                    <div id="predefined-routines-cover-card" class="hidden overflow-hidden rounded-3xl border border-white/10 bg-gray-900/70 shadow-[0_45px_140px_-70px_rgba(16,185,129,0.55)]">
                        <div class="relative aspect-[21/9]">
                            <div id="predefined-routines-cover-skeleton" class="image-loading-placeholder"></div>
                            <img id="predefined-routines-cover-preview" alt="Portada de rutinas premium" class="absolute inset-0 h-full w-full object-cover opacity-0 transition-opacity duration-500" />
                            <div id="predefined-routines-cover-empty" class="image-fallback absolute inset-0 hidden flex-col items-center justify-center gap-2 bg-gray-900/80 text-center text-gray-400" data-predefined-cover-admin>
                                <i data-lucide="sparkles" class="h-10 w-10 text-emerald-300/80"></i>
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/80">Portada premium</p>
                                <p class="max-w-sm text-sm text-gray-400">Sube una imagen panorámica 21:9 para destacar tu colección de rutinas predefinidas.</p>
                            </div>
                            <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div>
                        </div>
                        <div class="flex flex-col gap-4 border-t border-white/5 p-5 sm:flex-row sm:items-center sm:justify-between sm:p-6" data-predefined-cover-admin>
                            <div class="space-y-1">
                                <h3 class="text-lg font-semibold text-white">Portada de Rutinas Premium</h3>
                                <p class="text-sm text-gray-300">Formato recomendado 21:9 (ej. 2100×900 px) para un impacto visual óptimo.</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-3">
                                <input type="file" id="predefined-routines-cover-input" accept="image/*" class="hidden">
                                <button data-action="open-predefined-cover-upload" class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/20 transition hover:bg-emerald-400">
                                    <i data-lucide="image-plus" class="h-4 w-4"></i>
                                    Subir portada
                                </button>
                                <button data-action="remove-predefined-cover-image" class="inline-flex items-center gap-2 rounded-full border border-white/10 px-4 py-2 text-sm font-semibold text-gray-200 transition hover:border-red-400/60 hover:text-red-300">
                                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                                    Quitar
                                </button>
                            </div>
                            <div id="predefined-routines-cover-progress" class="hidden w-full items-center gap-3 rounded-2xl border border-white/10 bg-gray-950/70 px-4 py-3">
                                <div class="relative h-2 flex-1 overflow-hidden rounded-full bg-white/10">
                                    <div id="predefined-routines-cover-progress-bar" class="h-full w-0 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 transition-[width] duration-300"></div>
                                </div>
                                <span id="predefined-routines-cover-progress-text" class="text-xs font-semibold text-gray-300">Preparando...</span>
                            </div>
                        </div>
                    </div>
                        predefinedRoutinesCover: { image: '', storagePath: '', updatedAt: null },
                getPredefinedRoutinesCoverImage() {
                    const globalImage = this.sharedMedia?.predefinedRoutinesCover?.image || '';
                    const localImage = this.state?.predefinedRoutinesCover?.image || '';
                    if (this.canEditGlobalMedia()) {
                        return localImage || globalImage;
                    }
                    return globalImage || localImage;
                },

                async loadPredefinedRoutinesCoverFromFirestore() {
                    if (!this.db) return;
                    const defaults = this.getDefaultState().predefinedRoutinesCover || { image: '', storagePath: '', updatedAt: null };
                    try {
                        const docRef = doc(this.db, 'app_data', 'predefined_routines_cover');
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            this.sharedMedia.predefinedRoutinesCover = { ...defaults, ...(docSnap.data() || {}) };
                        } else {
                            this.sharedMedia.predefinedRoutinesCover = { ...defaults };
                            if (this.canEditGlobalMedia()) {
                                await setDoc(docRef, this.sharedMedia.predefinedRoutinesCover);
                            }
                        }
                        if (this.sharedMedia.predefinedRoutinesCover.image) {
                            this.preloadImage(this.sharedMedia.predefinedRoutinesCover.image, { priority: 'high' });
                        }
                        const shouldSyncLocal = !this.canEditGlobalMedia()
                            || !this.state.predefinedRoutinesCover
                            || !this.state.predefinedRoutinesCover.image;
                        if (shouldSyncLocal) {
                            this.state.predefinedRoutinesCover = { ...defaults, ...this.sharedMedia.predefinedRoutinesCover };
                        }
                    } catch (error) {
                        console.error('Error loading predefined routines cover:', error);
                    }
                },

                async savePredefinedRoutinesCoverToFirestore() {
                    if (!this.db) return;
                    try {
                        const docRef = doc(this.db, 'app_data', 'predefined_routines_cover');
                        await setDoc(docRef, this.sharedMedia.predefinedRoutinesCover || {}, { merge: true });
                    } catch (error) {
                        console.error('Error saving predefined routines cover:', error);
                        this.showToast('No se pudo actualizar la portada de rutinas premium.', 'error');
                    }
                },

                _isUploadingPredefinedCover: false,
                _predefinedCoverProgressTimeout: null,
                    predefinedRoutinesCover: { image: '', storagePath: '', updatedAt: null },
                    await this.loadPredefinedRoutinesCoverFromFirestore();

                    this.updatePredefinedCoverPreview();
                            if (data.predefinedRoutinesCover) {
                                if (typeof data.predefinedRoutinesCover === 'string') {
                                    this.state.predefinedRoutinesCover = { ...defaultState.predefinedRoutinesCover, image: data.predefinedRoutinesCover };
                                } else {
                                    this.state.predefinedRoutinesCover = { ...defaultState.predefinedRoutinesCover, ...data.predefinedRoutinesCover };
                                }
                            } else {
                                this.state.predefinedRoutinesCover = { ...defaultState.predefinedRoutinesCover };
                            }
                            if (this.state.predefinedRoutinesCover?.image) {
                                this.preloadImage(this.state.predefinedRoutinesCover.image, { priority: 'high' });
                            }
                            if (this.canEditGlobalMedia() && this.state.predefinedRoutinesCover?.image && !this.sharedMedia.predefinedRoutinesCover?.image) {
                                this.sharedMedia.predefinedRoutinesCover = { ...defaultState.predefinedRoutinesCover, ...this.state.predefinedRoutinesCover };
                                await this.savePredefinedRoutinesCoverToFirestore();
                            }
                            'show-section': () => this.showSection(sectionId), 'open-cover-upload': () => this.triggerCoverUpload(), 'remove-cover-image': () => this.removeCoverImage(), 'open-predefined-cover-upload': () => this.triggerPredefinedCoverUpload(), 'remove-predefined-cover-image': () => this.removePredefinedCoverImage(), 'open-routine-banner-upload': () => this.triggerRoutineBannerUpload(), 'remove-routine-banner-image': () => this.removeRoutineBannerImage(), 'handle-workout-action': () => this.handleWorkoutAction(), 'confirm-cancel-workout': () => this.confirmCancelWorkout(), 'abort-workout': () => this.finishWorkout(false), 'exit-without-saving': () => this.finishWorkout(false), 'exit-and-save': () => this.finishWorkout(true), 'start-workout': () => this.startWorkout(routineId, parseInt(dayIndex)), 'skip-rest': () => this.skipRest(), 'add-rest-time': () => this.addRestTime(), 'save-goals': () => this.saveNutritionGoals(), 'calculate-body-metrics': () => this.calculateBodyMetrics(), 'show-add-food-modal': () => this.showAddFoodModal(foodId), 'add-food-to-meal': () => this.addFoodToMealFromModal(foodId, parseInt(mealIndex)), 'confirm-remove-food': () => this.confirmRemoveFoodFromMeal(parseInt(mealIndex), parseInt(itemIndex)), 'remove-food': () => this.removeFoodFromMeal(parseInt(mealIndex), parseInt(itemIndex)), 'generate-plan': () => this.generatePlanWithAI(), 'analyze-food': () => this.analyzeFoodWithAI(), 'get-recipe': () => this.getRecipeForMeal(parseInt(mealIndex)), 'show-exercise-info': () => this.showExerciseInfoModal(exerciseName), 'hide-modal': () => this.hideModal(), 'show-workout-history': () => this.openWorkoutHistoryModal(historyDate), 'routine-create': () => this.routine_enterCreator(), 'routine-show-details': () => this.routine_showDetails(routineId), 'routine-close-view': () => this.routine_closeFullscreenView(), 'routine-creator-next': () => this.routine_handleCreatorNext(), 'routine-creator-add-exercise': () => this.routine_showAddExerciseDrawer(), 'routine-creator-close-drawer': () => this.routine_closeAddExerciseDrawer(), 'routine-creator-select-exercise': () => this.routine_selectExercise(exerciseName), 'routine-creator-save-exercise-details': () => this.routine_saveExerciseDetails(parseInt(exerciseIndex)), 'routine-creator-edit-exercise': (e) => this.routine_editExercise(e.target.closest('[data-exercise-index]').dataset.exerciseIndex), 'routine-creator-remove-exercise': () => this.routine_removeExercise(parseInt(exerciseIndex)), 'routine-creator-save': () => this.routine_save(), 'routine-confirm-delete': () => this.routine_confirmDelete(routineId), 'routine-delete': () => this.routine_delete(routineId), 'routine-creator-suggest-ai': () => this.routine_showAiSuggestionModal(), 'generate-exercises-ai': () => this.routine_generateExercisesWithAi(), 'analyze-workout-performance': (e) => this.analyzeWorkoutPerformance(e), 'edit-profile': () => this.showEditProfileModal(), 'save-profile-changes': () => this.handleUpdateProfile(), 'edit-target-weight': () => this.showEditTargetWeightModal(), 'save-target-weight': () => this.handleUpdateTargetWeight(), 'add-weight-log': () => this.handleAddWeightLog(), 'admin-edit-exercise': () => this.admin_showEditExerciseModal(group, subgroup, exerciseIndex), 'admin-confirm-delete-exercise': () => this.admin_confirmDeleteExercise(group, subgroup, exerciseIndex), 'admin-delete-exercise': () => this.admin_deleteExercise(group, subgroup, exerciseIndex), 'admin-save-exercise': () => this.admin_saveExerciseChanges(group, subgroup, exerciseIndex), 'admin-edit-media': () => this.admin_showEditMediaModal(group, subgroup, exerciseIndex), 'admin-upload-media': () => this.admin_uploadAndSaveMedia(group, subgroup, exerciseIndex), 'routine-creator-switch-day': () => this.routine_switchDay(parseInt(dayIndex)), 'routine-creator-add-day': () => this.routine_addDay(), 'routine-creator-rename-day': () => this.routine_showRenameDayModal(parseInt(dayIndex)), 'routine-creator-confirm-delete-day': () => this.routine_confirmDeleteDay(parseInt(dayIndex)), 'routine-creator-delete-day': () => this.routine_deleteDay(parseInt(dayIndex)), 'routine-creator-back-to-groups': () => this.routine_creator_showGroupList(), 'routine-open-edit-modal': () => this.routine_openExerciseEditModal(parseInt(exerciseIndex)), 'routine-close-edit-modal': () => this.routine_closeExerciseEditModal(), 'routine-save-exercise-modal': () => this.routine_saveExerciseFromModal(), 'routine-open-timeline': () => this.routine_openTimelineView(), 'routine-toggle-mini-window': () => this.routine_toggleMiniWindow(), 'routine-close-timeline': () => this.routine_closeTimelineView(), 'routine-timeline-save': () => this.routine_handleTimelineSave(), 'routine-timeline-confirm-link': () => this.routine_handleTimelineLink(), 'routine-timeline-confirm-start': () => this.routine_handleTimelineStart(),
                        if (e.target.id === 'predefined-routines-cover-input') {
                            this.handlePredefinedCoverFileChange(e.target);
                            return;
                        }
                refreshPredefinedCoverControls() {
                    const card = document.getElementById('predefined-routines-cover-card');
                    const isAdmin = this.canEditGlobalMedia();
                    if (!card) return;

                    card.querySelectorAll('[data-predefined-cover-admin]').forEach(element => {
                        element.classList.toggle('hidden', !isAdmin);
                    });

                    const uploadBtn = card.querySelector('button[data-action="open-predefined-cover-upload"]');
                    if (uploadBtn) {
                        uploadBtn.disabled = !isAdmin || this._isUploadingPredefinedCover;
                        uploadBtn.setAttribute('aria-disabled', (!isAdmin || this._isUploadingPredefinedCover).toString());
                        uploadBtn.classList.toggle('opacity-50', this._isUploadingPredefinedCover || !isAdmin);
                        uploadBtn.classList.toggle('cursor-not-allowed', this._isUploadingPredefinedCover || !isAdmin);
                    }

                    const removeBtn = card.querySelector('button[data-action="remove-predefined-cover-image"]');
                    if (removeBtn) {
                        const hasImage = Boolean(this.getPredefinedRoutinesCoverImage());
                        const shouldDisable = !isAdmin || this._isUploadingPredefinedCover || !hasImage;
                        removeBtn.disabled = shouldDisable;
                        removeBtn.setAttribute('aria-disabled', shouldDisable.toString());
                        removeBtn.classList.toggle('opacity-40', !hasImage);
                        removeBtn.classList.toggle('cursor-not-allowed', shouldDisable);
                    }

                    const input = document.getElementById('predefined-routines-cover-input');
                    if (input) {
                        input.disabled = !isAdmin || this._isUploadingPredefinedCover;
                    }
                },
                updatePredefinedCoverPreview() {
                    const card = document.getElementById('predefined-routines-cover-card');
                    const preview = document.getElementById('predefined-routines-cover-preview');
                    const skeleton = document.getElementById('predefined-routines-cover-skeleton');
                    const fallback = document.getElementById('predefined-routines-cover-empty');
                    if (!card || !preview || !skeleton) {
                        this.refreshPredefinedCoverControls();
                        return;
                    }

                    const isAdmin = this.canEditGlobalMedia();
                    const imageUrl = this.getPredefinedRoutinesCoverImage();
                    const shouldHideCard = !isAdmin && !imageUrl;

                    card.classList.toggle('hidden', shouldHideCard);
                    card.querySelectorAll('[data-predefined-cover-admin]').forEach(element => {
                        element.classList.toggle('hidden', !isAdmin);
                    });

                    if (fallback) {
                        if (isAdmin && !imageUrl) {
                            fallback.classList.remove('hidden');
                            if (!fallback.classList.contains('flex')) {
                                fallback.classList.add('flex');
                            }
                        } else {
                            fallback.classList.add('hidden');
                            fallback.classList.remove('flex');
                        }
                    }

                    if (shouldHideCard) {
                        this.refreshPredefinedCoverControls();
                        return;
                    }

                    if (imageUrl) {
                        skeleton.classList.remove('is-hidden');
                        preview.dataset.pendingSrc = imageUrl;
                        this.preloadImage(imageUrl, { priority: 'high' }).then((success) => {
                            if (!preview || preview.dataset.pendingSrc !== imageUrl) return;
                            if (success) {
                                preview.src = imageUrl;
                                preview.classList.remove('hidden');
                                requestAnimationFrame(() => {
                                    preview.classList.remove('opacity-0');
                                    preview.classList.add('opacity-100');
                                });
                            } else {
                                preview.src = '';
                                preview.classList.add('hidden');
                                preview.classList.add('opacity-0');
                                preview.classList.remove('opacity-100');
                                if (fallback && isAdmin) {
                                    fallback.classList.remove('hidden');
                                    if (!fallback.classList.contains('flex')) {
                                        fallback.classList.add('flex');
                                    }
                                }
                            }
                            skeleton.classList.add('is-hidden');
                        });
                    } else {
                        preview.dataset.pendingSrc = '';
                        preview.src = '';
                        preview.classList.add('hidden');
                        preview.classList.add('opacity-0');
                        preview.classList.remove('opacity-100');
                        skeleton.classList.add('is-hidden');
                    }

                    this.refreshPredefinedCoverControls();
                },
                triggerPredefinedCoverUpload() {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede actualizar la portada de rutinas premium.', 'error');
                        return;
                    }
                    if (this._isUploadingPredefinedCover) {
                        this.showToast('Espera a que termine la subida en curso.', 'error');
                        return;
                    }
                    const input = document.getElementById('predefined-routines-cover-input');
                    if (input) {
                        input.click();
                    }
                },
                async deletePredefinedCoverFromStorage() {
                    const storagePath = this.state?.predefinedRoutinesCover?.storagePath || this.sharedMedia?.predefinedRoutinesCover?.storagePath;
                    if (!storagePath) return;
                    try {
                        const fileRef = ref(this.storage, storagePath);
                        await deleteObject(fileRef);
                    } catch (error) {
                        console.warn('No se pudo eliminar la portada anterior de rutinas premium del almacenamiento:', error);
                    }
                },
                async handlePredefinedCoverFileChange(input) {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede actualizar la portada de rutinas premium.', 'error');
                        if (input) input.value = '';
                        return;
                    }
                    if (!input || !input.files || input.files.length === 0) return;
                    if (this._isUploadingPredefinedCover) {
                        this.showToast('Ya hay una subida en curso.', 'error');
                        input.value = '';
                        return;
                    }

                    const file = input.files[0];
                    if (!file.type.startsWith('image/')) {
                        this.showToast('Selecciona una imagen válida.', 'error');
                        input.value = '';
                        return;
                    }
                    const maxSize = 5 * 1024 * 1024;
                    if (file.size > maxSize) {
                        this.showToast('La imagen debe pesar menos de 5MB.', 'error');
                        input.value = '';
                        return;
                    }

                    const progressContainer = document.getElementById('predefined-routines-cover-progress');
                    const progressBar = document.getElementById('predefined-routines-cover-progress-bar');
                    const progressText = document.getElementById('predefined-routines-cover-progress-text');

                    const clearProgressTimeout = () => {
                        if (this._predefinedCoverProgressTimeout) {
                            clearTimeout(this._predefinedCoverProgressTimeout);
                            this._predefinedCoverProgressTimeout = null;
                        }
                    };

                    clearProgressTimeout();

                    if (progressContainer) {
                        progressContainer.classList.remove('hidden');
                        progressContainer.classList.add('flex');
                    }
                    if (progressBar) {
                        progressBar.style.width = '0%';
                    }
                    if (progressText) {
                        progressText.textContent = 'Iniciando subida...';
                    }

                    this.state.predefinedRoutinesCover = this.state.predefinedRoutinesCover || { image: '', storagePath: '', updatedAt: null };

                    this._isUploadingPredefinedCover = true;
                    this.refreshPredefinedCoverControls();

                    const sanitizedName = file.name.replace(/[^a-zA-Z0-9_.-]/g, '_');
                    const filePath = `predefined_routines_cover/${this.state.currentUser?.uid || 'admin'}/${Date.now()}-${sanitizedName}`;
                    const storageRef = ref(this.storage, filePath);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    if (progressText) {
                        progressText.textContent = 'Subiendo... 0%';
                    }

                    const hideProgress = (delay = 0) => {
                        if (!progressContainer) return;
                        clearProgressTimeout();
                        this._predefinedCoverProgressTimeout = setTimeout(() => {
                            progressContainer.classList.add('hidden');
                            progressContainer.classList.remove('flex');
                            if (progressBar) {
                                progressBar.style.width = '0%';
                            }
                            if (progressText) {
                                progressText.textContent = 'Preparando...';
                            }
                            this._predefinedCoverProgressTimeout = null;
                        }, delay);
                    };

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = snapshot.totalBytes ? (snapshot.bytesTransferred / snapshot.totalBytes) * 100 : 0;
                            if (progressBar) {
                                progressBar.style.width = `${progress}%`;
                            }
                            if (progressText) {
                                progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                            }
                        },
                        (error) => {
                            console.error('Error al subir la portada de rutinas premium:', error);
                            this.showToast('No se pudo subir la portada.', 'error');
                            if (progressText) {
                                progressText.textContent = 'Error al subir';
                            }
                            hideProgress(2000);
                            this._isUploadingPredefinedCover = false;
                            this.refreshPredefinedCoverControls();
                            input.value = '';
                        },
                        async () => {
                            try {
                                await this.deletePredefinedCoverFromStorage();
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                const coverData = {
                                    image: downloadURL,
                                    storagePath: filePath,
                                    updatedAt: Date.now()
                                };
                                this.state.predefinedRoutinesCover = { ...coverData };
                                this.sharedMedia.predefinedRoutinesCover = { ...coverData };
                                this.updatePredefinedCoverPreview();
                                if (progressBar) {
                                    progressBar.style.width = '100%';
                                }
                                if (progressText) {
                                    progressText.textContent = 'Subida completa 100%';
                                }
                                await this.savePredefinedRoutinesCoverToFirestore();
                                await this.saveDataToFirestore();
                                this.showToast('Portada actualizada.');
                                hideProgress(1500);
                            } catch (error) {
                                console.error('Error al finalizar la subida de la portada:', error);
                                this.showToast('No se pudo procesar la portada.', 'error');
                                if (progressText) {
                                    progressText.textContent = 'Error al finalizar';
                                }
                                hideProgress(2000);
                            } finally {
                                this._isUploadingPredefinedCover = false;
                                this.refreshPredefinedCoverControls();
                                input.value = '';
                            }
                        }
                    );
                },
                async removePredefinedCoverImage() {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede modificar la portada de rutinas premium.', 'error');
                        return;
                    }
                    const hasImage = Boolean(this.state?.predefinedRoutinesCover?.image || this.sharedMedia?.predefinedRoutinesCover?.image);
                    if (!hasImage) {
                        return;
                    }
                    if (this._isUploadingPredefinedCover) {
                        this.showToast('Espera a que termine la subida antes de eliminar.', 'error');
                        return;
                    }
                    await this.deletePredefinedCoverFromStorage();
                    const defaults = this.getDefaultState().predefinedRoutinesCover || { image: '', storagePath: '', updatedAt: null };
                    this.state.predefinedRoutinesCover = { ...defaults };
                    this.sharedMedia.predefinedRoutinesCover = { ...defaults };
                    this.updatePredefinedCoverPreview();
                    const input = document.getElementById('predefined-routines-cover-input');
                    if (input) input.value = '';
                    await this.savePredefinedRoutinesCoverToFirestore();
                    await this.saveDataToFirestore();
                    this.showToast('Portada eliminada.');
                },
                    this.updatePredefinedCoverPreview();
