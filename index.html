<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>FitTrack - Tu Asistente Fitness Personal</title>

    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body.mobile-menu-open { overflow: hidden; }
        #profile-avatar,
        #user-avatar {
            position: relative;
            overflow: hidden;
        }
        #profile-avatar img,
        #user-avatar img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.35s ease;
        }
        #profile-avatar.has-photo,
        #user-avatar.has-photo {
            background-color: transparent !important;
            color: transparent;
        }
        #profile-avatar.has-photo span,
        #user-avatar.has-photo span {
            display: none;
        }
        #profile-avatar.has-photo img,
        #user-avatar.has-photo img {
            opacity: 1;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        .glass-header {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 64, 175, 0.45)) border-box;
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 25px 60px -35px rgba(14, 165, 233, 0.65);
            backdrop-filter: blur(16px) saturate(140%);
            -webkit-backdrop-filter: blur(16px) saturate(140%);
            transition: opacity 0.3s ease, background-color 0.3s ease, box-shadow 0.35s ease;
        }
        .glass-header::before {
            content: "";
            position: absolute;
            inset: -60% 45% auto -20%;
            height: 220%;
            background: radial-gradient(circle at center, rgba(45, 212, 191, 0.35), rgba(15, 23, 42, 0));
            opacity: 0.7;
            transform: rotate(12deg);
        }
        .glass-header::after {
            content: "";
            position: absolute;
            inset: auto -40% -120% 35%;
            height: 260%;
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.28), rgba(15, 23, 42, 0));
            opacity: 0.65;
        }
        .glass-header:hover {
            box-shadow: 0 35px 65px -30px rgba(34, 197, 94, 0.55);
        }
        .header-highlight {
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: linear-gradient(140deg, rgba(148, 163, 184, 0.12), rgba(15, 23, 42, 0.65));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .header-metric {
            position: relative;
            overflow: hidden;
        }
        .header-metric::after {
            content: "";
            position: absolute;
            inset: auto -40% -140% 20%;
            background: radial-gradient(circle at center, rgba(148, 163, 184, 0.25), transparent 70%);
            opacity: 0.6;
        }
        .header-progress-bar {
            height: 0.4rem;
            border-radius: 9999px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.2);
        }
        .header-progress-bar span {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.85));
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.55);
            transition: width 0.4s ease;
        }
        .macro-bar {
            position: relative;
            width: 100%;
            height: 0.55rem;
            overflow: hidden;
            border-radius: 9999px;
            background: rgba(148, 163, 184, 0.18);
        }
        .macro-bar-fill {
            height: 100%;
            width: 0;
            border-radius: inherit;
            transition: width 0.45s ease;
        }
        .macro-pie {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(15, 23, 42, 0.9) 55%, rgba(15, 23, 42, 0.2) 56%);
            box-shadow: inset 0 0 35px rgba(15, 23, 42, 0.7), 0 15px 35px -25px rgba(16, 185, 129, 0.65);
            display: grid;
            place-items: center;
        }
        .macro-pie::after {
            content: "";
            position: absolute;
            inset: 8px;
            border-radius: inherit;
            background: rgba(15, 23, 42, 0.85);
        }
        .macro-pie-content {
            position: relative;
            z-index: 1;
            display: grid;
            place-items: center;
            gap: 0.25rem;
        }
        .analytics-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(148, 163, 184, 0.12);
            padding: 0.4rem 0.9rem;
        }

        .mobile-sheet {
            transform: translateY(100%);
            transition: transform 0.35s ease;
        }

        [data-open="true"] .mobile-sheet {
            transform: translateY(0);
        }

        .sheet-backdrop {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        [data-open="true"] .sheet-backdrop {
            opacity: 1;
        }

        .thumbnail-strip {
            scrollbar-width: none;
        }

        .thumbnail-strip::-webkit-scrollbar {
            display: none;
        }

        .timeline-item {
            position: relative;
            padding-left: 2.5rem;
        }

        .timeline-item::before {
            content: "";
            position: absolute;
            left: 1rem;
            top: 1.75rem;
            bottom: -1.75rem;
            width: 2px;
            background: linear-gradient(180deg, rgba(16, 185, 129, 0.6), rgba(14, 116, 144, 0.15));
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .diet-panel {
            position: relative;
            overflow: hidden;
            border-radius: 26px;
            border: 1px solid rgba(148, 163, 184, 0.18);
            background: linear-gradient(140deg, rgba(15, 23, 42, 0.88), rgba(12, 74, 110, 0.48));
            box-shadow: 0 30px 90px -60px rgba(59, 130, 246, 0.55);
            backdrop-filter: blur(20px) saturate(140%);
            -webkit-backdrop-filter: blur(20px) saturate(140%);
            transition: transform 0.35s ease, border-color 0.35s ease, box-shadow 0.35s ease;
        }
        .diet-panel::before {
            content: "";
            position: absolute;
            inset: -55% 35% auto -20%;
            height: 220%;
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.22), rgba(15, 23, 42, 0));
            opacity: 0.6;
        }
        .diet-panel::after {
            content: "";
            position: absolute;
            inset: auto -30% -120% 45%;
            height: 240%;
            background: radial-gradient(circle at center, rgba(16, 185, 129, 0.35), rgba(15, 23, 42, 0));
            opacity: 0.55;
        }
        .diet-panel:hover {
            transform: translateY(-2px);
            border-color: rgba(94, 234, 212, 0.5);
            box-shadow: 0 45px 120px -70px rgba(56, 189, 248, 0.6);
        }
        .diet-panel[open] {
            border-color: rgba(16, 185, 129, 0.55);
            box-shadow: 0 55px 140px -70px rgba(16, 185, 129, 0.75);
        }
        .diet-panel-summary {
            position: relative;
            z-index: 2;
            display: block;
            cursor: pointer;
            border-radius: 24px;
            overflow: hidden;
            text-align: left;
        }
        .diet-panel-content {
            position: relative;
            z-index: 1;
            display: grid;
            gap: 1.6rem;
            padding: clamp(1.2rem, 4vw, 1.95rem);
            background: linear-gradient(155deg, rgba(15, 23, 42, 0.92), rgba(12, 74, 110, 0.5));
            border-top: 1px solid rgba(148, 163, 184, 0.14);
            border-radius: 0 0 24px 24px;
        }
        .diet-panel-body {
            position: relative;
            z-index: 1;
            display: block;
        }
        .diet-panel-cover {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 1.25rem;
            width: 100%;
            min-height: clamp(220px, 32vw, 260px);
            border-radius: 24px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.18);
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(8, 47, 73, 0.6));
            box-shadow: inset 0 0 40px rgba(15, 23, 42, 0.65);
            isolation: isolate;
        }
        .diet-panel-cover::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.1) 0%, rgba(15, 23, 42, 0.65) 68%, rgba(15, 23, 42, 0.9) 100%);
            z-index: 1;
        }
        .diet-panel-cover-visual {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            transform: scale(1);
            transition: transform 0.5s ease;
            filter: brightness(0.85);
            z-index: 0;
        }
        .diet-panel:hover .diet-panel-cover-visual {
            transform: scale(1.05);
        }
        .diet-panel-cover[data-custom-cover="true"] .diet-panel-cover-visual {
            filter: brightness(0.92);
        }
        .diet-panel-cover::before {
            content: "";
            position: absolute;
            inset: -40% 20% auto -20%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 0));
            opacity: 0.45;
            z-index: 1;
        }
        .diet-panel-cover[data-custom-cover="true"] {
            border-color: rgba(16, 185, 129, 0.55);
            box-shadow: inset 0 0 35px rgba(16, 185, 129, 0.2);
        }
        .diet-panel-cover[data-custom-cover="true"]::after {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.05) 0%, rgba(15, 23, 42, 0.55) 68%, rgba(15, 23, 42, 0.85) 100%);
        }
        .diet-panel-cover-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: clamp(1.5rem, 4vw, 2rem);
        }
        .diet-panel-cover-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 3.1rem;
            width: 3.1rem;
            border-radius: 20px;
            background: rgba(16, 185, 129, 0.18);
            box-shadow: 0 20px 45px -28px rgba(16, 185, 129, 0.65);
            color: rgba(240, 253, 244, 0.92);
        }
        .diet-panel-cover-text {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .diet-panel-cover-text h3 {
            font-size: clamp(1rem, 2.8vw, 1.25rem);
            font-weight: 700;
            color: #f8fafc;
        }
        .diet-panel-cover-text span {
            font-size: clamp(0.75rem, 2.2vw, 0.9rem);
            color: rgba(226, 232, 240, 0.82);
        }
        .diet-panel-cover-toggle {
            position: absolute;
            top: 1.1rem;
            right: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.35rem;
            height: 2.35rem;
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: rgba(15, 23, 42, 0.82);
            color: rgba(226, 232, 240, 0.9);
            box-shadow: 0 22px 55px -35px rgba(56, 189, 248, 0.85);
            z-index: 3;
            pointer-events: none;
            transition: border-color 0.3s ease, color 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
        }
        .diet-panel-cover-toggle svg {
            width: 18px;
            height: 18px;
            transition: transform 0.35s ease;
        }
        .diet-panel:hover .diet-panel-cover-toggle {
            border-color: rgba(94, 234, 212, 0.6);
            color: rgba(240, 253, 250, 0.95);
            background: rgba(15, 23, 42, 0.92);
            box-shadow: 0 25px 65px -35px rgba(56, 189, 248, 0.9);
        }
        .diet-panel[open] .diet-panel-cover-toggle svg {
            transform: rotate(180deg);
        }
        .diet-panel-cover-upload {
            position: absolute;
            top: 1.1rem;
            left: 1.1rem;
            z-index: 3;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            border: 1px solid rgba(148, 163, 184, 0.28);
            background: rgba(15, 23, 42, 0.78);
            color: rgba(226, 232, 240, 0.9);
            cursor: pointer;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: border-color 0.3s ease, color 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
        }
        .diet-panel-cover-upload svg {
            width: 16px;
            height: 16px;
        }
        .diet-panel-cover-upload:hover {
            border-color: rgba(94, 234, 212, 0.6);
            color: rgba(240, 253, 250, 0.95);
            background: rgba(15, 23, 42, 0.92);
            box-shadow: 0 25px 65px -35px rgba(56, 189, 248, 0.75);
        }
        .diet-panel-cover-upload.is-hidden {
            display: none;
        }
        .diet-panel-cover-upload.is-uploading::after {
            content: "";
            position: absolute;
            inset: 0.35rem;
            border-radius: inherit;
            border: 3px solid rgba(148, 163, 184, 0.35);
            border-top-color: rgba(56, 189, 248, 0.8);
            animation: spin 0.85s linear infinite;
        }
        .diet-panel-cover[data-panel-key="guided"] .diet-panel-cover-visual {
            background-image: url('https://images.unsplash.com/photo-1514516430032-7f38caebc1ec?auto=format&fit=crop&w=1200&q=80');
        }
        .diet-panel-cover[data-panel-key="daily"] .diet-panel-cover-visual {
            background-image: url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&w=1200&q=80');
        }
        .diet-panel-cover[data-panel-key="agenda"] .diet-panel-cover-visual {
            background-image: url('https://images.unsplash.com/photo-1455619452474-d2be8b1e70cd?auto=format&fit=crop&w=1200&q=80');
        }
        .diet-panel-cover[data-panel-key="library"] .diet-panel-cover-visual {
            background-image: url('https://images.unsplash.com/photo-1498837167922-ddd27525d352?auto=format&fit=crop&w=1200&q=80');
        }
        .diet-panel-cover[data-panel-key="guided"] .diet-panel-cover-icon {
            background: rgba(16, 185, 129, 0.2);
            box-shadow: 0 18px 45px -28px rgba(16, 185, 129, 0.75);
            color: rgba(236, 253, 245, 0.95);
        }
        .diet-panel-cover[data-panel-key="daily"] .diet-panel-cover-icon {
            background: rgba(250, 204, 21, 0.18);
            box-shadow: 0 18px 45px -28px rgba(250, 204, 21, 0.6);
            color: rgba(255, 251, 235, 0.95);
        }
        .diet-panel-cover[data-panel-key="agenda"] .diet-panel-cover-icon {
            background: rgba(96, 165, 250, 0.18);
            box-shadow: 0 18px 45px -28px rgba(96, 165, 250, 0.65);
            color: rgba(239, 246, 255, 0.95);
        }
        .diet-panel-cover[data-panel-key="library"] .diet-panel-cover-icon {
            background: rgba(45, 212, 191, 0.2);
            box-shadow: 0 18px 45px -28px rgba(45, 212, 191, 0.7);
            color: rgba(236, 253, 245, 0.95);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; translateY(20px); } }
        @keyframes fadeslidein { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pulse-strong { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        @keyframes bar-grow { from { transform: scaleY(0); } to { transform: scaleY(1); } }

        .section-fade-in { animation: fadeIn 0.5s ease-in-out; }
        .modal-fade-in { animation: fadeIn 0.3s ease-out; }
        .modal-fade-out { animation: fadeOut 0.3s ease-in forwards; }
        .toast { animation: toastIn 0.5s ease-out forwards, toastOut 0.5s ease-in 2.5s forwards; }
        #timer-progress-ring { transition: stroke-dashoffset 1s linear; }

        .launch-spinner-wrapper { position: relative; width: 80px; height: 80px; display: inline-flex; align-items: center; justify-content: center; }
        .launch-spinner { width: 64px; height: 64px; border-radius: 50%; border: 4px solid rgba(52, 211, 153, 0.2); border-top-color: #34d399; animation: spin 1s linear infinite, pulse 2.4s ease-in-out infinite; box-shadow: 0 0 30px rgba(52, 211, 153, 0.25); }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 20px rgba(52, 211, 153, 0.15); } 50% { box-shadow: 0 0 35px rgba(52, 211, 153, 0.35); } }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

        .loading-shimmer {
            position: relative;
            overflow: hidden;
        }
        .loading-shimmer::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.22), rgba(255, 255, 255, 0));
            transform: translateX(-100%);
            animation: shimmer 1.2s ease-in-out infinite;
            pointer-events: none;
        }
        .loading-shimmer > * {
            position: relative;
            z-index: 1;
        }
        .image-loading-placeholder {
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.85), rgba(15, 23, 42, 0.9));
            overflow: hidden;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .image-loading-placeholder::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0));
            transform: translateX(-100%);
            animation: shimmer 1.2s ease-in-out infinite;
        }
        .image-loading-placeholder.is-hidden {
            opacity: 0;
            visibility: hidden;
        }

        #mobile-menu-backdrop { opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #mobile-menu-backdrop.is-visible { opacity: 1; pointer-events: auto; }

        .horizontal-scroll-container { -ms-overflow-style: none; scrollbar-width: none; }
        .horizontal-scroll-container::-webkit-scrollbar { display: none; }
        .fullscreen-view { transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); transform: translateX(100%); }
        .fullscreen-view.is-active { transform: translateX(0); }
        #exercise-drawer { transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s; transform: translateY(100%); opacity: 0; pointer-events: none; }
        #exercise-drawer.is-active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .exercise-accordion summary::-webkit-details-marker, details summary::-webkit-details-marker { display: none; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .live-workout-display { animation: fadeslidein 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .active-workout-state { animation: pulse-strong 1.5s infinite ease-in-out; }
        .prose h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .prose h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.25rem; }
        .prose ul, .prose ol { margin-left: 1rem; }
        .chart-bar { animation: bar-grow 0.8s cubic-bezier(0.25, 1, 0.5, 1); transform-origin: bottom; }
        #bmi-marker { transition: left 0.5s ease-in-out; }

        #app-sidebar { transition: background-color 0.3s ease, box-shadow 0.3s ease, width 0.3s ease, padding 0.3s ease; }
        #app-sidebar .nav-btn { transition: all 0.25s ease; color: #9ca3af; }
        #app-sidebar .nav-btn.is-active { color: #34d399; }
        #app-sidebar .nav-btn i { width: 1.25rem; height: 1.25rem; }
        #app-sidebar .sidebar-brand, #app-sidebar .sidebar-footer { transition: opacity 0.25s ease, transform 0.25s ease; }
        #app-sidebar .nav-label { transition: opacity 0.25s ease, margin 0.25s ease; }

        @media (max-width: 1023px) {
            #app-sidebar { border-top: 1px solid rgba(75, 85, 99, 0.6); }
            #app-sidebar .nav-btn { font-size: 0.75rem; font-weight: 600; }
            #app-sidebar.mobile-overlay { top: 0; bottom: 0; right: auto; left: 0; width: 18rem; max-width: calc(100vw - 3rem);
                padding: 1.75rem 1.5rem; border-radius: 0 1.5rem 1.5rem 0; border-top: none; border-right: 1px solid rgba(75, 85,
                99, 0.6); border-left: none; border-bottom: none; background: rgba(17, 24, 39, 0.98); box-shadow: 0 25px 60px -22px
                rgba(16, 185, 129, 0.35); transform: translateX(-110%); display: flex; flex-direction: column; gap: 1.5rem;
                align-items: stretch; z-index: 50; }
            #app-sidebar.mobile-overlay[data-mobile-open="true"] { transform: translateX(0); }
            #app-sidebar.mobile-overlay #main-nav-bar { display: flex; flex-direction: column; align-items: stretch; gap: 0.75rem; }
            #app-sidebar.mobile-overlay .nav-btn { flex-direction: row; justify-content: flex-start; gap: 0.75rem; padding: 0.75rem 1rem; }
            #app-sidebar.mobile-overlay .nav-label { opacity: 1; }
            #app-sidebar.mobile-overlay .sidebar-brand { display: flex !important; }
            #app-sidebar.mobile-overlay .sidebar-footer { display: block !important; }
            #app-sidebar.mobile-overlay #mobile-bottom-nav { display: none; }
        }

        @media (min-width: 1024px) {
            #app-sidebar { width: 18rem; background: rgba(255, 255, 255, 0.96); color: #111827; border-radius: 1.75rem; padding: 1.75rem 1.5rem; box-shadow: 0 25px 50px -12px rgba(15, 118, 110, 0.25); border: 1px solid rgba(229, 231, 235, 0.8); position: sticky; top: 1.5rem; max-height: calc(100vh - 3rem); backdrop-filter: blur(12px); }
            #app-sidebar .nav-btn { color: #6b7280; justify-content: flex-start; border-radius: 1.5rem; padding: 0.75rem 1rem; font-weight: 600; font-size: 0.95rem; }
            #app-sidebar .nav-btn.is-active { color: #0f766e; background: linear-gradient(120deg, rgba(16, 185, 129, 0.18), rgba(20, 184, 166, 0.08)); box-shadow: 0 10px 25px -10px rgba(16, 185, 129, 0.6); }
            #app-sidebar .nav-btn:not(.is-active):hover { color: #111827; background: rgba(243, 244, 246, 0.9); }
            #app-sidebar .nav-btn .nav-label { font-size: 0.95rem; margin-left: 0.75rem; }
            #app-sidebar .sidebar-footer { opacity: 1; transform: translateY(0); }
            #app-sidebar[data-collapsed="true"] { width: 5rem; padding-left: 1rem; padding-right: 1rem; }
            #app-sidebar[data-collapsed="true"] .sidebar-brand,
            #app-sidebar[data-collapsed="true"] .sidebar-footer { opacity: 0; transform: translateX(-12px); pointer-events: none; }
            #app-sidebar[data-collapsed="true"] .nav-btn { justify-content: center; padding-left: 0; padding-right: 0; }
            #app-sidebar[data-collapsed="true"] .nav-btn .nav-label { opacity: 0; width: 0; margin: 0; }
        }
        
        .auth-form-container { transition: all 0.4s ease-in-out; }
        .form-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; position: absolute; }
        .form-visible { opacity: 1; transform: scale(1); pointer-events: auto; position: relative; }

        .diet-responsive-grid {
            display: grid;
        }
        .diet-responsive-stack {
            display: flex;
            flex-wrap: wrap;
        }
        @media (max-width: 480px) {
            .diet-panel-summary {
                border-radius: 20px;
            }
            .diet-panel-cover {
                min-height: 200px;
            }
            .diet-panel-cover-content {
                align-items: flex-start;
                flex-direction: column;
            }
            .diet-panel-cover-icon {
                height: 2.6rem;
                width: 2.6rem;
                border-radius: 16px;
            }
            .diet-panel-cover-toggle {
                top: 0.85rem;
                right: 0.85rem;
            }
            .diet-panel-content {
                padding: 1.25rem;
                gap: 1.25rem;
            }
            .diet-panel-body .diet-responsive-grid {
                grid-template-columns: 1fr !important;
            }
            .diet-panel-body .diet-responsive-stack {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .diet-panel-body .diet-responsive-stack > * {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(error => {
                    console.error('Error al registrar el Service Worker:', error);
                });
            });
        }
    </script>

    <div id="launch-screen" class="min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800 text-center space-y-6">
        <div class="flex items-center justify-center space-x-3">
            <div class="h-14 w-14 rounded-3xl bg-emerald-500 text-gray-900 flex items-center justify-center shadow-2xl shadow-emerald-500/40">
                <i data-lucide="dumbbell" class="w-7 h-7"></i>
            </div>
            <div class="text-left">
                <p class="text-sm font-semibold tracking-[0.45em] text-emerald-300 uppercase">FitTrack</p>
                <p class="text-3xl font-black">Preparando tu experiencia</p>
            </div>
        </div>
        <p class="max-w-md text-gray-300 text-sm sm:text-base">Estamos sincronizando tu progreso y configurando tu panel personal. Esto tomará sólo un instante.</p>
        <div class="launch-spinner-wrapper">
            <div class="launch-spinner"></div>
        </div>
    </div>

    <div id="auth-container" class="hidden min-h-screen flex flex-col items-center justify-center p-6 bg-gradient-to-br from-gray-950 via-gray-900 to-gray-800">
        <div class="w-full max-w-5xl mx-auto">
            <div class="flex flex-col items-center gap-3 mb-10 text-center">
                <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-4 py-1 text-xs font-semibold uppercase tracking-[0.4em] text-emerald-200">
                    <i data-lucide="dumbbell" class="h-4 w-4"></i>
                    FitTrack
                </span>
                <h1 class="text-3xl sm:text-4xl font-black text-white">Tu espacio fitness, listo para despegar</h1>
                <p class="text-sm text-gray-400 max-w-2xl">Conecta entrenamientos, nutrición y progreso en un mismo panel envolvente diseñado para mantenerte inspirado.</p>
            </div>

            <div id="auth-card" class="relative overflow-hidden rounded-[2.5rem] border border-white/10 bg-gray-900/70 backdrop-blur-xl shadow-[0_45px_120px_-45px_rgba(16,185,129,0.75)]">
                <div class="pointer-events-none absolute inset-0">
                    <div class="absolute -top-32 -left-36 h-72 w-72 rounded-full bg-emerald-500/20 blur-3xl"></div>
                    <div class="absolute -bottom-40 right-0 h-80 w-80 rounded-full bg-cyan-500/10 blur-3xl"></div>
                </div>

                <div class="relative grid gap-8 lg:grid-cols-[minmax(0,1.05fr)_minmax(0,0.95fr)] items-stretch">
                    <div class="hidden lg:flex flex-col justify-between rounded-[2rem] border border-white/5 bg-gradient-to-br from-white/10 via-white/5 to-transparent p-10 text-left">
                        <div class="space-y-6">
                            <p class="text-xs font-semibold uppercase tracking-[0.45em] text-emerald-200/80">Experiencia inmersiva</p>
                            <h2 class="text-4xl font-semibold leading-tight text-white">Diseñado como tu asistente fitness personal</h2>
                            <p class="text-sm text-gray-300">Descubre paneles dinámicos, seguimiento inteligente de peso y recomendaciones sincronizadas con tus metas nutricionales.</p>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-400/20 text-emerald-200">
                                    <i data-lucide="sparkles" class="h-5 w-5"></i>
                                </span>
                                <div>
                                    <p class="text-sm font-semibold text-white">Todo en un mismo flujo</p>
                                    <p class="text-xs text-gray-400">Sincroniza tu progreso físico con tu plan de alimentación.</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-cyan-400/20 text-cyan-200">
                                    <i data-lucide="fingerprint" class="h-5 w-5"></i>
                                </span>
                                <div>
                                    <p class="text-sm font-semibold text-white">Acceso seguro y rápido</p>
                                    <p class="text-xs text-gray-400">Inicia sesión en segundos y continúa justo donde lo dejaste.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="relative p-6 sm:p-10">
                        <div id="auth-role-tabs" class="mb-6 grid grid-cols-1 gap-2 rounded-3xl border border-white/10 bg-white/5 p-2 text-xs font-semibold text-gray-400 sm:grid-cols-3">
                            <button data-action="toggle-role" data-role-target="admin" class="auth-role-tab inline-flex items-center justify-center gap-2 rounded-2xl bg-emerald-500/20 px-4 py-2 text-white shadow-[0_12px_25px_-20px_rgba(16,185,129,0.65)] transition">
                                <i data-lucide="crown" class="h-4 w-4"></i>
                                Administrador
                            </button>
                            <button data-action="toggle-role" data-role-target="entrenador" class="auth-role-tab inline-flex items-center justify-center gap-2 rounded-2xl px-4 py-2 text-gray-300 transition hover:text-white">
                                <i data-lucide="clipboard-check" class="h-4 w-4"></i>
                                Entrenador
                            </button>
                            <button data-action="toggle-role" data-role-target="asesorado" class="auth-role-tab inline-flex items-center justify-center gap-2 rounded-2xl px-4 py-2 text-gray-300 transition hover:text-white">
                                <i data-lucide="target" class="h-4 w-4"></i>
                                Asesorado
                            </button>
                        </div>

                        <div class="mb-6 rounded-full border border-white/10 bg-white/5 p-1 text-xs font-semibold text-gray-400">
                            <div class="grid grid-cols-2">
                                <button data-action="toggle-auth" data-auth-target="login" class="inline-flex items-center justify-center gap-2 rounded-full px-4 py-2 text-white bg-emerald-500/20 shadow-[0_12px_25px_-20px_rgba(16,185,129,0.65)] transition">
                                    <i data-lucide="log-in" class="h-4 w-4"></i>
                                    Iniciar sesión
                                </button>
                                <button data-action="toggle-auth" data-auth-target="register" class="inline-flex items-center justify-center gap-2 rounded-full px-4 py-2 text-gray-300 transition hover:text-white">
                                    <i data-lucide="user-plus" class="h-4 w-4"></i>
                                    Crear cuenta
                                </button>
                            </div>
                        </div>

                        <div class="relative">
                            <div id="login-form-container" class="auth-form-container form-visible space-y-6">
                                <div class="space-y-2 text-center">
                                    <h2 id="login-role-title" class="text-3xl font-bold text-white">Panel Administrador</h2>
                                    <p id="login-role-subtitle" class="text-sm text-gray-400">Acceso completo para orquestar a entrenadores y asesorados.</p>
                                </div>
                                <form id="login-form" class="space-y-5">
                                    <input type="hidden" id="login-role" value="admin">
                                    <div>
                                        <label for="login-email" class="block text-sm font-semibold text-gray-300 uppercase tracking-[0.35em]">Email</label>
                                        <input type="email" id="login-email" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-4 py-3 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                    </div>
                                    <div>
                                        <label for="login-password" class="block text-sm font-semibold text-gray-300 uppercase tracking-[0.35em]">Contraseña</label>
                                        <input type="password" id="login-password" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-4 py-3 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                    </div>
                                    <button type="submit" class="w-full rounded-2xl bg-gradient-to-r from-emerald-400 via-emerald-500 to-teal-400 py-3.5 text-sm font-semibold uppercase tracking-[0.3em] text-gray-900 shadow-[0_15px_45px_-20px_rgba(16,185,129,0.95)] transition hover:from-emerald-300 hover:via-emerald-400 hover:to-teal-300">
                                        Iniciar sesión
                                    </button>
                                </form>
                                <p class="text-center text-sm text-gray-400">
                                    ¿No tienes una cuenta? <button data-action="toggle-auth" class="font-semibold text-emerald-400 hover:underline">Regístrate aquí</button>
                                </p>
                            </div>

                            <div id="register-form-container" class="auth-form-container form-hidden space-y-6">
                                <div class="space-y-2 text-center">
                                    <h2 id="register-role-title" class="text-3xl font-bold text-white">Activa tu acceso</h2>
                                    <p id="register-role-subtitle" class="text-sm text-gray-400">Usa el enlace de invitación correspondiente para completar el registro.</p>
                                </div>
                                <form id="register-form" class="space-y-5">
                                    <input type="hidden" id="register-role" value="admin">
                                    <div class="grid gap-4 sm:grid-cols-2">
                                        <div class="sm:col-span-2">
                                            <label for="register-name" class="block text-sm font-semibold text-gray-300 uppercase tracking-[0.35em]">Nombre</label>
                                            <input type="text" id="register-name" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-4 py-3 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                        </div>
                                        <div>
                                            <label for="register-email" class="block text-sm font-semibold text-gray-300 uppercase tracking-[0.35em]">Email</label>
                                            <input type="email" id="register-email" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-4 py-3 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                        </div>
                                        <div>
                                            <label for="register-password" class="block text-sm font-semibold text-gray-300 uppercase tracking-[0.35em]">Contraseña</label>
                                            <input type="password" id="register-password" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-4 py-3 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                        </div>
                                    </div>
                                    <button type="submit" class="w-full rounded-2xl bg-gradient-to-r from-cyan-400 via-sky-400 to-emerald-400 py-3.5 text-sm font-semibold uppercase tracking-[0.3em] text-gray-900 shadow-[0_15px_45px_-20px_rgba(56,189,248,0.8)] transition hover:from-cyan-300 hover:via-sky-300 hover:to-emerald-300">
                                        Crear cuenta
                                    </button>
                                </form>
                                <p class="text-center text-sm text-gray-400">
                                    ¿Ya tienes una cuenta? <button data-action="toggle-auth" class="font-semibold text-emerald-400 hover:underline">Inicia sesión</button>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="hidden relative min-h-screen bg-gray-900 text-white">
        <div class="lg:flex lg:min-h-screen lg:mx-auto lg:max-w-7xl lg:gap-6">
            <nav id="app-sidebar" data-collapsed="true" data-mobile-open="false" class="fixed bottom-0 left-0 right-0 z-30 bg-gray-900/85 backdrop-blur-lg border-t border-gray-800 px-3 pt-2 pb-3 lg:flex lg:flex-col lg:items-stretch lg:gap-8 lg:border-none lg:px-0 lg:pt-0 lg:pb-0">
                <div class="hidden lg:flex items-center justify-between sidebar-brand">
                    <div class="flex items-center gap-3">
                        <div class="h-11 w-11 rounded-2xl bg-emerald-500 text-gray-900 flex items-center justify-center shadow-lg shadow-emerald-500/30">
                            <i data-lucide="dumbbell" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-emerald-600 uppercase tracking-[0.35em]">FitTrack</p>
                            <p class="text-lg font-bold text-gray-900">Panel Principal</p>
                        </div>
                    </div>
                </div>
                <div id="main-nav-bar" class="hidden flex-col items-stretch gap-3 lg:mt-8 lg:flex">
                    <button data-section="inicio" class="nav-btn is-active flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="home"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Inicio</span>
                    </button>
                    <button id="nav-rutinas" data-section="rutinas" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="clipboard-list"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Rutinas</span>
                    </button>
                    <button id="nav-roles" data-section="roles" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="shield"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Roles</span>
                    </button>
                    <button id="nav-asesorados" data-section="asesorados" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="users"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Asesorados</span>
                    </button>
                    <button id="nav-nutricion" data-section="nutricion" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="calculator"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Cálculos</span>
                    </button>
                    <button id="nav-dieta" data-section="dieta" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="utensils"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Dieta</span>
                    </button>
                    <button id="nav-historial" data-section="historial" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="history"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Historial</span>
                    </button>
                    <button id="nav-comunidad" data-section="comunidad" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="trophy"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Ranking</span>
                    </button>
                    <button data-section="perfil" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="user"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Perfil</span>
                    </button>
                </div>
                <div id="mobile-bottom-nav" class="flex justify-around items-center gap-1 lg:hidden">
                    <button data-section="inicio" class="nav-btn is-active flex-1 flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold">
                        <i data-lucide="home"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase">Inicio</span>
                    </button>
                    <button data-section="rutinas" class="nav-btn flex-1 flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold">
                        <i data-lucide="clipboard-list"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase">Rutinas</span>
                    </button>
                    <button data-section="comunidad" class="nav-btn flex-1 flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold">
                        <i data-lucide="trophy"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase">Ranking</span>
                    </button>
                    <button data-section="dieta" class="nav-btn flex-1 flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold">
                        <i data-lucide="utensils"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase">Dieta</span>
                    </button>
                    <button data-section="perfil" class="nav-btn flex-1 flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold">
                        <i data-lucide="user"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase">Perfil</span>
                    </button>
                </div>
                <div class="hidden lg:block mt-auto pt-6 sidebar-footer">
                    <div class="bg-gradient-to-br from-emerald-500 via-emerald-400 to-teal-400 rounded-2xl p-5 text-emerald-950 shadow-xl shadow-emerald-500/25">
                        <p class="text-sm font-semibold">Impulsa a tus clientes</p>
                        <p class="text-xs text-emerald-900/80 mt-1">Gestiona rutinas, nutrición y hábitos desde un solo lugar.</p>
                    </div>
                </div>
            </nav>
            <div id="mobile-menu-backdrop" class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm lg:hidden"></div>

            <div class="flex-1 flex flex-col min-h-screen lg:min-h-0 lg:max-h-screen">
                <header id="main-header" class="glass-header px-4 sm:px-6 py-4 sticky top-0 z-20 shadow-lg lg:rounded-2xl lg:mt-6 lg:mr-6 lg:ml-6">
                    <div class="absolute inset-0 pointer-events-none">
                        <div class="absolute -top-32 left-10 h-40 w-40 rounded-full bg-emerald-400/15 blur-3xl"></div>
                        <div class="absolute -bottom-36 right-0 h-48 w-48 rounded-full bg-sky-500/20 blur-3xl"></div>
                    </div>
                    <div class="relative flex w-full items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <button id="mobile-menu-toggle" type="button" aria-controls="app-sidebar" aria-expanded="false" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-200 transition hover:border-emerald-400/60 hover:bg-emerald-400/10 hover:text-white focus:outline-none focus:ring-2 focus:ring-emerald-400/60 lg:hidden">
                                <span class="sr-only">Abrir menú</span>
                                <i data-lucide="menu" class="h-5 w-5"></i>
                            </button>
                            <div class="flex items-center gap-3 rounded-2xl header-highlight px-3 py-2">
                                <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-500/15 text-emerald-300 shadow-inner shadow-emerald-500/20">
                                    <i data-lucide="dumbbell" class="h-5 w-5"></i>
                                </div>
                                <div>
                                    <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-100/80">Panel principal</p>
                                    <h1 class="text-xl font-bold tracking-tight text-white">FitTrack</h1>
                                </div>
                            </div>
                        </div>
                        <div class="hidden sm:flex flex-1 items-center justify-center gap-3 md:gap-5">
                            <div class="analytics-chip header-metric text-left text-xs text-emerald-100/90">
                                <i data-lucide="target" class="h-4 w-4 text-emerald-300"></i>
                                <div>
                                    <p class="text-[10px] uppercase tracking-[0.28em] text-emerald-100/70">Objetivo</p>
                                    <p id="header-goal-label" class="text-sm font-semibold text-white">--</p>
                                    <p id="header-direction-description" class="text-[10px] text-emerald-100/70">Define tu foco actual</p>
                                </div>
                            </div>
                            <div class="analytics-chip header-metric items-center gap-3 text-xs text-emerald-100/80">
                                <div>
                                    <p class="text-[10px] uppercase tracking-[0.28em] text-emerald-100/70">Progreso</p>
                                    <div class="header-progress-bar mt-1 w-28 md:w-36">
                                        <span id="header-progress-bar"></span>
                                    </div>
                                </div>
                                <p id="header-progress-label" class="text-sm font-semibold text-emerald-100">0%</p>
                            </div>
                            <div class="analytics-chip header-metric hidden md:flex items-center gap-3 text-xs text-emerald-100/80">
                                <i data-lucide="calendar" class="h-4 w-4 text-sky-300"></i>
                                <div>
                                    <p class="text-[10px] uppercase tracking-[0.28em] text-emerald-100/70">Proyección</p>
                                    <p id="header-projection-summary" class="text-sm font-semibold text-white/90">--</p>
                                    <p id="header-last-update" class="text-[10px] text-emerald-100/60">Actualiza tus métricas</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 sm:gap-4">
                            <div class="hidden sm:flex flex-col items-end leading-tight">
                                <p id="header-direction-label" class="text-xs font-semibold uppercase tracking-[0.28em] text-emerald-100/90">Objetivo activo</p>
                                <p id="header-projection-pace" class="text-[11px] text-emerald-200/80">--</p>
                            </div>
                            <div id="user-avatar" class="relative h-10 w-10 overflow-hidden rounded-full bg-emerald-500 text-gray-900 shadow-lg shadow-emerald-500/30">
                                <img id="user-avatar-img" alt="Foto de perfil" class="h-full w-full" />
                                <span class="absolute inset-0 grid place-items-center text-sm font-bold"></span>
                            </div>
                            <button id="logout-btn" title="Cerrar sesión" class="flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-300 transition hover:border-rose-400/40 hover:bg-rose-500/10 hover:text-white">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </header>

                <main id="app-main" class="flex-1 px-4 sm:px-6 pt-6 pb-28 overflow-y-auto lg:px-10 lg:pt-10 lg:pb-12"><div id="sections-wrapper" class="mx-auto w-full max-w-5xl lg:max-w-6xl xl:max-w-7xl"></div></main>
            </div>
        </div>

        <div id="fullscreen-view-container" class="fixed inset-0 z-40 pointer-events-none opacity-0 transition-opacity duration-300 bg-gray-950/95"></div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden"><div id="custom-modal-panel" class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm shadow-xl border border-gray-700 modal-fade-in"><h3 id="custom-modal-title" class="text-xl font-bold"></h3><div id="custom-modal-body" class="text-gray-300 mt-4 max-h-[70vh] overflow-y-auto"></div><div id="custom-modal-footer" class="mt-6 flex justify-end space-x-3"></div></div></div>
    <div id="toast-container" class="fixed bottom-24 right-0 left-0 max-w-lg mx-auto p-4 z-50 pointer-events-none lg:bottom-auto lg:top-6 lg:right-8 lg:left-auto lg:max-w-sm"></div>
    <div id="live-workout-overlay" class="fixed inset-0 z-40 hidden flex-col overflow-y-auto bg-gray-950/95 transition-opacity duration-300 touch-pan-y"></div>
    <div id="image-viewer-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4 cursor-pointer" onclick="this.classList.add('hidden')">
        <div id="image-viewer-content" class="max-w-3xl max-h-[90vh] relative cursor-default" onclick="event.stopPropagation()">
            </div>
    </div>

    <template id="template-inicio">
        <section id="inicio" class="section-content">
            <div class="space-y-8">
                <div class="space-y-4">
                    <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-emerald-500/10 via-emerald-500/5 to-transparent p-6 sm:p-8 shadow-lg shadow-emerald-500/10">
                        <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top_right,rgba(16,185,129,0.35),transparent_55%)]"></div>
                        <div class="relative flex flex-col gap-6">
                            <div class="space-y-3">
                                <span class="inline-flex w-fit items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200">Panel Inicio</span>
                                <h2 id="welcome-message" class="text-3xl font-black leading-tight text-white sm:text-4xl">Hola, </h2>
                                <p class="max-w-xl text-sm text-emerald-50/80 sm:text-base">Administra tus sesiones, nutrición y comunicaciones desde un panel preparado primero para móviles.</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-3 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-100/80">
                                <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-white/5 px-3 py-1"><i data-lucide="flame" class="h-4 w-4 text-emerald-300"></i><span>Metas activas</span></span>
                                <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-white/5 px-3 py-1"><i data-lucide="sparkles" class="h-4 w-4 text-emerald-300"></i><span>Motivación diaria</span></span>
                                <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-white/5 px-3 py-1"><i data-lucide="smartphone" class="h-4 w-4 text-emerald-300"></i><span>Optimizado móvil</span></span>
                            </div>
                        </div>
                    </div>
                    <div id="ai-daily-tip-card" class="hidden rounded-3xl border border-purple-400/30 bg-purple-500/10 p-5 text-purple-50 shadow-lg shadow-purple-500/10">
                        <div class="flex items-start gap-3">
                            <span class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-purple-500/20">
                                <i data-lucide="sparkles" class="h-5 w-5 text-purple-200"></i>
                            </span>
                            <div class="space-y-1">
                                <h3 class="font-semibold text-purple-100">Consejo del Día ✨</h3>
                                <p id="ai-daily-tip-text" class="text-sm text-purple-100/80">Cargando consejo...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-5">
                    <div class="overflow-hidden rounded-3xl border border-white/10 bg-gray-900/60 backdrop-blur">
                        <div class="relative aspect-[21/9] bg-gradient-to-r from-gray-800 via-gray-900 to-gray-800">
                            <img id="dashboard-cover-preview" alt="Portada promocional" class="absolute inset-0 h-full w-full object-cover hidden" />
                            <div id="dashboard-cover-placeholder" class="flex h-full w-full flex-col items-center justify-center gap-2 px-4 text-center text-gray-400">
                                <i data-lucide="image" class="h-10 w-10 text-gray-500"></i>
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-500/80">Portada publicitaria</p>
                                <p class="text-sm text-gray-400">Recomendado: formato panorámico 21:9 para un banner tipo publicidad.</p>
                            </div>
                            <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                        </div>
                        <div class="flex flex-col gap-4 border-t border-white/5 p-5 sm:flex-row sm:items-center sm:justify-between sm:p-6">
                            <div class="space-y-1">
                                <h3 class="text-lg font-semibold text-white">Portada promocional</h3>
                                <p class="text-sm text-gray-300">Sube un banner alargado para destacar promociones, retos o anuncios importantes.</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-3">
                                <input type="file" id="dashboard-cover-input" accept="image/*" class="hidden">
                                <button data-action="open-cover-upload" class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/20 transition hover:bg-emerald-400">
                                    <i data-lucide="image-plus" class="h-4 w-4"></i>
                                    Subir portada
                                </button>
                                <button data-action="remove-cover-image" class="inline-flex items-center gap-2 rounded-full border border-white/10 px-4 py-2 text-sm font-semibold text-gray-200 transition hover:border-red-400/60 hover:text-red-300">
                                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                                    Quitar
                                </button>
                            </div>
                            <div id="dashboard-cover-progress" class="hidden w-full items-center gap-3 rounded-2xl border border-white/10 bg-gray-950/70 px-4 py-3">
                                <div class="relative h-2 flex-1 overflow-hidden rounded-full bg-white/10">
                                    <div id="dashboard-cover-progress-bar" class="h-full w-0 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 transition-[width] duration-300"></div>
                                </div>
                                <span id="dashboard-cover-progress-text" class="text-xs font-semibold text-gray-300">Preparando...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid gap-4 lg:grid-cols-2">
                    <div class="rounded-3xl border border-emerald-400/20 bg-gradient-to-br from-emerald-500/20 via-emerald-500/10 to-teal-500/20 p-6 text-white shadow-lg shadow-emerald-500/20">
                        <div class="flex flex-col gap-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-white/80">Meta diaria</p>
                                    <h3 class="mt-1 text-3xl font-black" id="dashboard-calories">2,500 kcal</h3>
                                </div>
                                <span class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-white/90">
                                    <i data-lucide="target" class="h-4 w-4"></i>
                                    En progreso
                                </span>
                            </div>
                            <div>
                                <div class="h-2.5 w-full rounded-full bg-black/30">
                                    <div id="dashboard-progress-bar" class="h-2.5 rounded-full bg-white transition-all duration-500 ease-out" style="width: 0%"></div>
                                </div>
                                <p class="mt-2 text-right text-xs text-white/80">Progreso: <span id="dashboard-progress-text">0</span>%</p>
                            </div>
                            <div class="grid grid-cols-1 gap-3 sm:grid-cols-3">
                                <div class="rounded-2xl bg-white/10 p-3">
                                    <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-white/70">Proteínas</p>
                                    <p class="mt-1 text-lg font-bold text-white" id="dashboard-goal-protein">0 g</p>
                                    <p class="text-xs text-white/80"><span id="dashboard-consumed-protein">0</span> g consumidos</p>
                                </div>
                                <div class="rounded-2xl bg-white/10 p-3">
                                    <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-white/70">Carbohidratos</p>
                                    <p class="mt-1 text-lg font-bold text-white" id="dashboard-goal-carbs">0 g</p>
                                    <p class="text-xs text-white/80"><span id="dashboard-consumed-carbs">0</span> g consumidos</p>
                                </div>
                                <div class="rounded-2xl bg-white/10 p-3">
                                    <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-white/70">Grasas</p>
                                    <p class="mt-1 text-lg font-bold text-white" id="dashboard-goal-fats">0 g</p>
                                    <p class="text-xs text-white/80"><span id="dashboard-consumed-fats">0</span> g consumidos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="weekly-progress-card" class="rounded-3xl border border-white/10 bg-gray-900/60 p-6 shadow-lg shadow-emerald-500/10"></div>
                </div>

                <div class="grid gap-3 sm:grid-cols-2 xl:grid-cols-5">
                    <button data-action="show-section" data-section-id="rutinas" class="rounded-3xl border border-white/10 bg-white/5 p-4 text-left shadow-lg shadow-emerald-500/10 transition hover:border-emerald-400/50 hover:bg-emerald-500/10">
                        <div class="flex items-center gap-3">
                            <span class="flex h-11 w-11 items-center justify-center rounded-2xl bg-emerald-500/20 text-emerald-300">
                                <i data-lucide="clipboard-list" class="h-5 w-5"></i>
                            </span>
                            <div>
                                <p class="text-sm font-semibold text-white">Rutinas activas</p>
                                <p class="text-xs text-gray-400">Crea, revisa o lanza sesiones en segundos.</p>
                            </div>
                        </div>
                    </button>
                    <button data-action="show-section" data-section-id="perfil" class="rounded-3xl border border-white/10 bg-white/5 p-4 text-left shadow-lg shadow-emerald-500/10 transition hover:border-emerald-400/50 hover:bg-emerald-500/10">
                        <div class="flex items-center gap-3">
                            <span class="flex h-11 w-11 items-center justify-center rounded-2xl bg-emerald-500/20 text-emerald-300">
                                <i data-lucide="user" class="h-5 w-5"></i>
                            </span>
                            <div>
                                <p class="text-sm font-semibold text-white">Mi perfil</p>
                                <p class="text-xs text-gray-400">Actualiza datos personales y objetivos.</p>
                            </div>
                        </div>
                    </button>
                    <button data-action="show-section" data-section-id="dieta" class="rounded-3xl border border-white/10 bg-white/5 p-4 text-left shadow-lg shadow-emerald-500/10 transition hover:border-emerald-400/50 hover:bg-emerald-500/10">
                        <div class="flex items-center gap-3">
                            <span class="flex h-11 w-11 items-center justify-center rounded-2xl bg-emerald-500/20 text-emerald-300">
                                <i data-lucide="salad" class="h-5 w-5"></i>
                            </span>
                            <div>
                                <p class="text-sm font-semibold text-white">Mi dieta</p>
                                <p class="text-xs text-gray-400">Gestiona comidas y seguimiento diario.</p>
                            </div>
                        </div>
                    </button>
                    <button data-action="show-section" data-section-id="comunidad" class="rounded-3xl border border-white/10 bg-white/5 p-4 text-left shadow-lg shadow-emerald-500/10 transition hover:border-emerald-400/50 hover:bg-emerald-500/10">
                        <div class="flex items-center gap-3">
                            <span class="flex h-11 w-11 items-center justify-center rounded-2xl bg-amber-500/20 text-amber-300">
                                <i data-lucide="trophy" class="h-5 w-5"></i>
                            </span>
                            <div>
                                <p class="text-sm font-semibold text-white">Ranking global</p>
                                <p class="text-xs text-gray-400">Descubre quién lidera la comunidad esta semana.</p>
                            </div>
                        </div>
                    </button>
                    <div class="rounded-3xl border border-white/10 bg-white/5 p-4 shadow-lg shadow-emerald-500/10">
                        <div class="flex items-start gap-3">
                            <span class="flex h-11 w-11 items-center justify-center rounded-2xl bg-rose-500/20 text-rose-300">
                                <i data-lucide="flame" class="h-5 w-5"></i>
                            </span>
                            <div>
                                <p class="text-sm font-semibold text-white">Calorías consumidas hoy</p>
                                <p id="dashboard-consumed-calories" class="text-lg font-bold text-white">0 Kcal</p>
                                <p class="text-xs text-gray-400">Marca alimentos como completados para registrar tu avance.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </template>
    
    <template id="template-rutinas">
        <section id="rutinas" class="section-content hidden">
            <div class="space-y-12">
                <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-emerald-500/15 via-gray-900 to-gray-900 p-8 shadow-2xl shadow-emerald-500/10">
                    <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_right,_rgba(16,185,129,0.18),_transparent_45%)]"></div>
                    <div class="absolute -right-24 -top-24 h-72 w-72 rounded-full bg-emerald-500/10 blur-3xl"></div>
                    <div class="relative flex flex-col gap-10 lg:flex-row lg:items-center lg:justify-between">
                        <div class="max-w-2xl space-y-4">
                            <p class="text-xs uppercase tracking-[0.35em] text-emerald-300">Experiencia inmersiva</p>
                            <h2 class="text-3xl font-black text-white sm:text-4xl">Diseña, vive y comparte tus rutinas con estilo premium</h2>
                            <p class="text-base text-gray-300 sm:text-lg">Curamos tus entrenamientos con visuales envolventes, métricas en tiempo real y playlists energéticas para transformar cada sesión en un ritual memorable.</p>
                            <div class="flex flex-wrap gap-3">
                                <button id="create-routine-btn" data-action="routine-create" class="inline-flex items-center gap-2 rounded-2xl bg-white px-5 py-3 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/20 transition hover:bg-emerald-100">
                                    <i data-lucide="plus" class="h-5 w-5"></i>
                                    <span>Crear rutina magistral</span>
                                </button>
                                <button data-action="show-section" data-section-id="rutinas" class="inline-flex items-center gap-2 rounded-2xl border border-white/20 bg-white/5 px-5 py-3 text-sm font-semibold text-white transition hover:border-emerald-400/40 hover:bg-emerald-500/10">
                                    <i data-lucide="wand2" class="h-5 w-5 text-emerald-300"></i>
                                    <span>Explorar experiencia</span>
                                </button>
                            </div>
                        </div>
                        <div class="grid w-full max-w-sm grid-cols-2 gap-4 rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur lg:max-w-md">
                            <div class="space-y-3 rounded-2xl bg-gray-900/60 p-4 shadow-lg shadow-emerald-500/10">
                                <div class="flex items-center justify-between text-xs font-semibold text-emerald-300">
                                    <span>Sesión de hoy</span>
                                    <span class="flex items-center gap-1 text-emerald-200"><i data-lucide="activity" class="h-4 w-4"></i> Intensidad</span>
                                </div>
                                <p class="text-2xl font-bold text-white">Pecho + Core</p>
                                <div class="space-y-2 text-sm text-gray-300">
                                    <p>Calorías estimadas: <span class="font-semibold text-white">520 kcal</span></p>
                                    <p>Duración total: <span class="font-semibold text-white">48 min</span></p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-300">
                                        <i data-lucide="play" class="h-5 w-5"></i>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold uppercase tracking-wider text-gray-400">Próxima acción</p>
                                        <p class="text-sm font-semibold text-white">Iniciar calentamiento</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col justify-between rounded-2xl bg-gray-900/60 p-4 shadow-lg shadow-emerald-500/10">
                                <div class="space-y-3">
                                    <div class="flex items-center gap-3">
                                        <span class="flex h-9 w-9 items-center justify-center rounded-full bg-emerald-500/10 text-emerald-300"><i data-lucide="clock" class="h-4 w-4"></i></span>
                                        <div>
                                            <p class="text-xs uppercase tracking-wider text-gray-400">Racha activa</p>
                                            <p class="text-lg font-bold text-white">12 días</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="flex h-9 w-9 items-center justify-center rounded-full bg-emerald-500/10 text-emerald-300"><i data-lucide="flame" class="h-4 w-4"></i></span>
                                        <div>
                                            <p class="text-xs uppercase tracking-wider text-gray-400">Nivel de energía</p>
                                            <p class="text-lg font-bold text-white">95%</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="rounded-2xl bg-gradient-to-r from-emerald-500/20 via-emerald-400/10 to-transparent p-4">
                                    <p class="text-xs uppercase tracking-[0.35em] text-emerald-300">Próximo hito</p>
                                    <p class="text-sm font-semibold text-white">Domina la rutina Élite en 4 sesiones</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="routine-admin-banner-card" class="hidden overflow-hidden rounded-3xl border border-white/10 bg-gray-900/70 shadow-[0_45px_140px_-70px_rgba(16,185,129,0.65)]">
                    <div class="relative aspect-[21/9] overflow-hidden">
                        <div id="routine-admin-banner-skeleton" class="image-loading-placeholder"></div>
                        <img id="routine-admin-banner-preview" alt="Banner publicitario de rutinas" class="routine-banner-image absolute inset-0 h-full w-full object-cover opacity-0 transition-opacity duration-500" />
                        <div id="routine-admin-banner-fallback" class="image-fallback absolute inset-0 hidden flex-col items-center justify-center gap-2 bg-gray-900/80 text-center text-gray-400">
                            <i data-lucide="layout-dashboard" class="h-10 w-10 text-emerald-300/80"></i>
                            <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/80">Banner de rutinas</p>
                            <p class="max-w-sm text-sm text-gray-400">Sube una imagen panorámica 21:9 para destacar campañas o anuncios dentro del apartado de rutinas.</p>
                        </div>
                        <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/65 via-black/20 to-transparent"></div>
                    </div>
                    <div class="flex flex-col gap-4 border-t border-white/5 p-5 sm:flex-row sm:items-center sm:justify-between sm:p-6">
                        <div class="space-y-1">
                            <h3 class="text-lg font-semibold text-white">Banner destacado para rutinas</h3>
                            <p class="text-sm text-gray-300">Formato recomendado 21:9 (ej. 2100×900 px) optimizado para verse sin parpadeos.</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-3">
                            <input type="file" id="routine-banner-input" accept="image/*" class="hidden">
                            <button data-action="open-routine-banner-upload" class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/20 transition hover:bg-emerald-400">
                                <i data-lucide="image-plus" class="h-4 w-4"></i>
                                Subir banner
                            </button>
                            <button data-action="remove-routine-banner-image" class="inline-flex items-center gap-2 rounded-full border border-white/10 px-4 py-2 text-sm font-semibold text-gray-200 transition hover:border-red-400/60 hover:text-red-300">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                                Quitar
                            </button>
                        </div>
                        <div id="routine-banner-progress" class="hidden w-full items-center gap-3 rounded-2xl border border-white/10 bg-gray-950/70 px-4 py-3">
                            <div class="relative h-2 flex-1 overflow-hidden rounded-full bg-white/10">
                                <div id="routine-banner-progress-bar" class="h-full w-0 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 transition-[width] duration-300"></div>
                            </div>
                            <span id="routine-banner-progress-text" class="text-xs font-semibold text-gray-300">Preparando...</span>
                        </div>
                    </div>
                </div>

                <div id="user-routines-section" class="space-y-4">
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-white">Mis Rutinas Personalizadas</h3>
                            <p class="text-sm text-gray-400">Accede a tus colecciones exclusivas, listas para ejecutar con una experiencia inmersiva en cada paso.</p>
                        </div>
                        <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-gray-400">
                            <span class="flex items-center gap-1 rounded-full border border-white/10 px-3 py-1"><i data-lucide="badge-check" class="h-4 w-4 text-emerald-300"></i> Certificadas</span>
                            <span class="flex items-center gap-1 rounded-full border border-white/10 px-3 py-1"><i data-lucide="cpu" class="h-4 w-4 text-emerald-300"></i> Smart Coach</span>
                        </div>
                    </div>
                    <div class="relative">
                        <div class="pointer-events-none absolute -inset-y-8 -left-16 hidden w-24 bg-gradient-to-r from-gray-900 to-transparent lg:block"></div>
                        <div class="pointer-events-none absolute -inset-y-8 -right-16 hidden w-24 bg-gradient-to-l from-gray-900 to-transparent lg:block"></div>
                        <div id="user-routines-container" class="horizontal-scroll-container flex gap-5 overflow-x-auto pb-6 pt-2 pl-1 pr-6 lg:grid lg:grid-cols-2 xl:grid-cols-3 lg:gap-6 lg:overflow-visible lg:p-0">
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <h3 class="text-xl font-semibold text-white">Entrenamiento en casa</h3>
                            <p class="text-sm text-gray-400">Diseñado para espacios reducidos, con progresiones creativas, respiración guiada y playlists sincronizadas.</p>
                        </div>
                        <a href="#" class="inline-flex items-center gap-2 text-sm font-semibold text-emerald-300 hover:text-emerald-200">
                            Ver guía completa
                            <i data-lucide="arrow-up-right" class="h-4 w-4"></i>
                        </a>
                    </div>
                    <div class="grid gap-5 md:grid-cols-2 xl:grid-cols-3">
                        <article class="group relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-gray-800/80 via-gray-900 to-gray-900 p-6 shadow-lg shadow-emerald-500/10">
                            <div class="absolute inset-0 opacity-0 transition group-hover:opacity-100">
                                <div class="h-full w-full bg-[radial-gradient(circle_at_center,_rgba(16,185,129,0.22),_transparent_55%)]"></div>
                            </div>
                            <div class="relative space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-200">Bodyweight Élite</span>
                                    <i data-lucide="home" class="h-5 w-5 text-emerald-200"></i>
                                </div>
                                <h4 class="text-lg font-semibold text-white">Flow Metabólico 360°</h4>
                                <p class="text-sm text-gray-300">Circuitos intensivos de alta energía con respiración consciente y visualización para mantener la mente enfocada.</p>
                                <ul class="space-y-1 text-sm text-gray-400">
                                    <li class="flex items-center gap-2"><i data-lucide="wand2" class="h-4 w-4 text-emerald-300"></i>15 min de activación neuromuscular</li>
                                    <li class="flex items-center gap-2"><i data-lucide="move-horizontal" class="h-4 w-4 text-emerald-300"></i>5 bloques de fuerza dinámica</li>
                                    <li class="flex items-center gap-2"><i data-lucide="wind" class="h-4 w-4 text-emerald-300"></i>Meditación guiada post-sesión</li>
                                </ul>
                            </div>
                        </article>
                        <article class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-slate-800/80 via-gray-900 to-gray-900 p-6 shadow-lg shadow-emerald-500/10">
                            <div class="absolute inset-0 opacity-0 transition hover:opacity-100">
                                <div class="h-full w-full bg-[radial-gradient(circle_at_top_left,_rgba(59,130,246,0.22),_transparent_55%)]"></div>
                            </div>
                            <div class="relative space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="rounded-full bg-blue-500/20 px-3 py-1 text-xs font-semibold text-blue-200">Minimal Equipment</span>
                                    <i data-lucide="dumbbell" class="h-5 w-5 text-blue-200"></i>
                                </div>
                                <h4 class="text-lg font-semibold text-white">Studio Sculpt en casa</h4>
                                <p class="text-sm text-gray-300">Ritmos bajos con bandas y mancuernas ligeras para esculpir, acompañado de ambientaciones sonoras inmersivas.</p>
                                <ul class="space-y-1 text-sm text-gray-400">
                                    <li class="flex items-center gap-2"><i data-lucide="radio" class="h-4 w-4 text-blue-300"></i>Playlist chill-hop exclusiva</li>
                                    <li class="flex items-center gap-2"><i data-lucide="layers" class="h-4 w-4 text-blue-300"></i>3 fases de progresión consciente</li>
                                    <li class="flex items-center gap-2"><i data-lucide="droplets" class="h-4 w-4 text-blue-300"></i>Sección de estiramientos líquidos</li>
                                </ul>
                            </div>
                        </article>
                        <article class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-rose-800/60 via-gray-900 to-gray-900 p-6 shadow-lg shadow-emerald-500/10">
                            <div class="absolute inset-0 opacity-0 transition hover:opacity-100">
                                <div class="h-full w-full bg-[radial-gradient(circle_at_bottom_right,_rgba(244,114,182,0.25),_transparent_55%)]"></div>
                            </div>
                            <div class="relative space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="rounded-full bg-rose-500/20 px-3 py-1 text-xs font-semibold text-rose-200">Mindful Reset</span>
                                    <i data-lucide="wand2" class="h-5 w-5 text-rose-200"></i>
                                </div>
                                <h4 class="text-lg font-semibold text-white">Sunrise Mobility Ritual</h4>
                                <p class="text-sm text-gray-300">Secuencias suaves para despertar articulaciones y alinear postura con respiración guiada y visuales amanecer.</p>
                                <ul class="space-y-1 text-sm text-gray-400">
                                    <li class="flex items-center gap-2"><i data-lucide="sunrise" class="h-4 w-4 text-rose-300"></i>Respiraciones diafragmáticas</li>
                                    <li class="flex items-center gap-2"><i data-lucide="infinity" class="h-4 w-4 text-rose-300"></i>Movilidad en flujo continuo</li>
                                    <li class="flex items-center gap-2"><i data-lucide="headphones" class="h-4 w-4 text-rose-300"></i>Audio binaural restaurador</li>
                                </ul>
                            </div>
                        </article>
                    </div>
                </div>

                <div id="predefined-routines-section" class="space-y-5">
                    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                        <div class="space-y-2">
                            <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-300/70">Curaduría oficial</p>
                            <h3 class="text-2xl font-semibold text-white">Colecciones editoriales de alto rendimiento</h3>
                            <p class="text-sm text-gray-400 max-w-2xl">Explora compilaciones premium diseñadas por coaches élite con narrativa inmersiva, métricas listas y lanzadores instantáneos para cada sesión.</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-2 text-[11px] font-semibold uppercase tracking-[0.25em] text-gray-400">
                            <span class="flex items-center gap-2 rounded-full border border-white/10 px-4 py-2 bg-gray-800/60"><i data-lucide="sparkles" class="h-4 w-4 text-emerald-300"></i> Live Sync</span>
                            <span class="flex items-center gap-2 rounded-full border border-white/10 px-4 py-2 bg-gray-800/60"><i data-lucide="zap" class="h-4 w-4 text-emerald-300"></i> Intensidad calibrada</span>
                        </div>
                    </div>
                    <div id="predefined-routines-container" class="space-y-6"></div>
                </div>
            </div>
        </section>
    </template>
    
    <template id="template-asesorados">
        <section id="asesorados" class="section-content hidden">
            <div class="space-y-6">
                <div>
                    <h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="history" class="h-6 w-6 text-emerald-400"></i><span>Gestión de Asesorados</span></h2>
                    <p class="text-gray-400">Invita y gestiona los planes de tus clientes.</p>
                </div>
                
                <div class="bg-gray-700/50 p-4 rounded-2xl">
                    <h3 class="font-semibold text-lg mb-3">Invitar a un Nuevo Cliente</h3>
                    <form id="invite-form" class="flex flex-col gap-3 sm:flex-row">
                        <input type="email" id="invite-email" placeholder="email@cliente.com" required class="w-full bg-gray-700 rounded-lg p-2 focus:ring-2 focus:ring-emerald-500 focus:outline-none transition">
                        <button type="submit" class="bg-emerald-500 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-emerald-400 transition sm:w-auto">Invitar</button>
                    </form>
                </div>

                <div>
                    <h3 class="font-semibold text-lg mb-3">Mis Clientes</h3>
                    <div id="asesorados-list" class="space-y-3">
                        <p class="text-gray-500 text-center p-4">Aún no tienes clientes.</p>
                    </div>
                </div>
            </div>
        </section>
    </template>

    <template id="template-roles">
        <section id="roles" class="section-content hidden">
            <div class="space-y-8">
                <div class="rounded-[2rem] border border-white/10 bg-gradient-to-br from-emerald-500/10 via-emerald-500/5 to-sky-500/10 p-6 sm:p-8 shadow-[0_45px_140px_-70px_rgba(16,185,129,0.75)]">
                    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                        <div class="space-y-3">
                            <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-4 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200">
                                <i data-lucide="shield-check" class="h-4 w-4"></i>
                                Control central
                            </span>
                            <h2 class="text-3xl font-black text-white">Roles y accesos</h2>
                            <p class="max-w-2xl text-sm text-emerald-50/80">Administra entrenadores, define accesos y genera invitaciones seguras para que cada perfil ingrese a su panel personalizado.</p>
                        </div>
                        <div class="grid gap-3 text-sm text-emerald-100/80 sm:grid-cols-2">
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                                <p class="text-[11px] uppercase tracking-[0.35em] text-emerald-100/70">Entrenadores activos</p>
                                <p id="roles-coach-count" class="mt-2 text-3xl font-semibold text-white">0</p>
                                <p class="text-[11px] text-emerald-100/60">Cuentan con panel completo de gestión</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                                <p class="text-[11px] uppercase tracking-[0.35em] text-emerald-100/70">Invitaciones pendientes</p>
                                <p id="roles-invite-count" class="mt-2 text-3xl font-semibold text-white">0</p>
                                <p class="text-[11px] text-emerald-100/60">Caducan al primer uso</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid gap-6 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
                    <div class="space-y-6">
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
                            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <div>
                                    <h3 class="text-xl font-semibold text-white">Invitar a un nuevo entrenador</h3>
                                    <p class="text-sm text-gray-400">Genera un enlace único para que el entrenador configure su acceso.</p>
                                </div>
                                <button data-action="refresh-roles" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200 transition hover:border-emerald-300 hover:text-emerald-100">
                                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                                    Actualizar
                                </button>
                            </div>
                            <form id="roles-invite-form" class="mt-5 space-y-4" autocomplete="off">
                                <div class="grid gap-3 sm:grid-cols-[minmax(0,1fr)_minmax(0,220px)]">
                                    <div>
                                        <label for="roles-invite-email" class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Email del entrenador</label>
                                        <input type="email" id="roles-invite-email" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-4 py-3 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                    </div>
                                    <div>
                                        <label for="roles-invite-note" class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Nota opcional</label>
                                        <input type="text" id="roles-invite-note" maxlength="80" class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-4 py-3 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                    </div>
                                </div>
                                <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-full bg-gradient-to-r from-emerald-400 via-emerald-500 to-teal-400 px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-gray-900 shadow-[0_20px_45px_-25px_rgba(16,185,129,0.95)] transition hover:from-emerald-300 hover:via-emerald-400 hover:to-teal-300">
                                    <i data-lucide="send" class="h-4 w-4"></i>
                                    Enviar invitación
                                </button>
                            </form>
                        </div>

                        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
                            <div class="flex items-center justify-between gap-3">
                                <h3 class="text-lg font-semibold text-white flex items-center gap-2"><i data-lucide="users" class="h-5 w-5 text-emerald-300"></i>Entrenadores con acceso</h3>
                                <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-gray-400" id="roles-coach-sync-label">Sincronizado</span>
                            </div>
                            <div id="roles-trainers-list" class="mt-4 space-y-3">
                                <p class="rounded-2xl border border-white/5 bg-gray-900/60 p-4 text-sm text-gray-400">No hay entrenadores registrados aún.</p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="rounded-3xl border border-emerald-400/30 bg-emerald-500/10 p-6">
                            <h3 class="text-lg font-semibold text-white flex items-center gap-2"><i data-lucide="link" class="h-5 w-5 text-emerald-200"></i>Invitaciones pendientes</h3>
                            <p class="mt-1 text-sm text-emerald-50/80">Comparte el enlace generado para que el entrenador finalice su registro.</p>
                            <div id="roles-invitations-list" class="mt-4 space-y-3">
                                <p class="rounded-2xl border border-emerald-400/20 bg-gray-900/60 p-4 text-sm text-emerald-100/80">Sin invitaciones activas.</p>
                            </div>
                        </div>
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-6 space-y-4">
                            <h3 class="text-lg font-semibold text-white">Flujo de acceso</h3>
                            <ul class="space-y-3 text-sm text-gray-300">
                                <li class="flex items-start gap-3"><i data-lucide="arrow-right" class="mt-1 h-4 w-4 text-emerald-300"></i><span>El administrador crea la invitación y comparte el enlace único al entrenador.</span></li>
                                <li class="flex items-start gap-3"><i data-lucide="arrow-right" class="mt-1 h-4 w-4 text-emerald-300"></i><span>El entrenador registra su cuenta con panel completo, sin acceso a cambios de portada global.</span></li>
                                <li class="flex items-start gap-3"><i data-lucide="arrow-right" class="mt-1 h-4 w-4 text-emerald-300"></i><span>Desde su panel, el entrenador invita a los asesorados y vincula sus rutinas y planes de dieta.</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </template>

    
<template id="template-nutricion">
    <section id="nutricion" class="section-content hidden">
        <div class="space-y-8 pb-10">
            <div class="relative overflow-hidden rounded-[2rem] border border-white/10 bg-gradient-to-br from-gray-950/90 via-gray-900/70 to-gray-900/40 p-6 sm:p-8 shadow-[0_45px_120px_-60px_rgba(56,189,248,0.55)]">
                <div class="pointer-events-none absolute inset-0">
                    <div class="absolute -top-32 -left-20 h-56 w-56 rounded-full bg-emerald-500/20 blur-3xl"></div>
                    <div class="absolute -bottom-32 right-0 h-64 w-64 rounded-full bg-sky-500/20 blur-3xl"></div>
                </div>
                <div class="relative flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
                    <div class="space-y-4">
                        <span class="inline-flex w-fit items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-4 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200">Suite analítica</span>
                        <h2 class="text-3xl font-black leading-tight text-white sm:text-4xl">Herramientas de cálculo inteligentes</h2>
                        <p class="max-w-xl text-sm text-emerald-50/80 sm:text-base">Optimiza tus decisiones con métricas enlazadas a tu progreso real: calorías, macros, tendencias de peso y fuerza en una sola vista.</p>
                        <div class="flex flex-wrap items-center gap-2 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-100/80">
                            <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1"><i data-lucide="link" class="h-3.5 w-3.5 text-emerald-300"></i><span>Datos sincronizados</span></span>
                            <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1"><i data-lucide="smartphone" class="h-3.5 w-3.5 text-emerald-300"></i><span>Experiencia móvil</span></span>
                        </div>
                    </div>
                    <div class="grid w-full grid-cols-2 gap-3 text-sm text-emerald-100/80 sm:max-w-xl lg:grid-cols-2">
                        <div class="header-metric rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner shadow-emerald-500/20">
                            <p class="text-[11px] uppercase tracking-[0.28em] text-emerald-100/70">Peso actual</p>
                            <p id="calc-current-weight" class="mt-2 text-2xl font-bold text-white">--</p>
                            <p id="calc-last-update" class="text-[11px] text-emerald-100/60">Registra tu primer dato</p>
                        </div>
                        <div class="header-metric rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner shadow-emerald-500/20">
                            <p class="text-[11px] uppercase tracking-[0.28em] text-emerald-100/70">Peso objetivo</p>
                            <p id="calc-goal-weight" class="mt-2 text-2xl font-bold text-white">--</p>
                            <p id="calc-goal-diff" class="text-[11px] text-emerald-100/60">Define tu objetivo</p>
                        </div>
                        <div class="header-metric rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner shadow-emerald-500/20">
                            <p class="text-[11px] uppercase tracking-[0.28em] text-emerald-100/70">Tendencia</p>
                            <p id="calc-trend-label" class="mt-2 text-base font-semibold text-white">--</p>
                            <p id="calc-direction-label" class="text-[11px] text-emerald-100/60">Añade registros para ver más detalles.</p>
                            <p id="calc-trend-description" class="mt-1 text-[11px] text-gray-400">--</p>
                        </div>
                        <div class="header-metric rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner shadow-emerald-500/20">
                            <div class="flex items-center justify-between">
                                <p class="text-[11px] uppercase tracking-[0.28em] text-emerald-100/70">Progreso</p>
                                <span id="calc-progress-label" class="text-sm font-semibold text-emerald-100">0%</span>
                            </div>
                            <div class="mt-3 h-2.5 w-full overflow-hidden rounded-full bg-white/10">
                                <div id="calc-progress-bar" class="h-full rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-300 transition-all duration-500 ease-out" style="width: 0%"></div>
                            </div>
                            <p id="calc-projection-pace" class="mt-2 text-[11px] text-emerald-100/70">Ritmo actual no disponible.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="space-y-4">
                <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-white">Panel de cálculos</h3>
                        <p class="text-sm text-gray-400">Explora nutrición, métricas corporales y fuerza con visualizaciones reales.</p>
                    </div>
                    <div class="rounded-full border border-white/10 bg-gray-900/70 p-1 text-xs font-semibold text-gray-300 shadow-inner shadow-emerald-500/10">
                        <div class="grid grid-cols-3 gap-1">
                            <button data-tab="nutricion" class="calc-tab-btn rounded-full px-4 py-2 text-center transition focus:outline-none focus:ring-2 focus:ring-emerald-400/50 bg-emerald-500 text-gray-900">Nutrición</button>
                            <button data-tab="metricas" class="calc-tab-btn rounded-full px-4 py-2 text-center transition focus:outline-none focus:ring-2 focus:ring-emerald-400/50 text-gray-300">Métricas</button>
                            <button data-tab="fuerza" class="calc-tab-btn rounded-full px-4 py-2 text-center transition focus:outline-none focus:ring-2 focus:ring-emerald-400/50 text-gray-300">Fuerza</button>
                        </div>
                    </div>
                </div>
                <div id="calc-tabs-content">
                    <div id="tab-content-nutricion" class="calc-tab-content space-y-6">
                        <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-5 shadow-lg shadow-emerald-500/10">
                            <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <div>
                                    <h3 class="text-xl font-bold text-white">Metas de Nutrición</h3>
                                    <p class="text-sm text-gray-400">Calcula tus calorías y macros diarios según tu objetivo actual.</p>
                                </div>
                                <span class="analytics-chip text-[10px] font-semibold uppercase tracking-[0.3em] text-emerald-100/80"><i data-lucide="zap" class="h-3.5 w-3.5 text-emerald-300"></i>Resultado instantáneo</span>
                            </header>
                            <form id="nutrition-form" class="mt-6 space-y-6">
                                <div class="grid grid-cols-2 gap-3 text-xs font-semibold uppercase tracking-[0.25em] text-gray-300 sm:text-sm">
                                    <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-center transition has-[:checked]:border-emerald-400/50 has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:shadow-lg has-[:checked]:shadow-emerald-500/30">
                                        <input type="radio" name="gender" value="male" class="sr-only" checked>
                                        Hombre
                                    </label>
                                    <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-center transition has-[:checked]:border-emerald-400/50 has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:shadow-lg has-[:checked]:shadow-emerald-500/30">
                                        <input type="radio" name="gender" value="female" class="sr-only">
                                        Mujer
                                    </label>
                                </div>
                                <div class="grid gap-4 sm:grid-cols-3">
                                    <div class="rounded-2xl border border-white/10 bg-gray-950/60 p-4">
                                        <label for="age" class="block text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Edad</label>
                                        <input type="number" id="age" class="mt-2 w-full rounded-xl border border-white/10 bg-gray-900/80 py-3 text-center text-sm text-white placeholder:text-gray-500 focus:border-emerald-400/40 focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                    </div>
                                    <div class="rounded-2xl border border-white/10 bg-gray-950/60 p-4">
                                        <label for="weight" class="block text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Peso (kg)</label>
                                        <input type="number" step="0.1" id="weight" class="mt-2 w-full rounded-xl border border-white/10 bg-gray-900/80 py-3 text-center text-sm text-white placeholder:text-gray-500 focus:border-emerald-400/40 focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                    </div>
                                    <div class="rounded-2xl border border-white/10 bg-gray-950/60 p-4">
                                        <label for="height" class="block text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Altura (cm)</label>
                                        <input type="number" id="height" class="mt-2 w-full rounded-xl border border-white/10 bg-gray-900/80 py-3 text-center text-sm text-white placeholder:text-gray-500 focus:border-emerald-400/40 focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                    </div>
                                </div>
                                <div class="rounded-2xl border border-white/10 bg-gray-950/60 p-4">
                                    <label for="activity" class="block text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Nivel de Actividad</label>
                                    <select id="activity" class="mt-2 w-full rounded-xl border border-white/10 bg-gray-900/80 px-4 py-3 text-sm text-white focus:border-emerald-400/40 focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                        <option value="1.2">Sedentario</option>
                                        <option value="1.375">Ligero</option>
                                        <option value="1.55" selected>Moderado</option>
                                        <option value="1.725">Activo</option>
                                        <option value="1.9">Muy Activo</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-3 gap-3 text-xs font-semibold uppercase tracking-[0.25em] text-gray-300 sm:text-sm">
                                    <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-center transition has-[:checked]:border-emerald-400/50 has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:shadow-lg has-[:checked]:shadow-emerald-500/30">
                                        <input type="radio" name="goal" value="lose" class="sr-only">
                                        Perder
                                    </label>
                                    <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-center transition has-[:checked]:border-emerald-400/50 has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:shadow-lg has-[:checked]:shadow-emerald-500/30">
                                        <input type="radio" name="goal" value="maintain" class="sr-only" checked>
                                        Mantener
                                    </label>
                                    <label class="cursor-pointer rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-center transition has-[:checked]:border-emerald-400/50 has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:shadow-lg has-[:checked]:shadow-emerald-500/30">
                                        <input type="radio" name="goal" value="gain" class="sr-only">
                                        Ganar
                                    </label>
                                </div>
                                <button type="submit" class="flex w-full items-center justify-center gap-2 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 px-6 py-3 text-sm font-semibold uppercase tracking-[0.35em] text-gray-900 shadow-lg shadow-emerald-500/30 transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                                    Calcular y actualizar
                                </button>
                            </form>
                        </div>
                        <div id="nutrition-results" class="hidden space-y-6">
                            <div class="grid gap-4 lg:grid-cols-2">
                                <div class="rounded-3xl border border-emerald-400/20 bg-gradient-to-br from-emerald-500/20 via-emerald-500/10 to-cyan-500/20 p-6 text-white shadow-lg shadow-emerald-500/20">
                                    <div class="flex items-start justify-between gap-3">
                                        <div>
                                            <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-50/80">Calorías objetivo</p>
                                            <p id="result-calories" class="mt-2 text-3xl font-black">0 kcal</p>
                                        </div>
                                        <span class="analytics-chip border-emerald-400/40 bg-emerald-500/10 text-[10px] text-emerald-100"><i data-lucide="activity" class="h-3.5 w-3.5 text-emerald-200"></i>Balance diario</span>
                                    </div>
                                    <div class="mt-6 flex flex-col items-center gap-6 sm:flex-row">
                                        <div id="macro-pie" class="macro-pie bg-gradient-to-br from-emerald-500/50 via-sky-500/50 to-fuchsia-500/40">
                                            <div class="macro-pie-content">
                                                <span class="text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-100/80">Total</span>
                                                <p id="macro-energy-total" class="text-2xl font-black text-white">0</p>
                                                <span class="text-xs text-emerald-100/80">kcal</span>
                                            </div>
                                        </div>
                                        <div class="flex-1 space-y-4">
                                            <div>
                                                <div class="flex items-center justify-between text-sm text-emerald-50/90">
                                                    <div class="flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-sky-400"></span><span>Proteína</span><span id="result-protein" class="ml-2 text-xs font-semibold text-white/90">--</span></div>
                                                    <span id="macro-protein-percentage" class="text-xs text-emerald-100/70">0%</span>
                                                </div>
                                                <div class="macro-bar mt-2">
                                                    <div id="macro-protein-bar" class="macro-bar-fill bg-sky-400/80"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="flex items-center justify-between text-sm text-emerald-50/90">
                                                    <div class="flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-yellow-300"></span><span>Carbohidratos</span><span id="result-carbs" class="ml-2 text-xs font-semibold text-white/90">--</span></div>
                                                    <span id="macro-carbs-percentage" class="text-xs text-emerald-100/70">0%</span>
                                                </div>
                                                <div class="macro-bar mt-2">
                                                    <div id="macro-carbs-bar" class="macro-bar-fill bg-yellow-300/80"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="flex items-center justify-between text-sm text-emerald-50/90">
                                                    <div class="flex items-center gap-2"><span class="h-2 w-2 rounded-full bg-rose-400"></span><span>Grasas</span><span id="result-fats" class="ml-2 text-xs font-semibold text-white/90">--</span></div>
                                                    <span id="macro-fats-percentage" class="text-xs text-emerald-100/70">0%</span>
                                                </div>
                                                <div class="macro-bar mt-2">
                                                    <div id="macro-fats-bar" class="macro-bar-fill bg-rose-400/80"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-6 shadow-lg shadow-emerald-500/10">
                                    <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                        <div>
                                            <h4 class="text-lg font-semibold text-white">Proyección y ritmo</h4>
                                            <p class="text-sm text-gray-400">Seguimiento enlazado a tus registros recientes.</p>
                                        </div>
                                        <span id="calc-projection-badge" class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.3em] text-gray-300">Sin datos</span>
                                    </header>
                                    <p id="calc-projection-summary" class="mt-4 text-sm text-gray-300">Añade registros de peso para proyectar tu fecha objetivo.</p>
                                    <div class="mt-4 grid grid-cols-3 gap-3 text-center text-xs text-gray-300">
                                        <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
                                            <p class="text-[10px] uppercase text-gray-400">Fecha estimada</p>
                                            <p id="calc-projection-date" class="text-sm font-semibold text-white">--</p>
                                        </div>
                                        <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
                                            <p class="text-[10px] uppercase text-gray-400">Semanas</p>
                                            <p id="calc-projection-weeks" class="text-sm font-semibold text-white">--</p>
                                        </div>
                                        <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
                                            <p class="text-[10px] uppercase text-gray-400">Diferencia</p>
                                            <p id="calc-diff-label" class="text-sm font-semibold text-white">--</p>
                                        </div>
                                    </div>
                                    <p id="calc-projection-helper" class="mt-4 text-xs text-emerald-100/80">Define tu objetivo de peso.</p>
                                    <p id="calc-projection-pace-detail" class="text-xs text-emerald-200/80">Registra más datos para ver el ritmo.</p>
                                    <button data-action="save-goals" class="mt-6 inline-flex w-full items-center justify-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-5 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-400/20">
                                        <i data-lucide="save" class="h-4 w-4"></i>
                                        Guardar como mi meta
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-content-metricas" class="calc-tab-content hidden space-y-6">
                        <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-5 text-center shadow-lg shadow-sky-500/10">
                            <h3 class="text-xl font-bold text-white">Métricas Corporales</h3>
                            <p class="mt-2 text-sm text-gray-400">Usa tus datos de perfil para obtener un análisis corporal completo.</p>
                            <button data-action="calculate-body-metrics" class="mt-4 inline-flex w-full items-center justify-center gap-2 rounded-full bg-sky-500 px-5 py-3 text-sm font-semibold uppercase tracking-[0.35em] text-white shadow-lg shadow-sky-500/30 transition hover:bg-sky-400">
                                <i data-lucide="scan-line" class="h-5 w-5"></i>
                                Calcular mis métricas
                            </button>
                        </div>
                        <div id="body-metrics-results" class="space-y-6">
                            <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-6 shadow-lg shadow-sky-500/10">
                                <h3 class="text-lg font-semibold text-white">Índice de Masa Corporal (IMC)</h3>
                                <div class="my-4 flex items-baseline justify-center gap-2">
                                    <p id="bmi-value" class="text-4xl font-bold text-white">--</p>
                                    <p id="bmi-category" class="font-semibold text-gray-400">Sin calcular</p>
                                </div>
                                <div class="relative w-full">
                                    <div class="absolute inset-x-0 top-1/2 h-2 -translate-y-1/2 overflow-hidden rounded-full">
                                        <div class="flex h-full w-full">
                                            <div class="w-[25%] bg-sky-500" title="Bajo Peso (<18.5)"></div>
                                            <div class="w-[30%] bg-emerald-500" title="Normal (18.5-24.9)"></div>
                                            <div class="w-[25%] bg-yellow-500" title="Sobrepeso (25-29.9)"></div>
                                            <div class="w-[20%] bg-red-500" title="Obesidad (>30)"></div>
                                        </div>
                                    </div>
                                    <div id="bmi-marker" class="absolute top-1/2 h-5 w-5 -translate-x-1/2 -translate-y-1/2 rounded-full border-4 border-gray-900 bg-white" style="left: 0%;"></div>
                                </div>
                            </div>
                            <div class="grid gap-4 md:grid-cols-2">
                                <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-6 text-center shadow-lg shadow-sky-500/10">
                                    <h4 class="font-semibold text-gray-300">Grasa Corporal (Est.)</h4>
                                    <p class="my-2 text-3xl font-bold text-sky-300"><span id="bodyfat-value">--</span>%</p>
                                    <p class="text-xs text-gray-500">*Es una estimación, no un valor médico.</p>
                                </div>
                                <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-6 text-center shadow-lg shadow-sky-500/10">
                                    <h4 class="font-semibold text-gray-300">Peso Ideal (Rango)</h4>
                                    <p id="ideal-weight-value" class="my-2 text-3xl font-bold text-sky-300">--</p>
                                    <p class="text-xs text-gray-500">Basado en un IMC saludable.</p>
                                </div>
                            </div>
                            <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-6 text-center shadow-lg shadow-sky-500/10">
                                <h4 class="font-semibold text-gray-300">Hidratación Diaria Recom.</h4>
                                <p class="my-2 text-3xl font-bold text-sky-300"><span id="water-intake-value">--</span> L</p>
                                <p class="text-xs text-gray-500">Ajusta según tu actividad y clima.</p>
                            </div>
                        </div>
                    </div>
                    <div id="tab-content-fuerza" class="calc-tab-content hidden space-y-6">
                        <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-5 shadow-lg shadow-purple-500/10">
                            <h3 class="text-xl font-bold text-white">Calculadora de 1RM</h3>
                            <p class="text-sm text-gray-400">Estima tu repetición máxima para cualquier ejercicio con proyecciones automáticas.</p>
                            <form id="1rm-form" class="mt-6 space-y-5">
                                <div class="grid gap-4 sm:grid-cols-2">
                                    <div class="rounded-2xl border border-white/10 bg-gray-950/60 p-4">
                                        <label for="1rm-weight" class="block text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Peso Levantado (kg)</label>
                                        <input type="number" step="0.5" id="1rm-weight" placeholder="70" class="mt-2 w-full rounded-xl border border-white/10 bg-gray-900/80 py-3 text-center text-sm text-white placeholder:text-gray-500 focus:border-purple-400/50 focus:outline-none focus:ring-2 focus:ring-purple-400/50">
                                    </div>
                                    <div class="rounded-2xl border border-white/10 bg-gray-950/60 p-4">
                                        <label for="1rm-reps" class="block text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Repeticiones</label>
                                        <input type="number" id="1rm-reps" placeholder="8" class="mt-2 w-full rounded-xl border border-white/10 bg-gray-900/80 py-3 text-center text-sm text-white placeholder:text-gray-500 focus:border-purple-400/50 focus:outline-none focus:ring-2 focus:ring-purple-400/50">
                                    </div>
                                </div>
                                <button type="submit" class="flex w-full items-center justify-center gap-2 rounded-full bg-gradient-to-r from-purple-500 via-fuchsia-500 to-pink-500 px-6 py-3 text-sm font-semibold uppercase tracking-[0.35em] text-white shadow-lg shadow-purple-500/30 transition hover:from-purple-400 hover:via-fuchsia-400 hover:to-pink-400">
                                    <i data-lucide="bar-chart-3" class="h-5 w-5"></i>
                                    Calcular 1RM
                                </button>
                            </form>
                        </div>
                        <div id="1rm-results" class="hidden space-y-4">
                            <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-6 text-center shadow-lg shadow-purple-500/10">
                                <p class="text-sm text-gray-400">Tu 1RM estimado es</p>
                                <p id="1rm-result-value" class="mt-2 text-4xl font-bold text-purple-200"></p>
                            </div>
                            <div class="rounded-3xl border border-white/10 bg-gray-900/70 p-6 shadow-lg shadow-purple-500/10">
                                <h4 class="mb-4 text-center text-sm font-semibold uppercase tracking-[0.3em] text-purple-100/80">Pesos proyectados</h4>
                                <div id="1rm-projections" class="grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</template>

    
    <template id="template-dieta">
        <section id="dieta" class="section-content hidden">
            <div class="space-y-6">
                <details data-diet-panel="guided" open class="diet-panel group">
                    <summary class="diet-panel-summary [&::-webkit-details-marker]:hidden">
                        <div class="diet-panel-cover" data-panel-key="guided">
                            <div class="diet-panel-cover-visual" data-panel-cover-preview="guided"></div>
                            <div class="diet-panel-cover-content">
                                <span class="diet-panel-cover-icon">
                                    <i data-lucide="compass" class="h-5 w-5"></i>
                                </span>
                                <div class="diet-panel-cover-text">
                                    <h3>Definición guiada · Objetivo activo</h3>
                                    <span>Configura la estrategia nutricional y su proyección.</span>
                                </div>
                            </div>
                            <label class="diet-panel-cover-upload" data-panel-cover-trigger="guided" aria-label="Subir portada de Definición guiada">
                                <span class="sr-only">Actualizar portada de Definición guiada</span>
                                <i data-lucide="image-up"></i>
                                <input type="file" accept="image/*" class="hidden" data-panel-cover-input="guided" />
                            </label>
                            <span class="diet-panel-cover-toggle" aria-hidden="true">
                                <i data-lucide="chevron-down"></i>
                            </span>
                        </div>
                    </summary>
                    <div class="diet-panel-content">
                        <div class="diet-panel-body">
                            <div class="space-y-8">
                                <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-emerald-500/10 via-emerald-500/5 to-gray-900 p-6 sm:p-8 shadow-xl shadow-emerald-500/20">
                                    <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top_right,rgba(6,182,212,0.22),transparent_55%)]"></div>
                                    <div class="relative flex flex-col gap-7 lg:flex-row lg:items-start">
                                    <div class="flex-1 space-y-7">
                                        <header class="space-y-4">
                                            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                                <span class="inline-flex w-fit items-center rounded-full border border-emerald-400/60 bg-emerald-500/15 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-100 shadow-[0_10px_35px_-20px_rgba(16,185,129,0.65)]">Nutrición inteligente</span>
                                            </div>
                                            <div class="space-y-3">
                                                <h2 class="text-3xl font-bold text-white sm:text-4xl sm:leading-tight">Diseña un ecosistema nutricional a medida</h2>
                                                <p class="text-sm leading-relaxed text-emerald-100/80 sm:text-base">Coordina un plan gastronómico de lujo calibrado por IA que ajusta macros en tiempo real, mantiene la narrativa premium de tu progreso y preserva una experiencia móvil elegante sin fricciones.</p>
                                            </div>
                                        </header>
                                        <div class="space-y-6 rounded-2xl border border-white/10 bg-gray-900/65 p-4 shadow-inner sm:p-5">
                                            <div class="grid gap-4 sm:grid-cols-3">
                                                <div class="flex items-start gap-3">
                                                    <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-emerald-500/30 via-emerald-400/20 to-emerald-500/10 text-emerald-100 shadow-[0_12px_35px_-20px_rgba(16,185,129,0.75)]">
                                                        <i data-lucide="goal" class="h-5 w-5"></i>
                                                    </span>
                                                    <div class="space-y-1">
                                                        <p class="text-[11px] font-semibold uppercase tracking-[0.32em] text-emerald-200/70">Objetivo activo</p>
                                                        <p class="text-base font-semibold text-white sm:text-lg">+3.2 kg de masa magra</p>
                                                        <p class="text-[11px] text-emerald-100/60">Enfoque: recomposición premium</p>
                                                    </div>
                                                </div>
                                                <div class="flex items-start gap-3">
                                                    <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-cyan-500/30 via-emerald-400/25 to-emerald-500/15 text-emerald-100 shadow-[0_12px_35px_-20px_rgba(6,182,212,0.65)]">
                                                        <i data-lucide="calendar-clock" class="h-5 w-5"></i>
                                                    </span>
                                                    <div class="space-y-1">
                                                        <p class="text-[11px] font-semibold uppercase tracking-[0.32em] text-emerald-200/70">Proyección</p>
                                                        <p class="text-sm font-semibold text-emerald-200 sm:text-base">6 semanas para alcanzar la meta</p>
                                                        <p class="text-[11px] text-emerald-100/60">Ruta planificada en 3 microciclos</p>
                                                    </div>
                                                </div>
                                                <div class="flex items-start gap-3">
                                                    <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-emerald-400/25 via-cyan-400/20 to-sky-400/10 text-emerald-100 shadow-[0_12px_35px_-20px_rgba(59,130,246,0.45)]">
                                                        <i data-lucide="navigation-2" class="h-5 w-5"></i>
                                                    </span>
                                                    <div class="space-y-1">
                                                        <p class="text-[11px] font-semibold uppercase tracking-[0.32em] text-emerald-200/70">Fase actual</p>
                                                        <p class="text-base font-semibold text-white sm:text-lg">Semana 4 · Intensidad controlada</p>
                                                        <p class="text-[11px] text-emerald-100/60">Ritmo sostenido de +0.8 kg/sem</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="space-y-4">
                                                <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
                                                    <div class="flex items-center gap-2 text-[11px] font-semibold uppercase tracking-[0.32em] text-emerald-200/70">
                                                        <i data-lucide="activity" class="h-4 w-4"></i>
                                                        Línea de avance del protocolo
                                                    </div>
                                                    <div class="flex items-center gap-2 text-xs text-emerald-100/80">
                                                        <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/30 bg-emerald-500/10 px-2.5 py-1 text-[10px] uppercase tracking-[0.3em]">45% completado</span>
                                                        <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/20 bg-emerald-500/5 px-2.5 py-1 text-[10px] uppercase tracking-[0.3em] text-emerald-100/70">Objetivo: kilos ganados</span>
                                                    </div>
                                                </div>
                                                <div class="relative">
                                                    <div class="h-3 w-full overflow-hidden rounded-full bg-gray-900/70">
                                                        <div class="h-full rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400" style="width: 45%;"></div>
                                                    </div>
                                                    <div class="pointer-events-none absolute inset-0">
                                                        <span class="absolute left-0 top-1/2 -translate-y-1/2 h-4 w-4 rounded-full border border-emerald-400/40 bg-emerald-500/20 shadow-[0_0_18px_rgba(16,185,129,0.45)]"></span>
                                                        <span class="absolute left-[45%] top-1/2 -translate-x-1/2 -translate-y-1/2 h-5 w-5 rounded-full border-2 border-emerald-300/80 bg-emerald-400 shadow-[0_0_25px_rgba(6,182,212,0.55)]"></span>
                                                        <span class="absolute right-0 top-1/2 -translate-y-1/2 h-4 w-4 rounded-full border border-emerald-300/50 bg-emerald-500/20 shadow-[0_0_18px_rgba(59,130,246,0.35)]"></span>
                                                    </div>
                                                </div>
                                                <div class="flex items-start justify-between text-[10px] font-medium text-emerald-100/80 sm:text-xs diet-responsive-stack">
                                                    <div class="flex flex-col gap-1 text-left">
                                                        <span class="inline-flex items-center gap-1 rounded-full border border-emerald-500/20 bg-emerald-500/10 px-2 py-1 text-[10px] uppercase tracking-[0.3em] text-emerald-100/70"><i data-lucide="sparkles" class="h-3 w-3"></i>Inicio</span>
                                                        <span class="text-emerald-200/70">Semana 0 · Peso inicial 78 kg</span>
                                                    </div>
                                                    <div class="flex flex-col items-center gap-1">
                                                        <span class="inline-flex items-center gap-1 rounded-full border border-emerald-500/30 bg-emerald-400/15 px-2 py-1 text-[10px] uppercase tracking-[0.3em] text-emerald-100"><i data-lucide="flame" class="h-3 w-3"></i>Actual</span>
                                                        <span class="text-center text-emerald-200 font-semibold">Semana 4 · +2.1 kg</span>
                                                    </div>
                                                    <div class="flex flex-col gap-1 text-right">
                                                        <span class="inline-flex items-center gap-1 rounded-full border border-emerald-500/20 bg-emerald-500/10 px-2 py-1 text-[10px] uppercase tracking-[0.3em] text-emerald-100/70"><i data-lucide="star" class="h-3 w-3"></i>Meta</span>
                                                        <span class="text-emerald-200/70">Semana 10 · 82.5 kg proyectados</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="grid gap-3 sm:grid-cols-3">
                                                <div class="rounded-2xl border border-emerald-400/20 bg-emerald-500/10 p-3 shadow-[inset_0_1px_0_rgba(255,255,255,0.05)]">
                                                    <div class="flex items-center justify-between text-xs font-semibold text-emerald-200/80">
                                                        <span class="flex items-center gap-1">
                                                            <i data-lucide="activity" class="h-4 w-4"></i>
                                                            Adherencia
                                                        </span>
                                                        <span>92%</span>
                                                    </div>
                                                    <p class="mt-2 text-[11px] text-emerald-100/70">Rutina cumplida 11/12 días.</p>
                                                </div>
                                                <div class="rounded-2xl border border-emerald-400/20 bg-emerald-500/10 p-3 shadow-[inset_0_1px_0_rgba(255,255,255,0.05)]">
                                                    <div class="flex items-center justify-between text-xs font-semibold text-emerald-200/80">
                                                        <span class="flex items-center gap-1">
                                                            <i data-lucide="gauge" class="h-4 w-4"></i>
                                                            Ritmo óptimo
                                                        </span>
                                                        <span>Alta</span>
                                                    </div>
                                                    <p class="mt-2 text-[11px] text-emerald-100/70">Calibrado según última evaluación.</p>
                                                </div>
                                                <div class="rounded-2xl border border-emerald-400/20 bg-emerald-500/10 p-3 shadow-[inset_0_1px_0_rgba(255,255,255,0.05)]">
                                                    <div class="flex items-center justify-between text-xs font-semibold text-emerald-200/80">
                                                        <span class="flex items-center gap-1">
                                                            <i data-lucide="trophy" class="h-4 w-4"></i>
                                                            Logros
                                                        </span>
                                                        <span>3</span>
                                                    </div>
                                                    <p class="mt-2 text-[11px] text-emerald-100/70">Nuevas marcas registradas.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="diet-admin-actions" class="rounded-3xl border border-white/10 bg-gradient-to-br from-fuchsia-500/20 via-indigo-500/15 to-gray-950/80 p-4 shadow-[0_35px_90px_-45px_rgba(168,85,247,0.6)] sm:p-5 lg:w-[280px]">
                                        <div class="space-y-4">
                                            <div class="space-y-1">
                                                <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-fuchsia-100/80">Panel rápido</p>
                                                <p class="text-sm font-medium text-fuchsia-50/90">Activa recursos clave en segundos.</p>
                                            </div>
                                            <div class="grid gap-3">
                                                <button data-action="generate-plan" class="inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-amber-300 via-orange-400 to-rose-400 px-4 py-3 text-xs font-semibold text-gray-900 shadow-[0_20px_50px_-18px_rgba(251,191,36,0.75)] transition hover:from-amber-200 hover:via-orange-300 hover:to-rose-300 focus:outline-none focus:ring-2 focus:ring-amber-200/40 sm:text-sm">
                                                    <i data-lucide="sparkles" class="h-4 w-4"></i>
                                                    Generar plan con IA
                                                </button>
                                                <button data-action="client-diet-create-food-modal" class="inline-flex w-full items-center justify-center gap-2 rounded-2xl border border-fuchsia-200/60 bg-white/10 px-4 py-3 text-xs font-semibold uppercase tracking-[0.28em] text-fuchsia-100 transition hover:bg-fuchsia-500/15 focus:outline-none focus:ring-2 focus:ring-fuchsia-200/40 sm:text-sm">
                                                    <i data-lucide="plus" class="h-4 w-4"></i>
                                                    Nuevo alimento
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="grid gap-5 lg:grid-cols-[minmax(0,1.15fr)_minmax(0,0.85fr)] diet-responsive-grid">
                                <article class="relative overflow-hidden rounded-3xl border border-white/10 bg-gray-900/80 p-6 shadow-[0_35px_90px_-55px_rgba(16,185,129,0.65)]">
                                    <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top_left,rgba(16,185,129,0.18),transparent_65%)]"></div>
                                    <div class="relative space-y-5">
                                        <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                                            <div class="space-y-2">
                                                <span class="inline-flex w-fit items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-200">Objetivo activo</span>
                                                <h3 id="diet-goal-label" class="text-xl font-semibold text-white">Define un objetivo</h3>
                                                <p id="diet-goal-direction" class="text-sm text-emerald-100/70">Conecta tu meta de peso para personalizar el plan.</p>
                                            </div>
                                            <div class="space-y-1 text-right">
                                                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Peso actual</p>
                                                <p class="text-3xl font-bold text-white"><span id="diet-current-weight">--</span><span class="ml-1 text-base font-semibold text-gray-400">kg</span></p>
                                                <p id="diet-last-weigh-in" class="text-[11px] text-gray-500">Registra tu peso para comenzar.</p>
                                            </div>
                                        </header>
                                        <div class="space-y-2 rounded-2xl border border-white/10 bg-gray-900/70 px-4 py-3">
                                            <div class="flex items-center justify-between diet-responsive-stack">
                                                <div>
                                                    <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-500">Objetivo</p>
                                                    <p class="text-lg font-semibold text-emerald-200"><span id="diet-target-weight">--</span> kg</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-500">Diferencia</p>
                                                    <p id="diet-weight-diff" class="text-lg font-semibold text-white">-- kg</p>
                                                </div>
                                            </div>
                                            <p id="diet-goal-diff" class="text-xs text-emerald-100/70">Conecta tus registros para ver el avance.</p>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex items-center justify-between text-[11px] font-semibold uppercase tracking-[0.3em] text-gray-400 diet-responsive-stack">
                                                <span>Progreso hacia la meta</span>
                                                <span id="diet-weight-progress-label">0%</span>
                                            </div>
                                            <div class="h-2.5 w-full overflow-hidden rounded-full bg-gray-800/80">
                                                <div id="diet-weight-progress" class="h-full rounded-full bg-gradient-to-r from-emerald-400 via-sky-400 to-cyan-300" style="width: 0%;"></div>
                                            </div>
                                        </div>
                                        <div class="flex items-start justify-between rounded-2xl border border-white/10 bg-gray-900/70 px-4 py-3 diet-responsive-stack">
                                            <div>
                                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-500">Ritmo actual</p>
                                                <p id="diet-goal-trend" class="text-sm font-semibold text-emerald-200">Sin datos</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-500">Inicio</p>
                                                <p id="diet-goal-start" class="text-sm text-gray-400">-- kg</p>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                                <article class="rounded-3xl border border-white/10 bg-gray-900/80 p-6 shadow-[0_35px_90px_-55px_rgba(59,130,246,0.55)]">
                                    <div class="space-y-4">
                                        <div class="flex items-start justify-between diet-responsive-stack">
                                            <div>
                                                <span class="inline-flex w-fit items-center gap-2 rounded-full border border-cyan-400/40 bg-cyan-500/10 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-cyan-100">Proyección</span>
                                                <h3 class="mt-2 text-xl font-semibold text-white">Ruta estimada</h3>
                                            </div>
                                            <span id="diet-projection-badge" class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.3em] text-gray-300">Sin datos</span>
                                        </div>
                                        <p id="diet-projection-summary" class="text-sm text-gray-300">Añade registros de peso para proyectar tu fecha objetivo.</p>
                                        <div class="space-y-3 rounded-2xl border border-white/10 bg-gray-900/70 px-4 py-3">
                                            <div class="flex items-center justify-between text-xs text-gray-400">
                                                <span>Fecha estimada</span>
                                                <span id="diet-projection-date" class="text-sm font-semibold text-white">--</span>
                                            </div>
                                            <div class="flex items-center justify-between text-xs text-gray-400">
                                                <span>Semanas restantes</span>
                                                <span id="diet-projection-weeks" class="text-sm font-semibold text-white">--</span>
                                            </div>
                                            <div class="flex items-center justify-between text-xs text-gray-400">
                                                <span>Faltante para la meta</span>
                                                <span id="diet-projection-helper" class="text-sm font-semibold text-white">--</span>
                                            </div>
                                        </div>
                                        <p id="diet-projection-pace" class="text-xs text-gray-500">Actualiza tus pesajes para refinar el pronóstico.</p>
                                    </div>
                                </article>
                            </div>
                        </div>
                    </div>
                </details>
                <details data-diet-panel="daily" class="diet-panel group">
                    <summary class="diet-panel-summary [&::-webkit-details-marker]:hidden">
                        <div class="diet-panel-cover" data-panel-key="daily">
                            <div class="diet-panel-cover-visual" data-panel-cover-preview="daily"></div>
                            <div class="diet-panel-cover-content">
                                <span class="diet-panel-cover-icon">
                                    <i data-lucide="flame" class="h-5 w-5"></i>
                                </span>
                                <div class="diet-panel-cover-text">
                                    <h3>Plan de dieta hoy</h3>
                                    <span>Controla calorías, progreso y recordatorios.</span>
                                </div>
                            </div>
                            <label class="diet-panel-cover-upload" data-panel-cover-trigger="daily" aria-label="Subir portada de Plan de dieta hoy">
                                <span class="sr-only">Actualizar portada de Plan de dieta hoy</span>
                                <i data-lucide="image-up"></i>
                                <input type="file" accept="image/*" class="hidden" data-panel-cover-input="daily" />
                            </label>
                            <span class="diet-panel-cover-toggle" aria-hidden="true">
                                <i data-lucide="chevron-down"></i>
                            </span>
                        </div>
                    </summary>
                    <div class="diet-panel-content">
                        <div class="diet-panel-body">
                            <div class="grid gap-6 xl:grid-cols-[minmax(0,1.6fr)_minmax(0,1fr)] items-start diet-responsive-grid">
                                <article class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-gray-900/95 via-gray-900/60 to-gray-900/90 p-6 shadow-[0_45px_120px_-60px_rgba(16,185,129,0.85)]">
                                    <div class="pointer-events-none absolute -top-24 right-0 h-56 w-56 rounded-full bg-emerald-500/10 blur-3xl"></div>
                                    <div class="relative space-y-8">
                                        <header class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
                                            <div class="space-y-3">
                                                <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/10 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-200">
                                                    <i data-lucide="activity" class="h-4 w-4"></i>
                                                    Plan de dieta hoy
                                                </span>
                                                <div class="space-y-2">
                                                    <h2 class="text-3xl font-semibold text-white">Control diario de energía</h2>
                                                    <p class="text-sm text-emerald-100/80">Objetivo actual: <span id="diet-goal-calories" class="font-semibold text-emerald-300">2500</span> kcal sincronizadas con tu plan.</p>
                                                </div>
                                            </div>
                                            <div class="rounded-2xl border border-white/10 bg-white/5 px-6 py-4 text-right shadow-inner">
                                                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Consumido hoy</p>
                                                <p class="text-4xl font-bold text-white">
                                                    <span id="diet-total-calories">0</span>
                                                    <span class="text-base font-semibold text-gray-400">kcal</span>
                                                </p>
                                                <p id="diet-today-status" class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200/80">Sin datos</p>
                                            </div>
                                        </header>
                                        <div class="space-y-6">
                                            <div>
                                                <div class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-[0.25em] text-emerald-100/70 sm:flex-row sm:items-center sm:justify-between">
                                                    <span>Progreso calórico</span>
                                                    <span id="diet-today-progress-label">0% del objetivo</span>
                                                </div>
                                                <div class="mt-3 h-3 w-full overflow-hidden rounded-full bg-gray-800/80">
                                                    <div id="diet-progress-bar" class="h-full rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400" style="width: 0%;"></div>
                                                </div>
                                                <p id="diet-today-delta" class="mt-2 text-sm text-emerald-100/70">Planifica tu primera comida para comenzar.</p>
                                            </div>
                                            <div class="grid gap-4 lg:grid-cols-[minmax(0,1.3fr)_minmax(0,1fr)] diet-responsive-grid">
                                                <div class="space-y-3 rounded-2xl border border-white/10 bg-gray-900/70 p-4">
                                                    <div class="flex flex-col gap-2 text-xs text-gray-400 sm:flex-row sm:items-center sm:justify-between diet-responsive-stack">
                                                        <span id="diet-plan-coverage">Añade comidas para proyectar tu día.</span>
                                                        <span id="diet-plan-diff" class="font-semibold text-emerald-200/80"></span>
                                                    </div>
                                                    <div id="diet-today-macro-badges" class="grid gap-3 sm:grid-cols-3"></div>
                                                </div>
                                                <div class="space-y-3 rounded-2xl border border-white/10 bg-gray-900/70 p-4">
                                                    <div>
                                                        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Check-ins</p>
                                                        <p id="diet-today-meal-progress" class="text-lg font-semibold text-white">0 de 0 comidas registradas</p>
                                                        <p id="diet-today-checkins" class="text-xs text-gray-500">0% completado</p>
                                                    </div>
                                                    <div class="rounded-xl border border-white/10 bg-gray-800/70 px-4 py-3">
                                                        <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Próximo hito</p>
                                                        <p id="diet-today-next-meal" class="text-sm text-emerald-200/80">Añade comidas para activar recordatorios.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                                <aside id="diet-management-tools" class="space-y-5 rounded-3xl border border-white/10 bg-gray-900/70 p-6 shadow-[0_35px_90px_-55px_rgba(59,130,246,0.55)]">
                                    <div class="rounded-2xl border border-white/10 bg-gray-900/60 p-4">
                                        <h3 class="text-sm font-semibold text-white">Control rápido</h3>
                                        <p class="mt-1 text-xs text-gray-400">Organiza objetivos, registra nuevas comidas y mantén al día a tus asesorados.</p>
                                        <ul class="mt-3 space-y-2 text-xs text-gray-400">
                                            <li class="flex items-start gap-2"><i data-lucide="check-circle-2" class="mt-0.5 h-3.5 w-3.5 text-emerald-300"></i><span>Ajusta metas nutricionales en segundos.</span></li>
                                            <li class="flex items-start gap-2"><i data-lucide="clock-4" class="mt-0.5 h-3.5 w-3.5 text-sky-300"></i><span>Anticipa el día con recordatorios inteligentes.</span></li>
                                            <li class="flex items-start gap-2"><i data-lucide="stars" class="mt-0.5 h-3.5 w-3.5 text-purple-300"></i><span>Optimiza por macros o tipo de comida.</span></li>
                                        </ul>
                                    </div>
                                    <div class="rounded-2xl border border-white/10 bg-gradient-to-br from-sky-500/15 via-cyan-500/10 to-gray-900/60 p-4 shadow-inner">
                                        <div class="flex items-start justify-between gap-3">
                                            <div>
                                                <h4 class="flex items-center gap-2 text-sm font-semibold text-white">
                                                    <i data-lucide="brain-circuit" class="h-4 w-4 text-sky-300"></i>
                                                    Analizador de comidas IA
                                                </h4>
                                                <p class="text-xs text-gray-300">Describe tu plato y obtén una estimación aproximada de calorías y macros.</p>
                                            </div>
                                        </div>
                                        <textarea id="food-analysis-input" placeholder="Ej: bowl de avena con plátano y nueces" class="mt-4 h-28 w-full rounded-xl border border-white/10 bg-gray-900/80 p-3 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-sky-500/40"></textarea>
                                        <button data-action="analyze-food" class="mt-3 inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-sky-500 via-cyan-500 to-teal-500 px-4 py-2.5 text-sm font-semibold text-gray-900 transition hover:from-sky-400 hover:via-cyan-400 hover:to-teal-400">
                                            <i data-lucide="sparkles" class="h-4 w-4"></i>
                                            Analizar y añadir
                                        </button>
                                    </div>
                                </aside>
                            </div>
                        </div>
                    </div>
                </details>
                <details data-diet-panel="agenda" class="diet-panel group">
                    <summary class="diet-panel-summary [&::-webkit-details-marker]:hidden">
                        <div class="diet-panel-cover" data-panel-key="agenda">
                            <div class="diet-panel-cover-visual" data-panel-cover-preview="agenda"></div>
                            <div class="diet-panel-cover-content">
                                <span class="diet-panel-cover-icon">
                                    <i data-lucide="calendar" class="h-5 w-5"></i>
                                </span>
                                <div class="diet-panel-cover-text">
                                    <h3>Agenda nutricional</h3>
                                    <span>Gestiona las comidas planificadas del día.</span>
                                </div>
                            </div>
                            <label class="diet-panel-cover-upload" data-panel-cover-trigger="agenda" aria-label="Subir portada de Agenda nutricional">
                                <span class="sr-only">Actualizar portada de Agenda nutricional</span>
                                <i data-lucide="image-up"></i>
                                <input type="file" accept="image/*" class="hidden" data-panel-cover-input="agenda" />
                            </label>
                            <span class="diet-panel-cover-toggle" aria-hidden="true">
                                <i data-lucide="chevron-down"></i>
                            </span>
                        </div>
                    </summary>
                    <div class="diet-panel-content">
                        <div class="diet-panel-body">
                            <article class="space-y-6 rounded-3xl border border-white/10 bg-gray-900/70 p-6">
                                <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                    <div class="space-y-1">
                                        <div class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-300">
                                            <i data-lucide="calendar-check" class="h-4 w-4"></i>
                                            Agenda nutricional
                                        </div>
                                        <h3 class="text-2xl font-semibold text-white">Tus comidas planificadas</h3>
                                        <p class="text-sm text-gray-400">Marca lo que vayas consumiendo y mantén tus macros alineados.</p>
                                    </div>
                                </header>
                                <div id="meal-sections" class="space-y-5"></div>
                            </article>
                        </div>
                    </div>
                </details>
                <details data-diet-panel="library" class="diet-panel group">
                    <summary class="diet-panel-summary [&::-webkit-details-marker]:hidden">
                        <div class="diet-panel-cover" data-panel-key="library">
                            <div class="diet-panel-cover-visual" data-panel-cover-preview="library"></div>
                            <div class="diet-panel-cover-content">
                                <span class="diet-panel-cover-icon">
                                    <i data-lucide="library" class="h-5 w-5"></i>
                                </span>
                                <div class="diet-panel-cover-text">
                                    <h3>Añade alimentos al plan</h3>
                                    <span>Administra la biblioteca y registra nuevas opciones.</span>
                                </div>
                            </div>
                            <label class="diet-panel-cover-upload" data-panel-cover-trigger="library" aria-label="Subir portada de Añade alimentos al plan">
                                <span class="sr-only">Actualizar portada de Añade alimentos al plan</span>
                                <i data-lucide="image-up"></i>
                                <input type="file" accept="image/*" class="hidden" data-panel-cover-input="library" />
                            </label>
                            <span class="diet-panel-cover-toggle" aria-hidden="true">
                                <i data-lucide="chevron-down"></i>
                            </span>
                        </div>
                    </summary>
                    <div class="diet-panel-content">
                        <div class="diet-panel-body">
                            <aside id="add-food-section" class="space-y-6 rounded-3xl border border-white/10 bg-gray-900/70 p-6 shadow-[0_35px_90px_-55px_rgba(45,212,191,0.55)]">
                                <div class="space-y-2">
                                    <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Biblioteca de alimentos</p>
                                    <h3 class="text-xl font-semibold text-white">Añade alimentos al plan</h3>
                                    <p class="text-xs text-gray-500">Organiza tus bases, personaliza tus macros y sube imágenes para cada opción.</p>
                                </div>

                                <section id="diet-create-food-card" class="hidden space-y-5 rounded-3xl border border-white/10 bg-gray-900/60 p-5">
                                    <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                                        <div class="space-y-1">
                                            <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-200">Creador de alimentos</p>
                                            <h4 class="text-lg font-semibold text-white">Registra un nuevo alimento</h4>
                                            <p class="text-xs text-gray-400">Guarda valores por cada 100&nbsp;g para mantener tus cálculos precisos.</p>
                                        </div>
                                        <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-100">
                                            <i data-lucide="shield-check" class="h-3.5 w-3.5"></i>
                                            Solo entrenador
                                        </span>
                                    </header>
                                    <form id="diet-create-food-form" class="space-y-5">
                                        <div class="grid gap-5 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)] diet-responsive-grid">
                                            <div class="space-y-4">
                                                <label class="block space-y-2 text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">
                                                    <span>Nombre</span>
                                                    <input type="text" name="name" required class="w-full rounded-xl border border-white/10 bg-gray-900/70 px-3 py-2 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40" placeholder="Ej: Porridge Proteico">
                                                </label>
                                                <div class="grid gap-3 sm:grid-cols-2">
                                                    <label class="flex flex-col gap-2 rounded-2xl border border-white/10 bg-gray-900/70 p-3 text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">
                                                        <span class="flex items-center justify-between text-[10px]">
                                                            <span>Calorías (kcal)</span>
                                                            <i data-lucide="flame" class="h-3.5 w-3.5 text-amber-300"></i>
                                                        </span>
                                                        <input type="number" name="cals" required class="w-full rounded-lg border border-white/5 bg-gray-900/70 px-2 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                                    </label>
                                                    <label class="flex flex-col gap-2 rounded-2xl border border-white/10 bg-gray-900/70 p-3 text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">
                                                        <span class="flex items-center justify-between text-[10px]">
                                                            <span>Proteína (g)</span>
                                                            <i data-lucide="dumbbell" class="h-3.5 w-3.5 text-blue-300"></i>
                                                        </span>
                                                        <input type="number" name="p" required class="w-full rounded-lg border border-white/5 bg-gray-900/70 px-2 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                                    </label>
                                                    <label class="flex flex-col gap-2 rounded-2xl border border-white/10 bg-gray-900/70 p-3 text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">
                                                        <span class="flex items-center justify-between text-[10px]">
                                                            <span>Carbohidratos (g)</span>
                                                            <i data-lucide="wheat" class="h-3.5 w-3.5 text-yellow-200"></i>
                                                        </span>
                                                        <input type="number" name="c" required class="w-full rounded-lg border border-white/5 bg-gray-900/70 px-2 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                                    </label>
                                                    <label class="flex flex-col gap-2 rounded-2xl border border-white/10 bg-gray-900/70 p-3 text-xs font-semibold uppercase tracking-[0.35em] text-gray-300 sm:col-span-2">
                                                        <span class="flex items-center justify-between text-[10px]">
                                                            <span>Grasas (g)</span>
                                                            <i data-lucide="droplets" class="h-3.5 w-3.5 text-rose-200"></i>
                                                        </span>
                                                        <input type="number" name="f" required class="w-full rounded-lg border border-white/5 bg-gray-900/70 px-2 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="space-y-3 rounded-2xl border border-white/10 bg-gray-900/70 p-4">
                                                <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-300">Imagen del alimento</p>
                                                <div id="diet-create-food-preview" class="rounded-xl border border-dashed border-white/10 bg-gray-900/50 p-4"></div>
                                                <div class="flex flex-wrap items-center gap-2">
                                                    <label class="inline-flex cursor-pointer items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-emerald-400 hover:text-white">
                                                        <i data-lucide="upload" class="h-3.5 w-3.5"></i>
                                                        Subir imagen
                                                        <input type="file" id="diet-create-food-image" accept="image/*" class="hidden">
                                                    </label>
                                                    <button type="button" id="diet-create-remove-btn" data-action="client-diet-remove-food-image" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-500/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-rose-200 opacity-60 transition hover:border-rose-300 hover:bg-rose-500/20 disabled:cursor-not-allowed" disabled>
                                                        <i data-lucide="trash-2" class="h-3.5 w-3.5"></i>
                                                        Quitar imagen
                                                    </button>
                                                    <input type="hidden" id="diet-create-remove-image" value="false">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                            <p class="text-[11px] text-gray-400">Los valores se guardan por cada 100&nbsp;g.</p>
                                            <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 px-5 py-2 text-sm font-semibold uppercase tracking-[0.3em] text-gray-900 shadow-lg shadow-emerald-400/30 transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                                <i data-lucide="save" class="h-4 w-4"></i>
                                                Guardar alimento
                                            </button>
                                        </div>
                                    </form>
                                </section>

                                <section class="space-y-4 rounded-2xl border border-white/10 bg-gray-900/60 p-4">
                                    <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                        <div>
                                            <h4 class="text-base font-semibold text-white">Explora la biblioteca</h4>
                                            <p class="text-xs text-gray-400">Edita, agrega imágenes o elimina los alimentos que ya no necesites.</p>
                                        </div>
                                        <button data-action="client-diet-create-food-modal" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-4 py-2 text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-400/20">
                                            <i data-lucide="sparkles" class="h-3.5 w-3.5"></i>
                                            Abrir en modal
                                        </button>
                                    </header>
                                    <div class="relative">
                                        <i data-lucide="search" class="pointer-events-none absolute left-4 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-500"></i>
                                        <input type="text" id="food-search" placeholder="Busca por nombre o macro" class="w-full rounded-2xl border border-white/10 bg-gray-900/60 py-3 pl-11 pr-4 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                    </div>
                                    <div id="food-list" class="space-y-4"></div>
                                </section>
                            </aside>
                        </div>
                    </div>
                </details>
            </div>
        </section>
    </template>

    <template id="template-historial"><section id="historial" class="section-content hidden"><div class="space-y-6"><div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between"><div><h2 class="text-2xl font-bold flex items-center gap-3"><span class="inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-emerald-500/15 text-emerald-300 shadow-inner shadow-emerald-500/20"><i data-lucide="history" class="h-6 w-6"></i></span><span>Historial de Progreso</span></h2><p class="text-sm text-gray-400">Visualiza la evolución de tus entrenamientos, tiempos y cargas.</p></div><button data-action="show-workout-history" class="inline-flex items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-emerald-400/60 hover:bg-emerald-400/10"><i data-lucide="gallery-vertical-end" class="h-4 w-4"></i>Ver resumen detallado</button></div><div id="history-overview" class="grid gap-3 md:grid-cols-2 xl:grid-cols-4"></div><div id="history-cards" class="space-y-4"></div></div></section></template>
    <template id="template-comunidad">
        <section id="comunidad" class="section-content hidden">
            <div id="community-root" class="space-y-8">
                <div class="rounded-3xl border border-white/10 bg-gray-900/60 p-6 shadow-lg">
                    <div class="flex flex-col items-start gap-4 sm:flex-row sm:items-center sm:justify-between">
                        <div class="space-y-1">
                            <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200">Ranking en vivo</span>
                            <h2 class="text-2xl font-bold text-white">Comunidad FitTrack</h2>
                            <p class="text-sm text-gray-400">Consulta el top de atletas, retos colectivos y avances destacados.</p>
                        </div>
                        <button data-action="community-refresh" class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-gray-100 transition hover:border-emerald-400/60 hover:text-emerald-200">
                            <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                            Actualizar datos
                        </button>
                    </div>
                    <p class="mt-6 text-sm text-gray-400">Cargando métricas de la comunidad...</p>
                </div>
            </div>
        </section>
    </template>
    
    <template id="template-perfil">
        <section id="perfil" class="section-content hidden">
            <div class="space-y-10 pb-12">
                <div class="relative overflow-hidden rounded-[2.5rem] border border-white/10 bg-gradient-to-br from-gray-900/90 via-gray-900/70 to-gray-900/50 p-8 sm:p-10 shadow-[0_45px_120px_-60px_rgba(16,185,129,0.85)]">
                    <div class="pointer-events-none absolute inset-0">
                        <div class="absolute -top-28 -left-20 h-64 w-64 rounded-full bg-emerald-500/20 blur-3xl"></div>
                        <div class="absolute -bottom-32 right-0 h-72 w-72 rounded-full bg-teal-500/15 blur-3xl"></div>
                    </div>
                    <div class="relative flex flex-col gap-8 lg:flex-row lg:items-center lg:justify-between">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-6">
                            <div class="flex flex-col items-center gap-3 sm:items-start">
                                <div class="relative">
                                    <div id="profile-avatar" class="relative flex h-20 w-20 items-center justify-center rounded-3xl bg-emerald-400 text-4xl font-black text-gray-900 shadow-[0_20px_45px_-25px_rgba(16,185,129,0.9)]">
                                        <img id="profile-avatar-img" alt="Foto de perfil" class="h-full w-full rounded-3xl object-cover" />
                                        <span class="relative z-10"></span>
                                    </div>
                                    <div class="absolute -bottom-2 -right-2 rounded-full bg-gray-900/80 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200">
                                        Activo
                                    </div>
                                </div>
                                <div class="flex w-full flex-col items-center gap-1 sm:items-start">
                                    <button data-action="trigger-profile-photo-upload" class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-3 py-1.5 text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-emerald-400/60 hover:text-emerald-200">
                                        <i data-lucide="upload-cloud" class="h-4 w-4"></i>
                                        Cambiar foto
                                    </button>
                                    <p class="text-[11px] text-gray-400">PNG o JPG hasta 2MB</p>
                                    <input id="profile-photo-input" type="file" accept="image/*" class="hidden">
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200">
                                    <i data-lucide="sparkles" class="h-4 w-4"></i>
                                    Perfil sincronizado
                                </div>
                                <div>
                                    <h2 id="profile-name" class="text-3xl font-bold text-white"></h2>
                                    <p id="profile-email" class="text-sm text-gray-400"></p>
                                </div>
                                <p id="profile-last-update" class="text-xs text-gray-400"></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full sm:w-auto">
                            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-center">
                                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Entrenos</p>
                                <p id="profile-stat-workouts" class="mt-1 text-3xl font-bold text-white">0</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-center">
                                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Horas</p>
                                <p id="profile-stat-hours" class="mt-1 text-3xl font-bold text-white">0</p>
                            </div>
                            <div class="rounded-2xl border border-emerald-400/30 bg-emerald-500/10 px-4 py-3 text-center">
                                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200">Racha</p>
                                <p id="profile-stat-streak" class="mt-1 text-3xl font-bold text-white">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid gap-6 lg:grid-cols-[minmax(0,1.35fr)_minmax(0,1fr)] items-start">
                    <div class="space-y-6">
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-[0_30px_80px_-50px_rgba(148,163,184,0.45)]">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Datos principales</p>
                                    <h3 class="mt-1 text-xl font-semibold text-white">Información personal</h3>
                                </div>
                                <button data-action="edit-profile" class="inline-flex items-center gap-1.5 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200 transition hover:border-emerald-300 hover:text-emerald-100">
                                    <i data-lucide="edit-3" class="h-4 w-4"></i>
                                    Editar
                                </button>
                            </div>
                            <div class="mt-6 grid gap-4 sm:grid-cols-2">
                                <div class="rounded-2xl border border-white/5 bg-gray-900/60 p-4">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-500">Edad</p>
                                    <p id="profile-info-age" class="mt-2 text-2xl font-semibold text-white"></p>
                                </div>
                                <div class="rounded-2xl border border-white/5 bg-gray-900/60 p-4">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-500">Altura</p>
                                    <p id="profile-info-height" class="mt-2 text-2xl font-semibold text-white"></p>
                                </div>
                                <div class="rounded-2xl border border-white/5 bg-gray-900/60 p-4">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-500">Peso actual</p>
                                    <p id="profile-info-weight" class="mt-2 text-2xl font-semibold text-white"></p>
                                </div>
                                <div class="rounded-2xl border border-white/5 bg-gray-900/60 p-4">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-500">Actividad</p>
                                    <p id="profile-info-activity" class="mt-2 text-base font-semibold text-emerald-200"></p>
                                </div>
                                <div class="rounded-2xl border border-white/5 bg-gray-900/60 p-4 sm:col-span-2">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-500">Género</p>
                                    <p id="profile-info-gender" class="mt-2 text-base font-semibold text-gray-200"></p>
                                </div>
                            </div>
                        </div>

                        <div class="relative overflow-hidden rounded-3xl border border-emerald-400/30 bg-gradient-to-br from-emerald-500/15 via-teal-500/10 to-sky-500/10 p-6 shadow-[0_40px_95px_-55px_rgba(16,185,129,0.95)]">
                            <div class="pointer-events-none absolute inset-0">
                                <div class="absolute -top-16 right-10 h-40 w-40 rounded-full bg-white/10 blur-3xl"></div>
                            </div>
                            <div class="relative space-y-6">
                                <div class="flex flex-wrap items-center justify-between gap-3">
                                    <div>
                                        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-100/80">Seguimiento de peso</p>
                                        <h3 class="text-2xl font-semibold text-white">Trayectoria hacia tu objetivo</h3>
                                    </div>
                                    <button data-action="edit-target-weight" class="inline-flex items-center gap-1.5 rounded-full border border-emerald-200/50 bg-emerald-200/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-emerald-100 transition hover:border-emerald-100 hover:text-white">
                                        <i data-lucide="target" class="h-4 w-4"></i>
                                        Ajustar objetivo
                                    </button>
                                </div>
                                <div class="grid gap-4 sm:grid-cols-3">
                                    <div class="rounded-2xl border border-white/20 bg-white/10 p-4 text-center">
                                        <p class="text-[11px] font-semibold uppercase tracking-[0.4em] text-emerald-100/80">Actual</p>
                                        <p class="mt-2 text-3xl font-bold text-white"><span id="current-weight-display"></span><span class="ml-1 text-sm font-semibold text-emerald-100/80">kg</span></p>
                                    </div>
                                    <div class="rounded-2xl border border-emerald-200/70 bg-emerald-200/10 p-4 text-center">
                                        <p class="text-[11px] font-semibold uppercase tracking-[0.4em] text-emerald-100/80">Objetivo</p>
                                        <p class="mt-2 text-3xl font-bold text-white"><span id="target-weight-display"></span><span class="ml-1 text-sm font-semibold text-emerald-100/80">kg</span></p>
                                    </div>
                                    <div class="rounded-2xl border border-white/20 bg-white/10 p-4 text-center">
                                        <p class="text-[11px] font-semibold uppercase tracking-[0.4em] text-emerald-100/80">Diferencia</p>
                                        <p class="mt-2 text-3xl font-bold text-white"><span id="weight-diff-display"></span><span class="ml-1 text-sm font-semibold text-emerald-100/80">kg</span></p>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-[0.3em] text-emerald-100/70">
                                        <span>Progreso hacia la meta</span>
                                        <span id="weight-progress-label">0%</span>
                                    </div>
                                    <div class="mt-2 h-2.5 w-full overflow-hidden rounded-full bg-white/10">
                                        <div id="weight-progress-bar" class="h-full rounded-full bg-gradient-to-r from-emerald-300 via-teal-300 to-cyan-300" style="width: 0%;"></div>
                                    </div>
                                </div>
                                <div class="rounded-2xl border border-white/20 bg-white/5 p-4">
                                    <p id="weight-trend-label" class="text-sm text-emerald-100/90"></p>
                                </div>
                                <div class="space-y-3">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-100/70">Registro reciente</p>
                                    <div id="weight-log-list" class="space-y-2"></div>
                                </div>
                                <form id="weight-log-form" class="relative flex flex-col gap-3 rounded-2xl border border-white/10 bg-gray-900/70 p-4 backdrop-blur">
                                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                        <label for="new-weight-input" class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Añadir nuevo peso</label>
                                        <span id="weight-last-entry" class="text-xs text-gray-500 sm:ml-auto"></span>
                                    </div>
                                    <div class="flex flex-col gap-3 sm:flex-row">
                                        <input type="number" step="0.1" id="new-weight-input" placeholder="Peso de hoy (kg)" class="w-full rounded-2xl border border-white/10 bg-gray-900/60 px-4 py-3 text-center text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40" required>
                                        <button type="submit" data-action="add-weight-log" class="w-full sm:w-auto rounded-2xl bg-gradient-to-r from-emerald-400 via-emerald-500 to-teal-400 px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-gray-900 shadow-[0_18px_45px_-20px_rgba(16,185,129,0.95)] transition hover:from-emerald-300 hover:via-emerald-400 hover:to-teal-300">Registrar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Actividad semanal</p>
                                    <h3 class="mt-1 text-xl font-semibold text-white">Últimas 4 semanas</h3>
                                </div>
                                <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-gray-300">
                                    <i data-lucide="bar-chart-3" class="h-4 w-4"></i>
                                    Ritmo
                                </span>
                            </div>
                            <div id="profile-activity-chart" class="mt-6 h-36 flex items-end justify-around gap-2 text-center"></div>
                        </div>

                        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Instantánea corporal</p>
                                    <h3 class="mt-1 text-xl font-semibold text-white">Resumen en base a tus datos</h3>
                                </div>
                                <button data-action="calculate-body-metrics" class="inline-flex items-center gap-1.5 rounded-full border border-sky-400/40 bg-sky-500/10 px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.28em] text-sky-200 transition hover:border-sky-300 hover:text-sky-100">
                                    <i data-lucide="scan-line" class="h-4 w-4"></i>
                                    Actualizar
                                </button>
                            </div>
                            <div class="mt-6 space-y-4">
                                <div class="rounded-2xl border border-white/10 bg-gray-900/60 p-4">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">IMC estimado</p>
                                    <div class="mt-2 flex items-center gap-3">
                                        <p id="profile-bmi-value" class="text-3xl font-bold text-white">--</p>
                                        <p id="profile-bmi-label" class="text-sm font-semibold text-emerald-200"></p>
                                    </div>
                                </div>
                                <div class="grid gap-4 sm:grid-cols-2">
                                    <div class="rounded-2xl border border-white/10 bg-gray-900/60 p-4">
                                        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Hidratación diaria</p>
                                        <p id="profile-hydration" class="mt-2 text-xl font-semibold text-white">--</p>
                                    </div>
                                    <div class="rounded-2xl border border-white/10 bg-gray-900/60 p-4">
                                        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Peso saludable</p>
                                        <p id="profile-ideal-weight" class="mt-2 text-xl font-semibold text-white">--</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </template>
    
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            query,
            where,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyASVFAJx1vUN62V3t7VycuTKAehWW8byoM",
            authDomain: "seb-fit-460c4.firebaseapp.com",
            projectId: "seb-fit-460c4",
            storageBucket: "seb-fit-460c4.firebasestorage.app",
            messagingSenderId: "906669175939",
            appId: "1:906669175939:web:8fd09b745292c14eb6d7b6"
        };

        // Inicializar Firebase
        const firebaseApp = initializeApp(firebaseConfig);

        const initHeaderFadeEffect = () => {
            const header = document.getElementById('main-header');
            if (!header) {
                return;
            }

            const mainScrollContainer = document.getElementById('app-main');
            const fadeDistance = 240;
            const minOpacity = 0.25;

            const updateOpacity = () => {
                const windowScroll = window.scrollY || window.pageYOffset || 0;
                const containerScroll = mainScrollContainer ? mainScrollContainer.scrollTop : 0;
                const scrollAmount = Math.max(windowScroll, containerScroll);
                const nextOpacity = Math.max(minOpacity, 1 - scrollAmount / fadeDistance);
                header.style.opacity = nextOpacity.toFixed(2);
            };

            window.addEventListener('scroll', updateOpacity, { passive: true });
            if (mainScrollContainer) {
                mainScrollContainer.addEventListener('scroll', updateOpacity, { passive: true });
            }

            updateOpacity();
        };

        const bootstrapApp = () => {
            if (window.app) {
                return;
            }

            const app = {
                // IMPORTANTE: Reemplaza "" con tu propia clave de API de Google AI Studio.
                apiKey: "", // Tu clave de API de Google AI Studio aquí
                adminUID: "oyVFC1vKcLhTLJJsjMQDPRL1z2K2",
                firebaseApp: firebaseApp,
                auth: null,
                db: null,
                storage: null, 
                
                isAdmin() {
                    return this.state && this.state.role === 'admin';
                },

                isCoach() {
                    return this.state && this.state.role === 'entrenador';
                },

                isClient() {
                    return this.state && this.state.role === 'asesorado';
                },

                isAsesor() {
                    return this.isAdmin() || this.isCoach();
                },

                canEditGlobalMedia() {
                    return this.isAdmin();
                },

                getDefaultState() {
                    const now = new Date();
                    return {
                        currentUser: null,
                        userName: '',
                        role: 'asesorado',
                        managedRoles: {
                            trainers: [],
                            invitations: []
                        },
                        coachId: null,
                        currentSection: 'inicio', 
                        userGoals: { calories: 2500, protein: 188, carbs: 250, fats: 83 },
                        dailyDiet: [
                            { id: `meal-${now.getTime()}`, name: 'Desayuno', time: '08:00', items: [] },
                            { id: `meal-${now.getTime() + 1}`, name: 'Almuerzo', time: '13:00', items: [] },
                            { id: `meal-${now.getTime() + 2}`, name: 'Cena', time: '20:00', items: [] }
                        ], 
                        userRoutines: [], 
                        workoutHistory: {}, 
                        dietLog: {},
                        physicalStats: { age: 25, weight: 75, height: 180, gender: 'male', activity: 1.55 },
                        targetWeight: 75,
                        weightLog: [],
                        asesorados: [],
                        activeWorkout: null,
                        timer: { status: 'idle', timeLeft: 0, intervalId: null, initialRestTime: 0 },
                        dashboardCover: { image: '', storagePath: '', updatedAt: null },
                        routineBanner: { image: '', storagePath: '', updatedAt: null },
                        profilePhoto: { url: '', storagePath: '', updatedAt: null },
                        dietPanelCovers: {
                            guided: { url: '', storagePath: '', updatedAt: null },
                            daily: { url: '', storagePath: '', updatedAt: null },
                            agenda: { url: '', storagePath: '', updatedAt: null },
                            library: { url: '', storagePath: '', updatedAt: null }
                        },
                        isMobileMenuOpen: false,
                        community: {
                            stats: { totalAthletes: 0, totalVolume: 0, totalSessions: 0 },
                            leaderboards: { volume: [], sessions: [], progress: [] },
                            highlights: [],
                            feed: [],
                            challenges: [],
                            podium: [],
                            spotlight: null,
                            activeLeaderboard: 'volume',
                            lastUpdated: null,
                            isEmpty: true
                        },
                        isCommunityLoading: false
                    };
                },

                state: null,
                _tempClientData: null, // Estado temporal para el editor de dieta del cliente
                _isUploadingDashboardCover: false,
                _dashboardCoverProgressTimeout: null,
                _isUploadingRoutineBanner: false,
                _routineBannerProgressTimeout: null,
                
                data: { 
                    predefinedRoutines: {
                        "Clásicos de Hipertrofia": [
                            { id: 'pre-ppl', name: 'Empuje/Tire/Pierna (PPL)', description: 'División clásica y efectiva para ganar músculo y fuerza.', icon: 'git-merge', plan: [ { day: 'Día 1: Empuje (Pecho, Hombro, Tríceps)', exercises: [{name:'Press de Banca Plano con Barra',sets:4,reps:'8-12', rest:'60s'},{name:'Press Inclinado con Mancuernas',sets:3,reps:'10-12', rest:'60s'},{name:'Elevaciones Laterales con Mancuernas',sets:4,reps:'12-15', rest:'45s'},{name:'Extensiones de Tríceps en Polea',sets:3,reps:'12-15', rest:'45s'}] }, { day: 'Día 2: Tire (Espalda, Bíceps)', exercises: [{name:'Dominadas (Agarre Ancho)',sets:4,reps:'Al fallo', rest:'90s'},{name:'Remo con Barra',sets:4,reps:'8-10', rest:'75s'},{name:'Face Pulls',sets:3,reps:'15-20', rest:'45s'},{name:'Curl con Barra Z',sets:4,reps:'10-12', rest:'60s'}] }, { day: 'Día 3: Pierna', exercises: [{name:'Sentadilla con Barra',sets:4,reps:'8-10', rest:'90s'},{name:'Peso Muerto Rumano con Mancuernas',sets:3,reps:'10-12', rest:'75s'},{name:'Curl Femoral Tumbado',sets:3,reps:'12-15', rest:'60s'},{name:'Elevación de Talones de Pie',sets:4,reps:'15-20', rest:'45s'}] } ] },
                            { id: 'pre-arnold', name: 'Arnold Split', description: 'Alta frecuencia y volumen para desarrollo muscular máximo.', icon: 'user-check', plan: [ { day: 'Día 1: Pecho y Espalda', exercises: [{name:'Press de Banca Plano con Barra',sets:4,reps:'8-12',rest:'75s'},{name:'Dominadas (Agarre Ancho)',sets:4,reps:'Al fallo',rest:'75s'},{name:'Press Inclinado con Mancuernas',sets:3,reps:'10-12',rest:'60s'},{name:'Remo con Barra',sets:3,reps:'8-12',rest:'60s'}] }, { day: 'Día 2: Hombros y Brazos', exercises: [{name:'Press Militar con Barra',sets:4,reps:'8-12',rest:'75s'},{name:'Elevaciones Laterales con Mancuernas',sets:4,reps:'12-15',rest:'45s'},{name:'Curl con Barra Z',sets:3,reps:'10-12',rest:'60s'},{name:'Press Francés',sets:3,reps:'10-12',rest:'60s'}] }, { day: 'Día 3: Piernas y Abdomen', exercises: [{name:'Sentadilla con Barra',sets:5,reps:'8-10',rest:'90s'},{name:'Peso Muerto Rumano con Barra/Mancuernas',sets:4,reps:'10-12',rest:'75s'},{name:'Elevación de Talones de Pie',sets:4,reps:'15-20',rest:'45s'},{name:'Crunches',sets:3,reps:'Al fallo',rest:'45s'}] } ] }
                        ],
                        "Fuerza y Potencia": [
                            { id: 'pre-upper-lower', name: 'Torso/Pierna (Upper/Lower)', description: 'Balance perfecto entre fuerza y tamaño, 4 días/semana.', icon: 'move-vertical', plan: [ { day: 'Día 1: Torso Fuerza', exercises: [{name:'Press de Banca Plano con Barra',sets:4,reps:'5-8',rest:'90s'},{name:'Remo con Barra',sets:4,reps:'5-8',rest:'90s'},{name:'Press Militar con Barra',sets:3,reps:'6-10',rest:'75s'},{name:'Dominadas (Agarre Ancho)',sets:3,reps:'Al fallo',rest:'75s'}] }, { day: 'Día 2: Pierna Fuerza', exercises: [{name:'Sentadilla con Barra',sets:4,reps:'5-8',rest:'120s'},{name:'Peso Muerto Rumano con Barra/Mancuernas',sets:3,reps:'8-10',rest:'90s'},{name:'Prensa de Piernas',sets:3,reps:'8-12',rest:'75s'},{name:'Elevación de Talones de Pie',sets:4,reps:'10-15',rest:'60s'}] }, { day: 'Día 3: Torso Hipertrofia', exercises: [{name:'Press Inclinado con Mancuernas',sets:4,reps:'10-12',rest:'60s'},{name:'Jalón al Pecho (Agarre Ancho)',sets:4,reps:'10-12',rest:'60s'},{name:'Elevaciones Laterales con Mancuernas',sets:4,reps:'12-15',rest:'45s'},{name:'Curl con Mancuernas',sets:3,reps:'12-15',rest:'45s'},{name:'Extensiones de Tríceps en Polea',sets:3,reps:'12-15',rest:'45s'}] }, { day: 'Día 4: Pierna Hipertrofia', exercises: [{name:'Sentadilla Frontal',sets:4,reps:'10-12',rest:'75s'},{name:'Curl Femoral Tumbado',sets:4,reps:'12-15',rest:'60s'},{name:'Zancadas',sets:3,reps:'12-15',rest:'60s'},{name:'Elevación de Piernas Colgado/Tumbado',sets:4,reps:'Al fallo',rest:'45s'}] } ] }
                        ],
                        "Enfoque Femenino": [
                            { id: 'pre-glute-focus', name: 'Glute Gains', description: 'Rutina enfocada en el desarrollo de glúteos y piernas.', icon: 'person-standing', plan: [ { day: 'Día 1: Pierna (Énfasis Glúteo)', exercises: [{name:'Hip Thrust con Barra',sets:4,reps:'8-12',rest:'75s'},{name:'Sentadilla Búlgara',sets:3,reps:'10-12',rest:'60s'},{name:'Peso Muerto Rumano con Mancuernas',sets:3,reps:'12-15',rest:'60s'},{name:'Patada de Glúteo en Polea',sets:3,reps:'15-20',rest:'45s'}] }, { day: 'Día 2: Torso y Core', exercises: [{name:'Jalón al Pecho (Agarre Ancho)',sets:4,reps:'10-15',rest:'60s'},{name:'Press Inclinado con Mancuernas',sets:3,reps:'12-15',rest:'60s'},{name:'Remo con Mancuerna (Serrucho)',sets:3,reps:'12-15',rest:'45s'},{name:'Elevaciones Laterales con Mancuernas',sets:4,reps:'15-20',rest:'45s'},{name:'Plancha Abdominal',sets:3,reps:'Al fallo',rest:'45s'}] }, { day: 'Día 3: Full Body', exercises: [{name:'Sentadilla con Barra',sets:4,reps:'10-12',rest:'75s'},{name:'Press de Banca Plano con Mancuernas',sets:4,reps:'10-12',rest:'60s'},{name:'Remo con Barra',sets:4,reps:'10-12',rest:'60s'},{name:'Hiperextensiones',sets:3,reps:'15-20',rest:'45s'}] } ] },
                            { id: 'pre-fullbody-tone', name: 'Full Body Toning', description: '3 días a la semana para tonificar todo el cuerpo.', icon: 'heart-pulse', plan: [ { day: 'Día A', exercises: [{name:'Sentadilla con Barra',sets:3,reps:'12-15',rest:'60s'},{name:'Press de Banca Plano con Barra',sets:3,reps:'12-15',rest:'60s'},{name:'Remo con Barra',sets:3,reps:'12-15',rest:'60s'},{name:'Elevaciones Laterales con Mancuernas',sets:3,reps:'15-20',rest:'45s'}] }, { day: 'Día B', exercises: [{name:'Peso Muerto Convencional/Sumo',sets:3,reps:'10-12',rest:'90s'},{name:'Press Militar con Barra',sets:3,reps:'12-15',rest:'60s'},{name:'Jalón al Pecho (Agarre Ancho)',sets:3,reps:'12-15',rest:'60s'},{name:'Elevación de Piernas Colgado/Tumbado',sets:3,reps:'al fallo',rest:'45s'}] } ] }
                        ],
                        "CBUM Signature Series": [
                            { id: 'pre-cbum-ppl', name: 'Push Pull Legs Élite (CBUM)', description: 'Periodización de seis días inspirada en Chris Bumstead para maximizar volumen y control, con énfasis en tempo y ejecución perfecta.', icon: 'dumbbell', plan: [
                                { day: 'Día 1: Push Pesado', exercises: [
                                    { name: 'Press de Banca Inclinado con Barra', sets: 4, reps: '6-8', rest: '120s' },
                                    { name: 'Press Militar con Mancuernas', sets: 3, reps: '8-10', rest: '90s' },
                                    { name: 'Press en Máquina Hammer', sets: 3, reps: '10-12', rest: '75s' },
                                    { name: 'Elevaciones Laterales con Mancuernas', sets: 4, reps: '12-15', rest: '60s' },
                                    { name: 'Fondos en Paralelas con Lastre', sets: 3, reps: '8-10', rest: '90s' }
                                ] },
                                { day: 'Día 2: Pull Controlado', exercises: [
                                    { name: 'Peso Muerto Rumano', sets: 4, reps: '6-8', rest: '120s' },
                                    { name: 'Remo con Barra en T', sets: 3, reps: '8-10', rest: '90s' },
                                    { name: 'Jalón al Pecho con Agarre Neutro', sets: 4, reps: '10-12', rest: '75s' },
                                    { name: 'Face Pulls con Cuerda', sets: 3, reps: '15-20', rest: '60s' },
                                    { name: 'Curl con Barra Z', sets: 3, reps: '10-12', rest: '60s' }
                                ] },
                                { day: 'Día 3: Piernas Dominantes', exercises: [
                                    { name: 'Sentadilla Trasera Controlada (Tempo 3-1-1)', sets: 4, reps: '6-8', rest: '150s' },
                                    { name: 'Prensa de Piernas a una Pierna', sets: 3, reps: '10-12', rest: '90s' },
                                    { name: 'Peso Muerto Búlgaro con Mancuernas', sets: 3, reps: '12-14', rest: '90s' },
                                    { name: 'Curl Femoral en Máquina', sets: 4, reps: '12-15', rest: '75s' },
                                    { name: 'Elevación de Talones Sentado', sets: 4, reps: '15-18', rest: '60s' }
                                ] },
                                { day: 'Día 4: Push Metabólico', exercises: [
                                    { name: 'Press de Banca con Mancuernas (Tempo 2-1-2)', sets: 3, reps: '10-12', rest: '75s' },
                                    { name: 'Press Arnold', sets: 3, reps: '12-15', rest: '60s' },
                                    { name: 'Cruce de Poleas Alto-Bajo', sets: 3, reps: '15-20', rest: '60s' },
                                    { name: 'Extensión de Tríceps en Polea con Cuerda', sets: 3, reps: '12-15', rest: '60s' },
                                    { name: 'Fondos entre Bancos con Contracción Isométrica', sets: 3, reps: 'Hasta el fallo', rest: '60s' }
                                ] },
                                { day: 'Día 5: Pull Volumen', exercises: [
                                    { name: 'Remo con Mancuernas Apoyado', sets: 4, reps: '10-12', rest: '75s' },
                                    { name: 'Jalón en Polea Alta con Descenso Controlado', sets: 3, reps: '12-15', rest: '75s' },
                                    { name: 'Remo a Pecho en Máquina', sets: 3, reps: '12-15', rest: '75s' },
                                    { name: 'Curl Inclinado con Mancuernas', sets: 3, reps: '12-15', rest: '60s' },
                                    { name: 'Curl Martillo con Cuerda', sets: 3, reps: '12-15', rest: '60s' }
                                ] },
                                { day: 'Día 6: Pierna Accesorios', exercises: [
                                    { name: 'Hip Thrust con Pausa', sets: 4, reps: '10-12', rest: '90s' },
                                    { name: 'Zancadas Caminando con Mancuernas', sets: 3, reps: '14-16', rest: '75s' },
                                    { name: 'Extensiones de Cuádriceps', sets: 3, reps: '15-20', rest: '60s' },
                                    { name: 'Curl Femoral Sentado', sets: 3, reps: '12-15', rest: '60s' },
                                    { name: 'Abducción de Cadera en Máquina', sets: 3, reps: '20', rest: '45s' }
                                ] }
                            ] },
                            { id: 'pre-cbum-chest-bis', name: 'Pecho y Bíceps Protocolo CBUM', description: 'Sesiones con énfasis en congestión controlada y progresión doble, ideal para priorizar torso anterior y brazos.', icon: 'activity', plan: [
                                { day: 'Día 1: Pecho Denso', exercises: [
                                    { name: 'Press de Banca Plano con Barra', sets: 5, reps: '5-8', rest: '150s' },
                                    { name: 'Press Inclinado con Mancuernas', sets: 4, reps: '8-10', rest: '90s' },
                                    { name: 'Press en Máquina Convergente', sets: 3, reps: '10-12', rest: '75s' },
                                    { name: 'Aperturas en Polea con Pausa', sets: 3, reps: '12-15', rest: '60s' },
                                    { name: 'Fondos en Anillas Asistidos', sets: 3, reps: 'Hasta el fallo', rest: '90s' }
                                ] },
                                { day: 'Día 2: Bíceps y Estabilidad', exercises: [
                                    { name: 'Curl con Barra Recta (Tempo 3-1-1)', sets: 4, reps: '8-10', rest: '90s' },
                                    { name: 'Curl Alterno en Banco Inclinado', sets: 3, reps: '10-12', rest: '75s' },
                                    { name: 'Curl de Martillo en Polea Baja', sets: 3, reps: '12-15', rest: '60s' },
                                    { name: 'Curl Concentrado en Banco', sets: 3, reps: '12-15', rest: '60s' },
                                    { name: 'Trabajo de Core: Plancha con Arrastre', sets: 3, reps: '45s', rest: '45s' }
                                ] },
                                { day: 'Día 3: Pecho + Bíceps Sinergia', exercises: [
                                    { name: 'Press Inclinado con Barra Tempo 3-1-2', sets: 4, reps: '8-10', rest: '90s' },
                                    { name: 'Cruce de Poleas en Descendente', sets: 3, reps: '12-15', rest: '60s' },
                                    { name: 'Pull Over con Mancuernas', sets: 3, reps: '10-12', rest: '75s' },
                                    { name: 'Superserie: Curl en Predicador + Curl Martillo', sets: 3, reps: '10-12 + 12-15', rest: '75s' },
                                    { name: 'Curl Alta Tensión en Cable', sets: 3, reps: '15-20', rest: '60s' }
                                ] }
                            ] },
                            { id: 'pre-cbum-legs-dominant', name: 'Piernas Dominantes CBUM', description: 'Microciclos centrados en densidad femoral y glúteo con énfasis en control excéntrico y trabajo unilateral.', icon: 'footprints', plan: [
                                { day: 'Día 1: Cuádriceps y Core', exercises: [
                                    { name: 'Sentadilla Frontal con Pausa', sets: 4, reps: '6-8', rest: '150s' },
                                    { name: 'Prensa de Piernas Profunda', sets: 4, reps: '10-12', rest: '90s' },
                                    { name: 'Split Squat Búlgaro con Mancuernas', sets: 3, reps: '12-14', rest: '90s' },
                                    { name: 'Extensiones de Cuádriceps en Pico de Contracción', sets: 3, reps: '15-20', rest: '60s' },
                                    { name: 'Plancha Lateral con Elevación de Pierna', sets: 3, reps: '40s', rest: '45s' }
                                ] },
                                { day: 'Día 2: Cadena Posterior', exercises: [
                                    { name: 'Peso Muerto Rumano con Barra', sets: 4, reps: '6-8', rest: '150s' },
                                    { name: 'Hip Thrust en Máquina con Pausa', sets: 4, reps: '8-10', rest: '90s' },
                                    { name: 'Curl Femoral Tumbado Tempo 3-1-2', sets: 3, reps: '12-15', rest: '75s' },
                                    { name: 'Buenos Días con Barra', sets: 3, reps: '10-12', rest: '90s' },
                                    { name: 'Elevaciones de Talón en Prensa', sets: 4, reps: '15-20', rest: '60s' }
                                ] },
                                { day: 'Día 3: Aceleración y Estabilidad', exercises: [
                                    { name: 'Sentadilla Hack con Tempo Controlado', sets: 3, reps: '10-12', rest: '90s' },
                                    { name: 'Zancadas en Caminadora Inclinada', sets: 3, reps: '90s', rest: '60s' },
                                    { name: 'Peso Muerto a una Pierna con Mancuernas', sets: 3, reps: '12-15', rest: '75s' },
                                    { name: 'Abducción en Polea de Pie', sets: 3, reps: '15-20', rest: '60s' },
                                    { name: 'Farmer Walk Pesado', sets: 4, reps: '35m', rest: '75s' }
                                ] }
                            ] }
                        ],
                        "Alta Intensidad": [
                            { id: 'pre-mentzer', name: 'Mentzer Heavy Duty', description: 'Máxima intensidad, mínimo volumen. Para avanzados.', icon: 'zap', plan: [ { day: 'Día 1: Pecho y Espalda', exercises: [{name:'Pec Deck (Contractora)',sets:1,reps:'8-12 (al fallo)',rest:'10s'},{name:'Press Inclinado con Mancuernas',sets:1,reps:'6-8 (al fallo)',rest:'120s'},{name:'Pullover en Polea Alta',sets:1,reps:'8-12 (al fallo)',rest:'10s'},{name:'Jalón al Pecho (Agarre Ancho)',sets:1,reps:'6-8 (al fallo)',rest:'120s'}] }, { day: 'Día 2: Piernas', exercises: [{name:'Extensiones de Cuádriceps',sets:1,reps:'10-15 (al fallo)',rest:'10s'},{name:'Prensa de Piernas',sets:1,reps:'8-12 (al fallo)',rest:'120s'},{name:'Curl Femoral Tumbado',sets:1,reps:'8-12 (al fallo)',rest:'90s'},{name:'Elevación de Talones de Pie',sets:1,reps:'12-15 (al fallo)',rest:'60s'}] }, { day: 'Día 3: Hombros y Brazos', exercises: [{name:'Elevaciones Laterales con Mancuernas',sets:1,reps:'8-12 (al fallo)',rest:'10s'},{name:'Press Militar con Barra',sets:1,reps:'6-8 (al fallo)',rest:'120s'},{name:'Curl con Barra Z',sets:1,reps:'6-8 (al fallo)',rest:'90s'},{name:'Extensiones de Tríceps en Polea',sets:1,reps:'8-10 (al fallo)',rest:'60s'}] } ] }
                        ],
                        "Quema de Grasa": [
                            { id: 'pre-fbb', name: 'Full Body Burn', description: 'Cardio y fuerza para quemar calorías y definir.', icon: 'flame', plan: [ { day: 'Día A', exercises: [{name:'Sentadilla con Barra',sets:3,reps:'15', rest:'45s'},{name:'Fondos en Paralelas',sets:3,reps:'Al fallo', rest:'60s'},{name:'Remo con Mancuerna (Serrucho)',sets:3,reps:'15', rest:'45s'},{name:'Plancha Abdominal',sets:3,reps:'60s', rest:'45s'}] }, { day: 'Día B', exercises: [{name:'Zancadas',sets:3,reps:'15', rest:'45s'},{name:'Jalón al Pecho (Agarre Ancho)',sets:3,reps:'15', rest:'45s'},{name:'Press de Banca Plano con Barra',sets:3,reps:'15', rest:'45s'},{name:'Elevación de Piernas Colgado/Tumbado',sets:3,reps:'20', rest:'45s'}] } ] }
                        ]
                    },
                    exerciseLibrary: {
                        "Pecho":{
                            "Superior":[
                                {name:"Press Inclinado con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/1/17441.gif"},
                                {name:"Press Inclinado con Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/3/5/10235.gif"},
                                {name:"Cruce de Poleas (Bajo a Alto)", mediaUrl: null},
                                {name:"Aperturas Inclinadas", mediaUrl: null}
                            ],
                            "Medio":[
                                {name:"Press de Banca Plano con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/3/8/17438.gif"},
                                {name:"Press de Banca Plano con Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/2/8/10228.gif"},
                                {name:"Aperturas Planas con Mancuernas", mediaUrl: null},
                                {name:"Pec Deck (Contractora)", mediaUrl: "https://gymvisual.com/img/p/1/7/3/2/5/17325.gif"},
                                {name:"Press en Máquina", mediaUrl: null}
                            ],
                            "Inferior":[
                                {name:"Press Declinado con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/3/9/17439.gif"},
                                {name:"Fondos en Paralelas", mediaUrl: "https://gymvisual.com/img/p/1/7/3/0/1/17301.gif"},
                                {name:"Cruce de Poleas (Alto a Bajo)", mediaUrl: null}
                            ]
                        },
                        "Espalda":{
                            "Dorsales (Amplitud)":[
                                {name:"Dominadas (Agarre Ancho)", mediaUrl: "https://gymvisual.com/img/p/1/7/2/8/8/17288.gif"},
                                {name:"Jalón al Pecho (Agarre Ancho)", mediaUrl: "https://gymvisual.com/img/p/1/7/3/4/0/17340.gif"},
                                {name:"Remo Gironda (Agarre Estrecho)", mediaUrl: null},
                                {name:"Pullover en Polea Alta", mediaUrl: null}
                            ],
                            "Espalda Media (Densidad)":[
                                {name:"Remo con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/5/17445.gif"},
                                {name:"Remo con Mancuerna (Serrucho)", mediaUrl: "https://gymvisual.com/img/p/1/0/2/5/0/10250.gif"},
                                {name:"Remo en Punta (T-Bar)", mediaUrl: null},
                                {name:"Face Pulls", mediaUrl: null}
                            ],
                            "Lumbares":[
                                {name:"Peso Muerto Convencional/Sumo", mediaUrl: "https://gymvisual.com/img/p/1/7/4/5/2/17452.gif"},
                                {name:"Hiperextensiones", mediaUrl: "https://gymvisual.com/img/p/1/7/3/1/5/17315.gif"},
                                {name:"Good Mornings", mediaUrl: null}
                            ]
                        },
                        "Pierna":{
                            "Cuádriceps":[
                                {name:"Sentadilla con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/9/17449.gif"},
                                {name:"Sentadilla Frontal", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/2/17442.gif"},
                                {name:"Prensa de Piernas", mediaUrl: "https://gymvisual.com/img/p/1/7/3/5/6/17356.gif"},
                                {name:"Zancadas", mediaUrl: "https://gymvisual.com/img/p/1/0/3/1/6/10316.gif"},
                                {name:"Sentadilla Búlgara", mediaUrl: "https://gymvisual.com/img/p/1/0/2/0/9/10209.gif"},
                                {name:"Extensiones de Cuádriceps", mediaUrl: "https://gymvisual.com/img/p/1/7/3/5/4/17354.gif"}
                            ],
                            "Femorales":[
                                {name:"Peso Muerto Rumano con Barra/Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/6/2/10262.gif"},
                                {name:"Curl Femoral Tumbado", mediaUrl: "https://gymvisual.com/img/p/1/7/3/5/5/17355.gif"},
                                {name:"Curl Femoral Sentado", mediaUrl: null}
                            ],
                            "Glúteos":[
                                {name:"Hip Thrust con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/3/17443.gif"},
                                {name:"Peso Muerto Sumo", mediaUrl: null},
                                {name:"Patada de Glúteo en Polea", mediaUrl: null},
                                {name:"Abducción de Cadera en Máquina/Polea", mediaUrl: null}
                            ],
                            "Gemelos":[
                                {name:"Elevación de Talones de Pie", mediaUrl: "https://gymvisual.com/img/p/1/7/2/9/3/17293.gif"},
                                {name:"Elevación de Talones Sentado (Sóleo)", mediaUrl: null}
                            ]
                        },
                        "Hombro":{
                            "Deltoides Anterior":[
                                {name:"Press Militar con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/7/17447.gif"},
                                {name:"Press Arnold", mediaUrl: null},
                                {name:"Elevaciones Frontales con Mancuerna/Polea", mediaUrl: null}
                            ],
                            "Deltoides Lateral":[
                                {name:"Elevaciones Laterales con Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/4/3/10243.gif"},
                                {name:"Elevaciones Laterales en Polea", mediaUrl: null},
                                {name:"Remo al Mentón (Agarre Ancho)", mediaUrl: null}
                            ],
                            "Deltoides Posterior":[
                                {name:"Pájaros (Bent Over Raises)", mediaUrl: "https://gymvisual.com/img/p/1/0/2/1/4/10214.gif"},
                                {name:"Pec Deck Inverso", mediaUrl: null}
                            ]
                        },
                        "Brazo":{
                            "Bíceps":[
                                {name:"Curl con Barra Z", mediaUrl: "https://gymvisual.com/img/p/1/0/2/0/1/10201.gif"},
                                {name:"Curl con Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/2/5/10225.gif"},
                                {name:"Curl Martillo", mediaUrl: "https://gymvisual.com/img/p/1/0/2/4/0/10240.gif"},
                                {name:"Curl de Concentración", mediaUrl: null},
                                {name:"Curl en Banco Scott", mediaUrl: null}
                            ],
                            "Tríceps":[
                                {name:"Press Francés", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/6/17446.gif"},
                                {name:"Extensiones de Tríceps en Polea", mediaUrl: "https://gymvisual.com/img/p/1/7/3/3/0/17330.gif"},
                                {name:"Press de Banca (Agarre Estrecho)", mediaUrl: null},
                                {name:"Fondos entre Bancos", mediaUrl: null}
                            ],
                            "Antebrazo":[
                                {name:"Curl de Muñeca (Supino/Prono)", mediaUrl: null},
                                {name:"Paseo del Granjero", mediaUrl: null}
                            ]
                        },
                        "Abdomen":{
                            "Recto Abdominal":[
                                {name:"Crunches", mediaUrl: "https://gymvisual.com/img/p/1/7/2/9/9/17299.gif"},
                                {name:"Elevación de Piernas Colgado/Tumbado", mediaUrl: "https://gymvisual.com/img/p/1/7/3/1/4/17314.gif"}
                            ],
                            "Oblicuos":[
                                {name:"Russian Twists", mediaUrl: null},
                                {name:"Leñador en Polea (Woodchoppers)", mediaUrl: null}
                            ],
                            "Core General":[
                                {name:"Plancha Abdominal", mediaUrl: "https://gymvisual.com/img/p/1/7/3/6/5/17365.gif"},
                                {name:"Rueda Abdominal (Ab Wheel)", mediaUrl: null}
                            ]
                        }
                    },
                exerciseGroupImages: {
                    "Pecho": "https://images.unsplash.com/photo-1517832207067-4db24a2ae47c?auto=format&fit=crop&w=800&q=80",
                    "Espalda": "https://images.unsplash.com/photo-1517430816045-df4b7de1cd0d?auto=format&fit=crop&w=800&q=80",
                    "Pierna": "https://images.unsplash.com/photo-1579758629938-03607ccdbaba?auto=format&fit=crop&w=800&q=80",
                    "Hombro": "https://images.unsplash.com/photo-1599058917212-d750089bc07c?auto=format&fit=crop&w=800&q=80",
                    "Brazo": "https://images.unsplash.com/photo-1526402462925-efba5de1c9f1?auto=format&fit=crop&w=800&q=80",
                    "Abdomen": "https://images.unsplash.com/photo-1506354666786-959d6d497f1a?auto=format&fit=crop&w=800&q=80"
                },
                foodDatabase: {"Proteínas":[{"id":1,"name":"Pechuga de Pollo","cals":165,"p":31,"c":0,"f":3.6},{"id":2,"name":"Pechuga de Pavo","cals":135,"p":30,"c":0,"f":1},{"id":3,"name":"Salmón","cals":208,"p":20,"c":0,"f":13},{"id":4,"name":"Atún en lata (agua)","cals":116,"p":26,"c":0,"f":1},{"id":5,"name":"Carne de Res Magra (90%)","cals":198,"p":28,"c":0,"f":9},{"id":6,"name":"Huevo Entero","cals":155,"p":13,"c":1.1,"f":11},{"id":7,"name":"Clara de Huevo","cals":52,"p":11,"c":0.7,"f":0.2},{"id":8,"name":"Lentejas (cocidas)","cals":116,"p":9,"c":20,"f":0.4},{"id":9,"name":"Garbanzos (cocidos)","cals":139,"p":7.6,"c":22,"f":3.8},{"id":10,"name":"Tofu Firme","cals":76,"p":8,"c":1.9,"f":4.8}],"Carbohidratos":[{"id":11,"name":"Arroz Blanco (cocido)","cals":130,"p":2.7,"c":28,"f":0.3},{"id":12,"name":"Arroz Integral (cocido)","cals":111,"p":2.6,"c":23,"f":0.9},{"id":13,"name":"Avena en Hojuelas","cals":389,"p":17,"c":66,"f":7},{"id":14,"name":"Papa/Patata (cocida)","cals":87,"p":2,"c":20,"f":0.1},{"id":15,"name":"Batata/Camote (cocido)","cals":86,"p":1.6,"c":20,"f":0.1},{"id":16,"name":"Pan Integral","cals":265,"p":13,"c":41,"f":4.5},{"id":17,"name":"Pasta Integral (cocida)","cals":124,"p":5,"c":26,"f":0.8},{"id":18,"name":"Quinoa (cocida)","cals":120,"p":4.4,"c":21,"f":1.9},{"id":19,"name":"Maíz/Elote (cocido)","cals":96,"p":3.4,"c":21,"f":1.5}],"Grasas Saludables":[{"id":20,"name":"Aguacate","cals":160,"p":2,"c":9,"f":15},{"id":21,"name":"Aceite de Oliva Extra Virgen","cals":884,"p":0,"c":0,"f":100},{"id":22,"name":"Almendras","cals":579,"p":21,"c":22,"f":49},{"id":23,"name":"Nueces","cals":654,"p":15,"c":14,"f":65},{"id":24,"name":"Semillas de Chía","cals":486,"p":17,"c":42,"f":31},{"id":25,"name":"Mantequilla de Maní Natural","cals":588,"p":25,"c":20,"f":50}],"Frutas y Verduras":[{"id":26,"name":"Brócoli","cals":55,"p":3.7,"c":11,"f":0.6},{"id":27,"name":"Espinaca","cals":23,"p":2.9,"c":3.6,"f":0.4},{"id":28,"name":"Plátano","cals":89,"p":1.1,"c":23,"f":0.3},{"id":29,"name":"Manzana","cals":52,"p":0.3,"c":14,"f":0.2},{"id":30,"name":"Fresa","cals":32,"p":0.7,"c":8,"f":0.3},{"id":31,"name":"Tomate","cals":18,"p":0.9,"c":3.9,"f":0.2},{"id":32,"name":"Zanahoria","cals":41,"p":0.9,"c":10,"f":0.2}],"Lácteos y Derivados":[{"id":33,"name":"Yogur Griego Natural (0%)","cals":59,"p":10,"c":3.6,"f":0.4},{"id":34,"name":"Leche Descremada","cals":34,"p":3.4,"c":5,"f":0.1},{"id":35,"name":"Queso Cottage (bajo en grasa)","cals":72,"p":12,"c":2.7,"f":1},{"id":36,"name":"Queso Mozzarella","cals":280,"p":22,"c":2.2,"f":20}],"Suplementos":[{"id":37,"name":"Proteína Whey (Polvo)","cals":390,"p":75,"c":8,"f":5},{"id":38,"name":"Creatina Monohidratada","cals":0,"p":0,"c":0,"f":0}]},
                    foodOverrides: {},
                    foodLibrary: [], // Se llenará con la base de datos + alimentos personalizados
                },
                
                init() {
                    if(typeof lucide === 'undefined'){ setTimeout(() => this.init(), 50); return; }
                    this.state = this.getDefaultState();
                    this.auth = getAuth(this.firebaseApp);
                    this.db = getFirestore(this.firebaseApp);
                    this.storage = getStorage(this.firebaseApp);
                    this._imagePreloadCache = new Map();
                    this.setupAuthListeners();
                    this.setupEventListeners();
                    this.showLaunchScreen();
                    lucide.createIcons();
                },

                async initAppLogic() {
                    this.audioCtx = new(window.AudioContext || window.webkitAudioContext)();
                    await this.loadExerciseLibraryFromFirestore();
                    await this.loadExerciseGroupImagesFromFirestore();
                    this.preloadExerciseGroupImages();
                    await this.loadAndMergeFoodData(); // Cargar alimentos
                    this.loadTemplates();
                    await this.loadCommunityData();
                    this.populateNutritionForm();
                    this.adjustUIForRole();
                    this.renderAll();
                    this.getDailyTip();
                    this.showSection(this.state.currentSection, false);
                    this.updateUserInfoUI();
                },

                adjustUIForRole() {
                    const navAsesorados = document.getElementById('nav-asesorados');
                    const navRoles = document.getElementById('nav-roles');
                    const navNutricion = document.getElementById('nav-nutricion');
                    const createRoutineBtn = document.getElementById('create-routine-btn');
                    const predefinedRoutines = document.getElementById('predefined-routines-section');
                    const dietManagementTools = document.getElementById('diet-management-tools');
                    const addFoodSection = document.getElementById('add-food-section');
                    const dietAdminActions = document.getElementById('diet-admin-actions');

                    const navRutinasText = document.querySelector('#nav-rutinas .nav-label');

                    if (navRoles) {
                        navRoles.style.display = this.isAdmin() ? 'flex' : 'none';
                    }

                    if (this.isAdmin()) {
                        if (navAsesorados) navAsesorados.style.display = 'none';
                        if (navNutricion) navNutricion.style.display = 'flex';
                        if (createRoutineBtn) createRoutineBtn.style.display = 'flex';
                        if (predefinedRoutines) predefinedRoutines.style.display = 'block';
                        if (dietManagementTools) dietManagementTools.style.display = 'block';
                        if (addFoodSection) addFoodSection.style.display = 'block';
                        if (dietAdminActions) dietAdminActions.style.display = 'flex';
                        if (navRutinasText) navRutinasText.textContent = 'Rutinas';
                        return;
                    }

                    if (this.isCoach()) {
                        if (navAsesorados) navAsesorados.style.display = 'flex';
                        if (navNutricion) navNutricion.style.display = 'flex';
                        if (createRoutineBtn) createRoutineBtn.style.display = 'flex';
                        if (predefinedRoutines) predefinedRoutines.style.display = 'block';
                        if (dietManagementTools) dietManagementTools.style.display = 'block';
                        if (addFoodSection) addFoodSection.style.display = 'block';
                        if (dietAdminActions) dietAdminActions.style.display = this.canEditGlobalMedia() ? 'flex' : 'none';
                        if (navRutinasText) navRutinasText.textContent = 'Rutinas';
                        return;
                    }

                    if (navAsesorados) navAsesorados.style.display = 'none';
                    if (navNutricion) navNutricion.style.display = 'none';
                    if (createRoutineBtn) createRoutineBtn.style.display = 'none';
                    if (predefinedRoutines) predefinedRoutines.style.display = 'none';
                    if (dietManagementTools) dietManagementTools.style.display = 'none';
                    if (addFoodSection) addFoodSection.style.display = 'none';
                    if (dietAdminActions) dietAdminActions.style.display = 'none';
                    if (navRutinasText) navRutinasText.textContent = 'Mi Rutina';
                },

                async saveDataToFirestore() {
                    if (!this.state.currentUser) return false;
                    const dataToSave = { ...this.state };
                    ['currentUser', 'activeWorkout', 'timer', 'currentSection', 'asesorados', 'managedRoles', 'isMobileMenuOpen', 'community', 'isCommunityLoading', 'theme'].forEach(key => delete dataToSave[key]);
                    const userRef = doc(this.db, "users", this.state.currentUser.uid);
                    try {
                        await setDoc(userRef, dataToSave, { merge: true });
                        return true;
                    } catch (error) {
                        console.error("Error saving data to Firestore: ", error);
                        this.showToast("Error al guardar datos.", "error");
                        return false;
                    }
                },
                
                async loadDataFromFirestore() {
                    const userRef = doc(this.db, "users", this.state.currentUser.uid);
                    try {
                        const docSnap = await getDoc(userRef);
                        const defaultState = this.getDefaultState();
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            this.state = { ...defaultState, currentUser: this.state.currentUser, ...data };
                            delete this.state.theme;
                            this.state.physicalStats = { ...defaultState.physicalStats, ...data.physicalStats };
                            this.state.userGoals = { ...defaultState.userGoals, ...data.userGoals };
                            if (data.dashboardCover) {
                                if (typeof data.dashboardCover === 'string') {
                                    this.state.dashboardCover = { ...defaultState.dashboardCover, image: data.dashboardCover };
                                } else {
                                    this.state.dashboardCover = { ...defaultState.dashboardCover, ...data.dashboardCover };
                                }
                            } else {
                                this.state.dashboardCover = { ...defaultState.dashboardCover };
                            }
                            if (data.routineBanner) {
                                if (typeof data.routineBanner === 'string') {
                                    this.state.routineBanner = { ...defaultState.routineBanner, image: data.routineBanner };
                                } else {
                                    this.state.routineBanner = { ...defaultState.routineBanner, ...data.routineBanner };
                                }
                            } else {
                                this.state.routineBanner = { ...defaultState.routineBanner };
                            }
                            if (data.profilePhoto) {
                                if (typeof data.profilePhoto === 'string') {
                                    this.state.profilePhoto = { ...defaultState.profilePhoto, url: data.profilePhoto };
                                } else {
                                    this.state.profilePhoto = { ...defaultState.profilePhoto, ...data.profilePhoto };
                                }
                            } else {
                                this.state.profilePhoto = { ...defaultState.profilePhoto };
                            }
                            if (data.dietPanelCovers && typeof data.dietPanelCovers === 'object') {
                                const defaultCovers = defaultState.dietPanelCovers || {};
                                this.state.dietPanelCovers = {};
                                Object.keys(defaultCovers).forEach((key) => {
                                    const coverData = data.dietPanelCovers[key] || {};
                                    this.state.dietPanelCovers[key] = { ...defaultCovers[key], ...coverData };
                                    if (this.state.dietPanelCovers[key].url) {
                                        this.preloadImage(this.state.dietPanelCovers[key].url, { priority: 'high' });
                                    }
                                });
                            } else {
                                this.state.dietPanelCovers = { ...defaultState.dietPanelCovers };
                            }
                            if (this.state.profilePhoto?.url) {
                                this.preloadImage(this.state.profilePhoto.url, { priority: 'high' });
                            }
                            if (this.state.routineBanner?.image) {
                                this.preloadImage(this.state.routineBanner.image, { priority: 'high' });
                            }
                            // Compatibilidad hacia atrás para la estructura de dieta
                            if (data.dailyDiet && !Array.isArray(data.dailyDiet)) {
                                this.state.dailyDiet = defaultState.dailyDiet;
                            }
                            if (data.workoutHistory) {
                                const normalizedHistory = {};
                                Object.entries(data.workoutHistory).forEach(([dateKey, value]) => {
                                    if (Array.isArray(value)) {
                                        const normalizedArray = value.map(entry => this._normalizeWorkoutEntry(entry, dateKey));
                                        normalizedHistory[dateKey] = normalizedArray.sort((a, b) => new Date(a.completedAt || 0) - new Date(b.completedAt || 0));
                                    } else if (value && typeof value === 'object') {
                                        normalizedHistory[dateKey] = [this._normalizeWorkoutEntry(value, dateKey)];
                                    }
                                });
                                this.state.workoutHistory = normalizedHistory;
                            }
                            this.state.community = { ...defaultState.community };
                            this.state.isCommunityLoading = false;
                            if (this.state.role === 'asesor') {
                                this.state.role = this.auth.currentUser.uid === this.adminUID ? 'admin' : 'entrenador';
                            }
                        } else {
                            this.state = defaultState;
                            this.state.currentUser = this.auth.currentUser;
                            this.state.userName = this.auth.currentUser.displayName || "Nuevo Usuario";
                            this.state.role = this.auth.currentUser.uid === this.adminUID ? 'admin' : 'asesorado';
                            await this.saveDataToFirestore();
                        }
                    } catch (error) {
                        console.error("Error loading data from Firestore: ", error);
                        this.showToast("Error al cargar datos.", "error");
                    }
                },

                async loadAndMergeFoodData() {
                    const baseFoods = Object.entries(this.data.foodDatabase).flatMap(([category, items]) =>
                        items.map(item => ({ ...item, category, source: 'predefined' }))
                    );

                    let overrides = {};
                    if (this.db) {
                        try {
                            const overridesDoc = await getDoc(doc(this.db, 'app_data', 'food_overrides'));
                            if (overridesDoc.exists()) {
                                const data = overridesDoc.data() || {};
                                overrides = data.overrides || data;
                            }
                        } catch (error) {
                            console.error('Error fetching food overrides:', error);
                        }
                    }

                    this.data.foodOverrides = overrides;

                    const mergedPredefined = baseFoods.reduce((acc, item) => {
                        const override = overrides?.[item.id] || overrides?.[String(item.id)];
                        if (override?.hidden) {
                            return acc;
                        }
                        const merged = { ...item, ...(override || {}) };
                        if (!merged.category && item.category) {
                            merged.category = item.category;
                        }
                        merged.id = item.id;
                        merged.source = 'predefined';
                        acc.push(merged);
                        return acc;
                    }, []);

                    let customFoods = [];
                    if (this.isAsesor()) {
                        try {
                            const q = query(collection(this.db, 'users', this.state.currentUser.uid, 'customFoods'));
                            const querySnapshot = await getDocs(q);
                            customFoods = querySnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data(), source: 'custom', category: 'Mis Alimentos' }));
                        } catch (error) {
                            console.error('Error fetching custom foods:', error);
                        }
                    }

                    this.data.foodLibrary = [...mergedPredefined, ...customFoods];
                },

                async loadExerciseLibraryFromFirestore() {
                    const docRef = doc(this.db, "app_data", "exercise_library");
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            this.data.exerciseLibrary = docSnap.data();
                        } else {
                            console.log("No exercise library found in DB, seeding initial data...");
                            if (this.state.currentUser && this.state.currentUser.uid === this.adminUID) {
                                await setDoc(docRef, this.data.exerciseLibrary);
                            }
                        }
                    } catch (error) {
                        console.error("Error loading exercise library: ", error);
                        this.showToast("Error al cargar ejercicios.", "error");
                    }
                },

                async loadExerciseGroupImagesFromFirestore() {
                    const docRef = doc(this.db, "app_data", "exercise_group_images");
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            this.data.exerciseGroupImages = {
                                ...this.data.exerciseGroupImages,
                                ...docSnap.data()
                            };
                            this.preloadExerciseGroupImages();
                        } else if (this.state.currentUser && this.state.currentUser.uid === this.adminUID) {
                            await setDoc(docRef, this.data.exerciseGroupImages);
                        }
                    } catch (error) {
                        console.error("Error loading exercise group images: ", error);
                    }
                },

                async loadCommunityData(showSuccessToast = false) {
                    if (!this.db) {
                        return;
                    }

                    const previousActive = this.state?.community?.activeLeaderboard || 'volume';
                    this.state.isCommunityLoading = true;
                    this.renderCommunitySection();

                    try {
                        const usersSnapshot = await getDocs(collection(this.db, "users"));
                        const now = new Date();
                        now.setHours(0, 0, 0, 0);
                        const dayMs = 86_400_000;
                        const thirtyDaysAgo = new Date(now.getTime() - 29 * dayMs);
                        const lastSevenStart = new Date(now.getTime() - 6 * dayMs);
                        const previousSevenStart = new Date(now.getTime() - 13 * dayMs);

                        const intl = new Intl.NumberFormat('es-ES');
                        const normalizeDateValue = (value, fallbackDate) => {
                            if (!value) {
                                return new Date(`${fallbackDate}T00:00:00`);
                            }
                            if (value instanceof Date) {
                                return value;
                            }
                            if (typeof value === 'object') {
                                if (typeof value.toDate === 'function') {
                                    return value.toDate();
                                }
                                if (typeof value.seconds === 'number') {
                                    return new Date(value.seconds * 1000);
                                }
                            }
                            const parsed = new Date(value);
                            return Number.isNaN(parsed.getTime()) ? new Date(`${fallbackDate}T00:00:00`) : parsed;
                        };

                        const members = [];

                        usersSnapshot.forEach(userDoc => {
                            const data = userDoc.data() || {};
                            const name = data.userName || 'Atleta';
                            const history = data.workoutHistory || {};
                            const normalizedEntries = [];

                            Object.entries(history).forEach(([dateKey, record]) => {
                                if (!record) {
                                    return;
                                }
                                const pushEntry = (entry) => {
                                    if (!entry) return;
                                    const normalized = this._normalizeWorkoutEntry({
                                        ...entry,
                                        completedAt: entry?.completedAt ? normalizeDateValue(entry.completedAt, dateKey).toISOString() : entry?.completedAt
                                    }, dateKey);
                                    const parsedDate = normalizeDateValue(normalized.completedAt, dateKey);
                                    normalizedEntries.push({ ...normalized, parsedDate });
                                };

                                if (Array.isArray(record)) {
                                    record.forEach(item => pushEntry(item));
                                } else if (typeof record === 'object') {
                                    pushEntry(record);
                                }
                            });

                            normalizedEntries.sort((a, b) => a.parsedDate - b.parsedDate);

                            const last30Entries = normalizedEntries.filter(entry => entry.parsedDate >= thirtyDaysAgo);
                            const weeklyEntries = normalizedEntries.filter(entry => entry.parsedDate >= lastSevenStart);
                            const previousWeeklyEntries = normalizedEntries.filter(entry => entry.parsedDate >= previousSevenStart && entry.parsedDate < lastSevenStart);

                            const toDateKey = (entry) => entry.date || entry.parsedDate.toISOString().split('T')[0];
                            const trainingDaysSet = new Set(last30Entries.map(toDateKey));
                            const allDaysSet = new Set(normalizedEntries.map(toDateKey));

                            const entryVolume = (entry) => typeof entry.totalVolume === 'number'
                                ? entry.totalVolume
                                : (Array.isArray(entry.exerciseDetails)
                                    ? entry.exerciseDetails.reduce((sum, ex) => sum + (ex.volume || 0), 0)
                                    : 0);

                            const totalVolume30 = last30Entries.reduce((sum, entry) => sum + entryVolume(entry), 0);
                            const weeklyVolume = weeklyEntries.reduce((sum, entry) => sum + entryVolume(entry), 0);
                            const previousWeeklyVolume = previousWeeklyEntries.reduce((sum, entry) => sum + entryVolume(entry), 0);
                            const volumeTrend = weeklyVolume - previousWeeklyVolume;

                            let bestLiftWeight = 0;
                            let bestLiftName = '';
                            normalizedEntries.forEach(entry => {
                                if (!Array.isArray(entry.exerciseDetails)) {
                                    return;
                                }
                                entry.exerciseDetails.forEach(detail => {
                                    const weight = typeof detail.bestWeight === 'number' ? detail.bestWeight : 0;
                                    if (weight > bestLiftWeight) {
                                        bestLiftWeight = weight;
                                        bestLiftName = detail.name || '';
                                    }
                                });
                            });

                            let latestWorkout = null;
                            if (normalizedEntries.length > 0) {
                                const entry = normalizedEntries[normalizedEntries.length - 1];
                                latestWorkout = {
                                    date: entry.parsedDate,
                                    routineName: entry.routineName,
                                    totalVolume: entryVolume(entry),
                                    totalDuration: entry.totalDuration || 0
                                };
                            }

                            const weightLog = Array.isArray(data.weightLog)
                                ? data.weightLog
                                    .filter(item => item && item.date && typeof item.weight === 'number')
                                    .map(item => ({ ...item, parsedDate: normalizeDateValue(item.date, item.date) }))
                                    .sort((a, b) => a.parsedDate - b.parsedDate)
                                : [];

                            const weightDelta = weightLog.length > 1
                                ? weightLog[weightLog.length - 1].weight - weightLog[0].weight
                                : 0;

                            const weightLabel = weightLog.length > 1
                                ? `${weightDelta > 0 ? '+' : ''}${weightDelta.toFixed(1)} kg desde ${weightLog[0].parsedDate.toLocaleDateString('es-ES')}`
                                : 'Registra tu peso para medir cambios';

                            let streak = 0;
                            if (allDaysSet.size > 0) {
                                const cursor = new Date(now);
                                while (cursor >= thirtyDaysAgo) {
                                    const key = cursor.toISOString().split('T')[0];
                                    if (allDaysSet.has(key)) {
                                        streak += 1;
                                        cursor.setDate(cursor.getDate() - 1);
                                    } else {
                                        break;
                                    }
                                }
                            }

                            const volumeTrendLabel = (weeklyVolume === 0 && previousWeeklyVolume === 0)
                                ? 'Sin cargas registradas esta semana'
                                : (previousWeeklyVolume === 0 && weeklyVolume > 0)
                                    ? 'Nuevo pico semanal'
                                    : `${volumeTrend >= 0 ? '+' : ''}${intl.format(Math.round(volumeTrend))} kg vs semana pasada`;

                            const progressLabelParts = [];
                            if (weeklyVolume > 0) {
                                progressLabelParts.push(previousWeeklyVolume > 0
                                    ? `${volumeTrend >= 0 ? '+' : ''}${intl.format(Math.round(volumeTrend))} kg semana a semana`
                                    : 'Primer registro semanal');
                            }
                            if (weightLog.length > 1) {
                                progressLabelParts.push(`${weightDelta > 0 ? '+' : ''}${weightDelta.toFixed(1)} kg totales`);
                            }
                            const progressLabel = progressLabelParts.length > 0
                                ? progressLabelParts.join(' · ')
                                : 'Suma actividad para ver tu progreso';

                            const progressScore = Math.max(0, previousWeeklyVolume > 0
                                ? (volumeTrend / previousWeeklyVolume) * 100
                                : (weeklyVolume > 0 ? 75 : 0))
                                + (weightDelta < 0
                                    ? Math.min(100, Math.abs(weightDelta) * 15)
                                    : weightDelta > 0
                                        ? Math.min(100, weightDelta * 10)
                                        : 0);

                            const initials = name
                                .split(/\s+/)
                                .filter(Boolean)
                                .map(word => word[0])
                                .join('')
                                .slice(0, 2)
                                .toUpperCase() || name.charAt(0).toUpperCase();

                            members.push({
                                id: userDoc.id,
                                name,
                                initials,
                                totalVolume30,
                                weeklyVolume,
                                previousWeeklyVolume,
                                volumeTrend,
                                volumeTrendLabel,
                                trainingDays30: trainingDaysSet.size,
                                sessionCount30: last30Entries.length,
                                streak,
                                bestLiftWeight,
                                bestLiftName,
                                latestWorkout,
                                weightDelta,
                                weightLabel,
                                progressScore,
                                progressLabel
                            });
                        });

                        const stats = {
                            totalAthletes: usersSnapshot.size,
                            totalVolume: members.reduce((sum, member) => sum + member.totalVolume30, 0),
                            totalSessions: members.reduce((sum, member) => sum + member.sessionCount30, 0)
                        };

                        const formatKg = (value) => `${intl.format(Math.round(value))} kg`;
                        const formatDays = (value) => `${value} día${value === 1 ? '' : 's'}`;

                        const mapLeaderboardEntry = (member, index, formattedValue, subLabel, trendLabel) => ({
                            rank: index + 1,
                            id: member.id,
                            name: member.name,
                            initials: member.initials,
                            formattedValue,
                            subLabel,
                            trendLabel,
                            streak: member.streak,
                            progressScore: Math.round(member.progressScore),
                            progressLabel: member.progressLabel,
                            weightLabel: member.weightLabel,
                            bestLiftLabel: member.bestLiftWeight > 0 ? `${member.bestLiftWeight.toFixed(0)} kg en ${member.bestLiftName}` : 'Registra tu 1RM'
                        });

                        const volumeLeaderboard = members
                            .filter(member => member.totalVolume30 > 0)
                            .sort((a, b) => b.totalVolume30 - a.totalVolume30)
                            .slice(0, 5)
                            .map((member, index) => mapLeaderboardEntry(
                                member,
                                index,
                                formatKg(member.totalVolume30),
                                `${formatDays(member.trainingDays30)} activos`,
                                member.volumeTrendLabel
                            ));

                        const sessionsLeaderboard = members
                            .filter(member => member.trainingDays30 > 0)
                            .sort((a, b) => (b.trainingDays30 === a.trainingDays30)
                                ? b.streak - a.streak
                                : b.trainingDays30 - a.trainingDays30)
                            .slice(0, 5)
                            .map((member, index) => mapLeaderboardEntry(
                                member,
                                index,
                                formatDays(member.trainingDays30),
                                `${member.sessionCount30} sesiones registradas`,
                                member.streak > 0 ? `${member.streak} días de racha` : 'Sin racha activa'
                            ));

                        const progressLeaderboard = members
                            .filter(member => member.progressScore > 0)
                            .sort((a, b) => b.progressScore - a.progressScore)
                            .slice(0, 5)
                            .map((member, index) => mapLeaderboardEntry(
                                member,
                                index,
                                `${Math.round(member.progressScore)} pts`,
                                member.progressLabel,
                                member.weightLabel
                            ));

                        const podium = volumeLeaderboard.slice(0, 3);

                        const bestLiftChampion = members.reduce((best, current) => {
                            if (!best || current.bestLiftWeight > best.bestLiftWeight) {
                                return current;
                            }
                            return best;
                        }, null);

                        const spotlight = bestLiftChampion && bestLiftChampion.bestLiftWeight > 0
                            ? {
                                name: bestLiftChampion.name,
                                metric: `${bestLiftChampion.bestLiftWeight.toFixed(0)} kg`,
                                description: bestLiftChampion.bestLiftName ? `Nuevo récord en ${bestLiftChampion.bestLiftName}` : 'Nuevo récord personal',
                                detail: bestLiftChampion.volumeTrendLabel,
                                streak: bestLiftChampion.streak
                            }
                            : null;

                        const highlights = [];
                        if (volumeLeaderboard[0]) {
                            highlights.push({
                                id: 'volume',
                                title: `${volumeLeaderboard[0].name} domina la carga`,
                                badge: 'Carga total',
                                metric: volumeLeaderboard[0].formattedValue,
                                detail: volumeLeaderboard[0].trendLabel
                            });
                        }
                        if (sessionsLeaderboard[0]) {
                            highlights.push({
                                id: 'sessions',
                                title: `${sessionsLeaderboard[0].name} lidera la constancia`,
                                badge: 'Días activos',
                                metric: sessionsLeaderboard[0].formattedValue,
                                detail: sessionsLeaderboard[0].trendLabel
                            });
                        }
                        if (progressLeaderboard[0]) {
                            highlights.push({
                                id: 'progress',
                                title: `${progressLeaderboard[0].name} es tendencia`,
                                badge: 'Progreso',
                                metric: progressLeaderboard[0].formattedValue,
                                detail: progressLeaderboard[0].subLabel
                            });
                        }

                        const feed = members
                            .filter(member => member.latestWorkout)
                            .sort((a, b) => b.latestWorkout.date - a.latestWorkout.date)
                            .slice(0, 6)
                            .map(member => ({
                                name: member.name,
                                initials: member.initials,
                                routineName: member.latestWorkout.routineName || 'Sesión libre',
                                completedAt: member.latestWorkout.date.toISOString(),
                                volume: member.latestWorkout.totalVolume,
                                duration: member.latestWorkout.totalDuration,
                                highlight: member.volumeTrendLabel
                            }));

                        const streakLeader = sessionsLeaderboard[0];
                        const progressLeader = progressLeaderboard[0];

                        const challenges = [
                            {
                                id: 'streak',
                                title: 'Reto 21 días sin excusas',
                                description: 'Encadena entrenamientos diarios sin romper la racha.',
                                progress: Math.min(100, streakLeader ? (streakLeader.streak / 21) * 100 : 0),
                                status: streakLeader ? `${streakLeader.name} lleva ${streakLeader.streak} días seguidos` : 'Aún no hay una racha destacada.',
                                icon: 'flame'
                            },
                            {
                                id: 'volume',
                                title: 'Power Team 50K',
                                description: 'Alcancen 50.000 kg totales registrados en el mes.',
                                progress: Math.min(100, stats.totalVolume > 0 ? (stats.totalVolume / 50_000) * 100 : 0),
                                status: `${this.formatNumberCompact(stats.totalVolume)} / 50k kg acumulados`,
                                icon: 'dumbbell'
                            },
                            {
                                id: 'progress',
                                title: 'Transformación del mes',
                                description: 'Reconoce a quien más evoluciona semana a semana.',
                                progress: Math.min(100, progressLeader ? progressLeader.progressScore : 0),
                                status: progressLeader ? `${progressLeader.name}: ${progressLeader.subLabel}` : 'Registra tus métricas para entrar al ranking.',
                                icon: 'sparkles'
                            }
                        ];

                        const leaderboards = { volume: volumeLeaderboard, sessions: sessionsLeaderboard, progress: progressLeaderboard };
                        let resolvedActive = previousActive;
                        if (!leaderboards[resolvedActive] || leaderboards[resolvedActive].length === 0) {
                            const fallback = Object.entries(leaderboards).find(([, list]) => list.length > 0);
                            resolvedActive = fallback ? fallback[0] : 'volume';
                        }

                        this.state.community = {
                            ...this.state.community,
                            stats,
                            leaderboards,
                            highlights,
                            feed,
                            challenges,
                            podium,
                            spotlight,
                            activeLeaderboard: resolvedActive,
                            lastUpdated: new Date().toISOString(),
                            isEmpty: members.length === 0
                        };
                        this.state.isCommunityLoading = false;
                        this.renderCommunitySection();

                        if (showSuccessToast) {
                            this.showToast('Ranking actualizado');
                        }
                    } catch (error) {
                        console.error('Error loading community data: ', error);
                        this.state.isCommunityLoading = false;
                        this.renderCommunitySection();
                        this.showToast('No se pudo cargar el ranking comunitario.', 'error');
                    }
                },

                switchCommunityLeaderboard(leaderboardId) {
                    if (!leaderboardId || !this.state?.community?.leaderboards) {
                        return;
                    }
                    if (!this.state.community.leaderboards[leaderboardId] || this.state.community.leaderboards[leaderboardId].length === 0) {
                        return;
                    }
                    this.state.community.activeLeaderboard = leaderboardId;
                    this.renderCommunitySection();
                },

                async refreshCommunityData() {
                    await this.loadCommunityData(true);
                },

                setupAuthListeners() {
                    onAuthStateChanged(this.auth, async (user) => {
                        if (user) {
                            this.state.currentUser = user;
                            await this.loadDataFromFirestore();
                            this.showAppUI();
                            await this.initAppLogic();
                        } else {
                            this.state = this.getDefaultState();
                            this.showAuthUI();
                        }
                    });

                    document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
                    document.getElementById('register-form').addEventListener('submit', (e) => this.handleRegister(e));
                    document.getElementById('logout-btn').addEventListener('click', () => this.handleLogout());
                    document.querySelectorAll('[data-action="toggle-auth"]').forEach(btn => {
                        btn.addEventListener('click', (event) => {
                            const target = event.currentTarget.dataset.authTarget || null;
                            this.toggleAuthForms(target);
                        });
                    });
                    this.setActiveAuthRole('admin');
                },

                async handleLogin(e) {
                    e.preventDefault();
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const button = e.target.querySelector('button[type="submit"]');
                    this.setButtonLoading(button, true);
                    this.showLaunchScreen();
                    try {
                        await signInWithEmailAndPassword(this.auth, email, password);
                    } catch (error) {
                        this.hideLaunchScreen();
                        this.showToast(this.getFirebaseAuthErrorMessage(error), 'error');
                    } finally {
                        this.setButtonLoading(button, false);
                    }
                },
                
                async handleRegister(e) {
                    e.preventDefault();
                    const name = document.getElementById('register-name').value;
                    const email = document.getElementById('register-email').value.toLowerCase();
                    const password = document.getElementById('register-password').value;
                    const selectedRole = document.getElementById('register-role')?.value || 'asesorado';
                    const button = e.target.querySelector('button[type=\"submit\"]');
                    this.setButtonLoading(button, true);
                    this.showLaunchScreen();

                    try {
                        if (selectedRole === 'admin') {
                            this.hideLaunchScreen();
                            this.showToast('El registro de administradores se gestiona internamente.', 'error');
                            throw new Error('Admin self-registration not allowed');
                        }

                        const invitationsRef = collection(this.db, "invitations");
                        let invitationDoc = null;

                        if (selectedRole === 'entrenador') {
                            const coachInvites = await getDocs(query(invitationsRef, where('role', '==', 'entrenador'), where('email', '==', email), where('status', '==', 'pending')));
                            if (!coachInvites.empty) {
                                invitationDoc = coachInvites.docs[0];
                            }
                        } else {
                            let clientInvites = await getDocs(query(invitationsRef, where('role', '==', 'asesorado'), where('email', '==', email), where('status', '==', 'pending')));
                            if (clientInvites.empty) {
                                clientInvites = await getDocs(query(invitationsRef, where('clientEmail', '==', email), where('status', '==', 'pending')));
                            }
                            if (!clientInvites.empty) {
                                invitationDoc = clientInvites.docs[0];
                            }
                        }

                        if (!invitationDoc) {
                            this.hideLaunchScreen();
                            this.showToast('Necesitas una invitación válida para registrarte.', 'error');
                            throw new Error('Missing invitation');
                        }

                        const invitationData = invitationDoc.data();
                        const role = invitationData.role || selectedRole;
                        const coachId = role === 'asesorado' ? (invitationData.coachId || null) : null;
                        const invitationDocId = invitationDoc.id;

                        const userCredential = await createUserWithEmailAndPassword(this.auth, email, password);
                        const user = userCredential.user;

                        const userRef = doc(this.db, "users", user.uid);
                        const initialData = this.getDefaultState();
                        initialData.userName = name;
                        initialData.role = role;
                        initialData.coachId = coachId;
                        initialData.targetWeight = initialData.physicalStats.weight;
                        initialData.email = email;
                        delete initialData.currentUser;
                        delete initialData.asesorados;
                        await setDoc(userRef, initialData);

                        const invitationRef = doc(this.db, "invitations", invitationDocId);
                        await updateDoc(invitationRef, { status: 'accepted', acceptedAt: new Date(), clientId: user.uid });

                        if (role === 'entrenador') {
                            this.showToast('Acceso de entrenador activado.', 'success');
                        } else {
                            this.showToast('¡Bienvenido! Has aceptado una invitación.', 'success');
                        }

                    } catch (error) {
                        this.hideLaunchScreen();
                        if (error.message !== 'Missing invitation' && error.message !== 'Admin self-registration not allowed') {
                            this.showToast(this.getFirebaseAuthErrorMessage(error), 'error');
                        }
                        console.error("Registration error:", error);
                    } finally {
                        this.setButtonLoading(button, false);
                    }
                },

                setActiveAuthRole(role) {
                    const normalizedRole = ['admin', 'entrenador', 'asesorado'].includes(role) ? role : 'asesorado';
                    const loginRoleInput = document.getElementById('login-role');
                    const registerRoleInput = document.getElementById('register-role');
                    if (loginRoleInput) loginRoleInput.value = normalizedRole;
                    if (registerRoleInput) registerRoleInput.value = normalizedRole;

                    const tabs = document.querySelectorAll('.auth-role-tab');
                    tabs.forEach(tab => {
                        const isActive = tab.dataset.roleTarget === normalizedRole;
                        if (isActive) {
                            tab.classList.add('bg-emerald-500/20', 'text-white');
                            tab.classList.remove('text-gray-300');
                        } else {
                            tab.classList.remove('bg-emerald-500/20', 'text-white');
                            tab.classList.add('text-gray-300');
                        }
                    });

                    const contentMap = {
                        admin: {
                            loginTitle: 'Panel Administrador',
                            loginSubtitle: 'Administra roles, librerías oficiales y activos globales.',
                            registerTitle: 'Acceso interno',
                            registerSubtitle: 'Solicita tu usuario al responsable principal de la plataforma.'
                        },
                        entrenador: {
                            loginTitle: 'Ingreso de entrenador',
                            loginSubtitle: 'Gestiona clientes, rutinas y planes diarios desde un mismo panel.',
                            registerTitle: 'Activa tu panel de entrenador',
                            registerSubtitle: 'Utiliza el enlace enviado por el administrador para completar tu registro.'
                        },
                        asesorado: {
                            loginTitle: 'Tu progreso personalizado',
                            loginSubtitle: 'Accede a tus rutinas, seguimiento y checklist diario.',
                            registerTitle: 'Conéctate con tu entrenador',
                            registerSubtitle: 'Ingresa con el enlace privado que recibiste para sincronizar tu plan.'
                        }
                    };

                    const copy = contentMap[normalizedRole] || contentMap.asesorado;
                    const loginTitleEl = document.getElementById('login-role-title');
                    const loginSubtitleEl = document.getElementById('login-role-subtitle');
                    const registerTitleEl = document.getElementById('register-role-title');
                    const registerSubtitleEl = document.getElementById('register-role-subtitle');

                    if (loginTitleEl) loginTitleEl.textContent = copy.loginTitle;
                    if (loginSubtitleEl) loginSubtitleEl.textContent = copy.loginSubtitle;
                    if (registerTitleEl) registerTitleEl.textContent = copy.registerTitle;
                    if (registerSubtitleEl) registerSubtitleEl.textContent = copy.registerSubtitle;
                },

                async handleLogout() { try { await signOut(this.auth); } catch (error) { this.showToast('Error al cerrar sesión.', 'error'); } },
                showAppUI() {
                    this.hideLaunchScreen();
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                },
                showAuthUI() {
                    this.hideLaunchScreen();
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('auth-container').classList.remove('hidden');
                    document.getElementById('sections-wrapper').innerHTML = '';
                    const loginContainer = document.getElementById('login-form-container');
                    const registerContainer = document.getElementById('register-form-container');
                    if (loginContainer && registerContainer) {
                        loginContainer.classList.add('form-visible');
                        loginContainer.classList.remove('form-hidden');
                        registerContainer.classList.add('form-hidden');
                        registerContainer.classList.remove('form-visible');
                    }
                    this.updateAuthTabState('login');
                },
                showLaunchScreen() {
                    const launch = document.getElementById('launch-screen');
                    const authContainer = document.getElementById('auth-container');
                    const appContainer = document.getElementById('app-container');
                    if (launch) {
                        launch.classList.remove('hidden');
                    }
                    if (authContainer) {
                        authContainer.classList.add('hidden');
                    }
                    if (appContainer) {
                        appContainer.classList.add('hidden');
                    }
                },
                hideLaunchScreen() {
                    const launch = document.getElementById('launch-screen');
                    if (launch) {
                        launch.classList.add('hidden');
                    }
                },
                toggleAuthForms(target) {
                    const loginContainer = document.getElementById('login-form-container');
                    const registerContainer = document.getElementById('register-form-container');

                    if (!loginContainer || !registerContainer) return;

                    const isLoginVisible = loginContainer.classList.contains('form-visible');
                    let showLogin;

                    if (target === 'login') {
                        showLogin = true;
                    } else if (target === 'register') {
                        showLogin = false;
                    } else {
                        showLogin = !isLoginVisible;
                    }

                    if (showLogin) {
                        loginContainer.classList.add('form-visible');
                        loginContainer.classList.remove('form-hidden');
                        registerContainer.classList.add('form-hidden');
                        registerContainer.classList.remove('form-visible');
                    } else {
                        loginContainer.classList.add('form-hidden');
                        loginContainer.classList.remove('form-visible');
                        registerContainer.classList.add('form-visible');
                        registerContainer.classList.remove('form-hidden');
                    }

                    this.updateAuthTabState(showLogin ? 'login' : 'register');
                },
                updateAuthTabState(activeTarget) {
                    document.querySelectorAll('[data-auth-target]').forEach(tab => {
                        const isActive = tab.dataset.authTarget === activeTarget;
                        tab.classList.toggle('bg-emerald-500/20', isActive);
                        tab.classList.toggle('text-white', isActive);
                        tab.classList.toggle('shadow-[0_12px_25px_-20px_rgba(16,185,129,0.65)]', isActive);
                        tab.classList.toggle('text-gray-300', !isActive);
                    });
                },
                setButtonLoading(button, isLoading) { if (isLoading) { button.disabled = true; button.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>`; lucide.createIcons(); } else { button.disabled = false; button.innerHTML = `<span>${button.closest('form').id === 'login-form' ? 'Iniciar Sesión' : 'Crear Cuenta'}</span>`; } },
                updateUserInfoUI() {
                    const name = this.state.userName || 'Usuario';
                    const welcome = document.getElementById('welcome-message');
                    if (welcome) {
                        welcome.textContent = `Hola, ${name.split(' ')[0]}`;
                    }
                    const avatarContainer = document.getElementById('user-avatar');
                    if (avatarContainer) {
                        this.applyProfilePhotoToAvatar(avatarContainer, { priority: 'high', loading: 'eager' });
                        if (!this.state.profilePhoto?.url) {
                            const span = avatarContainer.querySelector('span');
                            if (span) {
                                span.textContent = name.charAt(0).toUpperCase();
                            }
                        }
                    }
                    this.updateHeaderInsights();
                },
                applyProfilePhotoToAvatar(element, options = {}) {
                    if (!element) return;
                    const photoUrl = this.state?.profilePhoto?.url || '';
                    const span = element.querySelector('span');
                    const img = element.querySelector('img');
                    const initial = (this.state?.userName || 'U').charAt(0).toUpperCase();
                    const currentUrl = element.dataset.currentPhotoUrl || '';
                    const { priority = 'auto', loading = 'lazy' } = options;

                    if (photoUrl) {
                        if (currentUrl === photoUrl && element.classList.contains('has-photo')) {
                            return;
                        }

                        element.classList.add('loading-shimmer');
                        this.preloadImage(photoUrl, { priority }).then((success) => {
                            element.classList.remove('loading-shimmer');
                            if (success) {
                                element.dataset.currentPhotoUrl = photoUrl;
                                element.classList.add('has-photo');
                                element.style.backgroundImage = '';
                                if (img) {
                                    try {
                                        if ('fetchPriority' in img) {
                                            img.fetchPriority = priority;
                                        }
                                    } catch (error) {
                                        /* noop */
                                    }
                                    img.loading = loading;
                                    img.decoding = 'async';
                                    if (img.src !== photoUrl) {
                                        img.src = photoUrl;
                                    }
                                } else {
                                    element.style.backgroundImage = `url('${photoUrl}')`;
                                }
                                if (span) {
                                    span.textContent = '';
                                }
                            } else if (!currentUrl) {
                                element.dataset.currentPhotoUrl = '';
                                element.classList.remove('has-photo');
                                element.style.backgroundImage = '';
                                if (img) {
                                    img.removeAttribute('src');
                                }
                                if (span) {
                                    span.textContent = initial;
                                }
                            }
                        });
                    } else {
                        element.dataset.currentPhotoUrl = '';
                        element.classList.remove('loading-shimmer');
                        element.classList.remove('has-photo');
                        element.style.backgroundImage = '';
                        if (img) {
                            img.removeAttribute('src');
                        }
                        if (span) {
                            span.textContent = initial;
                        }
                    }
                },
                updateHeaderInsights() {
                    const metrics = this._getWeightProgressMetrics();
                    if (!metrics) {
                        return;
                    }
                    const setText = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.textContent = value;
                        }
                    };

                    const goalLabel = metrics.goalWeightLabel && metrics.goalWeightLabel !== '--'
                        ? `${metrics.goalWeightLabel} kg`
                        : '--';
                    setText('header-goal-label', goalLabel);
                    setText('header-direction-label', metrics.directionLabel || 'Objetivo activo');
                    setText('header-direction-description', metrics.directionDescription || 'Define tu foco actual');

                    const progressLabel = `${Math.max(0, Math.round(metrics.progressPercent || 0))}%`;
                    setText('header-progress-label', progressLabel);
                    const progressBar = document.getElementById('header-progress-bar');
                    if (progressBar) {
                        const width = Math.max(0, Math.min(metrics.progressPercent || 0, 110));
                        progressBar.style.width = `${width}%`;
                    }

                    const projection = metrics.projection || {};
                    setText('header-projection-summary', projection.summary || 'Añade registros para proyectar tu meta.');
                    setText('header-last-update', metrics.lastWeighInLabel || 'Registra tu peso para comenzar.');
                    setText('header-projection-pace', projection.paceText || 'Registra tu peso para ver el ritmo.');
                },
                updateNutritionAnalytics() {
                    const metrics = this._getWeightProgressMetrics();
                    if (!metrics) {
                        return;
                    }
                    const setText = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.textContent = value;
                        }
                    };

                    const currentWeightLabel = metrics.currentWeightLabel && metrics.currentWeightLabel !== '--'
                        ? `${metrics.currentWeightLabel} kg`
                        : '--';
                    setText('calc-current-weight', currentWeightLabel);
                    setText('calc-last-update', metrics.lastWeighInLabel || 'Registra tu primer dato');
                    const goalWeightLabel = metrics.goalWeightLabel && metrics.goalWeightLabel !== '--'
                        ? `${metrics.goalWeightLabel} kg`
                        : '--';
                    setText('calc-goal-weight', goalWeightLabel);

                    const goalDiffEl = document.getElementById('calc-goal-diff');
                    if (goalDiffEl) {
                        goalDiffEl.textContent = metrics.goalDiffText || 'Define tu objetivo';
                        goalDiffEl.className = `text-[11px] ${metrics.goalDiffClass || 'text-emerald-100/60'}`;
                    }

                    const diffEl = document.getElementById('calc-diff-label');
                    if (diffEl) {
                        diffEl.textContent = metrics.diffLabel || '--';
                        diffEl.className = `text-sm font-semibold ${metrics.diffToneClass || 'text-white'}`;
                    }

                    setText('calc-trend-label', metrics.directionLabel || '--');
                    setText('calc-direction-label', metrics.directionDescription || 'Añade registros para ver más detalles.');
                    const trendDescriptionEl = document.getElementById('calc-trend-description');
                    if (trendDescriptionEl) {
                        trendDescriptionEl.textContent = metrics.trendLabel || 'Añade tu primer registro para visualizar la tendencia.';
                        trendDescriptionEl.className = `text-[11px] ${metrics.trendClass || 'text-gray-400'}`;
                    }

                    const progressBar = document.getElementById('calc-progress-bar');
                    if (progressBar) {
                        const width = Math.max(0, Math.min(metrics.progressPercent || 0, 110));
                        progressBar.style.width = `${width}%`;
                    }
                    setText('calc-progress-label', `${Math.max(0, Math.round(metrics.progressPercent || 0))}%`);

                    const projection = metrics.projection || {};
                    const paceText = projection.paceText || 'Registra más datos para ver el ritmo.';
                    setText('calc-projection-pace', paceText);
                    setText('calc-projection-pace-detail', paceText);
                    setText('calc-projection-summary', projection.summary || 'Añade registros de peso para proyectar tu fecha objetivo.');
                    setText('calc-projection-helper', projection.helperText || 'Define tu objetivo de peso.');
                    setText('calc-projection-date', projection.dateLabel || '--');
                    setText('calc-projection-weeks', projection.weeksLabel || '--');

                    const badge = document.getElementById('calc-projection-badge');
                    if (badge) {
                        const base = 'inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.3em]';
                        badge.className = `${base} ${projection.badgeClasses || 'border-white/10 bg-white/5 text-gray-300'}`;
                        badge.textContent = projection.badgeText || 'Sin datos';
                    }
                },
                updateMacroVisuals(results = {}) {
                    const calories = Number(results.calories) || 0;
                    const protein = Number(results.protein) || 0;
                    const carbs = Number(results.carbs) || 0;
                    const fats = Number(results.fats) || 0;
                    const macroCalories = {
                        protein: protein * 4,
                        carbs: carbs * 4,
                        fats: fats * 9
                    };
                    const total = macroCalories.protein + macroCalories.carbs + macroCalories.fats;
                    const getPercent = (value) => {
                        if (!total) return 0;
                        return Math.round((value / total) * 100);
                    };
                    const proteinPct = getPercent(macroCalories.protein);
                    const carbPct = getPercent(macroCalories.carbs);
                    const fatPct = Math.max(0, 100 - proteinPct - carbPct);

                    const setPercent = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.textContent = `${Math.max(0, value)}%`;
                        }
                    };
                    setPercent('macro-protein-percentage', proteinPct);
                    setPercent('macro-carbs-percentage', carbPct);
                    setPercent('macro-fats-percentage', fatPct);

                    const setBar = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) {
                            const width = Math.max(0, Math.min(value, 100));
                            el.style.width = `${width}%`;
                        }
                    };
                    setBar('macro-protein-bar', proteinPct);
                    setBar('macro-carbs-bar', carbPct);
                    setBar('macro-fats-bar', fatPct);

                    const energyTotal = document.getElementById('macro-energy-total');
                    if (energyTotal) {
                        energyTotal.textContent = calories ? calories.toString() : '0';
                    }

                    const pie = document.getElementById('macro-pie');
                    if (pie) {
                        const proteinStop = Math.max(0, Math.min(proteinPct, 100));
                        const carbStop = Math.max(proteinStop, Math.min(proteinStop + carbPct, 100));
                        pie.style.background = `conic-gradient(#38bdf8 0 ${proteinStop}%, #facc15 ${proteinStop}% ${carbStop}%, #f472b6 ${carbStop}% 100%)`;
                    }
                },
                updateNutritionResultsUI(results) {
                    const target = results || this._tempResults || this.state.userGoals || {};
                    const container = document.getElementById('nutrition-results');
                    if (!container) {
                        return;
                    }
                    const hasData = target && Number(target.calories);
                    const setText = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.textContent = value;
                        }
                    };

                    if (!hasData) {
                        container.classList.add('hidden');
                        setText('result-calories', '0 kcal');
                        setText('result-protein', '--');
                        setText('result-carbs', '--');
                        setText('result-fats', '--');
                        this.updateMacroVisuals();
                        return;
                    }

                    setText('result-calories', `${target.calories} kcal`);
                    setText('result-protein', `${target.protein}g`);
                    setText('result-carbs', `${target.carbs}g`);
                    setText('result-fats', `${target.fats}g`);
                    this.updateMacroVisuals(target);
                    container.classList.remove('hidden');
                },
                preloadImage(url, options = {}) {
                    if (!url) return Promise.resolve(false);
                    if (!this._imagePreloadCache) {
                        this._imagePreloadCache = new Map();
                    }
                    if (this._imagePreloadCache.has(url)) {
                        return this._imagePreloadCache.get(url);
                    }

                    const { priority = 'auto' } = options;
                    const loadPromise = new Promise((resolve) => {
                        const img = new Image();
                        try {
                            if (priority && 'fetchPriority' in img) {
                                img.fetchPriority = priority;
                            }
                        } catch (error) {
                            /* fetchPriority no soportado, continuar sin prioridad */
                        }
                        img.decoding = 'async';
                        img.onload = () => resolve(true);
                        img.onerror = () => resolve(false);
                        img.src = url;
                    }).then((success) => {
                        if (!success && this._imagePreloadCache) {
                            this._imagePreloadCache.delete(url);
                        }
                        return success;
                    });

                    this._imagePreloadCache.set(url, loadPromise);
                    return loadPromise;
                },
                preloadExerciseGroupImages(activeGroup = '') {
                    const entries = Object.entries(this.data.exerciseGroupImages || {});
                    entries.forEach(([groupName, imageUrl]) => {
                        if (!imageUrl) return;
                        const priority = groupName === activeGroup ? 'high' : 'auto';
                        this.preloadImage(imageUrl, { priority });
                    });
                },
                initializeGroupCardImageLoading(root = document) {
                    const scope = root instanceof Element ? root : document;
                    const images = scope.querySelectorAll('.routine-group-image');
                    images.forEach((img) => {
                        if (img.dataset.imageLoaderBound === 'true') return;
                        img.dataset.imageLoaderBound = 'true';
                        const wrapper = img.closest('.group-image-shell');
                        const skeleton = wrapper?.querySelector('.image-loading-placeholder');
                        const fallback = wrapper?.querySelector('.image-fallback');

                        const hideSkeleton = () => {
                            if (skeleton) {
                                skeleton.classList.add('is-hidden');
                                setTimeout(() => skeleton?.remove(), 350);
                            }
                        };

                        const showFallback = () => {
                            if (fallback) {
                                fallback.classList.remove('hidden');
                                if (!fallback.classList.contains('flex')) {
                                    fallback.classList.add('flex');
                                }
                            }
                            hideSkeleton();
                            if (img.parentElement) {
                                img.remove();
                            }
                        };

                        const revealImage = () => {
                            hideSkeleton();
                            if (fallback) {
                                fallback.classList.add('hidden');
                                fallback.classList.remove('flex');
                            }
                            requestAnimationFrame(() => {
                                img.classList.remove('opacity-0');
                                img.classList.add('opacity-100');
                            });
                        };

                        if (img.complete && img.naturalWidth > 0) {
                            revealImage();
                            return;
                        }

                        this.preloadImage(img.src, { priority: img.getAttribute('fetchpriority') || 'auto' });
                        img.addEventListener('load', revealImage, { once: true });
                        img.addEventListener('error', showFallback, { once: true });
                    });
                },
                triggerProfilePhotoUpload() {
                    const input = document.getElementById('profile-photo-input');
                    if (input) {
                        input.click();
                    }
                },
                async handleProfilePhotoSelected(file) {
                    if (!file) return;
                    const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
                    if (!validTypes.includes(file.type)) {
                        this.showToast('Selecciona una imagen JPG o PNG.', 'error');
                        return;
                    }
                    const maxSize = 2 * 1024 * 1024;
                    if (file.size > maxSize) {
                        this.showToast('La imagen debe pesar menos de 2MB.', 'error');
                        return;
                    }
                    try {
                        const previousPath = this.state.profilePhoto?.storagePath || '';
                        const uploadResult = await this.uploadImageToStorage(file, { pathPrefix: 'profile_photos', previousPath });
                        if (!uploadResult.url) {
                            this.showToast('No se pudo subir la foto de perfil.', 'error');
                            return;
                        }
                        this.state.profilePhoto = { url: uploadResult.url, storagePath: uploadResult.storagePath, updatedAt: new Date().toISOString() };
                        this.preloadImage(this.state.profilePhoto.url, { priority: 'high' });
                        await this.saveDataToFirestore();
                        this.renderProfileSection();
                        this.updateUserInfoUI();
                        lucide.createIcons();
                        this.showToast('Foto de perfil actualizada.', 'success');
                    } catch (error) {
                        console.error('Error uploading profile photo:', error);
                        this.showToast('No se pudo subir la foto de perfil.', 'error');
                    }
                },
                getFirebaseAuthErrorMessage(error) { switch (error.code) { case 'auth/invalid-email': return 'Email no válido.'; case 'auth/user-not-found': return 'Usuario no encontrado.'; case 'auth/wrong-password': return 'Contraseña incorrecta.'; case 'auth/email-already-in-use': return 'Este email ya está registrado.'; case 'auth/weak-password': return 'La contraseña debe tener al menos 6 caracteres.'; case 'auth/invalid-credential': return 'Credenciales inválidas.'; default: return error.message || 'Ha ocurrido un error. Inténtalo de nuevo.'; } },
                loadTemplates() { const wrapper = document.getElementById('sections-wrapper'); if(wrapper.children.length > 0) return; const templates = document.querySelectorAll('template'); templates.forEach(template => { const content = template.content.cloneNode(true); wrapper.appendChild(content); }); },
                
                setupEventListeners() {
                    document.body.addEventListener('click', (e) => {
                        const button = e.target.closest('[data-action]');
                        const calcTabBtn = e.target.closest('.calc-tab-btn');
                        
                        if(calcTabBtn){
                            this.switchCalculatorTab(calcTabBtn.dataset.tab);
                            return;
                        }
                        
                        if (!button) { 
                            const navBtn = e.target.closest('.nav-btn'); 
                            if (navBtn) this.showSection(navBtn.dataset.section); 
                            return; 
                        }
                        
                        const { action, sectionId, foodId, mealName, itemIndex, routineId, dayIndex, exerciseName, exerciseIndex, group, subgroup, mediaUrl, groupTarget, clientId, mealIndex, historyDate, leaderboard, storagePath, inviteId, inviteLink } = button.dataset;
                        if (action === 'trigger-profile-photo-upload') {
                            this.triggerProfilePhotoUpload();
                            return;
                        }
                        if (action === 'refresh-roles') {
                            this.renderRolesSection();
                            return;
                        }
                        if (action === 'toggle-role') {
                            const targetRole = button.dataset.roleTarget || 'asesorado';
                            this.setActiveAuthRole(targetRole);
                            return;
                        }
                        if (action === 'copy-invite-link') {
                            if (inviteLink) {
                                navigator.clipboard?.writeText(inviteLink).then(() => {
                                    this.showToast('Enlace copiado al portapapeles.');
                                }).catch(() => {
                                    this.showToast('No se pudo copiar el enlace.', 'error');
                                });
                            }
                            return;
                        }
                        if (action === 'revoke-invite') {
                            if (inviteId) {
                                this.revokeInvitation(inviteId);
                            }
                            return;
                        }
                        const actionMap = {
                            'show-section': () => this.showSection(sectionId), 'open-cover-upload': () => this.triggerCoverUpload(), 'remove-cover-image': () => this.removeCoverImage(), 'open-routine-banner-upload': () => this.triggerRoutineBannerUpload(), 'remove-routine-banner-image': () => this.removeRoutineBannerImage(), 'handle-workout-action': () => this.handleWorkoutAction(), 'confirm-cancel-workout': () => this.confirmCancelWorkout(), 'abort-workout': () => this.finishWorkout(false), 'exit-without-saving': () => this.finishWorkout(false), 'exit-and-save': () => this.finishWorkout(true), 'start-workout': () => this.startWorkout(routineId, parseInt(dayIndex)), 'skip-rest': () => this.skipRest(), 'add-rest-time': () => this.addRestTime(), 'save-goals': () => this.saveNutritionGoals(), 'calculate-body-metrics': () => this.calculateBodyMetrics(), 'show-add-food-modal': () => this.showAddFoodModal(foodId), 'add-food-to-meal': () => this.addFoodToMealFromModal(foodId, parseInt(mealIndex)), 'confirm-remove-food': () => this.confirmRemoveFoodFromMeal(parseInt(mealIndex), parseInt(itemIndex)), 'remove-food': () => this.removeFoodFromMeal(parseInt(mealIndex), parseInt(itemIndex)), 'generate-plan': () => this.generatePlanWithAI(), 'analyze-food': () => this.analyzeFoodWithAI(), 'get-recipe': () => this.getRecipeForMeal(parseInt(mealIndex)), 'show-exercise-info': () => this.showExerciseInfoModal(exerciseName), 'hide-modal': () => this.hideModal(), 'show-workout-history': () => this.openWorkoutHistoryModal(historyDate), 'routine-create': () => this.routine_enterCreator(), 'routine-show-details': () => this.routine_showDetails(routineId), 'routine-close-view': () => this.routine_closeFullscreenView(), 'routine-creator-next': () => this.routine_handleCreatorNext(), 'routine-creator-add-exercise': () => this.routine_showAddExerciseDrawer(), 'routine-creator-close-drawer': () => this.routine_closeAddExerciseDrawer(), 'routine-creator-select-exercise': () => this.routine_selectExercise(exerciseName), 'routine-creator-save-exercise-details': () => this.routine_saveExerciseDetails(parseInt(exerciseIndex)), 'routine-creator-edit-exercise': (e) => this.routine_editExercise(e.target.closest('[data-exercise-index]').dataset.exerciseIndex), 'routine-creator-remove-exercise': () => this.routine_removeExercise(parseInt(exerciseIndex)), 'routine-creator-save': () => this.routine_save(), 'routine-confirm-delete': () => this.routine_confirmDelete(routineId), 'routine-delete': () => this.routine_delete(routineId), 'routine-creator-suggest-ai': () => this.routine_showAiSuggestionModal(), 'generate-exercises-ai': () => this.routine_generateExercisesWithAi(), 'analyze-workout-performance': (e) => this.analyzeWorkoutPerformance(e), 'edit-profile': () => this.showEditProfileModal(), 'save-profile-changes': () => this.handleUpdateProfile(), 'edit-target-weight': () => this.showEditTargetWeightModal(), 'save-target-weight': () => this.handleUpdateTargetWeight(), 'add-weight-log': () => this.handleAddWeightLog(), 'admin-edit-exercise': () => this.admin_showEditExerciseModal(group, subgroup, exerciseIndex), 'admin-confirm-delete-exercise': () => this.admin_confirmDeleteExercise(group, subgroup, exerciseIndex), 'admin-delete-exercise': () => this.admin_deleteExercise(group, subgroup, exerciseIndex), 'admin-save-exercise': () => this.admin_saveExerciseChanges(group, subgroup, exerciseIndex), 'admin-edit-media': () => this.admin_showEditMediaModal(group, subgroup, exerciseIndex), 'admin-upload-media': () => this.admin_uploadAndSaveMedia(group, subgroup, exerciseIndex), 'routine-creator-switch-day': () => this.routine_switchDay(parseInt(dayIndex)), 'routine-creator-add-day': () => this.routine_addDay(), 'routine-creator-rename-day': () => this.routine_showRenameDayModal(parseInt(dayIndex)), 'routine-creator-confirm-delete-day': () => this.routine_confirmDeleteDay(parseInt(dayIndex)), 'routine-creator-delete-day': () => this.routine_deleteDay(parseInt(dayIndex)), 'routine-creator-back-to-groups': () => this.routine_creator_showGroupList(), 'routine-open-edit-modal': () => this.routine_openExerciseEditModal(parseInt(exerciseIndex)), 'routine-close-edit-modal': () => this.routine_closeExerciseEditModal(), 'routine-save-exercise-modal': () => this.routine_saveExerciseFromModal(), 'routine-open-timeline': () => this.routine_openTimelineView(), 'routine-toggle-mini-window': () => this.routine_toggleMiniWindow(), 'routine-close-timeline': () => this.routine_closeTimelineView(), 'routine-timeline-save': () => this.routine_handleTimelineSave(), 'routine-timeline-confirm-link': () => this.routine_handleTimelineLink(), 'routine-timeline-confirm-start': () => this.routine_handleTimelineStart(),
                            'show-media-viewer': () => this.showMediaViewer(mediaUrl),
                            'routine-creator-switch-group': () => this.routine_creator_switchGroup(groupTarget),
                            'routine-creator-edit-group-image': (evt) => { evt.stopPropagation(); this.routine_creator_showGroupImageModal(groupTarget); },
                            'routine-creator-upload-group-image': () => this.routine_creator_uploadGroupImage(groupTarget),
                            'manage-client': () => this.showClientManager(clientId),
                            'edit-client-routine': () => this.editClientRoutine(clientId),
                            'assign-routine-to-client': () => this.assignRoutineToClient(clientId),
                            'edit-client-diet': () => this.editClientDiet(clientId),
                            'save-client-diet': () => this.saveClientDiet(clientId),
                            'toggle-food-completion': () => this.toggleFoodCompletion(parseInt(mealIndex), parseInt(itemIndex)),
                            'client-diet-add-meal': () => this._addMealToClientDietTemp(),
                            'client-diet-remove-meal': () => this._removeMealFromClientDietTemp(parseInt(mealIndex)),
                            'client-diet-add-food-modal': () => this._showAddFoodToClientModal(foodId),
                            'client-diet-add-food-to-meal': () => this._addFoodToClientDietTemp(foodId, parseInt(mealIndex)),
                            'client-diet-remove-food': () => this._handleRemoveFoodFromClientDiet(parseInt(mealIndex), parseInt(itemIndex)),
                            'client-diet-show-calculator': () => this._showClientCalculatorModal(clientId),
                            'client-diet-create-food-modal': () => this._showCreateFoodModal(),
                            'client-diet-save-custom-food': () => this._saveCustomFood(),
                            'client-diet-edit-food-modal': () => this._showEditFoodModal(foodId),
                            'client-diet-update-food': () => this._updateFood(),
                            'client-diet-remove-food-image': () => this._handleRemoveFoodImageFromForm(button),
                            'confirm-delete-custom-food': () => this._confirmDeleteCustomFood(foodId),
                            'delete-custom-food': () => this._deleteCustomFood(foodId, storagePath),
                            'confirm-delete-predefined-food': () => this._confirmDeletePredefinedFood(foodId),
                            'delete-predefined-food': () => this._deletePredefinedFood(foodId, storagePath),
                            'community-switch-leaderboard': () => this.switchCommunityLeaderboard(leaderboard),
                            'community-refresh': () => this.refreshCommunityData(),
                        };
                        
                        // Prevenir que el checkbox dispare el evento del label padre
                        if (action === 'toggle-food-completion') {
                           e.stopPropagation(); 
                        }

                        if (actionMap[action]) {
                            actionMap[action](e);
                        }
                    });
                    document.body.addEventListener('submit', (e) => {
                        e.preventDefault();
                        if (e.target.id === 'nutrition-form') { this.calculateNutrition(); }
                        if (e.target.id === 'weight-log-form') { this.handleAddWeightLog(); }
                        if (e.target.id === '1rm-form') { this.calculate1RM(); }
                        if (e.target.id === 'invite-form') { this.handleInviteClient(e); }
                        if (e.target.id === 'roles-invite-form') { this.handleRoleInvitation(e); }
                        if (e.target.id === 'diet-create-food-form') { this._handleInlineFoodCreate(); }
                    });
                    document.body.addEventListener('input', (e) => { if (e.target.id === 'food-search') { this.renderFoodList(e.target.value); } if (e.target.id === 'exercise-search-input') { this.routine_filterExerciseLibrary(e.target.value); } if (e.target.id === 'client-food-search') { this.renderFoodList(e.target.value, 'client-food-list'); } if (e.target.closest('#client-diet-editor')) { const mealIndex = e.target.dataset.mealIndex; if (mealIndex) { this._updateMealDataFromUI(parseInt(mealIndex)); } } });
                    document.body.addEventListener('change', (e) => {
                        if (e.target.id === 'profile-photo-input') {
                            const file = e.target.files && e.target.files[0];
                            this.handleProfilePhotoSelected(file);
                            e.target.value = '';
                            return;
                        }
                        if (e.target.id === 'dashboard-cover-input') {
                            this.handleCoverFileChange(e.target);
                            return;
                        }
                        if (e.target.id === 'routine-banner-input') {
                            this.handleRoutineBannerFileChange(e.target);
                            return;
                        }
                        if (e.target.dataset.panelCoverInput) {
                            this.handleDietPanelCoverSelected(e.target);
                            return;
                        }
                        if (e.target.closest('#client-diet-goals-form')) {
                            this._handleUpdateClientGoalsFromUI();
                        }
                    });

                    const sidebar = document.getElementById('app-sidebar');
                    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                    const mobileBackdrop = document.getElementById('mobile-menu-backdrop');

                    if (mobileMenuToggle) {
                        mobileMenuToggle.addEventListener('click', () => this.toggleMobileMenu());
                    }
                    if (mobileBackdrop) {
                        mobileBackdrop.addEventListener('click', () => this.closeMobileMenu(true));
                    }
                    document.addEventListener('keydown', (event) => {
                        if (event.key === 'Escape' && this.state?.isMobileMenuOpen) {
                            this.closeMobileMenu(true);
                        }
                    });

                    if(sidebar){
                        const setSidebarStateForViewport = () => {
                            if(window.innerWidth >= 1024){
                                sidebar.setAttribute('data-collapsed','true');
                                this.closeMobileMenu(true, true);
                            } else {
                                sidebar.setAttribute('data-collapsed','false');
                                if (!this.state.isMobileMenuOpen) {
                                    sidebar.setAttribute('data-mobile-open','false');
                                    sidebar.classList.remove('mobile-overlay');
                                    if (mobileBackdrop) {
                                        mobileBackdrop.classList.remove('is-visible');
                                    }
                                    document.body.classList.remove('mobile-menu-open');
                                }
                            }
                        };
                        const expandSidebar = () => {
                            if(window.innerWidth >= 1024){
                                sidebar.setAttribute('data-collapsed','false');
                            }
                        };
                        const collapseSidebar = () => {
                            if(window.innerWidth >= 1024){
                                sidebar.setAttribute('data-collapsed','true');
                            }
                        };

                        setSidebarStateForViewport();

                        sidebar.addEventListener('mouseenter', expandSidebar);
                        sidebar.addEventListener('mouseleave', collapseSidebar);
                        sidebar.addEventListener('focusin', expandSidebar);
                        sidebar.addEventListener('focusout', () => {
                            if(window.innerWidth >= 1024){
                                requestAnimationFrame(() => {
                                    if(!sidebar.contains(document.activeElement)){
                                        sidebar.setAttribute('data-collapsed','true');
                                    }
                                });
                            }
                        });

                        window.addEventListener('resize', setSidebarStateForViewport);
                    }
                },

                toggleMobileMenu() {
                    if (window.innerWidth >= 1024) { return; }
                    if (this.state?.isMobileMenuOpen) {
                        this.closeMobileMenu(true);
                    } else {
                        this.openMobileMenu();
                    }
                },

                openMobileMenu() {
                    if (window.innerWidth >= 1024) { return; }
                    const sidebar = document.getElementById('app-sidebar');
                    const backdrop = document.getElementById('mobile-menu-backdrop');
                    const toggleBtn = document.getElementById('mobile-menu-toggle');
                    if (!sidebar) { return; }

                    this.state.isMobileMenuOpen = true;
                    sidebar.classList.add('mobile-overlay');
                    requestAnimationFrame(() => {
                        sidebar.setAttribute('data-mobile-open', 'true');
                    });
                    if (backdrop) {
                        backdrop.classList.add('is-visible');
                    }
                    document.body.classList.add('mobile-menu-open');
                    if (toggleBtn) {
                        toggleBtn.setAttribute('aria-expanded', 'true');
                    }
                },

                closeMobileMenu(force = false, immediate = false) {
                    if (!force && window.innerWidth >= 1024) { return; }
                    const sidebar = document.getElementById('app-sidebar');
                    const backdrop = document.getElementById('mobile-menu-backdrop');
                    const toggleBtn = document.getElementById('mobile-menu-toggle');

                    if (this.state) {
                        this.state.isMobileMenuOpen = false;
                    }

                    if (sidebar) {
                        sidebar.setAttribute('data-mobile-open', 'false');
                    }

                    if (backdrop) {
                        backdrop.classList.remove('is-visible');
                    }

                    document.body.classList.remove('mobile-menu-open');

                    if (toggleBtn) {
                        toggleBtn.setAttribute('aria-expanded', 'false');
                    }

                    if (sidebar && sidebar.classList.contains('mobile-overlay')) {
                        const cleanup = () => {
                            if (!this.state.isMobileMenuOpen && window.innerWidth < 1024) {
                                sidebar.classList.remove('mobile-overlay');
                            }
                        };
                        if (immediate) {
                            cleanup();
                        } else {
                            setTimeout(cleanup, 300);
                        }
                    }
                },

                renderAll() {
                    this.renderRoutinesSection();
                    this.renderDietPage();
                    this.renderWeeklyProgress();
                    this.renderWorkoutHistorySection();
                    this.renderProfileSection();
                    this.renderNutricionSection();
                    this.renderCommunitySection();
                    if (this.isAdmin()) {
                        this.renderRolesSection();
                    } else if (this.isAsesor()) {
                        this.renderAsesoradosSection();
                    }
                    this.updateCoverPreview();
                    this.updateDashboard();
                    this.updateHeaderInsights();
                    lucide.createIcons();
                },
                showSection(id, animate=true){
                    this.state.currentSection=id;
                    document.querySelectorAll('.section-content').forEach(s=>s.classList.add('hidden'));
                    const el=document.getElementById(id);
                    if(el){
                        el.classList.remove('hidden');
                        if(animate){
                            el.classList.add('section-fade-in');
                            el.addEventListener('animationend',()=>el.classList.remove('section-fade-in'),{once:true});
                        }
                    }
                    document.querySelectorAll('.nav-btn').forEach(b=>{
                        const isActive=b.dataset.section===id;
                        b.classList.toggle('is-active',isActive);
                    });
                    if(window.innerWidth < 1024){
                        this.closeMobileMenu(true);
                    }
                    if(id==='dieta'){this.renderFoodList();}
                    if(id==='comunidad'){this.animateCommunityCounters();}
                },
                
                async renderAsesoradosSection() {
                    const listContainer = document.getElementById('asesorados-list');
                    if (!listContainer) return;
                    await this.fetchAsesorados();
                    if (this.state.asesorados.length > 0) {
                        listContainer.innerHTML = this.state.asesorados.map(client => `
                            <button data-action="manage-client" data-client-id="${client.id}" class="w-full bg-gray-700 rounded-2xl p-4 flex items-center space-x-4 text-left hover:bg-gray-600/80 transition-colors">
                                <div class="w-10 h-10 rounded-full bg-emerald-500/50 flex items-center justify-center font-bold text-white flex-shrink-0">${client.userName.charAt(0).toUpperCase()}</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white">${client.userName}</h4>
                                    <p class="text-sm text-gray-400">${client.email}</p>
                                </div>
                                <i data-lucide="chevron-right" class="text-gray-500"></i>
                            </button>
                        `).join('');
                    } else {
                        listContainer.innerHTML = `<p class="text-gray-500 text-center p-4">Aún no tienes clientes. ¡Invita a alguien!</p>`;
                    }
                    lucide.createIcons();
                },

                async renderRolesSection() {
                    if (!this.isAdmin()) {
                        return;
                    }

                    const trainersList = document.getElementById('roles-trainers-list');
                    const invitationsList = document.getElementById('roles-invitations-list');
                    const coachCountEl = document.getElementById('roles-coach-count');
                    const inviteCountEl = document.getElementById('roles-invite-count');
                    const syncLabel = document.getElementById('roles-coach-sync-label');

                    if (!trainersList || !invitationsList) {
                        return;
                    }

                    if (!this.db) {
                        trainersList.innerHTML = '<p class="rounded-2xl border border-white/5 bg-gray-900/60 p-4 text-sm text-gray-400">No se pudo conectar a la base de datos.</p>';
                        return;
                    }

                    if (syncLabel) {
                        syncLabel.textContent = 'Sincronizando...';
                        syncLabel.classList.add('text-emerald-200');
                    }

                    try {
                        const usersRef = collection(this.db, 'users');
                        const invitesRef = collection(this.db, 'invitations');
                        const [trainersSnapshot, invitationsSnapshot] = await Promise.all([
                            getDocs(query(usersRef, where('role', '==', 'entrenador'))),
                            getDocs(query(invitesRef, where('role', '==', 'entrenador'), where('status', '==', 'pending')))
                        ]);

                        const trainers = trainersSnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                        const invites = invitationsSnapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

                        this.state.managedRoles = {
                            trainers,
                            invitations: invites
                        };

                        if (coachCountEl) {
                            coachCountEl.textContent = trainers.length.toString();
                        }
                        if (inviteCountEl) {
                            inviteCountEl.textContent = invites.length.toString();
                        }
                        if (syncLabel) {
                            syncLabel.textContent = 'Actualizado';
                            syncLabel.classList.remove('text-emerald-200', 'text-rose-300');
                        }

                        if (trainers.length === 0) {
                            trainersList.innerHTML = '<p class="rounded-2xl border border-white/5 bg-gray-900/60 p-4 text-sm text-gray-400">No hay entrenadores registrados aún.</p>';
                        } else {
                            trainersList.innerHTML = trainers.map(trainer => {
                                const name = trainer.userName || 'Entrenador';
                                const email = trainer.email || trainer.contactEmail || 'Sin email';
                                const joined = trainer.createdAt?.toDate?.() || trainer.createdAt?.seconds ? new Date(trainer.createdAt.seconds * 1000) : (trainer.createdAt ? new Date(trainer.createdAt) : null);
                                const joinedLabel = joined && !Number.isNaN(joined.getTime()) ? joined.toLocaleDateString('es-ES') : 'Registro inicial';
                                const clients = Array.isArray(trainer.asesorados) ? trainer.asesorados.length : (trainer.clientsCount || 0);
                                return `
                                    <article class="rounded-2xl border border-white/10 bg-white/5 p-4 shadow-inner shadow-emerald-500/10">
                                        <header class="flex items-start justify-between gap-3">
                                            <div>
                                                <h4 class="text-lg font-semibold text-white">${name}</h4>
                                                <p class="text-sm text-gray-400">${email}</p>
                                            </div>
                                            <span class="rounded-full border border-emerald-400/30 bg-emerald-500/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200">Entrenador</span>
                                        </header>
                                        <div class="mt-4 grid gap-3 sm:grid-cols-3 text-sm text-gray-300">
                                            <div class="rounded-2xl border border-white/10 bg-gray-900/60 p-3 text-center">
                                                <p class="text-[11px] uppercase tracking-[0.28em] text-gray-400">Asesorados</p>
                                                <p class="text-xl font-semibold text-white">${clients}</p>
                                            </div>
                                            <div class="rounded-2xl border border-white/10 bg-gray-900/60 p-3 text-center">
                                                <p class="text-[11px] uppercase tracking-[0.28em] text-gray-400">Actividad</p>
                                                <p class="text-sm font-semibold text-emerald-200">${trainer.lastLogin ? 'Reciente' : 'Sin registro'}</p>
                                            </div>
                                            <div class="rounded-2xl border border-white/10 bg-gray-900/60 p-3 text-center">
                                                <p class="text-[11px] uppercase tracking-[0.28em] text-gray-400">Alta</p>
                                                <p class="text-sm font-semibold text-white">${joinedLabel}</p>
                                            </div>
                                        </div>
                                    </article>
                                `;
                            }).join('');
                        }

                        if (invites.length === 0) {
                            invitationsList.innerHTML = '<p class="rounded-2xl border border-emerald-400/20 bg-gray-900/60 p-4 text-sm text-emerald-100/80">Sin invitaciones activas.</p>';
                        } else {
                            const baseUrl = window.location.origin;
                            invitationsList.innerHTML = invites.map(invite => {
                                const email = invite.email || invite.clientEmail || 'Sin email';
                                const note = invite.note || 'Sin nota adicional';
                                const sentDate = invite.sentAt?.toDate?.() || invite.sentAt?.seconds ? new Date(invite.sentAt.seconds * 1000) : (invite.sentAt ? new Date(invite.sentAt) : null);
                                const sentLabel = sentDate && !Number.isNaN(sentDate.getTime()) ? sentDate.toLocaleDateString('es-ES') : 'Pendiente';
                                const inviteUrl = `${baseUrl}?invite=${invite.id}`;
                                return `
                                    <article class="rounded-2xl border border-emerald-400/30 bg-gray-900/70 p-4">
                                        <div class="flex flex-col gap-2">
                                            <div class="flex items-center justify-between gap-3">
                                                <div>
                                                    <p class="text-sm font-semibold text-white">${email}</p>
                                                    <p class="text-xs text-emerald-100/80">Enviada el ${sentLabel}</p>
                                                </div>
                                                <button data-action="revoke-invite" data-invite-id="${invite.id}" class="inline-flex items-center gap-2 rounded-full border border-rose-400/30 bg-rose-500/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-rose-200 hover:border-rose-300 hover:text-rose-100">
                                                    <i data-lucide="x-circle" class="h-4 w-4"></i>
                                                    Revocar
                                                </button>
                                            </div>
                                            <p class="text-xs text-gray-300">${note}</p>
                                            <div class="flex flex-col gap-2 rounded-xl border border-emerald-400/20 bg-emerald-500/5 p-3">
                                                <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200">Enlace de invitación</p>
                                                <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                                    <code class="flex-1 truncate rounded-lg bg-gray-900/70 px-3 py-2 text-xs text-emerald-100/90">${inviteUrl}</code>
                                                    <button data-action="copy-invite-link" data-invite-link="${inviteUrl}" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-500/10 px-3 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200 hover:border-emerald-300 hover:text-emerald-100">
                                                        <i data-lucide="copy" class="h-4 w-4"></i>
                                                        Copiar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </article>
                                `;
                            }).join('');
                        }

                        lucide.createIcons();
                    } catch (error) {
                        console.error('Error rendering roles section:', error);
                        this.showToast('No se pudieron obtener los roles.', 'error');
                        trainersList.innerHTML = '<p class="rounded-2xl border border-white/5 bg-gray-900/60 p-4 text-sm text-gray-400">Intenta actualizar nuevamente.</p>';
                        if (invitationsList) {
                            invitationsList.innerHTML = '<p class="rounded-2xl border border-emerald-400/20 bg-gray-900/60 p-4 text-sm text-emerald-100/80">No se pudieron cargar las invitaciones.</p>';
                        }
                        if (syncLabel) {
                            syncLabel.textContent = 'Error';
                            syncLabel.classList.remove('text-emerald-200');
                            syncLabel.classList.add('text-rose-300');
                        }
                    }
                },

                async fetchAsesorados() {
                    if (!this.state.currentUser) return;
                    const usersRef = collection(this.db, "users");
                    const q = query(usersRef, where("coachId", "==", this.state.currentUser.uid));
                    const querySnapshot = await getDocs(q);
                    this.state.asesorados = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                },
                async handleInviteClient(e) {
                    if (!this.isCoach()) {
                        this.showToast('Solo los entrenadores pueden invitar asesorados.', 'error');
                        return;
                    }
                    const form = e.target;
                    const button = e.submitter || form.querySelector('button[type="submit"]');
                    if (button) button.disabled = true;

                    const emailInput = document.getElementById('invite-email');
                    const email = emailInput.value.toLowerCase().trim();

                    if (!email) {
                        this.showToast("Ingresa un email válido.", "error");
                        if (button) button.disabled = false;
                        return;
                    }

                    if (this.state.currentUser?.email?.toLowerCase() === email) {
                        this.showToast("No puedes invitarte a ti mismo.", "error");
                        if (button) button.disabled = false;
                        return;
                    }

                    await this.fetchAsesorados();
                    const alreadyClient = (this.state.asesorados || []).some(client => client.email?.toLowerCase() === email);
                    if (alreadyClient) {
                        this.showToast("Este usuario ya es tu cliente.", "error");
                        if (button) button.disabled = false;
                        return;
                    }

                    try {
                        const invitationsRef = collection(this.db, "invitations");
                        const q = query(
                            invitationsRef,
                            where("coachId", "==", this.state.currentUser.uid),
                            where("clientEmail", "==", email),
                            where("status", "==", "pending")
                        );
                        const existingInvite = await getDocs(q);
                        if (!existingInvite.empty) {
                            this.showToast("Ya existe una invitación pendiente para este email.", "error");
                            if (button) button.disabled = false;
                            return;
                        }

                        await addDoc(invitationsRef, {
                            coachId: this.state.currentUser.uid,
                            clientEmail: email,
                            email,
                            emailLower: email,
                            role: 'asesorado',
                            status: "pending",
                            sentAt: new Date()
                        });

                        this.showToast(`¡Invitación enviada a ${email}!`, "success");
                        emailInput.value = '';
                    } catch (error) {
                        console.error("Error sending invitation:", error);
                        this.showToast("No se pudo enviar la invitación.", "error");
                    } finally {
                        if (button) button.disabled = false;
                    }
                },
                
                async revokeInvitation(inviteId) {
                    if (!this.isAdmin()) {
                        this.showToast('Solo el administrador puede revocar invitaciones.', 'error');
                        return;
                    }

                    try {
                        const inviteRef = doc(this.db, 'invitations', inviteId);
                        await updateDoc(inviteRef, {
                            status: 'revoked',
                            revokedAt: new Date()
                        });
                        this.showToast('Invitación revocada.');
                        await this.renderRolesSection();
                    } catch (error) {
                        console.error('Error revoking invite:', error);
                        this.showToast('No se pudo revocar la invitación.', 'error');
                    }
                },

                async showClientManager(clientId) {
                    const client = this.state.asesorados.find(c => c.id === clientId);
                    if (!client) {
                        this.showToast("Cliente no encontrado.", "error");
                        return;
                    }

                    const clientRoutine = client.userRoutines && client.userRoutines.length > 0 ? client.userRoutines[0] : null;
                    const availableRoutines = Array.isArray(this.state.userRoutines) ? this.state.userRoutines : [];
                    const selectorId = `client-routine-select-${clientId}`;

                    const routineHTML = `
                        <div class="bg-gray-900/50 rounded-xl p-4 space-y-4">
                            <div>
                                <h4 class="font-bold text-lg text-emerald-300 mb-2">Plan de Entrenamiento</h4>
                                ${clientRoutine ? `
                                    <div class="bg-gray-700/60 border border-emerald-500/20 p-3 rounded-lg">
                                        <p class="font-semibold text-white">${clientRoutine.name}</p>
                                        <p class="text-xs text-gray-400 mt-1">${clientRoutine.plan.length} día(s) · ${clientRoutine.plan.reduce((acc, d) => acc + d.exercises.length, 0)} ejercicio(s)</p>
                                    </div>
                                ` : `<p class="text-sm text-gray-500">Aún no se ha asignado una rutina personalizada.</p>`}
                            </div>
                            <button data-action="edit-client-routine" data-client-id="${clientId}" class="w-full bg-emerald-600/80 font-bold py-2 rounded-lg hover:bg-emerald-600 transition">
                                ${clientRoutine ? 'Editar en el Creador' : 'Crear Rutina Personalizada'}
                            </button>
                            <div class="border-t border-gray-800 pt-4">
                                <p class="text-sm font-semibold text-gray-300 mb-3 flex items-center gap-2">
                                    <i data-lucide="link" class="w-4 h-4 text-emerald-400"></i>
                                    Vincular rutina desde tu librería
                                </p>
                                ${availableRoutines.length ? `
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <select id="${selectorId}" class="flex-1 bg-gray-800/70 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                            <option value="">Selecciona una rutina</option>
                                            ${availableRoutines.map(routine => `<option value="${routine.id}">${routine.name}</option>`).join('')}
                                        </select>
                                        <button data-action="assign-routine-to-client" data-client-id="${clientId}" class="sm:w-auto w-full bg-emerald-500 text-gray-900 font-bold px-4 py-2 rounded-lg hover:bg-emerald-400 transition">Vincular</button>
                                    </div>
                                ` : `<p class="text-xs text-gray-500">Crea rutinas en tu librería para poder asignarlas rápidamente.</p>`}
                            </div>
                        </div>
                    `;
                    
                    const dietHTML = `
                        <div class="bg-gray-900/50 rounded-xl p-4">
                           <h4 class="font-bold text-lg text-emerald-300 mb-3">Plan de Alimentación</h4>
                           <div class="text-sm text-gray-400">Objetivo: <span class="font-bold text-white">${client.userGoals.calories} kcal</span></div>
                           <button data-action="edit-client-diet" data-client-id="${clientId}" class="w-full bg-emerald-600/80 font-bold py-2 rounded-lg mt-3 hover:bg-emerald-600 transition">
                                Editar Dieta
                           </button>
                        </div>
                    `;

                    const viewHTML = `<div id="client-manager-view" class="fullscreen-view bg-gray-800 w-full h-full flex flex-col">
                        <header class="p-4 flex items-center bg-gray-900/80 backdrop-blur-sm sticky top-0">
                            <button data-action="routine-close-view" class="p-2 rounded-full hover:bg-gray-700"><i data-lucide="arrow-left"></i></button>
                            <div class="flex-grow text-center">
                                <h3 class="text-lg font-bold truncate">${client.userName}</h3>
                                <p class="text-xs text-gray-400">${client.email}</p>
                            </div>
                            <div class="w-9 h-9"></div>
                        </header>
                        <div class="flex-grow p-4 overflow-y-auto space-y-4">
                            ${routineHTML}
                            ${dietHTML}
                        </div>
                    </div>`;

                    this.routine_openFullscreenView(viewHTML);
                },
                
                editClientRoutine(clientId) {
                    const client = this.state.asesorados.find(c => c.id === clientId);
                    if (!client) return;

                    const existingRoutine = client.userRoutines && client.userRoutines.length > 0 ? client.userRoutines[0] : null;

                    if (existingRoutine) {
                        this._tempRoutine = JSON.parse(JSON.stringify(existingRoutine));
                        this._tempRoutine.modalEditingIndex = -1;
                        if (typeof this._tempRoutine.miniWindowCollapsed !== 'boolean') {
                            this._tempRoutine.miniWindowCollapsed = false;
                        }
                    } else {
                        this._tempRoutine = {
                            id: `manual-${Date.now()}`,
                            name: `Rutina para ${client.userName.split(' ')[0]}`,
                            description: '',
                            plan: [{ day: 'Día 1', exercises: [] }],
                            currentDayIndex: 0,
                            editingIndex: -1,
                            modalEditingIndex: -1,
                            activeExerciseGroup: '',
                            miniWindowCollapsed: false
                        };
                    }
                    if (!this._tempRoutine.activeExerciseGroup) {
                        this._tempRoutine.activeExerciseGroup = '';
                    }
                    if (typeof this._tempRoutine.miniWindowCollapsed !== 'boolean') {
                        this._tempRoutine.miniWindowCollapsed = false;
                    }
                    this._tempRoutine.editingClientId = clientId;
                    this._tempRoutine.assignedClientId = clientId;
                    this.routine_enterCreator(2);
                },

                async assignRoutineToClient(clientId) {
                    const selector = document.getElementById(`client-routine-select-${clientId}`);
                    if (!selector) return;

                    const routineId = selector.value;
                    if (!routineId) {
                        this.showToast('Selecciona una rutina para vincular.', 'error');
                        return;
                    }

                    const client = (this.state.asesorados || []).find(c => c.id === clientId);
                    if (!client) {
                        this.showToast('Cliente no encontrado.', 'error');
                        return;
                    }

                    const routine = (this.state.userRoutines || []).find(r => r.id === routineId);
                    if (!routine) {
                        this.showToast('No encontramos esa rutina en tu librería.', 'error');
                        return;
                    }

                    const routineCopy = JSON.parse(JSON.stringify(routine));
                    routineCopy.assignedClientId = clientId;

                    const existingRoutines = Array.isArray(client.userRoutines) ? [...client.userRoutines] : [];
                    const existingIndex = existingRoutines.findIndex(r => r.id === routineCopy.id);
                    if (existingIndex >= 0) {
                        existingRoutines[existingIndex] = routineCopy;
                    } else {
                        existingRoutines.unshift(routineCopy);
                    }

                    try {
                        const clientRef = doc(this.db, 'users', clientId);
                        await updateDoc(clientRef, { userRoutines: existingRoutines });
                        this.showToast(`Rutina vinculada a ${client.userName.split(' ')[0]}.`, 'success');
                        selector.value = '';
                        await this.fetchAsesorados();
                        this.showClientManager(clientId);
                    } catch (error) {
                        console.error('Error assigning routine to client:', error);
                        this.showToast('No se pudo vincular la rutina.', 'error');
                    }
                },

                // --- NUEVAS FUNCIONES DE EDICIÓN DE DIETA ---

                async editClientDiet(clientId) {
                    const client = this.state.asesorados.find(c => c.id === clientId);
                    if (!client) return this.showToast("Cliente no encontrado.", "error");

                    // Crear una copia profunda para edición temporal, asegurando que los datos por defecto existan.
                    const defaultData = this.getDefaultState();
                    this._tempClientData = JSON.parse(JSON.stringify({
                        id: client.id,
                        userName: client.userName,
                        userGoals: client.userGoals || defaultData.userGoals,
                        physicalStats: client.physicalStats || defaultData.physicalStats,
                        dailyDiet: Array.isArray(client.dailyDiet) && client.dailyDiet.length > 0 ? client.dailyDiet : defaultData.dailyDiet
                    }));

                    const editorHTML = this.renderClientDietEditor();
                    this.routine_openFullscreenView(editorHTML);
                    this.renderFoodList('', 'client-food-list');
                },

                renderClientDietEditor() {
                    const client = this._tempClientData;
                    const goals = client.userGoals;

                    return `
                    <div id="client-diet-editor" class="fullscreen-view bg-gray-900 w-full h-full flex flex-col">
                        <header class="p-4 flex items-center justify-between bg-gray-800/80 backdrop-blur-sm shrink-0">
                            <button data-action="routine-close-view" class="p-2 rounded-full hover:bg-gray-700"><i data-lucide="arrow-left"></i></button>
                            <div class="text-center">
                                <h3 class="text-lg font-bold truncate">Dieta de ${client.userName.split(' ')[0]}</h3>
                            </div>
                            <button data-action="save-client-diet" data-client-id="${client.id}" class="font-bold text-emerald-400 px-4 py-2 rounded-lg hover:bg-emerald-500/10">Guardar</button>
                        </header>

                        <div class="flex-grow p-4 overflow-y-auto space-y-6">
                            <div class="bg-gray-800 p-4 rounded-xl space-y-3">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-semibold text-lg">Metas Diarias</h3>
                                    <button data-action="client-diet-show-calculator" data-client-id="${client.id}" class="flex items-center gap-1.5 text-sm bg-sky-500/20 text-sky-300 font-semibold py-1 px-3 rounded-lg hover:bg-sky-500/40">
                                        <i data-lucide="calculator" class="w-4 h-4"></i>Calcular Metas
                                    </button>
                                </div>
                                <form id="client-diet-goals-form" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div><label class="text-xs text-gray-400">Calorías (kcal)</label><input type="number" id="client-cals-goal" value="${goals.calories}" class="w-full bg-gray-700 p-2 rounded-lg text-center font-bold"></div>
                                    <div><label class="text-xs text-gray-400">Proteína (g)</label><input type="number" id="client-prot-goal" value="${goals.protein}" class="w-full bg-gray-700 p-2 rounded-lg text-center font-bold"></div>
                                    <div><label class="text-xs text-gray-400">Carbs (g)</label><input type="number" id="client-carb-goal" value="${goals.carbs}" class="w-full bg-gray-700 p-2 rounded-lg text-center font-bold"></div>
                                    <div><label class="text-xs text-gray-400">Grasas (g)</label><input type="number" id="client-fat-goal" value="${goals.fats}" class="w-full bg-gray-700 p-2 rounded-lg text-center font-bold"></div>
                                </form>
                            </div>

                            <div id="client-meal-sections-editor" class="space-y-4">
                                ${client.dailyDiet.map((meal, index) => this._renderClientMealSectionEditor(meal, index)).join('')}
                            </div>
                            <button data-action="client-diet-add-meal" class="w-full bg-gray-700/80 font-bold py-2.5 rounded-lg hover:bg-gray-700 transition flex items-center justify-center gap-2 text-emerald-400">
                                <i data-lucide="plus"></i>Añadir Comida
                            </button>

                            <div class="bg-gray-800 p-4 rounded-xl">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-xl font-bold">Librería de Alimentos</h3>
                                    <button data-action="client-diet-create-food-modal" class="flex items-center gap-1.5 text-sm bg-emerald-500/20 text-emerald-300 font-semibold py-1 px-3 rounded-lg hover:bg-emerald-500/40">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i>Crear Alimento
                                    </button>
                                </div>
                                <div class="relative"><input type="text" id="client-food-search" placeholder="Busca un alimento..." class="w-full bg-gray-700 rounded-lg p-3 pl-10"><div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i data-lucide="search" class="text-gray-400"></i></div></div>
                                <div id="client-food-list" class="space-y-2 pr-2 mt-3 max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>`;
                },

                _renderClientMealSectionEditor(meal, mealIndex) {
                    const totalCals = meal.items.reduce((sum, item) => sum + item.totalCals, 0);
                    const itemsHTML = meal.items.length > 0
                        ? meal.items.map((item, itemIndex) => `
                            <div class="bg-gray-900/50 p-2 rounded-md flex justify-between items-center text-sm">
                                <div>
                                    <p>${item.name} <span class="text-gray-400">(${item.amount || 'N/A'}g)</span></p>
                                    <p class="text-xs text-gray-400">P:${item.totalP}g C:${item.totalC}g G:${item.totalF}g</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="font-semibold text-emerald-400">${item.totalCals} kcal</span>
                                    <button data-action="client-diet-remove-food" data-meal-index="${mealIndex}" data-item-index="${itemIndex}" class="text-red-400 hover:text-red-300 text-xl leading-none p-1">&times;</button>
                                </div>
                            </div>`).join('')
                        : `<p class="text-sm text-center text-gray-500 py-2">No hay alimentos en esta comida.</p>`;

                    return `
                    <div class="bg-gray-700/50 p-4 rounded-xl" data-meal-id="${meal.id}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2 flex-grow">
                                <div>
                                    <label class="text-xs text-gray-400">Nombre de la Comida</label>
                                    <input type="text" data-field="name" data-meal-index="${mealIndex}" value="${meal.name}" class="w-full bg-gray-800 p-2 rounded-lg font-bold text-lg">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">Hora</label>
                                    <input type="time" data-field="time" data-meal-index="${mealIndex}" value="${meal.time}" class="w-full bg-gray-800 p-2 rounded-lg font-bold text-lg">
                                </div>
                            </div>
                            <button data-action="client-diet-remove-meal" data-meal-index="${mealIndex}" class="ml-2 mt-5 p-2 text-red-500 hover:bg-red-500/10 rounded-full"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                        <div class="space-y-2 mt-4 border-t border-gray-600/50 pt-3">${itemsHTML}</div>
                        <p class="text-right text-sm text-gray-400 mt-2">Total Comida: <span class="font-bold text-white">${Math.round(totalCals)} kcal</span></p>
                    </div>`;
                },

                _rerenderClientMealEditor() {
                    const container = document.getElementById('client-meal-sections-editor');
                    if (container) {
                        container.innerHTML = this._tempClientData.dailyDiet.map((meal, index) => this._renderClientMealSectionEditor(meal, index)).join('');
                        lucide.createIcons();
                    }
                },
                _addMealToClientDietTemp() {
                    const newMeal = {
                        id: `meal-${Date.now()}`,
                        name: `Comida ${this._tempClientData.dailyDiet.length + 1}`,
                        time: '17:00',
                        items: []
                    };
                    this._tempClientData.dailyDiet.push(newMeal);
                    this._rerenderClientMealEditor();
                },
                _removeMealFromClientDietTemp(mealIndex) {
                    this._tempClientData.dailyDiet.splice(mealIndex, 1);
                    this._rerenderClientMealEditor();
                },
                _updateMealDataFromUI(mealIndex) {
                    const mealDiv = document.querySelector(`#client-diet-editor [data-meal-index="${mealIndex}"]`).closest('[data-meal-id]');
                    const nameInput = mealDiv.querySelector('input[data-field="name"]');
                    const timeInput = mealDiv.querySelector('input[data-field="time"]');
                    this._tempClientData.dailyDiet[mealIndex].name = nameInput.value;
                    this._tempClientData.dailyDiet[mealIndex].time = timeInput.value;
                },
                _showAddFoodToClientModal(foodId) {
                    const food = this.getFoodById(foodId);
                    if (!food) return;

                    const mealOptions = this._tempClientData.dailyDiet.map((meal, index) => 
                        `<button data-action="client-diet-add-food-to-meal" data-food-id="${food.id}" data-meal-index="${index}" class="bg-gray-600 p-2 rounded-lg hover:bg-gray-500">${meal.name}</button>`
                    ).join('');

                    const body = `
                        <p class="mb-4">Añadir <strong>${food.name}</strong> a una comida.</p>
                        <div><label for="food-amount-client" class="block text-sm font-medium text-gray-300 mb-1">Cantidad (g)</label><input type="number" id="food-amount-client" value="100" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div>
                        <div class="mt-4"><label class="block text-sm font-medium text-gray-300 mb-2">Selecciona la comida</label><div class="grid grid-cols-2 gap-2">${mealOptions}</div></div>`;
                    this.showModal(`Añadir a Dieta de ${this._tempClientData.userName.split(' ')[0]}`, body, [{ text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' }]);
                },
                _addFoodToClientDietTemp(foodId, mealIndex) {
                    const amount = parseInt(document.getElementById('food-amount-client').value);
                    if (isNaN(amount) || amount <= 0) { this.showToast("Cantidad inválida.", "error"); return; }
                    const food = this.getFoodById(foodId);
                    if (!food) { this.showToast("Alimento no encontrado.", "error"); return; }
                    
                    const factor = amount / 100;
                    this._tempClientData.dailyDiet[mealIndex].items.push({
                        ...food, amount: amount,
                        totalCals: Math.round((food.cals || 0) * factor),
                        totalP: Math.round((food.p || 0) * factor),
                        totalC: Math.round((food.c || 0) * factor),
                        totalF: Math.round((food.f || 0) * factor)
                    });
                    
                    this._rerenderClientMealEditor();
                    this.hideModal();
                    this.showToast(`${food.name} añadido a ${this._tempClientData.dailyDiet[mealIndex].name}.`);
                },
                _handleRemoveFoodFromClientDiet(mealIndex, itemIndex) {
                    this._tempClientData.dailyDiet[mealIndex].items.splice(itemIndex, 1);
                    this._rerenderClientMealEditor();
                    this.showToast('Alimento eliminado.', 'error');
                },
                _handleUpdateClientGoalsFromUI() {
                    this._tempClientData.userGoals.calories = parseInt(document.getElementById('client-cals-goal').value) || 0;
                    this._tempClientData.userGoals.protein = parseInt(document.getElementById('client-prot-goal').value) || 0;
                    this._tempClientData.userGoals.carbs = parseInt(document.getElementById('client-carb-goal').value) || 0;
                    this._tempClientData.userGoals.fats = parseInt(document.getElementById('client-fat-goal').value) || 0;
                },
                _showClientCalculatorModal(clientId) {
                    const client = this._tempClientData;
                    const stats = client.physicalStats || this.getDefaultState().physicalStats;
                    const body = `
                        <p class="text-sm text-gray-400 mb-4">Calcula las metas basadas en los datos de ${client.userName}.</p>
                        <form id="client-calc-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4"><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="gender" value="male" class="sr-only" ${stats.gender === 'male' ? 'checked' : ''}> Hombre</label><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="gender" value="female" class="sr-only" ${stats.gender === 'female' ? 'checked' : ''}> Mujer</label></div>
                            <div class="grid grid-cols-3 gap-3"><div><label class="text-xs">Edad</label><input type="number" name="age" value="${stats.age}" class="w-full bg-gray-700 rounded p-2 text-center"></div><div><label class="text-xs">Peso (kg)</label><input type="number" step="0.1" name="weight" value="${stats.weight}" class="w-full bg-gray-700 rounded p-2 text-center"></div><div><label class="text-xs">Altura (cm)</label><input type="number" name="height" value="${stats.height}" class="w-full bg-gray-700 rounded p-2 text-center"></div></div>
                            <div><label class="text-xs">Nivel de Actividad</label><select name="activity" class="w-full bg-gray-700 rounded p-2 mt-1"><option value="1.2" ${stats.activity == 1.2 ? 'selected' : ''}>Sedentario</option><option value="1.375" ${stats.activity == 1.375 ? 'selected' : ''}>Ligero</option><option value="1.55" ${stats.activity == 1.55 ? 'selected' : ''}>Moderado</option><option value="1.725" ${stats.activity == 1.725 ? 'selected' : ''}>Activo</option><option value="1.9" ${stats.activity == 1.9 ? 'selected' : ''}>Muy Activo</option></select></div>
                            <div class="grid grid-cols-3 gap-2"><label class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer text-sm has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="goal" value="lose" class="sr-only"> Perder</label><label class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer text-sm has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="goal" value="maintain" class="sr-only" checked> Mantener</label><label class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer text-sm has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="goal" value="gain" class="sr-only"> Ganar</label></div>
                        </form>
                    `;
                    const footer = [{ text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' }, { text: 'Calcular y Aplicar', class: 'bg-emerald-600 text-gray-900', action: 'none' }];
                    this.showModal('Calcular Metas', body, footer);

                    document.querySelector('#custom-modal-footer button[data-action="none"]').onclick = () => {
                        const form = document.getElementById('client-calc-form');
                        const results = this.calculateNutrition(form, false);
                        if (results) {
                            document.getElementById('client-cals-goal').value = results.calories;
                            document.getElementById('client-prot-goal').value = results.protein;
                            document.getElementById('client-carb-goal').value = results.carbs;
                            document.getElementById('client-fat-goal').value = results.fats;
                            this._handleUpdateClientGoalsFromUI();
                            this.hideModal();
                        }
                    };
                },
                _hydrateDietFoodCreator() {
                    const card = document.getElementById('diet-create-food-card');
                    if (!card) {
                        return;
                    }

                    const shouldShow = this.isAsesor();
                    card.classList.toggle('hidden', !shouldShow);
                    if (!shouldShow) {
                        return;
                    }

                    const preview = document.getElementById('diet-create-food-preview');
                    if (preview) {
                        if (!preview.dataset.initialized) {
                            this.renderFoodImagePlaceholder(preview);
                            preview.dataset.initialized = 'true';
                        } else if (!preview.innerHTML.trim()) {
                            this.renderFoodImagePlaceholder(preview);
                        }
                    }

                    const removeBtn = document.getElementById('diet-create-remove-btn');
                    if (removeBtn && !removeBtn.dataset.originalInnerHTML) {
                        removeBtn.dataset.originalInnerHTML = removeBtn.innerHTML;
                    }

                    const removeInput = document.getElementById('diet-create-remove-image');
                    if (removeInput && removeInput.value !== 'false' && !document.getElementById('diet-create-food-image')?.files?.length) {
                        removeInput.value = 'false';
                    }

                    this.setupFoodImagePreview('diet-create-food-image', 'diet-create-food-preview', 'diet-create-remove-image', 'diet-create-remove-btn');
                },
                _showCreateFoodModal() {
                    const body = `
                        <p class="text-sm text-gray-300 mb-4">Añade un nuevo alimento a tu librería personal con valores por cada 100&nbsp;g para mantener tus cálculos precisos.</p>
                        <form id="create-food-form" class="space-y-5">
                            <div>
                                <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Nombre del alimento</label>
                                <input type="text" name="name" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                            </div>
                            <div class="grid gap-3 sm:grid-cols-2">
                                <div>
                                    <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Calorías (kcal)</label>
                                    <input type="number" name="cals" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Proteína (g)</label>
                                    <input type="number" name="p" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Carbohidratos (g)</label>
                                    <input type="number" name="c" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Grasas (g)</label>
                                    <input type="number" name="f" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                </div>
                            </div>
                            <div class="rounded-2xl border border-dashed border-white/15 bg-gray-900/60 p-4">
                                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Imagen opcional</p>
                                <div id="custom-food-image-preview" class="mt-3 rounded-xl border border-dashed border-white/10 bg-gray-900/50 p-4"></div>
                                <div class="mt-3 flex flex-wrap items-center gap-3">
                                    <label class="inline-flex cursor-pointer items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-emerald-400 hover:text-white">
                                        <i data-lucide="upload-cloud" class="h-3.5 w-3.5"></i>
                                        Subir imagen
                                        <input type="file" id="custom-food-image-input" accept="image/*" class="hidden">
                                    </label>
                                    <button type="button" id="remove-food-image-btn" data-action="client-diet-remove-food-image" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-500/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-rose-200 opacity-60 transition hover:border-rose-300 hover:bg-rose-500/20 disabled:cursor-not-allowed" disabled>
                                        <i data-lucide="trash-2" class="h-3.5 w-3.5"></i>
                                        Quitar imagen
                                    </button>
                                </div>
                                <input type="hidden" id="custom-food-remove-image" value="false">
                            </div>
                        </form>
                    `;
                    const footer = [{ text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' }, { text: 'Crear Alimento', class: 'bg-emerald-600 text-gray-900', action: 'client-diet-save-custom-food' }];
                    this.showModal('Crear Nuevo Alimento', body, footer);
                    const preview = document.getElementById('custom-food-image-preview');
                    this.renderFoodImagePlaceholder(preview);
                    this.setupFoodImagePreview('custom-food-image-input', 'custom-food-image-preview', 'custom-food-remove-image', 'remove-food-image-btn');
                    const removeBtn = document.getElementById('remove-food-image-btn');
                    if (removeBtn) {
                        removeBtn.dataset.originalInnerHTML = removeBtn.innerHTML;
                    }
                    lucide.createIcons();
                },
                _collectFoodFormValues(form) {
                    if (!form) {
                        this.showToast('No se encontró el formulario del alimento.', 'error');
                        return null;
                    }
                    const name = form.name?.value?.trim() || '';
                    const cals = parseFloat(form.cals?.value);
                    const p = parseFloat(form.p?.value);
                    const c = parseFloat(form.c?.value);
                    const f = parseFloat(form.f?.value);
                    if (!name || [cals, p, c, f].some(value => Number.isNaN(value))) {
                        this.showToast('Todos los campos son obligatorios y deben ser números.', 'error');
                        return null;
                    }
                    return { name, cals, p, c, f };
                },
                async _saveCustomFood() {
                    const form = document.getElementById('create-food-form');
                    const newFood = this._collectFoodFormValues(form);
                    if (!newFood) {
                        return;
                    }
                    this.setModalButtonLoading('client-diet-save-custom-food', true);

                    try {
                        const fileInput = document.getElementById('custom-food-image-input');
                        if (fileInput && fileInput.files && fileInput.files[0]) {
                            const { url, storagePath } = await this.uploadImageToStorage(fileInput.files[0], { pathPrefix: 'foods' });
                            if (url) {
                                newFood.imageUrl = url;
                                newFood.storagePath = storagePath;
                            }
                        }

                        const customFoodsRef = collection(this.db, 'users', this.state.currentUser.uid, 'customFoods');
                        await addDoc(customFoodsRef, newFood);
                        this.showToast('Alimento creado y guardado en tu librería.', 'success');
                        await this.loadAndMergeFoodData();
                        const clientSearch = document.getElementById('client-food-search');
                        if (clientSearch) {
                            this.renderFoodList(clientSearch.value, 'client-food-list');
                        }
                        const mainSearch = document.getElementById('food-search');
                        this.renderFoodList(mainSearch ? mainSearch.value : '');
                        this.hideModal();
                    } catch (error) {
                        console.error('Error creating custom food:', error);
                        this.showToast('No se pudo guardar el alimento.', 'error');
                    } finally {
                        this.setModalButtonLoading('client-diet-save-custom-food', false, 'Crear alimento');
                    }
                },
                async _handleInlineFoodCreate() {
                    if (!this.isAsesor()) {
                        this.showToast('Solo el entrenador puede crear alimentos personalizados.', 'error');
                        return;
                    }

                    const form = document.getElementById('diet-create-food-form');
                    const submitBtn = form ? form.querySelector('button[type="submit"]') : null;
                    const newFood = this._collectFoodFormValues(form);
                    if (!newFood) {
                        return;
                    }

                    this.setElementLoading(submitBtn, true, 'Guardar alimento');

                    try {
                        const imageInput = document.getElementById('diet-create-food-image');
                        if (imageInput && imageInput.files && imageInput.files[0]) {
                            const { url, storagePath } = await this.uploadImageToStorage(imageInput.files[0], { pathPrefix: 'foods' });
                            if (url) {
                                newFood.imageUrl = url;
                                newFood.storagePath = storagePath;
                            }
                        }

                        const customFoodsRef = collection(this.db, 'users', this.state.currentUser.uid, 'customFoods');
                        await addDoc(customFoodsRef, newFood);
                        this.showToast('Alimento creado y guardado en tu librería.', 'success');

                        if (form) {
                            form.reset();
                        }
                        const preview = document.getElementById('diet-create-food-preview');
                        if (preview) {
                            preview.innerHTML = '';
                            this.renderFoodImagePlaceholder(preview);
                        }
                        const removeBtn = document.getElementById('diet-create-remove-btn');
                        if (removeBtn) {
                            removeBtn.disabled = true;
                            removeBtn.classList.add('opacity-60', 'cursor-not-allowed');
                            if (removeBtn.dataset.originalInnerHTML) {
                                removeBtn.innerHTML = removeBtn.dataset.originalInnerHTML;
                            }
                        }
                        const removeInput = document.getElementById('diet-create-remove-image');
                        if (removeInput) {
                            removeInput.value = 'false';
                        }

                        await this.loadAndMergeFoodData();
                        const mainSearch = document.getElementById('food-search');
                        this.renderFoodList(mainSearch ? mainSearch.value : '');
                        const clientSearch = document.getElementById('client-food-search');
                        if (clientSearch) {
                            this.renderFoodList(clientSearch.value, 'client-food-list');
                        }
                    } catch (error) {
                        console.error('Error creating custom food:', error);
                        this.showToast('No se pudo guardar el alimento.', 'error');
                    } finally {
                        this.setElementLoading(submitBtn, false, 'Guardar alimento');
                    }
                },
                _showEditFoodModal(foodId) {
                    const food = this.getFoodById(foodId);
                    if (!food) {
                        this.showToast('Alimento no encontrado.', 'error');
                        return;
                    }

                    const source = food.source || (typeof food.id === 'string' ? 'custom' : 'predefined');
                    const storagePath = food.storagePath || '';
                    const category = food.category || '';
                    const hasImage = Boolean(food.imageUrl);
                    const originIcon = source === 'custom' ? 'star' : 'apple';
                    const originLabel = source === 'custom' ? 'Alimento personalizado' : 'Alimento base FitTrack';

                    const body = `
                        <p class="text-sm text-gray-400 mb-4">Actualiza los valores por cada 100&nbsp;g para mantener tus registros precisos.</p>
                        <form id="edit-food-form" class="space-y-4" data-food-id="${foodId}" data-storage-path="${storagePath}" data-image-url="${food.imageUrl || ''}" data-source="${source}" data-category="${category}">
                            <div class="flex flex-wrap items-center gap-2 text-[11px] text-gray-400">
                                <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-1 font-semibold uppercase tracking-[0.35em] text-gray-200">
                                    <i data-lucide="${originIcon}" class="h-3.5 w-3.5"></i>
                                    ${originLabel}
                                </span>
                                ${category ? `<span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/30 bg-emerald-500/10 px-2.5 py-1 font-semibold uppercase tracking-[0.35em] text-emerald-100">${category}</span>` : ''}
                            </div>
                            <div>
                                <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Nombre del alimento</label>
                                <input type="text" name="name" value="${food.name}" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Calorías (kcal)</label>
                                    <input type="number" name="cals" value="${food.cals}" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Proteína (g)</label>
                                    <input type="number" name="p" value="${food.p}" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Carbohidratos (g)</label>
                                    <input type="number" name="c" value="${food.c}" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                </div>
                                <div>
                                    <label class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Grasas (g)</label>
                                    <input type="number" name="f" value="${food.f}" required class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                </div>
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Imagen</p>
                                <div class="mt-2 flex flex-col gap-3">
                                    <div id="custom-food-image-preview" class="rounded-xl border border-dashed border-white/10 bg-gray-900/40 p-4"></div>
                                    <div class="flex flex-wrap items-center gap-3">
                                        <label class="inline-flex cursor-pointer items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-emerald-400 hover:text-white">
                                            <i data-lucide="upload-cloud" class="h-4 w-4"></i>
                                            Subir nueva imagen
                                            <input type="file" id="custom-food-image-input" accept="image/*" class="hidden">
                                        </label>
                                        <button type="button" id="remove-food-image-btn" data-action="client-diet-remove-food-image" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-500/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-rose-200 transition hover:border-rose-300 hover:bg-rose-500/20 ${hasImage ? '' : 'opacity-60 cursor-not-allowed'}" ${hasImage ? '' : 'disabled'}>
                                            <i data-lucide="trash-2" class="h-3.5 w-3.5"></i>
                                            Quitar imagen
                                        </button>
                                    </div>
                                    <input type="hidden" id="custom-food-remove-image" value="false">
                                </div>
                            </div>
                        </form>
                    `;
                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' },
                        { text: 'Guardar cambios', class: 'bg-emerald-600 text-gray-900', action: 'client-diet-update-food' }
                    ];
                    this.showModal(`Editar Alimento`, body, footer);

                    const preview = document.getElementById('custom-food-image-preview');
                    if (hasImage) {
                        preview.innerHTML = `<img src="${food.imageUrl}" alt="${food.name}" class="h-24 w-full rounded-xl border border-white/10 object-cover">`;
                    } else {
                        this.renderFoodImagePlaceholder(preview);
                    }
                    const removeBtn = document.getElementById('remove-food-image-btn');
                    if (removeBtn) {
                        removeBtn.dataset.originalInnerHTML = removeBtn.innerHTML;
                        if (hasImage) {
                            removeBtn.disabled = false;
                            removeBtn.classList.remove('opacity-60', 'cursor-not-allowed');
                        } else {
                            removeBtn.disabled = true;
                            removeBtn.classList.add('opacity-60', 'cursor-not-allowed');
                        }
                    }
                    this.setupFoodImagePreview('custom-food-image-input', 'custom-food-image-preview', 'custom-food-remove-image', 'remove-food-image-btn');
                    lucide.createIcons();
                },
                async _updateFood() {
                    const form = document.getElementById('edit-food-form');
                    if (!form) {
                        return;
                    }

                    const foodId = form.dataset.foodId;
                    if (!foodId) {
                        this.showToast('No se pudo identificar el alimento.', 'error');
                        return;
                    }

                    const updates = this._collectFoodFormValues(form);
                    if (!updates) {
                        return;
                    }

                    const source = form.dataset.source || (isNaN(parseInt(foodId, 10)) ? 'custom' : 'predefined');
                    const category = form.dataset.category || '';
                    if (source === 'predefined' && category && !updates.category) {
                        updates.category = category;
                    }

                    const removeImage = document.getElementById('custom-food-remove-image')?.value === 'true';
                    this.setModalButtonLoading('client-diet-update-food', true, 'Guardar cambios');

                    const fileInput = document.getElementById('custom-food-image-input');
                    const previousPath = form.dataset.storagePath || '';

                    try {
                        if (fileInput && fileInput.files && fileInput.files[0]) {
                            const { url, storagePath } = await this.uploadImageToStorage(fileInput.files[0], { pathPrefix: 'foods', previousPath });
                            updates.imageUrl = url;
                            updates.storagePath = storagePath;
                        } else if (removeImage) {
                            if (previousPath) {
                                await this.deleteStorageAsset(previousPath);
                            }
                            updates.imageUrl = '';
                            updates.storagePath = '';
                        }

                        if (source === 'custom') {
                            const foodRef = doc(this.db, 'users', this.state.currentUser.uid, 'customFoods', foodId);
                            await updateDoc(foodRef, updates);
                        } else {
                            await this._savePredefinedFoodOverride(foodId, updates);
                        }

                        this.showToast('Alimento actualizado.', 'success');
                        this.hideModal();
                        await this.loadAndMergeFoodData();
                        const clientSearch = document.getElementById('client-food-search');
                        if (clientSearch) {
                            this.renderFoodList(clientSearch.value, 'client-food-list');
                        }
                        const mainSearch = document.getElementById('food-search');
                        this.renderFoodList(mainSearch ? mainSearch.value : '');
                    } catch (error) {
                        console.error('Error updating food:', error);
                        this.showToast('No se pudo actualizar el alimento.', 'error');
                    } finally {
                        this.setModalButtonLoading('client-diet-update-food', false, 'Guardar cambios');
                    }
                },
                _handleRemoveFoodImageFromForm(button) {
                    const preview = document.getElementById('custom-food-image-preview');
                    const removeInput = document.getElementById('custom-food-remove-image');
                    const fileInput = document.getElementById('custom-food-image-input');
                    if (removeInput) {
                        removeInput.value = 'true';
                    }
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    this.renderFoodImagePlaceholder(preview);
                    if (button) {
                        if (!button.dataset.originalInnerHTML) {
                            button.dataset.originalInnerHTML = button.innerHTML;
                        }
                        button.disabled = true;
                        button.classList.add('opacity-60', 'cursor-not-allowed');
                        button.innerHTML = `<i data-lucide="check" class="h-4 w-4"></i> Eliminada`;
                        lucide.createIcons();
                    }
                },
                _confirmDeleteCustomFood(foodId) {
                    const food = this.getFoodById(foodId);
                    if (!food) return this.showToast('Alimento no encontrado', 'error');
                    const body = `¿Estás seguro de que quieres eliminar permanentemente el alimento "<strong>${food.name}</strong>"? Esta acción no se puede deshacer.`;
                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' },
                        { text: 'Eliminar', class: 'bg-red-600', action: 'delete-custom-food', 'food-id': foodId, 'storage-path': food.storagePath || '' }
                    ];
                    this.showModal('Confirmar Eliminación', body, footer);
                },
                async _deleteCustomFood(foodId, storagePath = '') {
                    try {
                        const foodRef = doc(this.db, "users", this.state.currentUser.uid, "customFoods", foodId);
                        await deleteDoc(foodRef);
                        if (storagePath) {
                            await this.deleteStorageAsset(storagePath);
                        }
                        this.showToast('Alimento eliminado con éxito.', 'success');
                        this.hideModal();
                        await this.loadAndMergeFoodData();
                        const clientSearchInput = document.getElementById('client-food-search');
                        if (clientSearchInput) {
                            this.renderFoodList(clientSearchInput.value, 'client-food-list');
                        }
                        const mainSearch = document.getElementById('food-search');
                        this.renderFoodList(mainSearch ? mainSearch.value : '');
                    } catch (error) {
                        console.error("Error deleting custom food:", error);
                        this.showToast('No se pudo eliminar el alimento.', 'error');
                    }
                },
                async _savePredefinedFoodOverride(foodId, updates) {
                    const key = String(foodId);
                    const currentOverrides = { ...(this.data.foodOverrides || {}) };
                    const existing = currentOverrides[key] || {};
                    const nextOverride = { ...existing, ...updates };
                    if (nextOverride.hidden === false) {
                        delete nextOverride.hidden;
                    }
                    currentOverrides[key] = nextOverride;
                    try {
                        const docRef = doc(this.db, 'app_data', 'food_overrides');
                        await setDoc(docRef, { overrides: currentOverrides }, { merge: true });
                        this.data.foodOverrides = currentOverrides;
                    } catch (error) {
                        console.error('Error guardando overrides de alimentos:', error);
                        throw error;
                    }
                },
                _confirmDeletePredefinedFood(foodId) {
                    const food = this.getFoodById(foodId);
                    if (!food) {
                        this.showToast('Alimento no encontrado', 'error');
                        return;
                    }
                    const body = `Ocultarás <strong>${food.name}</strong> de la biblioteca base. Podrás restaurarlo editando los alimentos base nuevamente.`;
                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' },
                        { text: 'Ocultar', class: 'bg-red-600', action: 'delete-predefined-food', 'food-id': foodId, 'storage-path': food.storagePath || '' }
                    ];
                    this.showModal('Ocultar alimento base', body, footer);
                },
                async _deletePredefinedFood(foodId, storagePath = '') {
                    try {
                        const key = String(foodId);
                        const overrides = { ...(this.data.foodOverrides || {}) };
                        const existing = overrides[key] || {};
                        const nextOverride = { ...existing, hidden: true };
                        if (storagePath) {
                            await this.deleteStorageAsset(storagePath);
                            nextOverride.storagePath = '';
                            nextOverride.imageUrl = '';
                        }
                        overrides[key] = nextOverride;
                        const docRef = doc(this.db, 'app_data', 'food_overrides');
                        await setDoc(docRef, { overrides }, { merge: true });
                        this.data.foodOverrides = overrides;
                        this.showToast('Alimento ocultado de la biblioteca.', 'success');
                        this.hideModal();
                        await this.loadAndMergeFoodData();
                        const clientSearchInput = document.getElementById('client-food-search');
                        if (clientSearchInput) {
                            this.renderFoodList(clientSearchInput.value, 'client-food-list');
                        }
                        const mainSearch = document.getElementById('food-search');
                        this.renderFoodList(mainSearch ? mainSearch.value : '');
                    } catch (error) {
                        console.error('Error ocultando alimento base:', error);
                        this.showToast('No se pudo ocultar el alimento.', 'error');
                    }
                },
                async saveClientDiet(clientId) {
                    this._handleUpdateClientGoalsFromUI();
                    const clientRef = doc(this.db, "users", clientId);
                    try {
                        await updateDoc(clientRef, {
                            userGoals: this._tempClientData.userGoals,
                            dailyDiet: this._tempClientData.dailyDiet
                        });
                        this.showToast(`Dieta de ${this._tempClientData.userName.split(' ')[0]} guardada.`, "success");
                        this.routine_closeFullscreenView();
                        await this.fetchAsesorados();
                        this.renderAsesoradosSection();
                        this._tempClientData = null;
                    } catch (error) {
                        console.error("Error saving client diet:", error);
                        this.showToast("Error al guardar la dieta.", "error");
                    }
                },

                // --- FIN DE NUEVAS FUNCIONES ---
                
                updateDietSummary() {
                    const setText = (id, value) => {
                        const el = document.getElementById(id);
                        if (el !== null) {
                            el.textContent = value;
                        }
                    };
                    const toNumber = (value) => {
                        const parsed = Number(value);
                        return Number.isFinite(parsed) ? parsed : 0;
                    };

                    const goals = this.state.userGoals || { calories: 0, protein: 0, carbs: 0, fats: 0 };

                    const weightMetrics = this._getWeightProgressMetrics();
                    this._applyWeightMetrics(weightMetrics);

                    const consumedTotals = { cals: 0, p: 0, c: 0, f: 0 };
                    const plannedTotals = { cals: 0, p: 0, c: 0, f: 0 };
                    const mealStats = { totalMeals: 0, completedMeals: 0, plannedItems: 0, completedItems: 0 };
                    let nextMealLabel = '';

                    const today = new Date().toISOString().split('T')[0];
                    const todayLog = this.state.dietLog ? (this.state.dietLog[today] || {}) : {};
                    const isCoach = this.isAsesor();

                    if (Array.isArray(this.state.dailyDiet)) {
                        this.state.dailyDiet.forEach((meal) => {
                            const items = Array.isArray(meal.items) ? meal.items : [];
                            if (items.length > 0) {
                                mealStats.totalMeals += 1;
                            }
                            const mealLog = todayLog[meal.id] || [];
                            let mealCompleted = items.length > 0;

                            items.forEach((item, index) => {
                                const totals = {
                                    cals: toNumber(item.totalCals),
                                    p: toNumber(item.totalP),
                                    c: toNumber(item.totalC),
                                    f: toNumber(item.totalF)
                                };

                                plannedTotals.cals += totals.cals;
                                plannedTotals.p += totals.p;
                                plannedTotals.c += totals.c;
                                plannedTotals.f += totals.f;

                                mealStats.plannedItems += 1;

                                const isConsumed = isCoach || mealLog[index] === true;
                                if (isConsumed) {
                                    consumedTotals.cals += totals.cals;
                                    consumedTotals.p += totals.p;
                                    consumedTotals.c += totals.c;
                                    consumedTotals.f += totals.f;
                                    mealStats.completedItems += 1;
                                } else {
                                    mealCompleted = false;
                                }
                            });

                            if (items.length > 0) {
                                if (mealCompleted) {
                                    mealStats.completedMeals += 1;
                                } else if (!nextMealLabel) {
                                    const time = meal.time ? ` · ${meal.time}` : '';
                                    nextMealLabel = `${meal.name}${time}`;
                                }
                            }
                        });
                    }

                    const caloriesGoal = toNumber(goals.calories);
                    const consumedCalories = Math.round(consumedTotals.cals);
                    const consumedPercentRaw = caloriesGoal > 0 ? (consumedTotals.cals / caloriesGoal) * 100 : 0;
                    const consumedPercent = Math.round(Math.max(0, Math.min(consumedPercentRaw, 150)));
                    const planCalories = Math.round(plannedTotals.cals);
                    const planCoveragePercent = caloriesGoal > 0 ? Math.round(Math.max(0, Math.min((plannedTotals.cals / caloriesGoal) * 100, 200))) : 0;
                    const planDiff = planCalories - caloriesGoal;
                    const calorieDelta = caloriesGoal - consumedTotals.cals;

                    let statusLabel = 'Sin registros';
                    let statusClass = 'text-gray-400';
                    if (consumedPercent >= 100 && caloriesGoal > 0) {
                        statusLabel = 'Meta cubierta';
                        statusClass = 'text-emerald-200/90';
                    } else if (consumedPercent >= 75) {
                        statusLabel = 'Cierre final';
                        statusClass = 'text-amber-200/80';
                    } else if (consumedPercent > 0) {
                        statusLabel = 'En curso';
                        statusClass = 'text-emerald-200/80';
                    }

                    let deltaText = 'Planifica tu primera comida para comenzar.';
                    let deltaClass = 'text-emerald-100/70';
                    if (caloriesGoal <= 0) {
                        deltaText = 'Configura tu objetivo calórico desde la pestaña de nutrición.';
                        deltaClass = 'text-gray-400';
                    } else if (consumedTotals.cals === 0) {
                        deltaText = 'Registra tu primera comida para iniciar el seguimiento.';
                    } else if (Math.abs(calorieDelta) < 25) {
                        deltaText = 'Estás alineado con tu objetivo diario.';
                        deltaClass = 'text-emerald-200/80';
                    } else if (calorieDelta > 0) {
                        deltaText = `Restan ${Math.round(calorieDelta)} kcal para cerrar el día.`;
                        deltaClass = 'text-emerald-200/80';
                    } else if (calorieDelta < 0) {
                        deltaText = `Te excediste ${Math.abs(Math.round(calorieDelta))} kcal. Ajusta el resto del día.`;
                        deltaClass = 'text-amber-200/80';
                    }

                    const planCoverageText = planCalories > 0
                        ? `${planCalories} kcal planificadas${caloriesGoal > 0 ? ` (${planCoveragePercent}% del objetivo)` : ''}`
                        : 'Añade comidas para proyectar tu día.';
                    let planDiffText = '';
                    let planDiffClass = 'text-gray-500';
                    if (planCalories > 0 && caloriesGoal > 0) {
                        if (Math.abs(planDiff) < 25) {
                            planDiffText = 'Plan alineado con el objetivo.';
                            planDiffClass = 'text-emerald-200/80';
                        } else if (planDiff > 0) {
                            planDiffText = `+${Math.round(planDiff)} kcal sobre el objetivo.`;
                            planDiffClass = 'text-amber-200/80';
                        } else {
                            planDiffText = `${Math.round(planDiff)} kcal por debajo del objetivo.`;
                            planDiffClass = 'text-sky-200/80';
                        }
                    } else if (caloriesGoal > 0) {
                        planDiffText = 'Define el detalle de tus comidas para validar el plan.';
                    } else {
                        planDiffText = 'Configura tu objetivo calórico para validar el plan.';
                    }

                    const mealProgressText = mealStats.totalMeals > 0
                        ? `${mealStats.completedMeals} de ${mealStats.totalMeals} comidas completadas`
                        : 'Planifica tus comidas para iniciar el seguimiento.';
                    const checkinsPercent = mealStats.plannedItems > 0
                        ? Math.round((mealStats.completedItems / mealStats.plannedItems) * 100)
                        : 0;
                    const checkinsText = mealStats.plannedItems > 0
                        ? `${checkinsPercent}% de tus platos confirmados`
                        : 'Sin registros hoy';
                    let checkinsClass = 'text-gray-500';
                    if (mealStats.plannedItems > 0) {
                        if (checkinsPercent >= 80) {
                            checkinsClass = 'text-emerald-200/80';
                        } else if (checkinsPercent > 0) {
                            checkinsClass = 'text-emerald-100/70';
                        }
                    }

                    let nextMealText;
                    let nextMealClass = 'text-emerald-200/80';
                    if (mealStats.totalMeals === 0) {
                        nextMealText = 'Añade comidas para activar recordatorios.';
                        nextMealClass = 'text-gray-400';
                    } else if (!nextMealLabel) {
                        nextMealText = 'Todo listo. Celebra tu disciplina.';
                    } else {
                        nextMealText = `Próximo: ${nextMealLabel}`;
                    }

                    const macroContainer = document.getElementById('diet-today-macro-badges');
                    if (macroContainer && macroContainer.childElementCount === 0) {
                        const macroTemplate = [
                            { key: 'protein', label: 'Proteína', icon: 'shield-half', accent: 'text-blue-200', badge: 'bg-blue-500/20 text-blue-100', gradient: 'from-blue-500/10 via-blue-500/5 to-gray-900/60', meter: 'bg-blue-500/20', bar: 'from-blue-400 via-sky-400 to-emerald-300' },
                            { key: 'carbs', label: 'Carbohidratos', icon: 'wheat', accent: 'text-yellow-200', badge: 'bg-yellow-500/20 text-yellow-100', gradient: 'from-yellow-500/10 via-amber-500/5 to-gray-900/60', meter: 'bg-yellow-500/20', bar: 'from-yellow-300 via-amber-300 to-orange-300' },
                            { key: 'fats', label: 'Grasas saludables', icon: 'droplets', accent: 'text-rose-200', badge: 'bg-rose-500/20 text-rose-100', gradient: 'from-rose-500/10 via-pink-500/5 to-gray-900/60', meter: 'bg-rose-500/20', bar: 'from-rose-300 via-pink-300 to-purple-300' }
                        ].map(macro => `
                            <div class="space-y-3 rounded-2xl border border-white/10 bg-gradient-to-br ${macro.gradient} p-4 shadow-inner">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2 text-sm font-semibold ${macro.accent}">
                                        <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl ${macro.badge}">
                                            <i data-lucide="${macro.icon}" class="h-4 w-4"></i>
                                        </span>
                                        ${macro.label}
                                    </div>
                                    <span class="text-xs uppercase tracking-[0.3em] text-gray-300">Macro</span>
                                </div>
                                <p class="text-3xl font-bold text-white">
                                    <span id="diet-total-${macro.key}">0</span><span class="text-base font-semibold text-gray-400"> g</span>
                                </p>
                                <p class="text-xs text-gray-400">Objetivo <span id="diet-goal-${macro.key}">0</span> g</p>
                                <div class="h-2.5 w-full overflow-hidden rounded-full ${macro.meter}">
                                    <div id="diet-${macro.key}-bar" class="h-full rounded-full bg-gradient-to-r ${macro.bar}" style="width: 0%;"></div>
                                </div>
                                <p id="diet-${macro.key}-remaining" class="text-xs text-gray-400">Añade comida para calcularlo.</p>
                            </div>
                        `).join('');
                        macroContainer.innerHTML = macroTemplate;
                    }

                    setText('diet-goal-calories', Math.round(caloriesGoal));
                    setText('diet-total-calories', consumedCalories);

                    const progressLabel = document.getElementById('diet-today-progress-label');
                    if (progressLabel) {
                        progressLabel.textContent = caloriesGoal > 0 ? `${consumedPercent}% del objetivo` : 'Define tu objetivo calórico';
                    }
                    const progressValue = Math.max(0, Math.min(consumedPercent, 110));
                    const progressBar = document.getElementById('diet-progress-bar');
                    if (progressBar) progressBar.style.width = `${progressValue}%`;
                    const progressTextEl = document.getElementById('diet-total-calories-progress');
                    if (progressTextEl) progressTextEl.textContent = consumedPercent;

                    const statusEl = document.getElementById('diet-today-status');
                    if (statusEl) {
                        statusEl.className = `text-xs font-semibold uppercase tracking-[0.3em] ${statusClass}`;
                        statusEl.textContent = statusLabel;
                    }

                    const deltaEl = document.getElementById('diet-today-delta');
                    if (deltaEl) {
                        deltaEl.className = `mt-2 text-sm ${deltaClass}`;
                        deltaEl.textContent = deltaText;
                    }

                    const planCoverageEl = document.getElementById('diet-plan-coverage');
                    if (planCoverageEl) planCoverageEl.textContent = planCoverageText;
                    const planDiffEl = document.getElementById('diet-plan-diff');
                    if (planDiffEl) {
                        planDiffEl.className = `font-semibold ${planDiffClass}`;
                        planDiffEl.textContent = planDiffText;
                    }

                    const mealProgressEl = document.getElementById('diet-today-meal-progress');
                    if (mealProgressEl) mealProgressEl.textContent = mealProgressText;
                    const checkinsEl = document.getElementById('diet-today-checkins');
                    if (checkinsEl) {
                        checkinsEl.className = `text-xs ${checkinsClass}`;
                        checkinsEl.textContent = checkinsText;
                    }
                    const nextMealEl = document.getElementById('diet-today-next-meal');
                    if (nextMealEl) {
                        nextMealEl.className = `text-sm ${nextMealClass}`;
                        nextMealEl.textContent = nextMealText;
                    }

                    const macrosData = [
                        { key: 'protein', consumed: consumedTotals.p, goal: goals.protein },
                        { key: 'carbs', consumed: consumedTotals.c, goal: goals.carbs },
                        { key: 'fats', consumed: consumedTotals.f, goal: goals.fats }
                    ];
                    macrosData.forEach(({ key, consumed, goal }) => {
                        const consumedValue = Math.round(consumed);
                        const goalValue = Math.round(toNumber(goal));
                        setText(`diet-total-${key}`, consumedValue);
                        setText(`diet-goal-${key}`, goalValue);

                        const percent = goalValue > 0 ? Math.round(Math.max(0, Math.min((consumed / goalValue) * 100, 150))) : 0;
                        const bar = document.getElementById(`diet-${key}-bar`);
                        if (bar) bar.style.width = `${Math.max(0, Math.min(percent, 110))}%`;

                        const remaining = goalValue - consumed;
                        const roundedRemaining = Math.round(remaining);
                        let remainingText = goalValue > 0 ? 'Meta cubierta por hoy.' : 'Define tu objetivo para calcularlo.';
                        let remainingClass = goalValue > 0 ? 'text-emerald-200/80' : 'text-gray-400';
                        if (goalValue > 0) {
                            if (Math.abs(roundedRemaining) < 1) {
                                remainingText = 'Meta cubierta por hoy.';
                                remainingClass = 'text-emerald-200/80';
                            } else if (roundedRemaining > 0) {
                                remainingText = `Restan ${roundedRemaining} g`;
                                remainingClass = 'text-emerald-200/80';
                            } else {
                                remainingText = `+${Math.abs(roundedRemaining)} g`;
                                remainingClass = 'text-amber-200/80';
                            }
                        }
                        const remainingEl = document.getElementById(`diet-${key}-remaining`);
                        if (remainingEl) {
                            remainingEl.className = `text-xs ${remainingClass}`;
                            remainingEl.textContent = remainingText;
                        }
                    });

                    setText('dashboard-goal-protein', `${Math.round(toNumber(goals.protein))} g`);
                    setText('dashboard-goal-carbs', `${Math.round(toNumber(goals.carbs))} g`);
                    setText('dashboard-goal-fats', `${Math.round(toNumber(goals.fats))} g`);
                    setText('dashboard-consumed-protein', Math.round(consumedTotals.p));
                    setText('dashboard-consumed-carbs', Math.round(consumedTotals.c));
                    setText('dashboard-consumed-fats', Math.round(consumedTotals.f));

                    const dashboardCalories = document.getElementById('dashboard-consumed-calories');
                    if (dashboardCalories) dashboardCalories.textContent = `${consumedCalories} Kcal`;
                    const dashboardProgressBar = document.getElementById('dashboard-progress-bar');
                    if (dashboardProgressBar) dashboardProgressBar.style.width = `${progressValue}%`;
                    const dashboardProgressText = document.getElementById('dashboard-progress-text');
                    if (dashboardProgressText) dashboardProgressText.textContent = consumedPercent;

                    if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                        lucide.createIcons();
                    }
                },

                renderFoodList(searchTerm = '', containerId = 'food-list') {
                    const container = document.getElementById(containerId);
                    if (!container) return;

                    const isClientEditor = containerId === 'client-food-list';
                    const action = isClientEditor ? 'client-diet-add-food-modal' : 'show-add-food-modal';
                    const foodSource = this.data.foodLibrary || [];
                    const term = searchTerm.toLowerCase().trim();

                    const overridesMap = this.data.foodOverrides || {};
                    const renderFoodCard = (item) => {
                        const isCustom = item.source === 'custom';
                        const isPredefined = item.source === 'predefined';
                        const overrideEntry = isPredefined ? (overridesMap[item.id] || overridesMap[String(item.id)] || {}) : {};
                        const hasOverride = isPredefined && Object.keys(overrideEntry).length > 0;
                        const image = item.imageUrl
                            ? `<img src="${item.imageUrl}" alt="${item.name}" class="h-full w-full object-cover">`
                            : `<div class="flex h-full w-full items-center justify-center bg-gray-900/60 text-gray-500"><i data-lucide="image-off" class="h-5 w-5"></i></div>`;
                        const macros = `<div class="grid gap-2 text-[11px] text-gray-300 sm:grid-cols-3">
                                <div class="flex items-center justify-between rounded-xl border border-white/10 bg-gray-900/60 px-3 py-2 text-blue-200">
                                    <span class="flex items-center gap-1"><i data-lucide="shield-half" class="h-3.5 w-3.5"></i>Proteína</span>
                                    <strong>${Math.round(item.p || 0)}g</strong>
                                </div>
                                <div class="flex items-center justify-between rounded-xl border border-white/10 bg-gray-900/60 px-3 py-2 text-yellow-200">
                                    <span class="flex items-center gap-1"><i data-lucide="wheat" class="h-3.5 w-3.5"></i>Carbs</span>
                                    <strong>${Math.round(item.c || 0)}g</strong>
                                </div>
                                <div class="flex items-center justify-between rounded-xl border border-white/10 bg-gray-900/60 px-3 py-2 text-rose-200">
                                    <span class="flex items-center gap-1"><i data-lucide="droplets" class="h-3.5 w-3.5"></i>Grasas</span>
                                    <strong>${Math.round(item.f || 0)}g</strong>
                                </div>
                            </div>`;
                        const badges = [];
                        if (isPredefined && item.category) {
                            badges.push(`<span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2 py-0.5 font-semibold uppercase tracking-[0.35em] text-[10px] text-gray-200">${item.category}</span>`);
                        }
                        if (isCustom) {
                            badges.push(`<span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-400/10 px-2 py-0.5 font-semibold uppercase tracking-[0.35em] text-[10px] text-emerald-200"><i data-lucide="star" class="h-3 w-3"></i>Personal</span>`);
                        }
                        if (hasOverride) {
                            badges.push(`<span class="inline-flex items-center gap-1 rounded-full border border-amber-400/40 bg-amber-500/10 px-2 py-0.5 font-semibold uppercase tracking-[0.35em] text-[10px] text-amber-200"><i data-lucide="sparkles" class="h-3 w-3"></i>Editado</span>`);
                        }
                        const badgesMarkup = badges.length ? `<div class="flex flex-wrap items-center gap-2 text-[10px] text-gray-300">${badges.join('')}</div>` : '';
                        const addButton = `<button data-action="${action}" data-food-id="${item.id}" class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 text-gray-900 shadow-lg shadow-emerald-400/30 transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                        <i data-lucide="plus" class="h-4 w-4"></i>
                                    </button>`;
                        const isAdmin = this.isAsesor();
                        let adminControls = '';
                        if (isAdmin) {
                            const editBtn = `<button data-action="client-diet-edit-food-modal" data-food-id="${item.id}" class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-amber-400/40 bg-amber-500/10 text-amber-200 transition hover:border-amber-300 hover:bg-amber-500/20">
                                    <i data-lucide="pencil" class="h-4 w-4"></i>
                                </button>`;
                            const deleteAction = isCustom ? 'confirm-delete-custom-food' : 'confirm-delete-predefined-food';
                            const deleteBtn = `<button data-action="${deleteAction}" data-food-id="${item.id}" data-storage-path="${item.storagePath || ''}" class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-rose-400/40 bg-rose-500/10 text-rose-200 transition hover:border-rose-300 hover:bg-rose-500/20">
                                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                                </button>`;
                            adminControls = `<div class="flex items-center gap-2">${editBtn}${deleteBtn}</div>`;
                        }
                        const actionsStack = isAdmin
                            ? `<div class="flex flex-col items-end gap-2">${adminControls}${addButton}</div>`
                            : `<div class="flex items-center justify-end">${addButton}</div>`;

                        return `<div class="group flex gap-4 rounded-2xl border border-white/10 bg-white/5 p-4 transition hover:border-emerald-400/40">
                                <div class="h-16 w-16 overflow-hidden rounded-xl border border-white/10 bg-gray-900/60 flex-shrink-0">${image}</div>
                                <div class="min-w-0 flex-1 space-y-3">
                                    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                                        <div class="min-w-0 space-y-1">
                                            <p class="truncate text-sm font-semibold text-white">${item.name}</p>
                                            <p class="text-xs text-gray-400">${Math.round(item.cals || 0)} kcal · por 100g</p>
                                            ${badgesMarkup}
                                        </div>
                                        ${actionsStack}
                                    </div>
                                    ${macros}
                                </div>
                            </div>`;
                    };

                    const sortByName = (arr) => arr.slice().sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));

                    if (term) {
                        const results = foodSource.filter(item => item.name.toLowerCase().includes(term));
                        container.innerHTML = results.length > 0
                            ? results.sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' })).map(renderFoodCard).join('')
                            : `<div class="rounded-2xl border border-dashed border-white/15 bg-white/5 p-6 text-center text-sm text-gray-400">No se encontraron alimentos que coincidan con tu búsqueda.</div>`;
                        lucide.createIcons();
                        return;
                    }

                    const grouped = foodSource.reduce((acc, item) => {
                        const categoryKey = item.source === 'custom' ? 'Mis Alimentos' : (item.category || 'Otros');
                        if (!acc[categoryKey]) {
                            acc[categoryKey] = [];
                        }
                        acc[categoryKey].push(item);
                        return acc;
                    }, {});

                    const categoryOrder = ['Mis Alimentos', ...Object.keys(this.data.foodDatabase), ...Object.keys(grouped)];
                    const seenCategories = new Set();
                    const sections = categoryOrder
                        .filter(category => {
                            if (seenCategories.has(category)) {
                                return false;
                            }
                            const items = grouped[category];
                            if (!items || items.length === 0) {
                                return false;
                            }
                            seenCategories.add(category);
                            return true;
                        })
                        .map(category => {
                            const items = sortByName(grouped[category] || []);
                            return `<details class="group overflow-hidden rounded-2xl border border-white/10 bg-white/5 transition" ${category === 'Mis Alimentos' ? 'open' : ''}>
                                    <summary class="flex cursor-pointer items-center justify-between gap-3 px-4 py-3 text-sm font-semibold text-white">
                                        <span>${category}</span>
                                        <i data-lucide="chevron-down" class="h-4 w-4 transition-transform group-open:rotate-180"></i>
                                    </summary>
                                    <div class="space-y-3 border-t border-white/10 bg-gray-900/40 px-4 py-3">
                                        ${items.map(renderFoodCard).join('')}
                                    </div>
                                </details>`;
                        })
                        .join('');

                    container.innerHTML = sections || `<div class="rounded-2xl border border-dashed border-white/15 bg-white/5 p-6 text-center text-sm text-gray-400">Aún no hay alimentos en la biblioteca.</div>`;
                    lucide.createIcons();
                },
                
                renderWeeklyProgress() {
                    const container = document.getElementById('weekly-progress-card');
                    if (!container) return;

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const startOfWeek = new Date(today);
                    const weekday = today.getDay();
                    startOfWeek.setDate(today.getDate() - (weekday === 0 ? 6 : weekday - 1));

                    const dayLetters = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
                    let weekHTML = '';
                    let completedCount = 0;

                    for (let i = 0; i < 7; i++) {
                        const currentDate = new Date(startOfWeek);
                        currentDate.setDate(startOfWeek.getDate() + i);
                        const dateString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                        const dayEntries = Array.isArray(this.state.workoutHistory?.[dateString]) ? this.state.workoutHistory[dateString] : [];
                        const isCompleted = dayEntries.length > 0;
                        const isToday = currentDate.getTime() === today.getTime();
                        if (isCompleted) completedCount++;
                        const dayNumber = currentDate.getDate();
                        const circleClass = isCompleted ? 'bg-emerald-400 text-gray-900 shadow-lg shadow-emerald-500/40' : 'bg-gray-800 text-gray-200';
                        const ringClass = isToday ? 'ring-2 ring-emerald-300/80 ring-offset-2 ring-offset-gray-900' : '';
                        const statusContent = isCompleted ? '<i data-lucide="check" class="h-4 w-4"></i>' : `<span class="text-sm font-semibold">${dayNumber}</span>`;
                        weekHTML += `
                            <div class="flex flex-col items-center gap-1">
                                <span class="text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-400">${dayLetters[i]}</span>
                                <span class="flex h-10 w-10 items-center justify-center rounded-full ${circleClass} ${ringClass}">${statusContent}</span>
                            </div>
                        `;
                    }

                    const historyEntries = this.getWorkoutHistoryEntries();
                    let statsHtml = '';
                    if (historyEntries.length > 0) {
                        const lastWorkout = historyEntries[0];
                        const formattedDate = new Date(lastWorkout.completedAt || `${lastWorkout.date}T00:00:00`).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                        const intlFormatter = new Intl.NumberFormat('es-ES');
                        statsHtml = `
                            <div class="rounded-3xl border border-white/10 bg-white/5 p-4">
                                <div class="flex items-start justify-between gap-3">
                                    <div>
                                        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Último entrenamiento</p>
                                        <p class="mt-1 text-sm font-semibold text-white">${lastWorkout.routineName}</p>
                                        <p class="text-xs text-gray-400 capitalize">${formattedDate}</p>
                                    </div>
                                    <div class="text-right text-sm text-gray-200">
                                        <p class="font-semibold">${this.formatTime(lastWorkout.totalDuration)}</p>
                                        <p class="text-xs text-gray-400">${intlFormatter.format(Math.round(lastWorkout.totalVolume || 0))} kg·reps</p>
                                    </div>
                                </div>
                                <button data-action="show-workout-history" class="mt-4 inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.35em] text-emerald-300 transition hover:text-emerald-200">
                                    Ver historial
                                    <i data-lucide="arrow-up-right" class="h-4 w-4"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        statsHtml = `
                            <div class="rounded-3xl border border-dashed border-white/15 bg-white/5 p-4 text-center text-sm text-gray-400">
                                <p>Completa tu primer entrenamiento para ver estadísticas detalladas aquí.</p>
                                <button data-action="show-section" data-section-id="rutinas" class="mt-4 inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-gray-900 transition hover:bg-emerald-400">
                                    <i data-lucide="play" class="h-4 w-4"></i>
                                    Ir a rutinas
                                </button>
                            </div>
                        `;
                    }

                    container.innerHTML = `
                        <div class="flex flex-col gap-5">
                            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Actividad semanal</p>
                                    <h3 class="text-xl font-bold text-white">Seguimiento de entrenamientos</h3>
                                </div>
                                <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-gray-200">
                                    <i data-lucide="calendar-check" class="h-4 w-4"></i>
                                    ${completedCount} / 7 días
                                </span>
                            </div>
                            <div class="grid grid-cols-7 gap-2">${weekHTML}</div>
                            ${statsHtml}
                        </div>
                    `;
                    lucide.createIcons();
                },
                refreshDashboardCoverControls() {
                    const hasImage = Boolean(this.state.dashboardCover?.image);
                    const uploadBtn = document.querySelector('button[data-action="open-cover-upload"]');
                    if (uploadBtn) {
                        uploadBtn.disabled = this._isUploadingDashboardCover;
                        uploadBtn.setAttribute('aria-disabled', this._isUploadingDashboardCover ? 'true' : 'false');
                        uploadBtn.classList.toggle('opacity-50', this._isUploadingDashboardCover);
                        uploadBtn.classList.toggle('cursor-not-allowed', this._isUploadingDashboardCover);
                    }

                    const removeBtn = document.querySelector('button[data-action="remove-cover-image"]');
                    if (removeBtn) {
                        const shouldDisableRemove = this._isUploadingDashboardCover || !hasImage;
                        removeBtn.disabled = shouldDisableRemove;
                        removeBtn.setAttribute('aria-disabled', shouldDisableRemove ? 'true' : 'false');
                        removeBtn.classList.toggle('opacity-40', !hasImage);
                        removeBtn.classList.toggle('cursor-not-allowed', shouldDisableRemove);
                    }

                    const input = document.getElementById('dashboard-cover-input');
                    if (input) {
                        input.disabled = this._isUploadingDashboardCover;
                    }
                },
                updateCoverPreview() {
                    const preview = document.getElementById('dashboard-cover-preview');
                    const placeholder = document.getElementById('dashboard-cover-placeholder');
                    if (!preview || !placeholder) return;

                    const imageData = this.state.dashboardCover?.image;

                    if (imageData) {
                        preview.src = imageData;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    } else {
                        preview.src = '';
                        preview.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                    }

                    this.refreshDashboardCoverControls();
                },
                refreshRoutineBannerControls() {
                    const card = document.getElementById('routine-admin-banner-card');
                    const isAdmin = this.isAsesor();
                    if (card) {
                        card.classList.toggle('hidden', !isAdmin);
                    }
                    if (!isAdmin) {
                        return;
                    }

                    const hasImage = Boolean(this.state.routineBanner?.image);
                    const uploadBtn = card?.querySelector('button[data-action="open-routine-banner-upload"]');
                    if (uploadBtn) {
                        uploadBtn.disabled = this._isUploadingRoutineBanner;
                        uploadBtn.setAttribute('aria-disabled', this._isUploadingRoutineBanner ? 'true' : 'false');
                        uploadBtn.classList.toggle('opacity-50', this._isUploadingRoutineBanner);
                        uploadBtn.classList.toggle('cursor-not-allowed', this._isUploadingRoutineBanner);
                    }

                    const removeBtn = card?.querySelector('button[data-action="remove-routine-banner-image"]');
                    if (removeBtn) {
                        const shouldDisableRemove = this._isUploadingRoutineBanner || !hasImage;
                        removeBtn.disabled = shouldDisableRemove;
                        removeBtn.setAttribute('aria-disabled', shouldDisableRemove ? 'true' : 'false');
                        removeBtn.classList.toggle('opacity-40', !hasImage);
                        removeBtn.classList.toggle('cursor-not-allowed', shouldDisableRemove);
                    }

                    const input = document.getElementById('routine-banner-input');
                    if (input) {
                        input.disabled = this._isUploadingRoutineBanner;
                    }
                },
                updateRoutineBannerPreview() {
                    const card = document.getElementById('routine-admin-banner-card');
                    const isAdmin = this.isAsesor();
                    if (card) {
                        card.classList.toggle('hidden', !isAdmin);
                    }
                    if (!isAdmin) return;

                    const preview = document.getElementById('routine-admin-banner-preview');
                    const skeleton = document.getElementById('routine-admin-banner-skeleton');
                    const fallback = document.getElementById('routine-admin-banner-fallback');
                    if (!preview || !skeleton || !fallback) {
                        this.refreshRoutineBannerControls();
                        return;
                    }

                    const imageData = this.state.routineBanner?.image;
                    if (imageData) {
                        fallback.classList.add('hidden');
                        fallback.classList.remove('flex');
                        skeleton.classList.remove('is-hidden');
                        preview.dataset.pendingSrc = imageData;
                        this.preloadImage(imageData, { priority: 'high' }).then((success) => {
                            if (!preview || preview.dataset.pendingSrc !== imageData) return;
                            if (success) {
                                preview.src = imageData;
                                preview.classList.remove('hidden');
                                requestAnimationFrame(() => {
                                    preview.classList.remove('opacity-0');
                                    preview.classList.add('opacity-100');
                                });
                                skeleton.classList.add('is-hidden');
                            } else {
                                preview.src = '';
                                preview.classList.add('hidden');
                                preview.classList.add('opacity-0');
                                preview.classList.remove('opacity-100');
                                fallback.classList.remove('hidden');
                                if (!fallback.classList.contains('flex')) {
                                    fallback.classList.add('flex');
                                }
                                skeleton.classList.add('is-hidden');
                            }
                        });
                    } else {
                        preview.dataset.pendingSrc = '';
                        preview.src = '';
                        preview.classList.add('hidden');
                        preview.classList.add('opacity-0');
                        preview.classList.remove('opacity-100');
                        fallback.classList.remove('hidden');
                        if (!fallback.classList.contains('flex')) {
                            fallback.classList.add('flex');
                        }
                        skeleton.classList.add('is-hidden');
                    }

                    this.refreshRoutineBannerControls();
                },
                triggerRoutineBannerUpload() {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede actualizar el banner de rutinas.', 'error');
                        return;
                    }
                    if (this._isUploadingRoutineBanner) {
                        this.showToast('Espera a que termine la subida en curso.', 'error');
                        return;
                    }
                    const input = document.getElementById('routine-banner-input');
                    if (input) {
                        input.click();
                    }
                },
                async deleteRoutineBannerFromStorage() {
                    const storagePath = this.state.routineBanner?.storagePath;
                    if (!storagePath) return;
                    try {
                        const fileRef = ref(this.storage, storagePath);
                        await deleteObject(fileRef);
                    } catch (error) {
                        console.warn('No se pudo eliminar el banner anterior del almacenamiento:', error);
                    }
                },
                async handleRoutineBannerFileChange(input) {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede actualizar el banner de rutinas.', 'error');
                        if (input) input.value = '';
                        return;
                    }
                    if (!input || !input.files || input.files.length === 0) return;
                    if (this._isUploadingRoutineBanner) {
                        this.showToast('Ya hay una subida en curso.', 'error');
                        input.value = '';
                        return;
                    }

                    const file = input.files[0];
                    if (!file.type.startsWith('image/')) {
                        this.showToast('Selecciona una imagen válida.', 'error');
                        input.value = '';
                        return;
                    }
                    const maxSize = 5 * 1024 * 1024;
                    if (file.size > maxSize) {
                        this.showToast('La imagen debe pesar menos de 5MB.', 'error');
                        input.value = '';
                        return;
                    }

                    const progressContainer = document.getElementById('routine-banner-progress');
                    const progressBar = document.getElementById('routine-banner-progress-bar');
                    const progressText = document.getElementById('routine-banner-progress-text');

                    const clearProgressTimeout = () => {
                        if (this._routineBannerProgressTimeout) {
                            clearTimeout(this._routineBannerProgressTimeout);
                            this._routineBannerProgressTimeout = null;
                        }
                    };

                    clearProgressTimeout();

                    if (progressContainer) {
                        progressContainer.classList.remove('hidden');
                        progressContainer.classList.add('flex');
                    }
                    if (progressBar) {
                        progressBar.style.width = '0%';
                    }
                    if (progressText) {
                        progressText.textContent = 'Iniciando subida...';
                    }

                    this.state.routineBanner = this.state.routineBanner || { image: '', storagePath: '', updatedAt: null };

                    this._isUploadingRoutineBanner = true;
                    this.refreshRoutineBannerControls();

                    const sanitizedName = file.name.replace(/[^a-zA-Z0-9_.-]/g, '_');
                    const filePath = `routine_banners/${this.state.currentUser?.uid || 'coach'}/${Date.now()}-${sanitizedName}`;
                    const storageRef = ref(this.storage, filePath);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    if (progressText) {
                        progressText.textContent = 'Subiendo... 0%';
                    }

                    const hideProgress = (delay = 0) => {
                        if (!progressContainer) return;
                        clearProgressTimeout();
                        this._routineBannerProgressTimeout = setTimeout(() => {
                            progressContainer.classList.add('hidden');
                            progressContainer.classList.remove('flex');
                            if (progressBar) {
                                progressBar.style.width = '0%';
                            }
                            if (progressText) {
                                progressText.textContent = 'Preparando...';
                            }
                            this._routineBannerProgressTimeout = null;
                        }, delay);
                    };

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = snapshot.totalBytes ? (snapshot.bytesTransferred / snapshot.totalBytes) * 100 : 0;
                            if (progressBar) {
                                progressBar.style.width = `${progress}%`;
                            }
                            if (progressText) {
                                progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                            }
                        },
                        (error) => {
                            console.error('Error al subir el banner:', error);
                            this.showToast('No se pudo subir el banner.', 'error');
                            if (progressText) {
                                progressText.textContent = 'Error al subir';
                            }
                            hideProgress(2000);
                            this._isUploadingRoutineBanner = false;
                            this.refreshRoutineBannerControls();
                            input.value = '';
                        },
                        async () => {
                            try {
                                await this.deleteRoutineBannerFromStorage();
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                this.state.routineBanner = {
                                    image: downloadURL,
                                    storagePath: filePath,
                                    updatedAt: Date.now()
                                };
                                this.updateRoutineBannerPreview();
                                if (progressBar) {
                                    progressBar.style.width = '100%';
                                }
                                if (progressText) {
                                    progressText.textContent = 'Subida completa 100%';
                                }
                                await this.saveDataToFirestore();
                                this.showToast('Banner actualizado.');
                                hideProgress(1500);
                            } catch (error) {
                                console.error('Error al finalizar la subida del banner:', error);
                                this.showToast('No se pudo procesar el banner.', 'error');
                                if (progressText) {
                                    progressText.textContent = 'Error al finalizar';
                                }
                                hideProgress(2000);
                            } finally {
                                this._isUploadingRoutineBanner = false;
                                this.refreshRoutineBannerControls();
                                input.value = '';
                            }
                        }
                    );
                },
                async removeRoutineBannerImage() {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede modificar el banner.', 'error');
                        return;
                    }
                    if (!this.state.routineBanner || !this.state.routineBanner.image) {
                        return;
                    }
                    if (this._isUploadingRoutineBanner) {
                        this.showToast('Espera a que termine la subida antes de eliminar.', 'error');
                        return;
                    }
                    await this.deleteRoutineBannerFromStorage();
                    this.state.routineBanner.image = '';
                    this.state.routineBanner.storagePath = '';
                    this.state.routineBanner.updatedAt = null;
                    this.updateRoutineBannerPreview();
                    const input = document.getElementById('routine-banner-input');
                    if (input) input.value = '';
                    await this.saveDataToFirestore();
                    this.showToast('Banner eliminado.');
                },
                triggerCoverUpload() {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede actualizar la portada del panel.', 'error');
                        return;
                    }
                    const input = document.getElementById('dashboard-cover-input');
                    if (this._isUploadingDashboardCover) {
                        this.showToast('Espera a que termine la subida en curso.', 'error');
                        return;
                    }
                    if (input) {
                        input.click();
                    }
                },
                async deleteDashboardCoverFromStorage() {
                    const storagePath = this.state.dashboardCover?.storagePath;
                    if (!storagePath) return;
                    try {
                        const fileRef = ref(this.storage, storagePath);
                        await deleteObject(fileRef);
                    } catch (error) {
                        console.warn('No se pudo eliminar la portada anterior del almacenamiento:', error);
                    }
                },
                async handleCoverFileChange(input) {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede actualizar la portada del panel.', 'error');
                        if (input) input.value = '';
                        return;
                    }
                    if (!input || !input.files || input.files.length === 0) return;
                    if (this._isUploadingDashboardCover) {
                        this.showToast('Ya hay una subida en curso.', 'error');
                        input.value = '';
                        return;
                    }
                    const file = input.files[0];
                    if (!file.type.startsWith('image/')) {
                        this.showToast('Por favor selecciona una imagen válida.', 'error');
                        input.value = '';
                        return;
                    }
                    const maxSize = 5 * 1024 * 1024;
                    if (file.size > maxSize) {
                        this.showToast('La imagen debe pesar menos de 5MB.', 'error');
                        input.value = '';
                        return;
                    }

                    const progressContainer = document.getElementById('dashboard-cover-progress');
                    const progressBar = document.getElementById('dashboard-cover-progress-bar');
                    const progressText = document.getElementById('dashboard-cover-progress-text');

                    const clearProgressTimeout = () => {
                        if (this._dashboardCoverProgressTimeout) {
                            clearTimeout(this._dashboardCoverProgressTimeout);
                            this._dashboardCoverProgressTimeout = null;
                        }
                    };

                    clearProgressTimeout();

                    if (progressContainer) {
                        progressContainer.classList.remove('hidden');
                        progressContainer.classList.add('flex');
                    }
                    if (progressBar) {
                        progressBar.style.width = '0%';
                    }
                    if (progressText) {
                        progressText.textContent = 'Iniciando subida...';
                    }

                    this.state.dashboardCover = this.state.dashboardCover || { image: '', storagePath: '', updatedAt: null };

                    this._isUploadingDashboardCover = true;
                    this.refreshDashboardCoverControls();

                    const sanitizedName = file.name.replace(/[^a-zA-Z0-9_.-]/g, '_');
                    const filePath = `dashboard_covers/${this.state.currentUser?.uid || 'anonimo'}/${Date.now()}-${sanitizedName}`;
                    const storageRef = ref(this.storage, filePath);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    if (progressText) {
                        progressText.textContent = 'Subiendo... 0%';
                    }

                    const hideProgress = (delay = 0) => {
                        if (!progressContainer) return;
                        clearProgressTimeout();
                        this._dashboardCoverProgressTimeout = setTimeout(() => {
                            progressContainer.classList.add('hidden');
                            progressContainer.classList.remove('flex');
                            if (progressBar) {
                                progressBar.style.width = '0%';
                            }
                            if (progressText) {
                                progressText.textContent = 'Preparando...';
                            }
                            this._dashboardCoverProgressTimeout = null;
                        }, delay);
                    };

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = snapshot.totalBytes ? (snapshot.bytesTransferred / snapshot.totalBytes) * 100 : 0;
                            if (progressBar) {
                                progressBar.style.width = `${progress}%`;
                            }
                            if (progressText) {
                                progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                            }
                        },
                        (error) => {
                            console.error('Error al subir la portada:', error);
                            this.showToast('No se pudo subir la portada.', 'error');
                            if (progressText) {
                                progressText.textContent = 'Error al subir';
                            }
                            hideProgress(2000);
                            this._isUploadingDashboardCover = false;
                            this.refreshDashboardCoverControls();
                            input.value = '';
                        },
                        async () => {
                            try {
                                await this.deleteDashboardCoverFromStorage();
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                this.state.dashboardCover = {
                                    image: downloadURL,
                                    storagePath: filePath,
                                    updatedAt: Date.now()
                                };
                                this.updateCoverPreview();
                                if (progressBar) {
                                    progressBar.style.width = '100%';
                                }
                                if (progressText) {
                                    progressText.textContent = 'Subida completa 100%';
                                }
                                await this.saveDataToFirestore();
                                this.showToast('Portada actualizada.');
                                hideProgress(1500);
                            } catch (error) {
                                console.error('Error al finalizar la subida:', error);
                                this.showToast('No se pudo procesar la portada subida.', 'error');
                                if (progressText) {
                                    progressText.textContent = 'Error al finalizar';
                                }
                                hideProgress(2000);
                            } finally {
                                this._isUploadingDashboardCover = false;
                                this.refreshDashboardCoverControls();
                                input.value = '';
                            }
                        }
                    );
                },
                async removeCoverImage() {
                    if (!this.state.dashboardCover || !this.state.dashboardCover.image) {
                        return;
                    }
                    if (this._isUploadingDashboardCover) {
                        this.showToast('Espera a que termine la subida antes de eliminar.', 'error');
                        return;
                    }
                    await this.deleteDashboardCoverFromStorage();
                    this.state.dashboardCover.image = '';
                    this.state.dashboardCover.storagePath = '';
                    this.state.dashboardCover.updatedAt = null;
                    this.updateCoverPreview();
                    const input = document.getElementById('dashboard-cover-input');
                    if (input) input.value = '';
                    await this.saveDataToFirestore();
                    this.showToast('Portada eliminada.');
                },
                renderWorkoutHistorySection() {
                    const overviewContainer = document.getElementById('history-overview');
                    const cardsContainer = document.getElementById('history-cards');
                    const section = document.getElementById('historial');
                    if (!overviewContainer || !cardsContainer || !section) return;

                    const entries = this.getWorkoutHistoryEntries();
                    const intlFormatter = new Intl.NumberFormat('es-ES');

                    if (entries.length === 0) {
                        overviewContainer.innerHTML = `
                            <div class="rounded-3xl border border-dashed border-white/15 bg-white/5 p-6 text-center text-gray-400">
                                <i data-lucide="activity" class="mx-auto mb-3 h-8 w-8 text-emerald-300/80"></i>
                                <p class="font-semibold">Aún no hay entrenamientos registrados.</p>
                                <p class="mt-1 text-xs text-gray-500">Inicia una rutina para comenzar a construir tu historial.</p>
                            </div>
                        `;
                        cardsContainer.innerHTML = `
                            <div class="rounded-3xl border border-white/10 bg-gray-900/60 p-6 text-center text-sm text-gray-400">
                                <p>Cuando completes tus sesiones verás aquí tarjetas con tus métricas, pesos y progresos por fecha.</p>
                                <button data-action="show-section" data-section-id="rutinas" class="mt-4 inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-gray-900 transition hover:bg-emerald-400">
                                    <i data-lucide="play" class="h-4 w-4"></i>
                                    Comenzar una rutina
                                </button>
                            </div>
                        `;
                        lucide.createIcons();
                        return;
                    }

                    const totalSessions = entries.length;
                    const totalActiveSeconds = entries.reduce((sum, entry) => sum + (entry.totalActive || 0), 0);
                    const totalVolume = entries.reduce((sum, entry) => sum + (entry.totalVolume || 0), 0);
                    const bestOneRepMax = entries.reduce((max, entry) => {
                        const entryPeak = entry.peakOneRepMax || (entry.exerciseDetails || []).reduce((peak, ex) => Math.max(peak, ex.estimated1RM || 0), 0);
                        return Math.max(max, entryPeak || 0);
                    }, 0);
                    const latestWeightEntry = (this.state.weightLog || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date))[0] || null;

                    overviewContainer.innerHTML = `
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                            <div class="flex items-center gap-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-200"><i data-lucide="trophy" class="h-5 w-5"></i></span>
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Sesiones totales</p>
                                    <p class="text-2xl font-bold text-white">${intlFormatter.format(totalSessions)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                            <div class="flex items-center gap-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-sky-500/20 text-sky-200"><i data-lucide="timer" class="h-5 w-5"></i></span>
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Tiempo activo</p>
                                    <p class="text-2xl font-bold text-white">${this.formatTime(totalActiveSeconds)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                            <div class="flex items-center gap-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/20 text-amber-200"><i data-lucide="bar-chart" class="h-5 w-5"></i></span>
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Volumen total</p>
                                    <p class="text-2xl font-bold text-white">${intlFormatter.format(Math.round(totalVolume))} kg·reps</p>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                            <div class="flex items-center gap-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-purple-500/20 text-purple-200"><i data-lucide="line-chart" class="h-5 w-5"></i></span>
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">1RM más alto</p>
                                    <p class="text-2xl font-bold text-white">${bestOneRepMax ? `${bestOneRepMax.toFixed(1)} kg` : '—'}</p>
                                    <p class="text-[10px] text-gray-400">Peso actual: ${latestWeightEntry ? `${parseFloat(latestWeightEntry.weight).toFixed(1)} kg` : 'registra tu peso'}</p>
                                </div>
                            </div>
                        </div>
                    `;

                    const groupedByDate = entries.reduce((acc, entry) => {
                        const dateKey = entry.date || (entry.completedAt ? entry.completedAt.split('T')[0] : '');
                        if (!dateKey) return acc;
                        if (!acc[dateKey]) acc[dateKey] = [];
                        acc[dateKey].push(entry);
                        return acc;
                    }, {});

                    const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
                    const weightLogMap = (this.state.weightLog || []).reduce((map, entry) => {
                        if (entry && entry.date) {
                            map[entry.date] = parseFloat(entry.weight);
                        }
                        return map;
                    }, {});

                    const cardsHtml = sortedDates.map(dateKey => {
                        const sessions = groupedByDate[dateKey].slice().sort((a, b) => new Date(b.completedAt || 0) - new Date(a.completedAt || 0));
                        const dateLabel = new Date(`${dateKey}T00:00:00`).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                        const weightLabel = weightLogMap[dateKey] ? `${weightLogMap[dateKey].toFixed(1)} kg` : '—';
                        const dayDuration = sessions.reduce((sum, session) => sum + (session.totalDuration || 0), 0);
                        const dayActive = sessions.reduce((sum, session) => sum + (session.totalActive || 0), 0);
                        const dayRest = sessions.reduce((sum, session) => sum + (session.totalRest || Math.max(0, (session.totalDuration || 0) - (session.totalActive || 0))), 0);
                        const dayVolume = sessions.reduce((sum, session) => sum + (session.totalVolume || 0), 0);
                        const dayPeakOneRm = sessions.reduce((max, session) => {
                            const sessionPeak = session.peakOneRepMax || (session.exerciseDetails || []).reduce((peak, ex) => Math.max(peak, ex.estimated1RM || 0), 0);
                            return Math.max(max, sessionPeak || 0);
                        }, 0);

                        const sessionItems = sessions.map(session => {
                            const timeLabel = session.completedAt ? new Date(session.completedAt).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                            const highlightExercise = (session.exerciseDetails || []).reduce((best, ex) => {
                                const current = ex.estimated1RM || 0;
                                return current > ((best?.estimated1RM) || 0) ? ex : best;
                            }, null);
                            const highlightName = highlightExercise ? highlightExercise.name : null;
                            const highlightWeight = highlightExercise?.bestWeight;
                            const highlightOneRM = highlightExercise?.estimated1RM;

                            return `
                                <article class="rounded-2xl border border-white/10 bg-gray-900/60 p-4">
                                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                        <div>
                                            <p class="text-sm font-semibold text-white">${session.routineName}</p>
                                            <p class="text-xs text-gray-400">${session.dayName || 'Sesión'}${timeLabel ? ` · ${timeLabel}` : ''}</p>
                                        </div>
                                        <div class="flex flex-wrap gap-2 text-xs text-gray-300">
                                            <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5"><i data-lucide="timer" class="h-3.5 w-3.5"></i>${this.formatTime(session.totalDuration || 0)}</span>
                                            <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2.5 py-0.5 text-emerald-100"><i data-lucide="flame" class="h-3.5 w-3.5"></i>${this.formatTime(session.totalActive || 0)}</span>
                                            <span class="inline-flex items-center gap-1 rounded-full border border-sky-400/40 bg-sky-500/10 px-2.5 py-0.5 text-sky-100"><i data-lucide="bar-chart" class="h-3.5 w-3.5"></i>${intlFormatter.format(Math.round(session.totalVolume || 0))} kg·reps</span>
                                        </div>
                                    </div>
                                    <div class="mt-3 flex flex-wrap gap-2 text-xs text-gray-300">
                                        ${highlightName ? `<span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5">Foco: ${highlightName}</span>` : '<span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5 text-gray-400">Registra pesos para ver 1RM estimados</span>'}
                                        ${highlightWeight ? `<span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2.5 py-0.5 text-emerald-100"><i data-lucide="dumbbell" class="h-3.5 w-3.5"></i>${highlightWeight} kg</span>` : ''}
                                        ${highlightOneRM ? `<span class="inline-flex items-center gap-1 rounded-full border border-purple-400/40 bg-purple-500/10 px-2.5 py-0.5 text-purple-100"><i data-lucide="line-chart" class="h-3.5 w-3.5"></i>${highlightOneRM.toFixed(1)} kg</span>` : ''}
                                    </div>
                                </article>
                            `;
                        }).join('');

                        return `
                            <article class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                                <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                                    <div>
                                        <p class="text-lg font-semibold text-white capitalize">${dateLabel}</p>
                                        <p class="text-xs text-gray-400">${sessions.length} ${sessions.length === 1 ? 'sesión' : 'sesiones'} · Peso corporal: ${weightLabel}</p>
                                    </div>
                                    <div class="flex flex-wrap gap-2 text-xs text-gray-300">
                                        <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5"><i data-lucide="clock" class="h-3.5 w-3.5"></i>${this.formatTime(dayDuration)}</span>
                                        <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2.5 py-0.5 text-emerald-100"><i data-lucide="flame" class="h-3.5 w-3.5"></i>${this.formatTime(dayActive)}</span>
                                        <span class="inline-flex items-center gap-1 rounded-full border border-indigo-400/40 bg-indigo-500/10 px-2.5 py-0.5 text-indigo-100"><i data-lucide="moon" class="h-3.5 w-3.5"></i>${this.formatTime(dayRest)}</span>
                                    </div>
                                </div>
                                <div class="mt-4 space-y-3">
                                    ${sessionItems}
                                </div>
                                <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                    <div class="flex flex-wrap gap-2 text-xs text-gray-300">
                                        <span class="inline-flex items-center gap-1 rounded-full border border-amber-400/40 bg-amber-500/10 px-2.5 py-0.5 text-amber-100"><i data-lucide="bar-chart-3" class="h-3.5 w-3.5"></i>${intlFormatter.format(Math.round(dayVolume))} kg·reps</span>
                                        <span class="inline-flex items-center gap-1 rounded-full border border-purple-400/40 bg-purple-500/10 px-2.5 py-0.5 text-purple-100"><i data-lucide="line-chart" class="h-3.5 w-3.5"></i>${dayPeakOneRm ? `${dayPeakOneRm.toFixed(1)} kg 1RM` : '1RM pendiente'}</span>
                                        <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5 text-gray-300"><i data-lucide="scale" class="h-3.5 w-3.5"></i>Peso: ${weightLabel}</span>
                                    </div>
                                    <button data-action="show-workout-history" data-history-date="${dateKey}" class="inline-flex items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-emerald-400/60 hover:text-white">
                                        Ver detalle
                                        <i data-lucide="chevron-right" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </article>
                        `;
                    }).join('');

                    cardsContainer.innerHTML = cardsHtml;
                    lucide.createIcons();
                },
                renderProfileSection() {
                    if (!this.state.currentUser) return;
                    const { userName, currentUser, physicalStats, targetWeight } = this.state;
                    const avatar = document.getElementById('profile-avatar');
                    if (avatar) {
                        this.applyProfilePhotoToAvatar(avatar);
                    }
                    const nameEl = document.getElementById('profile-name');
                    if (nameEl) nameEl.textContent = userName || 'Usuario';
                    const emailEl = document.getElementById('profile-email');
                    if (emailEl) emailEl.textContent = currentUser.email;

                    const historyEntries = this.getWorkoutHistoryEntries();
                    const totalWorkouts = historyEntries.length;
                    const totalDurationSeconds = historyEntries.reduce((acc, entry) => acc + (entry.totalDuration || 0), 0);
                    const totalHours = (totalDurationSeconds / 3600);

                    const workoutsEl = document.getElementById('profile-stat-workouts');
                    if (workoutsEl) workoutsEl.textContent = totalWorkouts;
                    const hoursEl = document.getElementById('profile-stat-hours');
                    if (hoursEl) hoursEl.textContent = totalHours.toFixed(1);
                    const streakEl = document.getElementById('profile-stat-streak');
                    if (streakEl) streakEl.textContent = this.calculateWorkoutStreak();

                    const weightLog = Array.isArray(this.state.weightLog) ? [...this.state.weightLog] : [];
                    weightLog.sort((a, b) => new Date(a.date) - new Date(b.date));
                    const lastEntry = weightLog.length ? weightLog[weightLog.length - 1] : null;
                    const firstEntry = weightLog.length ? weightLog[0] : null;

                    const formatDate = (dateStr, options = { day: 'numeric', month: 'short', year: 'numeric' }) => {
                        if (!dateStr) return '';
                        const dateObj = new Date(`${dateStr}T00:00:00`);
                        return dateObj.toLocaleDateString('es-ES', options);
                    };

                    const profileUpdateEl = document.getElementById('profile-last-update');
                    if (profileUpdateEl) {
                        profileUpdateEl.textContent = lastEntry
                            ? `Último registro: ${formatDate(lastEntry.date, { day: 'numeric', month: 'long', year: 'numeric' })}`
                            : 'Aún no has registrado tu peso. ¡Empieza hoy para seguir tu evolución!';
                    }
                    const weightLastEntryEl = document.getElementById('weight-last-entry');
                    if (weightLastEntryEl) {
                        weightLastEntryEl.textContent = lastEntry
                            ? `Último: ${formatDate(lastEntry.date)}`
                            : 'Sin registros previos';
                    }

                    const weightValue = typeof physicalStats.weight === 'number' ? physicalStats.weight : parseFloat(physicalStats.weight) || 0;
                    const goalWeight = typeof targetWeight === 'number' ? targetWeight : weightValue;
                    const diffValue = goalWeight && weightValue
                        ? (goalWeight - weightValue)
                        : 0;

                    const ageEl = document.getElementById('profile-info-age');
                    if (ageEl) ageEl.textContent = physicalStats.age ? `${physicalStats.age} años` : '--';
                    const heightEl = document.getElementById('profile-info-height');
                    if (heightEl) heightEl.textContent = physicalStats.height ? `${physicalStats.height} cm` : '--';
                    const weightInfoEl = document.getElementById('profile-info-weight');
                    if (weightInfoEl) weightInfoEl.textContent = weightValue ? `${weightValue.toFixed(1)} kg` : '--';
                    const activityEl = document.getElementById('profile-info-activity');
                    if (activityEl) {
                        const activityMap = {
                            '1.2': 'Sedentario',
                            '1.375': 'Ligero',
                            '1.55': 'Moderado',
                            '1.725': 'Activo',
                            '1.9': 'Muy activo'
                        };
                        const activityKey = physicalStats.activity ? physicalStats.activity.toString() : '';
                        const activityLabel = activityMap[activityKey] ? `${activityMap[activityKey]} · x${physicalStats.activity}` : (physicalStats.activity ? `x${physicalStats.activity}` : 'Sin definir');
                        activityEl.textContent = activityLabel;
                    }
                    const genderEl = document.getElementById('profile-info-gender');
                    if (genderEl) {
                        const genderLabel = physicalStats.gender === 'male'
                            ? 'Masculino'
                            : physicalStats.gender === 'female'
                                ? 'Femenino'
                                : 'Sin especificar';
                        genderEl.textContent = genderLabel;
                    }

                    const currentWeightEl = document.getElementById('current-weight-display');
                    if (currentWeightEl) currentWeightEl.textContent = weightValue ? weightValue.toFixed(1) : '--';
                    const targetWeightEl = document.getElementById('target-weight-display');
                    if (targetWeightEl) targetWeightEl.textContent = goalWeight ? goalWeight.toFixed(1) : '--';
                    const diffEl = document.getElementById('weight-diff-display');
                    if (diffEl) diffEl.textContent = `${diffValue > 0 ? '+' : ''}${diffValue.toFixed(1)}`;

                    let progressPercent = 0;
                    if (firstEntry && goalWeight && goalWeight !== firstEntry.weight) {
                        const goalDelta = goalWeight - firstEntry.weight;
                        if (goalDelta !== 0) {
                            progressPercent = ((weightValue - firstEntry.weight) / goalDelta) * 100;
                            progressPercent = Math.min(100, Math.max(0, progressPercent));
                        }
                    }
                    const progressBar = document.getElementById('weight-progress-bar');
                    if (progressBar) progressBar.style.width = `${Math.max(0, Math.min(100, progressPercent))}%`;
                    const progressLabel = document.getElementById('weight-progress-label');
                    if (progressLabel) progressLabel.textContent = `${Math.round(Math.max(0, Math.min(100, progressPercent)))}%`;

                    const trendEl = document.getElementById('weight-trend-label');
                    if (trendEl) {
                        if (firstEntry && lastEntry) {
                            const totalChange = lastEntry.weight - firstEntry.weight;
                            const dayDiff = Math.max(1, Math.round((new Date(`${lastEntry.date}T00:00:00`) - new Date(`${firstEntry.date}T00:00:00`)) / (1000 * 60 * 60 * 24)));
                            if (Math.abs(totalChange) < 0.05) {
                                trendEl.textContent = `Peso estable desde ${formatDate(firstEntry.date, { day: 'numeric', month: 'long' })}.`;
                            } else {
                                const direction = totalChange > 0 ? 'ganado' : 'perdido';
                                trendEl.textContent = `Has ${direction} ${Math.abs(totalChange).toFixed(1)} kg en ${dayDiff} día(s).`;
                            }
                        } else {
                            trendEl.textContent = 'Añade tu primer registro para visualizar la tendencia.';
                        }
                    }

                    const timelineContainer = document.getElementById('weight-log-list');
                    if (timelineContainer) {
                        if (weightLog.length) {
                            const recentEntries = [...weightLog].reverse().slice(0, 5);
                            timelineContainer.innerHTML = recentEntries.map((entry, index) => {
                                const previous = index < recentEntries.length - 1 ? recentEntries[index + 1] : null;
                                const delta = previous ? entry.weight - previous.weight : 0;
                                let deltaLabel = '—';
                                let deltaClass = 'text-gray-400';
                                if (previous) {
                                    deltaLabel = `${delta > 0 ? '+' : ''}${delta.toFixed(1)} kg`;
                                    if (delta > 0.05) deltaClass = 'text-amber-200';
                                    else if (delta < -0.05) deltaClass = 'text-emerald-200';
                                }
                                const isLatest = index === 0;
                                return `
                                    <div class="flex items-center justify-between rounded-2xl border border-white/10 bg-gray-900/70 px-4 py-3">
                                        <div>
                                            <p class="text-sm font-semibold text-white">${formatDate(entry.date)}</p>
                                            <p class="text-xs ${isLatest ? 'text-emerald-200/90' : 'text-gray-500'}">${isLatest ? 'Registro más reciente' : 'Seguimiento registrado'}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-lg font-bold text-white">${entry.weight.toFixed(1)}<span class="ml-1 text-sm text-emerald-100/80">kg</span></p>
                                            <p class="text-xs ${deltaClass}">${deltaLabel}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            timelineContainer.innerHTML = `<div class="rounded-2xl border border-dashed border-white/15 bg-white/5 px-4 py-6 text-center text-sm text-gray-400">Sin registros todavía. ¡Agrega tu primer peso para comenzar a visualizar la evolución!</div>`;
                        }
                    }

                    const chartContainer = document.getElementById('profile-activity-chart');
                    if (chartContainer) {
                        const weeklyData = this.getWeeklyActivityData();
                        const maxWorkouts = Math.max(...weeklyData.map(w => w.count), 1);
                        chartContainer.innerHTML = weeklyData.map(week => {
                            const barHeight = (week.count / maxWorkouts) * 100;
                            return `<div class="flex h-full w-1/4 flex-col items-center justify-end"><div class="flex h-full w-3/5 items-end"><div class="chart-bar w-full rounded-t-md bg-gradient-to-t from-emerald-500 via-teal-400 to-cyan-300" style="height: ${barHeight}%;"></div></div><p class="mt-2 text-sm font-bold text-white">${week.count}</p><p class="text-xs text-gray-400">${week.label}</p></div>`;
                        }).join('');
                    }

                    const bmiValueEl = document.getElementById('profile-bmi-value');
                    const bmiLabelEl = document.getElementById('profile-bmi-label');
                    const hydrationEl = document.getElementById('profile-hydration');
                    const idealWeightEl = document.getElementById('profile-ideal-weight');

                    if (physicalStats.height && weightValue) {
                        const heightInMeters = physicalStats.height / 100;
                        const bmi = weightValue / (heightInMeters * heightInMeters);
                        let bmiLabel = '';
                        if (bmi < 18.5) bmiLabel = 'Bajo peso';
                        else if (bmi < 25) bmiLabel = 'Saludable';
                        else if (bmi < 30) bmiLabel = 'Sobrepeso';
                        else bmiLabel = 'Obesidad';
                        if (bmiValueEl) bmiValueEl.textContent = bmi.toFixed(1);
                        if (bmiLabelEl) bmiLabelEl.textContent = bmiLabel;
                        if (hydrationEl) {
                            const waterLiters = (weightValue * 35) / 1000;
                            hydrationEl.textContent = `${waterLiters.toFixed(1)} L`; 
                        }
                        if (idealWeightEl) {
                            const idealMin = 18.5 * (heightInMeters * heightInMeters);
                            const idealMax = 24.9 * (heightInMeters * heightInMeters);
                            idealWeightEl.textContent = `${idealMin.toFixed(1)} - ${idealMax.toFixed(1)} kg`;
                        }
                    } else {
                        if (bmiValueEl) bmiValueEl.textContent = '--';
                        if (bmiLabelEl) bmiLabelEl.textContent = '';
                        if (hydrationEl) hydrationEl.textContent = '--';
                        if (idealWeightEl) idealWeightEl.textContent = '--';
                    }

                    this.updateDietWeightInfo();
                },
                calculateWorkoutStreak() {
                    const dates = this.state.workoutHistory
                        ? Object.keys(this.state.workoutHistory)
                            .filter(dateKey => Array.isArray(this.state.workoutHistory[dateKey]) && this.state.workoutHistory[dateKey].length > 0)
                            .sort((a, b) => new Date(b) - new Date(a))
                        : [];
                    if (dates.length === 0) return 0;

                    let streak = 0;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const firstDateInLog = new Date(dates[0] + 'T00:00:00');
                    const diffTime = today - firstDateInLog;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays > 1) return 0;

                    streak = 1;
                    for (let i = 0; i < dates.length - 1; i++) {
                        const currentDate = new Date(dates[i] + 'T00:00:00');
                        const previousDate = new Date(dates[i + 1] + 'T00:00:00');
                        const dayDifference = (currentDate - previousDate) / (1000 * 60 * 60 * 24);
                        if (dayDifference === 1) {
                            streak++;
                        } else {
                            break;
                        }
                    }
                    return streak;
                },
                getWeeklyActivityData() {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const weeks = [
                        { label: 'Hace 3sem', count: 0, start: new Date(today), end: new Date(today) },
                        { label: 'Hace 2sem', count: 0, start: new Date(today), end: new Date(today) },
                        { label: 'Sem Pasada', count: 0, start: new Date(today), end: new Date(today) },
                        { label: 'Esta Sem', count: 0, start: new Date(today), end: new Date(today) },
                    ];
                    for (let i = 0; i < 4; i++) {
                        const weekIndex = 3 - i;
                        const firstDayOfWeek = new Date(today);
                        const dayOfWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                        firstDayOfWeek.setDate(today.getDate() - dayOfWeek - (i * 7));
                        weeks[weekIndex].start = new Date(firstDayOfWeek);
                        weeks[weekIndex].end = new Date(firstDayOfWeek);
                        weeks[weekIndex].end.setDate(firstDayOfWeek.getDate() + 6);
                    }
                    if (this.state.workoutHistory) {
                        Object.entries(this.state.workoutHistory).forEach(([dateStr, entries]) => {
                            if (!Array.isArray(entries) || entries.length === 0) return;
                            const workoutDate = new Date(dateStr + 'T00:00:00');
                            for (const week of weeks) {
                                if (workoutDate >= week.start && workoutDate <= week.end) {
                                    week.count += entries.length;
                                    break;
                                }
                            }
                        });
                    }
                    return weeks;
                },
                showEditProfileModal() { const { userName, physicalStats } = this.state; const body = `<form id="edit-profile-form" class="space-y-4"><div><label for="profile-edit-name" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label><input type="text" id="profile-edit-name" value="${userName}" required class="w-full bg-gray-700 rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-emerald-500 focus:outline-none transition"></div><div class="grid grid-cols-3 gap-3"><div><label for="profile-edit-age" class="block text-sm font-medium text-gray-300 mb-1">Edad</label><input type="number" id="profile-edit-age" value="${physicalStats.age}" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div><div><label for="profile-edit-weight" class="block text-sm font-medium text-gray-300 mb-1">Peso (kg)</label><input type="number" step="0.1" id="profile-edit-weight" value="${physicalStats.weight}" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div><div><label for="profile-edit-height" class="block text-sm font-medium text-gray-300 mb-1">Altura (cm)</label><input type="number" id="profile-edit-height" value="${physicalStats.height}" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div></div><div class="mt-4"><p class="block text-sm font-medium text-gray-300 mb-2">Género</p><div class="grid grid-cols-2 gap-4"><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="profile-edit-gender" value="male" class="sr-only" ${physicalStats.gender === 'male' ? 'checked' : ''}> Hombre</label><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="profile-edit-gender" value="female" class="sr-only" ${physicalStats.gender === 'female' ? 'checked' : ''}> Mujer</label></div></div></form>`; const footer = [{ text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },{ text: 'Guardar Cambios', class: 'bg-emerald-600 text-gray-900 hover:bg-emerald-500', action: 'save-profile-changes' }]; this.showModal('Editar Perfil', body, footer); },
                async handleUpdateProfile() { const name = document.getElementById('profile-edit-name').value.trim(); const age = parseInt(document.getElementById('profile-edit-age').value); const weight = parseFloat(document.getElementById('profile-edit-weight').value); const height = parseInt(document.getElementById('profile-edit-height').value); const gender = document.querySelector('input[name="profile-edit-gender"]:checked').value; if (!name || isNaN(age) || isNaN(weight) || isNaN(height)) { this.showToast("Por favor, rellena todos los campos correctamente.", "error"); return; } this.state.userName = name; this.state.physicalStats = { ...this.state.physicalStats, age, weight, height, gender }; await this.saveDataToFirestore(); this.renderAll(); this.updateUserInfoUI(); this.populateNutritionForm(); this.hideModal(); this.showToast("¡Perfil actualizado con éxito!"); },
                updateDashboard() { document.getElementById('dashboard-calories').textContent=`${this.state.userGoals.calories} kcal`; this.updateDietSummary(); },
                async uploadImageToStorage(file, { pathPrefix = 'uploads', previousPath = '' } = {}) {
                    if (!file || !this.storage) {
                        return { url: '', storagePath: '' };
                    }

                    const sanitizedName = file.name.toLowerCase().replace(/[^a-z0-9.]+/g, '-');
                    const ownerId = this.state.currentUser?.uid || 'public';
                    const storagePath = `${pathPrefix}/${ownerId}/${Date.now()}-${sanitizedName}`;
                    const storageRefInstance = ref(this.storage, storagePath);
                    const uploadTask = uploadBytesResumable(storageRefInstance, file);

                    await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed', null, reject, () => resolve());
                    });

                    const downloadURL = await getDownloadURL(storageRefInstance);

                    if (previousPath && previousPath !== storagePath) {
                        await this.deleteStorageAsset(previousPath);
                    }

                    return { url: downloadURL, storagePath };
                },
                async deleteStorageAsset(storagePath) {
                    if (!storagePath || !this.storage) {
                        return;
                    }
                    try {
                        await deleteObject(ref(this.storage, storagePath));
                    } catch (error) {
                        console.warn('No se pudo eliminar el archivo de Storage:', error);
                    }
                },
                renderFoodImagePlaceholder(previewEl) {
                    if (!previewEl) return;
                    previewEl.innerHTML = `<div class="flex h-24 w-full items-center justify-center gap-2 rounded-xl border border-dashed border-white/10 bg-gray-900/60 text-xs text-gray-400"><i data-lucide="image-off" class="h-4 w-4"></i><span>Sin imagen</span></div>`;
                    lucide.createIcons();
                },
                setupFoodImagePreview(inputId, previewId, removeInputId = null, removeButtonId = null) {
                    const fileInput = document.getElementById(inputId);
                    const preview = document.getElementById(previewId);
                    const removeInput = removeInputId ? document.getElementById(removeInputId) : null;
                    const removeButton = removeButtonId ? document.getElementById(removeButtonId) : null;

                    if (!fileInput || !preview) {
                        return;
                    }

                    if (!preview.innerHTML.trim()) {
                        this.renderFoodImagePlaceholder(preview);
                    }

                    if (removeButton && !removeButton.dataset.originalInnerHTML) {
                        removeButton.dataset.originalInnerHTML = removeButton.innerHTML;
                    }

                    if (fileInput.dataset.previewListenerAttached === 'true') {
                        return;
                    }
                    fileInput.dataset.previewListenerAttached = 'true';

                    fileInput.addEventListener('change', () => {
                        if (fileInput.files && fileInput.files[0]) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                preview.innerHTML = `<img src="${event.target.result}" alt="Vista previa del alimento" class="h-24 w-full rounded-xl border border-white/10 object-cover">`;
                            };
                            reader.readAsDataURL(fileInput.files[0]);
                            if (removeInput) {
                                removeInput.value = 'false';
                            }
                            if (removeButton) {
                                removeButton.disabled = false;
                                removeButton.classList.remove('opacity-60', 'cursor-not-allowed');
                                if (removeButton.dataset.originalInnerHTML) {
                                    removeButton.innerHTML = removeButton.dataset.originalInnerHTML;
                                }
                                lucide.createIcons();
                            }
                        } else {
                            this.renderFoodImagePlaceholder(preview);
                            if (removeButton) {
                                removeButton.disabled = true;
                                removeButton.classList.add('opacity-60', 'cursor-not-allowed');
                                lucide.createIcons();
                            }
                        }
                    });
                },
                setModalButtonLoading(action, isLoading, fallbackText = 'Guardar') {
                    const button = document.querySelector(`#custom-modal-footer button[data-action="${action}"]`);
                    if (!button) return;

                    if (isLoading) {
                        button.dataset.originalText = button.textContent;
                        button.disabled = true;
                        button.innerHTML = `<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i>`;
                        lucide.createIcons();
                    } else {
                        button.disabled = false;
                        const text = button.dataset.originalText || fallbackText;
                        button.textContent = text;
                    }
                },
                setElementLoading(button, isLoading, fallbackText = 'Guardar') {
                    if (!button) {
                        return;
                    }
                    if (isLoading) {
                        button.dataset.originalInnerHTML = button.innerHTML;
                        button.disabled = true;
                        button.innerHTML = `<i data-lucide="loader-2" class="h-4 w-4 animate-spin"></i>`;
                        lucide.createIcons();
                    } else {
                        button.disabled = false;
                        const html = button.dataset.originalInnerHTML || fallbackText;
                        button.innerHTML = html;
                    }
                },
                showModal(t,b,f=[]){document.getElementById('custom-modal-title').textContent=t;document.getElementById('custom-modal-body').innerHTML=b;const ft=document.getElementById('custom-modal-footer');ft.innerHTML=f.map(btn=>{const d=Object.entries(btn).filter(([k])=>k!=='text'&&k!=='class').map(([k,v])=>`data-${k}="${v}"`).join(' ');return`<button ${d} class="font-bold py-2 px-4 rounded-lg transition ${btn.class}">${btn.text}</button>`}).join('');document.getElementById('custom-modal').classList.remove('hidden');document.getElementById('custom-modal-panel').classList.remove('modal-fade-out');},
                hideModal(){const m=document.getElementById('custom-modal'),p=document.getElementById('custom-modal-panel');p.classList.add('modal-fade-out');p.addEventListener('animationend',()=>m.classList.add('hidden'),{once:true});},
                showToast(m,t='success'){const c=document.getElementById('toast-container'),el=document.createElement('div');el.className=`toast ${t==='success'?'bg-emerald-500':'bg-red-500'} text-white font-bold py-2 px-4 rounded-lg shadow-lg`;el.textContent=m;c.appendChild(el);setTimeout(()=>el.remove(),3000);},
            formatTime(seconds) { const m = Math.floor(seconds / 60); const s = seconds % 60; return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; },
            formatNumberCompact(value) {
                const numeric = typeof value === 'number' ? value : parseFloat(value);
                if (!numeric || Number.isNaN(numeric)) {
                    return '0';
                }
                return new Intl.NumberFormat('es-ES', { notation: 'compact', maximumFractionDigits: 1 }).format(numeric);
            },
            formatRelativeTime(dateInput) {
                if (!dateInput) {
                    return '';
                }
                const date = dateInput instanceof Date ? dateInput : new Date(dateInput);
                if (Number.isNaN(date.getTime())) {
                    return '';
                }
                const diffSeconds = Math.floor((Date.now() - date.getTime()) / 1000);
                if (diffSeconds < 60) {
                    return 'justo ahora';
                }
                const diffMinutes = Math.floor(diffSeconds / 60);
                if (diffMinutes < 60) {
                    return `hace ${diffMinutes} min`;
                }
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffHours < 24) {
                    return `hace ${diffHours} h`;
                }
                const diffDays = Math.floor(diffHours / 24);
                if (diffDays < 7) {
                    return `hace ${diffDays} d`;
                }
                return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            },
            animateCommunityCounters() {
                const counters = document.querySelectorAll('[data-community-counter][data-animated="false"]');
                counters.forEach(counter => {
                    const target = parseFloat(counter.dataset.counterValue || '0');
                    if (!target) {
                        counter.textContent = '0';
                        counter.dataset.animated = 'true';
                        return;
                    }
                    const duration = 1000;
                    const startTime = performance.now();
                    const animate = (now) => {
                        const elapsed = now - startTime;
                        const progress = Math.min(1, elapsed / duration);
                        const eased = 1 - Math.pow(1 - progress, 3);
                        const currentValue = target * eased;
                        counter.textContent = this.formatNumberCompact(currentValue);
                        if (progress < 1) {
                            requestAnimationFrame(animate);
                        } else {
                            counter.textContent = this.formatNumberCompact(target);
                            counter.dataset.animated = 'true';
                        }
                    };
                    requestAnimationFrame(animate);
                });
            },
            parseRepsValue(reps) {
                if (typeof reps === 'number' && !Number.isNaN(reps)) {
                    return reps;
                }
                if (typeof reps === 'string') {
                    const match = reps.match(/\d+/);
                    if (match) {
                        return parseInt(match[0], 10);
                    }
                }
                return 1;
            },
            estimateOneRepMax(weight, reps) {
                const numericWeight = typeof weight === 'number' ? weight : parseFloat(weight);
                const repsValue = this.parseRepsValue(reps);
                if (!numericWeight || Number.isNaN(numericWeight) || numericWeight <= 0 || !repsValue) {
                    return 0;
                }
                const estimate = numericWeight * (1 + repsValue / 30);
                return Math.round(estimate * 10) / 10;
            },
                playSound(type) { if(!this.audioCtx) return; const o=this.audioCtx.createOscillator(),g=this.audioCtx.createGain();o.connect(g);g.connect(this.audioCtx.destination);g.gain.setValueAtTime(0,this.audioCtx.currentTime);g.gain.linearRampToValueAtTime(0.3,this.audioCtx.currentTime+0.01);o.frequency.value=type==='start'?440:880;o.type='sine';o.start(this.audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.00001,this.audioCtx.currentTime+0.5);o.stop(this.audioCtx.currentTime+0.5); },
                switchCalculatorTab(tabId) { document.querySelectorAll('.calc-tab-content').forEach(el => el.classList.add('hidden')); document.getElementById(`tab-content-${tabId}`).classList.remove('hidden'); document.querySelectorAll('.calc-tab-btn').forEach(btn => { if (btn.dataset.tab === tabId) { btn.classList.add('bg-emerald-500', 'text-gray-900'); btn.classList.remove('text-gray-300'); } else { btn.classList.remove('bg-emerald-500', 'text-gray-900'); btn.classList.add('text-gray-300'); } }); },
                populateNutritionForm() { const { age, weight, height, gender } = this.state.physicalStats; document.getElementById('age').value = age; document.getElementById('weight').value = weight; document.getElementById('height').value = height; const genderRadio = document.querySelector(`#nutrition-form input[name="gender"][value="${gender}"]`); if (genderRadio) genderRadio.checked = true; },
                renderNutricionSection() {
                    const { weight, height } = this.state.physicalStats || {};
                    this.renderBmiCard(weight || 0, height || 0);
                    const setDefault = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.textContent = value;
                        }
                    };
                    setDefault('bodyfat-value', '--');
                    setDefault('ideal-weight-value', '--');
                    setDefault('water-intake-value', '-- L');
                    this.updateNutritionResultsUI();
                    this.updateNutritionAnalytics();
                },
                calculateNutrition(formElement, showUI) {
                    const targetForm = formElement || document.getElementById('nutrition-form');
                    const shouldUpdateUI = typeof showUI === 'undefined' ? true : Boolean(showUI);

                    const gender = targetForm.querySelector('input[name="gender"]:checked').value;
                    const age = parseInt(targetForm.age.value);
                    const weight = parseFloat(targetForm.weight.value);
                    const height = parseInt(targetForm.height.value);
                    const activity = parseFloat(targetForm.activity.value);
                    const goal = targetForm.querySelector('input[name="goal"]:checked').value;

                    if (!age || !weight || !height) {
                        this.showToast("Rellena todos los campos.", "error");
                        return null;
                    }

                    this.state.physicalStats = { ...this.state.physicalStats, age, weight, height, gender, activity };
                    this.saveDataToFirestore();

                    const bmr = (gender === 'male')
                        ? (10 * weight + 6.25 * height - 5 * age + 5)
                        : (10 * weight + 6.25 * height - 5 * age - 161);
                    const tdee = bmr * activity;

                    let calories;
                    if (goal === 'lose') calories = tdee - 500;
                    else if (goal === 'gain') calories = tdee + 500;
                    else calories = tdee;

                    const results = {
                        calories: Math.round(calories),
                        protein: Math.round((calories * 0.3) / 4),
                        carbs: Math.round((calories * 0.4) / 4),
                        fats: Math.round((calories * 0.3) / 9)
                    };

                    this._tempResults = results;
                    if (shouldUpdateUI) {
                        this.updateNutritionResultsUI(results);
                        this.updateNutritionAnalytics();
                        this.updateHeaderInsights();
                        this.showToast("Cálculos de nutrición actualizados", "success");
                    }

                    return results;
                },
                calculateBodyMetrics() { const { weight, height, age, gender } = this.state.physicalStats; if (!weight || !height || !age) { this.showToast("Completa tus datos en el perfil o en la pestaña de nutrición primero.", "error"); return; } const bmi = this.renderBmiCard(weight, height); const genderFactor = (gender === 'male') ? 1 : 0; const bodyFat = (1.20 * bmi) + (0.23 * age) - (10.8 * genderFactor) - 5.4; document.getElementById('bodyfat-value').textContent = bodyFat.toFixed(1); const heightInM = height / 100; const idealMin = 18.5 * (heightInM * heightInM); const idealMax = 24.9 * (heightInM * heightInM); document.getElementById('ideal-weight-value').textContent = `${idealMin.toFixed(1)} - ${idealMax.toFixed(1)} kg`; const waterLiters = (weight * 35) / 1000; document.getElementById('water-intake-value').textContent = waterLiters.toFixed(1); this.showToast("Métricas corporales calculadas."); },
                renderBmiCard(weight, height) { if(!weight || !height) { document.getElementById('bmi-value').textContent = '--'; document.getElementById('bmi-category').textContent = 'Sin calcular'; document.getElementById('bmi-category').className = 'font-semibold text-gray-400'; document.getElementById('bmi-marker').style.left = '0%'; return 0; } const heightInMeters = height / 100; const bmi = (weight / (heightInMeters * heightInMeters)); let category = '', colorClass = '', markerPosition = 0; if (bmi < 18.5) { category = 'Bajo Peso'; colorClass = 'text-sky-400'; markerPosition = (bmi / 18.5) * 25; } else if (bmi >= 18.5 && bmi < 25) { category = 'Normal'; colorClass = 'text-emerald-400'; markerPosition = 25 + ((bmi - 18.5) / (25 - 18.5)) * 30; } else if (bmi >= 25 && bmi < 30) { category = 'Sobrepeso'; colorClass = 'text-yellow-400'; markerPosition = 55 + ((bmi - 25) / (30 - 25)) * 25; } else { category = 'Obesidad'; colorClass = 'text-red-400'; markerPosition = 80 + ((bmi - 30) / (40 - 30)) * 20; } markerPosition = Math.max(2, Math.min(98, markerPosition)); document.getElementById('bmi-value').textContent = bmi.toFixed(1); const categoryEl = document.getElementById('bmi-category'); categoryEl.textContent = category; categoryEl.className = `font-semibold ${colorClass}`; document.getElementById('bmi-marker').style.left = `${markerPosition}%`; return bmi; },
                calculate1RM() { const weight = parseFloat(document.getElementById('1rm-weight').value); const reps = parseInt(document.getElementById('1rm-reps').value); if(!weight || !reps || weight <= 0 || reps <= 0) { this.showToast("Ingresa un peso y repeticiones válidos.", "error"); return; } if (reps > 12) { this.showToast("El cálculo es menos preciso con más de 12 reps.", "error"); } const oneRepMax = weight / (1.0278 - 0.0278 * reps); document.getElementById('1rm-result-value').textContent = `${oneRepMax.toFixed(1)} kg`; const projectionsContainer = document.getElementById('1rm-projections'); const repRanges = [3, 5, 8, 10, 12, 15]; projectionsContainer.innerHTML = repRanges.map(r => { const projectedWeight = oneRepMax * (1.0278 - 0.0278 * r); return `<div class="bg-gray-800/70 p-2 rounded-lg"><p class="font-bold text-lg text-purple-200">${projectedWeight.toFixed(1)}<span class="text-xs text-gray-400"> kg</span></p><p class="text-xs text-gray-400">${r} RM</p></div>`; }).join(''); document.getElementById('1rm-results').classList.remove('hidden'); },
                showEditTargetWeightModal() { const body = `<p class="text-gray-300 mb-4">Define el peso que quieres alcanzar.</p><input type="number" step="0.1" id="target-weight-input" value="${this.state.targetWeight}" class="w-full bg-gray-700 rounded-lg p-3 text-center text-xl">`; const footer = [ { text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }, { text: 'Guardar', class: 'bg-emerald-600 text-gray-900', action: 'save-target-weight' } ]; this.showModal('Editar Peso Objetivo', body, footer); },
                async handleUpdateTargetWeight() { const input = document.getElementById('target-weight-input'); const newTarget = parseFloat(input.value); if (isNaN(newTarget) || newTarget <= 0) { this.showToast('Por favor, introduce un peso válido.', 'error'); return; } this.state.targetWeight = newTarget; await this.saveDataToFirestore(); this.renderProfileSection(); this.renderDietPage(); this.hideModal(); this.showToast('Objetivo de peso actualizado.'); },
                async handleAddWeightLog() { const input = document.getElementById('new-weight-input'); const newWeight = parseFloat(input.value); if (isNaN(newWeight) || newWeight <= 0) { this.showToast('Por favor, introduce un peso válido.', 'error'); return; } const today = new Date().toISOString().split('T')[0]; if(!this.state.weightLog) this.state.weightLog = []; const existingIndex = this.state.weightLog.findIndex(entry => entry.date === today); if (existingIndex > -1) { this.state.weightLog[existingIndex].weight = newWeight; } else { this.state.weightLog.push({ date: today, weight: newWeight }); } this.state.physicalStats.weight = newWeight; input.value = ''; await this.saveDataToFirestore(); this.renderAll(); this.showToast('Nuevo peso registrado.'); },
                async saveNutritionGoals(){if(this._tempResults){this.state.userGoals={...this._tempResults};await this.saveDataToFirestore();this.renderAll();this.showToast("¡Meta guardada!");this.showSection('dieta');}},
                _getWeightProgressMetrics() {
                    const parseWeight = (value) => {
                        if (typeof value === 'number' && Number.isFinite(value)) {
                            return value;
                        }
                        const parsed = parseFloat(value);
                        return Number.isFinite(parsed) ? parsed : 0;
                    };
                    const formatDate = (dateStr, options = { day: 'numeric', month: 'short', year: 'numeric' }) => {
                        if (!dateStr) return null;
                        const date = new Date(`${dateStr}T00:00:00`);
                        if (Number.isNaN(date.getTime())) return null;
                        return date.toLocaleDateString('es-ES', options);
                    };
                    const formatDateFromObject = (date, options) => {
                        if (!(date instanceof Date) || Number.isNaN(date.getTime())) return null;
                        return date.toLocaleDateString('es-ES', options);
                    };

                    const weightValue = parseWeight(this.state?.physicalStats?.weight);
                    const targetValue = parseWeight(this.state?.targetWeight);
                    const goalWeight = targetValue > 0 ? targetValue : weightValue;

                    const weightLog = Array.isArray(this.state.weightLog) ? [...this.state.weightLog] : [];
                    weightLog.sort((a, b) => new Date(a.date) - new Date(b.date));

                    const firstEntry = weightLog.length ? weightLog[0] : null;
                    const lastEntry = weightLog.length ? weightLog[weightLog.length - 1] : null;
                    const startWeight = firstEntry ? parseWeight(firstEntry.weight) : (weightValue || goalWeight);
                    const currentWeight = lastEntry ? parseWeight(lastEntry.weight) : (weightValue || startWeight);

                    const lastWeighInLabel = lastEntry && formatDate(lastEntry.date)
                        ? `Actualizado el ${formatDate(lastEntry.date)}`
                        : 'Registra tu peso para comenzar.';

                    const totalDiff = goalWeight - startWeight;
                    let progressPercent = 0;
                    if (Math.abs(totalDiff) < 0.001) {
                        progressPercent = goalWeight > 0 && currentWeight > 0 ? 100 : 0;
                    } else {
                        const rawProgress = ((currentWeight - startWeight) / totalDiff) * 100;
                        progressPercent = Math.max(0, Math.min(rawProgress, 150));
                    }
                    const progressPercentClamped = Math.max(0, Math.min(progressPercent, 100));

                    const diffToGoal = goalWeight - currentWeight;
                    const diffLabel = (goalWeight > 0 && Number.isFinite(diffToGoal))
                        ? `${diffToGoal > 0 ? '+' : ''}${diffToGoal.toFixed(1)} kg`
                        : '-- kg';
                    let diffToneClass = 'text-gray-300';
                    if (goalWeight > 0 && Number.isFinite(diffToGoal)) {
                        if (Math.abs(diffToGoal) < 0.1) {
                            diffToneClass = 'text-emerald-200';
                        } else if (diffToGoal > 0) {
                            diffToneClass = 'text-emerald-200';
                        } else {
                            diffToneClass = 'text-amber-200';
                        }
                    }

                    const deltaNeeded = goalWeight - startWeight;
                    let directionLabel = 'Define un objetivo';
                    let directionDescription = 'Conecta tu meta de peso para personalizar el plan.';
                    if (goalWeight > 0) {
                        if (Math.abs(deltaNeeded) < 0.1) {
                            directionLabel = 'Mantenimiento inteligente';
                            directionDescription = 'Mantén consistencia registrando tus pesajes.';
                        } else if (deltaNeeded > 0) {
                            directionLabel = 'Ganancia controlada';
                            directionDescription = `Buscas sumar ${Math.abs(deltaNeeded).toFixed(1)} kg respecto a tu inicio.`;
                        } else if (deltaNeeded < 0) {
                            directionLabel = 'Definición guiada';
                            directionDescription = `Buscas recortar ${Math.abs(deltaNeeded).toFixed(1)} kg respecto a tu inicio.`;
                        }
                    }

                    let goalDiffText = 'Registra tus pesajes para medir el avance.';
                    let goalDiffClass = 'text-gray-400';
                    if (goalWeight > 0 && Number.isFinite(diffToGoal)) {
                        if (Math.abs(diffToGoal) < 0.1) {
                            goalDiffText = 'Meta alcanzada, mantén la consistencia.';
                            goalDiffClass = 'text-emerald-200';
                        } else if (diffToGoal > 0) {
                            goalDiffText = `Faltan ${diffToGoal.toFixed(1)} kg para la meta.`;
                            goalDiffClass = 'text-emerald-200/80';
                        } else {
                            goalDiffText = `Has superado la meta por ${Math.abs(diffToGoal).toFixed(1)} kg.`;
                            goalDiffClass = 'text-amber-200/80';
                        }
                    }

                    let totalChange = 0;
                    let totalDays = 0;
                    const parseDate = (dateStr) => {
                        if (!dateStr) return null;
                        const d = new Date(`${dateStr}T00:00:00`);
                        return Number.isNaN(d.getTime()) ? null : d;
                    };
                    for (let i = 1; i < weightLog.length; i++) {
                        const prev = weightLog[i - 1];
                        const curr = weightLog[i];
                        const prevDate = parseDate(prev.date);
                        const currDate = parseDate(curr.date);
                        if (!prevDate || !currDate) continue;
                        const diffMs = currDate - prevDate;
                        const days = diffMs / 86400000;
                        if (days <= 0) continue;
                        const change = parseWeight(curr.weight) - parseWeight(prev.weight);
                        totalChange += change;
                        totalDays += days;
                    }
                    const dailyRate = totalDays > 0 ? totalChange / totalDays : 0;
                    const weeklyRate = dailyRate * 7;
                    let trendLabel = 'Sin tendencia aún';
                    let trendClass = 'text-gray-400';
                    if (Math.abs(weeklyRate) > 0.01) {
                        trendLabel = `${weeklyRate > 0 ? '+' : ''}${weeklyRate.toFixed(1)} kg/sem`;
                        const sameDirection = Math.abs(diffToGoal) < 0.1 || Math.sign(weeklyRate) === Math.sign(diffToGoal);
                        trendClass = sameDirection ? 'text-emerald-200' : 'text-amber-200';
                    }

                    let projectionBadgeText = 'Sin datos';
                    let projectionBadgeClasses = 'border-white/10 bg-white/5 text-gray-300';
                    let projectionSummary = 'Añade registros de peso para proyectar tu fecha objetivo.';
                    let projectionDateLabel = '--';
                    let projectionWeeksLabel = '--';
                    let projectionHelper = goalWeight > 0 && Number.isFinite(diffToGoal)
                        ? `${diffToGoal > 0 ? 'Faltan' : 'Exceso'} ${Math.abs(diffToGoal).toFixed(1)} kg`
                        : 'Define tu objetivo de peso.';
                    let projectionPaceText = Math.abs(weeklyRate) > 0.01
                        ? `Ritmo actual: ${weeklyRate > 0 ? '+' : ''}${weeklyRate.toFixed(1)} kg/sem`
                        : 'Registra al menos dos pesajes recientes para estimar el ritmo.';

                    if (goalWeight > 0 && Math.abs(diffToGoal) < 0.1) {
                        projectionBadgeText = 'Completado';
                        projectionBadgeClasses = 'border-emerald-400/40 bg-emerald-500/10 text-emerald-100';
                        projectionSummary = 'Tu objetivo actual está completado.';
                        projectionDateLabel = lastEntry && formatDate(lastEntry.date, { day: 'numeric', month: 'short' }) ? formatDate(lastEntry.date, { day: 'numeric', month: 'short' }) : 'Hoy';
                        projectionWeeksLabel = '0';
                        projectionHelper = 'Diferencia 0.0 kg';
                        projectionPaceText = Math.abs(weeklyRate) > 0.01
                            ? `Mantén un ritmo de ${weeklyRate > 0 ? '+' : ''}${weeklyRate.toFixed(1)} kg/sem`
                            : 'Registra nuevos pesajes para mantener la métrica.';
                    } else if (goalWeight > 0 && Math.abs(weeklyRate) > 0.01) {
                        if (Math.sign(weeklyRate) !== Math.sign(diffToGoal) && Math.abs(diffToGoal) >= 0.1) {
                            projectionBadgeText = 'Desviación';
                            projectionBadgeClasses = 'border-amber-400/40 bg-amber-500/10 text-amber-100';
                            projectionSummary = diffToGoal > 0
                                ? 'Tu tendencia actual se aleja del objetivo, ajusta tu estrategia.'
                                : 'Tu tendencia actual supera la meta, considera estabilizarte.';
                            projectionPaceText = `Tendencia actual: ${weeklyRate > 0 ? '+' : ''}${weeklyRate.toFixed(1)} kg/sem`;
                        } else if (diffToGoal !== 0 && dailyRate !== 0) {
                            const estimatedDays = Math.ceil(Math.abs(diffToGoal / dailyRate));
                            const lastDate = lastEntry && parseDate(lastEntry.date) ? parseDate(lastEntry.date) : new Date();
                            const estimatedDate = new Date(lastDate.getTime() + estimatedDays * 86400000);
                            projectionBadgeText = 'En curso';
                            projectionBadgeClasses = 'border-emerald-400/40 bg-emerald-500/10 text-emerald-100';
                            const summaryDateLabel = formatDateFromObject(estimatedDate, { day: 'numeric', month: 'long' });
                            projectionSummary = summaryDateLabel
                                ? `A ritmo actual alcanzarías la meta el ${summaryDateLabel}.`
                                : 'Mantén tus registros para proyectar la fecha objetivo.';
                            projectionDateLabel = formatDateFromObject(estimatedDate, { day: 'numeric', month: 'short' }) || '--';
                            projectionWeeksLabel = `${(estimatedDays / 7).toFixed(1)} sem`;
                            projectionHelper = `${diffToGoal > 0 ? 'Faltan' : 'Exceso'} ${Math.abs(diffToGoal).toFixed(1)} kg`;
                            projectionPaceText = `Ritmo actual: ${weeklyRate > 0 ? '+' : ''}${weeklyRate.toFixed(1)} kg/sem`;
                        }
                    }

                    const formatWeight = (value) => (Number.isFinite(value) && value > 0 ? value.toFixed(1) : '--');

                    return {
                        currentWeight,
                        goalWeight,
                        startWeight,
                        currentWeightLabel: formatWeight(currentWeight),
                        goalWeightLabel: formatWeight(goalWeight),
                        startWeightLabel: `${formatWeight(startWeight)} kg`,
                        diffToGoal,
                        diffLabel,
                        diffToneClass,
                        goalDiffText,
                        goalDiffClass,
                        directionLabel,
                        directionDescription,
                        progressPercent: Math.round(progressPercentClamped),
                        lastWeighInLabel,
                        trendLabel,
                        trendClass,
                        projection: {
                            badgeText: projectionBadgeText,
                            badgeClasses: projectionBadgeClasses,
                            summary: projectionSummary,
                            dateLabel: projectionDateLabel,
                            weeksLabel: projectionWeeksLabel,
                            helperText: projectionHelper,
                            paceText: projectionPaceText
                        }
                    };
                },
                _applyWeightMetrics(metrics) {
                    if (!metrics) return;
                    const setText = (id, value) => {
                        const el = document.getElementById(id);
                        if (el !== null) {
                            el.textContent = value;
                        }
                    };

                    setText('diet-current-weight', metrics.currentWeightLabel);
                    setText('diet-target-weight', metrics.goalWeightLabel);
                    setText('diet-last-weigh-in', metrics.lastWeighInLabel);
                    setText('diet-goal-label', metrics.directionLabel);
                    const directionEl = document.getElementById('diet-goal-direction');
                    if (directionEl) directionEl.textContent = metrics.directionDescription;

                    const diffEl = document.getElementById('diet-weight-diff');
                    if (diffEl) {
                        diffEl.className = `text-lg font-semibold ${metrics.diffToneClass}`;
                        diffEl.textContent = metrics.diffLabel;
                    }

                    const goalDiffEl = document.getElementById('diet-goal-diff');
                    if (goalDiffEl) {
                        goalDiffEl.className = `text-xs ${metrics.goalDiffClass}`;
                        goalDiffEl.textContent = metrics.goalDiffText;
                    }

                    const progressBar = document.getElementById('diet-weight-progress');
                    if (progressBar) {
                        const width = Math.max(0, Math.min(metrics.progressPercent, 110));
                        progressBar.style.width = `${width}%`;
                    }
                    const progressLabel = document.getElementById('diet-weight-progress-label');
                    if (progressLabel) progressLabel.textContent = `${metrics.progressPercent}%`;

                    setText('diet-goal-start', metrics.startWeightLabel);

                    const trendEl = document.getElementById('diet-goal-trend');
                    if (trendEl) {
                        trendEl.className = `text-sm font-semibold ${metrics.trendClass}`;
                        trendEl.textContent = metrics.trendLabel;
                    }

                    const projectionBadge = document.getElementById('diet-projection-badge');
                    if (projectionBadge) {
                        projectionBadge.className = `inline-flex items-center gap-1 rounded-full px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.3em] ${metrics.projection.badgeClasses}`;
                        projectionBadge.textContent = metrics.projection.badgeText;
                    }
                    setText('diet-projection-summary', metrics.projection.summary);
                    setText('diet-projection-date', metrics.projection.dateLabel);
                    setText('diet-projection-weeks', metrics.projection.weeksLabel);
                    setText('diet-projection-helper', metrics.projection.helperText);
                    const projectionPace = document.getElementById('diet-projection-pace');
                    if (projectionPace) projectionPace.textContent = metrics.projection.paceText;
                },
                updateDietWeightInfo() {
                    const metrics = this._getWeightProgressMetrics();
                    this._applyWeightMetrics(metrics);
                },
                async handleDietPanelCoverSelected(input) {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede actualizar estas portadas.', 'error');
                        if (input) input.value = '';
                        return;
                    }
                    if (!input) return;

                    const panelKey = input.dataset.panelCoverInput;
                    const file = input.files && input.files[0];
                    input.value = '';

                    if (!panelKey || !file) {
                        return;
                    }

                    if (!file.type.startsWith('image/')) {
                        this.showToast('Selecciona una imagen válida.', 'error');
                        return;
                    }

                    const maxSize = 12 * 1024 * 1024;
                    if (file.size > maxSize) {
                        this.showToast('La imagen supera el límite de 12MB.', 'error');
                        return;
                    }

                    if (!this.state.dietPanelCovers) {
                        const defaults = this.getDefaultState().dietPanelCovers || {};
                        this.state.dietPanelCovers = Object.keys(defaults).reduce((acc, key) => {
                            acc[key] = { ...defaults[key] };
                            return acc;
                        }, {});
                    }

                    const trigger = document.querySelector(`[data-panel-cover-trigger="${panelKey}"]`);
                    const wrapper = document.querySelector(`.diet-panel-cover[data-panel-key="${panelKey}"]`);

                    const setUploadingState = (isUploading) => {
                        if (trigger) {
                            trigger.classList.toggle('is-uploading', isUploading);
                        }
                        if (wrapper) {
                            wrapper.classList.toggle('opacity-70', isUploading);
                            wrapper.classList.toggle('pointer-events-none', isUploading);
                        }
                    };

                    try {
                        setUploadingState(true);
                        const previousPath = this.state.dietPanelCovers?.[panelKey]?.storagePath || '';
                        const uploadResult = await this.uploadImageToStorage(file, {
                            pathPrefix: `diet_panel_covers/${panelKey}`,
                            previousPath
                        });

                        if (!uploadResult.url) {
                            this.showToast('No se pudo subir la imagen.', 'error');
                            return;
                        }

                        this.state.dietPanelCovers[panelKey] = {
                            url: uploadResult.url,
                            storagePath: uploadResult.storagePath,
                            updatedAt: new Date().toISOString()
                        };

                        this.preloadImage(uploadResult.url, { priority: 'high' });
                        this.renderDietPanelCovers();
                        await this.saveDataToFirestore();
                        this.showToast('Portada actualizada.', 'success');
                    } catch (error) {
                        console.error('Error uploading diet panel cover:', error);
                        this.showToast('No se pudo subir la imagen.', 'error');
                    } finally {
                        setUploadingState(false);
                    }
                },
                renderDietPanelCovers() {
                    const covers = this.state.dietPanelCovers || {};
                    const isAdmin = this.isAsesor();
                    const keys = ['guided', 'daily', 'agenda', 'library'];

                    keys.forEach((key) => {
                        const wrapper = document.querySelector(`.diet-panel-cover[data-panel-key="${key}"]`);
                        const preview = document.querySelector(`[data-panel-cover-preview="${key}"]`);
                        const trigger = document.querySelector(`[data-panel-cover-trigger="${key}"]`);
                        const input = document.querySelector(`[data-panel-cover-input="${key}"]`);
                        if (!wrapper || !preview) {
                            return;
                        }

                        const coverData = covers[key] || {};
                        const hasCustomCover = Boolean(coverData.url);

                        if (hasCustomCover) {
                            preview.style.backgroundImage = `url('${coverData.url}')`;
                        } else {
                            preview.style.backgroundImage = '';
                        }

                        wrapper.dataset.customCover = hasCustomCover ? 'true' : 'false';

                        if (trigger) {
                            trigger.classList.toggle('is-hidden', !isAdmin);
                            if (!isAdmin) {
                                trigger.setAttribute('aria-hidden', 'true');
                            } else {
                                trigger.removeAttribute('aria-hidden');
                            }
                        }

                        if (input) {
                            input.disabled = !isAdmin;
                        }
                    });

                    lucide.createIcons();
                },
                renderDietPage(){
                    this.renderDietPanelCovers();
                    this.updateDietWeightInfo();
                    if(!this.state.userGoals) return;
                    const { calories, protein, carbs, fats } = this.state.userGoals;
                    const goalCaloriesEl = document.getElementById('diet-goal-calories');
                    if (goalCaloriesEl) goalCaloriesEl.textContent = calories;
                    const goalProteinEl = document.getElementById('diet-goal-protein');
                    if (goalProteinEl) goalProteinEl.textContent = protein;
                    const goalCarbsEl = document.getElementById('diet-goal-carbs');
                    if (goalCarbsEl) goalCarbsEl.textContent = carbs;
                    const goalFatsEl = document.getElementById('diet-goal-fats');
                    if (goalFatsEl) goalFatsEl.textContent = fats;
                    this.renderMealSections();
                    this._hydrateDietFoodCreator();
                    this.updateDietSummary();
                },
                getFoodById(foodId) { return this.data.foodLibrary.find(item => item.id == foodId) || null; },
                
                renderMealSections(){
                    const container = document.getElementById('meal-sections');
                    const today = new Date().toISOString().split('T')[0];
                    const todayLog = this.state.dietLog ? (this.state.dietLog[today] || {}) : {};

                    if (!Array.isArray(this.state.dailyDiet)) {
                        container.innerHTML = `<div class="rounded-3xl border border-dashed border-white/15 bg-white/5 p-6 text-center text-sm text-gray-400">Formato de dieta no válido.</div>`;
                        return;
                    }

                    container.innerHTML = this.state.dailyDiet.map((meal, mealIndex) => {
                        const totalCals = meal.items.reduce((sum, item) => sum + (item.totalCals || 0), 0);
                        const mealLog = todayLog[meal.id] || [];
                        const normalizedName = (meal.name || '').toLowerCase();
                        let icon = 'chef-hat';
                        if (normalizedName.includes('desay')) icon = 'sunrise';
                        else if (normalizedName.includes('almuerzo') || normalizedName.includes('comida')) icon = 'utensils';
                        else if (normalizedName.includes('cena')) icon = 'moon-star';
                        else if (normalizedName.includes('snack') || normalizedName.includes('colac')) icon = 'coffee';

                        const itemsHTML = meal.items.length > 0
                            ? meal.items.map((item, itemIndex) => {
                                const isCompleted = mealLog[itemIndex] === true;
                                const nameClasses = (!this.isAsesor() && isCompleted) ? 'text-gray-400 line-through' : 'text-white';
                                const rowClasses = ['flex items-center gap-4 rounded-2xl border border-white/10 bg-white/5 p-3 transition'];
                                if (!this.isAsesor()) {
                                    rowClasses.push('hover:border-emerald-400/40');
                                    if (isCompleted) {
                                        rowClasses.push('opacity-60');
                                    }
                                }

                                const imageContent = item.imageUrl
                                    ? `<img src="${item.imageUrl}" alt="${item.name}" class="h-full w-full object-cover">`
                                    : `<div class="flex h-full w-full items-center justify-center bg-gray-900/60 text-gray-500"><i data-lucide="image-off" class="h-5 w-5"></i></div>`;

                                const macrosRow = `<div class="mt-1 flex flex-wrap items-center gap-3 text-xs text-gray-400">
                                        <span class="flex items-center gap-1 text-blue-200">P <strong>${item.totalP || 0}g</strong></span>
                                        <span class="flex items-center gap-1 text-yellow-200">C <strong>${item.totalC || 0}g</strong></span>
                                        <span class="flex items-center gap-1 text-rose-200">G <strong>${item.totalF || 0}g</strong></span>
                                    </div>`;
                                const amountLabel = item.amount && item.amount !== 'N/A' ? ` (${item.amount}g)` : '';

                                const adminActions = `<div class="flex items-center gap-2">
                                        <span class="text-sm font-semibold text-emerald-300">${item.totalCals || 0} kcal</span>
                                        <button data-action="confirm-remove-food" data-meal-index="${mealIndex}" data-item-index="${itemIndex}" class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-rose-500/40 bg-rose-500/10 text-rose-300 transition hover:border-rose-400 hover:bg-rose-500/20">
                                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                                        </button>
                                    </div>`;

                                const userActions = `<div class="flex items-center gap-3">
                                        <span class="text-sm font-semibold text-emerald-300">${item.totalCals || 0} kcal</span>
                                        <label class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs font-semibold text-gray-200">
                                            <input type="checkbox" data-action="toggle-food-completion" data-meal-index="${mealIndex}" data-item-index="${itemIndex}" class="h-4 w-4 rounded border-gray-600 bg-gray-800 text-emerald-400 focus:ring-emerald-400/50" ${isCompleted ? 'checked' : ''}>
                                            <span>Hecho</span>
                                        </label>
                                    </div>`;

                                return `<div class="${rowClasses.join(' ')}">
                                        <div class="relative h-16 w-16 overflow-hidden rounded-xl border border-white/10 bg-gray-900/60 flex-shrink-0">${imageContent}</div>
                                        <div class="min-w-0 flex-1">
                                            <p class="text-sm font-semibold ${nameClasses}">${item.name}${amountLabel ? `<span class="text-gray-400">${amountLabel}</span>` : ''}</p>
                                            ${macrosRow}
                                        </div>
                                        ${this.isAsesor() ? adminActions : userActions}
                                    </div>`;
                            }).join('')
                            : `<div class="rounded-2xl border border-dashed border-white/15 bg-gray-900/40 p-4 text-center text-sm text-gray-400">${this.isAsesor() ? 'Añade alimentos a esta comida.' : 'No hay alimentos asignados.'}</div>`;

                        const recipeButton = meal.items.length > 0 && this.isAsesor()
                            ? `<button data-action="get-recipe" data-meal-index="${mealIndex}" class="inline-flex items-center gap-1 rounded-full border border-purple-400/40 bg-purple-500/10 px-3 py-1 text-xs font-semibold text-purple-200 transition hover:border-purple-300 hover:bg-purple-500/20">
                                    <i data-lucide="sparkles" class="h-3.5 w-3.5"></i>
                                    Receta
                                </button>`
                            : '';

                        return `<article class="rounded-3xl border border-white/10 bg-white/5 p-5 shadow-[0_35px_90px_-60px_rgba(16,185,129,0.45)]">
                                <header class="flex flex-wrap items-center justify-between gap-4">
                                    <div class="flex items-center gap-3">
                                        <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-emerald-400/10 text-emerald-200">
                                            <i data-lucide="${icon}" class="h-6 w-6"></i>
                                        </span>
                                        <div>
                                            <p class="text-lg font-semibold text-white">${meal.name}</p>
                                            <p class="flex items-center gap-1 text-xs text-gray-400">
                                                <i data-lucide="clock" class="h-3.5 w-3.5"></i>
                                                ${meal.time}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-3">
                                        ${recipeButton}
                                        <span class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200">${Math.round(totalCals)} kcal</span>
                                    </div>
                                </header>
                                <div class="mt-4 space-y-3">${itemsHTML}</div>
                            </article>`;
                    }).join('');

                    lucide.createIcons();
                },

                async toggleFoodCompletion(mealIndex, itemIndex) {
                    const meal = this.state.dailyDiet[mealIndex];
                    if (!meal) return;
                    
                    const today = new Date().toISOString().split('T')[0];
                    if (!this.state.dietLog) { this.state.dietLog = {}; }
                    if (!this.state.dietLog[today]) { this.state.dietLog[today] = {}; }
                    
                    if (!this.state.dietLog[today][meal.id]) {
                        this.state.dietLog[today][meal.id] = meal.items.map(() => false);
                    }
                    
                    const currentStatus = this.state.dietLog[today][meal.id][itemIndex];
                    this.state.dietLog[today][meal.id][itemIndex] = !currentStatus;

                    await this.saveDataToFirestore();
                    this.renderMealSections();
                    this.updateDietSummary();
                },

                showAddFoodModal(foodId) {
                    const food = this.getFoodById(foodId);
                    if (!food) return;

                    const image = food.imageUrl
                        ? `<img src="${food.imageUrl}" alt="${food.name}" class="h-16 w-16 rounded-xl border border-white/10 object-cover">`
                        : `<div class="flex h-16 w-16 items-center justify-center rounded-xl border border-dashed border-white/10 bg-gray-900/60 text-gray-500"><i data-lucide="image-off" class="h-5 w-5"></i></div>`;

                    const macros = `<div class="grid grid-cols-3 gap-3 text-xs text-gray-400">
                            <div class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-center">
                                <p class="text-[10px] uppercase tracking-[0.35em] text-blue-200">Proteína</p>
                                <p class="text-sm font-semibold text-white">${Math.round(food.p || 0)} g</p>
                            </div>
                            <div class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-center">
                                <p class="text-[10px] uppercase tracking-[0.35em] text-yellow-200">Carbs</p>
                                <p class="text-sm font-semibold text-white">${Math.round(food.c || 0)} g</p>
                            </div>
                            <div class="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-center">
                                <p class="text-[10px] uppercase tracking-[0.35em] text-rose-200">Grasas</p>
                                <p class="text-sm font-semibold text-white">${Math.round(food.f || 0)} g</p>
                            </div>
                        </div>`;

                    const mealButtons = this.state.dailyDiet.map((meal, index) => `
                        <button data-action="add-food-to-meal" data-food-id="${food.id}" data-meal-index="${index}" class="rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-sm font-semibold text-gray-200 transition hover:border-emerald-400 hover:text-white">
                            ${meal.name}
                        </button>
                    `).join('');

                    const body = `
                        <div class="space-y-4">
                            <div class="flex items-center gap-4">
                                ${image}
                                <div>
                                    <h3 class="text-lg font-semibold text-white">${food.name}</h3>
                                    <p class="text-sm text-gray-400">${Math.round(food.cals || 0)} kcal · valores por 100 g</p>
                                </div>
                            </div>
                            ${macros}
                            <div>
                                <label for="food-amount" class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300">Cantidad a añadir (g)</label>
                                <input type="number" id="food-amount" value="100" class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-900/60 px-3 py-2 text-center text-sm text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                            </div>
                            <div>
                                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-300 mb-2">Elige la comida</p>
                                <div class="grid grid-cols-2 gap-2">${mealButtons}</div>
                            </div>
                        </div>
                    `;

                    this.showModal('Añadir Alimento', body, [{ text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }]);
                    lucide.createIcons();
                },
                async addFoodToMealFromModal(foodId,mealIndex){const a=parseInt(document.getElementById('food-amount').value);if(isNaN(a)||a<=0){this.showToast("Cantidad inválida.","error");return;}const f = this.getFoodById(foodId);if (!f) { this.showToast("Alimento no encontrado.", "error"); return; }const fac=a/100;this.state.dailyDiet[mealIndex].items.push({...f,amount:a,totalCals:Math.round((f.cals || 0)*fac),totalP:Math.round((f.p || 0)*fac),totalC:Math.round((f.c || 0)*fac),totalF:Math.round((f.f || 0)*fac)});await this.saveDataToFirestore();this.renderAll();this.hideModal();this.showToast(`${f.name} añadido a ${this.state.dailyDiet[mealIndex].name}.`);},
                confirmRemoveFoodFromMeal(mealIndex,itemIndex){this.showModal('Confirmar Eliminación','¿Seguro que quieres eliminar este alimento?',[{text:'Cancelar',class:'bg-gray-600 hover:bg-gray-500',action:'hide-modal'},{text:'Eliminar',class:'bg-red-600 hover:bg-red-500',action:'remove-food','meal-index':mealIndex,'item-index':itemIndex}]);},
                async removeFoodFromMeal(mealIndex,itemIndex){this.state.dailyDiet[mealIndex].items.splice(itemIndex,1);await this.saveDataToFirestore();this.renderAll();this.hideModal();this.showToast('Alimento eliminado.','error');},
                async callGeminiAPI(prompt, button = null) {if (!this.apiKey) { this.showToast("API Key de Gemini no configurada.", "error"); throw new Error("API Key is missing."); }let originalButtonHTML;if(button) { originalButtonHTML = button.innerHTML; button.disabled = true; button.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>`; lucide.createIcons(); }try {const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${this.apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });if (!response.ok) throw new Error('Error en la respuesta de la API.');const result = await response.json();if (!result.candidates || result.candidates.length === 0) throw new Error('Respuesta inválida de la API.');return result.candidates[0].content.parts[0].text;} catch (error) { console.error("Error en llamada a Gemini:", error); this.showToast(error.message || "Error al contactar la IA.", "error"); throw error;} finally { if (button) { button.disabled = false; button.innerHTML = originalButtonHTML; lucide.createIcons(); } }},
                async getDailyTip() {const tipCard = document.getElementById('ai-daily-tip-card');const tipTextEl = document.getElementById('ai-daily-tip-text');if (!tipCard || !tipTextEl) return;tipCard.classList.remove('hidden');const today = new Date().toISOString().split('T')[0];const storedTip = localStorage.getItem('fitTrackDailyTip');if (storedTip) { const tipData = JSON.parse(storedTip); if (tipData.date === today) { tipTextEl.textContent = tipData.tip; lucide.createIcons(); return; } }try {const prompt = "Dame un consejo de fitness corto, motivador e inspirador (menos de 25 palabras) para hoy. Debe ser en español.";const tip = await this.callGeminiAPI(prompt);const newTipData = { date: today, tip: tip.trim() };localStorage.setItem('fitTrackDailyTip', JSON.stringify(newTipData));tipTextEl.textContent = tip.trim();} catch (error) { tipTextEl.textContent = "El esfuerzo de hoy es el éxito de mañana. ¡No te rindas!"; } finally { lucide.createIcons(); }},
                async analyzeFoodWithAI() {const input = document.getElementById('food-analysis-input');const foodDescription = input.value.trim();if (!foodDescription) { this.showToast("Describe una comida para analizar.", "error"); return; }const button = document.querySelector('button[data-action="analyze-food"]');const prompt = `Estima las calorías y los macronutrientes (proteínas, carbohidratos, grasas) para la siguiente comida: "${foodDescription}". Responde únicamente con un objeto JSON válido con el formato: {"name": "Nombre descriptivo", "cals": numero, "p": numero, "c": numero, "f": numero}. No incluyas unidades (como "g" o "kcal"), comentarios ni explicaciones adicionales, solo el JSON.`;try {const textResponse = await this.callGeminiAPI(prompt, button);const cleanJsonString = textResponse.replace(/```json|```/g, '').trim();const foodData = JSON.parse(cleanJsonString);const targetMealIndex = this.state.dailyDiet.length - 1; if (targetMealIndex >= 0) {this.state.dailyDiet[targetMealIndex].items.push({ id: `ai-${Date.now()}`, name: foodData.name || foodDescription, amount: 'N/A', totalCals: foodData.cals, totalP: foodData.p, totalC: foodData.c, totalF: foodData.f, });this.showToast(`${foodData.name || 'Comida'} añadida a la dieta.`);input.value = '';await this.saveDataToFirestore(); this.renderAll();} else { this.showToast("No hay comidas para añadir el alimento.", "error"); }} catch (error) {}},
                async getRecipeForMeal(mealIndex) {const meal = this.state.dailyDiet[mealIndex];if (!meal || meal.items.length === 0) { this.showToast("Añade alimentos a la comida primero.", "error"); return; }const ingredientsList = meal.items.map(item => `${item.name.split('(')[0].trim()} (${item.amount}g)`).join(', ');this.showModal('Generando Receta ✨', '<div class="flex justify-center items-center p-8"><i data-lucide="loader-2" class="w-10 h-10 animate-spin text-purple-400"></i></div>', []);lucide.createIcons();const prompt = `Eres un chef experto en comida saludable. Crea una receta simple y deliciosa usando los siguientes ingredientes: ${ingredientsList}. El objetivo es una comida saludable. Proporciona un nombre creativo para el plato, una lista de ingredientes y las instrucciones paso a paso. Formatea tu respuesta como HTML simple, usando <h2> para el nombre del plato, <h3> para los encabezados (Ingredientes, Instrucciones), y <ul> o <ol> para las listas.`;try {const recipeHtml = await this.callGeminiAPI(prompt);const body = `<div class="text-left prose prose-invert prose-sm max-w-none">${recipeHtml}</div>`;this.showModal(`Receta para ${meal.name} ✨`, body, [{ text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }]);} catch (error) { this.hideModal(); }},
                async showExerciseInfoModal(exerciseName) { const exercise = this.getExerciseByName(exerciseName); let mediaHtml = ''; if (exercise && exercise.mediaUrl) { const isVideo = exercise.mediaUrl.includes('.mp4') || exercise.mediaUrl.includes('video'); if (isVideo) { mediaHtml = `<div class="mb-4 rounded-lg overflow-hidden bg-gray-900"><video src="${exercise.mediaUrl}" autoplay loop muted playsinline class="w-full h-auto object-cover"></video></div>`; } else { mediaHtml = `<div class="mb-4 rounded-lg overflow-hidden bg-gray-900"><img src="${exercise.mediaUrl}" alt="Demostración de ${exercise.name}" class="w-full h-auto object-cover"></div>`; } } else { mediaHtml = `<div class="mb-4 p-4 text-center bg-gray-700/50 rounded-lg text-sm text-gray-400">No hay video/GIF disponible para este ejercicio.</div>`; } this.showModal(`Info: ${exerciseName}`, `${mediaHtml}<div id="ai-instructions-container"><div class="flex justify-center items-center p-4"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-sky-400"></i></div></div>`, [{ text: 'Entendido', class: 'bg-emerald-600 text-gray-900', action: 'hide-modal' }]); lucide.createIcons(); const prompt = `Eres un entrenador personal certificado. Proporciona instrucciones claras y concisas sobre cómo realizar el ejercicio "${exerciseName}". Incluye una sección de "Músculos Principales" y una sección de "Errores Comunes" a evitar. Formatea la respuesta como HTML simple, usando <h3> para los encabezados y <ul> para las listas.`; try { const instructionsHtml = await this.callGeminiAPI(prompt); document.getElementById('ai-instructions-container').innerHTML = `<div class="text-left prose prose-invert prose-sm max-w-none">${instructionsHtml}</div>`; } catch (error) { document.getElementById('ai-instructions-container').innerHTML = `<p class="text-sm text-red-400">No se pudieron cargar las instrucciones.</p>`; } },
                async generatePlanWithAI() {const button = document.querySelector('button[data-action="generate-plan"]');const { calories, protein, carbs, fats } = this.state.userGoals;const prompt = `Crea un plan de comidas de ejemplo para un día completo que cumpla con los siguientes objetivos nutricionales: ${calories} kcal, ${protein}g de proteína, ${carbs}g de carbohidratos y ${fats}g de grasas. El plan debe dividirse en 3 comidas: Desayuno, Almuerzo y Cena. Para cada comida, lista los alimentos y sus cantidades aproximadas en gramos. Responde únicamente con un objeto JSON válido con el formato: {"Desayuno": [{"name": "nombre_alimento", "amount": cantidad_gramos}], "Almuerzo": [...], "Cena": [...]}. No incluyas comentarios ni explicaciones adicionales, solo el JSON.`;try {const textResponse = await this.callGeminiAPI(prompt, button);const cleanJsonString = textResponse.replace(/```json|```/g, '').trim();const mealPlan = JSON.parse(cleanJsonString); this.state.dailyDiet = []; const mealNames = Object.keys(mealPlan);const timeMap = {'Desayuno': '08:00', 'Almuerzo': '13:00', 'Cena': '20:00'}; mealNames.forEach((mealName, index) => {const mealData = {id: `meal-${Date.now() + index}`, name: mealName, time: timeMap[mealName] || '12:00', items: []}; mealPlan[mealName].forEach(food => {const searchTerm = food.name.toLowerCase().split('(')[0].trim().replace(/de|en|con/g, '').trim().split(' ')[0];let dbFood = this.data.foodLibrary.find(f => f.name.toLowerCase().includes(searchTerm)); let foodEntry; if (dbFood) { const factor = food.amount / 100; foodEntry = { ...dbFood, name: `${food.name}`, amount: food.amount, totalCals: Math.round((dbFood.cals||0) * factor), totalP: Math.round((dbFood.p||0) * factor), totalC: Math.round((dbFood.c||0) * factor), totalF: Math.round((dbFood.f||0) * factor) }; } else { foodEntry = { name: food.name, amount: food.amount, totalCals: 150, totalP: 10, totalC: 15, totalF: 5 }; } mealData.items.push(foodEntry);}); this.state.dailyDiet.push(mealData); });this.showToast("¡Plan de dieta generado!");await this.saveDataToFirestore(); this.renderAll();} catch (error) {}},
                async routine_generateExercisesWithAi() {
                    const goalInput = document.getElementById('ai-goal-input');
                    const goal = goalInput.value.trim();
                    if (!goal) {
                        this.showToast("Describe tu objetivo.", "error");
                        return;
                    }

                    const button = document.querySelector('button[data-action="generate-exercises-ai"]');
                    const prompt = `Basado en el siguiente objetivo de entrenamiento: "${goal}", sugiere entre 5 y 7 ejercicios. Responde ÚNICAMENTE con un array JSON de strings, como: ["nombre_ejercicio_1", "nombre_ejercicio_2", ...]. No incluyas texto adicional ni formato markdown. Asegúrate de que los nombres de los ejercicios sean comunes en el gimnasio.`;

                    try {
                        const textResponse = await this.callGeminiAPI(prompt, button);
                        const cleanJsonString = textResponse.replace(/```json|```/g, '').trim();
                        const exercises = JSON.parse(cleanJsonString);
                        const currentDayIndex = this._tempRoutine.currentDayIndex;

                        if (Array.isArray(exercises)) {
                            exercises.forEach(exName => {
                                this._tempRoutine.plan[currentDayIndex].exercises.push({
                                    name: exName,
                                    sets: 4,
                                    reps: '10',
                                    weight: '0 kg',
                                    rest: '60 s'
                                });
                            });
                            this.hideModal();
                            this.routine_refreshExerciseList();
                            this.showToast('¡Ejercicios sugeridos por IA añadidos!');
                        } else {
                            throw new Error('El formato de respuesta de la IA no es válido.');
                        }
                    } catch (error) {
                        this.showToast("No se pudo procesar la sugerencia de la IA. Inténtalo de nuevo.", "error");
                    }
                },
                async analyzeWorkoutPerformance(e) {const button = e.target.closest('[data-action="analyze-workout-performance"]');const logDataString = button.dataset.logData;const log = JSON.parse(decodeURIComponent(logDataString));const goal = document.querySelector('#nutrition-form input[name="goal"]:checked')?.value || 'maintain';const goalMap = { lose: 'perder peso', maintain: 'mantenimiento', gain: 'ganar músculo' };const userGoalText = goalMap[goal];const prompt = `Eres un entrenador de fitness positivo y motivador. Mi objetivo principal es ${userGoalText}. Este es mi registro de entrenamiento de hoy: ${JSON.stringify(log)}. Proporciona un análisis breve (menos de 75 palabras), en español, sobre mi rendimiento. Destaca un aspecto positivo y sugiere una mejora simple y específica para mi próxima sesión. Envuelve el aspecto positivo en etiquetas <strong> y la sugerencia en etiquetas <em>.`;try {const analysisText = await this.callGeminiAPI(prompt, button);const container = document.getElementById('ai-analysis-container');if (container) { container.innerHTML = `<div class="mt-4 pt-4 border-t border-gray-700 text-left"><h4 class="font-bold text-gray-200 flex items-center gap-2"><i data-lucide="sparkles" class="w-5 h-5 text-purple-400"></i>Análisis del Coach IA</h4><p class="text-sm text-gray-300 mt-2 bg-gray-900/50 p-3 rounded-lg">${analysisText}</p></div>`; lucide.createIcons(); button.style.display = 'none'; }} catch (error) {}},
                routine_showAiSuggestionModal() { const body = `<p class="text-gray-300 mb-4">Describe el objetivo para este día de entrenamiento y la IA te sugerirá ejercicios.</p><div><label for="ai-goal-input" class="block text-sm font-medium text-gray-400 mb-1">Objetivo del día</label><input type="text" id="ai-goal-input" class="w-full bg-gray-700 rounded-lg p-2 mt-1 border border-gray-600" placeholder="Ej: Hipertrofia para pecho y hombro"></div>`; const footer = [ {text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal'}, {text: '✨ Generar', class: 'bg-emerald-600 hover:bg-emerald-500 text-gray-900', action: 'generate-exercises-ai'} ]; this.showModal('Sugerencias de la IA', body, footer); setTimeout(() => document.getElementById('ai-goal-input').focus(), 100); },
                getExerciseByName(name) { for (const group in this.data.exerciseLibrary) { for (const subGroup in this.data.exerciseLibrary[group]) { const exercise = this.data.exerciseLibrary[group][subGroup].find(ex => ex.name === name); if (exercise) return exercise; } } return null; },
                renderRoutinesSection() {
                    const userRoutinesContainer = document.getElementById('user-routines-container');
                    const predefinedRoutinesContainer = document.getElementById('predefined-routines-container');
                    if (!userRoutinesContainer || !predefinedRoutinesContainer) return;

                    this.updateRoutineBannerPreview();

                    if (this.state.userRoutines && this.state.userRoutines.length > 0) {
                        userRoutinesContainer.innerHTML = this.state.userRoutines.map(r => this.routine_createUserCardHTML(r)).join('');
                    } else {
                        userRoutinesContainer.innerHTML = `<div class="flex flex-col items-center justify-center w-64 h-40 text-center p-4 bg-gray-700/50 rounded-2xl border-2 border-dashed border-gray-600"><i data-lucide="folder-plus" class="w-8 h-8 text-gray-500 mb-2"></i><p class="text-gray-400 text-sm">${this.isAsesor() ? 'Crea tu primera rutina' : 'No tienes una rutina asignada.'}</p></div>`;
                    }

                    const defaultTheme = {
                        emoji: '✨',
                        badgeLabel: 'Colección signature',
                        title: '',
                        tagline: 'Rituales inmersivos listos para ejecutar en tu calendario.',
                        heroGradient: 'from-emerald-500/20 via-cyan-500/10 to-gray-900/90',
                        chipClasses: 'bg-emerald-500/15 text-emerald-200',
                        glow: 'shadow-[0_45px_120px_-65px_rgba(16,185,129,0.65)]',
                        cardGradient: 'from-emerald-500/15 via-gray-900 to-gray-900',
                        cardIconWrap: 'bg-emerald-500/15 text-emerald-200',
                        cardOverlay: 'from-emerald-400/25 via-transparent to-transparent',
                        cardStatAccent: 'text-emerald-200'
                    };

                        const categoryThemes = {
                            'Clásicos de Hipertrofia': {
                                emoji: '🏆',
                                badgeLabel: 'Legado Pro',
                                title: 'Clásicos de Hipertrofia',
                            tagline: 'Divisiones legendarias reeditadas con seguimiento moderno para volumen sostenido.',
                            heroGradient: 'from-amber-500/25 via-emerald-500/10 to-gray-950/80',
                            chipClasses: 'bg-amber-500/20 text-amber-200',
                            glow: 'shadow-[0_55px_140px_-70px_rgba(245,158,11,0.6)]',
                            cardGradient: 'from-amber-500/15 via-slate-900/80 to-gray-950',
                            cardIconWrap: 'bg-amber-500/15 text-amber-200',
                            cardOverlay: 'from-amber-400/20 via-transparent to-transparent',
                            cardStatAccent: 'text-amber-200'
                        },
                        'Fuerza y Potencia': {
                            emoji: '⚡',
                            badgeLabel: 'Output Máximo',
                            title: 'Fuerza y Potencia',
                            tagline: 'Periodizaciones explosivas con foco neural y métricas de potencia listas para registrar.',
                            heroGradient: 'from-sky-500/30 via-cyan-500/15 to-gray-950/85',
                            chipClasses: 'bg-sky-500/20 text-sky-200',
                            glow: 'shadow-[0_55px_140px_-70px_rgba(56,189,248,0.55)]',
                            cardGradient: 'from-sky-500/20 via-slate-900/80 to-gray-950',
                            cardIconWrap: 'bg-sky-500/20 text-sky-200',
                            cardOverlay: 'from-sky-400/20 via-transparent to-transparent',
                            cardStatAccent: 'text-sky-200'
                        },
                            'Enfoque Femenino': {
                                emoji: '🌸',
                                badgeLabel: 'Flow Curves',
                                title: 'Enfoque Femenino',
                                tagline: 'Secuencias estilizadas para esculpir, equilibrar y potenciar energía femenina.',
                                heroGradient: 'from-rose-400/30 via-fuchsia-500/15 to-gray-950/85',
                                chipClasses: 'bg-rose-500/20 text-rose-200',
                                glow: 'shadow-[0_55px_140px_-70px_rgba(244,114,182,0.55)]',
                                cardGradient: 'from-rose-400/20 via-slate-900/80 to-gray-950',
                                cardIconWrap: 'bg-rose-500/20 text-rose-200',
                                cardOverlay: 'from-rose-400/25 via-transparent to-transparent',
                                cardStatAccent: 'text-rose-200'
                            },
                            'CBUM Signature Series': {
                                emoji: '🏋️‍♂️',
                                badgeLabel: 'Olympia Blueprint',
                                title: 'CBUM Signature Series',
                                tagline: 'Blueprint oficial inspirado en Chris Bumstead con tempos controlados y dominancia estética.',
                                heroGradient: 'from-purple-500/25 via-emerald-500/15 to-gray-950/85',
                                chipClasses: 'bg-purple-500/20 text-purple-200',
                                glow: 'shadow-[0_55px_140px_-70px_rgba(168,85,247,0.55)]',
                                cardGradient: 'from-purple-500/20 via-slate-900/80 to-gray-950',
                                cardIconWrap: 'bg-purple-500/20 text-purple-200',
                                cardOverlay: 'from-purple-400/25 via-transparent to-transparent',
                                cardStatAccent: 'text-purple-200'
                            },
                            'Alta Intensidad': {
                                emoji: '🔥',
                                badgeLabel: 'Impact Chamber',
                                title: 'Alta Intensidad',
                            tagline: 'Microciclos concentrados para atletas avanzados con descansos calculados al segundo.',
                            heroGradient: 'from-orange-500/25 via-red-500/15 to-gray-950/85',
                            chipClasses: 'bg-orange-500/20 text-orange-200',
                            glow: 'shadow-[0_55px_140px_-70px_rgba(249,115,22,0.55)]',
                            cardGradient: 'from-orange-500/20 via-slate-900/80 to-gray-950',
                            cardIconWrap: 'bg-orange-500/20 text-orange-200',
                            cardOverlay: 'from-orange-500/25 via-transparent to-transparent',
                            cardStatAccent: 'text-orange-200'
                        },
                        'Quema de Grasa': {
                            emoji: '💧',
                            badgeLabel: 'Metabolic Wave',
                            title: 'Quema de Grasa',
                            tagline: 'Protocolos híbridos que combinan fuerza funcional y cardio para maximizar el gasto energético.',
                            heroGradient: 'from-lime-400/25 via-emerald-500/15 to-gray-950/85',
                            chipClasses: 'bg-lime-500/20 text-lime-200',
                            glow: 'shadow-[0_55px_140px_-70px_rgba(163,230,53,0.55)]',
                            cardGradient: 'from-lime-400/20 via-slate-900/80 to-gray-950',
                            cardIconWrap: 'bg-lime-500/20 text-lime-200',
                            cardOverlay: 'from-lime-400/25 via-transparent to-transparent',
                            cardStatAccent: 'text-lime-200'
                        }
                    };

                    let predefinedHtml = '';

                    for (const [category, routinesInCategory] of Object.entries(this.data.predefinedRoutines)) {
                        const theme = { ...defaultTheme, ...(categoryThemes[category] || {}) };
                        const routinesCount = routinesInCategory.length;
                        const totalSessions = routinesInCategory.reduce((sum, routine) => sum + ((routine.plan || []).length), 0);
                        const totalExercises = routinesInCategory.reduce((sum, routine) => sum + (routine.plan || []).reduce((acc, day) => acc + ((day.exercises || []).length), 0), 0);
                        const totalSets = routinesInCategory.reduce((sum, routine) => sum + (routine.plan || []).reduce((acc, day) => acc + (day.exercises || []).reduce((setSum, exercise) => setSum + (Number(exercise.sets) || 0), 0), 0), 0);
                        const avgExercisesPerSession = totalSessions ? Math.round(totalExercises / totalSessions) : 0;
                        const avgSetsPerSession = totalSessions ? Math.round(totalSets / totalSessions) : 0;

                        predefinedHtml += `
                            <section class="relative overflow-hidden rounded-3xl border border-white/8 bg-gray-900/60 p-6 lg:p-8 ${theme.glow}">
                                <div class="pointer-events-none absolute inset-0 opacity-90 bg-gradient-to-br ${theme.heroGradient}"></div>
                                <div class="relative z-10 space-y-6">
                                    <div class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
                                        <div class="space-y-4 max-w-3xl">
                                            <div class="flex flex-wrap items-center gap-2 text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-300">
                                                <span class="rounded-full px-3 py-1 ${theme.chipClasses}">${theme.badgeLabel}</span>
                                                <span class="rounded-full px-3 py-1 bg-white/5 text-gray-200/80">${theme.emoji} ${category}</span>
                                            </div>
                                            <h4 class="text-2xl font-bold text-white">${theme.title || category}</h4>
                                            <p class="text-sm text-gray-200/90">${theme.tagline}</p>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3 text-center text-xs uppercase tracking-[0.25em] text-gray-300 sm:grid-cols-4 lg:max-w-md">
                                            <div class="rounded-2xl border border-white/10 bg-gray-900/70 px-4 py-3">
                                                <p class="text-lg font-semibold text-white">${routinesCount}</p>
                                                <p class="mt-1 text-[11px] text-gray-400">Rutinas</p>
                                            </div>
                                            <div class="rounded-2xl border border-white/10 bg-gray-900/70 px-4 py-3">
                                                <p class="text-lg font-semibold text-white">${totalSessions}</p>
                                                <p class="mt-1 text-[11px] text-gray-400">Sesiones</p>
                                            </div>
                                            <div class="rounded-2xl border border-white/10 bg-gray-900/70 px-4 py-3">
                                                <p class="text-lg font-semibold text-white">${avgExercisesPerSession}</p>
                                                <p class="mt-1 text-[11px] text-gray-400">Ejerc./sesión</p>
                                            </div>
                                            <div class="rounded-2xl border border-white/10 bg-gray-900/70 px-4 py-3 hidden sm:block">
                                                <p class="text-lg font-semibold text-white">${avgSetsPerSession}</p>
                                                <p class="mt-1 text-[11px] text-gray-400">Sets/sesión</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="rounded-3xl border border-white/10 bg-gray-950/40 p-4 lg:p-6">
                                        <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
                                            ${routinesInCategory.map(r => this.routine_createPredefinedCardHTML(r, theme)).join('')}
                                        </div>
                                    </div>
                                </div>
                            </section>
                        `;
                    }

                    predefinedRoutinesContainer.innerHTML = predefinedHtml;
                    lucide.createIcons();
                },
                routine_createUserCardHTML(routine) {
    const days = routine.plan.length;
    const totalExercises = routine.plan.reduce((acc, day) => acc + day.exercises.length, 0);

    const hasCover = routine.coverImageUrl;
    const backgroundStyle = hasCover 
        ? `style="background-image: url('${routine.coverImageUrl}');"`
        : '';
    const backgroundClasses = hasCover
        ? 'bg-cover bg-center'
        : 'bg-gradient-to-br from-gray-700 to-gray-800';

    const overlayHTML = hasCover ? '<div class="absolute inset-0 bg-black/60 rounded-2xl"></div>' : '';

    return `
        <button data-action="routine-show-details" data-routine-id="${routine.id}" 
                class="relative flex-shrink-0 w-64 h-40 ${backgroundClasses} rounded-2xl p-4 flex flex-col justify-between text-left hover:ring-2 hover:ring-emerald-400 transition-all shadow-lg overflow-hidden" 
                ${backgroundStyle}>
            ${overlayHTML}
            <div class="relative z-10">
                <h4 class="font-bold text-lg text-white truncate">${routine.name}</h4>
                <p class="text-sm text-gray-300 mt-1 line-clamp-2">${routine.description || 'Sin descripción'}</p>
            </div>
            <div class="relative z-10 flex items-center gap-4 text-xs text-gray-300 font-medium">
                <div class="flex items-center gap-1.5"><i data-lucide="calendar-days" class="w-3.5 h-3.5"></i><span>${days} ${days > 1 ? 'días' : 'día'}</span></div>
                <div class="flex items-center gap-1.5"><i data-lucide="repeat" class="w-3.5 h-3.5"></i><span>${totalExercises} ej.</span></div>
            </div>
        </button>`;
},
                routine_createPredefinedCardHTML(routine, theme = {}) {
                    const plan = routine.plan || [];
                    const days = plan.length;
                    const totalExercises = plan.reduce((sum, day) => sum + ((day.exercises || []).length), 0);
                    const totalSets = plan.reduce((sum, day) => sum + (day.exercises || []).reduce((acc, exercise) => acc + (Number(exercise.sets) || 0), 0), 0);

                    const cardGradient = theme.cardGradient || 'from-emerald-500/15 via-gray-900 to-gray-900';
                    const iconWrap = theme.cardIconWrap || 'bg-emerald-500/15 text-emerald-200';
                    const overlay = theme.cardOverlay || 'from-emerald-400/25 via-transparent to-transparent';
                    const statAccent = theme.cardStatAccent || 'text-emerald-200';

                    return `
                        <button data-action="routine-show-details" data-routine-id="${routine.id}"
                            class="group relative w-full overflow-hidden rounded-2xl border border-white/10 bg-gradient-to-br ${cardGradient} p-5 text-left shadow-[0_25px_70px_-45px_rgba(16,185,129,0.45)] transition-all duration-500 hover:-translate-y-1 hover:border-emerald-400/60 hover:shadow-[0_35px_90px_-40px_rgba(16,185,129,0.55)]">
                            <span class="pointer-events-none absolute inset-0 opacity-0 transition duration-500 group-hover:opacity-100 bg-gradient-to-br ${overlay}"></span>
                            <div class="relative z-10 flex flex-col gap-4">
                                <div class="flex items-center justify-between gap-3">
                                    <div class="flex items-center gap-3">
                                        <span class="flex h-12 w-12 items-center justify-center rounded-xl ${iconWrap}"><i data-lucide="${routine.icon || 'activity'}" class="w-5 h-5"></i></span>
                                        <div>
                                            <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Programa signature</p>
                                            <h4 class="text-lg font-bold text-white leading-tight">${routine.name}</h4>
                                        </div>
                                    </div>
                                    <i data-lucide="arrow-up-right" class="h-5 w-5 text-gray-400 transition group-hover:text-white"></i>
                                </div>
                                <p class="text-sm text-gray-300 line-clamp-3">${routine.description || 'Sesión curada por expertos, lista para ejecutarse.'}</p>
                                <div class="flex flex-wrap gap-2 text-xs font-semibold text-gray-300">
                                    <span class="inline-flex items-center gap-1 rounded-full bg-black/40 px-3 py-1"><i data-lucide="calendar" class="h-3.5 w-3.5 ${statAccent}"></i>${days} ${days === 1 ? 'día' : 'días'}</span>
                                    <span class="inline-flex items-center gap-1 rounded-full bg-black/40 px-3 py-1"><i data-lucide="list-checks" class="h-3.5 w-3.5 ${statAccent}"></i>${totalExercises} ejercicios</span>
                                    <span class="inline-flex items-center gap-1 rounded-full bg-black/40 px-3 py-1"><i data-lucide="repeat-2" class="h-3.5 w-3.5 ${statAccent}"></i>${totalSets} sets</span>
                                </div>
                            </div>
                        </button>
                    `;
                },
                
                routine_showDetails(routineId) {
                    const allRoutines = [...(this.state.userRoutines || []), ...Object.values(this.data.predefinedRoutines).flat()];
                    const routine = allRoutines.find(r => r.id === routineId);
                    if (!routine) return;

                    const today = new Date().toISOString().split('T')[0];
                    const todayEntries = Array.isArray(this.state.workoutHistory?.[today]) ? this.state.workoutHistory[today] : [];

                    const plan = routine.plan || [];
                    const totalDays = plan.length;
                    const totalExercises = plan.reduce((sum, day) => sum + ((day.exercises || []).length), 0);
                    const totalSets = plan.reduce((sum, day) => sum + (day.exercises || []).reduce((acc, exercise) => acc + (Number(exercise.sets) || 0), 0), 0);

                    const heroSectionHTML = `
                        <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-gray-900/70 p-6 lg:p-8 shadow-[0_35px_120px_-70px_rgba(16,185,129,0.75)]">
                            <div class="pointer-events-none absolute inset-0 bg-gradient-to-br from-emerald-500/25 via-cyan-500/10 to-transparent opacity-80"></div>
                            <div class="relative z-10 flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
                                <div class="space-y-5 max-w-3xl">
                                    <div class="flex items-center gap-4">
                                        <span class="flex h-14 w-14 items-center justify-center rounded-2xl bg-white/10 backdrop-blur">
                                            <i data-lucide="${routine.icon || 'dumbbell'}" class="h-7 w-7 text-emerald-200"></i>
                                        </span>
                                        <div class="space-y-1">
                                            <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/80">Colección premium</p>
                                            <h2 class="text-2xl sm:text-3xl font-bold leading-tight text-white">${routine.name}</h2>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-200/90 max-w-2xl">${routine.description}</p>
                                    <div class="flex flex-wrap gap-3 text-xs font-semibold uppercase tracking-[0.25em] text-gray-300">
                                        <span class="flex items-center gap-2 rounded-full border border-white/10 bg-black/30 px-4 py-2"><i data-lucide="calendar-range" class="h-4 w-4 text-emerald-200"></i>${totalDays} ${totalDays === 1 ? 'día' : 'días'}</span>
                                        <span class="flex items-center gap-2 rounded-full border border-white/10 bg-black/30 px-4 py-2"><i data-lucide="list-ordered" class="h-4 w-4 text-emerald-200"></i>${totalExercises} ejercicios</span>
                                        <span class="flex items-center gap-2 rounded-full border border-white/10 bg-black/30 px-4 py-2"><i data-lucide="hash" class="h-4 w-4 text-emerald-200"></i>${totalSets} sets</span>
                                    </div>
                                </div>
                                ${plan.length ? `
                                <div class="flex flex-col gap-4 rounded-3xl border border-emerald-400/30 bg-emerald-500/10 p-5 text-emerald-100 shadow-[0_25px_70px_-45px_rgba(16,185,129,0.65)]">
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200/80">Lanzamiento rápido</p>
                                    <p class="text-lg font-semibold text-white leading-snug">Activa el modo inmersivo y deja que la app marque el ritmo.</p>
                                    <button data-action="start-workout" data-routine-id="${routine.id}" data-day-index="0" class="inline-flex items-center gap-2 rounded-full bg-white px-5 py-2.5 font-semibold text-gray-900 shadow-lg shadow-emerald-500/40 transition hover:bg-emerald-100"><i data-lucide="play" class="h-5 w-5"></i><span>Comenzar Día 1</span></button>
                                </div>
                                ` : ''}
                            </div>
                        </section>
                    `;

                    const daysHTML = plan.map((day, dayIndex) => {
                        const latestEntryToday = todayEntries.slice().reverse().find(entry => entry.routineId === routine.id && entry.dayIndex === dayIndex);
                        const isCompletedToday = Boolean(latestEntryToday);

                        const exercisesHTML = (day.exercises || []).map((ex, exerciseIndex) => `
                            <div class="flex items-start justify-between gap-3 rounded-2xl bg-gray-900/60 p-3 lg:p-4">
                                <div class="flex items-start gap-3">
                                    <span class="mt-0.5 flex h-8 w-8 items-center justify-center rounded-full bg-white/5 text-[11px] font-semibold text-gray-400">${String(exerciseIndex + 1).padStart(2, '0')}</span>
                                    <div class="space-y-1">
                                        <button data-action="show-exercise-info" data-exercise-name="${ex.name}" class="flex items-center gap-2 text-left text-sm font-semibold text-white/90 transition hover:text-emerald-200">
                                            <i data-lucide="info" class="hidden h-4 w-4 text-gray-500 md:block"></i>
                                            <span>${ex.name}</span>
                                        </button>
                                        <p class="text-xs text-gray-400">Descanso ${ex.rest || '60s'}</p>
                                    </div>
                                </div>
                                <span class="rounded-full bg-gray-950/80 px-3 py-1 text-xs font-mono text-gray-300">${ex.sets} x ${ex.reps}</span>
                            </div>
                        `).join('');

                        let actionBlockHTML = '';
                        if (isCompletedToday) {
                            const totalWeight = latestEntryToday.exerciseDetails
                                ? latestEntryToday.exerciseDetails.reduce((total, exercise) => total + exercise.weights.reduce((sum, weight) => sum + weight, 0), 0)
                                : 0;
                            actionBlockHTML = `
                                <div class="mt-5 space-y-3 rounded-2xl border border-emerald-500/40 bg-emerald-500/10 p-4 text-sm text-emerald-100">
                                    <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200"><i data-lucide="sparkles" class="h-4 w-4"></i>Logro del día</div>
                                    <div class="grid grid-cols-2 gap-3 text-center text-xs sm:grid-cols-4">
                                        <div class="rounded-xl bg-emerald-500/10 p-3">
                                            <p class="text-lg font-bold text-white">${totalWeight.toFixed(1)} kg</p>
                                            <p class="mt-1 text-[10px] uppercase tracking-[0.3em] text-emerald-200/70">Peso total</p>
                                        </div>
                                        <div class="rounded-xl bg-emerald-500/10 p-3">
                                            <p class="text-lg font-bold text-white">${this.formatTime(latestEntryToday.totalActive)}</p>
                                            <p class="mt-1 text-[10px] uppercase tracking-[0.3em] text-emerald-200/70">Tiempo activo</p>
                                        </div>
                                        <div class="rounded-xl bg-emerald-500/10 p-3">
                                            <p class="text-lg font-bold text-white">${this.formatTime(latestEntryToday.totalRest)}</p>
                                            <p class="mt-1 text-[10px] uppercase tracking-[0.3em] text-emerald-200/70">Descanso</p>
                                        </div>
                                        <div class="rounded-xl bg-emerald-500/10 p-3">
                                            <p class="text-lg font-bold text-white">${new Intl.NumberFormat('es-ES').format(Math.round(latestEntryToday.totalVolume || 0))}</p>
                                            <p class="mt-1 text-[10px] uppercase tracking-[0.3em] text-emerald-200/70">Volumen</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            actionBlockHTML = `
                                <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                    <p class="text-sm text-gray-400">Prepara tu espacio, conecta el temporizador y lanza la sesión guiada.</p>
                                    <button data-action="start-workout" data-routine-id="${routine.id}" data-day-index="${dayIndex}" class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-5 py-2.5 font-semibold text-gray-900 shadow-lg shadow-emerald-500/30 transition hover:bg-emerald-400"><i data-lucide="play" class="h-5 w-5"></i><span>Iniciar sesión</span></button>
                                </div>
                            `;
                        }

                        return `
                            <article class="relative overflow-hidden rounded-3xl border ${isCompletedToday ? 'border-emerald-400/60 bg-emerald-500/5 shadow-[0_35px_100px_-60px_rgba(16,185,129,0.75)]' : 'border-white/10 bg-gray-900/60 hover:border-emerald-400/40 hover:shadow-[0_30px_90px_-60px_rgba(16,185,129,0.55)]'} p-5 lg:p-6 transition-all duration-500">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="space-y-1">
                                        <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Sesión ${dayIndex + 1}</p>
                                        <h3 class="text-xl font-bold text-white">${day.day}</h3>
                                    </div>
                                    <span class="inline-flex items-center gap-2 rounded-full ${isCompletedToday ? 'bg-emerald-500/20 text-emerald-200' : 'bg-white/10 text-gray-300'} px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em]">
                                        <i data-lucide="${isCompletedToday ? 'check-circle-2' : 'timer'}" class="h-4 w-4"></i>
                                        ${isCompletedToday ? 'Completado hoy' : 'Listo' }
                                    </span>
                                </div>
                                <div class="mt-4 space-y-3">
                                    ${exercisesHTML}
                                </div>
                                ${actionBlockHTML}
                            </article>
                        `;
                    }).join('');

                    const isUserRoutine = routine.id.startsWith('manual-');
                    const deleteButtonHTML = isUserRoutine && this.isAsesor()
                        ? `<button data-action="routine-confirm-delete" data-routine-id="${routine.id}" class="text-red-400 hover:text-red-300 p-2 rounded-full hover:bg-red-500/10"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`
                        : '<div class="w-9 h-9"></div>';

                    const viewHTML = `
                        <div id="routine-details-view" class="fullscreen-view bg-gray-800 w-full h-full flex flex-col">
                            <header class="sticky top-0 z-10 flex items-center justify-between border-b border-white/5 bg-gray-900/85 px-4 py-4 backdrop-blur">
                                <button data-action="routine-close-view" class="rounded-full bg-white/5 p-2 text-gray-200 transition hover:bg-white/10"><i data-lucide="arrow-left"></i></button>
                                <h3 class="text-lg font-bold text-white truncate px-4">${routine.name}</h3>
                                ${deleteButtonHTML}
                            </header>
                            <div class="flex-grow overflow-y-auto space-y-6 px-4 pb-8 pt-4">
                                ${heroSectionHTML}
                                <section class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h4 class="text-lg font-semibold text-white">Sesiones guiadas</h4>
                                        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-500">${totalDays} ${totalDays === 1 ? 'sesión' : 'sesiones'}</p>
                                    </div>
                                    <div class="space-y-5">
                                        ${daysHTML}
                                    </div>
                                </section>
                            </div>
                        </div>
                    `;

                    this.routine_openFullscreenView(viewHTML);
                },

                routine_enterCreator(step) {
                    if (this._boundHandleDrawerResize) {
                        window.removeEventListener('resize', this._boundHandleDrawerResize);
                        this._boundHandleDrawerResize = null;
                    }

                    const targetStep = typeof step === 'undefined' ? 1 : step;
                    if (targetStep === 1) {
                        this._tempRoutine = { id: `manual-${Date.now()}`, name: '', description: '', coverImageUrl: null, plan: [{ day: 'Día 1: Mi Rutina', exercises: [] }], currentDayIndex: 0, editingIndex: -1, modalEditingIndex: -1, editingClientId: null, assignedClientId: '', activeExerciseGroup: '', miniWindowCollapsed: false };
                    }
                    const viewHTML = `<div id="routine-creator-view" class="fullscreen-view bg-gray-900 w-full h-full flex flex-col overflow-hidden">${this.routine_getCreatorContent(targetStep)}</div>`;
                    this.routine_openFullscreenView(viewHTML);

                    if (targetStep === 1) {
                        document.getElementById('routine-cover-image-input')?.addEventListener('change', (e) => this.routine_handleCoverImageSelect(e));
                    }

                    if (targetStep === 2) {
                        this.routine_refreshDayTabs();
                        this.routine_refreshExerciseList();
                        const activeGroup = this._tempRoutine.activeExerciseGroup || Object.keys(this.data.exerciseLibrary)[0];
                        if (activeGroup) {
                            this.routine_creator_switchGroup(activeGroup);
                        }
                        this.initializeGroupCardImageLoading();

                        const panel = document.getElementById('exercise-list-panel');
                        if (panel) {
                            panel.dataset.mobileVisible = window.innerWidth >= 768 ? 'true' : 'false';
                        }

                        this._boundHandleDrawerResize = this.routine_creator_handleDrawerResize.bind(this);
                        window.addEventListener('resize', this._boundHandleDrawerResize);
                        this.routine_creator_handleDrawerResize();
                        if (this.isAsesor()) {
                            this.admin_setupExerciseCreationForm();
                        }
                    }
                },
                routine_getCreatorContent(step) {
                    if (step === 1) {
                        return `
                            <div class="min-h-full flex flex-col bg-gradient-to-b from-gray-950 via-gray-900 to-gray-950">
                                <header class="sticky top-0 z-10 border-b border-white/5 bg-gray-950/80 backdrop-blur">
                                    <div class="mx-auto flex w-full max-w-5xl items-center justify-between px-4 py-4 sm:px-6">
                                        <button data-action="routine-close-view" class="rounded-full bg-white/5 p-2 text-gray-400 transition hover:text-white"><i data-lucide="x"></i></button>
                                        <div class="text-center">
                                            <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-300/80">Crear Rutina</p>
                                            <p class="mt-1 text-sm font-semibold text-white">Paso 1 · Detalles principales</p>
                                        </div>
                                        <div class="h-9 w-9"></div>
                                    </div>
                                    <div class="h-1 w-full bg-white/5">
                                        <div class="h-full w-1/2 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400"></div>
                                    </div>
                                </header>
                                <div class="flex-1 overflow-y-auto overscroll-contain">
                                    <div class="mx-auto flex w-full max-w-5xl flex-col gap-10 px-4 py-8 sm:px-6 sm:py-10">
                                        <section class="overflow-hidden rounded-3xl border border-white/5 bg-white/5 shadow-[0_35px_120px_-60px_rgba(16,185,129,0.85)]">
                                            <div class="grid gap-10 p-6 sm:p-10 lg:grid-cols-[minmax(0,1fr)_minmax(0,1.15fr)]">
                                                <div class="flex flex-col gap-4">
                                                    <div>
                                                        <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/70">Imagen de portada</p>
                                                        <p class="mt-2 text-sm text-gray-300">Resalta tu rutina con una portada envolvente para motivar a tus asesorados.</p>
                                                    </div>
                                                    <label for="routine-cover-image-input" class="group relative block aspect-[4/3] overflow-hidden rounded-2xl border border-white/10 bg-gray-950/60 transition hover:border-emerald-400/60">
                                                        <input type="file" accept="image/*" id="routine-cover-image-input" class="absolute inset-0 h-full w-full cursor-pointer opacity-0">
                                                        <div id="cover-image-placeholder" class="flex h-full flex-col items-center justify-center gap-3 text-gray-400">
                                                            <span class="grid h-16 w-16 place-items-center rounded-full border border-white/10 bg-white/5 text-white transition group-hover:border-emerald-400/50 group-hover:text-emerald-200">
                                                                <i data-lucide="image"></i>
                                                            </span>
                                                            <div class="text-center">
                                                                <p class="text-sm font-semibold text-white">Arrastra o selecciona una imagen</p>
                                                                <p class="text-xs text-gray-500">Ideal 1280 × 720 px</p>
                                                            </div>
                                                        </div>
                                                        <img id="routine-cover-preview" class="hidden h-full w-full object-cover" alt="Vista previa de la portada">
                                                    </label>
                                                    <div id="cover-upload-progress-container" class="hidden items-center gap-3 rounded-2xl border border-white/10 bg-gray-950/70 px-4 py-3">
                                                        <div class="h-2 flex-1 overflow-hidden rounded-full bg-white/10">
                                                            <div id="cover-upload-progress-bar" class="h-full w-0 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 transition-[width] duration-300"></div>
                                                        </div>
                                                        <span id="cover-upload-progress-text" class="text-xs font-semibold text-gray-300"></span>
                                                    </div>
                                                </div>
                                                <div class="flex flex-col gap-6">
                                                    <div>
                                                        <label for="routine-name-input" class="text-sm font-semibold text-gray-200">Nombre de la rutina</label>
                                                        <input id="routine-name-input" type="text" placeholder="Ej. Fuerza Total" class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-950/60 px-4 py-3 text-white shadow-inner focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400" value="${this._tempRoutine?.name || ''}">
                                                    </div>
                                                    <div class="flex flex-col gap-3">
                                                        <label for="routine-desc-input" class="text-sm font-semibold text-gray-200">Descripción</label>
                                                        <textarea id="routine-desc-input" rows="6" placeholder="Describe objetivos, nivel de intensidad y sensaciones que buscará esta rutina." class="w-full resize-none rounded-2xl border border-white/10 bg-gray-950/60 px-4 py-3 text-white shadow-inner focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">${this._tempRoutine?.description || ''}</textarea>
                                                    </div>
                                                    <div class="flex flex-col gap-4 text-sm text-gray-400 sm:flex-row sm:items-center sm:justify-between">
                                                        <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200/80">
                                                            <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
                                                            <span>50% Completado</span>
                                                        </div>
                                                        <button data-action="routine-creator-next" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 px-6 py-3 font-semibold text-gray-900 transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                                            <span>Siguiente paso</span>
                                                            <i data-lucide="arrow-right"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    if (step === 2) {
                        const isAdmin = this.isAsesor();
                        const assignedClientId = this._tempRoutine.assignedClientId || this._tempRoutine.editingClientId;
                        const assignedClient = assignedClientId ? (this.state.asesorados || []).find(c => c.id === assignedClientId) : null;
                        const assignmentInfo = assignedClient ? `<p class="mt-1 text-[11px] font-semibold uppercase tracking-[0.25em] text-emerald-200/80">Asignada a ${assignedClient.userName}</p>` : '';
                        const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex] || { day: '', exercises: [] };
                        const dayName = currentDay.day || `Día ${this._tempRoutine.currentDayIndex + 1}`;
                        const totalExercises = currentDay.exercises.length;
                        const dayStatus = !totalExercises
                            ? 'Aún sin ejercicios'
                            : totalExercises === 1
                                ? '1 ejercicio configurado'
                                : `${totalExercises} ejercicios configurados`;
                        const groupImages = this.data.exerciseGroupImages || {};
                        const groupKeys = Object.keys(this.data.exerciseLibrary);
                        const firstGroup = groupKeys[0] || '';
                        const activeGroup = this._tempRoutine.activeExerciseGroup || firstGroup;
                        this._tempRoutine.activeExerciseGroup = activeGroup;
                        this.preloadExerciseGroupImages(activeGroup);
                        const groupsNav = `<aside id="exercise-group-nav" class="flex-1 w-full shrink-0 overflow-y-auto border-b border-white/5 bg-gray-950/80 md:w-80 md:flex-none md:border-b-0 md:border-r md:max-h-full md:overflow-y-auto">
                            <div class="grid grid-cols-1 gap-4 p-5 sm:grid-cols-2 md:grid-cols-1">
                                ${groupKeys.map(group => {
                                        const rawUrl = groupImages[group] || '';
                                        const sanitizedUrl = rawUrl.replace(/'/g, "\'");
                                        const hasImage = Boolean(rawUrl);
                                        const isActiveGroup = group === activeGroup;
                                        const fetchPriority = isActiveGroup ? 'high' : 'auto';
                                        if (hasImage) {
                                            this.preloadImage(rawUrl, { priority: fetchPriority });
                                        }
                                        const fallbackClasses = `image-fallback absolute inset-0 ${hasImage ? 'hidden' : 'flex'} items-center justify-center bg-gradient-to-br from-emerald-500/30 via-teal-500/20 to-sky-500/25 text-emerald-100/80 pointer-events-none`;
                                        const imageContent = `
                                            <div class="group-image-shell relative h-full w-full overflow-hidden">
                                                ${hasImage ? '<div class="image-loading-placeholder pointer-events-none"></div>' : ''}
                                                <div class="${fallbackClasses}">
                                                    <i data-lucide="dumbbell" class="h-10 w-10"></i>
                                                </div>
                                                ${hasImage ? `<img src="${sanitizedUrl}" alt="Grupo muscular ${group}" class="routine-group-image h-full w-full object-cover opacity-0 transition-opacity duration-500" decoding="async" loading="eager" fetchpriority="${fetchPriority}">` : ''}
                                            </div>
                                        `;
                                        const editButton = isAdmin
                                            ? `<button type="button" data-action="routine-creator-edit-group-image" data-group-target="${group}" class="absolute right-4 top-4 inline-flex h-11 w-11 items-center justify-center rounded-full border border-white/15 bg-gray-950/85 text-white shadow-lg transition hover:-translate-y-0.5 hover:border-white/40 hover:bg-white hover:text-gray-900"><i data-lucide="image-up" class="h-5 w-5"></i></button>`
                                            : '';
                                        const accentConfig = (() => {
                                            const base = {
                                                icon: 'dumbbell',
                                                highlight: 'text-emerald-200',
                                                badgeLabel: 'Activación total',
                                                badgeClass: 'border border-emerald-400/40 bg-emerald-500/15 text-emerald-100',
                                                gradientBorder: 'from-emerald-500/40 via-teal-500/20 to-sky-500/35',
                                                glowOne: 'bg-emerald-500/30',
                                                glowTwo: 'bg-sky-500/20',
                                                tagline: 'Activa y fortalece este grupo muscular con precisión y control.',
                                                ctaGradient: 'from-emerald-300 via-teal-300 to-sky-300',
                                                ctaTextClass: 'text-gray-900'
                                            };
                                            const key = group.toLowerCase();
                                            if (key.includes('pecho')) {
                                                return {
                                                    ...base,
                                                    icon: 'activity',
                                                    highlight: 'text-rose-200',
                                                    badgeLabel: 'Foco torácico',
                                                    badgeClass: 'border border-rose-400/40 bg-rose-500/15 text-rose-100',
                                                    gradientBorder: 'from-rose-500/45 via-fuchsia-500/25 to-amber-400/20',
                                                    glowOne: 'bg-rose-500/30',
                                                    glowTwo: 'bg-amber-400/25',
                                                    tagline: 'Expande la potencia del pecho con ángulos completos y controlados.',
                                                    ctaGradient: 'from-rose-300 via-fuchsia-300 to-amber-200'
                                                };
                                            }
                                            if (key.includes('espalda')) {
                                                return {
                                                    ...base,
                                                    icon: 'layers',
                                                    highlight: 'text-sky-200',
                                                    badgeLabel: 'Tracción suprema',
                                                    badgeClass: 'border border-sky-400/40 bg-sky-500/15 text-sky-100',
                                                    gradientBorder: 'from-sky-500/45 via-cyan-500/25 to-indigo-400/20',
                                                    glowOne: 'bg-sky-500/30',
                                                    glowTwo: 'bg-indigo-400/25',
                                                    tagline: 'Amplía tu espalda con movimientos de tracción envolventes.',
                                                    ctaGradient: 'from-sky-300 via-cyan-300 to-indigo-200'
                                                };
                                            }
                                            if (key.includes('pierna') || key.includes('glúte') || key.includes('glute')) {
                                                return {
                                                    ...base,
                                                    icon: 'mountain',
                                                    highlight: 'text-lime-200',
                                                    badgeLabel: 'Potencia inferior',
                                                    badgeClass: 'border border-lime-400/40 bg-lime-500/15 text-lime-100',
                                                    gradientBorder: 'from-lime-400/45 via-emerald-500/25 to-green-400/20',
                                                    glowOne: 'bg-lime-400/30',
                                                    glowTwo: 'bg-emerald-500/25',
                                                    tagline: 'Desarrolla piernas explosivas con secuencias estables y fluidas.',
                                                    ctaGradient: 'from-lime-300 via-emerald-300 to-green-200'
                                                };
                                            }
                                            if (key.includes('hombro') || key.includes('delto')) {
                                                return {
                                                    ...base,
                                                    icon: 'sun',
                                                    highlight: 'text-amber-200',
                                                    badgeLabel: 'Rotación 360°',
                                                    badgeClass: 'border border-amber-400/40 bg-amber-500/15 text-amber-100',
                                                    gradientBorder: 'from-amber-500/40 via-orange-500/25 to-emerald-400/20',
                                                    glowOne: 'bg-amber-500/30',
                                                    glowTwo: 'bg-orange-400/25',
                                                    tagline: 'Ilumina tus hombros con patrones de rotación controlados.',
                                                    ctaGradient: 'from-amber-300 via-orange-300 to-emerald-200'
                                                };
                                            }
                                            if (key.includes('brazo') || key.includes('bíceps') || key.includes('tríceps') || key.includes('biceps') || key.includes('triceps')) {
                                                return {
                                                    ...base,
                                                    icon: 'sparkle',
                                                    highlight: 'text-purple-200',
                                                    badgeLabel: 'Fuerza definida',
                                                    badgeClass: 'border border-purple-400/40 bg-purple-500/15 text-purple-100',
                                                    gradientBorder: 'from-purple-500/45 via-violet-500/25 to-indigo-400/20',
                                                    glowOne: 'bg-purple-500/30',
                                                    glowTwo: 'bg-indigo-400/25',
                                                    tagline: 'Moldea brazos definidos con tempos precisos y conectados.',
                                                    ctaGradient: 'from-purple-300 via-violet-300 to-indigo-200'
                                                };
                                            }
                                            if (key.includes('core') || key.includes('abdomen') || key.includes('abdominal')) {
                                                return {
                                                    ...base,
                                                    icon: 'target',
                                                    highlight: 'text-cyan-200',
                                                    badgeLabel: 'Estabilidad central',
                                                    badgeClass: 'border border-cyan-400/40 bg-cyan-500/15 text-cyan-100',
                                                    gradientBorder: 'from-cyan-500/45 via-sky-500/25 to-blue-400/20',
                                                    glowOne: 'bg-cyan-500/30',
                                                    glowTwo: 'bg-blue-400/25',
                                                    tagline: 'Construye un núcleo firme con respiración consciente y control.',
                                                    ctaGradient: 'from-cyan-300 via-sky-300 to-blue-200'
                                                };
                                            }
                                            return base;
                                        })();
                                        return `
                                        <article role="button" tabindex="0" data-action="routine-creator-switch-group" data-group-target="${group}" data-active="${isActiveGroup}" class="group relative isolate flex h-full cursor-pointer flex-col overflow-hidden rounded-3xl border border-white/10 bg-gray-950/75 text-left shadow-[0_25px_80px_-50px_rgba(20,184,166,0.55)] transition-all duration-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-950 hover:-translate-y-1 hover:border-emerald-300/60 hover:shadow-[0_35px_120px_-60px_rgba(20,184,166,0.7)] data-[active=true]:border-emerald-300 data-[active=true]:shadow-[0_45px_140px_-60px_rgba(16,185,129,0.85)]">
                                            <div class="pointer-events-none absolute inset-0 overflow-hidden">
                                                <div class="absolute -inset-px rounded-[28px] bg-gradient-to-br ${accentConfig.gradientBorder} opacity-0 transition duration-500 group-hover:opacity-100 data-[active=true]:opacity-100"></div>
                                                <div class="absolute inset-x-10 -top-16 h-28 ${accentConfig.glowOne} blur-3xl transition duration-500 group-hover:scale-110 data-[active=true]:scale-110"></div>
                                                <div class="absolute inset-x-12 bottom-0 h-32 ${accentConfig.glowTwo} blur-[120px] transition duration-500 group-hover:opacity-90"></div>
                                            </div>
                                            <div class="relative z-10 flex h-full flex-col">
                                                <div class="relative aspect-[4/3] w-full overflow-hidden">
                                                    ${imageContent}
                                                    <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/80 via-black/35 to-transparent"></div>
                                                    <div class="pointer-events-none absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-black/70 via-black/10 to-transparent"></div>
                                                    <div class="absolute left-4 top-4 inline-flex items-center gap-2 rounded-full border border-white/20 bg-black/60 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-white/80">
                                                        <i data-lucide="aperture" class="h-3.5 w-3.5"></i>
                                                        Zona clave
                                                    </div>
                                                    ${editButton}
                                                </div>
                                                <div class="flex flex-1 flex-col justify-between px-5 pb-5 pt-6">
                                                    <div class="space-y-4">
                                                        <div class="flex items-center gap-3">
                                                            <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl border border-white/10 bg-white/5 text-lg ${accentConfig.highlight}">
                                                                <i data-lucide="${accentConfig.icon}" class="h-6 w-6"></i>
                                                            </span>
                                                            <div class="space-y-1">
                                                                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Grupo muscular</p>
                                                                <h3 class="text-2xl font-bold leading-tight text-white">${group}</h3>
                                                            </div>
                                                        </div>
                                                        <p class="text-sm leading-relaxed text-gray-300">${accentConfig.tagline}</p>
                                                    </div>
                                                    <div class="mt-6 flex items-center justify-between gap-3">
                                                        <span class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-[11px] font-semibold uppercase tracking-[0.35em] ${accentConfig.badgeClass}">
                                                            <i data-lucide="sparkles" class="h-4 w-4"></i>
                                                            ${accentConfig.badgeLabel}
                                                        </span>
                                                        <span class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r ${accentConfig.ctaGradient} px-4 py-2 text-xs font-semibold ${accentConfig.ctaTextClass} shadow-[0_18px_45px_-25px_rgba(20,184,166,0.9)] transition group-hover:translate-x-1 group-data-[active=true]:translate-x-1">
                                                            Explorar
                                                            <i data-lucide="arrow-right" class="h-4 w-4"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </article>
                                    `;
                                }).join('')}
                            </div>
                        </aside>`;
                        const exercisesPanel = `
                        <section id="exercise-list-panel" data-mobile-visible="false" class="hidden flex-1 flex-col overflow-y-auto bg-gray-950/60 md:flex">
                            <header class="sticky top-0 z-20 flex items-center justify-between gap-3 border-b border-white/5 bg-gray-950/90 px-4 py-4 md:hidden">
                                <button data-action="routine-creator-back-to-groups" class="rounded-full bg-white/10 p-2 text-gray-300 transition hover:text-white">
                                    <i data-lucide="arrow-left"></i>
                                </button>
                                <div class="min-w-0 flex-1 text-center">
                                    <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/70">Ejercicios</p>
                                    <h3 id="active-group-title" class="mt-1 truncate text-base font-semibold text-white">${activeGroup}</h3>
                                </div>
                                <div class="h-9 w-9"></div>
                            </header>
                            <div class="space-y-8 p-5 sm:p-8">
                                ${Object.entries(this.data.exerciseLibrary).map(([group, subGroups]) => `
                                    <div data-group-content="${group}" class="${group === activeGroup ? 'space-y-6' : 'hidden space-y-6'}">
                                        ${Object.entries(subGroups).map(([subGroup, exercises]) => `
                                            <div data-subgroup-content="${subGroup}" class="space-y-4">
                                                <div class="flex items-center justify-between gap-2">
                                                    <h4 class="text-sm font-semibold uppercase tracking-[0.3em] text-emerald-200/80">${subGroup}</h4>
                                                    ${isAdmin ? `<button data-action="routine-creator-switch-group" data-group-target="${group}" class="hidden"></button>` : ''}
                                                </div>
                                                <div class="grid gap-5">
                                                    ${exercises.map((ex, exIndex) => `
                                                        <div class="exercise-item group relative flex flex-col gap-5 rounded-2xl border border-white/5 bg-white/5 p-5 shadow-[0_25px_60px_-45px_rgba(56,189,248,0.55)] transition hover:border-emerald-300/70 sm:flex-row sm:items-center" data-exercise-name="${ex.name}">
                                                            <button data-action="show-media-viewer" data-media-url="${ex.mediaUrl || ''}" class="relative h-36 w-full overflow-hidden rounded-2xl bg-gray-900/80 sm:h-40 sm:w-48">
                                                                ${ex.mediaUrl ? `<img src="${ex.mediaUrl}" alt="${ex.name}" class="h-full w-full object-cover transition duration-500 group-hover:scale-105">` : `<div class="flex h-full w-full items-center justify-center text-gray-500"><i data-lucide="image-off" class="h-10 w-10"></i></div>`}
                                                                <span class="absolute left-3 top-3 rounded-full bg-black/70 px-3 py-1 text-xs font-semibold text-white">${subGroup}</span>
                                                            </button>
                                                            <div class="flex flex-1 flex-col gap-4">
                                                                <div>
                                                                    <p class="text-base font-semibold text-white">${ex.name}</p>
                                                                    <div class="mt-1 flex flex-wrap items-center gap-3 text-xs text-gray-400">
                                                                        ${isAdmin ? `<button data-action="admin-edit-exercise" data-group="${group}" data-subgroup="${subGroup}" data-exercise-index="${exIndex}" class="inline-flex items-center gap-1 text-emerald-300/80 transition hover:text-emerald-100"><i data-lucide="pencil" class="h-3.5 w-3.5"></i>Editar ejercicio</button>` : ''}
                                                                        ${isAdmin ? `<button data-action="admin-edit-media" data-group="${group}" data-subgroup="${subGroup}" data-exercise-index="${exIndex}" class="inline-flex items-center gap-1 text-amber-300/80 transition hover:text-amber-200"><i data-lucide="camera" class="h-3.5 w-3.5"></i>Editar media</button>` : ''}
                                                                        ${isAdmin ? `<button data-action="admin-confirm-delete-exercise" data-group="${group}" data-subgroup="${subGroup}" data-exercise-index="${exIndex}" class="inline-flex items-center gap-1 text-rose-300/80 transition hover:text-rose-200"><i data-lucide="trash-2" class="h-3.5 w-3.5"></i>Eliminar</button>` : ''}
                                                                        <button data-action="show-exercise-info" data-exercise-name="${ex.name}" class="inline-flex items-center gap-1 text-sky-300/80 transition hover:text-sky-200"><i data-lucide="info" class="h-3.5 w-3.5"></i>Instrucciones</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <button data-action="routine-creator-select-exercise" data-exercise-name="${ex.name}" class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-gradient-to-br from-emerald-400 via-teal-400 to-cyan-400 text-gray-900 shadow-lg transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                                                <i data-lucide="plus" class="h-6 w-6"></i>
                                                            </button>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </section>`;
                        return `
                            <div class="min-h-full flex flex-col bg-gradient-to-b from-gray-950 via-gray-900 to-gray-950">
                                <header class="sticky top-0 z-30 border-b border-white/5 bg-gray-950/80 backdrop-blur">
                                    <div class="mx-auto flex w-full max-w-6xl items-center justify-between gap-3 px-4 py-4 sm:px-6">
                                        <button data-action="routine-close-view" class="rounded-full bg-white/5 p-2 text-gray-400 transition hover:text-white">
                                            <i data-lucide="arrow-left"></i>
                                        </button>
                                        <div class="min-w-0 flex-1 text-center">
                                            <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-300/80">Paso 2 · Planifica tu rutina</p>
                                            <h3 class="mt-1 truncate text-lg font-semibold text-white">${this._tempRoutine.name}</h3>
                                            ${assignmentInfo}
                                        </div>
                                        <button data-action="routine-creator-save" class="hidden sm:inline-flex items-center justify-center rounded-2xl bg-white/10 px-4 py-2 text-sm font-semibold text-emerald-300 transition hover:bg-emerald-400/10 hover:text-emerald-200">
                                            Guardar
                                        </button>
                                    </div>
                                    <div class="bg-gray-950/60 border-t border-white/5">
                                        <div class="mx-auto w-full max-w-6xl px-4 sm:px-6">
                                            <div id="routine-day-tabs" class="horizontal-scroll-container flex items-center gap-2 overflow-x-auto py-3"></div>
                                        </div>
                                    </div>
                                </header>
                                <div class="flex-1 overflow-y-auto pb-28 sm:pb-12">
                                    <div class="mx-auto flex w-full max-w-6xl flex-col gap-6 px-4 py-6 sm:px-6 sm:py-10">
                                        ${isAdmin ? `
                                        <section class="rounded-3xl border border-white/5 bg-white/5 p-5 shadow-[0_35px_120px_-60px_rgba(16,185,129,0.85)] sm:p-8">
                                            <div class="flex flex-col gap-6">
                                                <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
                                                    <div>
                                                        <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/80">Nuevo ejercicio</p>
                                                        <h2 class="text-2xl font-semibold text-white sm:text-3xl">Añade movimientos a tu biblioteca</h2>
                                                        <p class="mt-2 text-sm leading-relaxed text-gray-300">Crea ejercicios personalizados con imagen y clasifícalos para que estén disponibles al planificar cada día.</p>
                                                        <p class="mt-3 text-xs text-gray-500">Configurando <span class="font-semibold text-emerald-200">${dayName}</span>. ${dayStatus}.</p>
                                                    </div>
                                                </div>
                                                <form id="create-exercise-form" class="grid gap-6 lg:grid-cols-[minmax(0,1.05fr)_minmax(0,0.95fr)]" autocomplete="off">
                                                    <div class="space-y-5">
                                                        <div>
                                                            <label for="new-exercise-name" class="text-sm font-semibold text-gray-200">Nombre del ejercicio</label>
                                                            <input id="new-exercise-name" type="text" placeholder="Ej. Remo con mancuerna unilateral" class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-950/60 px-4 py-3 text-white shadow-inner focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                                        </div>
                                                        <div class="space-y-4">
                                                            <div>
                                                                <p class="text-sm font-semibold text-gray-200">Clasificación</p>
                                                                <p class="text-xs text-gray-500">Selecciona el grupo muscular y subgrupo donde estará disponible este movimiento.</p>
                                                            </div>
                                                            <div class="grid gap-4 sm:grid-cols-2">
                                                                <div class="flex flex-col gap-2">
                                                                    <span class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/80">Grupo muscular</span>
                                                                    <select id="new-exercise-group" class="w-full rounded-2xl border border-white/10 bg-gray-950/60 px-3 py-3 text-sm font-medium text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                                                        <option value="" ${activeGroup ? '' : 'selected'} disabled>Selecciona un grupo muscular</option>
                                                                        ${groupKeys.map(group => `<option value="${group}" ${group === activeGroup ? 'selected' : ''}>${group}</option>`).join('')}
                                                                        <option value="__new__">Crear nuevo grupo muscular</option>
                                                                    </select>
                                                                </div>
                                                                <div class="flex flex-col gap-2">
                                                                    <span class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/80">Subgrupo</span>
                                                                    <select id="new-exercise-subgroup" class="w-full rounded-2xl border border-white/10 bg-gray-950/60 px-3 py-3 text-sm font-medium text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                                                        <option value="" selected disabled>Selecciona un subgrupo</option>
                                                                        ${(this.data.exerciseLibrary[activeGroup] ? Object.keys(this.data.exerciseLibrary[activeGroup]) : []).map(sub => `<option value="${sub}">${sub}</option>`).join('')}
                                                                        <option value="__new__">Crear nuevo subgrupo</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <div data-new-group-field class="hidden flex-col gap-2">
                                                                <label for="new-exercise-group-name" class="text-sm font-semibold text-gray-200">Nombre del nuevo grupo muscular</label>
                                                                <input id="new-exercise-group-name" type="text" placeholder="Ej. Antebrazo" class="rounded-2xl border border-white/10 bg-gray-950/60 px-4 py-3 text-white shadow-inner focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                                            </div>
                                                            <div data-new-subgroup-field class="hidden flex-col gap-2">
                                                                <label for="new-exercise-subgroup-name" class="text-sm font-semibold text-gray-200">Nombre del nuevo subgrupo</label>
                                                                <input id="new-exercise-subgroup-name" type="text" placeholder="Ej. Flexores" class="rounded-2xl border border-white/10 bg-gray-950/60 px-4 py-3 text-white shadow-inner focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex flex-col gap-5">
                                                        <div class="flex flex-col gap-2">
                                                            <label for="new-exercise-image" class="text-sm font-semibold text-gray-200">Imagen del ejercicio</label>
                                                            <p class="text-xs text-gray-500">Utiliza un formato horizontal o cuadrado para lograr la mejor visualización.</p>
                                                        </div>
                                                        <label for="new-exercise-image" class="group relative block aspect-[4/3] overflow-hidden rounded-2xl border border-dashed border-emerald-400/40 bg-gray-950/60 transition hover:border-emerald-300/60">
                                                            <input type="file" accept="image/*" id="new-exercise-image" class="absolute inset-0 h-full w-full cursor-pointer opacity-0">
                                                            <div id="new-exercise-image-placeholder" class="flex h-full flex-col items-center justify-center gap-3 text-emerald-200/80">
                                                                <span class="grid h-14 w-14 place-items-center rounded-full border border-emerald-400/40 bg-emerald-500/10 text-emerald-200 transition group-hover:border-emerald-300 group-hover:bg-emerald-400/10">
                                                                    <i data-lucide="upload-cloud" class="h-6 w-6"></i>
                                                                </span>
                                                                <div class="text-center">
                                                                    <p class="text-sm font-semibold text-white">Sube una imagen representativa</p>
                                                                    <p class="text-xs text-gray-500">PNG, JPG o GIF · Máx. 5 MB</p>
                                                                </div>
                                                            </div>
                                                            <img id="new-exercise-preview" class="hidden h-full w-full object-cover transition duration-500 group-hover:scale-[1.01]" alt="Vista previa del ejercicio">
                                                        </label>
                                                        <div id="new-exercise-upload-progress-container" class="hidden items-center gap-3 rounded-2xl border border-white/10 bg-gray-950/70 px-4 py-3">
                                                            <div class="h-2 flex-1 overflow-hidden rounded-full bg-white/10">
                                                                <div id="new-exercise-upload-progress-bar" class="h-full w-0 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 transition-[width] duration-300"></div>
                                                            </div>
                                                            <span id="new-exercise-upload-progress-text" class="text-xs font-semibold text-gray-300"></span>
                                                        </div>
                                                        <button type="submit" data-role="submit-new-exercise" class="inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-emerald-500 px-5 py-3 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/20 transition hover:bg-emerald-400">
                                                            <i data-lucide="plus"></i>
                                                            <span data-label>Guardar ejercicio</span>
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </section>
                                        ` : ''}
                                        <section class="rounded-3xl border border-white/5 bg-white/5 p-5 sm:p-8">
                                            <div class="flex flex-col gap-5 sm:flex-row sm:items-center sm:justify-between">
                                                <div class="flex flex-col gap-1">
                                                    <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/80">Acciones rápidas</p>
                                                    <h3 class="text-lg font-semibold text-white">Construye tu sesión perfecta</h3>
                                                    <p class="text-sm text-gray-300">Añade ejercicios manualmente o deja que nuestra IA proponga combinaciones inteligentes.</p>
                                                </div>
                                                <div class="flex flex-col gap-3 sm:flex-row">
                                                    <button data-action="routine-creator-add-exercise" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-emerald-500 px-5 py-3 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/20 transition hover:bg-emerald-400">
                                                        <i data-lucide="plus"></i>
                                                        <span>Añadir ejercicio</span>
                                                    </button>
                                                    <button data-action="routine-creator-suggest-ai" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-purple-500 to-indigo-600 px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-purple-500/20 transition hover:opacity-90">
                                                        <i data-lucide="sparkles"></i>
                                                        <span>Sugerir con IA</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </section>
                                        <section class="overflow-hidden rounded-3xl border border-white/5 bg-white/5">
                                            <div class="flex flex-col gap-6 p-5 sm:p-8">
                                                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                                    <div>
                                                        <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/80">Listado de ejercicios</p>
                                                        <p class="text-sm text-gray-300">Edita sets, repeticiones y descansos en cada bloque para afinar la experiencia del día.</p>
                                                    </div>
                                                    <button data-action="routine-creator-add-exercise" class="inline-flex items-center justify-center gap-2 rounded-2xl border border-emerald-400/40 px-4 py-2 text-sm font-semibold text-emerald-200 transition hover:border-emerald-300 hover:text-emerald-100">
                                                        <i data-lucide="plus"></i>
                                                        <span>Nuevo ejercicio</span>
                                                    </button>
                                                </div>
                                                <div id="exercise-list-container" class="space-y-4"></div>
                                            </div>
                                        </section>
                                        <div id="exercise-mini-window" data-collapsed="false" class="pointer-events-none fixed inset-x-0 bottom-0 z-[45] mx-auto hidden w-full max-w-3xl px-3 pb-[calc(env(safe-area-inset-bottom,0px)+0.25rem)] sm:px-4">
                                            <div class="pointer-events-auto overflow-hidden rounded-t-2xl rounded-b-none border border-white/10 bg-gray-950/95 shadow-[0_16px_40px_-28px_rgba(16,185,129,0.6)] backdrop-blur sm:rounded-t-3xl">
                                                <div class="flex flex-col">
                                                    <div class="flex items-center justify-between gap-3 px-3 py-2 sm:px-4 sm:py-2.5">
                                                        <div class="space-y-0.5">
                                                            <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-200/70">Resumen rápido</p>
                                                            <p data-mini-count class="text-xs font-semibold text-white">Sin ejercicios añadidos</p>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <button data-action="routine-toggle-mini-window" class="inline-flex items-center gap-1.5 rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[10px] font-semibold text-gray-200 transition hover:border-emerald-300/50 hover:text-white sm:px-3 sm:py-1.5 sm:text-xs">
                                                                <span data-mini-toggle-label>Plegar</span>
                                                                <i data-lucide="chevron-down" data-mini-toggle-icon class="h-4 w-4 transition-transform"></i>
                                                            </button>
                                                            <button data-action="routine-open-timeline" class="inline-flex items-center gap-1.5 rounded-full border border-emerald-400/40 bg-emerald-500 px-3 py-1 text-[10px] font-semibold text-gray-900 shadow-sm shadow-emerald-500/20 transition hover:border-emerald-300 hover:bg-emerald-400 sm:px-4 sm:py-1.5 sm:text-xs">
                                                                <i data-lucide="route" class="h-4 w-4"></i>
                                                                <span>Ver rutina</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="border-t border-white/5 bg-gray-950/85 px-3 pb-2 pt-2 sm:px-4 sm:pt-3" data-mini-content>
                                                        <div data-thumbnail-strip id="exercise-thumbnail-strip" class="thumbnail-strip flex snap-x gap-2.5 overflow-x-auto pb-1.5">
                                                            <p class="text-[11px] font-medium text-gray-400">Los ejercicios que añadas aparecerán aquí.</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="routine-timeline-overlay" class="fixed inset-0 z-50 hidden flex-col justify-end" aria-hidden="true">
                                            <div data-action="routine-close-timeline" class="sheet-backdrop absolute inset-0 bg-gray-950/60 backdrop-blur-sm"></div>
                                            <section class="mobile-sheet relative z-10 mt-auto w-full rounded-t-3xl border border-white/10 bg-gray-900/95 shadow-[0_-25px_60px_-35px_rgba(16,185,129,0.65)]">
                                                <div class="mx-auto h-1 w-12 rounded-full bg-white/10 pt-3"></div>
                                                <header class="flex items-center justify-between px-6 pt-2 pb-4">
                                                    <div>
                                                        <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/70">Vista de línea de tiempo</p>
                                                        <h3 class="text-xl font-bold text-white">Rutina planificada</h3>
                                                    </div>
                                                    <button data-action="routine-close-timeline" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-400 transition hover:border-emerald-400/60 hover:bg-emerald-500/10 hover:text-white">
                                                        <i data-lucide="x"></i>
                                                    </button>
                                                </header>
                                                <div data-role="timeline-content" class="flex max-h-[70vh] flex-col gap-6 overflow-y-auto px-6 pb-6">
                                                    <ul id="routine-timeline-items" class="flex flex-col gap-5"></ul>
                                                    <button data-action="routine-timeline-save" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 px-5 py-3 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/20 transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                                        <i data-lucide="save"></i>
                                                        <span>Guardar rutina</span>
                                                    </button>
                                                </div>
                                                <div data-role="timeline-confirmation" class="hidden px-6 pb-8">
                                                    <div class="rounded-3xl border border-emerald-400/30 bg-emerald-500/10 p-6 text-center shadow-inner shadow-emerald-500/20">
                                                        <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-emerald-500 text-gray-900">
                                                            <i data-lucide="check"></i>
                                                        </div>
                                                        <h4 class="mt-4 text-lg font-semibold text-white">Rutina guardada con éxito</h4>
                                                        <p class="mt-2 text-sm text-emerald-100/80">Decide tu siguiente paso: vincula la rutina con un asesorado o comienza a ejecutarla.</p>
                                                        <div class="mt-6 flex flex-col gap-3">
                                                            <button data-action="routine-timeline-confirm-link" class="inline-flex items-center justify-center gap-2 rounded-2xl border border-emerald-400/40 bg-white/5 px-5 py-3 text-sm font-semibold text-emerald-200 transition hover:border-emerald-300 hover:text-emerald-100">
                                                                <i data-lucide="users"></i>
                                                                <span>Vincular con asesorado</span>
                                                            </button>
                                                            <button data-action="routine-timeline-confirm-start" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-emerald-500 px-5 py-3 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/30 transition hover:bg-emerald-400">
                                                                <i data-lucide="zap"></i>
                                                                <span>Comenzar</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </section>
                                        </div>
                                        <div id="exercise-edit-modal" class="fixed inset-0 z-50 hidden flex-col justify-end" aria-hidden="true">
                                            <div data-action="routine-close-edit-modal" class="sheet-backdrop absolute inset-0 bg-gray-950/60 backdrop-blur-sm"></div>
                                            <section class="mobile-sheet relative z-10 mt-auto w-full px-0">
                                                <div class="flex max-h-[min(92vh,640px)] w-full flex-col overflow-hidden rounded-t-3xl border border-white/10 bg-gray-900/95 shadow-[0_-25px_60px_-35px_rgba(16,185,129,0.65)]">
                                                    <div class="px-6 pt-4">
                                                        <div class="mx-auto mb-4 h-1 w-12 rounded-full bg-white/10"></div>
                                                        <div class="flex items-center justify-between gap-4">
                                                            <div>
                                                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/70">Editar ejercicio</p>
                                                                <h3 id="exercise-modal-name" class="text-lg font-bold text-white"></h3>
                                                            </div>
                                                            <button data-action="routine-close-edit-modal" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-400 transition hover:border-emerald-400/60 hover:bg-emerald-500/10 hover:text-white">
                                                                <i data-lucide="x"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="flex-1 overflow-y-auto px-6 pb-6">
                                                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                            <label class="flex flex-col gap-2 rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-gray-300">
                                                                <span class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200/70">Series</span>
                                                                <input id="modal-sets-input" type="number" min="1" class="w-full rounded-xl border border-white/10 bg-gray-900/70 px-3 py-2 text-base font-semibold text-white focus:border-emerald-400 focus:outline-none" />
                                                            </label>
                                                            <label class="flex flex-col gap-2 rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-gray-300">
                                                                <span class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200/70">Repeticiones</span>
                                                                <input id="modal-reps-input" type="text" class="w-full rounded-xl border border-white/10 bg-gray-900/70 px-3 py-2 text-base font-semibold text-white focus:border-emerald-400 focus:outline-none" />
                                                            </label>
                                                            <label class="flex flex-col gap-2 rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-gray-300">
                                                                <span class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200/70">Peso objetivo</span>
                                                                <input id="modal-weight-input" type="text" class="w-full rounded-xl border border-white/10 bg-gray-900/70 px-3 py-2 text-base font-semibold text-white focus:border-emerald-400 focus:outline-none" placeholder="Ej. 20 kg" />
                                                            </label>
                                                            <label class="flex flex-col gap-2 rounded-2xl border border-white/10 bg-white/5 p-4 text-sm text-gray-300">
                                                                <span class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200/70">Descanso</span>
                                                                <input id="modal-rest-input" type="text" class="w-full rounded-xl border border-white/10 bg-gray-900/70 px-3 py-2 text-base font-semibold text-white focus:border-emerald-400 focus:outline-none" placeholder="Ej. 60 s" />
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="px-6 pb-[calc(1.5rem+env(safe-area-inset-bottom,0px))]">
                                                        <div class="flex flex-col gap-3 sm:flex-row">
                                                            <button data-action="routine-close-edit-modal" class="inline-flex w-full items-center justify-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-5 py-3 text-sm font-semibold text-gray-300 transition hover:border-emerald-400/40 hover:text-white">
                                                                <span>Cancelar</span>
                                                            </button>
                                                            <button data-action="routine-save-exercise-modal" class="inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-emerald-500 px-5 py-3 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/30 transition hover:bg-emerald-400">
                                                                <i data-lucide="check-circle"></i>
                                                                <span>Guardar cambios</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </section>
                                        </div>
                                    </div>
                                </div>
                                <footer class="sticky bottom-0 z-30 border-t border-white/5 bg-gray-950/90 px-4 pb-[calc(1rem+env(safe-area-inset-bottom,0px))] pt-3 backdrop-blur sm:px-6">
                                    <div class="mx-auto flex w-full max-w-6xl flex-col gap-3 sm:flex-row">
                                        <button data-action="routine-creator-add-exercise" class="inline-flex w-full flex-1 items-center justify-center gap-2 rounded-2xl bg-emerald-500 px-5 py-3 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/20 transition hover:bg-emerald-400">
                                            <i data-lucide="plus"></i>
                                            <span>Añadir ejercicio</span>
                                        </button>
                                        <button data-action="routine-creator-save" class="inline-flex w-full flex-1 items-center justify-center gap-2 rounded-2xl border border-emerald-400/40 bg-transparent px-5 py-3 text-sm font-semibold text-emerald-200 transition hover:border-emerald-300 hover:text-emerald-100">
                                            <i data-lucide="save"></i>
                                            <span>Guardar rutina</span>
                                        </button>
                                    </div>
                                </footer>
                            </div>
                            <div id="exercise-drawer" class="fixed inset-0 z-40 flex flex-col justify-end bg-gray-950/80 backdrop-blur-lg">
                                <div class="mx-auto flex h-full w-full max-w-6xl flex-col overflow-hidden border border-white/10 bg-gray-950/95 pt-[env(safe-area-inset-top,0px)] shadow-[0_-35px_80px_-40px_rgba(16,185,129,0.65)] max-h-screen">
                                    <header class="flex items-center gap-3 border-b border-white/5 bg-gray-950/90 px-4 py-4 sm:px-6">
                                        <div class="flex flex-1 flex-col gap-1">
                                            <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/80">Añadir ejercicios</p>
                                            <div class="relative">
                                                <i data-lucide="search" class="pointer-events-none absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-500"></i>
                                                <input id="exercise-search-input" type="search" placeholder="Busca por nombre, grupo o patrón de movimiento" class="w-full rounded-2xl border border-white/10 bg-gray-900/80 py-2.5 pl-10 pr-4 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                            </div>
                                        </div>
                                        <button data-action="routine-creator-close-drawer" class="rounded-full bg-white/5 p-2 text-gray-400 transition hover:text-white">
                                            <i data-lucide="x"></i>
                                        </button>
                                    </header>
                                    <div id="exercise-drawer-content" class="flex flex-1 flex-col overflow-hidden md:flex-row" data-current-group="${activeGroup}">
                                        ${groupsNav}
                                        ${exercisesPanel}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                },
                // ▼▼▼ CÓDIGO A INSERTAR ▼▼▼
                routine_handleCoverImageSelect(event) {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede actualizar esta portada.', 'error');
                        if (event?.target) event.target.value = '';
                        return;
                    }
                    const file = event.target.files[0];
                    if (!file) return;

                    const preview = document.getElementById('routine-cover-preview');
                    const placeholder = document.getElementById('cover-image-placeholder');
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    };

                    reader.readAsDataURL(file);
                    this.routine_uploadCoverImage(file);
                },

                async routine_uploadCoverImage(file) {
                    if (!this.canEditGlobalMedia()) {
                        this.showToast('Solo el administrador puede actualizar esta portada.', 'error');
                        return;
                    }
                    if (!file) return;

                    const progressContainer = document.getElementById('cover-upload-progress-container');
                    const progressBar = document.getElementById('cover-upload-progress-bar');
                    const progressText = document.getElementById('cover-upload-progress-text');

                    progressContainer.style.display = 'flex';

                    const filePath = `routine_covers/${this._tempRoutine.id}-${file.name}`;
                    const storageRef = ref(this.storage, filePath);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = progress + '%';
                            progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                        },
                        (error) => {
                            console.error("Upload failed:", error);
                            this.showToast('Error al subir la imagen.', 'error');
                            progressText.textContent = 'Error en la subida';
                        },
                        async () => {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            this._tempRoutine.coverImageUrl = downloadURL;
                            progressText.textContent = '¡Subido con éxito!';
                            document.getElementById('routine-cover-image-input').disabled = true;
                            setTimeout(() => { progressContainer.style.display = 'none'; }, 2000);
                        }
                    );
                },
                // ▲▲▲ FIN DEL CÓDIGO A INSERTAR ▲▲▲
                
                routine_handleCreatorNext() {
                    const name = document.getElementById('routine-name-input').value.trim();
                    const desc = document.getElementById('routine-desc-input').value.trim();
                    if (!name) { this.showToast('El nombre es obligatorio', 'error'); return; }
                    this._tempRoutine.name = name;
                    this._tempRoutine.description = desc;
                    this.routine_enterCreator(2);
                },
                routine_showAddExerciseDrawer() {
                    const drawer = document.getElementById('exercise-drawer');
                    if (!drawer) return;

                    drawer.classList.add('is-active');

                    const panel = document.getElementById('exercise-list-panel');
                    if (panel) {
                        panel.dataset.mobileVisible = window.innerWidth >= 768 ? 'true' : 'false';
                    }

                    this.routine_creator_handleDrawerResize();

                    const searchInput = document.getElementById('exercise-search-input');
                    if (searchInput) searchInput.focus();
                },
                routine_closeAddExerciseDrawer() {
                    const drawer = document.getElementById('exercise-drawer');
                    if (drawer) drawer.classList.remove('is-active');

                    const panel = document.getElementById('exercise-list-panel');
                    if (panel && window.innerWidth < 768) {
                        panel.dataset.mobileVisible = 'false';
                        this.routine_creator_handleDrawerResize();
                    }
                },
                routine_creator_switchGroup(targetGroup) {
                    const navButtons = document.querySelectorAll('#exercise-group-nav [data-action="routine-creator-switch-group"]');
                    navButtons.forEach(btn => {
                        const isActive = btn.dataset.groupTarget === targetGroup;
                        btn.dataset.active = isActive;
                        if (isActive) {
                            btn.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
                        }
                    });

                    document.querySelectorAll('#exercise-list-panel [data-group-content]').forEach(panel => {
                        panel.classList.toggle('hidden', panel.dataset.groupContent !== targetGroup);
                    });

                    this._tempRoutine.activeExerciseGroup = targetGroup;

                    const drawerContent = document.getElementById('exercise-drawer-content');
                    if (drawerContent) {
                        drawerContent.dataset.currentGroup = targetGroup;
                    }

                    const panel = document.getElementById('exercise-list-panel');
                    if (panel) {
                        panel.dataset.mobileVisible = 'true';
                        if (window.innerWidth < 768) {
                            panel.classList.remove('hidden');
                            panel.classList.add('flex');
                            panel.scrollTop = 0;
                        }
                    }

                    const groupTitle = document.getElementById('active-group-title');
                    if (groupTitle) groupTitle.textContent = targetGroup;

                    this.routine_creator_handleDrawerResize();
                },
                routine_creator_showGroupList() {
                    const panel = document.getElementById('exercise-list-panel');
                    if (panel) {
                        if (window.innerWidth < 768) {
                            panel.dataset.mobileVisible = 'false';
                            panel.scrollTop = 0;
                        } else {
                            panel.dataset.mobileVisible = 'true';
                        }
                    }

                    this.routine_creator_handleDrawerResize();
                },
                routine_creator_handleDrawerResize() {
                    const nav = document.getElementById('exercise-group-nav');
                    const panel = document.getElementById('exercise-list-panel');
                    if (!nav || !panel) return;

                    if (window.innerWidth >= 768) {
                        nav.classList.remove('hidden');
                        panel.classList.remove('hidden');
                        panel.classList.remove('flex');
                        panel.dataset.mobileVisible = 'true';
                        return;
                    }

                    const shouldShowExercises = panel.dataset.mobileVisible === 'true';
                    if (shouldShowExercises) {
                        nav.classList.add('hidden');
                        panel.classList.remove('hidden');
                        panel.classList.add('flex');
                    } else {
                        nav.classList.remove('hidden');
                        panel.classList.add('hidden');
                        panel.classList.remove('flex');
                    }
                },
                admin_setupExerciseCreationForm() {
                    if (!this.isAsesor()) return;

                    const form = document.getElementById('create-exercise-form');
                    if (!form) return;

                    const groupSelect = form.querySelector('#new-exercise-group');
                    const subgroupSelect = form.querySelector('#new-exercise-subgroup');
                    const newGroupField = form.querySelector('[data-new-group-field]');
                    const newSubgroupField = form.querySelector('[data-new-subgroup-field]');
                    const newGroupInput = form.querySelector('#new-exercise-group-name');
                    const newSubgroupInput = form.querySelector('#new-exercise-subgroup-name');
                    const imageInput = form.querySelector('#new-exercise-image');
                    const previewImage = form.querySelector('#new-exercise-preview');
                    const placeholder = form.querySelector('#new-exercise-image-placeholder');

                    const handleSubgroupChange = () => {
                        if (!subgroupSelect) return;
                        if (subgroupSelect.value === '__new__') {
                            newSubgroupField?.classList.remove('hidden');
                            newSubgroupInput?.focus();
                        } else {
                            newSubgroupField?.classList.add('hidden');
                            if (newSubgroupInput) newSubgroupInput.value = '';
                        }
                    };

                    const populateSubgroups = (groupName) => {
                        if (!subgroupSelect) return;
                        if (!groupName || groupName === '__new__') {
                            subgroupSelect.innerHTML = '<option value="__new__" selected>Crear nuevo subgrupo</option>';
                            subgroupSelect.value = '__new__';
                            subgroupSelect.disabled = true;
                            handleSubgroupChange();
                            return;
                        }

                        const subgroups = Object.keys(this.data.exerciseLibrary?.[groupName] || {});
                        const placeholderSelected = subgroups.length === 0 ? ' selected' : '';
                        subgroupSelect.innerHTML = `
                            <option value="" disabled${placeholderSelected}>Selecciona un subgrupo</option>
                            ${subgroups.map(sub => `<option value="${sub}">${sub}</option>`).join('')}
                            <option value="__new__">Crear nuevo subgrupo</option>
                        `;
                        subgroupSelect.disabled = false;
                        if (subgroups.length > 0) {
                            subgroupSelect.value = subgroups[0];
                        } else {
                            subgroupSelect.value = '__new__';
                        }
                        handleSubgroupChange();
                    };

                    const handleGroupChange = () => {
                        if (!groupSelect) return;
                        const value = groupSelect.value;
                        if (value === '__new__') {
                            newGroupField?.classList.remove('hidden');
                            newGroupInput?.focus();
                        } else {
                            newGroupField?.classList.add('hidden');
                            if (newGroupInput) newGroupInput.value = '';
                        }
                        populateSubgroups(value);
                    };

                    if (groupSelect) {
                        if (!groupSelect.value) {
                            const groupKeys = Object.keys(this.data.exerciseLibrary || {});
                            groupSelect.value = groupKeys[0] || '__new__';
                        }
                        handleGroupChange();
                        groupSelect.addEventListener('change', handleGroupChange);
                    }

                    if (subgroupSelect) {
                        subgroupSelect.addEventListener('change', handleSubgroupChange);
                    }

                    if (imageInput) {
                        imageInput.addEventListener('change', () => {
                            const file = imageInput.files?.[0];
                            if (!file) {
                                if (previewImage) previewImage.classList.add('hidden');
                                placeholder?.classList.remove('hidden');
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                if (previewImage) {
                                    previewImage.src = e.target?.result || '';
                                    previewImage.classList.remove('hidden');
                                }
                                placeholder?.classList.add('hidden');
                            };
                            reader.readAsDataURL(file);
                        });
                    }

                    form.addEventListener('submit', (event) => this.admin_handleExerciseCreation(event));
                },
                async admin_handleExerciseCreation(event) {
                    event.preventDefault();
                    if (!this.isAsesor()) {
                        this.showToast('Acción no permitida.', 'error');
                        return;
                    }

                    const form = event.currentTarget;
                    const nameInput = form.querySelector('#new-exercise-name');
                    const groupSelect = form.querySelector('#new-exercise-group');
                    const subgroupSelect = form.querySelector('#new-exercise-subgroup');
                    const newGroupInput = form.querySelector('#new-exercise-group-name');
                    const newSubgroupInput = form.querySelector('#new-exercise-subgroup-name');
                    const imageInput = form.querySelector('#new-exercise-image');
                    const progressContainer = form.querySelector('#new-exercise-upload-progress-container');
                    const progressBar = form.querySelector('#new-exercise-upload-progress-bar');
                    const progressText = form.querySelector('#new-exercise-upload-progress-text');
                    const submitButton = form.querySelector('[data-role="submit-new-exercise"]');
                    const labelElement = submitButton?.querySelector('[data-label]');
                    const originalLabel = labelElement?.textContent || 'Guardar ejercicio';

                    const exerciseName = nameInput?.value.trim();
                    if (!exerciseName) {
                        this.showToast('El nombre del ejercicio es obligatorio.', 'error');
                        nameInput?.focus();
                        return;
                    }

                    const groupValue = groupSelect?.value || '';
                    let groupName = groupValue;
                    if (!groupValue) {
                        this.showToast('Selecciona un grupo muscular.', 'error');
                        groupSelect?.focus();
                        return;
                    }
                    if (groupValue === '__new__') {
                        groupName = newGroupInput?.value.trim();
                        if (!groupName) {
                            this.showToast('Escribe el nombre del nuevo grupo muscular.', 'error');
                            newGroupInput?.focus();
                            return;
                        }
                    }

                    let subgroupName = subgroupSelect?.value || '';
                    const needsNewSubgroup = groupValue === '__new__' || subgroupSelect?.value === '__new__';
                    if (needsNewSubgroup) {
                        subgroupName = newSubgroupInput?.value.trim();
                        if (!subgroupName) {
                            this.showToast('Escribe el nombre del nuevo subgrupo.', 'error');
                            newSubgroupInput?.focus();
                            return;
                        }
                    } else if (!subgroupName) {
                        this.showToast('Selecciona un subgrupo.', 'error');
                        subgroupSelect?.focus();
                        return;
                    }

                    const file = imageInput?.files?.[0];
                    if (!file) {
                        this.showToast('Sube una imagen del ejercicio.', 'error');
                        imageInput?.focus();
                        return;
                    }

                    const existingList = this.data.exerciseLibrary[groupName]?.[subgroupName] || [];
                    if (existingList.some(ex => ex.name.toLowerCase() === exerciseName.toLowerCase())) {
                        this.showToast('Ya existe un ejercicio con ese nombre en este subgrupo.', 'error');
                        nameInput?.focus();
                        return;
                    }

                    const toggleButtonState = (loading) => {
                        if (!submitButton) return;
                        submitButton.disabled = loading;
                        submitButton.classList.toggle('opacity-60', loading);
                        submitButton.classList.toggle('cursor-not-allowed', loading);
                        if (labelElement) {
                            labelElement.textContent = loading ? 'Guardando...' : originalLabel;
                        }
                    };

                    const showProgress = () => {
                        progressContainer?.classList.remove('hidden');
                        if (progressBar) progressBar.style.width = '0%';
                        if (progressText) progressText.textContent = 'Preparando subida...';
                    };

                    const hideProgress = () => {
                        progressContainer?.classList.add('hidden');
                        if (progressBar) progressBar.style.width = '0%';
                        if (progressText) progressText.textContent = '';
                    };

                    toggleButtonState(true);
                    showProgress();

                    const slugify = (value) => value
                        .toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-+|-+$/g, '') || 'general';

                    const storagePath = `exercise_media/${slugify(groupName)}/${slugify(subgroupName)}-${Date.now()}-${file.name.replace(/\s+/g, '-')}`;
                    const storageRef = ref(this.storage, storagePath);

                    let shouldReload = false;
                    try {
                        const downloadURL = await new Promise((resolve, reject) => {
                            const uploadTask = uploadBytesResumable(storageRef, file);
                            uploadTask.on('state_changed',
                                (snapshot) => {
                                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                    if (progressBar) progressBar.style.width = `${progress}%`;
                                    if (progressText) progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                                },
                                (error) => reject(error),
                                async () => {
                                    const url = await getDownloadURL(uploadTask.snapshot.ref);
                                    resolve(url);
                                }
                            );
                        });

                        if (!this.data.exerciseLibrary[groupName]) {
                            this.data.exerciseLibrary[groupName] = {};
                        }
                        if (!Array.isArray(this.data.exerciseLibrary[groupName][subgroupName])) {
                            this.data.exerciseLibrary[groupName][subgroupName] = [];
                        }

                        this.data.exerciseLibrary[groupName][subgroupName].push({ name: exerciseName, mediaUrl: downloadURL });
                        this.data.exerciseLibrary[groupName][subgroupName].sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));

                        const docRef = doc(this.db, 'app_data', 'exercise_library');
                        await setDoc(docRef, this.data.exerciseLibrary);

                        shouldReload = true;
                        this._tempRoutine.activeExerciseGroup = groupName;
                        this.showToast('Ejercicio creado correctamente.', 'success');
                    } catch (error) {
                        console.error('Error creating exercise:', error);
                        this.showToast('No se pudo crear el ejercicio.', 'error');
                    } finally {
                        toggleButtonState(false);
                        hideProgress();
                    }

                    if (shouldReload) {
                        this.routine_enterCreator(2);
                    }
                },
                admin_showEditExerciseModal(group, subGroup, exerciseIndex) {
                    if (!this.isAsesor()) return;

                    const index = parseInt(exerciseIndex, 10);
                    if (Number.isNaN(index)) return;

                    const exercise = this.data.exerciseLibrary?.[group]?.[subGroup]?.[index];
                    if (!exercise) {
                        this.showToast('No se encontró el ejercicio seleccionado.', 'error');
                        return;
                    }

                    const groupOptions = Object.keys(this.data.exerciseLibrary || {});
                    if (groupOptions.length === 0) {
                        this.showToast('No hay grupos disponibles para editar.', 'error');
                        return;
                    }

                    const initialSubgroups = Object.keys(this.data.exerciseLibrary[group] || {});
                    const safeName = (exercise.name || '').replace(/"/g, '&quot;');
                    const subgroupOptions = initialSubgroups.length
                        ? initialSubgroups.map(sub => `<option value="${sub}" ${sub === subGroup ? 'selected' : ''}>${sub}</option>`).join('')
                        : '<option value="" disabled selected>No hay subgrupos disponibles</option>';
                    const subgroupDisabled = initialSubgroups.length ? '' : 'disabled';

                    const body = `
                        <div class="space-y-5">
                            <div class="flex flex-col gap-2">
                                <label for="admin-edit-exercise-name" class="text-sm font-semibold text-gray-200">Nombre del ejercicio</label>
                                <input id="admin-edit-exercise-name" type="text" value="${safeName}" class="rounded-2xl border border-white/10 bg-gray-950/60 px-4 py-3 text-white shadow-inner focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="Ej. Press inclinado con mancuernas">
                            </div>
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div class="flex flex-col gap-2">
                                    <label for="admin-edit-exercise-group" class="text-sm font-semibold text-gray-200">Grupo muscular</label>
                                    <select id="admin-edit-exercise-group" class="rounded-2xl border border-white/10 bg-gray-950/60 px-3 py-3 text-sm font-medium text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                        ${groupOptions.map(option => `<option value="${option}" ${option === group ? 'selected' : ''}>${option}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label for="admin-edit-exercise-subgroup" class="text-sm font-semibold text-gray-200">Subgrupo</label>
                                    <select id="admin-edit-exercise-subgroup" class="rounded-2xl border border-white/10 bg-gray-950/60 px-3 py-3 text-sm font-medium text-white focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400" ${subgroupDisabled}>
                                        ${subgroupOptions}
                                    </select>
                                    <p id="admin-edit-exercise-subgroup-empty" class="text-xs text-amber-300/80 ${initialSubgroups.length ? 'hidden' : ''}">Crea un subgrupo dentro de este grupo para poder asignar el ejercicio.</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400">Para actualizar la imagen utiliza la opción <strong>Editar media</strong>.</p>
                        </div>
                    `;

                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                        { text: 'Guardar cambios', class: 'bg-emerald-600 text-gray-900 hover:bg-emerald-500', action: 'admin-save-exercise', group, subgroup: subGroup, 'exercise-index': exerciseIndex, id: 'admin-save-exercise-btn' }
                    ];

                    this.showModal(`Editar ejercicio: ${exercise.name}`, body, footer);
                    lucide.createIcons();

                    const groupSelect = document.getElementById('admin-edit-exercise-group');
                    const subgroupSelect = document.getElementById('admin-edit-exercise-subgroup');
                    const emptyHelper = document.getElementById('admin-edit-exercise-subgroup-empty');

                    const populateSubgroups = (targetGroup, desiredSubgroup) => {
                        if (!subgroupSelect) return;
                        const subgroups = Object.keys(this.data.exerciseLibrary[targetGroup] || {});
                        if (subgroups.length === 0) {
                            subgroupSelect.innerHTML = '<option value="" disabled selected>No hay subgrupos disponibles</option>';
                            subgroupSelect.disabled = true;
                            emptyHelper?.classList.remove('hidden');
                            return;
                        }

                        subgroupSelect.disabled = false;
                        emptyHelper?.classList.add('hidden');
                        subgroupSelect.innerHTML = subgroups.map(sub => `<option value="${sub}">${sub}</option>`).join('');
                        subgroupSelect.value = desiredSubgroup && subgroups.includes(desiredSubgroup) ? desiredSubgroup : subgroups[0];
                    };

                    if (groupSelect) {
                        groupSelect.addEventListener('change', (event) => {
                            populateSubgroups(event.target.value, '');
                        });
                    }

                    populateSubgroups(group, subGroup);
                },
                async admin_saveExerciseChanges(group, subGroup, exerciseIndex) {
                    if (!this.isAsesor()) {
                        this.showToast('Acción no permitida.', 'error');
                        return;
                    }

                    const originalGroup = group;
                    const originalSubGroup = subGroup;
                    const index = parseInt(exerciseIndex, 10);
                    if (Number.isNaN(index)) return;

                    const nameInput = document.getElementById('admin-edit-exercise-name');
                    const groupSelect = document.getElementById('admin-edit-exercise-group');
                    const subgroupSelect = document.getElementById('admin-edit-exercise-subgroup');

                    if (!nameInput || !groupSelect || !subgroupSelect) {
                        this.showToast('Formulario incompleto.', 'error');
                        return;
                    }

                    const newName = nameInput.value.trim();
                    if (!newName) {
                        this.showToast('El nombre del ejercicio es obligatorio.', 'error');
                        nameInput.focus();
                        return;
                    }

                    const targetGroup = groupSelect.value;
                    if (!targetGroup) {
                        this.showToast('Selecciona un grupo muscular.', 'error');
                        groupSelect.focus();
                        return;
                    }

                    const targetSubgroup = subgroupSelect.value;
                    if (!targetSubgroup) {
                        this.showToast('Selecciona un subgrupo.', 'error');
                        subgroupSelect.focus();
                        return;
                    }

                    const normalizedName = newName.toLowerCase();
                    const targetList = this.data.exerciseLibrary[targetGroup]?.[targetSubgroup] || [];
                    const hasDuplicate = targetList.some((item, idx) => item.name.toLowerCase() === normalizedName && !(targetGroup === originalGroup && targetSubgroup === originalSubGroup && idx === index));
                    if (hasDuplicate) {
                        this.showToast('Ya existe un ejercicio con ese nombre en el subgrupo seleccionado.', 'error');
                        nameInput.focus();
                        return;
                    }

                    const footerButtons = document.getElementById('custom-modal-footer')?.querySelectorAll('button');
                    footerButtons?.forEach(btn => btn.disabled = true);

                    try {
                        const updatedLibrary = JSON.parse(JSON.stringify(this.data.exerciseLibrary));
                        const originalList = updatedLibrary?.[originalGroup]?.[originalSubGroup];
                        if (!originalList || !originalList[index]) {
                            this.showToast('No se encontró el ejercicio seleccionado.', 'error');
                            footerButtons?.forEach(btn => btn.disabled = false);
                            return;
                        }

                        const [exerciseData] = originalList.splice(index, 1);
                        if (originalList.length === 0) {
                            delete updatedLibrary[originalGroup][originalSubGroup];
                        }
                        if (Object.keys(updatedLibrary[originalGroup] || {}).length === 0) {
                            delete updatedLibrary[originalGroup];
                        }

                        if (!updatedLibrary[targetGroup]) {
                            updatedLibrary[targetGroup] = {};
                        }
                        if (!Array.isArray(updatedLibrary[targetGroup][targetSubgroup])) {
                            updatedLibrary[targetGroup][targetSubgroup] = [];
                        }

                        updatedLibrary[targetGroup][targetSubgroup].push({ ...exerciseData, name: newName });
                        updatedLibrary[targetGroup][targetSubgroup].sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));

                        const docRef = doc(this.db, 'app_data', 'exercise_library');
                        await setDoc(docRef, updatedLibrary);

                        this.data.exerciseLibrary = updatedLibrary;
                        this._tempRoutine.activeExerciseGroup = targetGroup;

                        this.showToast('Ejercicio actualizado correctamente.', 'success');
                        this.hideModal();
                        this.routine_enterCreator(2);
                    } catch (error) {
                        console.error('Error updating exercise:', error);
                        this.showToast('No se pudo actualizar el ejercicio.', 'error');
                        footerButtons?.forEach(btn => btn.disabled = false);
                    }
                },
                admin_confirmDeleteExercise(group, subGroup, exerciseIndex) {
                    if (!this.isAsesor()) return;

                    const index = parseInt(exerciseIndex, 10);
                    if (Number.isNaN(index)) return;

                    const exercise = this.data.exerciseLibrary?.[group]?.[subGroup]?.[index];
                    if (!exercise) {
                        this.showToast('No se encontró el ejercicio seleccionado.', 'error');
                        return;
                    }

                    const body = `
                        <div class="space-y-4">
                            <p class="text-sm text-gray-300">¿Seguro que deseas eliminar <strong class="text-white">${exercise.name}</strong>? Esta acción no se puede deshacer.</p>
                            <div class="rounded-2xl border border-white/10 bg-gray-900/70 p-4 text-xs text-gray-400">
                                <p>Se eliminará del grupo <span class="font-semibold text-emerald-200">${group}</span> y del subgrupo <span class="font-semibold text-emerald-200">${subGroup}</span>.</p>
                            </div>
                        </div>
                    `;

                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                        { text: 'Eliminar', class: 'bg-rose-600 text-white hover:bg-rose-500', action: 'admin-delete-exercise', group, subgroup: subGroup, 'exercise-index': exerciseIndex, id: 'admin-delete-exercise-btn' }
                    ];

                    this.showModal(`Eliminar ejercicio`, body, footer);
                    lucide.createIcons();
                },
                async admin_deleteExercise(group, subGroup, exerciseIndex) {
                    if (!this.isAsesor()) {
                        this.showToast('Acción no permitida.', 'error');
                        return;
                    }

                    const index = parseInt(exerciseIndex, 10);
                    if (Number.isNaN(index)) return;

                    const footerButtons = document.getElementById('custom-modal-footer')?.querySelectorAll('button');
                    footerButtons?.forEach(btn => btn.disabled = true);

                    try {
                        const updatedLibrary = JSON.parse(JSON.stringify(this.data.exerciseLibrary));
                        const exercises = updatedLibrary?.[group]?.[subGroup];
                        if (!exercises || !exercises[index]) {
                            this.showToast('No se encontró el ejercicio seleccionado.', 'error');
                            footerButtons?.forEach(btn => btn.disabled = false);
                            return;
                        }

                        exercises.splice(index, 1);
                        if (exercises.length === 0) {
                            delete updatedLibrary[group][subGroup];
                        }
                        if (Object.keys(updatedLibrary[group] || {}).length === 0) {
                            delete updatedLibrary[group];
                        }

                        const docRef = doc(this.db, 'app_data', 'exercise_library');
                        await setDoc(docRef, updatedLibrary);

                        this.data.exerciseLibrary = updatedLibrary;

                        if (!this.data.exerciseLibrary[this._tempRoutine.activeExerciseGroup]) {
                            this._tempRoutine.activeExerciseGroup = Object.keys(this.data.exerciseLibrary)[0] || '';
                        }

                        this.showToast('Ejercicio eliminado correctamente.', 'success');
                        this.hideModal();
                        this.routine_enterCreator(2);
                    } catch (error) {
                        console.error('Error deleting exercise:', error);
                        this.showToast('No se pudo eliminar el ejercicio.', 'error');
                        footerButtons?.forEach(btn => btn.disabled = false);
                    }
                },
                routine_creator_showGroupImageModal(group) {
                    if (!this.isAsesor()) return;

                    const currentImage = this.data.exerciseGroupImages?.[group] || '';
                    const body = `
                        <div class="space-y-5">
                            <div class="bg-gray-800/70 border border-gray-700 rounded-2xl p-4">
                                <p class="text-sm text-gray-300 leading-relaxed">Selecciona una imagen representativa para el grupo muscular <strong>${group}</strong>. Recomendamos un formato horizontal para lograr una mejor cobertura de la tarjeta.</p>
                                <label for="group-image-file-input" class="mt-4 block cursor-pointer">
                                    <div class="w-full aspect-video rounded-2xl border-2 border-dashed border-gray-600 text-gray-400 flex flex-col items-center justify-center gap-2 hover:border-emerald-400 hover:text-emerald-300 transition">
                                        <i data-lucide="upload-cloud" class="w-10 h-10"></i>
                                        <span class="font-semibold">Seleccionar imagen</span>
                                        <span class="text-xs text-gray-500">Formatos permitidos: JPG, PNG o WEBP</span>
                                    </div>
                                </label>
                                <input type="file" id="group-image-file-input" class="hidden" accept="image/*">
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-gray-300 mb-2">Vista previa</h4>
                                <div id="group-image-preview" class="aspect-video rounded-2xl overflow-hidden bg-gray-900/60 flex items-center justify-center">
                                    ${currentImage ? `<img src="${currentImage}" alt="Imagen actual de ${group}" class="w-full h-full object-cover">` : `<span class="text-xs text-gray-500">Aún no hay imagen asignada para este grupo.</span>`}
                                </div>
                            </div>
                            <div id="group-image-upload-progress" class="hidden">
                                <div class="w-full bg-gray-600 rounded-full h-2">
                                    <div id="group-image-progress-bar" class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="group-image-progress-text" class="text-xs text-gray-400 mt-2 text-center">Subiendo...</p>
                            </div>
                        </div>
                    `;

                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                        { text: 'Guardar Imagen', class: 'bg-emerald-600 text-gray-900 hover:bg-emerald-500', action: 'routine-creator-upload-group-image', 'group-target': group }
                    ];

                    this.showModal(`Imagen para ${group}`, body, footer);
                    lucide.createIcons();

                    const fileInput = document.getElementById('group-image-file-input');
                    const previewContainer = document.getElementById('group-image-preview');

                    if (fileInput) {
                        fileInput.addEventListener('change', () => {
                            if (fileInput.files.length === 0) {
                                previewContainer.innerHTML = currentImage
                                    ? `<img src="${currentImage}" alt="Imagen actual de ${group}" class="w-full h-full object-cover">`
                                    : `<span class="text-xs text-gray-500">Aún no hay imagen asignada para este grupo.</span>`;
                                return;
                            }

                            const file = fileInput.files[0];
                            if (!file.type.startsWith('image/')) {
                                this.showToast('Selecciona un archivo de imagen válido.', 'error');
                                fileInput.value = '';
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = (event) => {
                                previewContainer.innerHTML = `<img src="${event.target.result}" alt="Nueva imagen para ${group}" class="w-full h-full object-cover">`;
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                },
                async routine_creator_uploadGroupImage(group) {
                    if (!this.canEditGlobalMedia()) { this.showToast('Solo el administrador puede actualizar estas imágenes.', 'error'); return; }

                    const fileInput = document.getElementById('group-image-file-input');
                    if (!fileInput || fileInput.files.length === 0) {
                        this.showToast('Selecciona una imagen para este grupo.', 'error');
                        return;
                    }

                    const file = fileInput.files[0];
                    if (!file.type.startsWith('image/')) {
                        this.showToast('El archivo debe ser una imagen.', 'error');
                        return;
                    }

                    const progressContainer = document.getElementById('group-image-upload-progress');
                    const progressBar = document.getElementById('group-image-progress-bar');
                    const progressText = document.getElementById('group-image-progress-text');
                    const modalFooter = document.getElementById('custom-modal-footer');

                    if (progressContainer) progressContainer.classList.remove('hidden');
                    if (modalFooter) {
                        modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = true);
                    }

                    const safeGroupName = group.replace(/\s+/g, '_').toLowerCase();
                    const extension = file.name.split('.').pop();
                    const fileName = `group_covers/${safeGroupName}-${Date.now()}.${extension}`;
                    const storageRef = ref(this.storage, fileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            if (!progressBar || !progressText) return;
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                        },
                        (error) => {
                            console.error('Group image upload failed:', error);
                            this.showToast('Error en la subida. Inténtalo nuevamente.', 'error');
                            if (modalFooter) {
                                modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                            }
                        },
                        async () => {
                            try {
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                if (!this.data.exerciseGroupImages) this.data.exerciseGroupImages = {};
                                this.data.exerciseGroupImages[group] = downloadURL;
                                this.preloadImage(downloadURL, { priority: 'high' });

                                const docRef = doc(this.db, 'app_data', 'exercise_group_images');
                                await setDoc(docRef, { [group]: downloadURL }, { merge: true });

                                this.showToast('Imagen del grupo actualizada.', 'success');
                                this.hideModal();

                                const creatorView = document.getElementById('routine-creator-view');
                                if (creatorView) {
                                    this.routine_enterCreator(2);
                                }
                            } catch (error) {
                                console.error('Error saving group image:', error);
                                this.showToast('No se pudo guardar la imagen.', 'error');
                                if (modalFooter) {
                                    modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                                }
                            }
                        }
                    );
                },
                routine_filterExerciseLibrary(searchTerm) {
                    const term = searchTerm.toLowerCase().trim();
                    const panel = document.getElementById('exercise-list-panel');
                    const nav = document.getElementById('exercise-group-nav');
                    if (!panel || !nav) return;

                    panel.querySelectorAll('.exercise-item').forEach(item => {
                        const name = item.dataset.exerciseName.toLowerCase();
                        item.style.display = name.includes(term) ? 'flex' : 'none';
                    });

                    panel.querySelectorAll('[data-subgroup-content]').forEach(subgroup => {
                        const visibleExercises = subgroup.querySelector('.exercise-item[style*="display: flex"]');
                        subgroup.style.display = visibleExercises ? 'block' : 'none';
                    });

                    panel.querySelectorAll('[data-group-content]').forEach(groupContent => {
                        const visibleSubgroups = groupContent.querySelector('[data-subgroup-content][style*="display: block"]');
                        const correspondingButton = nav.querySelector(`[data-action="routine-creator-switch-group"][data-group-target="${groupContent.dataset.groupContent}"]`);
                        if (correspondingButton) {
                            correspondingButton.classList.toggle('hidden', !visibleSubgroups);
                        }
                    });
                },
                routine_selectExercise(exerciseName) {
                    const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex];
                    if (!currentDay) return;
                    currentDay.exercises.push({ name: exerciseName, sets: 4, reps: '10', weight: '0 kg', rest: '60 s' });
                    this.showToast(`${exerciseName} añadido`, 'success');
                    this.routine_refreshExerciseList();
                },
                routine_editExercise(index) {
                    this.routine_openExerciseEditModal(parseInt(index));
                },
                routine_saveExerciseDetails(index) {
                    this._tempRoutine.modalEditingIndex = parseInt(index);
                    this.routine_saveExerciseFromModal();
                },
                routine_removeExercise(index) {
                    const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex];
                    if (!currentDay) return;
                    currentDay.exercises.splice(index, 1);
                    this._tempRoutine.modalEditingIndex = -1;
                    this.routine_refreshExerciseList();
                },
                routine_refreshExerciseList() {
                    const container = document.getElementById('exercise-list-container');
                    if (!container) return;
                    const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex];
                    if (!currentDay) return;
                    const exercises = currentDay.exercises || [];

                    if (exercises.length === 0) {
                        container.innerHTML = `
                        <div class="flex h-full flex-col items-center justify-center p-6 text-center">
                            <div class="max-w-sm rounded-2xl border-2 border-dashed border-gray-700 bg-gray-800/50 p-8">
                                <i data-lucide="list-plus" class="mx-auto h-16 w-16 text-gray-600"></i>
                                <h3 class="mt-4 text-xl font-bold text-white">Tu día de entrenamiento está vacío</h3>
                                <p class="mt-2 text-gray-400">Añade ejercicios y observa cómo se construye tu línea de tiempo personalizada.</p>
                                <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:justify-center">
                                    <button data-action="routine-creator-add-exercise" class="flex-1 items-center justify-center gap-2 rounded-2xl bg-emerald-500 px-4 py-3 text-sm font-semibold text-gray-900 shadow-lg shadow-emerald-500/20 transition hover:bg-emerald-400 sm:w-auto sm:flex">
                                        <i data-lucide="plus"></i>
                                        <span>Añadir manualmente</span>
                                    </button>
                                    <button data-action="routine-creator-suggest-ai" class="flex-1 items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-purple-500 to-indigo-600 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-purple-500/20 transition hover:opacity-90 sm:w-auto sm:flex">
                                        <i data-lucide="sparkles"></i>
                                        <span>Sugerir con IA</span>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                        this.routine_updateMiniWindow();
                        lucide.createIcons();
                        return;
                    }

                    container.innerHTML = exercises.map((exercise, index) => {
                        if (!exercise) return '';
                        if (!exercise.sets) exercise.sets = 4;
                        if (!exercise.reps) exercise.reps = '10';
                        if (!exercise.rest) exercise.rest = '60 s';
                        if (!exercise.weight) exercise.weight = '0 kg';

                        return `
                        <article class="group relative overflow-hidden rounded-2xl border border-white/10 bg-gray-900/70 p-4 shadow-[0_25px_60px_-35px_rgba(16,185,129,0.65)] section-fade-in" data-exercise-index="${index}">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/70">Bloque ${index + 1}</p>
                                    <h4 class="text-lg font-semibold text-white">${exercise.name}</h4>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button data-action="routine-open-edit-modal" data-exercise-index="${index}" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/30 bg-emerald-500/10 px-3 py-1.5 text-xs font-semibold text-emerald-200 transition hover:border-emerald-300 hover:bg-emerald-400 hover:text-gray-900">
                                        <i data-lucide="pen-line" class="h-4 w-4"></i>
                                        <span>Editar</span>
                                    </button>
                                    <button data-action="routine-creator-remove-exercise" data-exercise-index="${index}" class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-red-500/40 bg-red-500/10 text-red-400 transition hover:bg-red-500 hover:text-gray-900">
                                        <i data-lucide="trash-2"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mt-4 grid grid-cols-2 gap-3 text-sm text-gray-300 sm:grid-cols-4">
                                <div class="flex items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-3 py-3">
                                    <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/10 text-emerald-200">
                                        <i data-lucide="layers" class="h-4 w-4"></i>
                                    </span>
                                    <div>
                                        <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-gray-400">Series</p>
                                        <p class="text-base font-semibold text-white">${exercise.sets}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-3 py-3">
                                    <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-sky-500/10 text-sky-200">
                                        <i data-lucide="repeat" class="h-4 w-4"></i>
                                    </span>
                                    <div>
                                        <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-gray-400">Reps</p>
                                        <p class="text-base font-semibold text-white">${exercise.reps}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-3 py-3">
                                    <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/10 text-amber-200">
                                        <i data-lucide="dumbbell" class="h-4 w-4"></i>
                                    </span>
                                    <div>
                                        <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-gray-400">Peso</p>
                                        <p class="text-base font-semibold text-white">${exercise.weight}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 rounded-2xl border border-white/10 bg-white/5 px-3 py-3">
                                    <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-purple-500/10 text-purple-200">
                                        <i data-lucide="timer" class="h-4 w-4"></i>
                                    </span>
                                    <div>
                                        <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-gray-400">Descanso</p>
                                        <p class="text-base font-semibold text-white">${exercise.rest}</p>
                                    </div>
                                </div>
                            </div>
                        </article>`;
                    }).join('');

                    this.routine_updateMiniWindow();
                    lucide.createIcons();
                },
                routine_updateMiniWindow() {
                    const miniWindow = document.getElementById('exercise-mini-window');
                    if (!miniWindow) return;
                    const strip = miniWindow.querySelector('[data-thumbnail-strip]');
                    const counter = miniWindow.querySelector('[data-mini-count]');
                    const content = miniWindow.querySelector('[data-mini-content]');
                    const toggleLabel = miniWindow.querySelector('[data-mini-toggle-label]');
                    const toggleIcon = miniWindow.querySelector('[data-mini-toggle-icon]');
                    const listContainer = document.getElementById('exercise-list-container');
                    const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex];
                    const exercises = currentDay?.exercises || [];

                    if (!exercises.length) {
                        if (strip) {
                        strip.innerHTML = '<p class="text-[11px] font-medium text-gray-400">Los ejercicios que añadas aparecerán aquí.</p>';
                        }
                        if (counter) counter.textContent = 'Sin ejercicios añadidos';
                        miniWindow.setAttribute('data-collapsed', 'false');
                        if (content) content.classList.remove('hidden');
                        if (toggleLabel) toggleLabel.textContent = 'Plegar';
                        if (toggleIcon) toggleIcon.classList.remove('rotate-180');
                        if (listContainer) listContainer.style.paddingBottom = '';
                        if (this._tempRoutine) this._tempRoutine.miniWindowCollapsed = false;
                        miniWindow.classList.add('hidden');
                        miniWindow.classList.add('pointer-events-none');
                        return;
                    }

                    miniWindow.classList.remove('hidden');
                    miniWindow.classList.remove('pointer-events-none');
                    const isCollapsed = Boolean(this._tempRoutine?.miniWindowCollapsed);

                    if (counter) {
                        const label = `${exercises.length} ejercicio${exercises.length === 1 ? '' : 's'} planificado${exercises.length === 1 ? '' : 's'}`;
                        counter.textContent = label;
                    }

                    miniWindow.setAttribute('data-collapsed', isCollapsed ? 'true' : 'false');
                    if (content) content.classList.toggle('hidden', isCollapsed);
                    if (toggleLabel) toggleLabel.textContent = isCollapsed ? 'Mostrar' : 'Plegar';
                    if (toggleIcon) toggleIcon.classList.toggle('rotate-180', isCollapsed);

                    if (listContainer) {
                        const padding = isCollapsed ? '4.25rem' : '7rem';
                        listContainer.style.paddingBottom = `calc(${padding} + env(safe-area-inset-bottom, 0px))`;
                    }

                    if (strip) {
                        const existingThumbs = new Map(Array.from(strip.querySelectorAll('[data-thumb-key]')).map(node => [node.dataset.thumbKey, node]));
                        const fragment = document.createDocumentFragment();

                        exercises.forEach((exercise, index) => {
                            if (!exercise.weight) exercise.weight = '0 kg';
                            if (!Object.prototype.hasOwnProperty.call(exercise, '__thumbKey')) {
                                Object.defineProperty(exercise, '__thumbKey', {
                                    value: `thumb-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                                    enumerable: false,
                                    writable: true
                                });
                            }

                            const key = exercise.__thumbKey;
                            let card = existingThumbs.get(key);
                            const libraryExercise = this.getExerciseByName(exercise.name) || {};
                            const rawUrl = typeof libraryExercise.mediaUrl === 'string' ? libraryExercise.mediaUrl : '';
                            const hasImage = Boolean(rawUrl);
                            const initials = exercise.name.split(' ').map(word => word[0] || '').join('').slice(0, 2).toUpperCase() || 'FX';

                            if (!card) {
                                card = document.createElement('article');
                                card.className = 'group flex w-20 shrink-0 snap-center flex-col gap-1.5 text-center';
                                card.dataset.thumbKey = key;
                                card.innerHTML = `
                                    <div class="relative h-16 w-20 overflow-hidden rounded-xl border border-white/10 bg-gray-900/80 shadow-lg shadow-emerald-500/10">
                                        <span data-thumb-fallback class="flex h-full w-full items-center justify-center bg-gradient-to-br from-emerald-500/25 via-teal-500/20 to-sky-500/30 text-sm font-semibold text-emerald-100"></span>
                                        <img data-thumb-image alt="" class="hidden h-full w-full object-cover transition duration-300" loading="lazy" decoding="async" width="80" height="64">
                                        <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-gray-950/55 via-gray-950/10 to-transparent opacity-0 transition group-hover:opacity-100"></div>
                                        <button data-thumb-remove data-action="routine-creator-remove-exercise" class="pointer-events-auto absolute left-2 top-2 inline-flex h-6 w-6 items-center justify-center rounded-full border border-white/10 bg-gray-950/70 text-rose-200/90 shadow transition hover:border-rose-300 hover:bg-rose-400 hover:text-gray-900" title="Quitar ejercicio">
                                            <i data-lucide="x" class="h-3.5 w-3.5"></i>
                                        </button>
                                        <button data-thumb-edit data-action="routine-open-edit-modal" class="pointer-events-auto absolute right-2 top-2 inline-flex h-7 w-7 items-center justify-center rounded-full border border-white/10 bg-gray-950/70 text-emerald-200/90 shadow transition hover:border-emerald-300 hover:bg-emerald-400 hover:text-gray-900" title="Editar ejercicio">
                                            <i data-lucide="settings-2" class="h-3.5 w-3.5"></i>
                                        </button>
                                    </div>
                                    <p data-thumb-name class="truncate text-[10px] font-semibold text-gray-100"></p>
                                `;
                            }

                            card.dataset.thumbKey = key;
                            const nameEl = card.querySelector('[data-thumb-name]');
                            if (nameEl) nameEl.textContent = exercise.name;

                            const editBtn = card.querySelector('[data-thumb-edit]');
                            if (editBtn) editBtn.dataset.exerciseIndex = index;

                            const removeBtn = card.querySelector('[data-thumb-remove]');
                            if (removeBtn) removeBtn.dataset.exerciseIndex = index;

                            const imageEl = card.querySelector('[data-thumb-image]');
                            const fallbackEl = card.querySelector('[data-thumb-fallback]');

                            if (imageEl) {
                                if (hasImage) {
                                    if (imageEl.getAttribute('src') !== rawUrl) {
                                        imageEl.setAttribute('src', rawUrl);
                                    }
                                    imageEl.setAttribute('alt', exercise.name);
                                    imageEl.classList.remove('hidden');
                                } else {
                                    imageEl.removeAttribute('src');
                                    imageEl.classList.add('hidden');
                                }
                            }

                            if (fallbackEl) {
                                fallbackEl.textContent = initials;
                                fallbackEl.classList.toggle('hidden', hasImage);
                            }

                            fragment.appendChild(card);
                            existingThumbs.delete(key);
                        });

                        existingThumbs.forEach(node => node.remove());
                        strip.replaceChildren(fragment);
                    }

                    lucide.createIcons();
                },
                routine_toggleMiniWindow() {
                    if (!this._tempRoutine) return;
                    if (typeof this._tempRoutine.miniWindowCollapsed !== 'boolean') {
                        this._tempRoutine.miniWindowCollapsed = false;
                    }
                    this._tempRoutine.miniWindowCollapsed = !this._tempRoutine.miniWindowCollapsed;
                    this.routine_updateMiniWindow();
                },
                routine_openExerciseEditModal(index) {
                    const modal = document.getElementById('exercise-edit-modal');
                    if (!modal) return;
                    const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex];
                    if (!currentDay) return;
                    const exerciseIndex = Number.isNaN(index) ? -1 : parseInt(index);
                    const exercise = currentDay.exercises?.[exerciseIndex];
                    if (!exercise) return;

                    this._tempRoutine.modalEditingIndex = exerciseIndex;
                    const nameEl = document.getElementById('exercise-modal-name');
                    const setsInput = document.getElementById('modal-sets-input');
                    const repsInput = document.getElementById('modal-reps-input');
                    const weightInput = document.getElementById('modal-weight-input');
                    const restInput = document.getElementById('modal-rest-input');

                    if (nameEl) nameEl.textContent = exercise.name;
                    if (setsInput) setsInput.value = exercise.sets || 4;
                    if (repsInput) repsInput.value = exercise.reps || '10';
                    if (weightInput) weightInput.value = exercise.weight || '0 kg';
                    if (restInput) restInput.value = exercise.rest || '60 s';

                    modal.classList.remove('hidden');
                    requestAnimationFrame(() => modal.setAttribute('data-open', 'true'));
                    lucide.createIcons();
                },
                routine_closeExerciseEditModal() {
                    const modal = document.getElementById('exercise-edit-modal');
                    if (!modal) return;
                    modal.removeAttribute('data-open');
                    const sheet = modal.querySelector('.mobile-sheet');
                    const handleClose = () => {
                        modal.classList.add('hidden');
                    };
                    if (sheet) {
                        sheet.addEventListener('transitionend', () => handleClose(), { once: true });
                    } else {
                        handleClose();
                    }
                    this._tempRoutine.modalEditingIndex = -1;
                },
                routine_saveExerciseFromModal() {
                    const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex];
                    if (!currentDay) return;
                    const index = this._tempRoutine.modalEditingIndex;
                    if (index === -1) {
                        this.routine_closeExerciseEditModal();
                        return;
                    }
                    const exercise = currentDay.exercises?.[index];
                    if (!exercise) {
                        this.routine_closeExerciseEditModal();
                        return;
                    }

                    const setsInput = document.getElementById('modal-sets-input');
                    const repsInput = document.getElementById('modal-reps-input');
                    const weightInput = document.getElementById('modal-weight-input');
                    const restInput = document.getElementById('modal-rest-input');

                    const setsValue = parseInt(setsInput?.value, 10);
                    if (!Number.isNaN(setsValue) && setsValue > 0) {
                        exercise.sets = setsValue;
                    }
                    if (repsInput && repsInput.value.trim()) {
                        exercise.reps = repsInput.value.trim();
                    }
                    if (weightInput) {
                        const weightText = weightInput.value.trim();
                        exercise.weight = weightText || '0 kg';
                    }
                    if (restInput) {
                        const restText = restInput.value.trim();
                        exercise.rest = restText || '60 s';
                    }

                    this._tempRoutine.modalEditingIndex = -1;
                    this.routine_refreshExerciseList();
                    this.routine_closeExerciseEditModal();
                    this.showToast('Ejercicio actualizado', 'success');
                },
                routine_openTimelineView() {
                    const overlay = document.getElementById('routine-timeline-overlay');
                    if (!overlay) return;
                    const content = overlay.querySelector('[data-role="timeline-content"]');
                    const confirmation = overlay.querySelector('[data-role="timeline-confirmation"]');
                    if (content) content.classList.remove('hidden');
                    if (confirmation) confirmation.classList.add('hidden');
                    overlay.classList.remove('hidden');
                    requestAnimationFrame(() => overlay.setAttribute('data-open', 'true'));
                    this.routine_renderTimeline();
                    lucide.createIcons();
                },
                routine_closeTimelineView() {
                    const overlay = document.getElementById('routine-timeline-overlay');
                    if (!overlay) return;
                    overlay.removeAttribute('data-open');
                    const sheet = overlay.querySelector('.mobile-sheet');
                    const handleClose = () => {
                        overlay.classList.add('hidden');
                    };
                    if (sheet) {
                        sheet.addEventListener('transitionend', () => handleClose(), { once: true });
                    } else {
                        handleClose();
                    }
                },
                routine_renderTimeline() {
                    const overlay = document.getElementById('routine-timeline-overlay');
                    if (!overlay) return;
                    const list = overlay.querySelector('#routine-timeline-items');
                    if (!list) return;
                    const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex];
                    const exercises = currentDay?.exercises || [];

                    if (!exercises.length) {
                        list.innerHTML = `<li class="rounded-2xl border border-white/10 bg-white/5 p-5 text-center text-sm text-gray-300">Añade ejercicios para visualizar la línea de tiempo.</li>`;
                        return;
                    }

                    list.innerHTML = exercises.map((exercise, index) => {
                        if (!exercise.weight) exercise.weight = '0 kg';
                        return `
                            <li class="timeline-item">
                                <span class="absolute left-0 top-0 inline-flex h-8 w-8 items-center justify-center rounded-full bg-emerald-500 text-sm font-bold text-gray-900 shadow-lg">${index + 1}</span>
                                <div class="rounded-2xl border border-white/10 bg-gray-900/80 p-4 shadow-[0_20px_45px_-30px_rgba(16,185,129,0.6)]">
                                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                        <div>
                                            <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/70">Secuencia ${index + 1}</p>
                                            <h4 class="text-lg font-semibold text-white">${exercise.name}</h4>
                                        </div>
                                        <div class="flex flex-wrap items-center gap-2 text-xs text-gray-300">
                                            <span class="inline-flex items-center gap-1 rounded-full bg-emerald-500/10 px-3 py-1 font-semibold text-emerald-200"><i data-lucide="layers" class="h-3.5 w-3.5"></i>${exercise.sets} series</span>
                                            <span class="inline-flex items-center gap-1 rounded-full bg-sky-500/10 px-3 py-1 font-semibold text-sky-200"><i data-lucide="repeat" class="h-3.5 w-3.5"></i>${exercise.reps} reps</span>
                                            <span class="inline-flex items-center gap-1 rounded-full bg-amber-500/10 px-3 py-1 font-semibold text-amber-200"><i data-lucide="dumbbell" class="h-3.5 w-3.5"></i>${exercise.weight}</span>
                                            <span class="inline-flex items-center gap-1 rounded-full bg-purple-500/10 px-3 py-1 font-semibold text-purple-200"><i data-lucide="timer" class="h-3.5 w-3.5"></i>${exercise.rest}</span>
                                        </div>
                                    </div>
                                </div>
                            </li>`;
                    }).join('');
                },
                async routine_handleTimelineSave() {
                    const overlay = document.getElementById('routine-timeline-overlay');
                    if (!overlay) return;
                    const content = overlay.querySelector('[data-role="timeline-content"]');
                    const confirmation = overlay.querySelector('[data-role="timeline-confirmation"]');
                    const saveButton = overlay.querySelector('[data-action="routine-timeline-save"]');
                    const saveLabel = saveButton?.querySelector('span');
                    const originalLabel = saveLabel?.textContent || 'Guardar rutina';

                    if (saveButton) {
                        saveButton.disabled = true;
                        saveButton.classList.add('opacity-70');
                        saveButton.setAttribute('aria-busy', 'true');
                        if (saveLabel) saveLabel.textContent = 'Guardando...';
                    }

                    const saved = await this.routine_save({ skipClose: true });

                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.classList.remove('opacity-70');
                        saveButton.removeAttribute('aria-busy');
                        if (saveLabel) saveLabel.textContent = originalLabel;
                    }

                    if (!saved) {
                        return;
                    }

                    if (content) content.classList.add('hidden');
                    if (confirmation) confirmation.classList.remove('hidden');
                    lucide.createIcons();
                },
                routine_handleTimelineLink() {
                    this.showToast('Dirígete a tus asesorados para vincular esta rutina.');
                    this.routine_closeTimelineView();
                },
                async routine_handleTimelineStart() {
                    const overlay = document.getElementById('routine-timeline-overlay');
                    const startButton = overlay?.querySelector('[data-action="routine-timeline-confirm-start"]');
                    const startLabel = startButton?.querySelector('span');
                    const originalLabel = startLabel?.textContent || 'Comenzar';

                    if (startButton) {
                        startButton.disabled = true;
                        startButton.classList.add('opacity-70');
                        startButton.setAttribute('aria-busy', 'true');
                        if (startLabel) startLabel.textContent = 'Comenzando...';
                    }

                    const saved = await this.routine_save({ skipClose: true });

                    if (!saved) {
                        if (startButton) {
                            startButton.disabled = false;
                            startButton.classList.remove('opacity-70');
                            startButton.removeAttribute('aria-busy');
                            if (startLabel) startLabel.textContent = originalLabel;
                        }
                        return;
                    }

                    const routineId = this._tempRoutine?.id;
                    const dayIndex = this._tempRoutine?.currentDayIndex || 0;

                    this.routine_closeTimelineView();
                    this.routine_closeFullscreenView();

                    if (routineId) {
                        this.showToast('¡Rutina lista para comenzar!', 'success');
                        this.startWorkout(routineId, dayIndex);
                    } else {
                        this.showToast('No se pudo iniciar la rutina planificada.', 'error');
                    }

                    if (startButton) {
                        startButton.disabled = false;
                        startButton.classList.remove('opacity-70');
                        startButton.removeAttribute('aria-busy');
                        if (startLabel) startLabel.textContent = originalLabel;
                    }
                },

                renderCommunitySection() {
                    const root = document.getElementById('community-root');
                    if (!root) {
                        return;
                    }

                    if (this.state.isCommunityLoading) {
                        root.innerHTML = `
                            <div class="rounded-3xl border border-white/10 bg-gray-900/60 p-6 text-center text-sm text-gray-400">
                                <div class="flex flex-col items-center gap-3">
                                    <span class="flex h-12 w-12 items-center justify-center rounded-full bg-emerald-500/10 text-emerald-300">
                                        <i data-lucide="loader-2" class="h-5 w-5 animate-spin"></i>
                                    </span>
                                    <p>Actualizando estadísticas de la comunidad...</p>
                                </div>
                            </div>
                        `;
                        lucide.createIcons();
                        return;
                    }

                    const community = this.state.community || {};
                    const isEmpty = Boolean(community.isEmpty);
                    const stats = community.stats || { totalAthletes: 0, totalVolume: 0, totalSessions: 0 };
                    const counters = [
                        { label: 'Atletas activos', description: 'Miembros registrados', icon: 'users', value: stats.totalAthletes },
                        { label: 'Kg registrados (30 días)', description: 'Carga acumulada', icon: 'activity', value: stats.totalVolume },
                        { label: 'Entrenos en 30 días', description: 'Sesiones registradas', icon: 'calendar-check', value: stats.totalSessions }
                    ];

                    const countersHtml = counters.map((counter) => {
                        const value = typeof counter.value === 'number' ? counter.value : 0;
                        return `
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                                <div class="flex items-center justify-between gap-3">
                                    <div>
                                        <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">${counter.label}</p>
                                        <p class="mt-2 text-3xl font-bold text-white" data-community-counter data-counter-value="${value}" data-animated="false">0</p>
                                    </div>
                                    <span class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/10 text-emerald-200">
                                        <i data-lucide="${counter.icon}" class="h-5 w-5"></i>
                                    </span>
                                </div>
                                <p class="mt-2 text-xs text-gray-400">${counter.description}</p>
                            </div>
                        `;
                    }).join('');

                    const updatedLabel = community.lastUpdated
                        ? `Actualizado ${this.formatRelativeTime(community.lastUpdated)}`
                        : 'Listo para registrar datos';

                    const podium = Array.isArray(community.podium) ? community.podium : [];
                    const podiumStyles = [
                        'from-amber-500/20 via-amber-500/10 to-transparent border border-amber-400/40 text-amber-100',
                        'from-slate-500/20 via-slate-500/10 to-transparent border border-slate-400/30 text-slate-100',
                        'from-orange-500/20 via-orange-500/10 to-transparent border border-orange-400/30 text-orange-100'
                    ];
                    const podiumEmojis = ['🥇', '🥈', '🥉'];
                    const podiumHtml = podium.length > 0
                        ? podium.map((entry, index) => `
                            <div class="rounded-2xl bg-gradient-to-br ${podiumStyles[index] || 'from-gray-700/20 via-gray-800/20 to-transparent border border-white/10 text-gray-200'} p-4 text-center">
                                <span class="text-2xl">${podiumEmojis[index] || `#${entry.rank}`}</span>
                                <p class="mt-2 text-sm font-semibold text-white">${entry.name}</p>
                                <p class="text-xs text-gray-200">${entry.formattedValue}</p>
                                ${entry.trendLabel ? `<p class="mt-2 text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-200">${entry.trendLabel}</p>` : ''}
                            </div>
                        `).join('')
                        : `<div class="rounded-2xl border border-dashed border-white/10 bg-white/5 p-4 text-sm text-gray-400">Aún no hay atletas con cargas registradas.</div>`;

                    const leaderboardTabs = [
                        { id: 'volume', label: 'Carga total', icon: 'dumbbell' },
                        { id: 'sessions', label: 'Días activos', icon: 'calendar-check' },
                        { id: 'progress', label: 'Progreso', icon: 'trending-up' }
                    ];
                    const activeLeaderboard = community.activeLeaderboard || 'volume';
                    const tabButtons = leaderboardTabs.map(tab => {
                        const isActive = tab.id === activeLeaderboard;
                        return `
                            <button data-action="community-switch-leaderboard" data-leaderboard="${tab.id}" class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.3em] transition ${isActive ? 'bg-emerald-500/20 text-emerald-200 border border-emerald-400/40 shadow-lg shadow-emerald-500/20' : 'bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10'}">
                                <i data-lucide="${tab.icon}" class="h-4 w-4"></i>
                                ${tab.label}
                            </button>
                        `;
                    }).join('');

                    const leaderboardData = community.leaderboards?.[activeLeaderboard] || [];
                    const leaderboardItemsHtml = leaderboardData.length > 0
                        ? `<ul class="space-y-3">
                            ${leaderboardData.map((entry, index) => {
                                const rankBadge = index === 0
                                    ? 'bg-amber-500/20 text-amber-300 border border-amber-400/40'
                                    : index === 1
                                        ? 'bg-slate-500/20 text-slate-200 border border-slate-400/30'
                                        : index === 2
                                            ? 'bg-orange-500/20 text-orange-200 border border-orange-400/30'
                                            : 'bg-gray-800 text-gray-300 border border-gray-700';
                                const detailLine = activeLeaderboard === 'volume'
                                    ? entry.bestLiftLabel
                                    : activeLeaderboard === 'progress'
                                        ? entry.weightLabel
                                        : entry.weightLabel;
                                return `
                                    <li class="rounded-2xl border border-white/10 bg-white/5 p-4 flex items-center justify-between gap-4">
                                        <div class="flex items-center gap-3">
                                            <span class="flex h-10 w-10 items-center justify-center rounded-full ${rankBadge} text-base font-bold">${entry.rank}</span>
                                            <div>
                                                <p class="text-sm font-semibold text-white">${entry.name}</p>
                                                <p class="text-xs text-gray-400">${entry.subLabel}</p>
                                                ${entry.trendLabel ? `<p class="text-xs text-emerald-300">${entry.trendLabel}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-lg font-bold text-white">${entry.formattedValue}</p>
                                            ${detailLine ? `<p class="text-xs text-gray-400">${detailLine}</p>` : ''}
                                        </div>
                                    </li>
                                `;
                            }).join('')}
                        </ul>`
                        : `<div class="rounded-2xl border border-dashed border-white/10 bg-white/5 p-6 text-center text-sm text-gray-400">${isEmpty ? 'Sé la primera persona en aparecer registrando tu próximo entrenamiento.' : 'Registra entrenamientos para activar este ranking.'}</div>`;

                    const spotlight = community.spotlight;
                    const spotlightHtml = spotlight
                        ? `
                            <div class="rounded-3xl border border-amber-400/40 bg-gradient-to-br from-amber-500/15 via-amber-500/5 to-transparent p-5 shadow-lg shadow-amber-500/20">
                                <div class="flex items-start justify-between gap-3">
                                    <div>
                                        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-amber-200">Récord destacado</p>
                                        <h4 class="text-lg font-bold text-white">${spotlight.name}</h4>
                                        <p class="text-sm text-amber-100/80">${spotlight.description}</p>
                                    </div>
                                    <span class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-amber-500/20 text-amber-200 text-lg font-bold">${spotlight.metric}</span>
                                </div>
                                <div class="mt-4 flex flex-wrap items-center gap-2 text-[10px] font-semibold uppercase tracking-[0.35em] text-amber-200/80">
                                    ${spotlight.detail ? `<span class="inline-flex items-center gap-2 rounded-full border border-amber-400/30 bg-amber-500/10 px-3 py-1"><i data-lucide="trending-up" class="h-4 w-4"></i>${spotlight.detail}</span>` : ''}
                                    ${spotlight.streak ? `<span class="inline-flex items-center gap-2 rounded-full border border-amber-400/30 bg-amber-500/10 px-3 py-1"><i data-lucide="flame" class="h-4 w-4"></i>${spotlight.streak} días de racha</span>` : ''}
                                </div>
                            </div>
                        `
                        : `<div class="rounded-3xl border border-white/10 bg-white/5 p-5 text-sm text-gray-400">Registra tus pesos máximos para destacar los nuevos récords de la comunidad.</div>`;

                    const highlights = Array.isArray(community.highlights) ? community.highlights : [];
                    const highlightsHtml = highlights.length > 0
                        ? highlights.map(item => `
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                                <div class="flex items-start justify-between gap-3">
                                    <div>
                                        <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-2.5 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-200">${item.badge}</span>
                                        <p class="mt-2 text-sm font-semibold text-white">${item.title}</p>
                                        <p class="text-xs text-gray-400">${item.detail}</p>
                                    </div>
                                    <p class="text-lg font-bold text-emerald-300">${item.metric}</p>
                                </div>
                            </div>
                        `).join('')
                        : `<div class="rounded-2xl border border-dashed border-white/10 bg-white/5 p-4 text-sm text-gray-400">Cuando la comunidad registre entrenamientos verás aquí a los protagonistas.</div>`;

                    const feed = Array.isArray(community.feed) ? community.feed : [];
                    const feedHtml = feed.length > 0
                        ? feed.map(item => `
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 flex items-center justify-between gap-4">
                                <div class="flex items-center gap-3">
                                    <span class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-200 font-bold">${item.initials}</span>
                                    <div>
                                        <p class="text-sm font-semibold text-white">${item.name}</p>
                                        <p class="text-xs text-gray-400">${item.routineName}</p>
                                    </div>
                                </div>
                                <div class="text-right text-xs text-gray-400">
                                    <p>${this.formatRelativeTime(item.completedAt)}</p>
                                    <p>${this.formatNumberCompact(item.volume || 0)} kg · ${this.formatTime(Math.round(item.duration || 0))}</p>
                                </div>
                            </div>
                        `).join('')
                        : `<div class="rounded-2xl border border-dashed border-white/10 bg-white/5 p-6 text-sm text-gray-400 text-center">Cuando registres entrenamientos aparecerán aquí los últimos movimientos.</div>`;

                    const challenges = Array.isArray(community.challenges) ? community.challenges : [];
                    const challengesHtml = challenges.length > 0
                        ? challenges.map(challenge => {
                            const progress = Math.round(Math.min(100, challenge.progress || 0));
                            return `
                                <div class="rounded-2xl border border-white/10 bg-white/5 p-4 space-y-3">
                                    <div class="flex items-start justify-between gap-3">
                                        <div>
                                            <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200">${challenge.title}</p>
                                            <p class="text-sm text-gray-300">${challenge.description}</p>
                                        </div>
                                        <span class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/10 text-emerald-200">
                                            <i data-lucide="${challenge.icon}" class="h-5 w-5"></i>
                                        </span>
                                    </div>
                                    <div class="h-2.5 w-full rounded-full bg-gray-800">
                                        <div class="h-full rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400" style="width: ${progress}%"></div>
                                    </div>
                                    <div class="flex items-center justify-between text-xs text-gray-400">
                                        <span>${challenge.status}</span>
                                        <span class="font-semibold text-emerald-200">${progress}%</span>
                                    </div>
                                </div>
                            `;
                        }).join('')
                        : `<div class="rounded-2xl border border-dashed border-white/10 bg-white/5 p-6 text-sm text-gray-400 text-center">Activa retos comunitarios compartiendo tus entrenamientos.</div>`;

                    const emptyBannerHtml = isEmpty
                        ? `<div class="rounded-2xl border border-dashed border-emerald-400/40 bg-emerald-500/5 p-4 text-sm text-emerald-100">
                                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-200">
                                            <i data-lucide="sparkles" class="h-5 w-5"></i>
                                        </span>
                                        <div>
                                            <p class="font-semibold text-emerald-100">Activa el ranking registrando tus sesiones</p>
                                            <p class="text-xs text-emerald-100/80">Completa un entrenamiento o carga tus métricas de peso para desbloquear la tabla.</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-200/80">
                                        <i data-lucide="cloud" class="h-4 w-4"></i>
                                        Datos en vivo desde Firebase
                                    </div>
                                </div>
                            </div>`
                        : '';

                    root.innerHTML = `
                        <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-gradient-to-br from-emerald-500/10 via-emerald-500/5 to-gray-900 p-6 sm:p-8 shadow-xl shadow-emerald-500/20">
                            <div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top_right,rgba(6,182,212,0.25),transparent_55%)]"></div>
                            <div class="relative flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
                                <div class="flex-1 space-y-6">
                                    <div class="space-y-3">
                                        <span class="inline-flex w-fit items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200">Ranking en vivo</span>
                                        <h2 class="text-3xl font-bold text-white sm:text-4xl">Comunidad FitTrack</h2>
                                        <p class="max-w-xl text-sm text-emerald-50/80 sm:text-base">Inspírate con los atletas que rompen récords y suma tus datos para aparecer en el top global.</p>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2 text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-100/80">
                                        <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-3 py-1">
                                            <i data-lucide="clock-3" class="h-4 w-4"></i>
                                            ${updatedLabel}
                                        </span>
                                        <button data-action="community-refresh" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/10 px-3 py-1 text-emerald-200 hover:bg-emerald-400/20">
                                            <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                                            Actualizar
                                        </button>
                                    </div>
                                    <div class="grid gap-3 sm:grid-cols-3">
                                        ${countersHtml}
                                    </div>
                                    ${emptyBannerHtml}
                                </div>
                                <div class="flex-1 rounded-3xl border border-white/10 bg-gray-900/60 p-4 shadow-inner shadow-emerald-500/10">
                                    <h3 class="text-sm font-semibold uppercase tracking-[0.35em] text-gray-400">Top cargas (30 días)</h3>
                                    <div class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-3">
                                        ${podiumHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid gap-6 xl:grid-cols-[2fr,1fr]">
                            <div class="rounded-3xl border border-white/10 bg-gray-900/60 p-5 sm:p-6 space-y-4">
                                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                    <div>
                                        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Tabla general</p>
                                        <h3 class="text-xl font-bold text-white">Leaderboard global</h3>
                                    </div>
                                    <div class="flex flex-wrap gap-2">${tabButtons}</div>
                                </div>
                                ${leaderboardItemsHtml}
                            </div>
                            <div class="space-y-4">
                                ${spotlightHtml}
                                <div class="rounded-3xl border border-white/10 bg-gray-900/60 p-5 space-y-3">
                                    <h3 class="text-sm font-semibold uppercase tracking-[0.35em] text-gray-400">Logros destacados</h3>
                                    ${highlightsHtml}
                                </div>
                            </div>
                        </div>
                        <div class="grid gap-6 lg:grid-cols-2">
                            <div class="rounded-3xl border border-white/10 bg-gray-900/60 p-5 space-y-3">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-bold text-white">Actividad en vivo</h3>
                                    <span class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Últimos registros</span>
                                </div>
                                ${feedHtml}
                            </div>
                            <div class="rounded-3xl border border-white/10 bg-gray-900/60 p-5 space-y-3">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-bold text-white">Retos comunitarios</h3>
                                    <span class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Progreso en tiempo real</span>
                                </div>
                                ${challengesHtml}
                            </div>
                        </div>
                    `;

                    lucide.createIcons();
                    if (this.state.currentSection === 'comunidad' && !this.state.isCommunityLoading) {
                        this.animateCommunityCounters();
                    }
                },
                
                routine_addDay() { const dayCount = this._tempRoutine.plan.length + 1; this._tempRoutine.plan.push({ day: `Día ${dayCount}`, exercises: [] }); this._tempRoutine.currentDayIndex = dayCount - 1; this.routine_refreshDayTabs(); this.routine_refreshExerciseList(); },
                routine_switchDay(index) { this._tempRoutine.currentDayIndex = index; this.routine_refreshDayTabs(); this.routine_refreshExerciseList(); },
                routine_refreshDayTabs() { const container = document.getElementById('routine-day-tabs'); if(!container) return; const tabsHtml = this._tempRoutine.plan.map((day, index) => { const isActive = index === this._tempRoutine.currentDayIndex; return `<button data-action="routine-creator-switch-day" data-day-index="${index}" class="relative group flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-lg ${isActive ? 'bg-emerald-500 text-gray-900' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'} transition-colors"><span ondblclick="app.routine_showRenameDayModal(${index})">${day.day}</span><button data-action="routine-creator-confirm-delete-day" data-day-index="${index}" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button></button>`; }).join(''); const addButton = `<button data-action="routine-creator-add-day" class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-gray-800 text-gray-400 rounded-lg hover:bg-gray-700 hover:text-white transition-colors"><i data-lucide="plus"></i></button>`; container.innerHTML = tabsHtml + addButton; lucide.createIcons(); container.scrollLeft = container.scrollWidth; },
                routine_showRenameDayModal(index) { const currentName = this._tempRoutine.plan[index].day; const body = `<input type="text" id="rename-day-input" value="${currentName}" class="w-full bg-gray-700 rounded-lg p-3">`; const footer = [{ text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' }, { text: 'Guardar', class: 'bg-emerald-600 text-gray-900', action: 'none' }]; this.showModal(`Renombrar ${currentName}`, body, footer); document.querySelector('#custom-modal-footer button[data-action="none"]').onclick = () => { const newName = document.getElementById('rename-day-input').value.trim(); if (newName) { this._tempRoutine.plan[index].day = newName; this.routine_refreshDayTabs(); this.hideModal(); } else { this.showToast('El nombre no puede estar vacío', 'error'); } }; },
                routine_confirmDeleteDay(dayIndex) { if (this._tempRoutine.plan.length <= 1) { this.showToast('No puedes eliminar el único día de la rutina.', 'error'); return; } const dayName = this._tempRoutine.plan[dayIndex].day; this.showModal('Eliminar Día', `¿Seguro que quieres eliminar "${dayName}"?`, [ {text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal'}, {text: 'Eliminar', class: 'bg-red-600', action: 'routine-creator-delete-day', 'day-index': dayIndex} ]); },
                routine_deleteDay(dayIndex) { this._tempRoutine.plan.splice(dayIndex, 1); this._tempRoutine.currentDayIndex = Math.max(0, dayIndex - 1); this.routine_refreshDayTabs(); this.routine_refreshExerciseList(); this.hideModal(); },
                
                async routine_save(options = {}) {
                    const { skipClose = false } = options || {};
                    if (this._tempRoutine.plan.some(d => d.exercises.length === 0)) {
                        this.showToast('Asegúrate de que cada día tenga al menos un ejercicio.', 'error');
                        return false;
                    }
                    this._tempRoutine.editingIndex = -1;
                    this._tempRoutine.modalEditingIndex = -1;

                    const editingClientId = this._tempRoutine.editingClientId;
                    const assignedClientId = this._tempRoutine.assignedClientId || '';
                    const routinePayload = JSON.parse(JSON.stringify(this._tempRoutine));
                    delete routinePayload.editingClientId;
                    delete routinePayload.activeExerciseGroup;
                    if (!assignedClientId) delete routinePayload.assignedClientId;

                    try {
                        if (editingClientId) {
                            const clientRef = doc(this.db, "users", editingClientId);
                            const clientData = (this.state.asesorados || []).find(c => c.id === editingClientId);
                            const existingRoutines = Array.isArray(clientData?.userRoutines) ? [...clientData.userRoutines] : [];
                            const routineIndex = existingRoutines.findIndex(r => r.id === routinePayload.id);
                            if (routineIndex >= 0) {
                                existingRoutines[routineIndex] = routinePayload;
                            } else {
                                existingRoutines.push(routinePayload);
                            }
                            await updateDoc(clientRef, { userRoutines: existingRoutines });
                            this.showToast('Rutina del cliente guardada con éxito');
                            await this.fetchAsesorados();
                            if (!Array.isArray(this.state.userRoutines)) {
                                this.state.userRoutines = [];
                            }
                            const localIndex = this.state.userRoutines.findIndex(r => r.id === routinePayload.id);
                            if (localIndex >= 0) {
                                this.state.userRoutines[localIndex] = routinePayload;
                            } else {
                                this.state.userRoutines.unshift(routinePayload);
                            }
                            await this.saveDataToFirestore();
                            this.renderRoutinesSection();
                        } else if (assignedClientId) {
                            const clientRef = doc(this.db, "users", assignedClientId);
                            const clientData = (this.state.asesorados || []).find(c => c.id === assignedClientId);
                            const existingRoutines = Array.isArray(clientData?.userRoutines) ? [...clientData.userRoutines] : [];
                            existingRoutines.push(routinePayload);
                            await updateDoc(clientRef, { userRoutines: existingRoutines });
                            this.showToast('Rutina asignada al asesorado con éxito');
                            await this.fetchAsesorados();

                            if (!this.state.userRoutines) this.state.userRoutines = [];
                            this.state.userRoutines.unshift(routinePayload);
                            await this.saveDataToFirestore();
                            this.renderRoutinesSection();
                        } else {
                            if (!this.state.userRoutines) this.state.userRoutines = [];
                            this.state.userRoutines.unshift(routinePayload);
                            await this.saveDataToFirestore();
                            this.showToast('Rutina guardada con éxito');
                            this.renderRoutinesSection();
                        }

                        if (!skipClose) {
                            this.routine_closeFullscreenView();
                        }
                        return true;
                    } catch (error) {
                        console.error('Error saving routine:', error);
                        const isClientAction = Boolean(editingClientId || assignedClientId);
                        this.showToast(isClientAction ? 'Error al guardar la rutina del cliente.' : 'Error al guardar la rutina.', 'error');
                        return false;
                    }
                },

                routine_confirmDelete(routineId) { this.showModal('Eliminar Rutina', '¿Estás seguro? Esta acción no se puede deshacer.', [ {text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal'}, {text: 'Eliminar', class: 'bg-red-600 hover:bg-red-500', action: 'routine-delete', 'routine-id': routineId} ]); },
                async routine_delete(routineId) { this.state.userRoutines = this.state.userRoutines.filter(r => r.id !== routineId); await this.saveDataToFirestore(); this.hideModal(); this.routine_closeFullscreenView(); this.renderRoutinesSection(); this.showToast('Rutina eliminada', 'error'); },
                routine_openFullscreenView(html) {
                    const container = document.getElementById('fullscreen-view-container');
                    if (typeof this._bodyOverflowBackup === 'undefined') {
                        this._bodyOverflowBackup = document.body.style.overflow;
                    }
                    document.body.style.overflow = 'hidden';
                    container.innerHTML = html;
                    container.classList.remove('pointer-events-none');
                    container.classList.remove('opacity-0');
                    container.style.opacity = '1';
                    setTimeout(() => {
                        const view = container.querySelector('.fullscreen-view');
                        if (view) view.classList.add('is-active');
                        lucide.createIcons();
                        if (typeof this.initializeGroupCardImageLoading === 'function') {
                            this.initializeGroupCardImageLoading(container);
                        }
                    }, 10);
                },
                routine_closeFullscreenView() {
                    if (this._boundHandleDrawerResize) {
                        window.removeEventListener('resize', this._boundHandleDrawerResize);
                        this._boundHandleDrawerResize = null;
                    }

                    const container = document.getElementById('fullscreen-view-container');
                    const view = container.querySelector('.fullscreen-view');
                    if (view) {
                        view.classList.remove('is-active');
                        container.style.opacity = '0';
                        container.classList.add('opacity-0');
                        view.addEventListener('transitionend', () => {
                            container.innerHTML = '';
                            container.classList.add('pointer-events-none');
                            if (typeof this._bodyOverflowBackup !== 'undefined') {
                                document.body.style.overflow = this._bodyOverflowBackup;
                                delete this._bodyOverflowBackup;
                            }
                            this.renderAsesoradosSection();
                        }, { once: true });
                    } else if (typeof this._bodyOverflowBackup !== 'undefined') {
                        document.body.style.overflow = this._bodyOverflowBackup;
                        delete this._bodyOverflowBackup;
                    }
                },
                
                showMediaViewer(url) {
                    if (!url) {
                        this.showToast('No hay multimedia para este ejercicio.', 'error');
                        return;
                    }
                    const modal = document.getElementById('image-viewer-modal');
                    const contentContainer = document.getElementById('image-viewer-content');
                    contentContainer.innerHTML = '';

                    const isVideo = url.includes('.mp4') || url.includes('.webm');
                    let mediaElement;
                    if (isVideo) {
                        mediaElement = document.createElement('video');
                        mediaElement.autoplay = true;
                        mediaElement.loop = true;
                        mediaElement.muted = true;
                        mediaElement.playsInline = true;
                    } else {
                        mediaElement = document.createElement('img');
                    }
                    mediaElement.src = url;
                    mediaElement.className = 'rounded-lg max-h-[90vh]';

                    contentContainer.appendChild(mediaElement);
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                },

                admin_showEditMediaModal(group, subGroup, exerciseIndex) {
                    if (!this.isAsesor()) return;
                    const exercise = this.data.exerciseLibrary[group][subGroup][exerciseIndex];
                    const body = `
                        <p class="text-sm text-gray-400 mb-4">Sube un nuevo GIF, imagen o video para este ejercicio. El archivo anterior será reemplazado.</p>
                        <div>
                            <label for="media-file-input" class="w-full cursor-pointer bg-gray-700 hover:bg-gray-600 border-2 border-dashed border-gray-500 rounded-lg p-6 text-center transition">
                                <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-gray-400"></i>
                                <span id="file-name-display" class="mt-2 block text-sm font-semibold text-gray-300">Seleccionar archivo</span>
                            </label>
                            <input type="file" id="media-file-input" class="hidden" accept="image/*,video/*">
                        </div>
                        <div id="media-preview-container" class="mt-4 hidden max-h-48 overflow-hidden rounded-lg bg-gray-900 flex justify-center items-center"></div>
                        <div id="upload-progress-container" class="mt-4 hidden">
                            <div class="w-full bg-gray-600 rounded-full h-2.5">
                                <div id="upload-progress-bar" class="bg-emerald-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="upload-progress-text" class="text-center text-xs text-gray-400 mt-1">Subiendo...</p>
                        </div>
                    `;
                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                        { text: 'Subir y Guardar', class: 'bg-emerald-600 text-gray-900 hover:bg-emerald-500', action: 'admin-upload-media', group: group, subgroup: subGroup, 'exercise-index': exerciseIndex, id: 'admin-upload-btn' }
                    ];
                    this.showModal(`Editar Media: ${exercise.name}`, body, footer);
                    lucide.createIcons();

                    const fileInput = document.getElementById('media-file-input');
                    const fileNameDisplay = document.getElementById('file-name-display');
                    const previewContainer = document.getElementById('media-preview-container');

                    fileInput.addEventListener('change', () => {
                        if (fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            fileNameDisplay.textContent = file.name;
                            previewContainer.innerHTML = '';
                            previewContainer.classList.remove('hidden');

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                let previewElement;
                                if (file.type.startsWith('image/')) {
                                    previewElement = document.createElement('img');
                                } else if (file.type.startsWith('video/')) {
                                    previewElement = document.createElement('video');
                                    previewElement.muted = true;
                                    previewElement.autoplay = true;
                                    previewElement.loop = true;
                                    previewElement.playsInline = true;
                                }
                                if (previewElement) {
                                    previewElement.src = e.target.result;
                                    previewElement.className = 'w-full h-auto object-contain max-h-48';
                                    previewContainer.appendChild(previewElement);
                                }
                            };
                            reader.readAsDataURL(file);
                        } else {
                            fileNameDisplay.textContent = 'Seleccionar archivo';
                            previewContainer.classList.add('hidden');
                            previewContainer.innerHTML = '';
                        }
                    });
                },

                async admin_uploadAndSaveMedia(group, subGroup, exerciseIndex) {
                    if (!this.isAsesor()) { this.showToast('Acción no permitida.', 'error'); return; }
                    
                    const fileInput = document.getElementById('media-file-input');
                    if (fileInput.files.length === 0) {
                        this.showToast('Por favor, selecciona un archivo para subir.', 'error');
                        return;
                    }
                    const file = fileInput.files[0];

                    const progressContainer = document.getElementById('upload-progress-container');
                    const progressBar = document.getElementById('upload-progress-bar');
                    const progressText = document.getElementById('upload-progress-text');
                    const modalFooter = document.getElementById('custom-modal-footer');

                    modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = true);
                    progressContainer.classList.remove('hidden');
                    
                    const exerciseName = this.data.exerciseLibrary[group][subGroup][exerciseIndex].name.replace(/\s+/g, '_');
                    const fileName = `exercise_media/${exerciseName}-${Date.now()}.${file.name.split('.').pop()}`;
                    const storageRef = ref(this.storage, fileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                        },
                        (error) => {
                            console.error("Upload failed:", error);
                            this.showToast('Error en la subida. Revisa las reglas de Storage.', 'error');
                            modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                        },
                        async () => {
                            try {
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                this.data.exerciseLibrary[group][subGroup][exerciseIndex].mediaUrl = downloadURL;
                                
                                const docRef = doc(this.db, "app_data", "exercise_library");
                                await setDoc(docRef, this.data.exerciseLibrary);
                                
                                this.showToast('¡Recurso subido y guardado!', 'success');
                                this.hideModal();
                                
                                const creatorView = document.getElementById('routine-creator-view');
                                if (creatorView) {
                                   this.routine_enterCreator(2);
                                }

                            } catch(error) {
                                console.error("Error saving data after upload: ", error);
                                this.showToast('Error al guardar la nueva URL.', 'error');
                                modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                            }
                        }
                    );
                },

                startWorkout(routineId, dayIndex) { let routine = [...(this.state.userRoutines || []), ...Object.values(this.data.predefinedRoutines).flat()].find(r => r.id === routineId); if (!routine || !routine.plan || !routine.plan[dayIndex]) { this.showToast("No se pudo iniciar la rutina.", "error"); return; } const workoutDay = routine.plan[dayIndex]; this.state.activeWorkout = { routineId, dayIndex, routineName: routine.name, dayName: workoutDay.day, exercises: JSON.parse(JSON.stringify(workoutDay.exercises.map(ex => ({...ex, log: []})))), currentExerciseIndex: 0, currentSet: 1, workoutStartTime: Date.now(), totalRestTime: 0, workoutTimerIntervalId: null, }; this.state.timer = { status: 'idle', timeLeft: 0, intervalId: null }; this.state.activeWorkout.workoutTimerIntervalId = setInterval(() => this.updateWorkoutTimerDisplay(), 1000); this.renderLiveWorkoutView(); },
                updateWeightInput(amount) { const input = document.getElementById('weight-input'); if (input) { let currentValue = parseFloat(input.value) || 0; input.value = Math.max(0, currentValue + amount); } },
                
                renderLiveWorkoutView() {
                    const overlay = document.getElementById('live-workout-overlay');
                    if (!this.state.activeWorkout) {
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                        return;
                    }

                    const { exercises, currentExerciseIndex, currentSet, routineName, dayName } = this.state.activeWorkout;
                    const exercise = exercises[currentExerciseIndex];
                    if (!exercise) {
                        this.finishWorkout(false);
                        return;
                    }

                    const totalExercises = Math.max(1, exercises.length);
                    const timerStatus = this.state.timer.status;
                    const workoutProgress = ((currentExerciseIndex + 1) / totalExercises) * 100;
                    const progressRounded = Math.min(100, Math.max(0, workoutProgress));
                    const totalSets = Math.max(1, Number(exercise.sets) || 1);
                    const normalizedSet = Math.min(currentSet, totalSets);
                    const restTarget = exercise.rest || '60s';
                    const nextExercise = exercises[currentExerciseIndex + 1] || null;

                    const libraryExercise = this.getExerciseByName(exercise.name) || {};
                    const mediaUrl = exercise.mediaUrl || libraryExercise.mediaUrl || '';
                    const isVideoMedia = mediaUrl ? (/\.(mp4|webm|mov|m4v)(\?.*)?$/i.test(mediaUrl) || mediaUrl.includes('video')) : false;

                    const mediaContent = mediaUrl
                        ? `
                            <div class="relative aspect-video w-full overflow-hidden rounded-3xl border border-white/10 bg-black/40 shadow-[0_25px_70px_-45px_rgba(56,189,248,0.65)]">
                                ${isVideoMedia
                                    ? `<video src="${mediaUrl}" autoplay loop muted playsinline class="h-full w-full object-cover"></video>`
                                    : `<img src="${mediaUrl}" alt="Demostración de ${exercise.name}" class="h-full w-full object-cover" loading="lazy">`
                                }
                                <div class="absolute inset-x-3 bottom-3 flex items-center justify-between rounded-full bg-black/55 px-3 py-2 text-[10px] font-semibold uppercase tracking-[0.35em] text-white/80">
                                    <span class="inline-flex items-center gap-2 text-white">
                                        <i data-lucide="${isVideoMedia ? 'play-circle' : 'image'}" class="h-4 w-4"></i>
                                        ${isVideoMedia ? 'Video' : 'Imagen'} de referencia
                                    </span>
                                    <button data-action="show-media-viewer" data-media-url="${mediaUrl}" class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1 text-[10px] font-bold tracking-[0.4em] text-white transition hover:bg-white/30">
                                        Ver grande
                                        <i data-lucide="expand" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </div>
                        `
                        : `
                            <div class="relative overflow-hidden rounded-3xl border border-dashed border-white/15 bg-white/5 px-4 py-12 text-center sm:px-6">
                                <i data-lucide="image-off" class="mx-auto mb-4 h-10 w-10 text-gray-500"></i>
                                <p class="text-sm font-semibold text-gray-300">Aún no hay media asociada a este ejercicio.</p>
                                <p class="mt-2 text-xs text-gray-500">Sube una imagen o video desde el creador de rutinas para enriquecer esta vista.</p>
                            </div>
                        `;

                    let setIndicators = '';
                    for (let i = 1; i <= totalSets; i++) {
                        const isCompleted = exercise.log?.[i - 1] !== undefined;
                        const isActive = i === normalizedSet && !['resting', 'exercise_complete', 'workout_complete'].includes(timerStatus);
                        let barClass = 'bg-white/10';
                        if (isCompleted) {
                            barClass = 'bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 shadow-[0_0_25px_-12px_rgba(45,212,191,0.7)]';
                        } else if (isActive) {
                            barClass = 'bg-amber-400/80 animate-pulse shadow-[0_0_35px_-18px_rgba(251,191,36,0.85)]';
                        }
                        setIndicators += `<span class="h-2 flex-1 rounded-full transition-all duration-500 ${barClass}"></span>`;
                    }

                    const statusPresets = {
                        idle: { label: 'Listo para iniciar', badgeClass: 'bg-emerald-400/10 border border-emerald-300/40 text-emerald-200' },
                        active: { label: 'En progreso', badgeClass: 'bg-amber-400/10 border border-amber-300/40 text-amber-200' },
                        logging_weight: { label: 'Registra el peso', badgeClass: 'bg-sky-400/10 border border-sky-300/40 text-sky-200' },
                        resting: { label: 'Descansando', badgeClass: 'bg-purple-400/10 border border-purple-300/40 text-purple-200' },
                        exercise_complete: { label: 'Ejercicio completado', badgeClass: 'bg-indigo-400/10 border border-indigo-300/40 text-indigo-200' },
                        workout_complete: { label: 'Rutina completada', badgeClass: 'bg-emerald-400/20 border border-emerald-300/40 text-emerald-100' }
                    };
                    const statusInfo = statusPresets[timerStatus] || statusPresets.idle;

                    let mainDisplayHtml = '';
                    switch (timerStatus) {
                        case 'resting': {
                            const radius = 88;
                            const circumference = 2 * Math.PI * radius;
                            const progressFraction = this.state.timer.initialRestTime > 0
                                ? Math.max(0, this.state.timer.timeLeft) / this.state.timer.initialRestTime
                                : 0;
                            const offset = circumference - progressFraction * circumference;
                            const upcomingName = (currentSet > totalSets && nextExercise)
                                ? nextExercise.name
                                : exercise.name;
                            mainDisplayHtml = `
                                <div class="flex flex-col items-center gap-6 text-center">
                                    <div class="relative mx-auto h-48 w-48">
                                        <svg class="h-full w-full -rotate-90" viewBox="0 0 ${radius * 2 + 40} ${radius * 2 + 40}">
                                            <circle class="text-white/10" stroke-width="12" stroke="currentColor" fill="transparent" r="${radius}" cx="${radius + 20}" cy="${radius + 20}"></circle>
                                            <circle id="rest-progress-circle" data-circumference="${circumference}" class="text-emerald-400 drop-shadow-[0_0_20px_rgba(45,212,191,0.45)]" stroke-width="12" stroke-dasharray="${circumference}"
                                                stroke-dashoffset="${offset}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="${radius + 20}" cy="${radius + 20}"></circle>
                                        </svg>
                                        <div class="absolute inset-0 grid place-items-center">
                                            <div class="text-center">
                                                <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-emerald-200/80">Tiempo de descanso</p>
                                                <p id="rest-timer-display" class="mt-1 text-5xl font-black font-mono tracking-tight text-white">${this.formatTime(this.state.timer.timeLeft)}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-200">
                                            <i data-lucide="clock" class="h-4 w-4"></i>
                                            Recupera energías
                                        </span>
                                        <p class="text-sm font-semibold text-white">${nextExercise ? 'Próximo: ' + upcomingName : 'Último bloque completado'}</p>
                                        <p class="text-xs text-gray-400">Respira profundo y prepara la técnica.</p>
                                    </div>
                                </div>
                            `;
                            break;
                        }
                        case 'logging_weight': {
                            const lastWeight = exercise.log?.[currentSet - 2] ?? '';
                            mainDisplayHtml = `
                                <div class="mx-auto w-full max-w-md space-y-6 text-center">
                                    <div>
                                        <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-sky-200/80">Registra el peso</p>
                                        <p class="mt-2 text-sm text-gray-300">Serie ${Math.max(currentSet - 1, 1)} completada</p>
                                    </div>
                                    <div class="flex items-center justify-center gap-4">
                                        <button type="button" onclick="app.updateWeightInput(-2.5)" class="h-14 w-14 rounded-full border border-white/15 bg-white/10 text-3xl font-bold text-white transition hover:border-emerald-300/60 hover:bg-emerald-300/10">-</button>
                                        <div class="relative w-44">
                                            <input type="number" id="weight-input" inputmode="decimal"
                                                class="w-full rounded-2xl border border-white/10 bg-black/60 py-3 text-center text-5xl font-black text-white focus:border-emerald-400 focus:outline-none"
                                                placeholder="0" value="${lastWeight}">
                                            <span class="pointer-events-none absolute inset-x-0 -bottom-6 text-xs uppercase tracking-[0.4em] text-gray-400">kg</span>
                                        </div>
                                        <button type="button" onclick="app.updateWeightInput(2.5)" class="h-14 w-14 rounded-full border border-white/15 bg-white/10 text-3xl font-bold text-white transition hover:border-emerald-300/60 hover:bg-emerald-300/10">+</button>
                                    </div>
                                    <p class="text-xs text-gray-400">Guarda el peso utilizado para mantener tu progreso controlado.</p>
                                </div>
                            `;
                            break;
                        }
                        case 'exercise_complete':
                            mainDisplayHtml = `
                                <div class="flex flex-col items-center gap-4 text-center">
                                    <span class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-emerald-400/10 text-emerald-300">
                                        <i data-lucide="check" class="h-10 w-10"></i>
                                    </span>
                                    <p class="text-2xl font-semibold text-white">¡Ejercicio completado!</p>
                                    <p class="text-sm text-gray-400">Respira profundo y prepárate para el siguiente desafío.</p>
                                </div>
                            `;
                            break;
                        case 'workout_complete':
                            mainDisplayHtml = `
                                <div class="flex flex-col items-center gap-4 text-center">
                                    <span class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-emerald-400/15 text-emerald-200">
                                        <i data-lucide="sparkles" class="h-10 w-10"></i>
                                    </span>
                                    <p class="text-3xl font-semibold text-white">¡Entrenamiento finalizado!</p>
                                    <p class="text-sm text-gray-400">Excelente trabajo. Registra sensaciones y estira para cerrar con broche de oro.</p>
                                </div>
                            `;
                            break;
                        default:
                            mainDisplayHtml = `
                                <div class="flex flex-col items-center gap-5 text-center">
                                    <div class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-300">
                                        Serie ${normalizedSet} / ${totalSets}
                                    </div>
                                    <p class="text-7xl font-black tracking-tight text-white">${exercise.reps}</p>
                                    <p class="text-sm text-gray-400">Repeticiones objetivo · Mantén la técnica bajo control.</p>
                                </div>
                            `;
                            break;
                    }

                    const buttonMap = {
                        idle: { text: `Comenzar serie ${normalizedSet}`, gradient: 'from-emerald-400 via-teal-400 to-cyan-400', textClass: 'text-gray-900', icon: 'play', hoverShadow: 'hover:shadow-[0_35px_70px_-40px_rgba(45,212,191,0.75)]' },
                        active: { text: 'Finalizar serie', gradient: 'from-amber-400 via-orange-400 to-pink-500', textClass: 'text-gray-900', icon: 'flag-checkered', hoverShadow: 'hover:shadow-[0_35px_70px_-40px_rgba(251,191,36,0.75)]' },
                        logging_weight: { text: 'Guardar y descansar', gradient: 'from-sky-400 via-blue-500 to-indigo-500', textClass: 'text-white', icon: 'save', hoverShadow: 'hover:shadow-[0_35px_70px_-40px_rgba(59,130,246,0.75)]' },
                        resting: { text: 'Descansando...', gradient: 'from-slate-600 via-slate-700 to-slate-800', textClass: 'text-gray-200', icon: 'timer', hoverShadow: '', disabled: true },
                        exercise_complete: { text: 'Siguiente ejercicio', gradient: 'from-purple-500 via-indigo-500 to-blue-500', textClass: 'text-white', icon: 'arrow-right', hoverShadow: 'hover:shadow-[0_35px_70px_-40px_rgba(129,140,248,0.75)]' },
                        workout_complete: { text: '¡Rutina completada!', gradient: 'from-emerald-400 via-green-500 to-teal-500', textClass: 'text-gray-900', icon: 'sparkles', hoverShadow: 'hover:shadow-[0_45px_90px_-50px_rgba(16,185,129,0.85)]' }
                    };
                    const buttonState = buttonMap[timerStatus] || buttonMap.idle;
                    const mainButtonHtml = `
                        <button data-action="handle-workout-action" class="group relative w-full overflow-hidden rounded-full bg-gradient-to-r ${buttonState.gradient} px-5 py-3 text-base font-semibold sm:flex-1 sm:px-7 sm:py-3.5 sm:text-lg ${buttonState.textClass} transition duration-200 ${buttonState.disabled ? 'cursor-not-allowed opacity-70' : 'hover:scale-[1.01]'} ${buttonState.hoverShadow}" ${buttonState.disabled ? 'disabled' : ''}>
                            <span class="flex items-center justify-center gap-3">
                                ${buttonState.text}
                                <i data-lucide="${buttonState.icon}" class="h-5 w-5"></i>
                            </span>
                        </button>
                    `;

                    const exitRoutineButtonHtml = `
                        <button data-action="confirm-cancel-workout" class="inline-flex w-full items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-5 py-3 text-sm font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-rose-400/60 hover:bg-rose-500/10 hover:text-white sm:w-auto sm:px-6">
                            <i data-lucide="log-out" class="h-4 w-4"></i>
                            <span>Finalizar rutina</span>
                        </button>
                    `;

                    const restControlsSection = timerStatus === 'resting'
                        ? `
                            <div class="flex flex-wrap items-center justify-center gap-2 sm:gap-3">
                                <button data-action="add-rest-time" class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1.5 text-[11px] font-semibold uppercase tracking-[0.35em] text-white transition hover:border-emerald-300/60 hover:bg-emerald-300/10 sm:px-4 sm:py-2">
                                    <i data-lucide="plus" class="h-4 w-4"></i>
                                    +15s
                                </button>
                                <button data-action="skip-rest" class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1.5 text-[11px] font-semibold uppercase tracking-[0.35em] text-white transition hover:border-rose-300/60 hover:bg-rose-300/10 sm:px-4 sm:py-2">
                                    <i data-lucide="skip-forward" class="h-4 w-4"></i>
                                    Saltar descanso
                                </button>
                            </div>
                        `
                        : '';

                    const upcomingHtml = `
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-xl shadow-[0_25px_70px_-55px_rgba(59,130,246,0.45)] sm:p-6">
                            <div class="flex items-center justify-between text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-300">
                                <span>${nextExercise ? 'Siguiente ejercicio' : 'Último esfuerzo'}</span>
                                <span class="inline-flex items-center gap-2 text-emerald-200"><i data-lucide="activity" class="h-4 w-4"></i>${Math.round(progressRounded)}%</span>
                            </div>
                            <p class="mt-3 text-lg font-semibold text-white sm:text-xl">${nextExercise ? nextExercise.name : 'Cool down & estiramientos'}</p>
                            <p class="mt-2 text-sm text-gray-400">${nextExercise ? `${nextExercise.sets || '—'} series · ${nextExercise.reps || '—'} reps` : 'Aprovecha para bajar pulsaciones y evaluar sensaciones.'}</p>
                        </div>
                    `;

                    const statsHtml = `
                        <div class="grid grid-cols-3 gap-3">
                            <div class="rounded-2xl border border-white/10 bg-white/5 py-3 text-center">
                                <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-gray-400">Serie</p>
                                <p class="mt-1 text-lg font-semibold text-white">${normalizedSet}/${totalSets}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 py-3 text-center">
                                <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-gray-400">Reps</p>
                                <p class="mt-1 text-lg font-semibold text-white">${exercise.reps || '—'}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 py-3 text-center">
                                <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-gray-400">Descanso</p>
                                <p class="mt-1 text-lg font-semibold text-white">${restTarget}</p>
                            </div>
                        </div>
                    `;

                    overlay.innerHTML = `
                        <div class="flex min-h-full flex-col bg-gradient-to-b from-gray-950 via-gray-950 to-gray-900 text-white">
                            <header class="sticky top-0 z-10 border-b border-white/5 bg-gray-950/95 px-4 py-4 backdrop-blur-sm sm:px-6">
                                <div class="mx-auto flex w-full max-w-5xl flex-col gap-4">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="space-y-1">
                                            <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-400">${routineName || 'Rutina personalizada'}</p>
                                            <div class="flex flex-wrap items-center gap-2">
                                                <h1 class="text-xl font-semibold text-white">${dayName || 'Sesión en curso'}</h1>
                                                <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] ${statusInfo.badgeClass}">
                                                    <span class="h-2 w-2 rounded-full bg-current"></span>
                                                    ${statusInfo.label}
                                                </span>
                                            </div>
                                        </div>
                                        <button data-action="confirm-cancel-workout" title="Salir de la rutina" aria-label="Salir de la rutina" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-300 transition hover:border-rose-400/60 hover:bg-rose-500/10 hover:text-white">
                                            <span class="sr-only">Salir de la rutina</span>
                                            <i data-lucide="x" class="h-5 w-5"></i>
                                        </button>
                                    </div>
                                    <div class="grid gap-3 sm:grid-cols-[auto,1fr] sm:items-center">
                                        <div class="flex items-center gap-3">
                                            <div id="main-workout-timer" class="rounded-full bg-black/40 px-4 py-2 text-2xl font-mono font-semibold tracking-widest text-white shadow-inner">00:00</div>
                                            <span class="text-xs text-gray-400">Duración de la sesión</span>
                                        </div>
                                        <div class="w-full">
                                            <div class="overflow-hidden rounded-full border border-white/10 bg-white/5">
                                                <div class="h-2 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 transition-[width] duration-500" style="width: ${progressRounded}%"></div>
                                            </div>
                                            <p class="mt-1 text-xs text-gray-400">Ejercicio ${currentExerciseIndex + 1} de ${totalExercises}</p>
                                        </div>
                                    </div>
                                </div>
                            </header>

                            <main class="flex-1 overflow-y-auto px-4 pb-28 pt-6 sm:px-6">
                                <div class="mx-auto flex w-full max-w-5xl flex-col gap-6 lg:flex-row">
                                    <section class="flex w-full flex-col gap-4 lg:w-5/12">
                                        ${mediaContent}
                                        ${upcomingHtml}
                                    </section>

                                    <section class="flex flex-1">
                                        <div class="flex w-full flex-col gap-5 rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-xl shadow-[0_25px_70px_-55px_rgba(15,118,110,0.5)] sm:p-6">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-200/80">Ejercicio en curso</p>
                                                    <h2 class="mt-1 text-2xl font-semibold leading-tight text-white">${exercise.name}</h2>
                                                </div>
                                                <button data-action="show-exercise-info" data-exercise-name="${exercise.name}" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-300 transition hover:border-sky-400/60 hover:bg-sky-500/10 hover:text-white">
                                                    <i data-lucide="info" class="h-5 w-5"></i>
                                                </button>
                                            </div>

                                            <div class="space-y-3">
                                                <div class="flex items-center gap-2">
                                                    ${setIndicators}
                                                </div>
                                                ${statsHtml}
                                            </div>

                                            <div class="flex flex-1 items-center justify-center">
                                                <div class="live-workout-display w-full">
                                                    ${mainDisplayHtml}
                                                </div>
                                            </div>

                                            ${timerStatus === 'resting' ? '' : '<p class="text-center text-xs text-gray-400">Mantén la buena forma y controla la respiración.</p>'}
                                        </div>
                                    </section>
                                </div>
                            </main>

                            <footer class="fixed inset-x-0 bottom-0 border-t border-white/5 bg-gray-950/95 px-4 py-4 backdrop-blur-sm sm:px-6">
                                <div class="mx-auto flex w-full max-w-5xl flex-col gap-3">
                                    ${restControlsSection}
                                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                        ${exitRoutineButtonHtml}
                                        ${mainButtonHtml}
                                    </div>
                                </div>
                            </footer>
                        </div>
                    `;

                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');

                    if (timerStatus === 'logging_weight') {
                        const weightInput = document.getElementById('weight-input');
                        if (weightInput) {
                            weightInput.focus();
                            weightInput.select();
                        }
                    }

                    lucide.createIcons();
                    if (timerStatus === 'resting') {
                        this.updateRestTimerVisuals();
                    }
                },

            updateWorkoutTimerDisplay() {
                if (!this.state.activeWorkout || !this.state.activeWorkout.workoutStartTime) {
                    return;
                }
                const timerElement = document.getElementById('main-workout-timer');
                if (timerElement) {
                    const elapsedSeconds = Math.floor((Date.now() - this.state.activeWorkout.workoutStartTime) / 1000);
                    timerElement.textContent = this.formatTime(elapsedSeconds);
                }
            },
            updateRestTimerVisuals() {
                if (!this.state.timer || this.state.timer.status !== 'resting') {
                    return;
                }
                const timeLeft = Math.max(0, this.state.timer.timeLeft);
                const displayElement = document.getElementById('rest-timer-display');
                if (displayElement) {
                    displayElement.textContent = this.formatTime(timeLeft);
                }
                const circleElement = document.getElementById('rest-progress-circle');
                if (circleElement) {
                    const circumference = parseFloat(circleElement.getAttribute('data-circumference')) || 0;
                    const initialRest = this.state.timer.initialRestTime || 0;
                    if (circumference > 0 && initialRest > 0) {
                        const fraction = Math.min(1, Math.max(0, timeLeft / initialRest));
                        circleElement.style.strokeDashoffset = `${circumference - fraction * circumference}`;
                    }
                }
            },
            handleWorkoutAction() { const status = this.state.timer.status; if (status === 'idle') { this.state.timer.status = 'active'; } else if (status === 'active') { this.state.timer.status = 'logging_weight'; } else if (status === 'logging_weight') { const weightInput = document.getElementById('weight-input'); const weightValue = parseFloat(weightInput.value); const weightToLog = !isNaN(weightValue) && weightValue >= 0 ? weightValue : 0; const { exercises, currentExerciseIndex, currentSet } = this.state.activeWorkout; exercises[currentExerciseIndex].log[currentSet - 1] = weightToLog; this.state.activeWorkout.currentSet++; if (this.state.activeWorkout.currentSet <= exercises[currentExerciseIndex].sets) { this.startRestTimer(); } else { if (this.state.activeWorkout.currentExerciseIndex >= this.state.activeWorkout.exercises.length - 1) { this.state.timer.status = 'workout_complete'; } else { this.state.timer.status = 'exercise_complete'; } } } else if (status === 'exercise_complete') { this.startRestTimer(true); this.state.activeWorkout.currentExerciseIndex++; this.state.activeWorkout.currentSet = 1; this.state.timer.status = 'resting'; } else if (status === 'workout_complete') { this.finishWorkout(true); return; } this.renderLiveWorkoutView(); },
            startRestTimer(isBetweenExercises) {
                clearInterval(this.state.timer.intervalId);
                const { exercises, currentExerciseIndex } = this.state.activeWorkout;
                const betweenExercises = Boolean(isBetweenExercises);

                let restSeconds;
                if (betweenExercises) {
                    restSeconds = 90;
                } else {
                    const restString = exercises[currentExerciseIndex].rest || '60s';
                    restSeconds = parseInt(restString.match(/\d+/)[0] || 60);
                }

                this.state.activeWorkout.totalRestTime += restSeconds;
                this.state.timer = { ...this.state.timer, status: 'resting', timeLeft: restSeconds, initialRestTime: restSeconds };
                this.playSound('start');

                this.state.timer.intervalId = setInterval(() => {
                    if (!this.state.timer) {
                        return clearInterval(this.state.timer.intervalId);
                    }

                    this.state.timer.timeLeft--;
                    if (this.state.timer.timeLeft <= 0) {
                        this.playSound('end');
                        this.skipRest();
                    } else {
                        this.updateRestTimerVisuals();
                    }
                }, 1000);
            },
            addRestTime() { if (this.state.timer.status === 'resting') { this.state.timer.timeLeft += 15; this.state.timer.initialRestTime += 15; this.state.activeWorkout.totalRestTime += 15; this.showToast("+15 segundos añadidos"); this.updateRestTimerVisuals(); } },
            skipRest() { if (this.state.timer.status === 'resting') { clearInterval(this.state.timer.intervalId); this.state.timer.status = 'idle'; this.renderLiveWorkoutView(); } },
            confirmCancelWorkout() {
                const hasActiveWorkout = Boolean(this.state.activeWorkout);
                const hasLoggedProgress = hasActiveWorkout && Array.isArray(this.state.activeWorkout.exercises)
                    && this.state.activeWorkout.exercises.some(exercise => Array.isArray(exercise.log) && exercise.log.length > 0);
                const hasAdvancedExercise = hasActiveWorkout && (
                    (this.state.activeWorkout.currentExerciseIndex ?? 0) > 0
                    || (this.state.activeWorkout.currentSet ?? 1) > 1
                );
                const hasMeaningfulProgress = hasLoggedProgress || hasAdvancedExercise;

                const description = hasMeaningfulProgress
                    ? '<p class="text-sm text-gray-300">¿Deseas salir de la rutina en vivo? Puedes guardar tus avances registrados hasta el momento o salir sin conservarlos.</p>'
                    : '<p class="text-sm text-gray-300">¿Deseas salir de la rutina en vivo? Aún no registras progreso, por lo que puedes abandonar ahora sin guardar datos.</p>';

                const helper = hasMeaningfulProgress
                    ? '<p class="text-xs text-gray-500">Elige "Salir y guardar" para conservar series, pesos y tiempos anotados hasta ahora.</p>'
                    : '<p class="text-xs text-gray-500">Si prefieres guardar, podrás registrar el estado actual de todos modos.</p>';

                this.showModal('Salir de la rutina', `<div class="space-y-3 text-left">${description}${helper}</div>`, [
                    { text: 'Seguir entrenando', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                    { text: 'Salir sin guardar', class: 'bg-rose-600 hover:bg-rose-500', action: 'exit-without-saving' },
                    { text: 'Salir y guardar', class: 'bg-emerald-500 text-gray-900 hover:bg-emerald-400', action: 'exit-and-save' }
                ]);
            },
            async finishWorkout(completed) {
                const isCompleted = typeof completed === 'undefined' ? true : Boolean(completed);
                const overlay = document.getElementById('live-workout-overlay');

                if (!this.state.activeWorkout) {
                    if (overlay) {
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                    }
                    this.hideModal();
                    return;
                }

                clearInterval(this.state.activeWorkout.workoutTimerIntervalId);
                if (this.state.timer?.intervalId) {
                    clearInterval(this.state.timer.intervalId);
                }

                const totalDuration = Math.floor((Date.now() - this.state.activeWorkout.workoutStartTime) / 1000);
                const totalRest = this.state.activeWorkout.totalRestTime || 0;
                const totalActive = Math.max(0, totalDuration - totalRest);

                if (isCompleted) {
                    const today = new Date();
                    const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    const baseLog = this.state.activeWorkout.exercises.map(ex => ({ name: ex.name, sets: ex.sets, reps: ex.reps, log: ex.log }));
                    const exerciseDetails = baseLog.map(exercise => {
                        const reps = this.parseRepsValue(exercise.reps);
                        const weights = (exercise.log || []).filter(value => typeof value === 'number' && !Number.isNaN(value));
                        const completedSets = weights.length;
                        const bestWeight = weights.length ? Math.max(...weights) : 0;
                        const volume = weights.reduce((sum, weight) => sum + (weight * (reps || 1)), 0);
                        const estimated1RM = this.estimateOneRepMax(bestWeight, exercise.reps || reps);
                        return { ...exercise, weights, completedSets, bestWeight, volume, estimated1RM };
                    });
                    const totalVolume = exerciseDetails.reduce((sum, ex) => sum + ex.volume, 0);
                    const totalSetsCompleted = exerciseDetails.reduce((sum, ex) => sum + ex.completedSets, 0);
                    const peakOneRepMax = exerciseDetails.reduce((max, ex) => Math.max(max, ex.estimated1RM || 0), 0);

                    const summary = {
                        id: `workout-${Date.now()}`,
                        date: dateString,
                        completedAt: today.toISOString(),
                        routineId: this.state.activeWorkout.routineId,
                        dayIndex: this.state.activeWorkout.dayIndex,
                        routineName: this.state.activeWorkout.routineName,
                        dayName: this.state.activeWorkout.dayName,
                        totalDuration,
                        totalActive,
                        totalRest,
                        totalVolume,
                        totalSetsCompleted,
                        peakOneRepMax,
                        log: baseLog,
                        exerciseDetails
                    };

                    if (!this.state.workoutHistory) this.state.workoutHistory = {};
                    if (!Array.isArray(this.state.workoutHistory[dateString])) {
                        this.state.workoutHistory[dateString] = [];
                    }
                    this.state.workoutHistory[dateString].push(summary);
                    this.state.workoutHistory[dateString].sort((a, b) => new Date(a.completedAt) - new Date(b.completedAt));
                    this.showWorkoutSummaryModal(summary);
                } else {
                    this.hideModal();
                }

                this.state.activeWorkout = null;
                this.state.timer = null;
                await this.saveDataToFirestore();
                if (overlay) {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                }
                this.renderAll();
            },
            showWorkoutSummaryModal(summary) {
                const intlFormatter = new Intl.NumberFormat('es-ES');
                const formattedDateTime = summary.completedAt
                    ? new Date(summary.completedAt).toLocaleString('es-ES', { dateStyle: 'long', timeStyle: 'short' })
                    : new Date(`${summary.date}T00:00:00`).toLocaleDateString('es-ES', { dateStyle: 'long' });
                const formattedVolume = intlFormatter.format(Math.round(summary.totalVolume || 0));
                const formattedSets = intlFormatter.format(summary.totalSetsCompleted || 0);
                const exerciseSections = summary.exerciseDetails && summary.exerciseDetails.length > 0
                    ? summary.exerciseDetails.map(exercise => {
                        const totalSets = parseInt(exercise.sets, 10) || exercise.log.length || 0;
                        const setBadges = Array.from({ length: totalSets }).map((_, index) => {
                            const weight = exercise.log?.[index];
                            const isCompleted = typeof weight === 'number' && !Number.isNaN(weight);
                            return `<span class="rounded-full border ${isCompleted ? 'border-emerald-400/40 bg-emerald-500/15 text-emerald-100' : 'border-white/10 bg-white/5 text-gray-400'} px-3 py-1 text-[11px] font-semibold">S${index + 1}: ${isCompleted ? `${weight} kg` : 'Pendiente'}</span>`;
                        }).join('');
                        return `
                            <div class="rounded-2xl border border-white/10 bg-gray-900/70 p-4">
                                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                    <div>
                                        <p class="text-sm font-semibold text-white">${exercise.name}</p>
                                        <p class="text-xs text-gray-400">${exercise.completedSets}/${exercise.sets || exercise.log.length} series registradas · ${exercise.reps || '—'} reps objetivo</p>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-emerald-200">
                                        <i data-lucide="bar-chart" class="h-4 w-4"></i>
                                        Volumen: ${intlFormatter.format(Math.round(exercise.volume || 0))} kg·reps
                                    </div>
                                </div>
                                <div class="mt-3 flex flex-wrap gap-2 text-[11px] text-gray-300">
                                    <span class="inline-flex items-center gap-1 rounded-full border border-sky-400/40 bg-sky-500/10 px-3 py-1 font-semibold text-sky-100">
                                        <i data-lucide="weight" class="h-3.5 w-3.5"></i>
                                        Máx: ${exercise.bestWeight ? `${exercise.bestWeight} kg` : '—'}
                                    </span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-amber-400/40 bg-amber-500/10 px-3 py-1 font-semibold text-amber-100">
                                        <i data-lucide="repeat-2" class="h-3.5 w-3.5"></i>
                                        Series completadas: ${exercise.completedSets}
                                    </span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-purple-400/40 bg-purple-500/10 px-3 py-1 font-semibold text-purple-100">
                                        <i data-lucide="line-chart" class="h-3.5 w-3.5"></i>
                                        1RM: ${exercise.estimated1RM ? `${exercise.estimated1RM.toFixed(1)} kg` : '—'}
                                    </span>
                                </div>
                                <div class="mt-4 flex flex-wrap gap-2">
                                    ${setBadges}
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<p class="text-gray-500 text-sm p-3 bg-gray-900/60 rounded-2xl text-center">No se registraron pesos en esta sesión.</p>';

                const logString = encodeURIComponent(JSON.stringify(summary.log));
                const body = `
                    <div class="space-y-6 text-left">
                        <div class="rounded-3xl bg-gradient-to-br from-emerald-500/20 via-teal-500/10 to-cyan-500/20 border border-emerald-400/20 p-5 text-emerald-100">
                            <div class="flex flex-col gap-1">
                                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200/80">Resumen de progreso</p>
                                <h3 class="text-xl font-semibold text-white">${summary.routineName}</h3>
                                <p class="text-sm text-emerald-100/80">${formattedDateTime}</p>
                            </div>
                        </div>
                        <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Duración total</p>
                                <p class="mt-2 text-2xl font-bold">${this.formatTime(summary.totalDuration)}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Tiempo activo</p>
                                <p class="mt-2 text-2xl font-bold">${this.formatTime(summary.totalActive)}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Descanso acumulado</p>
                                <p class="mt-2 text-2xl font-bold">${this.formatTime(summary.totalRest)}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Volumen (kg·reps)</p>
                                <p class="mt-2 text-2xl font-bold">${formattedVolume}</p>
                                <p class="text-xs text-gray-400 mt-1">${formattedSets} series registradas</p>
                                <p class="text-xs text-gray-400">1RM máximo: ${summary.peakOneRepMax ? `${summary.peakOneRepMax.toFixed(1)} kg` : '—'}</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <h4 class="text-sm font-semibold text-gray-200 uppercase tracking-[0.35em]">Detalle por ejercicio</h4>
                                <span class="text-xs text-gray-400">Analiza tus pesos serie a serie</span>
                            </div>
                            <div class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                ${exerciseSections}
                            </div>
                        </div>
                        <div id="ai-analysis-container" class="space-y-2"></div>
                    </div>
                `;

                const footerButtons = [
                    { text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                    { text: 'Ver historial', class: 'bg-sky-500 text-gray-900 hover:bg-sky-400', action: 'show-workout-history', 'history-date': summary.date },
                    { text: '✨ Analizar', class: 'bg-gradient-to-r from-purple-500 to-indigo-600', action: 'analyze-workout-performance', 'log-data': logString }
                ];

                this.showModal('Resumen del entrenamiento', body, footerButtons);
                lucide.createIcons();
            },
            _normalizeWorkoutEntry(entry, dateKey) {
                if (!entry || typeof entry !== 'object') {
                    return {
                        id: `workout-${Date.now()}`,
                        date: dateKey,
                        completedAt: new Date(`${dateKey}T00:00:00`).toISOString(),
                        routineId: '',
                        dayIndex: 0,
                        routineName: 'Sesión',
                        dayName: '',
                        totalDuration: 0,
                        totalRest: 0,
                        totalActive: 0,
                        totalVolume: 0,
                        totalSetsCompleted: 0,
                        log: [],
                        exerciseDetails: []
                    };
                }

                const baseLog = Array.isArray(entry.log)
                    ? entry.log.map(ex => ({
                        name: ex.name,
                        sets: ex.sets,
                        reps: ex.reps,
                        log: Array.isArray(ex.log) ? ex.log : []
                    }))
                    : [];

                const deriveDetails = (source) => {
                    const reps = this.parseRepsValue(source.reps);
                    const weights = (source.log || []).filter(value => typeof value === 'number' && !Number.isNaN(value));
                    const completedSets = weights.length;
                    const bestWeight = weights.length ? Math.max(...weights) : 0;
                    const volume = weights.reduce((sum, weight) => sum + weight * (reps || 1), 0);
                    return {
                        name: source.name,
                        sets: source.sets,
                        reps: source.reps,
                        log: source.log || [],
                        weights,
                        completedSets,
                        bestWeight,
                        volume,
                        estimated1RM: this.estimateOneRepMax(bestWeight, source.reps || reps)
                    };
                };

                const exerciseDetails = Array.isArray(entry.exerciseDetails) && entry.exerciseDetails.length > 0
                    ? entry.exerciseDetails.map(detail => {
                        const base = baseLog.find(ex => ex.name === detail.name) || detail;
                        const normalizedLog = Array.isArray(detail.log) ? detail.log : (base.log || []);
                        const weights = Array.isArray(detail.weights) ? detail.weights : normalizedLog.filter(value => typeof value === 'number' && !Number.isNaN(value));
                        const reps = this.parseRepsValue(detail.reps ?? base.reps);
                        const completedSets = typeof detail.completedSets === 'number' ? detail.completedSets : weights.length;
                        const bestWeight = typeof detail.bestWeight === 'number' ? detail.bestWeight : (weights.length ? Math.max(...weights) : 0);
                        const volume = typeof detail.volume === 'number' ? detail.volume : weights.reduce((sum, weight) => sum + weight * (reps || 1), 0);
                        return {
                            name: detail.name || base.name,
                            sets: detail.sets ?? base.sets,
                            reps: detail.reps ?? base.reps,
                            log: normalizedLog,
                            weights,
                            completedSets,
                            bestWeight,
                            volume,
                            estimated1RM: typeof detail.estimated1RM === 'number' ? detail.estimated1RM : this.estimateOneRepMax(bestWeight, detail.reps ?? base.reps)
                        };
                    })
                    : baseLog.map(deriveDetails);

                const totalDuration = entry.totalDuration || 0;
                const totalRest = entry.totalRest || 0;
                const totalActive = entry.totalActive || Math.max(0, totalDuration - totalRest);
                const totalVolume = typeof entry.totalVolume === 'number' ? entry.totalVolume : exerciseDetails.reduce((sum, ex) => sum + (ex.volume || 0), 0);
                const totalSetsCompleted = typeof entry.totalSetsCompleted === 'number' ? entry.totalSetsCompleted : exerciseDetails.reduce((sum, ex) => sum + (ex.completedSets || 0), 0);
                const peakOneRepMax = typeof entry.peakOneRepMax === 'number' ? entry.peakOneRepMax : exerciseDetails.reduce((max, ex) => Math.max(max, ex.estimated1RM || 0), 0);

                return {
                    id: entry.id || `workout-${Date.parse(entry.completedAt || `${dateKey}T00:00:00`) || Date.now()}`,
                    date: entry.date || dateKey,
                    completedAt: entry.completedAt || new Date(`${dateKey}T00:00:00`).toISOString(),
                    routineId: entry.routineId || '',
                    dayIndex: typeof entry.dayIndex === 'number' ? entry.dayIndex : 0,
                    routineName: entry.routineName || 'Sesión',
                    dayName: entry.dayName || '',
                    totalDuration,
                    totalRest,
                    totalActive,
                    totalVolume,
                    totalSetsCompleted,
                    peakOneRepMax,
                    log: baseLog,
                    exerciseDetails
                };
            },
            getWorkoutHistoryEntries() {
                if (!this.state.workoutHistory) return [];
                const entries = [];
                Object.entries(this.state.workoutHistory).forEach(([date, records]) => {
                    if (Array.isArray(records)) {
                        records.forEach(record => entries.push({ ...record, date }));
                    }
                });
                return entries.sort((a, b) => {
                    const aDate = new Date(a.completedAt || `${a.date}T00:00:00`);
                    const bDate = new Date(b.completedAt || `${b.date}T00:00:00`);
                    return bDate - aDate;
                });
            },
            openWorkoutHistoryModal(targetDate) {
                if (!this.state.workoutHistory || Object.keys(this.state.workoutHistory).length === 0) {
                    this.showModal('Historial de entrenamientos', '<p class="text-sm text-gray-300">Registra tu primera rutina para comenzar a visualizar estadísticas.</p>', [
                        { text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }
                    ]);
                    return;
                }

                const entriesByDate = Object.entries(this.state.workoutHistory)
                    .filter(([, records]) => Array.isArray(records) && records.length > 0)
                    .sort((a, b) => new Date(b[0]) - new Date(a[0]));

                if (entriesByDate.length === 0) {
                    this.showModal('Historial de entrenamientos', '<p class="text-sm text-gray-300">Aún no hay sesiones registradas.</p>', [
                        { text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }
                    ]);
                    return;
                }

                const intlFormatter = new Intl.NumberFormat('es-ES');
                const selectedDate = targetDate && this.state.workoutHistory[targetDate] && this.state.workoutHistory[targetDate].length > 0
                    ? targetDate
                    : entriesByDate[0][0];

                const selectedEntries = this.state.workoutHistory[selectedDate]
                    .slice()
                    .sort((a, b) => new Date(b.completedAt || 0) - new Date(a.completedAt || 0));

                const totalSessions = entriesByDate.reduce((sum, [, list]) => sum + list.length, 0);
                const totalActiveSeconds = entriesByDate.reduce((sum, [, list]) => sum + list.reduce((acc, entry) => acc + (entry.totalActive || 0), 0), 0);
                const totalVolume = entriesByDate.reduce((sum, [, list]) => sum + list.reduce((acc, entry) => acc + (entry.totalVolume || 0), 0), 0);
                const averageActive = totalSessions ? Math.round(totalActiveSeconds / totalSessions) : 0;

                const dateListHtml = entriesByDate.map(([dateKey, list]) => {
                    const formattedDay = new Date(`${dateKey}T00:00:00`).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
                    const dayVolume = list.reduce((acc, entry) => acc + (entry.totalVolume || 0), 0);
                    const isActive = dateKey === selectedDate;
                    return `
                        <button data-action="show-workout-history" data-history-date="${dateKey}" class="w-full rounded-2xl border ${isActive ? 'border-emerald-400/40 bg-emerald-500/15 text-emerald-100' : 'border-white/10 bg-white/5 text-gray-300 hover:border-emerald-300/40 hover:text-white'} px-4 py-3 text-left transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-semibold capitalize">${formattedDay}</p>
                                    <p class="text-xs text-gray-400">${list.length} sesiones · ${intlFormatter.format(Math.round(dayVolume))} kg·reps</p>
                                </div>
                                <i data-lucide="chevron-right" class="h-4 w-4"></i>
                            </div>
                        </button>
                    `;
                }).join('');

                const selectedDateLabel = new Date(`${selectedDate}T00:00:00`).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

                const selectedEntriesHtml = selectedEntries.map(entry => {
                    const timeLabel = entry.completedAt
                        ? new Date(entry.completedAt).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
                        : '';
                    const entryVolume = intlFormatter.format(Math.round(entry.totalVolume || 0));
                    const topExercises = (entry.exerciseDetails || []).slice(0, 3).map(ex => {
                        const bestWeightLabel = ex.bestWeight ? `${ex.bestWeight} kg` : '—';
                        const oneRmLabel = ex.estimated1RM ? `${ex.estimated1RM.toFixed(1)} kg` : '—';
                        return `
                            <div class="flex items-center justify-between gap-2 text-xs text-gray-300">
                                <span class="truncate pr-2">${ex.name}</span>
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2.5 py-0.5 text-emerald-100"><i data-lucide="dumbbell" class="h-3.5 w-3.5"></i>${bestWeightLabel}</span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-purple-400/40 bg-purple-500/10 px-2.5 py-0.5 text-purple-100"><i data-lucide="line-chart" class="h-3.5 w-3.5"></i>${oneRmLabel}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    return `
                        <div class="rounded-2xl border border-white/10 bg-gray-900/70 p-4">
                            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <div>
                                    <p class="text-base font-semibold text-white">${entry.routineName}</p>
                                    <p class="text-xs text-gray-400">${entry.dayName || 'Sesión'} ${timeLabel ? `· ${timeLabel}` : ''}</p>
                                </div>
                                <div class="flex flex-wrap gap-3 text-xs text-gray-300">
                                    <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-3 py-1"><i data-lucide="timer" class="h-3.5 w-3.5"></i>${this.formatTime(entry.totalDuration)}</span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-3 py-1 text-emerald-100"><i data-lucide="flame" class="h-3.5 w-3.5"></i>${this.formatTime(entry.totalActive)}</span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-sky-400/40 bg-sky-500/10 px-3 py-1 text-sky-100"><i data-lucide="bar-chart" class="h-3.5 w-3.5"></i>${entryVolume} kg·reps</span>
                                </div>
                            </div>
                            <div class="mt-3 space-y-1">
                                ${topExercises || '<p class="text-xs text-gray-500">Añade pesos para ver más detalles.</p>'}
                            </div>
                        </div>
                    `;
                }).join('');

                const body = `
                    <div class="flex flex-col gap-6 lg:flex-row">
                        <aside class="space-y-4 lg:w-1/3">
                            <div class="rounded-3xl border border-white/10 bg-white/5 p-5 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Resumen general</p>
                                <div class="mt-4 space-y-3 text-sm">
                                    <div class="flex items-center justify-between">
                                        <span>Sesiones registradas</span>
                                        <strong>${intlFormatter.format(totalSessions)}</strong>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span>Volumen total</span>
                                        <strong>${intlFormatter.format(Math.round(totalVolume))} kg·reps</strong>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span>Tiempo activo promedio</span>
                                        <strong>${this.formatTime(averageActive)}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2 max-h-80 overflow-y-auto pr-1">
                                ${dateListHtml}
                            </div>
                        </aside>
                        <section class="flex-1 space-y-4">
                            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <h3 class="text-lg font-semibold text-white capitalize">${selectedDateLabel}</h3>
                                <p class="text-xs text-gray-400">${selectedEntries.length} sesiones registradas</p>
                            </div>
                            <div class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                ${selectedEntriesHtml || '<p class="text-sm text-gray-400">No hay entrenamientos registrados en esta fecha.</p>'}
                            </div>
                        </section>
                    </div>
                `;

                this.showModal('Historial de entrenamientos', body, [
                    { text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }
                ]);
                lucide.createIcons();
            },
        };
            window.app = app;
            app.init();
            initHeaderFadeEffect();
        };

        if (document.readyState === 'loading') {
            const onceHandler = () => {
                document.removeEventListener('DOMContentLoaded', onceHandler);
                bootstrapApp();
            };
            document.addEventListener('DOMContentLoaded', onceHandler);
        } else {
            bootstrapApp();
        }
</script>

</body>
</html>
