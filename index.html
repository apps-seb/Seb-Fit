<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FitTrack - Tu Asistente Fitness Personal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body.mobile-menu-open { overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } 
        ::-webkit-scrollbar-track { background: transparent; } 
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; } 
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }
        @keyframes toastIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; translateY(20px); } }
        @keyframes fadeslidein { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pulse-strong { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        @keyframes bar-grow { from { transform: scaleY(0); } to { transform: scaleY(1); } }

        .section-fade-in { animation: fadeIn 0.5s ease-in-out; }
        .modal-fade-in { animation: fadeIn 0.3s ease-out; }
        .modal-fade-out { animation: fadeOut 0.3s ease-in forwards; }
        .toast { animation: toastIn 0.5s ease-out forwards, toastOut 0.5s ease-in 2.5s forwards; }
        #timer-progress-ring { transition: stroke-dashoffset 1s linear; }

        #mobile-menu-backdrop { opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #mobile-menu-backdrop.is-visible { opacity: 1; pointer-events: auto; }

        .horizontal-scroll-container { -ms-overflow-style: none; scrollbar-width: none; }
        .horizontal-scroll-container::-webkit-scrollbar { display: none; }
        .fullscreen-view { transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); transform: translateX(100%); }
        .fullscreen-view.is-active { transform: translateX(0); }
        #exercise-drawer { transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s; transform: translateY(100%); opacity: 0; pointer-events: none; }
        #exercise-drawer.is-active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .exercise-accordion summary::-webkit-details-marker, details summary::-webkit-details-marker { display: none; }
        .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
        .live-workout-display { animation: fadeslidein 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        .active-workout-state { animation: pulse-strong 1.5s infinite ease-in-out; }
        .prose h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .prose h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.25rem; }
        .prose ul, .prose ol { margin-left: 1rem; }
        .chart-bar { animation: bar-grow 0.8s cubic-bezier(0.25, 1, 0.5, 1); transform-origin: bottom; }
        #bmi-marker { transition: left 0.5s ease-in-out; }

        #app-sidebar { transition: background-color 0.3s ease, box-shadow 0.3s ease, width 0.3s ease, padding 0.3s ease; }
        #app-sidebar .nav-btn { transition: all 0.25s ease; color: #9ca3af; }
        #app-sidebar .nav-btn.is-active { color: #34d399; }
        #app-sidebar .nav-btn i { width: 1.25rem; height: 1.25rem; }
        #app-sidebar .sidebar-brand, #app-sidebar .sidebar-footer { transition: opacity 0.25s ease, transform 0.25s ease; }
        #app-sidebar .nav-label { transition: opacity 0.25s ease, margin 0.25s ease; }

        @media (max-width: 1023px) {
            #app-sidebar { border-top: 1px solid rgba(75, 85, 99, 0.6); }
            #app-sidebar .nav-btn { font-size: 0.75rem; font-weight: 600; }
            #app-sidebar.mobile-overlay { top: 0; bottom: 0; right: auto; left: 0; width: 18rem; max-width: calc(100vw - 3rem);
                padding: 1.75rem 1.5rem; border-radius: 0 1.5rem 1.5rem 0; border-top: none; border-right: 1px solid rgba(75, 85,
                99, 0.6); border-left: none; border-bottom: none; background: rgba(17, 24, 39, 0.98); box-shadow: 0 25px 60px -22px
                rgba(16, 185, 129, 0.35); transform: translateX(-110%); display: flex; flex-direction: column; gap: 1.5rem;
                align-items: stretch; z-index: 50; }
            #app-sidebar.mobile-overlay[data-mobile-open="true"] { transform: translateX(0); }
            #app-sidebar.mobile-overlay #main-nav-bar { display: flex; flex-direction: column; align-items: stretch; gap: 0.75rem; }
            #app-sidebar.mobile-overlay .nav-btn { flex-direction: row; justify-content: flex-start; gap: 0.75rem; padding: 0.75rem 1rem; }
            #app-sidebar.mobile-overlay .nav-label { opacity: 1; }
            #app-sidebar.mobile-overlay .sidebar-brand { display: flex !important; }
            #app-sidebar.mobile-overlay .sidebar-footer { display: block !important; }
            #app-sidebar.mobile-overlay #mobile-bottom-nav { display: none; }
        }

        @media (min-width: 1024px) {
            #app-sidebar { width: 18rem; background: rgba(255, 255, 255, 0.96); color: #111827; border-radius: 1.75rem; padding: 1.75rem 1.5rem; box-shadow: 0 25px 50px -12px rgba(15, 118, 110, 0.25); border: 1px solid rgba(229, 231, 235, 0.8); position: sticky; top: 1.5rem; max-height: calc(100vh - 3rem); backdrop-filter: blur(12px); }
            #app-sidebar .nav-btn { color: #6b7280; justify-content: flex-start; border-radius: 1.5rem; padding: 0.75rem 1rem; font-weight: 600; font-size: 0.95rem; }
            #app-sidebar .nav-btn.is-active { color: #0f766e; background: linear-gradient(120deg, rgba(16, 185, 129, 0.18), rgba(20, 184, 166, 0.08)); box-shadow: 0 10px 25px -10px rgba(16, 185, 129, 0.6); }
            #app-sidebar .nav-btn:not(.is-active):hover { color: #111827; background: rgba(243, 244, 246, 0.9); }
            #app-sidebar .nav-btn .nav-label { font-size: 0.95rem; margin-left: 0.75rem; }
            #app-sidebar .sidebar-footer { opacity: 1; transform: translateY(0); }
            #app-sidebar[data-collapsed="true"] { width: 5rem; padding-left: 1rem; padding-right: 1rem; }
            #app-sidebar[data-collapsed="true"] .sidebar-brand,
            #app-sidebar[data-collapsed="true"] .sidebar-footer { opacity: 0; transform: translateX(-12px); pointer-events: none; }
            #app-sidebar[data-collapsed="true"] .nav-btn { justify-content: center; padding-left: 0; padding-right: 0; }
            #app-sidebar[data-collapsed="true"] .nav-btn .nav-label { opacity: 0; width: 0; margin: 0; }
        }
        
        .auth-form-container { transition: all 0.4s ease-in-out; }
        .form-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; position: absolute; }
        .form-visible { opacity: 1; transform: scale(1); pointer-events: auto; position: relative; }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-gray-900 to-gray-800">
        <div class="w-full max-w-md mx-auto">
            <div class="flex items-center justify-center space-x-3 mb-8">
                <i data-lucide="dumbbell" class="text-emerald-400 w-10 h-10"></i>
                <h1 class="text-4xl font-bold tracking-tight">FitTrack</h1>
            </div>
            
            <div id="auth-card" class="bg-gray-800/50 backdrop-blur-lg border border-gray-700 rounded-2xl p-8 shadow-2xl relative overflow-hidden">
                <div id="login-form-container" class="auth-form-container form-visible">
                    <h2 class="text-2xl font-bold text-center mb-1">Bienvenido de Nuevo</h2>
                    <p class="text-center text-gray-400 mb-6">Inicia sesi√≥n para continuar tu progreso.</p>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                            <input type="email" id="login-email" required class="w-full bg-gray-700 rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-emerald-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-300 mb-1">Contrase√±a</label>
                            <input type="password" id="login-password" required class="w-full bg-gray-700 rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-emerald-500 focus:outline-none transition">
                        </div>
                        <button type="submit" class="w-full bg-emerald-500 text-gray-900 font-bold py-3 rounded-lg hover:bg-emerald-400 transition shadow-lg shadow-emerald-500/20 flex items-center justify-center">
                            <span>Iniciar Sesi√≥n</span>
                        </button>
                    </form>
                    <p class="text-center text-sm text-gray-400 mt-6">
                        ¬øNo tienes una cuenta? <button data-action="toggle-auth" class="font-semibold text-emerald-400 hover:underline">Reg√≠strate aqu√≠</button>
                    </p>
                </div>

                <div id="register-form-container" class="auth-form-container form-hidden">
                    <h2 class="text-2xl font-bold text-center mb-1">Crea tu Cuenta</h2>
                    <p class="text-center text-gray-400 mb-6">Empieza tu viaje fitness hoy mismo.</p>
                    <form id="register-form" class="space-y-4">
                        <div>
                            <label for="register-name" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label>
                            <input type="text" id="register-name" required class="w-full bg-gray-700 rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-emerald-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label for="register-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                            <input type="email" id="register-email" required class="w-full bg-gray-700 rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-emerald-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-300 mb-1">Contrase√±a</label>
                            <input type="password" id="register-password" required class="w-full bg-gray-700 rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-emerald-500 focus:outline-none transition">
                        </div>
                        <button type="submit" class="w-full bg-emerald-500 text-gray-900 font-bold py-3 rounded-lg hover:bg-emerald-400 transition shadow-lg shadow-emerald-500/20 flex items-center justify-center">
                            <span>Crear Cuenta</span>
                        </button>
                    </form>
                    <p class="text-center text-sm text-gray-400 mt-6">
                        ¬øYa tienes una cuenta? <button data-action="toggle-auth" class="font-semibold text-emerald-400 hover:underline">Inicia sesi√≥n</button>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="app-container" class="hidden relative min-h-screen bg-gray-900 text-white">
        <div class="lg:flex lg:min-h-screen lg:mx-auto lg:max-w-7xl lg:gap-6">
            <nav id="app-sidebar" data-collapsed="true" data-mobile-open="false" class="fixed bottom-0 left-0 right-0 z-30 bg-gray-900/85 backdrop-blur-lg border-t border-gray-800 px-3 pt-2 pb-3 lg:flex lg:flex-col lg:items-stretch lg:gap-8 lg:border-none lg:px-0 lg:pt-0 lg:pb-0">
                <div class="hidden lg:flex items-center justify-between sidebar-brand">
                    <div class="flex items-center gap-3">
                        <div class="h-11 w-11 rounded-2xl bg-emerald-500 text-gray-900 flex items-center justify-center shadow-lg shadow-emerald-500/30">
                            <i data-lucide="dumbbell" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-emerald-600 uppercase tracking-[0.35em]">FitTrack</p>
                            <p class="text-lg font-bold text-gray-900">Panel Principal</p>
                        </div>
                    </div>
                </div>
                <div id="main-nav-bar" class="hidden flex-col items-stretch gap-3 lg:mt-8 lg:flex">
                    <button data-section="inicio" class="nav-btn is-active flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="home"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Inicio</span>
                    </button>
                    <button id="nav-rutinas" data-section="rutinas" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="clipboard-list"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Rutinas</span>
                    </button>
                    <button id="nav-asesorados" data-section="asesorados" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="users"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Asesorados</span>
                    </button>
                    <button id="nav-nutricion" data-section="nutricion" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="calculator"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">C√°lculos</span>
                    </button>
                    <button id="nav-dieta" data-section="dieta" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="utensils"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Dieta</span>
                    </button>
                    <button id="nav-historial" data-section="historial" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="history"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Historial</span>
                    </button>
                    <button data-section="perfil" class="nav-btn flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold lg:flex-row lg:justify-start lg:gap-3 lg:px-4 lg:py-3 lg:uppercase lg:tracking-normal">
                        <i data-lucide="user"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase lg:text-sm lg:font-semibold lg:tracking-normal lg:normal-case">Perfil</span>
                    </button>
                </div>
                <div id="mobile-bottom-nav" class="flex justify-around items-center gap-1 lg:hidden">
                    <button data-section="inicio" class="nav-btn is-active flex-1 flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold">
                        <i data-lucide="home"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase">Inicio</span>
                    </button>
                    <button data-section="rutinas" class="nav-btn flex-1 flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold">
                        <i data-lucide="clipboard-list"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase">Rutinas</span>
                    </button>
                    <button data-section="dieta" class="nav-btn flex-1 flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold">
                        <i data-lucide="utensils"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase">Dieta</span>
                    </button>
                    <button data-section="perfil" class="nav-btn flex-1 flex flex-col items-center gap-1 pt-2 pb-1 uppercase tracking-wide text-[11px] font-semibold">
                        <i data-lucide="user"></i>
                        <span class="nav-label text-[11px] font-semibold tracking-wide uppercase">Perfil</span>
                    </button>
                </div>
                <div class="hidden lg:block mt-auto pt-6 sidebar-footer">
                    <div class="bg-gradient-to-br from-emerald-500 via-emerald-400 to-teal-400 rounded-2xl p-5 text-emerald-950 shadow-xl shadow-emerald-500/25">
                        <p class="text-sm font-semibold">Impulsa a tus clientes</p>
                        <p class="text-xs text-emerald-900/80 mt-1">Gestiona rutinas, nutrici√≥n y h√°bitos desde un solo lugar.</p>
                    </div>
                </div>
            </nav>
            <div id="mobile-menu-backdrop" class="fixed inset-0 z-40 bg-black/60 backdrop-blur-sm lg:hidden"></div>

            <div class="flex-1 flex flex-col min-h-screen lg:min-h-0 lg:max-h-screen">
                <header class="bg-gray-900/80 backdrop-blur-sm px-4 sm:px-6 py-4 sticky top-0 z-20 flex items-center justify-between shadow-lg lg:rounded-2xl lg:mt-6 lg:mr-6 lg:ml-6">
                    <div class="flex items-center gap-3">
                        <button id="mobile-menu-toggle" type="button" aria-controls="app-sidebar" aria-expanded="false" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-200 transition hover:border-emerald-400/60 hover:bg-emerald-400/10 hover:text-white focus:outline-none focus:ring-2 focus:ring-emerald-400/60 lg:hidden">
                            <span class="sr-only">Abrir men√∫</span>
                            <i data-lucide="menu" class="h-5 w-5"></i>
                        </button>
                        <div class="flex items-center space-x-2"><i data-lucide="dumbbell" class="text-emerald-400"></i><h1 class="text-xl font-bold tracking-tight">FitTrack</h1></div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div id="user-avatar" class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center font-bold text-gray-900"><span></span></div>
                        <button id="logout-btn" title="Cerrar sesi√≥n" class="text-gray-400 hover:text-white transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                </header>

                <main class="flex-1 px-4 sm:px-6 pt-6 pb-28 overflow-y-auto lg:px-10 lg:pt-10 lg:pb-12"><div id="sections-wrapper" class="mx-auto w-full max-w-5xl lg:max-w-6xl xl:max-w-7xl"></div></main>
            </div>
        </div>

        <div id="fullscreen-view-container" class="fixed inset-0 z-40 pointer-events-none opacity-0 transition-opacity duration-300 bg-gray-950/95"></div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden"><div id="custom-modal-panel" class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm shadow-xl border border-gray-700 modal-fade-in"><h3 id="custom-modal-title" class="text-xl font-bold"></h3><div id="custom-modal-body" class="text-gray-300 mt-4 max-h-[70vh] overflow-y-auto"></div><div id="custom-modal-footer" class="mt-6 flex justify-end space-x-3"></div></div></div>
    <div id="toast-container" class="fixed bottom-24 right-0 left-0 max-w-lg mx-auto p-4 z-50 pointer-events-none lg:bottom-auto lg:top-6 lg:right-8 lg:left-auto lg:max-w-sm"></div>
    <div id="live-workout-overlay" class="fixed inset-0 z-40 hidden flex-col overflow-y-auto bg-gray-950/95 transition-opacity duration-300 touch-pan-y"></div>
    <div id="image-viewer-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4 cursor-pointer" onclick="this.classList.add('hidden')">
        <div id="image-viewer-content" class="max-w-3xl max-h-[90vh] relative cursor-default" onclick="event.stopPropagation()">
            </div>
    </div>

    <template id="template-inicio"><section id="inicio" class="section-content"><div class="space-y-6"><div><h2 id="welcome-message" class="text-2xl font-bold">Hola, </h2><p class="text-gray-400">¬øListo para superar tus l√≠mites hoy?</p></div><div id="ai-daily-tip-card" class="bg-gray-700/80 p-4 rounded-2xl hidden"><div class="flex items-start space-x-3"><i data-lucide="sparkles" class="text-purple-400 w-5 h-5 flex-shrink-0 mt-1"></i><div><h3 class="font-semibold text-gray-200">Consejo del D√≠a ‚ú®</h3><p id="ai-daily-tip-text" class="text-sm text-gray-300 mt-1">Cargando consejo...</p></div></div></div><div id="weekly-progress-card" class="bg-gray-700/80 p-4 rounded-2xl"></div><div class="bg-gradient-to-br from-emerald-500 to-green-600 p-6 rounded-2xl shadow-lg text-white"><p class="font-medium">Tu Meta Diaria de Calor√≠as</p><p class="text-3xl font-bold" id="dashboard-calories">2,500 kcal</p><div class="mt-4 h-2.5 w-full rounded-full bg-black/20"><div id="dashboard-progress-bar" class="bg-white h-2.5 rounded-full" style="width: 0%"></div></div><p class="text-right text-sm mt-1">Progreso: <span id="dashboard-progress-text">0</span>%</p></div><div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4"><button data-action="show-section" data-section-id="rutinas" class="bg-gray-700/80 p-4 rounded-2xl flex flex-col items-center justify-center space-y-2 hover:bg-gray-700 transition"><i data-lucide="clipboard-list" class="text-emerald-400 p-e-none"></i><span class="font-semibold p-e-none">Rutinas</span></button><button data-action="show-section" data-section-id="perfil" class="bg-gray-700/80 p-4 rounded-2xl flex flex-col items-center justify-center space-y-2 hover:bg-gray-700 transition"><i data-lucide="user" class="text-emerald-400 p-e-none"></i><span class="font-semibold p-e-none">Mi Perfil</span></button><button data-action="show-section" data-section-id="dieta" class="bg-gray-700/80 p-4 rounded-2xl flex flex-col items-center justify-center space-y-2 hover:bg-gray-700 transition"><i data-lucide="salad" class="text-emerald-400 p-e-none"></i><span class="font-semibold p-e-none">Mi Dieta</span></button><div class="bg-gray-700/80 p-4 rounded-2xl flex flex-col items-center justify-center space-y-2"><i data-lucide="flame" class="text-red-400"></i><span id="dashboard-consumed-calories" class="font-semibold">0 Kcal</span><span class="text-xs text-gray-400">Consumidas</span></div></div></div></section></template>
    
    <template id="template-rutinas"><section id="rutinas" class="section-content hidden"><div class="space-y-8"><div class="flex justify-between items-center"><h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="history" class="h-6 w-6 text-emerald-400"></i><span>Rutinas</span></h2><button id="create-routine-btn" data-action="routine-create" class="flex items-center gap-2 bg-emerald-500 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-emerald-400 transition shadow-lg shadow-emerald-500/20"><i data-lucide="plus" class="w-5 h-5"></i><span>Crear Rutina</span></button></div><div id="user-routines-section">
        <h3 class="font-semibold text-lg mb-3 text-gray-300">Mis Rutinas</h3>
        <div id="user-routines-container" class="horizontal-scroll-container flex overflow-x-auto gap-4 -mx-4 px-4 pb-4 lg:grid lg:grid-cols-2 xl:grid-cols-3 lg:gap-6 lg:overflow-visible lg:mx-0 lg:px-0"></div>
    </div><div id="predefined-routines-section"><h3 class="font-semibold text-lg mb-3 text-gray-300">Explorar Rutinas</h3><div id="predefined-routines-container" class="space-y-3"></div></div></div></section></template>
    
    <template id="template-asesorados">
        <section id="asesorados" class="section-content hidden">
            <div class="space-y-6">
                <div>
                    <h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="history" class="h-6 w-6 text-emerald-400"></i><span>Gesti√≥n de Asesorados</span></h2>
                    <p class="text-gray-400">Invita y gestiona los planes de tus clientes.</p>
                </div>
                
                <div class="bg-gray-700/50 p-4 rounded-2xl">
                    <h3 class="font-semibold text-lg mb-3">Invitar a un Nuevo Cliente</h3>
                    <form id="invite-form" class="flex flex-col gap-3 sm:flex-row">
                        <input type="email" id="invite-email" placeholder="email@cliente.com" required class="w-full bg-gray-700 rounded-lg p-2 focus:ring-2 focus:ring-emerald-500 focus:outline-none transition">
                        <button type="submit" class="bg-emerald-500 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-emerald-400 transition sm:w-auto">Invitar</button>
                    </form>
                </div>

                <div>
                    <h3 class="font-semibold text-lg mb-3">Mis Clientes</h3>
                    <div id="asesorados-list" class="space-y-3">
                        <p class="text-gray-500 text-center p-4">A√∫n no tienes clientes.</p>
                    </div>
                </div>
            </div>
        </section>
    </template>

    <template id="template-nutricion">
        <section id="nutricion" class="section-content hidden">
            <div class="space-y-6 pb-8">
                <div>
                    <h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="history" class="h-6 w-6 text-emerald-400"></i><span>Herramientas de C√°lculo</span></h2>
                    <p class="text-gray-400">Estima tus m√©tricas clave para optimizar tu progreso.</p>
                </div>
                
                <div class="bg-gray-700/50 p-1 rounded-xl flex space-x-1">
                    <button data-tab="nutricion" class="calc-tab-btn flex-1 p-2 rounded-lg font-semibold text-sm bg-emerald-500 text-gray-900">Nutrici√≥n</button>
                    <button data-tab="metricas" class="calc-tab-btn flex-1 p-2 rounded-lg font-semibold text-sm text-gray-300">M√©tricas</button>
                    <button data-tab="fuerza" class="calc-tab-btn flex-1 p-2 rounded-lg font-semibold text-sm text-gray-300">Fuerza</button>
                </div>

                <div id="calc-tabs-content">
                    <div id="tab-content-nutricion" class="calc-tab-content space-y-6">
                        <div class="bg-gray-700/50 p-4 rounded-2xl">
                            <h3 class="text-xl font-bold">Metas de Nutrici√≥n</h3>
                            <p class="text-sm text-gray-400 mb-4">Calcula tus calor√≠as y macros diarios seg√∫n tus objetivos.</p>
                            <form id="nutrition-form" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4"><label class="bg-gray-700 p-4 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:font-bold transition"><input type="radio" name="gender" value="male" class="sr-only" checked> Hombre</label><label class="bg-gray-700 p-4 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:font-bold transition"><input type="radio" name="gender" value="female" class="sr-only"> Mujer</label></div>
                                <div class="grid grid-cols-3 gap-4"><div><label for="age" class="block text-sm font-medium text-gray-300 mb-1">Edad</label><input type="number" id="age" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div><div><label for="weight" class="block text-sm font-medium text-gray-300 mb-1">Peso (kg)</label><input type="number" step="0.1" id="weight" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div><div><label for="height" class="block text-sm font-medium text-gray-300 mb-1">Altura (cm)</label><input type="number" id="height" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div></div>
                                <div><label for="activity" class="block text-sm font-medium text-gray-300 mb-1">Nivel de Actividad</label><select id="activity" class="w-full bg-gray-700 rounded-lg p-2"><option value="1.2">Sedentario</option><option value="1.375">Ligero</option><option value="1.55" selected>Moderado</option><option value="1.725">Activo</option><option value="1.9">Muy Activo</option></select></div>
                                <div class="grid grid-cols-3 gap-4"><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer text-sm has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:font-bold transition"><input type="radio" name="goal" value="lose" class="sr-only"> Perder</label><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer text-sm has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:font-bold transition"><input type="radio" name="goal" value="maintain" class="sr-only" checked> Mantener</label><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer text-sm has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 has-[:checked]:font-bold transition"><input type="radio" name="goal" value="gain" class="sr-only"> Ganar</label></div>
                                <button type="submit" class="w-full bg-emerald-500 text-gray-900 font-bold py-3 rounded-lg hover:bg-emerald-400 transition flex items-center justify-center gap-2"><i data-lucide="refresh-cw" class="w-4 h-4"></i>Calcular y Actualizar</button>
                            </form>
                        </div>
                        <div id="nutrition-results" class="space-y-6 hidden">
                            <div>
                                <h3 class="text-xl font-bold mb-3">Tus Resultados de Nutrici√≥n</h3>
                                <div class="bg-gray-700/80 p-5 rounded-xl"><p class="text-gray-400">Calor√≠as para tu objetivo</p><p id="result-calories" class="text-3xl font-bold text-emerald-400"></p></div>
                                <div class="grid grid-cols-3 gap-4 text-center mt-4"><div class="bg-blue-500/20 text-blue-300 p-3 rounded-xl"><p class="font-bold text-lg" id="result-protein"></p><p class="text-sm">Prote√≠na</p></div><div class="bg-yellow-500/20 text-yellow-300 p-3 rounded-xl"><p class="font-bold text-lg" id="result-carbs"></p><p class="text-sm">Carbs</p></div><div class="bg-red-500/20 text-red-300 p-3 rounded-xl"><p class="font-bold text-lg" id="result-fats"></p><p class="text-sm">Grasas</p></div></div>
                                <button data-action="save-goals" class="mt-4 w-full bg-gray-600 font-bold py-3 rounded-lg hover:bg-gray-500 transition">Guardar como mi meta</button>
                            </div>
                        </div>
                    </div>

                    <div id="tab-content-metricas" class="calc-tab-content hidden space-y-6">
                        <div class="bg-gray-700/50 p-4 rounded-2xl text-center">
                            <h3 class="text-xl font-bold">M√©tricas Corporales</h3>
                            <p class="text-sm text-gray-400 mb-4">Usa tus datos de perfil para obtener un an√°lisis corporal completo.</p>
                            <button data-action="calculate-body-metrics" class="w-full bg-sky-500 text-white font-bold py-3 rounded-lg hover:bg-sky-400 transition flex items-center justify-center gap-2"><i data-lucide="scan-line" class="w-5 h-5"></i>Calcular mis M√©tricas</button>
                        </div>
                        <div id="body-metrics-results" class="space-y-6">
                            <div class="bg-gray-700/80 p-4 rounded-2xl"><h3 class="font-semibold text-lg">√çndice de Masa Corporal (IMC)</h3><div class="flex items-baseline justify-center gap-2 my-3"><p id="bmi-value" class="text-4xl font-bold">--</p><p id="bmi-category" class="font-semibold text-gray-400">Sin calcular</p></div><div class="relative w-full h-6"><div class="absolute w-full h-2 top-1/2 -translate-y-1/2 flex rounded-full overflow-hidden"><div class="w-[25%] bg-sky-500" title="Bajo Peso (<18.5)"></div><div class="w-[30%] bg-emerald-500" title="Normal (18.5-24.9)"></div><div class="w-[25%] bg-yellow-500" title="Sobrepeso (25-29.9)"></div><div class="w-[20%] bg-red-500" title="Obesidad (>30)"></div></div><div id="bmi-marker" class="absolute top-1/2 w-5 h-5 -translate-x-1/2 -translate-y-1/2 bg-white rounded-full border-4 border-gray-800" style="left: 0%;"></div></div></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-700/80 p-4 rounded-2xl text-center"><h4 class="font-semibold text-gray-300">Grasa Corporal (Est.)</h4><p class="text-3xl font-bold text-sky-300 my-2"><span id="bodyfat-value">--</span>%</p><p class="text-xs text-gray-500">*Es una estimaci√≥n, no un valor m√©dico.</p></div>
                                <div class="bg-gray-700/80 p-4 rounded-2xl text-center"><h4 class="font-semibold text-gray-300">Peso Ideal (Rango)</h4><p class="text-3xl font-bold text-sky-300 my-2" id="ideal-weight-value">--</p><p class="text-xs text-gray-500">Basado en un IMC saludable.</p></div>
                            </div>
                            <div class="bg-gray-700/80 p-4 rounded-2xl text-center"><h4 class="font-semibold text-gray-300">Hidrataci√≥n Diaria Recom.</h4><p class="text-3xl font-bold text-sky-300 my-2"><span id="water-intake-value">--</span> L</p><p class="text-xs text-gray-500">Ajusta seg√∫n tu actividad y clima.</p></div>
                        </div>
                    </div>

                    <div id="tab-content-fuerza" class="calc-tab-content hidden space-y-6">
                        <div class="bg-gray-700/50 p-4 rounded-2xl">
                             <h3 class="text-xl font-bold">Calculadora de 1RM</h3>
                             <p class="text-sm text-gray-400 mb-4">Estima tu repetici√≥n m√°xima para cualquier ejercicio.</p>
                             <form id="1rm-form" class="space-y-4">
                                 <div class="grid grid-cols-2 gap-4">
                                     <div><label for="1rm-weight" class="block text-sm font-medium text-gray-300 mb-1">Peso Levantado (kg)</label><input type="number" step="0.5" id="1rm-weight" placeholder="70" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div>
                                     <div><label for="1rm-reps" class="block text-sm font-medium text-gray-300 mb-1">Repeticiones</label><input type="number" id="1rm-reps" placeholder="8" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div>
                                 </div>
                                 <button type="submit" class="w-full bg-purple-500 text-white font-bold py-3 rounded-lg hover:bg-purple-400 transition flex items-center justify-center gap-2"><i data-lucide="bar-chart-3" class="w-5 h-5"></i>Calcular 1RM</button>
                             </form>
                        </div>
                        <div id="1rm-results" class="hidden space-y-4">
                            <div class="bg-gray-700/80 p-5 rounded-xl text-center"><p class="text-gray-400">Tu 1RM Estimado es</p><p id="1rm-result-value" class="text-4xl font-bold text-purple-300"></p></div>
                            <div class="bg-gray-700/80 p-4 rounded-2xl">
                                <h4 class="font-semibold text-center mb-3">Pesos Proyectados</h4>
                                <div class="grid grid-cols-3 gap-3 text-center text-sm" id="1rm-projections"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </template>
    
    <template id="template-dieta"><section id="dieta" class="section-content hidden"><div class="space-y-6"><div><h2 class="text-2xl font-bold flex items-center gap-2"><i data-lucide="history" class="h-6 w-6 text-emerald-400"></i><span>Plan de Dieta de Hoy</span></h2><p class="text-gray-400">Objetivo: <span id="diet-goal-calories" class="font-bold text-emerald-400">2500</span> kcal</p></div><div class="bg-gray-700/80 p-4 rounded-xl space-y-3"><div class="flex justify-between items-center text-sm"><span class="text-gray-300">Consumido</span><span class="font-bold"><span id="diet-total-calories">0</span> kcal</span></div><div class="h-2.5 w-full rounded-full bg-gray-600"><div id="diet-progress-bar" class="bg-emerald-500 h-2.5 rounded-full w-0"></div></div><div class="grid grid-cols-3 gap-2 text-center text-xs"><div class="space-y-1"><p class="font-semibold text-blue-300">Prote√≠na</p><div class="h-1.5 w-full rounded-full bg-blue-500/20"><div id="diet-protein-bar" class="bg-blue-400 h-1.5 rounded-full w-0"></div></div><p><span id="diet-total-protein">0</span>g / <span id="diet-goal-protein">188</span>g</p></div><div class="space-y-1"><p class="font-semibold text-yellow-300">Carbs</p><div class="h-1.5 w-full rounded-full bg-yellow-500/20"><div id="diet-carbs-bar" class="bg-yellow-400 h-1.5 rounded-full w-0"></div></div><p><span id="diet-total-carbs">0</span>g / <span id="diet-goal-carbs">250</span>g</p></div><div class="space-y-1"><p class="font-semibold text-red-300">Grasas</p><div class="h-1.5 w-full rounded-full bg-red-500/20"><div id="diet-fats-bar" class="bg-red-400 h-1.5 rounded-full w-0"></div></div><p><span id="diet-total-fats">0</span>g / <span id="diet-goal-fats">83</span>g</p></div></div></div><div id="diet-management-tools"><div class="my-4"><button data-action="generate-plan" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 font-bold py-3 rounded-lg hover:opacity-90 transition flex items-center justify-center space-x-2 shadow-lg"><i data-lucide="sparkles" class="w-5 h-5 p-e-none"></i><span class="p-e-none">‚ú® Generar Plan con IA</span></button></div><div class="bg-gray-700/50 p-4 rounded-xl space-y-3 mb-6"><h3 class="font-semibold flex items-center gap-2"><i data-lucide="brain-circuit" class="w-5 h-5 text-sky-400"></i>Analizador de Comidas IA</h3><p class="text-sm text-gray-400">Describe una comida y la IA estimar√° sus macros para a√±adirla a tu dieta.</p><textarea id="food-analysis-input" placeholder="Ej: un taz√≥n de avena con pl√°tano y nueces" class="w-full bg-gray-700 rounded-lg p-2 h-16 resize-none"></textarea><button data-action="analyze-food" class="w-full bg-gradient-to-r from-sky-500 to-cyan-600 font-bold py-2 rounded-lg hover:opacity-90 transition flex items-center justify-center space-x-2"><span class="p-e-none">‚ú® Analizar y A√±adir</span></button></div></div><div id="meal-sections" class="space-y-4"></div><div id="add-food-section" class="space-y-4 mt-4"><h3 class="text-xl font-bold">A√±adir Alimentos</h3><div class="relative"><input type="text" id="food-search" placeholder="Busca un alimento..." class="w-full bg-gray-700 rounded-lg p-3 pl-10"><div class="absolute inset-y-0 left-0 flex items-center pl-3 p-e-none"><i data-lucide="search" class="text-gray-400"></i></div></div><div id="food-list" class="space-y-2 pr-2"></div></div></div></section></template>
    <template id="template-historial"><section id="historial" class="section-content hidden"><div class="space-y-6"><div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between"><div><h2 class="text-2xl font-bold flex items-center gap-3"><span class="inline-flex h-10 w-10 items-center justify-center rounded-2xl bg-emerald-500/15 text-emerald-300 shadow-inner shadow-emerald-500/20"><i data-lucide="history" class="h-6 w-6"></i></span><span>Historial de Progreso</span></h2><p class="text-sm text-gray-400">Visualiza la evoluci√≥n de tus entrenamientos, tiempos y cargas.</p></div><button data-action="show-workout-history" class="inline-flex items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-emerald-400/60 hover:bg-emerald-400/10"><i data-lucide="gallery-vertical-end" class="h-4 w-4"></i>Ver resumen detallado</button></div><div id="history-overview" class="grid gap-3 md:grid-cols-2 xl:grid-cols-4"></div><div id="history-cards" class="space-y-4"></div></div></section></template>
    
    <template id="template-perfil">
        <section id="perfil" class="section-content hidden">
            <div class="space-y-6 pb-8">
                <div class="flex items-center space-x-4">
                    <div id="profile-avatar" class="w-16 h-16 rounded-full bg-emerald-500 flex items-center justify-center font-bold text-gray-900 text-3xl flex-shrink-0">
                        <span></span>
                    </div>
                    <div>
                        <h2 id="profile-name" class="text-2xl font-bold"></h2>
                        <p id="profile-email" class="text-sm text-gray-400"></p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-gray-700/80 p-3 rounded-xl">
                        <p id="profile-stat-workouts" class="text-xl font-bold">0</p>
                        <p class="text-xs text-gray-400">Entrenos</p>
                    </div>
                    <div class="bg-gray-700/80 p-3 rounded-xl">
                        <p id="profile-stat-hours" class="text-xl font-bold">0</p>
                        <p class="text-xs text-gray-400">Horas</p>
                    </div>
                    <div class="bg-gray-700/80 p-3 rounded-xl">
                        <p id="profile-stat-streak" class="text-xl font-bold">0</p>
                        <p class="text-xs text-gray-400">Racha üî•</p>
                    </div>
                </div>

                <div class="bg-gray-700/80 p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-lg">Informaci√≥n Personal</h3>
                        <button data-action="edit-profile" class="flex items-center gap-1.5 text-sm text-emerald-400 font-semibold hover:text-emerald-300">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                            <span>Editar</span>
                        </button>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-400">Edad</span><span id="profile-info-age" class="font-medium"></span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Peso</span><span id="profile-info-weight" class="font-medium"></span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Altura</span><span id="profile-info-height" class="font-medium"></span></div>
                    </div>
                </div>
                
                <div class="bg-gray-700/80 p-4 rounded-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg">Seguimiento de Peso</h3>
                        <button data-action="edit-target-weight" class="flex items-center gap-1.5 text-sm text-emerald-400 font-semibold hover:text-emerald-300"><i data-lucide="edit-3" class="w-4 h-4"></i><span>Editar Objetivo</span></button>
                    </div>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div><p class="text-xl font-bold"><span id="current-weight-display"></span> <span class="text-sm font-normal text-gray-400">kg</span></p><p class="text-xs text-gray-400">Actual</p></div>
                        <div><p class="text-xl font-bold text-emerald-400"><span id="target-weight-display"></span> <span class="text-sm font-normal text-gray-400">kg</span></p><p class="text-xs text-gray-400">Objetivo</p></div>
                        <div><p class="text-xl font-bold"><span id="weight-diff-display"></span> <span class="text-sm font-normal text-gray-400">kg</span></p><p class="text-xs text-gray-400">Diferencia</p></div>
                    </div>
                     <form id="weight-log-form" class="flex gap-3 mt-4">
                         <input type="number" step="0.1" id="new-weight-input" placeholder="A√±adir peso de hoy (kg)" class="w-full bg-gray-700 rounded-lg p-2 text-center" required>
                         <button type="submit" data-action="add-weight-log" class="bg-emerald-500 text-gray-900 font-bold py-2 px-4 rounded-lg hover:bg-emerald-400 transition">A√±adir</button>
                     </form>
                </div>

                <div class="bg-gray-700/80 p-4 rounded-2xl">
                    <h3 class="font-semibold text-lg mb-4">Actividad Reciente (√öltimas 4 Semanas)</h3>
                    <div id="profile-activity-chart" class="h-32 flex items-end justify-around gap-2 text-center">
                    </div>
                </div>

                <div class="space-y-3">
                    <h3 class="font-semibold text-lg">Historial de Entrenamientos</h3>
                    <div id="profile-workout-history" class="space-y-2">
                    </div>
                </div>
            </div>
        </section>
    </template>
    
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            query,
            where,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyASVFAJx1vUN62V3t7VycuTKAehWW8byoM",
            authDomain: "seb-fit-460c4.firebaseapp.com",
            projectId: "seb-fit-460c4",
            storageBucket: "seb-fit-460c4.firebasestorage.app",
            messagingSenderId: "906669175939",
            appId: "1:906669175939:web:8fd09b745292c14eb6d7b6"
        };

        // Inicializar Firebase
        const firebaseApp = initializeApp(firebaseConfig);
        
        const bootstrapApp = () => {
            if (window.app) {
                return;
            }

            const app = {
                // IMPORTANTE: Reemplaza "" con tu propia clave de API de Google AI Studio.
                apiKey: "", // Tu clave de API de Google AI Studio aqu√≠
                adminUID: "oyVFC1vKcLhTLJJsjMQDPRL1z2K2",
                firebaseApp: firebaseApp,
                auth: null,
                db: null,
                storage: null, 
                
                isAsesor() {
                    return this.state && this.state.role === 'asesor';
                },

                getDefaultState() {
                    const now = new Date();
                    return {
                        currentUser: null,
                        userName: '',
                        role: 'asesor', 
                        coachId: null,
                        currentSection: 'inicio', 
                        userGoals: { calories: 2500, protein: 188, carbs: 250, fats: 83 },
                        dailyDiet: [
                            { id: `meal-${now.getTime()}`, name: 'Desayuno', time: '08:00', items: [] },
                            { id: `meal-${now.getTime() + 1}`, name: 'Almuerzo', time: '13:00', items: [] },
                            { id: `meal-${now.getTime() + 2}`, name: 'Cena', time: '20:00', items: [] }
                        ], 
                        userRoutines: [], 
                        workoutHistory: {}, 
                        dietLog: {},
                        physicalStats: { age: 25, weight: 75, height: 180, gender: 'male', activity: 1.55 },
                        targetWeight: 75,
                        weightLog: [],
                        asesorados: [],
                        activeWorkout: null,
                        timer: { status: 'idle', timeLeft: 0, intervalId: null, initialRestTime: 0 },
                        isMobileMenuOpen: false
                    };
                },
                
                state: null,
                _tempClientData: null, // Estado temporal para el editor de dieta del cliente
                
                data: { 
                    predefinedRoutines: {
                        "Cl√°sicos de Hipertrofia": [
                            { id: 'pre-ppl', name: 'Empuje/Tire/Pierna (PPL)', description: 'Divisi√≥n cl√°sica y efectiva para ganar m√∫sculo y fuerza.', icon: 'git-merge', plan: [ { day: 'D√≠a 1: Empuje (Pecho, Hombro, Tr√≠ceps)', exercises: [{name:'Press de Banca Plano con Barra',sets:4,reps:'8-12', rest:'60s'},{name:'Press Inclinado con Mancuernas',sets:3,reps:'10-12', rest:'60s'},{name:'Elevaciones Laterales con Mancuernas',sets:4,reps:'12-15', rest:'45s'},{name:'Extensiones de Tr√≠ceps en Polea',sets:3,reps:'12-15', rest:'45s'}] }, { day: 'D√≠a 2: Tire (Espalda, B√≠ceps)', exercises: [{name:'Dominadas (Agarre Ancho)',sets:4,reps:'Al fallo', rest:'90s'},{name:'Remo con Barra',sets:4,reps:'8-10', rest:'75s'},{name:'Face Pulls',sets:3,reps:'15-20', rest:'45s'},{name:'Curl con Barra Z',sets:4,reps:'10-12', rest:'60s'}] }, { day: 'D√≠a 3: Pierna', exercises: [{name:'Sentadilla con Barra',sets:4,reps:'8-10', rest:'90s'},{name:'Peso Muerto Rumano con Mancuernas',sets:3,reps:'10-12', rest:'75s'},{name:'Curl Femoral Tumbado',sets:3,reps:'12-15', rest:'60s'},{name:'Elevaci√≥n de Talones de Pie',sets:4,reps:'15-20', rest:'45s'}] } ] },
                            { id: 'pre-arnold', name: 'Arnold Split', description: 'Alta frecuencia y volumen para desarrollo muscular m√°ximo.', icon: 'user-check', plan: [ { day: 'D√≠a 1: Pecho y Espalda', exercises: [{name:'Press de Banca Plano con Barra',sets:4,reps:'8-12',rest:'75s'},{name:'Dominadas (Agarre Ancho)',sets:4,reps:'Al fallo',rest:'75s'},{name:'Press Inclinado con Mancuernas',sets:3,reps:'10-12',rest:'60s'},{name:'Remo con Barra',sets:3,reps:'8-12',rest:'60s'}] }, { day: 'D√≠a 2: Hombros y Brazos', exercises: [{name:'Press Militar con Barra',sets:4,reps:'8-12',rest:'75s'},{name:'Elevaciones Laterales con Mancuernas',sets:4,reps:'12-15',rest:'45s'},{name:'Curl con Barra Z',sets:3,reps:'10-12',rest:'60s'},{name:'Press Franc√©s',sets:3,reps:'10-12',rest:'60s'}] }, { day: 'D√≠a 3: Piernas y Abdomen', exercises: [{name:'Sentadilla con Barra',sets:5,reps:'8-10',rest:'90s'},{name:'Peso Muerto Rumano con Barra/Mancuernas',sets:4,reps:'10-12',rest:'75s'},{name:'Elevaci√≥n de Talones de Pie',sets:4,reps:'15-20',rest:'45s'},{name:'Crunches',sets:3,reps:'Al fallo',rest:'45s'}] } ] }
                        ],
                        "Fuerza y Potencia": [
                            { id: 'pre-upper-lower', name: 'Torso/Pierna (Upper/Lower)', description: 'Balance perfecto entre fuerza y tama√±o, 4 d√≠as/semana.', icon: 'move-vertical', plan: [ { day: 'D√≠a 1: Torso Fuerza', exercises: [{name:'Press de Banca Plano con Barra',sets:4,reps:'5-8',rest:'90s'},{name:'Remo con Barra',sets:4,reps:'5-8',rest:'90s'},{name:'Press Militar con Barra',sets:3,reps:'6-10',rest:'75s'},{name:'Dominadas (Agarre Ancho)',sets:3,reps:'Al fallo',rest:'75s'}] }, { day: 'D√≠a 2: Pierna Fuerza', exercises: [{name:'Sentadilla con Barra',sets:4,reps:'5-8',rest:'120s'},{name:'Peso Muerto Rumano con Barra/Mancuernas',sets:3,reps:'8-10',rest:'90s'},{name:'Prensa de Piernas',sets:3,reps:'8-12',rest:'75s'},{name:'Elevaci√≥n de Talones de Pie',sets:4,reps:'10-15',rest:'60s'}] }, { day: 'D√≠a 3: Torso Hipertrofia', exercises: [{name:'Press Inclinado con Mancuernas',sets:4,reps:'10-12',rest:'60s'},{name:'Jal√≥n al Pecho (Agarre Ancho)',sets:4,reps:'10-12',rest:'60s'},{name:'Elevaciones Laterales con Mancuernas',sets:4,reps:'12-15',rest:'45s'},{name:'Curl con Mancuernas',sets:3,reps:'12-15',rest:'45s'},{name:'Extensiones de Tr√≠ceps en Polea',sets:3,reps:'12-15',rest:'45s'}] }, { day: 'D√≠a 4: Pierna Hipertrofia', exercises: [{name:'Sentadilla Frontal',sets:4,reps:'10-12',rest:'75s'},{name:'Curl Femoral Tumbado',sets:4,reps:'12-15',rest:'60s'},{name:'Zancadas',sets:3,reps:'12-15',rest:'60s'},{name:'Elevaci√≥n de Piernas Colgado/Tumbado',sets:4,reps:'Al fallo',rest:'45s'}] } ] }
                        ],
                        "Enfoque Femenino": [
                            { id: 'pre-glute-focus', name: 'Glute Gains', description: 'Rutina enfocada en el desarrollo de gl√∫teos y piernas.', icon: 'person-standing', plan: [ { day: 'D√≠a 1: Pierna (√ânfasis Gl√∫teo)', exercises: [{name:'Hip Thrust con Barra',sets:4,reps:'8-12',rest:'75s'},{name:'Sentadilla B√∫lgara',sets:3,reps:'10-12',rest:'60s'},{name:'Peso Muerto Rumano con Mancuernas',sets:3,reps:'12-15',rest:'60s'},{name:'Patada de Gl√∫teo en Polea',sets:3,reps:'15-20',rest:'45s'}] }, { day: 'D√≠a 2: Torso y Core', exercises: [{name:'Jal√≥n al Pecho (Agarre Ancho)',sets:4,reps:'10-15',rest:'60s'},{name:'Press Inclinado con Mancuernas',sets:3,reps:'12-15',rest:'60s'},{name:'Remo con Mancuerna (Serrucho)',sets:3,reps:'12-15',rest:'45s'},{name:'Elevaciones Laterales con Mancuernas',sets:4,reps:'15-20',rest:'45s'},{name:'Plancha Abdominal',sets:3,reps:'Al fallo',rest:'45s'}] }, { day: 'D√≠a 3: Full Body', exercises: [{name:'Sentadilla con Barra',sets:4,reps:'10-12',rest:'75s'},{name:'Press de Banca Plano con Mancuernas',sets:4,reps:'10-12',rest:'60s'},{name:'Remo con Barra',sets:4,reps:'10-12',rest:'60s'},{name:'Hiperextensiones',sets:3,reps:'15-20',rest:'45s'}] } ] },
                            { id: 'pre-fullbody-tone', name: 'Full Body Toning', description: '3 d√≠as a la semana para tonificar todo el cuerpo.', icon: 'heart-pulse', plan: [ { day: 'D√≠a A', exercises: [{name:'Sentadilla con Barra',sets:3,reps:'12-15',rest:'60s'},{name:'Press de Banca Plano con Barra',sets:3,reps:'12-15',rest:'60s'},{name:'Remo con Barra',sets:3,reps:'12-15',rest:'60s'},{name:'Elevaciones Laterales con Mancuernas',sets:3,reps:'15-20',rest:'45s'}] }, { day: 'D√≠a B', exercises: [{name:'Peso Muerto Convencional/Sumo',sets:3,reps:'10-12',rest:'90s'},{name:'Press Militar con Barra',sets:3,reps:'12-15',rest:'60s'},{name:'Jal√≥n al Pecho (Agarre Ancho)',sets:3,reps:'12-15',rest:'60s'},{name:'Elevaci√≥n de Piernas Colgado/Tumbado',sets:3,reps:'al fallo',rest:'45s'}] } ] }
                        ],
                        "Alta Intensidad": [
                            { id: 'pre-mentzer', name: 'Mentzer Heavy Duty', description: 'M√°xima intensidad, m√≠nimo volumen. Para avanzados.', icon: 'zap', plan: [ { day: 'D√≠a 1: Pecho y Espalda', exercises: [{name:'Pec Deck (Contractora)',sets:1,reps:'8-12 (al fallo)',rest:'10s'},{name:'Press Inclinado con Mancuernas',sets:1,reps:'6-8 (al fallo)',rest:'120s'},{name:'Pullover en Polea Alta',sets:1,reps:'8-12 (al fallo)',rest:'10s'},{name:'Jal√≥n al Pecho (Agarre Ancho)',sets:1,reps:'6-8 (al fallo)',rest:'120s'}] }, { day: 'D√≠a 2: Piernas', exercises: [{name:'Extensiones de Cu√°driceps',sets:1,reps:'10-15 (al fallo)',rest:'10s'},{name:'Prensa de Piernas',sets:1,reps:'8-12 (al fallo)',rest:'120s'},{name:'Curl Femoral Tumbado',sets:1,reps:'8-12 (al fallo)',rest:'90s'},{name:'Elevaci√≥n de Talones de Pie',sets:1,reps:'12-15 (al fallo)',rest:'60s'}] }, { day: 'D√≠a 3: Hombros y Brazos', exercises: [{name:'Elevaciones Laterales con Mancuernas',sets:1,reps:'8-12 (al fallo)',rest:'10s'},{name:'Press Militar con Barra',sets:1,reps:'6-8 (al fallo)',rest:'120s'},{name:'Curl con Barra Z',sets:1,reps:'6-8 (al fallo)',rest:'90s'},{name:'Extensiones de Tr√≠ceps en Polea',sets:1,reps:'8-10 (al fallo)',rest:'60s'}] } ] }
                        ],
                        "Quema de Grasa": [
                            { id: 'pre-fbb', name: 'Full Body Burn', description: 'Cardio y fuerza para quemar calor√≠as y definir.', icon: 'flame', plan: [ { day: 'D√≠a A', exercises: [{name:'Sentadilla con Barra',sets:3,reps:'15', rest:'45s'},{name:'Fondos en Paralelas',sets:3,reps:'Al fallo', rest:'60s'},{name:'Remo con Mancuerna (Serrucho)',sets:3,reps:'15', rest:'45s'},{name:'Plancha Abdominal',sets:3,reps:'60s', rest:'45s'}] }, { day: 'D√≠a B', exercises: [{name:'Zancadas',sets:3,reps:'15', rest:'45s'},{name:'Jal√≥n al Pecho (Agarre Ancho)',sets:3,reps:'15', rest:'45s'},{name:'Press de Banca Plano con Barra',sets:3,reps:'15', rest:'45s'},{name:'Elevaci√≥n de Piernas Colgado/Tumbado',sets:3,reps:'20', rest:'45s'}] } ] }
                        ]
                    },
                    exerciseLibrary: {
                        "Pecho":{
                            "Superior":[
                                {name:"Press Inclinado con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/1/17441.gif"},
                                {name:"Press Inclinado con Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/3/5/10235.gif"},
                                {name:"Cruce de Poleas (Bajo a Alto)", mediaUrl: null},
                                {name:"Aperturas Inclinadas", mediaUrl: null}
                            ],
                            "Medio":[
                                {name:"Press de Banca Plano con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/3/8/17438.gif"},
                                {name:"Press de Banca Plano con Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/2/8/10228.gif"},
                                {name:"Aperturas Planas con Mancuernas", mediaUrl: null},
                                {name:"Pec Deck (Contractora)", mediaUrl: "https://gymvisual.com/img/p/1/7/3/2/5/17325.gif"},
                                {name:"Press en M√°quina", mediaUrl: null}
                            ],
                            "Inferior":[
                                {name:"Press Declinado con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/3/9/17439.gif"},
                                {name:"Fondos en Paralelas", mediaUrl: "https://gymvisual.com/img/p/1/7/3/0/1/17301.gif"},
                                {name:"Cruce de Poleas (Alto a Bajo)", mediaUrl: null}
                            ]
                        },
                        "Espalda":{
                            "Dorsales (Amplitud)":[
                                {name:"Dominadas (Agarre Ancho)", mediaUrl: "https://gymvisual.com/img/p/1/7/2/8/8/17288.gif"},
                                {name:"Jal√≥n al Pecho (Agarre Ancho)", mediaUrl: "https://gymvisual.com/img/p/1/7/3/4/0/17340.gif"},
                                {name:"Remo Gironda (Agarre Estrecho)", mediaUrl: null},
                                {name:"Pullover en Polea Alta", mediaUrl: null}
                            ],
                            "Espalda Media (Densidad)":[
                                {name:"Remo con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/5/17445.gif"},
                                {name:"Remo con Mancuerna (Serrucho)", mediaUrl: "https://gymvisual.com/img/p/1/0/2/5/0/10250.gif"},
                                {name:"Remo en Punta (T-Bar)", mediaUrl: null},
                                {name:"Face Pulls", mediaUrl: null}
                            ],
                            "Lumbares":[
                                {name:"Peso Muerto Convencional/Sumo", mediaUrl: "https://gymvisual.com/img/p/1/7/4/5/2/17452.gif"},
                                {name:"Hiperextensiones", mediaUrl: "https://gymvisual.com/img/p/1/7/3/1/5/17315.gif"},
                                {name:"Good Mornings", mediaUrl: null}
                            ]
                        },
                        "Pierna":{
                            "Cu√°driceps":[
                                {name:"Sentadilla con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/9/17449.gif"},
                                {name:"Sentadilla Frontal", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/2/17442.gif"},
                                {name:"Prensa de Piernas", mediaUrl: "https://gymvisual.com/img/p/1/7/3/5/6/17356.gif"},
                                {name:"Zancadas", mediaUrl: "https://gymvisual.com/img/p/1/0/3/1/6/10316.gif"},
                                {name:"Sentadilla B√∫lgara", mediaUrl: "https://gymvisual.com/img/p/1/0/2/0/9/10209.gif"},
                                {name:"Extensiones de Cu√°driceps", mediaUrl: "https://gymvisual.com/img/p/1/7/3/5/4/17354.gif"}
                            ],
                            "Femorales":[
                                {name:"Peso Muerto Rumano con Barra/Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/6/2/10262.gif"},
                                {name:"Curl Femoral Tumbado", mediaUrl: "https://gymvisual.com/img/p/1/7/3/5/5/17355.gif"},
                                {name:"Curl Femoral Sentado", mediaUrl: null}
                            ],
                            "Gl√∫teos":[
                                {name:"Hip Thrust con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/3/17443.gif"},
                                {name:"Peso Muerto Sumo", mediaUrl: null},
                                {name:"Patada de Gl√∫teo en Polea", mediaUrl: null},
                                {name:"Abducci√≥n de Cadera en M√°quina/Polea", mediaUrl: null}
                            ],
                            "Gemelos":[
                                {name:"Elevaci√≥n de Talones de Pie", mediaUrl: "https://gymvisual.com/img/p/1/7/2/9/3/17293.gif"},
                                {name:"Elevaci√≥n de Talones Sentado (S√≥leo)", mediaUrl: null}
                            ]
                        },
                        "Hombro":{
                            "Deltoides Anterior":[
                                {name:"Press Militar con Barra", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/7/17447.gif"},
                                {name:"Press Arnold", mediaUrl: null},
                                {name:"Elevaciones Frontales con Mancuerna/Polea", mediaUrl: null}
                            ],
                            "Deltoides Lateral":[
                                {name:"Elevaciones Laterales con Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/4/3/10243.gif"},
                                {name:"Elevaciones Laterales en Polea", mediaUrl: null},
                                {name:"Remo al Ment√≥n (Agarre Ancho)", mediaUrl: null}
                            ],
                            "Deltoides Posterior":[
                                {name:"P√°jaros (Bent Over Raises)", mediaUrl: "https://gymvisual.com/img/p/1/0/2/1/4/10214.gif"},
                                {name:"Pec Deck Inverso", mediaUrl: null}
                            ]
                        },
                        "Brazo":{
                            "B√≠ceps":[
                                {name:"Curl con Barra Z", mediaUrl: "https://gymvisual.com/img/p/1/0/2/0/1/10201.gif"},
                                {name:"Curl con Mancuernas", mediaUrl: "https://gymvisual.com/img/p/1/0/2/2/5/10225.gif"},
                                {name:"Curl Martillo", mediaUrl: "https://gymvisual.com/img/p/1/0/2/4/0/10240.gif"},
                                {name:"Curl de Concentraci√≥n", mediaUrl: null},
                                {name:"Curl en Banco Scott", mediaUrl: null}
                            ],
                            "Tr√≠ceps":[
                                {name:"Press Franc√©s", mediaUrl: "https://gymvisual.com/img/p/1/7/4/4/6/17446.gif"},
                                {name:"Extensiones de Tr√≠ceps en Polea", mediaUrl: "https://gymvisual.com/img/p/1/7/3/3/0/17330.gif"},
                                {name:"Press de Banca (Agarre Estrecho)", mediaUrl: null},
                                {name:"Fondos entre Bancos", mediaUrl: null}
                            ],
                            "Antebrazo":[
                                {name:"Curl de Mu√±eca (Supino/Prono)", mediaUrl: null},
                                {name:"Paseo del Granjero", mediaUrl: null}
                            ]
                        },
                        "Abdomen":{
                            "Recto Abdominal":[
                                {name:"Crunches", mediaUrl: "https://gymvisual.com/img/p/1/7/2/9/9/17299.gif"},
                                {name:"Elevaci√≥n de Piernas Colgado/Tumbado", mediaUrl: "https://gymvisual.com/img/p/1/7/3/1/4/17314.gif"}
                            ],
                            "Oblicuos":[
                                {name:"Russian Twists", mediaUrl: null},
                                {name:"Le√±ador en Polea (Woodchoppers)", mediaUrl: null}
                            ],
                            "Core General":[
                                {name:"Plancha Abdominal", mediaUrl: "https://gymvisual.com/img/p/1/7/3/6/5/17365.gif"},
                                {name:"Rueda Abdominal (Ab Wheel)", mediaUrl: null}
                            ]
                        }
                    },
                exerciseGroupImages: {
                    "Pecho": "https://images.unsplash.com/photo-1517832207067-4db24a2ae47c?auto=format&fit=crop&w=800&q=80",
                    "Espalda": "https://images.unsplash.com/photo-1517430816045-df4b7de1cd0d?auto=format&fit=crop&w=800&q=80",
                    "Pierna": "https://images.unsplash.com/photo-1579758629938-03607ccdbaba?auto=format&fit=crop&w=800&q=80",
                    "Hombro": "https://images.unsplash.com/photo-1599058917212-d750089bc07c?auto=format&fit=crop&w=800&q=80",
                    "Brazo": "https://images.unsplash.com/photo-1526402462925-efba5de1c9f1?auto=format&fit=crop&w=800&q=80",
                    "Abdomen": "https://images.unsplash.com/photo-1506354666786-959d6d497f1a?auto=format&fit=crop&w=800&q=80"
                },
                foodDatabase: {"Prote√≠nas":[{"id":1,"name":"Pechuga de Pollo","cals":165,"p":31,"c":0,"f":3.6},{"id":2,"name":"Pechuga de Pavo","cals":135,"p":30,"c":0,"f":1},{"id":3,"name":"Salm√≥n","cals":208,"p":20,"c":0,"f":13},{"id":4,"name":"At√∫n en lata (agua)","cals":116,"p":26,"c":0,"f":1},{"id":5,"name":"Carne de Res Magra (90%)","cals":198,"p":28,"c":0,"f":9},{"id":6,"name":"Huevo Entero","cals":155,"p":13,"c":1.1,"f":11},{"id":7,"name":"Clara de Huevo","cals":52,"p":11,"c":0.7,"f":0.2},{"id":8,"name":"Lentejas (cocidas)","cals":116,"p":9,"c":20,"f":0.4},{"id":9,"name":"Garbanzos (cocidos)","cals":139,"p":7.6,"c":22,"f":3.8},{"id":10,"name":"Tofu Firme","cals":76,"p":8,"c":1.9,"f":4.8}],"Carbohidratos":[{"id":11,"name":"Arroz Blanco (cocido)","cals":130,"p":2.7,"c":28,"f":0.3},{"id":12,"name":"Arroz Integral (cocido)","cals":111,"p":2.6,"c":23,"f":0.9},{"id":13,"name":"Avena en Hojuelas","cals":389,"p":17,"c":66,"f":7},{"id":14,"name":"Papa/Patata (cocida)","cals":87,"p":2,"c":20,"f":0.1},{"id":15,"name":"Batata/Camote (cocido)","cals":86,"p":1.6,"c":20,"f":0.1},{"id":16,"name":"Pan Integral","cals":265,"p":13,"c":41,"f":4.5},{"id":17,"name":"Pasta Integral (cocida)","cals":124,"p":5,"c":26,"f":0.8},{"id":18,"name":"Quinoa (cocida)","cals":120,"p":4.4,"c":21,"f":1.9},{"id":19,"name":"Ma√≠z/Elote (cocido)","cals":96,"p":3.4,"c":21,"f":1.5}],"Grasas Saludables":[{"id":20,"name":"Aguacate","cals":160,"p":2,"c":9,"f":15},{"id":21,"name":"Aceite de Oliva Extra Virgen","cals":884,"p":0,"c":0,"f":100},{"id":22,"name":"Almendras","cals":579,"p":21,"c":22,"f":49},{"id":23,"name":"Nueces","cals":654,"p":15,"c":14,"f":65},{"id":24,"name":"Semillas de Ch√≠a","cals":486,"p":17,"c":42,"f":31},{"id":25,"name":"Mantequilla de Man√≠ Natural","cals":588,"p":25,"c":20,"f":50}],"Frutas y Verduras":[{"id":26,"name":"Br√≥coli","cals":55,"p":3.7,"c":11,"f":0.6},{"id":27,"name":"Espinaca","cals":23,"p":2.9,"c":3.6,"f":0.4},{"id":28,"name":"Pl√°tano","cals":89,"p":1.1,"c":23,"f":0.3},{"id":29,"name":"Manzana","cals":52,"p":0.3,"c":14,"f":0.2},{"id":30,"name":"Fresa","cals":32,"p":0.7,"c":8,"f":0.3},{"id":31,"name":"Tomate","cals":18,"p":0.9,"c":3.9,"f":0.2},{"id":32,"name":"Zanahoria","cals":41,"p":0.9,"c":10,"f":0.2}],"L√°cteos y Derivados":[{"id":33,"name":"Yogur Griego Natural (0%)","cals":59,"p":10,"c":3.6,"f":0.4},{"id":34,"name":"Leche Descremada","cals":34,"p":3.4,"c":5,"f":0.1},{"id":35,"name":"Queso Cottage (bajo en grasa)","cals":72,"p":12,"c":2.7,"f":1},{"id":36,"name":"Queso Mozzarella","cals":280,"p":22,"c":2.2,"f":20}],"Suplementos":[{"id":37,"name":"Prote√≠na Whey (Polvo)","cals":390,"p":75,"c":8,"f":5},{"id":38,"name":"Creatina Monohidratada","cals":0,"p":0,"c":0,"f":0}]},
                    foodLibrary: [], // Se llenar√° con la base de datos + alimentos personalizados
                },
                
                init() { 
                    if(typeof lucide === 'undefined'){ setTimeout(() => this.init(), 50); return; } 
                    this.state = this.getDefaultState();
                    this.auth = getAuth(this.firebaseApp);
                    this.db = getFirestore(this.firebaseApp);
                    this.storage = getStorage(this.firebaseApp);
                    this.setupAuthListeners();
                    this.setupEventListeners();
                    lucide.createIcons();
                },

                async initAppLogic() {
                    this.audioCtx = new(window.AudioContext || window.webkitAudioContext)();
                    await this.loadExerciseLibraryFromFirestore();
                    await this.loadExerciseGroupImagesFromFirestore();
                    await this.loadAndMergeFoodData(); // Cargar alimentos
                    this.loadTemplates();
                    this.populateNutritionForm();
                    this.adjustUIForRole();
                    this.renderAll(); 
                    this.getDailyTip();
                    this.showSection(this.state.currentSection, false);
                    this.updateUserInfoUI();
                },

                adjustUIForRole() {
                    const navAsesorados = document.getElementById('nav-asesorados');
                    const navNutricion = document.getElementById('nav-nutricion');
                    const createRoutineBtn = document.getElementById('create-routine-btn');
                    const predefinedRoutines = document.getElementById('predefined-routines-section');
                    const dietManagementTools = document.getElementById('diet-management-tools');
                    const addFoodSection = document.getElementById('add-food-section');

                    if (this.isAsesor()) {
                        navAsesorados.style.display = 'flex';
                        navNutricion.style.display = 'flex';
                        if (createRoutineBtn) createRoutineBtn.style.display = 'flex';
                        if (predefinedRoutines) predefinedRoutines.style.display = 'block';
                        if (dietManagementTools) dietManagementTools.style.display = 'block';
                        if (addFoodSection) addFoodSection.style.display = 'block';
                        const navRutinasText = document.querySelector('#nav-rutinas .nav-label');
                        if (navRutinasText) navRutinasText.textContent = 'Rutinas';

                    } else {
                        navAsesorados.style.display = 'none';
                        navNutricion.style.display = 'none';
                        if (createRoutineBtn) createRoutineBtn.style.display = 'none';
                        if (predefinedRoutines) predefinedRoutines.style.display = 'none';
                        if (dietManagementTools) dietManagementTools.style.display = 'none';
                        if (addFoodSection) addFoodSection.style.display = 'none';
                        const navRutinasText = document.querySelector('#nav-rutinas .nav-label');
                        if (navRutinasText) navRutinasText.textContent = 'Mi Rutina';
                    }
                },

                async saveDataToFirestore() {
                    if (!this.state.currentUser) return;
                    const dataToSave = { ...this.state };
                    ['currentUser', 'activeWorkout', 'timer', 'currentSection', 'asesorados', 'isMobileMenuOpen'].forEach(key => delete dataToSave[key]);
                    const userRef = doc(this.db, "users", this.state.currentUser.uid);
                    try {
                        await setDoc(userRef, dataToSave, { merge: true });
                    } catch (error) {
                        console.error("Error saving data to Firestore: ", error);
                        this.showToast("Error al guardar datos.", "error");
                    }
                },
                
                async loadDataFromFirestore() {
                    const userRef = doc(this.db, "users", this.state.currentUser.uid);
                    try {
                        const docSnap = await getDoc(userRef);
                        const defaultState = this.getDefaultState();
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            this.state = { ...defaultState, currentUser: this.state.currentUser, ...data };
                            this.state.physicalStats = { ...defaultState.physicalStats, ...data.physicalStats };
                            this.state.userGoals = { ...defaultState.userGoals, ...data.userGoals };
                            // Compatibilidad hacia atr√°s para la estructura de dieta
                            if (data.dailyDiet && !Array.isArray(data.dailyDiet)) {
                                this.state.dailyDiet = defaultState.dailyDiet;
                            }
                            if (data.workoutHistory) {
                                const normalizedHistory = {};
                                Object.entries(data.workoutHistory).forEach(([dateKey, value]) => {
                                    if (Array.isArray(value)) {
                                        const normalizedArray = value.map(entry => this._normalizeWorkoutEntry(entry, dateKey));
                                        normalizedHistory[dateKey] = normalizedArray.sort((a, b) => new Date(a.completedAt || 0) - new Date(b.completedAt || 0));
                                    } else if (value && typeof value === 'object') {
                                        normalizedHistory[dateKey] = [this._normalizeWorkoutEntry(value, dateKey)];
                                    }
                                });
                                this.state.workoutHistory = normalizedHistory;
                            }
                        } else {
                            this.state = defaultState;
                            this.state.currentUser = this.auth.currentUser;
                            this.state.userName = this.auth.currentUser.displayName || "Nuevo Usuario";
                            this.state.role = this.auth.currentUser.uid === this.adminUID ? 'asesor' : 'asesorado';
                            await this.saveDataToFirestore();
                        }
                    } catch (error) {
                        console.error("Error loading data from Firestore: ", error);
                        this.showToast("Error al cargar datos.", "error");
                    }
                },

                async loadAndMergeFoodData() {
                    const predefinedFoods = Object.values(this.data.foodDatabase).flat();
                    let customFoods = [];
                    if (this.isAsesor()) {
                        try {
                            const q = query(collection(this.db, "users", this.state.currentUser.uid, "customFoods"));
                            const querySnapshot = await getDocs(q);
                            customFoods = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        } catch (error) {
                            console.error("Error fetching custom foods:", error);
                        }
                    }
                    this.data.foodLibrary = [...predefinedFoods, ...customFoods];
                },

                async loadExerciseLibraryFromFirestore() {
                    const docRef = doc(this.db, "app_data", "exercise_library");
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            this.data.exerciseLibrary = docSnap.data();
                        } else {
                            console.log("No exercise library found in DB, seeding initial data...");
                            if (this.state.currentUser && this.state.currentUser.uid === this.adminUID) {
                                await setDoc(docRef, this.data.exerciseLibrary);
                            }
                        }
                    } catch (error) {
                        console.error("Error loading exercise library: ", error);
                        this.showToast("Error al cargar ejercicios.", "error");
                    }
                },

                async loadExerciseGroupImagesFromFirestore() {
                    const docRef = doc(this.db, "app_data", "exercise_group_images");
                    try {
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            this.data.exerciseGroupImages = {
                                ...this.data.exerciseGroupImages,
                                ...docSnap.data()
                            };
                        } else if (this.state.currentUser && this.state.currentUser.uid === this.adminUID) {
                            await setDoc(docRef, this.data.exerciseGroupImages);
                        }
                    } catch (error) {
                        console.error("Error loading exercise group images: ", error);
                    }
                },

                setupAuthListeners() {
                    onAuthStateChanged(this.auth, async (user) => {
                        if (user) {
                            this.state.currentUser = user;
                            await this.loadDataFromFirestore();
                            this.showAppUI();
                            await this.initAppLogic();
                        } else {
                            this.state = this.getDefaultState();
                            this.showAuthUI();
                        }
                    });

                    document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
                    document.getElementById('register-form').addEventListener('submit', (e) => this.handleRegister(e));
                    document.getElementById('logout-btn').addEventListener('click', () => this.handleLogout());
                    document.querySelectorAll('[data-action="toggle-auth"]').forEach(btn => {
                        btn.addEventListener('click', () => this.toggleAuthForms());
                    });
                },

                async handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; const button = e.target.querySelector('button[type="submit"]'); this.setButtonLoading(button, true); try { await signInWithEmailAndPassword(this.auth, email, password); } catch (error) { this.showToast(this.getFirebaseAuthErrorMessage(error), 'error'); } finally { this.setButtonLoading(button, false); } },
                
                async handleRegister(e) {
                    e.preventDefault();
                    const name = document.getElementById('register-name').value;
                    const email = document.getElementById('register-email').value.toLowerCase();
                    const password = document.getElementById('register-password').value;
                    const button = e.target.querySelector('button[type="submit"]');
                    this.setButtonLoading(button, true);

                    try {
                        const invitationsRef = collection(this.db, "invitations");
                        const q = query(invitationsRef, where("clientEmail", "==", email), where("status", "==", "pending"));
                        const querySnapshot = await getDocs(q);

                        let role = 'asesor';
                        let coachId = null;
                        let invitationDocId = null;

                        if (!querySnapshot.empty) {
                            const invitationDoc = querySnapshot.docs[0];
                            const invitationData = invitationDoc.data();
                            role = 'asesorado';
                            coachId = invitationData.coachId;
                            invitationDocId = invitationDoc.id;
                            this.showToast("¬°Bienvenido! Has aceptado una invitaci√≥n.", "success");
                        } else {
                            if (this.adminUID) {
                                this.showToast("Registro no autorizado sin invitaci√≥n.", "error");
                                throw new Error("Unauthorized registration");
                            }
                        }

                        const userCredential = await createUserWithEmailAndPassword(this.auth, email, password);
                        const user = userCredential.user;

                        const userRef = doc(this.db, "users", user.uid);
                        const initialData = this.getDefaultState();
                        initialData.userName = name;
                        initialData.role = role;
                        initialData.coachId = coachId;
                        initialData.targetWeight = initialData.physicalStats.weight;
                        delete initialData.currentUser;
                        delete initialData.asesorados;
                        await setDoc(userRef, initialData);

                        if (invitationDocId) {
                            const invitationRef = doc(this.db, "invitations", invitationDocId);
                            await updateDoc(invitationRef, { status: "accepted", acceptedAt: new Date(), clientId: user.uid });
                        }

                    } catch (error) {
                        this.showToast(this.getFirebaseAuthErrorMessage(error), 'error');
                        console.error("Registration error:", error);
                    } finally {
                        this.setButtonLoading(button, false);
                    }
                },

                async handleLogout() { try { await signOut(this.auth); } catch (error) { this.showToast('Error al cerrar sesi√≥n.', 'error'); } },
                showAppUI() { document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); },
                showAuthUI() { document.getElementById('app-container').classList.add('hidden'); document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('sections-wrapper').innerHTML = ''; },
                toggleAuthForms() { const loginContainer = document.getElementById('login-form-container'); const registerContainer = document.getElementById('register-form-container'); loginContainer.classList.toggle('form-visible'); loginContainer.classList.toggle('form-hidden'); registerContainer.classList.toggle('form-visible'); registerContainer.classList.toggle('form-hidden'); },
                setButtonLoading(button, isLoading) { if (isLoading) { button.disabled = true; button.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>`; lucide.createIcons(); } else { button.disabled = false; button.innerHTML = `<span>${button.closest('form').id === 'login-form' ? 'Iniciar Sesi√≥n' : 'Crear Cuenta'}</span>`; } },
                updateUserInfoUI() { const name = this.state.userName || 'Usuario'; document.getElementById('welcome-message').textContent = `Hola, ${name.split(' ')[0]}`; const avatar = document.getElementById('user-avatar').querySelector('span'); avatar.textContent = name.charAt(0).toUpperCase(); },
                getFirebaseAuthErrorMessage(error) { switch (error.code) { case 'auth/invalid-email': return 'Email no v√°lido.'; case 'auth/user-not-found': return 'Usuario no encontrado.'; case 'auth/wrong-password': return 'Contrase√±a incorrecta.'; case 'auth/email-already-in-use': return 'Este email ya est√° registrado.'; case 'auth/weak-password': return 'La contrase√±a debe tener al menos 6 caracteres.'; case 'auth/invalid-credential': return 'Credenciales inv√°lidas.'; default: return error.message || 'Ha ocurrido un error. Int√©ntalo de nuevo.'; } },
                loadTemplates() { const wrapper = document.getElementById('sections-wrapper'); if(wrapper.children.length > 0) return; const templates = document.querySelectorAll('template'); templates.forEach(template => { const content = template.content.cloneNode(true); wrapper.appendChild(content); }); },
                
                setupEventListeners() {
                    document.body.addEventListener('click', (e) => {
                        const button = e.target.closest('[data-action]');
                        const calcTabBtn = e.target.closest('.calc-tab-btn');
                        
                        if(calcTabBtn){
                            this.switchCalculatorTab(calcTabBtn.dataset.tab);
                            return;
                        }
                        
                        if (!button) { 
                            const navBtn = e.target.closest('.nav-btn'); 
                            if (navBtn) this.showSection(navBtn.dataset.section); 
                            return; 
                        }
                        
                        const { action, sectionId, foodId, mealName, itemIndex, routineId, dayIndex, exerciseName, exerciseIndex, group, subgroup, mediaUrl, groupTarget, clientId, mealIndex, historyDate } = button.dataset;
                        const actionMap = {
                            'show-section': () => this.showSection(sectionId), 'handle-workout-action': () => this.handleWorkoutAction(), 'confirm-cancel-workout': () => this.confirmCancelWorkout(), 'abort-workout': () => this.finishWorkout(false), 'exit-without-saving': () => this.finishWorkout(false), 'exit-and-save': () => this.finishWorkout(true), 'start-workout': () => this.startWorkout(routineId, parseInt(dayIndex)), 'skip-rest': () => this.skipRest(), 'add-rest-time': () => this.addRestTime(), 'save-goals': () => this.saveNutritionGoals(), 'calculate-body-metrics': () => this.calculateBodyMetrics(), 'show-add-food-modal': () => this.showAddFoodModal(foodId), 'add-food-to-meal': () => this.addFoodToMealFromModal(foodId, parseInt(mealIndex)), 'confirm-remove-food': () => this.confirmRemoveFoodFromMeal(parseInt(mealIndex), parseInt(itemIndex)), 'remove-food': () => this.removeFoodFromMeal(parseInt(mealIndex), parseInt(itemIndex)), 'generate-plan': () => this.generatePlanWithAI(), 'analyze-food': () => this.analyzeFoodWithAI(), 'get-recipe': () => this.getRecipeForMeal(parseInt(mealIndex)), 'show-exercise-info': () => this.showExerciseInfoModal(exerciseName), 'hide-modal': () => this.hideModal(), 'show-workout-history': () => this.openWorkoutHistoryModal(historyDate), 'routine-create': () => this.routine_enterCreator(), 'routine-show-details': () => this.routine_showDetails(routineId), 'routine-close-view': () => this.routine_closeFullscreenView(), 'routine-creator-next': () => this.routine_handleCreatorNext(), 'routine-creator-add-exercise': () => this.routine_showAddExerciseDrawer(), 'routine-creator-close-drawer': () => this.routine_closeAddExerciseDrawer(), 'routine-creator-select-exercise': () => this.routine_selectExercise(exerciseName), 'routine-creator-save-exercise-details': () => this.routine_saveExerciseDetails(parseInt(exerciseIndex)), 'routine-creator-edit-exercise': (e) => this.routine_editExercise(e.target.closest('[data-exercise-index]').dataset.exerciseIndex), 'routine-creator-remove-exercise': () => this.routine_removeExercise(parseInt(exerciseIndex)), 'routine-creator-save': () => this.routine_save(), 'routine-confirm-delete': () => this.routine_confirmDelete(routineId), 'routine-delete': () => this.routine_delete(routineId), 'routine-creator-suggest-ai': () => this.routine_showAiSuggestionModal(), 'generate-exercises-ai': () => this.routine_generateExercisesWithAi(), 'analyze-workout-performance': (e) => this.analyzeWorkoutPerformance(e), 'edit-profile': () => this.showEditProfileModal(), 'save-profile-changes': () => this.handleUpdateProfile(), 'edit-target-weight': () => this.showEditTargetWeightModal(), 'save-target-weight': () => this.handleUpdateTargetWeight(), 'add-weight-log': () => this.handleAddWeightLog(), 'admin-edit-media': () => this.admin_showEditMediaModal(group, subgroup, exerciseIndex), 'admin-upload-media': () => this.admin_uploadAndSaveMedia(group, subgroup, exerciseIndex), 'routine-creator-switch-day': () => this.routine_switchDay(parseInt(dayIndex)), 'routine-creator-add-day': () => this.routine_addDay(), 'routine-creator-rename-day': () => this.routine_showRenameDayModal(parseInt(dayIndex)), 'routine-creator-confirm-delete-day': () => this.routine_confirmDeleteDay(parseInt(dayIndex)), 'routine-creator-delete-day': () => this.routine_deleteDay(parseInt(dayIndex)), 'routine-creator-back-to-groups': () => this.routine_creator_showGroupList(),
                            'show-media-viewer': () => this.showMediaViewer(mediaUrl),
                            'routine-creator-switch-group': () => this.routine_creator_switchGroup(groupTarget),
                            'routine-creator-edit-group-image': (evt) => { evt.stopPropagation(); this.routine_creator_showGroupImageModal(groupTarget); },
                            'routine-creator-upload-group-image': () => this.routine_creator_uploadGroupImage(groupTarget),
                            'manage-client': () => this.showClientManager(clientId),
                            'edit-client-routine': () => this.editClientRoutine(clientId),
                            'assign-routine-to-client': () => this.assignRoutineToClient(clientId),
                            'edit-client-diet': () => this.editClientDiet(clientId),
                            'save-client-diet': () => this.saveClientDiet(clientId),
                            'toggle-food-completion': () => this.toggleFoodCompletion(parseInt(mealIndex), parseInt(itemIndex)),
                            'client-diet-add-meal': () => this._addMealToClientDietTemp(),
                            'client-diet-remove-meal': () => this._removeMealFromClientDietTemp(parseInt(mealIndex)),
                            'client-diet-add-food-modal': () => this._showAddFoodToClientModal(foodId),
                            'client-diet-add-food-to-meal': () => this._addFoodToClientDietTemp(foodId, parseInt(mealIndex)),
                            'client-diet-remove-food': () => this._handleRemoveFoodFromClientDiet(parseInt(mealIndex), parseInt(itemIndex)),
                            'client-diet-show-calculator': () => this._showClientCalculatorModal(clientId),
                            'client-diet-create-food-modal': () => this._showCreateFoodModal(),
                            'client-diet-save-custom-food': () => this._saveCustomFood(),
                            'confirm-delete-custom-food': () => this._confirmDeleteCustomFood(foodId),
                            'delete-custom-food': () => this._deleteCustomFood(foodId),
                        };
                        
                        // Prevenir que el checkbox dispare el evento del label padre
                        if (action === 'toggle-food-completion') {
                           e.stopPropagation(); 
                        }

                        if (actionMap[action]) {
                            actionMap[action](e);
                        }
                    });
                    document.body.addEventListener('submit', (e) => { e.preventDefault(); if (e.target.id === 'nutrition-form') { this.calculateNutrition(); } if (e.target.id === 'weight-log-form') { this.handleAddWeightLog(); } if (e.target.id === '1rm-form') { this.calculate1RM(); } if (e.target.id === 'invite-form') { this.handleInviteClient(e); } });
                    document.body.addEventListener('input', (e) => { if (e.target.id === 'food-search') { this.renderFoodList(e.target.value); } if (e.target.id === 'exercise-search-input') { this.routine_filterExerciseLibrary(e.target.value); } if (e.target.id === 'client-food-search') { this.renderFoodList(e.target.value, 'client-food-list'); } if (e.target.closest('#client-diet-editor')) { const mealIndex = e.target.dataset.mealIndex; if (mealIndex) { this._updateMealDataFromUI(parseInt(mealIndex)); } } });
                    document.body.addEventListener('change', (e) => { if (e.target.closest('#client-diet-goals-form')) { this._handleUpdateClientGoalsFromUI(); } });

                    const sidebar = document.getElementById('app-sidebar');
                    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                    const mobileBackdrop = document.getElementById('mobile-menu-backdrop');

                    if (mobileMenuToggle) {
                        mobileMenuToggle.addEventListener('click', () => this.toggleMobileMenu());
                    }
                    if (mobileBackdrop) {
                        mobileBackdrop.addEventListener('click', () => this.closeMobileMenu(true));
                    }
                    document.addEventListener('keydown', (event) => {
                        if (event.key === 'Escape' && this.state?.isMobileMenuOpen) {
                            this.closeMobileMenu(true);
                        }
                    });

                    if(sidebar){
                        const setSidebarStateForViewport = () => {
                            if(window.innerWidth >= 1024){
                                sidebar.setAttribute('data-collapsed','true');
                                this.closeMobileMenu(true, true);
                            } else {
                                sidebar.setAttribute('data-collapsed','false');
                                if (!this.state.isMobileMenuOpen) {
                                    sidebar.setAttribute('data-mobile-open','false');
                                    sidebar.classList.remove('mobile-overlay');
                                    if (mobileBackdrop) {
                                        mobileBackdrop.classList.remove('is-visible');
                                    }
                                    document.body.classList.remove('mobile-menu-open');
                                }
                            }
                        };
                        const expandSidebar = () => {
                            if(window.innerWidth >= 1024){
                                sidebar.setAttribute('data-collapsed','false');
                            }
                        };
                        const collapseSidebar = () => {
                            if(window.innerWidth >= 1024){
                                sidebar.setAttribute('data-collapsed','true');
                            }
                        };

                        setSidebarStateForViewport();

                        sidebar.addEventListener('mouseenter', expandSidebar);
                        sidebar.addEventListener('mouseleave', collapseSidebar);
                        sidebar.addEventListener('focusin', expandSidebar);
                        sidebar.addEventListener('focusout', () => {
                            if(window.innerWidth >= 1024){
                                requestAnimationFrame(() => {
                                    if(!sidebar.contains(document.activeElement)){
                                        sidebar.setAttribute('data-collapsed','true');
                                    }
                                });
                            }
                        });

                        window.addEventListener('resize', setSidebarStateForViewport);
                    }
                },

                toggleMobileMenu() {
                    if (window.innerWidth >= 1024) { return; }
                    if (this.state?.isMobileMenuOpen) {
                        this.closeMobileMenu(true);
                    } else {
                        this.openMobileMenu();
                    }
                },

                openMobileMenu() {
                    if (window.innerWidth >= 1024) { return; }
                    const sidebar = document.getElementById('app-sidebar');
                    const backdrop = document.getElementById('mobile-menu-backdrop');
                    const toggleBtn = document.getElementById('mobile-menu-toggle');
                    if (!sidebar) { return; }

                    this.state.isMobileMenuOpen = true;
                    sidebar.classList.add('mobile-overlay');
                    requestAnimationFrame(() => {
                        sidebar.setAttribute('data-mobile-open', 'true');
                    });
                    if (backdrop) {
                        backdrop.classList.add('is-visible');
                    }
                    document.body.classList.add('mobile-menu-open');
                    if (toggleBtn) {
                        toggleBtn.setAttribute('aria-expanded', 'true');
                    }
                },

                closeMobileMenu(force = false, immediate = false) {
                    if (!force && window.innerWidth >= 1024) { return; }
                    const sidebar = document.getElementById('app-sidebar');
                    const backdrop = document.getElementById('mobile-menu-backdrop');
                    const toggleBtn = document.getElementById('mobile-menu-toggle');

                    if (this.state) {
                        this.state.isMobileMenuOpen = false;
                    }

                    if (sidebar) {
                        sidebar.setAttribute('data-mobile-open', 'false');
                    }

                    if (backdrop) {
                        backdrop.classList.remove('is-visible');
                    }

                    document.body.classList.remove('mobile-menu-open');

                    if (toggleBtn) {
                        toggleBtn.setAttribute('aria-expanded', 'false');
                    }

                    if (sidebar && sidebar.classList.contains('mobile-overlay')) {
                        const cleanup = () => {
                            if (!this.state.isMobileMenuOpen && window.innerWidth < 1024) {
                                sidebar.classList.remove('mobile-overlay');
                            }
                        };
                        if (immediate) {
                            cleanup();
                        } else {
                            setTimeout(cleanup, 300);
                        }
                    }
                },

                renderAll() { this.renderRoutinesSection(); this.renderDietPage(); this.renderWeeklyProgress(); this.renderWorkoutHistorySection(); this.renderProfileSection(); this.renderNutricionSection(); if (this.isAsesor()){ this.renderAsesoradosSection();} this.updateDashboard(); lucide.createIcons(); },
                showSection(id, animate=true){
                    this.state.currentSection=id;
                    document.querySelectorAll('.section-content').forEach(s=>s.classList.add('hidden'));
                    const el=document.getElementById(id);
                    if(el){
                        el.classList.remove('hidden');
                        if(animate){
                            el.classList.add('section-fade-in');
                            el.addEventListener('animationend',()=>el.classList.remove('section-fade-in'),{once:true});
                        }
                    }
                    document.querySelectorAll('.nav-btn').forEach(b=>{
                        const isActive=b.dataset.section===id;
                        b.classList.toggle('is-active',isActive);
                    });
                    if(window.innerWidth < 1024){
                        this.closeMobileMenu(true);
                    }
                    if(id==='dieta'){this.renderFoodList();}
                },
                
                async renderAsesoradosSection() {
                    const listContainer = document.getElementById('asesorados-list');
                    if (!listContainer) return;
                    await this.fetchAsesorados();
                    if (this.state.asesorados.length > 0) {
                        listContainer.innerHTML = this.state.asesorados.map(client => `
                            <button data-action="manage-client" data-client-id="${client.id}" class="w-full bg-gray-700 rounded-2xl p-4 flex items-center space-x-4 text-left hover:bg-gray-600/80 transition-colors">
                                <div class="w-10 h-10 rounded-full bg-emerald-500/50 flex items-center justify-center font-bold text-white flex-shrink-0">${client.userName.charAt(0).toUpperCase()}</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-white">${client.userName}</h4>
                                    <p class="text-sm text-gray-400">${client.email}</p>
                                </div>
                                <i data-lucide="chevron-right" class="text-gray-500"></i>
                            </button>
                        `).join('');
                    } else {
                        listContainer.innerHTML = `<p class="text-gray-500 text-center p-4">A√∫n no tienes clientes. ¬°Invita a alguien!</p>`;
                    }
                    lucide.createIcons();
                },
                async fetchAsesorados() {
                    if (!this.state.currentUser) return;
                    const usersRef = collection(this.db, "users");
                    const q = query(usersRef, where("coachId", "==", this.state.currentUser.uid));
                    const querySnapshot = await getDocs(q);
                    this.state.asesorados = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                },
                async handleInviteClient(e) {
                    const form = e.target;
                    const button = e.submitter || form.querySelector('button[type="submit"]');
                    if (button) button.disabled = true;

                    const emailInput = document.getElementById('invite-email');
                    const email = emailInput.value.toLowerCase().trim();

                    if (!email) {
                        this.showToast("Ingresa un email v√°lido.", "error");
                        if (button) button.disabled = false;
                        return;
                    }

                    if (this.state.currentUser?.email?.toLowerCase() === email) {
                        this.showToast("No puedes invitarte a ti mismo.", "error");
                        if (button) button.disabled = false;
                        return;
                    }

                    await this.fetchAsesorados();
                    const alreadyClient = (this.state.asesorados || []).some(client => client.email?.toLowerCase() === email);
                    if (alreadyClient) {
                        this.showToast("Este usuario ya es tu cliente.", "error");
                        if (button) button.disabled = false;
                        return;
                    }

                    try {
                        const invitationsRef = collection(this.db, "invitations");
                        const q = query(
                            invitationsRef,
                            where("coachId", "==", this.state.currentUser.uid),
                            where("clientEmail", "==", email),
                            where("status", "==", "pending")
                        );
                        const existingInvite = await getDocs(q);
                        if (!existingInvite.empty) {
                            this.showToast("Ya existe una invitaci√≥n pendiente para este email.", "error");
                            if (button) button.disabled = false;
                            return;
                        }

                        await addDoc(invitationsRef, {
                            coachId: this.state.currentUser.uid,
                            clientEmail: email,
                            status: "pending",
                            sentAt: new Date()
                        });

                        this.showToast(`¬°Invitaci√≥n enviada a ${email}!`, "success");
                        emailInput.value = '';
                    } catch (error) {
                        console.error("Error sending invitation:", error);
                        this.showToast("No se pudo enviar la invitaci√≥n.", "error");
                    } finally {
                        if (button) button.disabled = false;
                    }
                },
                
                async showClientManager(clientId) {
                    const client = this.state.asesorados.find(c => c.id === clientId);
                    if (!client) {
                        this.showToast("Cliente no encontrado.", "error");
                        return;
                    }

                    const clientRoutine = client.userRoutines && client.userRoutines.length > 0 ? client.userRoutines[0] : null;
                    const availableRoutines = Array.isArray(this.state.userRoutines) ? this.state.userRoutines : [];
                    const selectorId = `client-routine-select-${clientId}`;

                    const routineHTML = `
                        <div class="bg-gray-900/50 rounded-xl p-4 space-y-4">
                            <div>
                                <h4 class="font-bold text-lg text-emerald-300 mb-2">Plan de Entrenamiento</h4>
                                ${clientRoutine ? `
                                    <div class="bg-gray-700/60 border border-emerald-500/20 p-3 rounded-lg">
                                        <p class="font-semibold text-white">${clientRoutine.name}</p>
                                        <p class="text-xs text-gray-400 mt-1">${clientRoutine.plan.length} d√≠a(s) ¬∑ ${clientRoutine.plan.reduce((acc, d) => acc + d.exercises.length, 0)} ejercicio(s)</p>
                                    </div>
                                ` : `<p class="text-sm text-gray-500">A√∫n no se ha asignado una rutina personalizada.</p>`}
                            </div>
                            <button data-action="edit-client-routine" data-client-id="${clientId}" class="w-full bg-emerald-600/80 font-bold py-2 rounded-lg hover:bg-emerald-600 transition">
                                ${clientRoutine ? 'Editar en el Creador' : 'Crear Rutina Personalizada'}
                            </button>
                            <div class="border-t border-gray-800 pt-4">
                                <p class="text-sm font-semibold text-gray-300 mb-3 flex items-center gap-2">
                                    <i data-lucide="link" class="w-4 h-4 text-emerald-400"></i>
                                    Vincular rutina desde tu librer√≠a
                                </p>
                                ${availableRoutines.length ? `
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <select id="${selectorId}" class="flex-1 bg-gray-800/70 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                            <option value="">Selecciona una rutina</option>
                                            ${availableRoutines.map(routine => `<option value="${routine.id}">${routine.name}</option>`).join('')}
                                        </select>
                                        <button data-action="assign-routine-to-client" data-client-id="${clientId}" class="sm:w-auto w-full bg-emerald-500 text-gray-900 font-bold px-4 py-2 rounded-lg hover:bg-emerald-400 transition">Vincular</button>
                                    </div>
                                ` : `<p class="text-xs text-gray-500">Crea rutinas en tu librer√≠a para poder asignarlas r√°pidamente.</p>`}
                            </div>
                        </div>
                    `;
                    
                    const dietHTML = `
                        <div class="bg-gray-900/50 rounded-xl p-4">
                           <h4 class="font-bold text-lg text-emerald-300 mb-3">Plan de Alimentaci√≥n</h4>
                           <div class="text-sm text-gray-400">Objetivo: <span class="font-bold text-white">${client.userGoals.calories} kcal</span></div>
                           <button data-action="edit-client-diet" data-client-id="${clientId}" class="w-full bg-emerald-600/80 font-bold py-2 rounded-lg mt-3 hover:bg-emerald-600 transition">
                                Editar Dieta
                           </button>
                        </div>
                    `;

                    const viewHTML = `<div id="client-manager-view" class="fullscreen-view bg-gray-800 w-full h-full flex flex-col">
                        <header class="p-4 flex items-center bg-gray-900/80 backdrop-blur-sm sticky top-0">
                            <button data-action="routine-close-view" class="p-2 rounded-full hover:bg-gray-700"><i data-lucide="arrow-left"></i></button>
                            <div class="flex-grow text-center">
                                <h3 class="text-lg font-bold truncate">${client.userName}</h3>
                                <p class="text-xs text-gray-400">${client.email}</p>
                            </div>
                            <div class="w-9 h-9"></div>
                        </header>
                        <div class="flex-grow p-4 overflow-y-auto space-y-4">
                            ${routineHTML}
                            ${dietHTML}
                        </div>
                    </div>`;

                    this.routine_openFullscreenView(viewHTML);
                },
                
                editClientRoutine(clientId) {
                    const client = this.state.asesorados.find(c => c.id === clientId);
                    if (!client) return;

                    const existingRoutine = client.userRoutines && client.userRoutines.length > 0 ? client.userRoutines[0] : null;

                    if (existingRoutine) {
                        this._tempRoutine = JSON.parse(JSON.stringify(existingRoutine));
                    } else {
                        this._tempRoutine = {
                            id: `manual-${Date.now()}`,
                            name: `Rutina para ${client.userName.split(' ')[0]}`,
                            description: '',
                            plan: [{ day: 'D√≠a 1', exercises: [] }],
                            currentDayIndex: 0,
                            editingIndex: -1,
                            activeExerciseGroup: ''
                        };
                    }
                    if (!this._tempRoutine.activeExerciseGroup) {
                        this._tempRoutine.activeExerciseGroup = '';
                    }
                    this._tempRoutine.editingClientId = clientId;
                    this._tempRoutine.assignedClientId = clientId;
                    this.routine_enterCreator(2);
                },

                async assignRoutineToClient(clientId) {
                    const selector = document.getElementById(`client-routine-select-${clientId}`);
                    if (!selector) return;

                    const routineId = selector.value;
                    if (!routineId) {
                        this.showToast('Selecciona una rutina para vincular.', 'error');
                        return;
                    }

                    const client = (this.state.asesorados || []).find(c => c.id === clientId);
                    if (!client) {
                        this.showToast('Cliente no encontrado.', 'error');
                        return;
                    }

                    const routine = (this.state.userRoutines || []).find(r => r.id === routineId);
                    if (!routine) {
                        this.showToast('No encontramos esa rutina en tu librer√≠a.', 'error');
                        return;
                    }

                    const routineCopy = JSON.parse(JSON.stringify(routine));
                    routineCopy.assignedClientId = clientId;

                    const existingRoutines = Array.isArray(client.userRoutines) ? [...client.userRoutines] : [];
                    const existingIndex = existingRoutines.findIndex(r => r.id === routineCopy.id);
                    if (existingIndex >= 0) {
                        existingRoutines[existingIndex] = routineCopy;
                    } else {
                        existingRoutines.unshift(routineCopy);
                    }

                    try {
                        const clientRef = doc(this.db, 'users', clientId);
                        await updateDoc(clientRef, { userRoutines: existingRoutines });
                        this.showToast(`Rutina vinculada a ${client.userName.split(' ')[0]}.`, 'success');
                        selector.value = '';
                        await this.fetchAsesorados();
                        this.showClientManager(clientId);
                    } catch (error) {
                        console.error('Error assigning routine to client:', error);
                        this.showToast('No se pudo vincular la rutina.', 'error');
                    }
                },

                // --- NUEVAS FUNCIONES DE EDICI√ìN DE DIETA ---

                async editClientDiet(clientId) {
                    const client = this.state.asesorados.find(c => c.id === clientId);
                    if (!client) return this.showToast("Cliente no encontrado.", "error");

                    // Crear una copia profunda para edici√≥n temporal, asegurando que los datos por defecto existan.
                    const defaultData = this.getDefaultState();
                    this._tempClientData = JSON.parse(JSON.stringify({
                        id: client.id,
                        userName: client.userName,
                        userGoals: client.userGoals || defaultData.userGoals,
                        physicalStats: client.physicalStats || defaultData.physicalStats,
                        dailyDiet: Array.isArray(client.dailyDiet) && client.dailyDiet.length > 0 ? client.dailyDiet : defaultData.dailyDiet
                    }));

                    const editorHTML = this.renderClientDietEditor();
                    this.routine_openFullscreenView(editorHTML);
                    this.renderFoodList('', 'client-food-list');
                },

                renderClientDietEditor() {
                    const client = this._tempClientData;
                    const goals = client.userGoals;

                    return `
                    <div id="client-diet-editor" class="fullscreen-view bg-gray-900 w-full h-full flex flex-col">
                        <header class="p-4 flex items-center justify-between bg-gray-800/80 backdrop-blur-sm shrink-0">
                            <button data-action="routine-close-view" class="p-2 rounded-full hover:bg-gray-700"><i data-lucide="arrow-left"></i></button>
                            <div class="text-center">
                                <h3 class="text-lg font-bold truncate">Dieta de ${client.userName.split(' ')[0]}</h3>
                            </div>
                            <button data-action="save-client-diet" data-client-id="${client.id}" class="font-bold text-emerald-400 px-4 py-2 rounded-lg hover:bg-emerald-500/10">Guardar</button>
                        </header>

                        <div class="flex-grow p-4 overflow-y-auto space-y-6">
                            <div class="bg-gray-800 p-4 rounded-xl space-y-3">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-semibold text-lg">Metas Diarias</h3>
                                    <button data-action="client-diet-show-calculator" data-client-id="${client.id}" class="flex items-center gap-1.5 text-sm bg-sky-500/20 text-sky-300 font-semibold py-1 px-3 rounded-lg hover:bg-sky-500/40">
                                        <i data-lucide="calculator" class="w-4 h-4"></i>Calcular Metas
                                    </button>
                                </div>
                                <form id="client-diet-goals-form" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div><label class="text-xs text-gray-400">Calor√≠as (kcal)</label><input type="number" id="client-cals-goal" value="${goals.calories}" class="w-full bg-gray-700 p-2 rounded-lg text-center font-bold"></div>
                                    <div><label class="text-xs text-gray-400">Prote√≠na (g)</label><input type="number" id="client-prot-goal" value="${goals.protein}" class="w-full bg-gray-700 p-2 rounded-lg text-center font-bold"></div>
                                    <div><label class="text-xs text-gray-400">Carbs (g)</label><input type="number" id="client-carb-goal" value="${goals.carbs}" class="w-full bg-gray-700 p-2 rounded-lg text-center font-bold"></div>
                                    <div><label class="text-xs text-gray-400">Grasas (g)</label><input type="number" id="client-fat-goal" value="${goals.fats}" class="w-full bg-gray-700 p-2 rounded-lg text-center font-bold"></div>
                                </form>
                            </div>

                            <div id="client-meal-sections-editor" class="space-y-4">
                                ${client.dailyDiet.map((meal, index) => this._renderClientMealSectionEditor(meal, index)).join('')}
                            </div>
                            <button data-action="client-diet-add-meal" class="w-full bg-gray-700/80 font-bold py-2.5 rounded-lg hover:bg-gray-700 transition flex items-center justify-center gap-2 text-emerald-400">
                                <i data-lucide="plus"></i>A√±adir Comida
                            </button>

                            <div class="bg-gray-800 p-4 rounded-xl">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-xl font-bold">Librer√≠a de Alimentos</h3>
                                    <button data-action="client-diet-create-food-modal" class="flex items-center gap-1.5 text-sm bg-emerald-500/20 text-emerald-300 font-semibold py-1 px-3 rounded-lg hover:bg-emerald-500/40">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i>Crear Alimento
                                    </button>
                                </div>
                                <div class="relative"><input type="text" id="client-food-search" placeholder="Busca un alimento..." class="w-full bg-gray-700 rounded-lg p-3 pl-10"><div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"><i data-lucide="search" class="text-gray-400"></i></div></div>
                                <div id="client-food-list" class="space-y-2 pr-2 mt-3 max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>`;
                },

                _renderClientMealSectionEditor(meal, mealIndex) {
                    const totalCals = meal.items.reduce((sum, item) => sum + item.totalCals, 0);
                    const itemsHTML = meal.items.length > 0
                        ? meal.items.map((item, itemIndex) => `
                            <div class="bg-gray-900/50 p-2 rounded-md flex justify-between items-center text-sm">
                                <div>
                                    <p>${item.name} <span class="text-gray-400">(${item.amount || 'N/A'}g)</span></p>
                                    <p class="text-xs text-gray-400">P:${item.totalP}g C:${item.totalC}g G:${item.totalF}g</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="font-semibold text-emerald-400">${item.totalCals} kcal</span>
                                    <button data-action="client-diet-remove-food" data-meal-index="${mealIndex}" data-item-index="${itemIndex}" class="text-red-400 hover:text-red-300 text-xl leading-none p-1">&times;</button>
                                </div>
                            </div>`).join('')
                        : `<p class="text-sm text-center text-gray-500 py-2">No hay alimentos en esta comida.</p>`;

                    return `
                    <div class="bg-gray-700/50 p-4 rounded-xl" data-meal-id="${meal.id}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="grid grid-cols-2 gap-x-4 gap-y-2 flex-grow">
                                <div>
                                    <label class="text-xs text-gray-400">Nombre de la Comida</label>
                                    <input type="text" data-field="name" data-meal-index="${mealIndex}" value="${meal.name}" class="w-full bg-gray-800 p-2 rounded-lg font-bold text-lg">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">Hora</label>
                                    <input type="time" data-field="time" data-meal-index="${mealIndex}" value="${meal.time}" class="w-full bg-gray-800 p-2 rounded-lg font-bold text-lg">
                                </div>
                            </div>
                            <button data-action="client-diet-remove-meal" data-meal-index="${mealIndex}" class="ml-2 mt-5 p-2 text-red-500 hover:bg-red-500/10 rounded-full"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </div>
                        <div class="space-y-2 mt-4 border-t border-gray-600/50 pt-3">${itemsHTML}</div>
                        <p class="text-right text-sm text-gray-400 mt-2">Total Comida: <span class="font-bold text-white">${Math.round(totalCals)} kcal</span></p>
                    </div>`;
                },

                _rerenderClientMealEditor() {
                    const container = document.getElementById('client-meal-sections-editor');
                    if (container) {
                        container.innerHTML = this._tempClientData.dailyDiet.map((meal, index) => this._renderClientMealSectionEditor(meal, index)).join('');
                        lucide.createIcons();
                    }
                },
                _addMealToClientDietTemp() {
                    const newMeal = {
                        id: `meal-${Date.now()}`,
                        name: `Comida ${this._tempClientData.dailyDiet.length + 1}`,
                        time: '17:00',
                        items: []
                    };
                    this._tempClientData.dailyDiet.push(newMeal);
                    this._rerenderClientMealEditor();
                },
                _removeMealFromClientDietTemp(mealIndex) {
                    this._tempClientData.dailyDiet.splice(mealIndex, 1);
                    this._rerenderClientMealEditor();
                },
                _updateMealDataFromUI(mealIndex) {
                    const mealDiv = document.querySelector(`#client-diet-editor [data-meal-index="${mealIndex}"]`).closest('[data-meal-id]');
                    const nameInput = mealDiv.querySelector('input[data-field="name"]');
                    const timeInput = mealDiv.querySelector('input[data-field="time"]');
                    this._tempClientData.dailyDiet[mealIndex].name = nameInput.value;
                    this._tempClientData.dailyDiet[mealIndex].time = timeInput.value;
                },
                _showAddFoodToClientModal(foodId) {
                    const food = this.getFoodById(foodId);
                    if (!food) return;

                    const mealOptions = this._tempClientData.dailyDiet.map((meal, index) => 
                        `<button data-action="client-diet-add-food-to-meal" data-food-id="${food.id}" data-meal-index="${index}" class="bg-gray-600 p-2 rounded-lg hover:bg-gray-500">${meal.name}</button>`
                    ).join('');

                    const body = `
                        <p class="mb-4">A√±adir <strong>${food.name}</strong> a una comida.</p>
                        <div><label for="food-amount-client" class="block text-sm font-medium text-gray-300 mb-1">Cantidad (g)</label><input type="number" id="food-amount-client" value="100" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div>
                        <div class="mt-4"><label class="block text-sm font-medium text-gray-300 mb-2">Selecciona la comida</label><div class="grid grid-cols-2 gap-2">${mealOptions}</div></div>`;
                    this.showModal(`A√±adir a Dieta de ${this._tempClientData.userName.split(' ')[0]}`, body, [{ text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' }]);
                },
                _addFoodToClientDietTemp(foodId, mealIndex) {
                    const amount = parseInt(document.getElementById('food-amount-client').value);
                    if (isNaN(amount) || amount <= 0) { this.showToast("Cantidad inv√°lida.", "error"); return; }
                    const food = this.getFoodById(foodId);
                    if (!food) { this.showToast("Alimento no encontrado.", "error"); return; }
                    
                    const factor = amount / 100;
                    this._tempClientData.dailyDiet[mealIndex].items.push({
                        ...food, amount: amount,
                        totalCals: Math.round((food.cals || 0) * factor),
                        totalP: Math.round((food.p || 0) * factor),
                        totalC: Math.round((food.c || 0) * factor),
                        totalF: Math.round((food.f || 0) * factor)
                    });
                    
                    this._rerenderClientMealEditor();
                    this.hideModal();
                    this.showToast(`${food.name} a√±adido a ${this._tempClientData.dailyDiet[mealIndex].name}.`);
                },
                _handleRemoveFoodFromClientDiet(mealIndex, itemIndex) {
                    this._tempClientData.dailyDiet[mealIndex].items.splice(itemIndex, 1);
                    this._rerenderClientMealEditor();
                    this.showToast('Alimento eliminado.', 'error');
                },
                _handleUpdateClientGoalsFromUI() {
                    this._tempClientData.userGoals.calories = parseInt(document.getElementById('client-cals-goal').value) || 0;
                    this._tempClientData.userGoals.protein = parseInt(document.getElementById('client-prot-goal').value) || 0;
                    this._tempClientData.userGoals.carbs = parseInt(document.getElementById('client-carb-goal').value) || 0;
                    this._tempClientData.userGoals.fats = parseInt(document.getElementById('client-fat-goal').value) || 0;
                },
                _showClientCalculatorModal(clientId) {
                    const client = this._tempClientData;
                    const stats = client.physicalStats || this.getDefaultState().physicalStats;
                    const body = `
                        <p class="text-sm text-gray-400 mb-4">Calcula las metas basadas en los datos de ${client.userName}.</p>
                        <form id="client-calc-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4"><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="gender" value="male" class="sr-only" ${stats.gender === 'male' ? 'checked' : ''}> Hombre</label><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="gender" value="female" class="sr-only" ${stats.gender === 'female' ? 'checked' : ''}> Mujer</label></div>
                            <div class="grid grid-cols-3 gap-3"><div><label class="text-xs">Edad</label><input type="number" name="age" value="${stats.age}" class="w-full bg-gray-700 rounded p-2 text-center"></div><div><label class="text-xs">Peso (kg)</label><input type="number" step="0.1" name="weight" value="${stats.weight}" class="w-full bg-gray-700 rounded p-2 text-center"></div><div><label class="text-xs">Altura (cm)</label><input type="number" name="height" value="${stats.height}" class="w-full bg-gray-700 rounded p-2 text-center"></div></div>
                            <div><label class="text-xs">Nivel de Actividad</label><select name="activity" class="w-full bg-gray-700 rounded p-2 mt-1"><option value="1.2" ${stats.activity == 1.2 ? 'selected' : ''}>Sedentario</option><option value="1.375" ${stats.activity == 1.375 ? 'selected' : ''}>Ligero</option><option value="1.55" ${stats.activity == 1.55 ? 'selected' : ''}>Moderado</option><option value="1.725" ${stats.activity == 1.725 ? 'selected' : ''}>Activo</option><option value="1.9" ${stats.activity == 1.9 ? 'selected' : ''}>Muy Activo</option></select></div>
                            <div class="grid grid-cols-3 gap-2"><label class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer text-sm has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="goal" value="lose" class="sr-only"> Perder</label><label class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer text-sm has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="goal" value="maintain" class="sr-only" checked> Mantener</label><label class="bg-gray-700 p-2 rounded-lg text-center cursor-pointer text-sm has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="goal" value="gain" class="sr-only"> Ganar</label></div>
                        </form>
                    `;
                    const footer = [{ text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' }, { text: 'Calcular y Aplicar', class: 'bg-emerald-600 text-gray-900', action: 'none' }];
                    this.showModal('Calcular Metas', body, footer);

                    document.querySelector('#custom-modal-footer button[data-action="none"]').onclick = () => {
                        const form = document.getElementById('client-calc-form');
                        const results = this.calculateNutrition(form, false);
                        if (results) {
                            document.getElementById('client-cals-goal').value = results.calories;
                            document.getElementById('client-prot-goal').value = results.protein;
                            document.getElementById('client-carb-goal').value = results.carbs;
                            document.getElementById('client-fat-goal').value = results.fats;
                            this._handleUpdateClientGoalsFromUI();
                            this.hideModal();
                        }
                    };
                },
                _showCreateFoodModal() {
                    const body = `
                        <p class="text-sm text-gray-400 mb-4">A√±ade un nuevo alimento a tu librer√≠a personal. Los valores deben ser por cada 100g.</p>
                        <form id="create-food-form" class="space-y-3">
                            <div><label class="text-xs text-gray-300">Nombre del Alimento</label><input type="text" name="name" required class="w-full bg-gray-700 p-2 rounded-lg mt-1"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs text-gray-300">Calor√≠as (kcal)</label><input type="number" name="cals" required class="w-full bg-gray-700 p-2 rounded-lg mt-1"></div>
                                <div><label class="text-xs text-gray-300">Prote√≠na (g)</label><input type="number" name="p" required class="w-full bg-gray-700 p-2 rounded-lg mt-1"></div>
                                <div><label class="text-xs text-gray-300">Carbs (g)</label><input type="number" name="c" required class="w-full bg-gray-700 p-2 rounded-lg mt-1"></div>
                                <div><label class="text-xs text-gray-300">Grasas (g)</label><input type="number" name="f" required class="w-full bg-gray-700 p-2 rounded-lg mt-1"></div>
                            </div>
                        </form>
                    `;
                    const footer = [{ text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' }, { text: 'Crear Alimento', class: 'bg-emerald-600 text-gray-900', action: 'client-diet-save-custom-food' }];
                    this.showModal('Crear Nuevo Alimento', body, footer);
                },
                async _saveCustomFood() {
                    const form = document.getElementById('create-food-form');
                    const name = form.name.value.trim();
                    const cals = parseFloat(form.cals.value);
                    const p = parseFloat(form.p.value);
                    const c = parseFloat(form.c.value);
                    const f = parseFloat(form.f.value);

                    if (!name || isNaN(cals) || isNaN(p) || isNaN(c) || isNaN(f)) {
                        return this.showToast("Todos los campos son obligatorios y deben ser n√∫meros.", "error");
                    }
                    const newFood = { name, cals, p, c, f };
                    try {
                        const customFoodsRef = collection(this.db, "users", this.state.currentUser.uid, "customFoods");
                        await addDoc(customFoodsRef, newFood);
                        this.showToast("Alimento creado y guardado en tu librer√≠a.", "success");
                        await this.loadAndMergeFoodData();
                        this.renderFoodList(document.getElementById('client-food-search').value, 'client-food-list');
                        this.hideModal();
                    } catch (error) {
                        console.error("Error creating custom food:", error);
                        this.showToast("No se pudo guardar el alimento.", "error");
                    }
                },
                _confirmDeleteCustomFood(foodId) {
                    const food = this.getFoodById(foodId);
                    if (!food) return this.showToast('Alimento no encontrado', 'error');
                    const body = `¬øEst√°s seguro de que quieres eliminar permanentemente el alimento "<strong>${food.name}</strong>"? Esta acci√≥n no se puede deshacer.`;
                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' },
                        { text: 'Eliminar', class: 'bg-red-600', action: 'delete-custom-food', 'food-id': foodId }
                    ];
                    this.showModal('Confirmar Eliminaci√≥n', body, footer);
                },
                async _deleteCustomFood(foodId) {
                    try {
                        const foodRef = doc(this.db, "users", this.state.currentUser.uid, "customFoods", foodId);
                        await deleteDoc(foodRef);
                        this.showToast('Alimento eliminado con √©xito.', 'success');
                        this.hideModal();
                        await this.loadAndMergeFoodData();
                        const clientSearchInput = document.getElementById('client-food-search');
                        if (clientSearchInput) {
                            this.renderFoodList(clientSearchInput.value, 'client-food-list');
                        } else {
                            this.renderFoodList();
                        }
                    } catch (error) {
                        console.error("Error deleting custom food:", error);
                        this.showToast('No se pudo eliminar el alimento.', 'error');
                    }
                },
                async saveClientDiet(clientId) {
                    this._handleUpdateClientGoalsFromUI();
                    const clientRef = doc(this.db, "users", clientId);
                    try {
                        await updateDoc(clientRef, {
                            userGoals: this._tempClientData.userGoals,
                            dailyDiet: this._tempClientData.dailyDiet
                        });
                        this.showToast(`Dieta de ${this._tempClientData.userName.split(' ')[0]} guardada.`, "success");
                        this.routine_closeFullscreenView();
                        await this.fetchAsesorados();
                        this.renderAsesoradosSection();
                        this._tempClientData = null;
                    } catch (error) {
                        console.error("Error saving client diet:", error);
                        this.showToast("Error al guardar la dieta.", "error");
                    }
                },

                // --- FIN DE NUEVAS FUNCIONES ---
                
                updateDietSummary() {
                    let consumedTotals = { cals: 0, p: 0, c: 0, f: 0 };
                    
                    const today = new Date().toISOString().split('T')[0];
                    const todayLog = this.state.dietLog ? (this.state.dietLog[today] || {}) : {};
                    
                    if (this.state.dailyDiet && Array.isArray(this.state.dailyDiet)) {
                        this.state.dailyDiet.forEach((meal, mealIndex) => {
                            const mealLog = todayLog[meal.id] || [];
                            meal.items.forEach((item, itemIndex) => {
                                if (mealLog[itemIndex] === true || this.isAsesor()) { // Asesor ve el 100% como "consumido"
                                    if (item.totalCals) consumedTotals.cals += item.totalCals;
                                    if (item.totalP) consumedTotals.p += item.totalP;
                                    if (item.totalC) consumedTotals.c += item.totalC;
                                    if (item.totalF) consumedTotals.f += item.totalF;
                                }
                            });
                        });
                    }

                    const { calories, protein, carbs, fats } = this.state.userGoals;
                    const p = (c, g) => Math.min(100, (g > 0 ? c / g : 0) * 100);

                    // Actualizar p√°gina de Dieta
                    document.getElementById('diet-total-calories').textContent = Math.round(consumedTotals.cals);
                    document.getElementById('diet-total-protein').textContent = Math.round(consumedTotals.p);
                    document.getElementById('diet-total-carbs').textContent = Math.round(consumedTotals.c);
                    document.getElementById('diet-total-fats').textContent = Math.round(consumedTotals.f);
                    
                    document.getElementById('diet-progress-bar').style.width = `${p(consumedTotals.cals, calories)}%`;
                    document.getElementById('diet-protein-bar').style.width = `${p(consumedTotals.p, protein)}%`;
                    document.getElementById('diet-carbs-bar').style.width = `${p(consumedTotals.c, carbs)}%`;
                    document.getElementById('diet-fats-bar').style.width = `${p(consumedTotals.f, fats)}%`;

                    // Actualizar Dashboard
                    const consumedCalsPercent = p(consumedTotals.cals, calories);
                    document.getElementById('dashboard-consumed-calories').textContent = `${Math.round(consumedTotals.cals)} Kcal`;
                    document.getElementById('dashboard-progress-bar').style.width = `${consumedCalsPercent}%`;
                    document.getElementById('dashboard-progress-text').textContent = Math.round(consumedCalsPercent);
                },

                renderFoodList(searchTerm = '', containerId = 'food-list') {
                    const container = document.getElementById(containerId);
                    if (!container) return;

                    const isClientEditor = containerId === 'client-food-list';
                    const action = isClientEditor ? 'client-diet-add-food-modal' : 'show-add-food-modal';

                    const renderFoodItem = (item) => {
                        let deleteButton = '';
                        // Los alimentos personalizados tienen un ID de texto, los predefinidos tienen n√∫meros.
                        if (this.isAsesor() && typeof item.id === 'string') {
                            deleteButton = `
                                <button data-action="confirm-delete-custom-food" data-food-id="${item.id}" title="Eliminar Alimento Personalizado" class="text-red-500 hover:text-red-400 p-2 rounded-full hover:bg-red-500/10 transition-colors">
                                    <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            `;
                        }

                        return `
                        <div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-white">${item.name}</p>
                                <p class="text-xs text-gray-400">${item.cals} kcal por 100g</p>
                            </div>
                            <div class="flex items-center gap-2">
                                ${deleteButton}
                                <button data-action="${action}" data-food-id="${item.id}" class="bg-emerald-500 rounded-full w-8 h-8 flex-shrink-0 flex items-center justify-center text-gray-900 font-bold text-xl">+</button>
                            </div>
                        </div>`;
                    };
                    
                    const term = searchTerm.toLowerCase().trim();
                    const foodSource = this.data.foodLibrary || [];
                    if (term) {
                        const results = foodSource.filter(item => item.name.toLowerCase().includes(term));
                        container.innerHTML = results.length > 0 ? results.map(renderFoodItem).join('') : `<p class="text-gray-400 text-center p-4">No se encontraron alimentos.</p>`;
                    } else {
                        const grouped = {
                            'Mis Alimentos': foodSource.filter(f => typeof f.id === 'string'),
                            ...Object.entries(this.data.foodDatabase).reduce((acc, [cat, items]) => {
                                acc[cat] = items;
                                return acc;
                            }, {})
                        };
                        
                        container.innerHTML = Object.entries(grouped).map(([category, items]) => {
                            if (items.length === 0) return '';
                            return `<details class="bg-gray-700/50 rounded-lg open:bg-gray-700/80 transition-colors" ${category === 'Mis Alimentos' ? 'open' : ''}><summary class="p-3 font-semibold cursor-pointer list-none flex justify-between items-center">${category}<i data-lucide="chevron-down" class="w-5 h-5 transition-transform transform details-open:rotate-180"></i></summary><div class="p-3 border-t border-gray-600/50 space-y-2">${items.map(renderFoodItem).join('')}</div></details>`;
                        }).join('');
                    }
                    lucide.createIcons();
                },
                
                renderWeeklyProgress() {
                    const container = document.getElementById('weekly-progress-card');
                    if (!container) return;

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const startOfWeek = new Date(today);
                    const weekday = today.getDay();
                    startOfWeek.setDate(today.getDate() - (weekday === 0 ? 6 : weekday - 1));

                    const dayLetters = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
                    let weekHTML = '';
                    let completedCount = 0;

                    for (let i = 0; i < 7; i++) {
                        const currentDate = new Date(startOfWeek);
                        currentDate.setDate(startOfWeek.getDate() + i);
                        const dateString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                        const dayEntries = Array.isArray(this.state.workoutHistory?.[dateString]) ? this.state.workoutHistory[dateString] : [];
                        const isCompleted = dayEntries.length > 0;
                        const isToday = currentDate.getTime() === today.getTime();
                        if (isCompleted) completedCount++;
                        weekHTML += `
                            <div class="text-center">
                                <p class="text-xs text-gray-400">${dayLetters[i]}</p>
                                <div class="w-8 h-8 rounded-full flex items-center justify-center mt-1 ${isCompleted ? 'bg-emerald-500' : 'bg-gray-600'} ${isToday ? 'ring-2 ring-white' : ''}"></div>
                            </div>
                        `;
                    }

                    const historyEntries = this.getWorkoutHistoryEntries();
                    let statsHtml = '';
                    if (historyEntries.length > 0) {
                        const lastWorkout = historyEntries[0];
                        const formattedDate = new Date(lastWorkout.completedAt || `${lastWorkout.date}T00:00:00`).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                        const intlFormatter = new Intl.NumberFormat('es-ES');
                        statsHtml = `
                            <div class="mt-4 pt-4 border-t border-gray-600/50">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">√öltimo entrenamiento</h4>
                                    <button data-action="show-workout-history" class="text-xs font-semibold text-emerald-300 hover:text-emerald-200">Ver historial</button>
                                </div>
                                <div class="mt-3 flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 p-3">
                                    <div class="flex items-center gap-3">
                                        <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-200"><i data-lucide="award" class="h-5 w-5"></i></span>
                                        <div>
                                            <p class="font-bold text-white">${lastWorkout.routineName}</p>
                                            <p class="text-xs text-gray-400 capitalize">${formattedDate}</p>
                                        </div>
                                    </div>
                                    <div class="text-right text-sm text-gray-200">
                                        <p class="font-semibold">${this.formatTime(lastWorkout.totalDuration)}</p>
                                        <p class="text-xs text-gray-400">${intlFormatter.format(Math.round(lastWorkout.totalVolume || 0))} kg¬∑reps</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        statsHtml = `
                            <div class="mt-4 pt-4 border-t border-gray-600/50 text-center text-gray-500 text-sm">
                                <p>Completa tu primer entrenamiento para comenzar a ver tus estad√≠sticas.</p>
                            </div>
                        `;
                    }

                    container.innerHTML = `
                        <h3 class="font-semibold text-lg mb-3">Progreso semanal</h3>
                        <div class="flex justify-between">${weekHTML}</div>
                        <p class="text-right text-xs text-gray-400 mt-2">${completedCount} de 7 d√≠as completados</p>
                        ${statsHtml}
                    `;
                    lucide.createIcons();
                },
                renderWorkoutHistorySection() {
                    const overviewContainer = document.getElementById('history-overview');
                    const cardsContainer = document.getElementById('history-cards');
                    const section = document.getElementById('historial');
                    if (!overviewContainer || !cardsContainer || !section) return;

                    const entries = this.getWorkoutHistoryEntries();
                    const intlFormatter = new Intl.NumberFormat('es-ES');

                    if (entries.length === 0) {
                        overviewContainer.innerHTML = `
                            <div class="rounded-3xl border border-dashed border-white/15 bg-white/5 p-6 text-center text-gray-400">
                                <i data-lucide="activity" class="mx-auto mb-3 h-8 w-8 text-emerald-300/80"></i>
                                <p class="font-semibold">A√∫n no hay entrenamientos registrados.</p>
                                <p class="mt-1 text-xs text-gray-500">Inicia una rutina para comenzar a construir tu historial.</p>
                            </div>
                        `;
                        cardsContainer.innerHTML = `
                            <div class="rounded-3xl border border-white/10 bg-gray-900/60 p-6 text-center text-sm text-gray-400">
                                <p>Cuando completes tus sesiones ver√°s aqu√≠ tarjetas con tus m√©tricas, pesos y progresos por fecha.</p>
                                <button data-action="show-section" data-section-id="rutinas" class="mt-4 inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-xs font-semibold uppercase tracking-[0.35em] text-gray-900 transition hover:bg-emerald-400">
                                    <i data-lucide="play" class="h-4 w-4"></i>
                                    Comenzar una rutina
                                </button>
                            </div>
                        `;
                        lucide.createIcons();
                        return;
                    }

                    const totalSessions = entries.length;
                    const totalActiveSeconds = entries.reduce((sum, entry) => sum + (entry.totalActive || 0), 0);
                    const totalVolume = entries.reduce((sum, entry) => sum + (entry.totalVolume || 0), 0);
                    const bestOneRepMax = entries.reduce((max, entry) => {
                        const entryPeak = entry.peakOneRepMax || (entry.exerciseDetails || []).reduce((peak, ex) => Math.max(peak, ex.estimated1RM || 0), 0);
                        return Math.max(max, entryPeak || 0);
                    }, 0);
                    const latestWeightEntry = (this.state.weightLog || []).slice().sort((a, b) => new Date(b.date) - new Date(a.date))[0] || null;

                    overviewContainer.innerHTML = `
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                            <div class="flex items-center gap-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-200"><i data-lucide="trophy" class="h-5 w-5"></i></span>
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Sesiones totales</p>
                                    <p class="text-2xl font-bold text-white">${intlFormatter.format(totalSessions)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                            <div class="flex items-center gap-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-sky-500/20 text-sky-200"><i data-lucide="timer" class="h-5 w-5"></i></span>
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Tiempo activo</p>
                                    <p class="text-2xl font-bold text-white">${this.formatTime(totalActiveSeconds)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                            <div class="flex items-center gap-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-amber-500/20 text-amber-200"><i data-lucide="bar-chart" class="h-5 w-5"></i></span>
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">Volumen total</p>
                                    <p class="text-2xl font-bold text-white">${intlFormatter.format(Math.round(totalVolume))} kg¬∑reps</p>
                                </div>
                            </div>
                        </div>
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                            <div class="flex items-center gap-3">
                                <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-purple-500/20 text-purple-200"><i data-lucide="line-chart" class="h-5 w-5"></i></span>
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-gray-400">1RM m√°s alto</p>
                                    <p class="text-2xl font-bold text-white">${bestOneRepMax ? `${bestOneRepMax.toFixed(1)} kg` : '‚Äî'}</p>
                                    <p class="text-[10px] text-gray-400">Peso actual: ${latestWeightEntry ? `${parseFloat(latestWeightEntry.weight).toFixed(1)} kg` : 'registra tu peso'}</p>
                                </div>
                            </div>
                        </div>
                    `;

                    const groupedByDate = entries.reduce((acc, entry) => {
                        const dateKey = entry.date || (entry.completedAt ? entry.completedAt.split('T')[0] : '');
                        if (!dateKey) return acc;
                        if (!acc[dateKey]) acc[dateKey] = [];
                        acc[dateKey].push(entry);
                        return acc;
                    }, {});

                    const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
                    const weightLogMap = (this.state.weightLog || []).reduce((map, entry) => {
                        if (entry && entry.date) {
                            map[entry.date] = parseFloat(entry.weight);
                        }
                        return map;
                    }, {});

                    const cardsHtml = sortedDates.map(dateKey => {
                        const sessions = groupedByDate[dateKey].slice().sort((a, b) => new Date(b.completedAt || 0) - new Date(a.completedAt || 0));
                        const dateLabel = new Date(`${dateKey}T00:00:00`).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                        const weightLabel = weightLogMap[dateKey] ? `${weightLogMap[dateKey].toFixed(1)} kg` : '‚Äî';
                        const dayDuration = sessions.reduce((sum, session) => sum + (session.totalDuration || 0), 0);
                        const dayActive = sessions.reduce((sum, session) => sum + (session.totalActive || 0), 0);
                        const dayRest = sessions.reduce((sum, session) => sum + (session.totalRest || Math.max(0, (session.totalDuration || 0) - (session.totalActive || 0))), 0);
                        const dayVolume = sessions.reduce((sum, session) => sum + (session.totalVolume || 0), 0);
                        const dayPeakOneRm = sessions.reduce((max, session) => {
                            const sessionPeak = session.peakOneRepMax || (session.exerciseDetails || []).reduce((peak, ex) => Math.max(peak, ex.estimated1RM || 0), 0);
                            return Math.max(max, sessionPeak || 0);
                        }, 0);

                        const sessionItems = sessions.map(session => {
                            const timeLabel = session.completedAt ? new Date(session.completedAt).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
                            const highlightExercise = (session.exerciseDetails || []).reduce((best, ex) => {
                                const current = ex.estimated1RM || 0;
                                return current > ((best?.estimated1RM) || 0) ? ex : best;
                            }, null);
                            const highlightName = highlightExercise ? highlightExercise.name : null;
                            const highlightWeight = highlightExercise?.bestWeight;
                            const highlightOneRM = highlightExercise?.estimated1RM;

                            return `
                                <article class="rounded-2xl border border-white/10 bg-gray-900/60 p-4">
                                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                        <div>
                                            <p class="text-sm font-semibold text-white">${session.routineName}</p>
                                            <p class="text-xs text-gray-400">${session.dayName || 'Sesi√≥n'}${timeLabel ? ` ¬∑ ${timeLabel}` : ''}</p>
                                        </div>
                                        <div class="flex flex-wrap gap-2 text-xs text-gray-300">
                                            <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5"><i data-lucide="timer" class="h-3.5 w-3.5"></i>${this.formatTime(session.totalDuration || 0)}</span>
                                            <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2.5 py-0.5 text-emerald-100"><i data-lucide="flame" class="h-3.5 w-3.5"></i>${this.formatTime(session.totalActive || 0)}</span>
                                            <span class="inline-flex items-center gap-1 rounded-full border border-sky-400/40 bg-sky-500/10 px-2.5 py-0.5 text-sky-100"><i data-lucide="bar-chart" class="h-3.5 w-3.5"></i>${intlFormatter.format(Math.round(session.totalVolume || 0))} kg¬∑reps</span>
                                        </div>
                                    </div>
                                    <div class="mt-3 flex flex-wrap gap-2 text-xs text-gray-300">
                                        ${highlightName ? `<span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5">Foco: ${highlightName}</span>` : '<span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5 text-gray-400">Registra pesos para ver 1RM estimados</span>'}
                                        ${highlightWeight ? `<span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2.5 py-0.5 text-emerald-100"><i data-lucide="dumbbell" class="h-3.5 w-3.5"></i>${highlightWeight} kg</span>` : ''}
                                        ${highlightOneRM ? `<span class="inline-flex items-center gap-1 rounded-full border border-purple-400/40 bg-purple-500/10 px-2.5 py-0.5 text-purple-100"><i data-lucide="line-chart" class="h-3.5 w-3.5"></i>${highlightOneRM.toFixed(1)} kg</span>` : ''}
                                    </div>
                                </article>
                            `;
                        }).join('');

                        return `
                            <article class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-sm">
                                <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                                    <div>
                                        <p class="text-lg font-semibold text-white capitalize">${dateLabel}</p>
                                        <p class="text-xs text-gray-400">${sessions.length} ${sessions.length === 1 ? 'sesi√≥n' : 'sesiones'} ¬∑ Peso corporal: ${weightLabel}</p>
                                    </div>
                                    <div class="flex flex-wrap gap-2 text-xs text-gray-300">
                                        <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5"><i data-lucide="clock" class="h-3.5 w-3.5"></i>${this.formatTime(dayDuration)}</span>
                                        <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2.5 py-0.5 text-emerald-100"><i data-lucide="flame" class="h-3.5 w-3.5"></i>${this.formatTime(dayActive)}</span>
                                        <span class="inline-flex items-center gap-1 rounded-full border border-indigo-400/40 bg-indigo-500/10 px-2.5 py-0.5 text-indigo-100"><i data-lucide="moon" class="h-3.5 w-3.5"></i>${this.formatTime(dayRest)}</span>
                                    </div>
                                </div>
                                <div class="mt-4 space-y-3">
                                    ${sessionItems}
                                </div>
                                <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                    <div class="flex flex-wrap gap-2 text-xs text-gray-300">
                                        <span class="inline-flex items-center gap-1 rounded-full border border-amber-400/40 bg-amber-500/10 px-2.5 py-0.5 text-amber-100"><i data-lucide="bar-chart-3" class="h-3.5 w-3.5"></i>${intlFormatter.format(Math.round(dayVolume))} kg¬∑reps</span>
                                        <span class="inline-flex items-center gap-1 rounded-full border border-purple-400/40 bg-purple-500/10 px-2.5 py-0.5 text-purple-100"><i data-lucide="line-chart" class="h-3.5 w-3.5"></i>${dayPeakOneRm ? `${dayPeakOneRm.toFixed(1)} kg 1RM` : '1RM pendiente'}</span>
                                        <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-2.5 py-0.5 text-gray-300"><i data-lucide="scale" class="h-3.5 w-3.5"></i>Peso: ${weightLabel}</span>
                                    </div>
                                    <button data-action="show-workout-history" data-history-date="${dateKey}" class="inline-flex items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-emerald-400/60 hover:text-white">
                                        Ver detalle
                                        <i data-lucide="chevron-right" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </article>
                        `;
                    }).join('');

                    cardsContainer.innerHTML = cardsHtml;
                    lucide.createIcons();
                },
                renderProfileSection() {
                    if (!this.state.currentUser) return;
                    const { userName, currentUser, physicalStats, targetWeight } = this.state;
                    document.getElementById('profile-avatar').querySelector('span').textContent = (userName || 'U').charAt(0).toUpperCase();
                    document.getElementById('profile-name').textContent = userName || 'Usuario';
                    document.getElementById('profile-email').textContent = currentUser.email;

                    const historyEntries = this.getWorkoutHistoryEntries();
                    const totalWorkouts = historyEntries.length;
                    const totalDurationSeconds = historyEntries.reduce((acc, entry) => acc + (entry.totalDuration || 0), 0);
                    const totalHours = (totalDurationSeconds / 3600).toFixed(1);

                    document.getElementById('profile-stat-workouts').textContent = totalWorkouts;
                    document.getElementById('profile-stat-hours').textContent = totalHours;
                    document.getElementById('profile-stat-streak').textContent = this.calculateWorkoutStreak();

                    document.getElementById('profile-info-age').textContent = `${physicalStats.age} a√±os`;
                    document.getElementById('profile-info-weight').textContent = `${physicalStats.weight} kg`;
                    document.getElementById('profile-info-height').textContent = `${physicalStats.height} cm`;
                    document.getElementById('current-weight-display').textContent = physicalStats.weight.toFixed(1);
                    document.getElementById('target-weight-display').textContent = targetWeight.toFixed(1);
                    const diff = (targetWeight - physicalStats.weight).toFixed(1);
                    document.getElementById('weight-diff-display').textContent = diff;

                    const chartContainer = document.getElementById('profile-activity-chart');
                    const weeklyData = this.getWeeklyActivityData();
                    const maxWorkouts = Math.max(...weeklyData.map(w => w.count), 1);
                    chartContainer.innerHTML = weeklyData.map(week => {
                        const barHeight = (week.count / maxWorkouts) * 100;
                        return `<div class="flex flex-col items-center justify-end h-full w-1/4"><p class="text-sm font-bold text-white">${week.count}</p><div class="w-3/5 h-full flex items-end"><div class="w-full bg-emerald-500 rounded-t-sm chart-bar" style="height: ${barHeight}%;"></div></div><p class="text-xs text-gray-400 mt-1">${week.label}</p></div>`;
                    }).join('');

                    const historyContainer = document.getElementById('profile-workout-history');
                    if (historyEntries.length > 0) {
                        historyContainer.innerHTML = historyEntries.slice(0, 5).map(entry => {
                            const formattedDate = new Date(entry.completedAt || `${entry.date}T00:00:00`).toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
                            return `<div class="bg-gray-700/60 p-3 rounded-lg flex justify-between items-center"><div><p class="font-semibold text-white">${entry.routineName}</p><p class="text-xs text-gray-400 capitalize">${formattedDate}</p></div><div class="text-sm font-medium text-gray-300">${this.formatTime(entry.totalDuration)}</div></div>`;
                        }).join('');
                    } else {
                        historyContainer.innerHTML = `<p class="text-center text-gray-500 text-sm p-4">No hay entrenamientos registrados.</p>`;
                    }
                },
                calculateWorkoutStreak() {
                    const dates = this.state.workoutHistory
                        ? Object.keys(this.state.workoutHistory)
                            .filter(dateKey => Array.isArray(this.state.workoutHistory[dateKey]) && this.state.workoutHistory[dateKey].length > 0)
                            .sort((a, b) => new Date(b) - new Date(a))
                        : [];
                    if (dates.length === 0) return 0;

                    let streak = 0;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const firstDateInLog = new Date(dates[0] + 'T00:00:00');
                    const diffTime = today - firstDateInLog;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays > 1) return 0;

                    streak = 1;
                    for (let i = 0; i < dates.length - 1; i++) {
                        const currentDate = new Date(dates[i] + 'T00:00:00');
                        const previousDate = new Date(dates[i + 1] + 'T00:00:00');
                        const dayDifference = (currentDate - previousDate) / (1000 * 60 * 60 * 24);
                        if (dayDifference === 1) {
                            streak++;
                        } else {
                            break;
                        }
                    }
                    return streak;
                },
                getWeeklyActivityData() {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const weeks = [
                        { label: 'Hace 3sem', count: 0, start: new Date(today), end: new Date(today) },
                        { label: 'Hace 2sem', count: 0, start: new Date(today), end: new Date(today) },
                        { label: 'Sem Pasada', count: 0, start: new Date(today), end: new Date(today) },
                        { label: 'Esta Sem', count: 0, start: new Date(today), end: new Date(today) },
                    ];
                    for (let i = 0; i < 4; i++) {
                        const weekIndex = 3 - i;
                        const firstDayOfWeek = new Date(today);
                        const dayOfWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                        firstDayOfWeek.setDate(today.getDate() - dayOfWeek - (i * 7));
                        weeks[weekIndex].start = new Date(firstDayOfWeek);
                        weeks[weekIndex].end = new Date(firstDayOfWeek);
                        weeks[weekIndex].end.setDate(firstDayOfWeek.getDate() + 6);
                    }
                    if (this.state.workoutHistory) {
                        Object.entries(this.state.workoutHistory).forEach(([dateStr, entries]) => {
                            if (!Array.isArray(entries) || entries.length === 0) return;
                            const workoutDate = new Date(dateStr + 'T00:00:00');
                            for (const week of weeks) {
                                if (workoutDate >= week.start && workoutDate <= week.end) {
                                    week.count += entries.length;
                                    break;
                                }
                            }
                        });
                    }
                    return weeks;
                },
                showEditProfileModal() { const { userName, physicalStats } = this.state; const body = `<form id="edit-profile-form" class="space-y-4"><div><label for="profile-edit-name" class="block text-sm font-medium text-gray-300 mb-1">Nombre</label><input type="text" id="profile-edit-name" value="${userName}" required class="w-full bg-gray-700 rounded-lg p-3 border border-gray-600 focus:ring-2 focus:ring-emerald-500 focus:outline-none transition"></div><div class="grid grid-cols-3 gap-3"><div><label for="profile-edit-age" class="block text-sm font-medium text-gray-300 mb-1">Edad</label><input type="number" id="profile-edit-age" value="${physicalStats.age}" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div><div><label for="profile-edit-weight" class="block text-sm font-medium text-gray-300 mb-1">Peso (kg)</label><input type="number" step="0.1" id="profile-edit-weight" value="${physicalStats.weight}" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div><div><label for="profile-edit-height" class="block text-sm font-medium text-gray-300 mb-1">Altura (cm)</label><input type="number" id="profile-edit-height" value="${physicalStats.height}" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div></div><div class="mt-4"><p class="block text-sm font-medium text-gray-300 mb-2">G√©nero</p><div class="grid grid-cols-2 gap-4"><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="profile-edit-gender" value="male" class="sr-only" ${physicalStats.gender === 'male' ? 'checked' : ''}> Hombre</label><label class="bg-gray-700 p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-emerald-500 has-[:checked]:text-gray-900 transition"><input type="radio" name="profile-edit-gender" value="female" class="sr-only" ${physicalStats.gender === 'female' ? 'checked' : ''}> Mujer</label></div></div></form>`; const footer = [{ text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },{ text: 'Guardar Cambios', class: 'bg-emerald-600 text-gray-900 hover:bg-emerald-500', action: 'save-profile-changes' }]; this.showModal('Editar Perfil', body, footer); },
                async handleUpdateProfile() { const name = document.getElementById('profile-edit-name').value.trim(); const age = parseInt(document.getElementById('profile-edit-age').value); const weight = parseFloat(document.getElementById('profile-edit-weight').value); const height = parseInt(document.getElementById('profile-edit-height').value); const gender = document.querySelector('input[name="profile-edit-gender"]:checked').value; if (!name || isNaN(age) || isNaN(weight) || isNaN(height)) { this.showToast("Por favor, rellena todos los campos correctamente.", "error"); return; } this.state.userName = name; this.state.physicalStats = { ...this.state.physicalStats, age, weight, height, gender }; await this.saveDataToFirestore(); this.renderAll(); this.updateUserInfoUI(); this.populateNutritionForm(); this.hideModal(); this.showToast("¬°Perfil actualizado con √©xito!"); },
                updateDashboard() { document.getElementById('dashboard-calories').textContent=`${this.state.userGoals.calories} kcal`; this.updateDietSummary(); },
                showModal(t,b,f=[]){document.getElementById('custom-modal-title').textContent=t;document.getElementById('custom-modal-body').innerHTML=b;const ft=document.getElementById('custom-modal-footer');ft.innerHTML=f.map(btn=>{const d=Object.entries(btn).filter(([k])=>k!=='text'&&k!=='class').map(([k,v])=>`data-${k}="${v}"`).join(' ');return`<button ${d} class="font-bold py-2 px-4 rounded-lg transition ${btn.class}">${btn.text}</button>`}).join('');document.getElementById('custom-modal').classList.remove('hidden');document.getElementById('custom-modal-panel').classList.remove('modal-fade-out');},
                hideModal(){const m=document.getElementById('custom-modal'),p=document.getElementById('custom-modal-panel');p.classList.add('modal-fade-out');p.addEventListener('animationend',()=>m.classList.add('hidden'),{once:true});},
                showToast(m,t='success'){const c=document.getElementById('toast-container'),el=document.createElement('div');el.className=`toast ${t==='success'?'bg-emerald-500':'bg-red-500'} text-white font-bold py-2 px-4 rounded-lg shadow-lg`;el.textContent=m;c.appendChild(el);setTimeout(()=>el.remove(),3000);},
            formatTime(seconds) { const m = Math.floor(seconds / 60); const s = seconds % 60; return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; },
            parseRepsValue(reps) {
                if (typeof reps === 'number' && !Number.isNaN(reps)) {
                    return reps;
                }
                if (typeof reps === 'string') {
                    const match = reps.match(/\d+/);
                    if (match) {
                        return parseInt(match[0], 10);
                    }
                }
                return 1;
            },
            estimateOneRepMax(weight, reps) {
                const numericWeight = typeof weight === 'number' ? weight : parseFloat(weight);
                const repsValue = this.parseRepsValue(reps);
                if (!numericWeight || Number.isNaN(numericWeight) || numericWeight <= 0 || !repsValue) {
                    return 0;
                }
                const estimate = numericWeight * (1 + repsValue / 30);
                return Math.round(estimate * 10) / 10;
            },
                playSound(type) { if(!this.audioCtx) return; const o=this.audioCtx.createOscillator(),g=this.audioCtx.createGain();o.connect(g);g.connect(this.audioCtx.destination);g.gain.setValueAtTime(0,this.audioCtx.currentTime);g.gain.linearRampToValueAtTime(0.3,this.audioCtx.currentTime+0.01);o.frequency.value=type==='start'?440:880;o.type='sine';o.start(this.audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.00001,this.audioCtx.currentTime+0.5);o.stop(this.audioCtx.currentTime+0.5); },
                switchCalculatorTab(tabId) { document.querySelectorAll('.calc-tab-content').forEach(el => el.classList.add('hidden')); document.getElementById(`tab-content-${tabId}`).classList.remove('hidden'); document.querySelectorAll('.calc-tab-btn').forEach(btn => { if (btn.dataset.tab === tabId) { btn.classList.add('bg-emerald-500', 'text-gray-900'); btn.classList.remove('text-gray-300'); } else { btn.classList.remove('bg-emerald-500', 'text-gray-900'); btn.classList.add('text-gray-300'); } }); },
                populateNutritionForm() { const { age, weight, height, gender } = this.state.physicalStats; document.getElementById('age').value = age; document.getElementById('weight').value = weight; document.getElementById('height').value = height; const genderRadio = document.querySelector(`#nutrition-form input[name="gender"][value="${gender}"]`); if (genderRadio) genderRadio.checked = true; },
                renderNutricionSection() { this.renderBmiCard(0, 0); document.getElementById('bodyfat-value').textContent = '--'; document.getElementById('ideal-weight-value').textContent = '--'; document.getElementById('water-intake-value').textContent = '-- L'; },
                calculateNutrition(formElement, showUI) {
                    const targetForm = formElement || document.getElementById('nutrition-form');
                    const shouldUpdateUI = typeof showUI === 'undefined' ? true : Boolean(showUI);

                    const gender = targetForm.querySelector('input[name="gender"]:checked').value;
                    const age = parseInt(targetForm.age.value);
                    const weight = parseFloat(targetForm.weight.value);
                    const height = parseInt(targetForm.height.value);
                    const activity = parseFloat(targetForm.activity.value);
                    const goal = targetForm.querySelector('input[name="goal"]:checked').value;

                    if (!age || !weight || !height) {
                        this.showToast("Rellena todos los campos.", "error");
                        return null;
                    }

                    this.state.physicalStats = { ...this.state.physicalStats, age, weight, height, gender, activity };
                    this.saveDataToFirestore();

                    const bmr = (gender === 'male')
                        ? (10 * weight + 6.25 * height - 5 * age + 5)
                        : (10 * weight + 6.25 * height - 5 * age - 161);
                    const tdee = bmr * activity;

                    let calories;
                    if (goal === 'lose') calories = tdee - 500;
                    else if (goal === 'gain') calories = tdee + 500;
                    else calories = tdee;

                    const results = {
                        calories: Math.round(calories),
                        protein: Math.round((calories * 0.3) / 4),
                        carbs: Math.round((calories * 0.4) / 4),
                        fats: Math.round((calories * 0.3) / 9)
                    };

                    if (shouldUpdateUI) {
                        document.getElementById('result-calories').textContent = `${results.calories} kcal`;
                        document.getElementById('result-protein').textContent = `${results.protein}g`;
                        document.getElementById('result-carbs').textContent = `${results.carbs}g`;
                        document.getElementById('result-fats').textContent = `${results.fats}g`;
                        document.getElementById('nutrition-results').classList.remove('hidden');
                        this.showToast("C√°lculos de nutrici√≥n actualizados", "success");
                    }

                    this._tempResults = results;
                    return results;
                },
                calculateBodyMetrics() { const { weight, height, age, gender } = this.state.physicalStats; if (!weight || !height || !age) { this.showToast("Completa tus datos en el perfil o en la pesta√±a de nutrici√≥n primero.", "error"); return; } const bmi = this.renderBmiCard(weight, height); const genderFactor = (gender === 'male') ? 1 : 0; const bodyFat = (1.20 * bmi) + (0.23 * age) - (10.8 * genderFactor) - 5.4; document.getElementById('bodyfat-value').textContent = bodyFat.toFixed(1); const heightInM = height / 100; const idealMin = 18.5 * (heightInM * heightInM); const idealMax = 24.9 * (heightInM * heightInM); document.getElementById('ideal-weight-value').textContent = `${idealMin.toFixed(1)} - ${idealMax.toFixed(1)} kg`; const waterLiters = (weight * 35) / 1000; document.getElementById('water-intake-value').textContent = waterLiters.toFixed(1); this.showToast("M√©tricas corporales calculadas."); },
                renderBmiCard(weight, height) { if(!weight || !height) { document.getElementById('bmi-value').textContent = '--'; document.getElementById('bmi-category').textContent = 'Sin calcular'; document.getElementById('bmi-category').className = 'font-semibold text-gray-400'; document.getElementById('bmi-marker').style.left = '0%'; return 0; } const heightInMeters = height / 100; const bmi = (weight / (heightInMeters * heightInMeters)); let category = '', colorClass = '', markerPosition = 0; if (bmi < 18.5) { category = 'Bajo Peso'; colorClass = 'text-sky-400'; markerPosition = (bmi / 18.5) * 25; } else if (bmi >= 18.5 && bmi < 25) { category = 'Normal'; colorClass = 'text-emerald-400'; markerPosition = 25 + ((bmi - 18.5) / (25 - 18.5)) * 30; } else if (bmi >= 25 && bmi < 30) { category = 'Sobrepeso'; colorClass = 'text-yellow-400'; markerPosition = 55 + ((bmi - 25) / (30 - 25)) * 25; } else { category = 'Obesidad'; colorClass = 'text-red-400'; markerPosition = 80 + ((bmi - 30) / (40 - 30)) * 20; } markerPosition = Math.max(2, Math.min(98, markerPosition)); document.getElementById('bmi-value').textContent = bmi.toFixed(1); const categoryEl = document.getElementById('bmi-category'); categoryEl.textContent = category; categoryEl.className = `font-semibold ${colorClass}`; document.getElementById('bmi-marker').style.left = `${markerPosition}%`; return bmi; },
                calculate1RM() { const weight = parseFloat(document.getElementById('1rm-weight').value); const reps = parseInt(document.getElementById('1rm-reps').value); if(!weight || !reps || weight <= 0 || reps <= 0) { this.showToast("Ingresa un peso y repeticiones v√°lidos.", "error"); return; } if (reps > 12) { this.showToast("El c√°lculo es menos preciso con m√°s de 12 reps.", "error"); } const oneRepMax = weight / (1.0278 - 0.0278 * reps); document.getElementById('1rm-result-value').textContent = `${oneRepMax.toFixed(1)} kg`; const projectionsContainer = document.getElementById('1rm-projections'); const repRanges = [3, 5, 8, 10, 12, 15]; projectionsContainer.innerHTML = repRanges.map(r => { const projectedWeight = oneRepMax * (1.0278 - 0.0278 * r); return `<div class="bg-gray-800/70 p-2 rounded-lg"><p class="font-bold text-lg text-purple-200">${projectedWeight.toFixed(1)}<span class="text-xs text-gray-400"> kg</span></p><p class="text-xs text-gray-400">${r} RM</p></div>`; }).join(''); document.getElementById('1rm-results').classList.remove('hidden'); },
                showEditTargetWeightModal() { const body = `<p class="text-gray-300 mb-4">Define el peso que quieres alcanzar.</p><input type="number" step="0.1" id="target-weight-input" value="${this.state.targetWeight}" class="w-full bg-gray-700 rounded-lg p-3 text-center text-xl">`; const footer = [ { text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }, { text: 'Guardar', class: 'bg-emerald-600 text-gray-900', action: 'save-target-weight' } ]; this.showModal('Editar Peso Objetivo', body, footer); },
                async handleUpdateTargetWeight() { const input = document.getElementById('target-weight-input'); const newTarget = parseFloat(input.value); if (isNaN(newTarget) || newTarget <= 0) { this.showToast('Por favor, introduce un peso v√°lido.', 'error'); return; } this.state.targetWeight = newTarget; await this.saveDataToFirestore(); this.renderProfileSection(); this.hideModal(); this.showToast('Objetivo de peso actualizado.'); },
                async handleAddWeightLog() { const input = document.getElementById('new-weight-input'); const newWeight = parseFloat(input.value); if (isNaN(newWeight) || newWeight <= 0) { this.showToast('Por favor, introduce un peso v√°lido.', 'error'); return; } const today = new Date().toISOString().split('T')[0]; if(!this.state.weightLog) this.state.weightLog = []; const existingIndex = this.state.weightLog.findIndex(entry => entry.date === today); if (existingIndex > -1) { this.state.weightLog[existingIndex].weight = newWeight; } else { this.state.weightLog.push({ date: today, weight: newWeight }); } this.state.physicalStats.weight = newWeight; input.value = ''; await this.saveDataToFirestore(); this.renderAll(); this.showToast('Nuevo peso registrado.'); },
                async saveNutritionGoals(){if(this._tempResults){this.state.userGoals={...this._tempResults};await this.saveDataToFirestore();this.renderAll();this.showToast("¬°Meta guardada!");this.showSection('dieta');}},
                renderDietPage(){if(!this.state.userGoals) return; const{calories,protein,carbs,fats}=this.state.userGoals;document.getElementById('diet-goal-calories').textContent=calories;document.getElementById('diet-goal-protein').textContent=protein;document.getElementById('diet-goal-carbs').textContent=carbs;document.getElementById('diet-goal-fats').textContent=fats;this.renderMealSections();this.updateDietSummary();},
                getFoodById(foodId) { return this.data.foodLibrary.find(item => item.id == foodId) || null; },
                
                renderMealSections(){
                    const container = document.getElementById('meal-sections');
                    const today = new Date().toISOString().split('T')[0];
                    const todayLog = this.state.dietLog ? (this.state.dietLog[today] || {}) : {};

                    if (!Array.isArray(this.state.dailyDiet)) {
                        container.innerHTML = `<p class="text-center text-gray-500">Formato de dieta no v√°lido.</p>`;
                        return;
                    }

                    container.innerHTML = this.state.dailyDiet.map((meal, mealIndex) => {
                        const totalCals = meal.items.reduce((sum, item) => sum + item.totalCals, 0);
                        const mealLog = todayLog[meal.id] || [];

                        const itemsHTML = meal.items.length > 0
                            ? meal.items.map((item, itemIndex) => {
                                const isCompleted = mealLog[itemIndex] === true;
                                const textClasses = isCompleted ? 'line-through text-gray-500' : 'text-white';
                                
                                if (this.isAsesor()) {
                                    return `<div class="bg-gray-800/50 p-2 rounded-md flex justify-between items-center text-sm">
                                        <div>
                                            <p class="${textClasses}">${item.name} <span class="text-gray-400">(${item.amount || 'N/A'}g)</span></p>
                                            <p class="text-xs text-gray-400">P:${item.totalP}g C:${item.totalC}g G:${item.totalF}g</p>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="font-semibold text-emerald-400">${item.totalCals} kcal</span>
                                            <button data-action="confirm-remove-food" data-meal-index="${mealIndex}" data-item-index="${itemIndex}" class="text-red-400 hover:text-red-300 text-xl leading-none p-1">&times;</button>
                                        </div>
                                    </div>`;
                                }
                                
                                return `<div class="bg-gray-800/50 p-2 rounded-md flex justify-between items-center text-sm">
                                    <label class="flex items-center space-x-3 flex-grow cursor-pointer">
                                        <input type="checkbox" data-action="toggle-food-completion" data-meal-index="${mealIndex}" data-item-index="${itemIndex}" class="w-5 h-5 bg-gray-700 border-gray-600 rounded text-emerald-500 focus:ring-emerald-500/50" ${isCompleted ? 'checked' : ''}>
                                        <div>
                                            <p class="${textClasses}">${item.name} <span class="text-gray-400">(${item.amount || 'N/A'}g)</span></p>
                                            <p class="text-xs text-gray-400">P:${item.totalP}g C:${item.totalC}g G:${item.totalF}g</p>
                                        </div>
                                    </label>
                                    <span class="font-semibold text-emerald-400 ml-2">${item.totalCals} kcal</span>
                                </div>`;
                              }).join('')
                            : `<p class="text-sm text-gray-500">${this.isAsesor() ? 'A√±ade alimentos a esta comida.' : 'No hay alimentos asignados.'}</p>`;

                        const recipeButton = meal.items.length > 0 && this.isAsesor() ? `<button data-action="get-recipe" data-meal-index="${mealIndex}" class="text-xs bg-purple-600/50 hover:bg-purple-600/80 text-purple-200 font-semibold py-1 px-2 rounded-md flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i>Receta</button>` : '';
                        
                        return `<div class="bg-gray-700/50 p-4 rounded-xl">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg text-white">${meal.name}</h3>
                                    <p class="text-xs text-gray-400 font-mono"><i data-lucide="clock" class="w-3 h-3 inline-block -mt-0.5"></i> ${meal.time}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    ${recipeButton}
                                    <p class="text-sm text-gray-400">Total: <span class="font-bold text-white">${Math.round(totalCals)} kcal</span></p>
                                </div>
                            </div>
                            <div class="mt-2 space-y-2">${itemsHTML}</div>
                        </div>`;
                    }).join('');
                    
                    lucide.createIcons();
                },

                async toggleFoodCompletion(mealIndex, itemIndex) {
                    const meal = this.state.dailyDiet[mealIndex];
                    if (!meal) return;
                    
                    const today = new Date().toISOString().split('T')[0];
                    if (!this.state.dietLog) { this.state.dietLog = {}; }
                    if (!this.state.dietLog[today]) { this.state.dietLog[today] = {}; }
                    
                    if (!this.state.dietLog[today][meal.id]) {
                        this.state.dietLog[today][meal.id] = meal.items.map(() => false);
                    }
                    
                    const currentStatus = this.state.dietLog[today][meal.id][itemIndex];
                    this.state.dietLog[today][meal.id][itemIndex] = !currentStatus;

                    await this.saveDataToFirestore();
                    this.renderMealSections();
                    this.updateDietSummary();
                },

                showAddFoodModal(foodId){const f = this.getFoodById(foodId);if(!f)return;const b=`<p class="mb-4">A√±adir <strong>${f.name}</strong> a una comida.</p><div><label for="food-amount" class="block text-sm font-medium text-gray-300 mb-1">Cantidad (g)</label><input type="number" id="food-amount" value="100" class="w-full bg-gray-700 rounded-lg p-2 text-center"></div><div class="mt-4"><label class="block text-sm font-medium text-gray-300 mb-2">Selecciona la comida</label><div class="grid grid-cols-2 gap-2">${this.state.dailyDiet.map((m,i)=>`<button data-action="add-food-to-meal" data-food-id="${f.id}" data-meal-index="${i}" class="bg-gray-600 p-2 rounded-lg hover:bg-gray-500">${m.name}</button>`).join('')}</div></div>`;this.showModal('A√±adir Alimento',b,[{text:'Cancelar',class:'bg-gray-600 hover:bg-gray-500',action:'hide-modal'}]);},
                async addFoodToMealFromModal(foodId,mealIndex){const a=parseInt(document.getElementById('food-amount').value);if(isNaN(a)||a<=0){this.showToast("Cantidad inv√°lida.","error");return;}const f = this.getFoodById(foodId);if (!f) { this.showToast("Alimento no encontrado.", "error"); return; }const fac=a/100;this.state.dailyDiet[mealIndex].items.push({...f,amount:a,totalCals:Math.round((f.cals || 0)*fac),totalP:Math.round((f.p || 0)*fac),totalC:Math.round((f.c || 0)*fac),totalF:Math.round((f.f || 0)*fac)});await this.saveDataToFirestore();this.renderAll();this.hideModal();this.showToast(`${f.name} a√±adido a ${this.state.dailyDiet[mealIndex].name}.`);},
                confirmRemoveFoodFromMeal(mealIndex,itemIndex){this.showModal('Confirmar Eliminaci√≥n','¬øSeguro que quieres eliminar este alimento?',[{text:'Cancelar',class:'bg-gray-600 hover:bg-gray-500',action:'hide-modal'},{text:'Eliminar',class:'bg-red-600 hover:bg-red-500',action:'remove-food','meal-index':mealIndex,'item-index':itemIndex}]);},
                async removeFoodFromMeal(mealIndex,itemIndex){this.state.dailyDiet[mealIndex].items.splice(itemIndex,1);await this.saveDataToFirestore();this.renderAll();this.hideModal();this.showToast('Alimento eliminado.','error');},
                async callGeminiAPI(prompt, button = null) {if (!this.apiKey) { this.showToast("API Key de Gemini no configurada.", "error"); throw new Error("API Key is missing."); }let originalButtonHTML;if(button) { originalButtonHTML = button.innerHTML; button.disabled = true; button.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>`; lucide.createIcons(); }try {const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${this.apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });if (!response.ok) throw new Error('Error en la respuesta de la API.');const result = await response.json();if (!result.candidates || result.candidates.length === 0) throw new Error('Respuesta inv√°lida de la API.');return result.candidates[0].content.parts[0].text;} catch (error) { console.error("Error en llamada a Gemini:", error); this.showToast(error.message || "Error al contactar la IA.", "error"); throw error;} finally { if (button) { button.disabled = false; button.innerHTML = originalButtonHTML; lucide.createIcons(); } }},
                async getDailyTip() {const tipCard = document.getElementById('ai-daily-tip-card');const tipTextEl = document.getElementById('ai-daily-tip-text');if (!tipCard || !tipTextEl) return;tipCard.classList.remove('hidden');const today = new Date().toISOString().split('T')[0];const storedTip = localStorage.getItem('fitTrackDailyTip');if (storedTip) { const tipData = JSON.parse(storedTip); if (tipData.date === today) { tipTextEl.textContent = tipData.tip; lucide.createIcons(); return; } }try {const prompt = "Dame un consejo de fitness corto, motivador e inspirador (menos de 25 palabras) para hoy. Debe ser en espa√±ol.";const tip = await this.callGeminiAPI(prompt);const newTipData = { date: today, tip: tip.trim() };localStorage.setItem('fitTrackDailyTip', JSON.stringify(newTipData));tipTextEl.textContent = tip.trim();} catch (error) { tipTextEl.textContent = "El esfuerzo de hoy es el √©xito de ma√±ana. ¬°No te rindas!"; } finally { lucide.createIcons(); }},
                async analyzeFoodWithAI() {const input = document.getElementById('food-analysis-input');const foodDescription = input.value.trim();if (!foodDescription) { this.showToast("Describe una comida para analizar.", "error"); return; }const button = document.querySelector('button[data-action="analyze-food"]');const prompt = `Estima las calor√≠as y los macronutrientes (prote√≠nas, carbohidratos, grasas) para la siguiente comida: "${foodDescription}". Responde √∫nicamente con un objeto JSON v√°lido con el formato: {"name": "Nombre descriptivo", "cals": numero, "p": numero, "c": numero, "f": numero}. No incluyas unidades (como "g" o "kcal"), comentarios ni explicaciones adicionales, solo el JSON.`;try {const textResponse = await this.callGeminiAPI(prompt, button);const cleanJsonString = textResponse.replace(/```json|```/g, '').trim();const foodData = JSON.parse(cleanJsonString);const targetMealIndex = this.state.dailyDiet.length - 1; if (targetMealIndex >= 0) {this.state.dailyDiet[targetMealIndex].items.push({ id: `ai-${Date.now()}`, name: foodData.name || foodDescription, amount: 'N/A', totalCals: foodData.cals, totalP: foodData.p, totalC: foodData.c, totalF: foodData.f, });this.showToast(`${foodData.name || 'Comida'} a√±adida a la dieta.`);input.value = '';await this.saveDataToFirestore(); this.renderAll();} else { this.showToast("No hay comidas para a√±adir el alimento.", "error"); }} catch (error) {}},
                async getRecipeForMeal(mealIndex) {const meal = this.state.dailyDiet[mealIndex];if (!meal || meal.items.length === 0) { this.showToast("A√±ade alimentos a la comida primero.", "error"); return; }const ingredientsList = meal.items.map(item => `${item.name.split('(')[0].trim()} (${item.amount}g)`).join(', ');this.showModal('Generando Receta ‚ú®', '<div class="flex justify-center items-center p-8"><i data-lucide="loader-2" class="w-10 h-10 animate-spin text-purple-400"></i></div>', []);lucide.createIcons();const prompt = `Eres un chef experto en comida saludable. Crea una receta simple y deliciosa usando los siguientes ingredientes: ${ingredientsList}. El objetivo es una comida saludable. Proporciona un nombre creativo para el plato, una lista de ingredientes y las instrucciones paso a paso. Formatea tu respuesta como HTML simple, usando <h2> para el nombre del plato, <h3> para los encabezados (Ingredientes, Instrucciones), y <ul> o <ol> para las listas.`;try {const recipeHtml = await this.callGeminiAPI(prompt);const body = `<div class="text-left prose prose-invert prose-sm max-w-none">${recipeHtml}</div>`;this.showModal(`Receta para ${meal.name} ‚ú®`, body, [{ text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }]);} catch (error) { this.hideModal(); }},
                async showExerciseInfoModal(exerciseName) { const exercise = this.getExerciseByName(exerciseName); let mediaHtml = ''; if (exercise && exercise.mediaUrl) { const isVideo = exercise.mediaUrl.includes('.mp4') || exercise.mediaUrl.includes('video'); if (isVideo) { mediaHtml = `<div class="mb-4 rounded-lg overflow-hidden bg-gray-900"><video src="${exercise.mediaUrl}" autoplay loop muted playsinline class="w-full h-auto object-cover"></video></div>`; } else { mediaHtml = `<div class="mb-4 rounded-lg overflow-hidden bg-gray-900"><img src="${exercise.mediaUrl}" alt="Demostraci√≥n de ${exercise.name}" class="w-full h-auto object-cover"></div>`; } } else { mediaHtml = `<div class="mb-4 p-4 text-center bg-gray-700/50 rounded-lg text-sm text-gray-400">No hay video/GIF disponible para este ejercicio.</div>`; } this.showModal(`Info: ${exerciseName}`, `${mediaHtml}<div id="ai-instructions-container"><div class="flex justify-center items-center p-4"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-sky-400"></i></div></div>`, [{ text: 'Entendido', class: 'bg-emerald-600 text-gray-900', action: 'hide-modal' }]); lucide.createIcons(); const prompt = `Eres un entrenador personal certificado. Proporciona instrucciones claras y concisas sobre c√≥mo realizar el ejercicio "${exerciseName}". Incluye una secci√≥n de "M√∫sculos Principales" y una secci√≥n de "Errores Comunes" a evitar. Formatea la respuesta como HTML simple, usando <h3> para los encabezados y <ul> para las listas.`; try { const instructionsHtml = await this.callGeminiAPI(prompt); document.getElementById('ai-instructions-container').innerHTML = `<div class="text-left prose prose-invert prose-sm max-w-none">${instructionsHtml}</div>`; } catch (error) { document.getElementById('ai-instructions-container').innerHTML = `<p class="text-sm text-red-400">No se pudieron cargar las instrucciones.</p>`; } },
                async generatePlanWithAI() {const button = document.querySelector('button[data-action="generate-plan"]');const { calories, protein, carbs, fats } = this.state.userGoals;const prompt = `Crea un plan de comidas de ejemplo para un d√≠a completo que cumpla con los siguientes objetivos nutricionales: ${calories} kcal, ${protein}g de prote√≠na, ${carbs}g de carbohidratos y ${fats}g de grasas. El plan debe dividirse en 3 comidas: Desayuno, Almuerzo y Cena. Para cada comida, lista los alimentos y sus cantidades aproximadas en gramos. Responde √∫nicamente con un objeto JSON v√°lido con el formato: {"Desayuno": [{"name": "nombre_alimento", "amount": cantidad_gramos}], "Almuerzo": [...], "Cena": [...]}. No incluyas comentarios ni explicaciones adicionales, solo el JSON.`;try {const textResponse = await this.callGeminiAPI(prompt, button);const cleanJsonString = textResponse.replace(/```json|```/g, '').trim();const mealPlan = JSON.parse(cleanJsonString); this.state.dailyDiet = []; const mealNames = Object.keys(mealPlan);const timeMap = {'Desayuno': '08:00', 'Almuerzo': '13:00', 'Cena': '20:00'}; mealNames.forEach((mealName, index) => {const mealData = {id: `meal-${Date.now() + index}`, name: mealName, time: timeMap[mealName] || '12:00', items: []}; mealPlan[mealName].forEach(food => {const searchTerm = food.name.toLowerCase().split('(')[0].trim().replace(/de|en|con/g, '').trim().split(' ')[0];let dbFood = this.data.foodLibrary.find(f => f.name.toLowerCase().includes(searchTerm)); let foodEntry; if (dbFood) { const factor = food.amount / 100; foodEntry = { ...dbFood, name: `${food.name}`, amount: food.amount, totalCals: Math.round((dbFood.cals||0) * factor), totalP: Math.round((dbFood.p||0) * factor), totalC: Math.round((dbFood.c||0) * factor), totalF: Math.round((dbFood.f||0) * factor) }; } else { foodEntry = { name: food.name, amount: food.amount, totalCals: 150, totalP: 10, totalC: 15, totalF: 5 }; } mealData.items.push(foodEntry);}); this.state.dailyDiet.push(mealData); });this.showToast("¬°Plan de dieta generado!");await this.saveDataToFirestore(); this.renderAll();} catch (error) {}},
                async routine_generateExercisesWithAi() { const goalInput = document.getElementById('ai-goal-input'); const goal = goalInput.value.trim(); if (!goal) { this.showToast("Describe tu objetivo.", "error"); return; } const button = document.querySelector('button[data-action="generate-exercises-ai"]'); const prompt = `Basado en el siguiente objetivo de entrenamiento: "${goal}", sugiere entre 5 y 7 ejercicios. Responde √öNICAMENTE con un array JSON de strings, como: ["nombre_ejercicio_1", "nombre_ejercicio_2", ...]. No incluyas texto adicional ni formato markdown. Aseg√∫rate de que los nombres de los ejercicios sean comunes en el gimnasio.`; try { const textResponse = await this.callGeminiAPI(prompt, button); const cleanJsonString = textResponse.replace(/```json|```/g, '').trim(); const exercises = JSON.parse(cleanJsonString); const currentDayIndex = this._tempRoutine.currentDayIndex; if (Array.isArray(exercises)) { exercises.forEach(exName => { this._tempRoutine.plan[currentDayIndex].exercises.push({ name: exName, sets: 4, reps: '10', rest: '60s' }); }); this.hideModal(); this.routine_refreshExerciseList(); this.showToast('¬°Ejercicios sugeridos por IA a√±adidos!'); } else { throw new Error('El formato de respuesta de la IA no es v√°lido.'); } } catch (error) { this.showToast("No se pudo procesar la sugerencia de la IA. Int√©ntalo de nuevo.", "error"); } },
                async analyzeWorkoutPerformance(e) {const button = e.target.closest('[data-action="analyze-workout-performance"]');const logDataString = button.dataset.logData;const log = JSON.parse(decodeURIComponent(logDataString));const goal = document.querySelector('#nutrition-form input[name="goal"]:checked')?.value || 'maintain';const goalMap = { lose: 'perder peso', maintain: 'mantenimiento', gain: 'ganar m√∫sculo' };const userGoalText = goalMap[goal];const prompt = `Eres un entrenador de fitness positivo y motivador. Mi objetivo principal es ${userGoalText}. Este es mi registro de entrenamiento de hoy: ${JSON.stringify(log)}. Proporciona un an√°lisis breve (menos de 75 palabras), en espa√±ol, sobre mi rendimiento. Destaca un aspecto positivo y sugiere una mejora simple y espec√≠fica para mi pr√≥xima sesi√≥n. Envuelve el aspecto positivo en etiquetas <strong> y la sugerencia en etiquetas <em>.`;try {const analysisText = await this.callGeminiAPI(prompt, button);const container = document.getElementById('ai-analysis-container');if (container) { container.innerHTML = `<div class="mt-4 pt-4 border-t border-gray-700 text-left"><h4 class="font-bold text-gray-200 flex items-center gap-2"><i data-lucide="sparkles" class="w-5 h-5 text-purple-400"></i>An√°lisis del Coach IA</h4><p class="text-sm text-gray-300 mt-2 bg-gray-900/50 p-3 rounded-lg">${analysisText}</p></div>`; lucide.createIcons(); button.style.display = 'none'; }} catch (error) {}},
                routine_showAiSuggestionModal() { const body = `<p class="text-gray-300 mb-4">Describe el objetivo para este d√≠a de entrenamiento y la IA te sugerir√° ejercicios.</p><div><label for="ai-goal-input" class="block text-sm font-medium text-gray-400 mb-1">Objetivo del d√≠a</label><input type="text" id="ai-goal-input" class="w-full bg-gray-700 rounded-lg p-2 mt-1 border border-gray-600" placeholder="Ej: Hipertrofia para pecho y hombro"></div>`; const footer = [ {text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal'}, {text: '‚ú® Generar', class: 'bg-emerald-600 hover:bg-emerald-500 text-gray-900', action: 'generate-exercises-ai'} ]; this.showModal('Sugerencias de la IA', body, footer); setTimeout(() => document.getElementById('ai-goal-input').focus(), 100); },
                getExerciseByName(name) { for (const group in this.data.exerciseLibrary) { for (const subGroup in this.data.exerciseLibrary[group]) { const exercise = this.data.exerciseLibrary[group][subGroup].find(ex => ex.name === name); if (exercise) return exercise; } } return null; },
                renderRoutinesSection() { const userRoutinesContainer = document.getElementById('user-routines-container'); const predefinedRoutinesContainer = document.getElementById('predefined-routines-section'); if (!userRoutinesContainer || !predefinedRoutinesContainer) return; if (this.state.userRoutines && this.state.userRoutines.length > 0) { userRoutinesContainer.innerHTML = this.state.userRoutines.map(r => this.routine_createUserCardHTML(r)).join(''); } else { userRoutinesContainer.innerHTML = `<div class="flex flex-col items-center justify-center w-64 h-40 text-center p-4 bg-gray-700/50 rounded-2xl border-2 border-dashed border-gray-600"><i data-lucide="folder-plus" class="w-8 h-8 text-gray-500 mb-2"></i><p class="text-gray-400 text-sm">${this.isAsesor() ? 'Crea tu primera rutina' : 'No tienes una rutina asignada.'}</p></div>`; } let predefinedHtml = ''; const categoryTitles = { "Cl√°sicos de Hipertrofia": "üèÜ Cl√°sicos de Hipertrofia", "Fuerza y Potencia": "‚ö° Fuerza y Potencia", "Enfoque Femenino": "üå∏ Enfoque Femenino", "Alta Intensidad": "üî• Alta Intensidad", "Quema de Grasa": "üíß Quema de Grasa" }; for (const category in this.data.predefinedRoutines) { const title = categoryTitles[category] || category.replace(/_/g, ' '); predefinedHtml += `<div class="mb-6"><h4 class="font-bold text-xl mb-3 text-emerald-300 capitalize">${title}</h4><div class="space-y-3">`; const routinesInCategory = this.data.predefinedRoutines[category]; predefinedHtml += routinesInCategory.map(r => this.routine_createPredefinedCardHTML(r)).join(''); predefinedHtml += `</div></div>`; } predefinedRoutinesContainer.innerHTML = predefinedHtml; lucide.createIcons(); },
                routine_createUserCardHTML(routine) {
    const days = routine.plan.length;
    const totalExercises = routine.plan.reduce((acc, day) => acc + day.exercises.length, 0);

    const hasCover = routine.coverImageUrl;
    const backgroundStyle = hasCover 
        ? `style="background-image: url('${routine.coverImageUrl}');"`
        : '';
    const backgroundClasses = hasCover
        ? 'bg-cover bg-center'
        : 'bg-gradient-to-br from-gray-700 to-gray-800';

    const overlayHTML = hasCover ? '<div class="absolute inset-0 bg-black/60 rounded-2xl"></div>' : '';

    return `
        <button data-action="routine-show-details" data-routine-id="${routine.id}" 
                class="relative flex-shrink-0 w-64 h-40 ${backgroundClasses} rounded-2xl p-4 flex flex-col justify-between text-left hover:ring-2 hover:ring-emerald-400 transition-all shadow-lg overflow-hidden" 
                ${backgroundStyle}>
            ${overlayHTML}
            <div class="relative z-10">
                <h4 class="font-bold text-lg text-white truncate">${routine.name}</h4>
                <p class="text-sm text-gray-300 mt-1 line-clamp-2">${routine.description || 'Sin descripci√≥n'}</p>
            </div>
            <div class="relative z-10 flex items-center gap-4 text-xs text-gray-300 font-medium">
                <div class="flex items-center gap-1.5"><i data-lucide="calendar-days" class="w-3.5 h-3.5"></i><span>${days} ${days > 1 ? 'd√≠as' : 'd√≠a'}</span></div>
                <div class="flex items-center gap-1.5"><i data-lucide="repeat" class="w-3.5 h-3.5"></i><span>${totalExercises} ej.</span></div>
            </div>
        </button>`;
},
                routine_createPredefinedCardHTML(routine) { return `<button data-action="routine-show-details" data-routine-id="${routine.id}" class="w-full bg-gray-700 rounded-2xl p-4 flex items-center space-x-4 text-left hover:bg-gray-600/80 transition-colors"><div class="bg-gray-800 p-3 rounded-lg"><i data-lucide="${routine.icon || 'activity'}" class="text-emerald-400"></i></div><div class="flex-1"><h4 class="font-bold text-white">${routine.name}</h4><p class="text-sm text-gray-400">${routine.description}</p></div><i data-lucide="chevron-right" class="text-gray-500"></i></button>`; },
                
                routine_showDetails(routineId) {
                    const allRoutines = [...(this.state.userRoutines || []), ...Object.values(this.data.predefinedRoutines).flat()];
                    const routine = allRoutines.find(r => r.id === routineId);
                    if (!routine) return;

                    const today = new Date().toISOString().split('T')[0];
                    const todayEntries = Array.isArray(this.state.workoutHistory?.[today]) ? this.state.workoutHistory[today] : [];

                    const daysHTML = routine.plan.map((day, dayIndex) => {
                        const latestEntryToday = todayEntries.slice().reverse().find(entry => entry.routineId === routine.id && entry.dayIndex === dayIndex);
                        const isCompletedToday = Boolean(latestEntryToday);

                        let actionBlockHTML = '';
                        if (isCompletedToday) {
                            const totalWeight = latestEntryToday.exerciseDetails
                                ? latestEntryToday.exerciseDetails.reduce((total, exercise) => total + exercise.weights.reduce((sum, weight) => sum + weight, 0), 0)
                                : 0;
                            actionBlockHTML = `
                            <div class="mt-4 bg-emerald-900/50 border border-emerald-500/30 text-emerald-300 rounded-xl p-4 space-y-3">
                                <p class="text-center font-bold text-lg flex items-center justify-center gap-2"><i data-lucide="check-circle-2"></i> COMPLETADO HOY</p>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                                    <div class="flex justify-between border-b border-white/10 pb-1"><span>Peso total:</span> <span class="font-bold">${totalWeight.toFixed(1)} kg</span></div>
                                    <div class="flex justify-between border-b border-white/10 pb-1"><span>Tiempo activo:</span> <span class="font-bold">${this.formatTime(latestEntryToday.totalActive)}</span></div>
                                    <div class="flex justify-between border-b border-white/10 pb-1"><span>Descanso:</span> <span class="font-bold">${this.formatTime(latestEntryToday.totalRest)}</span></div>
                                    <div class="flex justify-between border-b border-white/10 pb-1"><span>Volumen:</span> <span class="font-bold">${new Intl.NumberFormat('es-ES').format(Math.round(latestEntryToday.totalVolume || 0))} kg¬∑reps</span></div>
                                </div>
                            </div>`;
                        } else {
                            actionBlockHTML = `<button data-action="start-workout" data-routine-id="${routine.id}" data-day-index="${dayIndex}" class="w-full bg-emerald-600 text-gray-900 font-bold py-2.5 rounded-lg mt-3 hover:bg-emerald-500 transition flex items-center justify-center gap-2"><i data-lucide="play" class="w-5 h-5"></i><span>Comenzar Entrenamiento</span></button>`;
                        }

                        return `<div class="bg-gray-900/50 rounded-xl p-4">
                                    <h4 class="font-bold text-lg text-emerald-300">${day.day}</h4>
                                    <ul class="text-gray-300 space-y-2 text-sm divide-y divide-gray-700/50 mt-3">
                                        ${day.exercises.map(ex => `<li class="flex justify-between items-center pt-2"><button data-action="show-exercise-info" data-exercise-name="${ex.name}" class="flex items-center gap-2 text-left flex-1 pr-4 group"><i data-lucide="help-circle" class="w-4 h-4 text-gray-500 group-hover:text-sky-400 transition-colors"></i><span class="group-hover:text-white transition-colors">${ex.name}</span></button> <span class="text-gray-400 font-mono bg-gray-700/80 px-2 py-1 text-xs rounded-md">${ex.sets}x${ex.reps}</span></li>`).join('')}
                                    </ul>
                                    ${actionBlockHTML}
                                </div>`;
                    }).join('');

                    const isUserRoutine = routine.id.startsWith('manual-'); 
                    const deleteButtonHTML = isUserRoutine && this.isAsesor() ? `<button data-action="routine-confirm-delete" data-routine-id="${routine.id}" class="text-red-400 hover:text-red-300 p-2 rounded-full hover:bg-red-500/10"><i data-lucide="trash-2" class="w-5 h-5"></i></button>` : '<div class="w-9 h-9"></div>'; 
                    const viewHTML = `<div id="routine-details-view" class="fullscreen-view bg-gray-800 w-full h-full flex flex-col"><header class="p-4 flex items-center justify-between bg-gray-900/80 backdrop-blur-sm sticky top-0"><button data-action="routine-close-view" class="p-2 rounded-full hover:bg-gray-700"><i data-lucide="arrow-left"></i></button><h3 class="text-lg font-bold truncate px-4">${routine.name}</h3>${deleteButtonHTML}</header><div class="flex-grow p-4 overflow-y-auto space-y-4"><p class="text-gray-400 bg-gray-700/50 p-3 rounded-lg text-sm">${routine.description}</p>${daysHTML}</div></div>`;
                    this.routine_openFullscreenView(viewHTML);
                },

                routine_enterCreator(step) {
                    if (this._boundHandleDrawerResize) {
                        window.removeEventListener('resize', this._boundHandleDrawerResize);
                        this._boundHandleDrawerResize = null;
                    }

                    const targetStep = typeof step === 'undefined' ? 1 : step;
                    if (targetStep === 1) {
                        this._tempRoutine = { id: `manual-${Date.now()}`, name: '', description: '', coverImageUrl: null, plan: [{ day: 'D√≠a 1: Mi Rutina', exercises: [] }], currentDayIndex: 0, editingIndex: -1, editingClientId: null, assignedClientId: '', activeExerciseGroup: '' };
                    }
                    const viewHTML = `<div id="routine-creator-view" class="fullscreen-view bg-gray-900 w-full min-h-screen flex flex-col overflow-hidden">${this.routine_getCreatorContent(targetStep)}</div>`;
                    this.routine_openFullscreenView(viewHTML);

                    if (targetStep === 1) {
                        document.getElementById('routine-cover-image-input')?.addEventListener('change', (e) => this.routine_handleCoverImageSelect(e));
                    }

                    if (targetStep === 2) {
                        this.routine_refreshDayTabs();
                        this.routine_refreshExerciseList();
                        const activeGroup = this._tempRoutine.activeExerciseGroup || Object.keys(this.data.exerciseLibrary)[0];
                        if (activeGroup) {
                            this.routine_creator_switchGroup(activeGroup);
                        }

                        const panel = document.getElementById('exercise-list-panel');
                        if (panel) {
                            panel.dataset.mobileVisible = window.innerWidth >= 768 ? 'true' : 'false';
                        }

                        this._boundHandleDrawerResize = this.routine_creator_handleDrawerResize.bind(this);
                        window.addEventListener('resize', this._boundHandleDrawerResize);
                        this.routine_creator_handleDrawerResize();
                    }
                },
                routine_getCreatorContent(step) {
                    if (step === 1) {
                        return `
                            <div class="min-h-full flex flex-col bg-gradient-to-b from-gray-950 via-gray-900 to-gray-950">
                                <header class="sticky top-0 z-10 border-b border-white/5 bg-gray-950/80 backdrop-blur">
                                    <div class="mx-auto flex w-full max-w-5xl items-center justify-between px-4 py-4 sm:px-6">
                                        <button data-action="routine-close-view" class="rounded-full bg-white/5 p-2 text-gray-400 transition hover:text-white"><i data-lucide="x"></i></button>
                                        <div class="text-center">
                                            <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-300/80">Crear Rutina</p>
                                            <p class="mt-1 text-sm font-semibold text-white">Paso 1 ¬∑ Detalles principales</p>
                                        </div>
                                        <div class="h-9 w-9"></div>
                                    </div>
                                    <div class="h-1 w-full bg-white/5">
                                        <div class="h-full w-1/2 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400"></div>
                                    </div>
                                </header>
                                <div class="flex-1 overflow-y-auto">
                                    <div class="mx-auto flex w-full max-w-5xl flex-col gap-10 px-4 py-8 sm:px-6 sm:py-10">
                                        <section class="overflow-hidden rounded-3xl border border-white/5 bg-white/5 shadow-[0_35px_120px_-60px_rgba(16,185,129,0.85)]">
                                            <div class="grid gap-10 p-6 sm:p-10 lg:grid-cols-[minmax(0,1fr)_minmax(0,1.15fr)]">
                                                <div class="flex flex-col gap-4">
                                                    <div>
                                                        <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/70">Imagen de portada</p>
                                                        <p class="mt-2 text-sm text-gray-300">Resalta tu rutina con una portada envolvente para motivar a tus asesorados.</p>
                                                    </div>
                                                    <label for="routine-cover-image-input" class="group relative block aspect-[4/3] overflow-hidden rounded-2xl border border-white/10 bg-gray-950/60 transition hover:border-emerald-400/60">
                                                        <input type="file" accept="image/*" id="routine-cover-image-input" class="absolute inset-0 h-full w-full cursor-pointer opacity-0">
                                                        <div id="cover-image-placeholder" class="flex h-full flex-col items-center justify-center gap-3 text-gray-400">
                                                            <span class="grid h-16 w-16 place-items-center rounded-full border border-white/10 bg-white/5 text-white transition group-hover:border-emerald-400/50 group-hover:text-emerald-200">
                                                                <i data-lucide="image"></i>
                                                            </span>
                                                            <div class="text-center">
                                                                <p class="text-sm font-semibold text-white">Arrastra o selecciona una imagen</p>
                                                                <p class="text-xs text-gray-500">Ideal 1280 √ó 720 px</p>
                                                            </div>
                                                        </div>
                                                        <img id="routine-cover-preview" class="hidden h-full w-full object-cover" alt="Vista previa de la portada">
                                                    </label>
                                                    <div id="cover-upload-progress-container" class="hidden items-center gap-3 rounded-2xl border border-white/10 bg-gray-950/70 px-4 py-3">
                                                        <div class="h-2 flex-1 overflow-hidden rounded-full bg-white/10">
                                                            <div id="cover-upload-progress-bar" class="h-full w-0 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 transition-[width] duration-300"></div>
                                                        </div>
                                                        <span id="cover-upload-progress-text" class="text-xs font-semibold text-gray-300"></span>
                                                    </div>
                                                </div>
                                                <div class="flex flex-col gap-6">
                                                    <div>
                                                        <label for="routine-name-input" class="text-sm font-semibold text-gray-200">Nombre de la rutina</label>
                                                        <input id="routine-name-input" type="text" placeholder="Ej. Fuerza Total" class="mt-2 w-full rounded-2xl border border-white/10 bg-gray-950/60 px-4 py-3 text-white shadow-inner focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400" value="${this._tempRoutine?.name || ''}">
                                                    </div>
                                                    <div class="flex flex-col gap-3">
                                                        <label for="routine-desc-input" class="text-sm font-semibold text-gray-200">Descripci√≥n</label>
                                                        <textarea id="routine-desc-input" rows="6" placeholder="Describe objetivos, nivel de intensidad y sensaciones que buscar√° esta rutina." class="w-full resize-none rounded-2xl border border-white/10 bg-gray-950/60 px-4 py-3 text-white shadow-inner focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">${this._tempRoutine?.description || ''}</textarea>
                                                    </div>
                                                    <div class="flex flex-col gap-4 text-sm text-gray-400 sm:flex-row sm:items-center sm:justify-between">
                                                        <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-emerald-200/80">
                                                            <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
                                                            <span>50% Completado</span>
                                                        </div>
                                                        <button data-action="routine-creator-next" class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 px-6 py-3 font-semibold text-gray-900 transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                                            <span>Siguiente paso</span>
                                                            <i data-lucide="arrow-right"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    if (step === 2) {
                        const isAdmin = this.isAsesor();
                        const assignedClientId = this._tempRoutine.assignedClientId || this._tempRoutine.editingClientId;
                        const assignedClient = assignedClientId ? (this.state.asesorados || []).find(c => c.id === assignedClientId) : null;
                        const assignmentInfo = assignedClient ? `<div class="mt-3 inline-flex items-center gap-2 rounded-full border border-emerald-300/30 bg-emerald-500/10 px-4 py-1 text-sm font-semibold text-emerald-200/90"><i data-lucide="user-check" class="h-4 w-4"></i><span>Asignada a ${assignedClient.userName}</span></div>` : '';
                        const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex] || { day: '', exercises: [] };
                        const dayName = currentDay.day || `D√≠a ${this._tempRoutine.currentDayIndex + 1}`;
                        const totalDays = this._tempRoutine.plan.length;
                        const totalExercises = currentDay.exercises.length;
                        const groupImages = this.data.exerciseGroupImages || {};
                        const groupKeys = Object.keys(this.data.exerciseLibrary);
                        const firstGroup = groupKeys[0] || '';
                        const activeGroup = this._tempRoutine.activeExerciseGroup || firstGroup;
                        const routineName = (this._tempRoutine.name || '').trim() || 'Rutina sin t√≠tulo';
                        this._tempRoutine.activeExerciseGroup = activeGroup;
                        const groupsNav = `<aside id="exercise-group-nav" class="w-full shrink-0 border-b border-white/5 bg-gray-950/80 md:w-80 md:border-b-0 md:border-r md:max-h-[calc(100vh-8rem)] md:overflow-y-auto">
                            <div class="grid gap-4 p-5">
                                ${groupKeys.map(group => {
                                        const rawUrl = groupImages[group] || '';
                                        const sanitizedUrl = rawUrl.replace(/'/g, "\'");
                                        const backgroundStyle = rawUrl
                                            ? `background-image: url('${sanitizedUrl}');`
                                            : 'background-image: linear-gradient(135deg, rgba(16,185,129,0.55), rgba(59,130,246,0.45));';
                                        const editButton = isAdmin
                                            ? `<button type="button" data-action="routine-creator-edit-group-image" data-group-target="${group}" class="absolute right-4 top-4 inline-flex h-9 w-9 items-center justify-center rounded-full border border-white/10 bg-black/60 text-white shadow-lg transition hover:bg-emerald-400 hover:text-gray-900"><i data-lucide="image-plus" class="h-4 w-4"></i></button>`
                                            : '';
                                        const isActiveGroup = group === activeGroup;
                                        return `
                                        <button type="button" data-action="routine-creator-switch-group" data-group-target="${group}" data-active="${isActiveGroup}" class="group relative flex h-44 w-full flex-col justify-end overflow-hidden rounded-2xl border border-white/5 bg-white/5 text-left shadow-[0_25px_60px_-40px_rgba(16,185,129,0.75)] transition-all duration-300 hover:-translate-y-1 hover:border-emerald-300/60 data-[active=true]:border-emerald-300 data-[active=true]:shadow-emerald-400/40">
                                            <div class="absolute inset-0 overflow-hidden">
                                                <div class="absolute inset-0 bg-cover bg-center transition duration-500 group-hover:scale-105" style="${backgroundStyle}"></div>
                                                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>
                                            </div>
                                            ${editButton}
                                            <div class="relative z-10 flex w-full flex-col gap-2 p-5">
                                                <span class="inline-flex w-fit items-center rounded-full bg-white/15 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-100/90 backdrop-blur">Grupo muscular</span>
                                                <p class="text-2xl font-semibold leading-tight text-white drop-shadow-xl">${group}</p>
                                            </div>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </aside>`;
                        const exercisesPanel = `
                        <section id="exercise-list-panel" data-mobile-visible="false" class="hidden flex-1 flex-col overflow-y-auto bg-gray-950/60 md:flex">
                            <header class="sticky top-0 z-20 flex items-center justify-between gap-3 border-b border-white/5 bg-gray-950/90 px-4 py-4 md:hidden">
                                <button data-action="routine-creator-back-to-groups" class="rounded-full bg-white/10 p-2 text-gray-300 transition hover:text-white">
                                    <i data-lucide="arrow-left"></i>
                                </button>
                                <div class="min-w-0 flex-1 text-center">
                                    <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/70">Ejercicios</p>
                                    <h3 id="active-group-title" class="mt-1 truncate text-base font-semibold text-white">${activeGroup}</h3>
                                </div>
                                <div class="h-9 w-9"></div>
                            </header>
                            <div class="space-y-8 p-5 sm:p-8">
                                ${Object.entries(this.data.exerciseLibrary).map(([group, subGroups]) => `
                                    <div data-group-content="${group}" class="${group === activeGroup ? 'space-y-6' : 'hidden space-y-6'}">
                                        ${Object.entries(subGroups).map(([subGroup, exercises]) => `
                                            <div data-subgroup-content="${subGroup}" class="space-y-4">
                                                <div class="flex items-center justify-between gap-2">
                                                    <h4 class="text-sm font-semibold uppercase tracking-[0.3em] text-emerald-200/80">${subGroup}</h4>
                                                    ${isAdmin ? `<button data-action="routine-creator-switch-group" data-group-target="${group}" class="hidden"></button>` : ''}
                                                </div>
                                                <div class="grid gap-5">
                                                    ${exercises.map((ex, exIndex) => `
                                                        <div class="exercise-item group relative flex flex-col gap-5 rounded-2xl border border-white/5 bg-white/5 p-5 shadow-[0_25px_60px_-45px_rgba(56,189,248,0.55)] transition hover:border-emerald-300/70 sm:flex-row sm:items-center" data-exercise-name="${ex.name}">
                                                            <button data-action="show-media-viewer" data-media-url="${ex.mediaUrl || ''}" class="relative h-36 w-full overflow-hidden rounded-2xl bg-gray-900/80 sm:h-40 sm:w-48">
                                                                ${ex.mediaUrl ? `<img src="${ex.mediaUrl}" alt="${ex.name}" class="h-full w-full object-cover transition duration-500 group-hover:scale-105">` : `<div class="flex h-full w-full items-center justify-center text-gray-500"><i data-lucide="image-off" class="h-10 w-10"></i></div>`}
                                                                <span class="absolute left-3 top-3 rounded-full bg-black/70 px-3 py-1 text-xs font-semibold text-white">${subGroup}</span>
                                                            </button>
                                                            <div class="flex flex-1 flex-col gap-4">
                                                                <div>
                                                                    <p class="text-base font-semibold text-white">${ex.name}</p>
                                                                    <div class="mt-1 flex flex-wrap items-center gap-3 text-xs text-gray-400">
                                                                        ${isAdmin ? `<button data-action="admin-edit-media" data-group="${group}" data-subgroup="${subGroup}" data-exercise-index="${exIndex}" class="inline-flex items-center gap-1 text-amber-300/80 transition hover:text-amber-200"><i data-lucide="camera" class="h-3.5 w-3.5"></i>Editar media</button>` : ''}
                                                                        <button data-action="show-exercise-info" data-exercise-name="${ex.name}" class="inline-flex items-center gap-1 text-sky-300/80 transition hover:text-sky-200"><i data-lucide="info" class="h-3.5 w-3.5"></i>Instrucciones</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <button data-action="routine-creator-select-exercise" data-exercise-name="${ex.name}" class="inline-flex h-12 w-12 items-center justify-center rounded-full bg-gradient-to-br from-emerald-400 via-teal-400 to-cyan-400 text-gray-900 shadow-lg transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                                                <i data-lucide="plus" class="h-6 w-6"></i>
                                                            </button>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        </section>`;
                        return `
                            <div class="flex min-h-screen flex-col bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950">
                                <header class="border-b border-white/5 bg-gray-950/80 backdrop-blur">
                                    <div class="mx-auto flex w-full max-w-6xl items-center justify-between px-4 py-5 sm:px-6">
                                        <button data-action="routine-close-view" class="group inline-flex h-11 w-11 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-400 transition hover:border-emerald-400/60 hover:text-white"><i data-lucide="arrow-left" class="h-5 w-5"></i></button>
                                        <div class="min-w-0 text-center">
                                            <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/70">Crear rutina</p>
                                            <h3 class="mt-2 text-lg font-semibold text-white">Paso 2 ¬∑ Planifica tu rutina</h3>
                                            ${assignmentInfo}
                                        </div>
                                        <div class="hidden h-11 w-11 sm:block"></div>
                                    </div>
                                    <div class="h-1 w-full bg-white/5">
                                        <div class="h-full w-full rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400"></div>
                                    </div>
                                </header>
                                <div class="flex-1 min-h-0 overflow-y-auto px-4 pb-24 pt-8 sm:px-6 lg:pb-12">
                                    <div class="mx-auto grid w-full max-w-6xl items-start gap-6 lg:grid-cols-[minmax(0,340px)_minmax(0,1fr)]">
                                        <section class="flex min-h-0 flex-col gap-6 rounded-3xl border border-white/5 bg-white/5 p-6 sm:p-8 shadow-[0_45px_120px_-70px_rgba(16,185,129,0.55)]">
                                            <div class="space-y-6">
                                                <div>
                                                    <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-gray-950/50 px-4 py-1 text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/80"><span class="h-2 w-2 rounded-full bg-emerald-400"></span>Paso 2</span>
                                                    <h2 class="mt-4 text-2xl font-semibold leading-tight text-white">Dise√±a la jornada con intenci√≥n</h2>
                                                    <div class="mt-3 inline-flex items-center gap-2 rounded-full border border-emerald-300/30 bg-emerald-500/10 px-4 py-1 text-xs font-semibold text-emerald-200/90">
                                                        <i data-lucide="bookmark-check" class="h-4 w-4"></i>
                                                        <span>${routineName}</span>
                                                    </div>
                                                    <p class="mt-3 text-sm leading-relaxed text-gray-300">Presentamos la informaci√≥n esencial del d√≠a para que definas cada bloque con claridad y profesionalismo.</p>
                                                </div>
                                                <div class="space-y-6 rounded-2xl border border-white/10 bg-gray-950/60 p-6">
                                                    <div class="flex items-start justify-between gap-4">
                                                        <div>
                                                            <p class="text-[11px] font-semibold uppercase tracking-[0.3em] text-emerald-200/70">D√≠a en edici√≥n</p>
                                                            <p class="mt-2 text-2xl font-semibold text-white">${dayName}</p>
                                                        </div>
                                                        <span class="grid h-12 w-12 place-items-center rounded-2xl bg-emerald-500/10 text-emerald-300">
                                                            <i data-lucide="calendar-check" class="h-6 w-6"></i>
                                                        </span>
                                                    </div>
                                                    <div class="grid gap-4 sm:grid-cols-2">
                                                        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                                                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">D√≠as totales</p>
                                                            <p class="mt-2 text-2xl font-bold text-white">${totalDays}</p>
                                                            <p class="mt-1 text-xs text-gray-400">Personaliza tantos d√≠as como necesites.</p>
                                                        </div>
                                                        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                                                            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-gray-400">Ejercicios hoy</p>
                                                            <p class="mt-2 text-2xl font-bold text-white">${totalExercises}</p>
                                                            <p class="mt-1 text-xs text-gray-400">Equilibra intensidad, descansos y volumen.</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="rounded-2xl border border-emerald-400/20 bg-emerald-500/10 p-5 text-sm text-emerald-100">
                                                <div class="flex items-start gap-3">
                                                    <span class="grid h-9 w-9 place-items-center rounded-full bg-emerald-500/20 text-emerald-100">
                                                        <i data-lucide="lightbulb" class="h-5 w-5"></i>
                                                    </span>
                                                    <p>Utiliza la vista de bloques para asegurarte de que cada ejercicio responda a un objetivo claro y acompa√±e al progreso del asesorado.</p>
                                                </div>
                                            </div>
                                        </section>
                                        <section class="flex h-full flex-col gap-6 rounded-3xl border border-white/5 bg-gray-950/70 p-6 sm:p-8 shadow-[0_55px_120px_-80px_rgba(12,74,110,0.55)]">
                                            <div class="space-y-2">
                                                <span class="text-[11px] font-semibold uppercase tracking-[0.35em] text-emerald-200/70">Organizaci√≥n</span>
                                                <h3 class="text-2xl font-semibold leading-tight text-white">Estructura tu d√≠a de entrenamiento</h3>
                                                <p class="text-sm text-gray-300">Gestiona la secuencia perfecta, a√±ade ejercicios o ap√≥yate en la IA para optimizar cada bloque.</p>
                                            </div>
                                            <div class="rounded-2xl border border-white/10 bg-gray-900/60 p-4">
                                                <div id="routine-day-tabs" class="flex items-center gap-2 overflow-x-auto pb-1"></div>
                                            </div>
                                            <div class="flex flex-1 flex-col gap-6 rounded-2xl border border-white/10 bg-gray-900/60 p-6">
                                                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                                    <div class="flex items-center gap-3">
                                                        <span class="grid h-11 w-11 place-items-center rounded-full bg-emerald-500/10 text-emerald-300">
                                                            <i data-lucide="list-checks" class="h-5 w-5"></i>
                                                        </span>
                                                        <div>
                                                            <p class="text-sm font-semibold text-white">Bloques del d√≠a</p>
                                                            <p class="text-xs text-gray-400">A√±ade, edita o elimina ejercicios en segundos.</p>
                                                        </div>
                                                    </div>
                                                    <div class="flex flex-wrap items-center gap-2">
                                                        <button data-action="routine-creator-suggest-ai" class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-sm font-semibold text-white transition hover:border-purple-400/50 hover:text-purple-200">
                                                            <i data-lucide="sparkles" class="h-4 w-4"></i>
                                                            <span>Propuesta IA</span>
                                                        </button>
                                                        <button data-action="routine-creator-add-exercise" class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 px-5 py-2 text-sm font-semibold text-gray-900 shadow-lg transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                                            <i data-lucide="plus" class="h-4 w-4"></i>
                                                            <span>Agregar ejercicio</span>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="relative flex-1 min-h-0">
                                                    <div id="exercise-list-container" class="relative flex h-full flex-col gap-4"></div>
                                                </div>
                                            </div>
                                            <div class="flex flex-col gap-3 rounded-2xl border border-white/10 bg-white/5 p-5 sm:flex-row sm:items-center sm:justify-between">
                                                <div class="flex items-center gap-3 text-sm text-gray-200">
                                                    <i data-lucide="shield-check" class="h-5 w-5 text-emerald-300"></i>
                                                    <span>Cuando todo est√© listo, guarda la rutina para compartirla con tus asesorados.</span>
                                                </div>
                                                <button data-action="routine-creator-save" class="inline-flex items-center justify-center gap-2 rounded-full bg-emerald-500 px-6 py-3 text-sm font-semibold text-gray-900 shadow-lg transition hover:bg-emerald-400">
                                                    <i data-lucide="save" class="h-5 w-5"></i>
                                                    <span>Guardar rutina</span>
                                                </button>
                                            </div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                            <div id="exercise-drawer" class="absolute inset-0 z-30 flex flex-col bg-gray-950/95 backdrop-blur-lg">
                                <header class="sticky top-0 z-10 flex items-center gap-3 border-b border-white/5 bg-gray-950/90 px-4 py-4 sm:px-6">
                                    <div class="relative flex-1">
                                        <i data-lucide="search" class="pointer-events-none absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-500"></i>
                                        <input id="exercise-search-input" type="search" placeholder="Busca por nombre o grupo..." class="w-full rounded-2xl border border-white/10 bg-gray-900/80 py-2.5 pl-10 pr-4 text-sm text-white placeholder:text-gray-500 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                    </div>
                                    <button data-action="routine-creator-close-drawer" class="rounded-full bg-white/5 p-2 text-gray-400 transition hover:text-white"><i data-lucide="x"></i></button>
                                </header>
                                <div id="exercise-drawer-content" class="flex flex-1 flex-col overflow-y-auto md:flex-row md:overflow-hidden" data-current-group="${activeGroup}">${groupsNav}${exercisesPanel}</div>
                            </div>
                        `;
                    }
                },
                // ‚ñº‚ñº‚ñº C√ìDIGO A INSERTAR ‚ñº‚ñº‚ñº
                routine_handleCoverImageSelect(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const preview = document.getElementById('routine-cover-preview');
                    const placeholder = document.getElementById('cover-image-placeholder');
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    };

                    reader.readAsDataURL(file);
                    this.routine_uploadCoverImage(file);
                },

                async routine_uploadCoverImage(file) {
                    if (!file) return;

                    const progressContainer = document.getElementById('cover-upload-progress-container');
                    const progressBar = document.getElementById('cover-upload-progress-bar');
                    const progressText = document.getElementById('cover-upload-progress-text');

                    progressContainer.style.display = 'flex';

                    const filePath = `routine_covers/${this._tempRoutine.id}-${file.name}`;
                    const storageRef = ref(this.storage, filePath);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = progress + '%';
                            progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                        },
                        (error) => {
                            console.error("Upload failed:", error);
                            this.showToast('Error al subir la imagen.', 'error');
                            progressText.textContent = 'Error en la subida';
                        },
                        async () => {
                            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                            this._tempRoutine.coverImageUrl = downloadURL;
                            progressText.textContent = '¬°Subido con √©xito!';
                            document.getElementById('routine-cover-image-input').disabled = true;
                            setTimeout(() => { progressContainer.style.display = 'none'; }, 2000);
                        }
                    );
                },
                // ‚ñ≤‚ñ≤‚ñ≤ FIN DEL C√ìDIGO A INSERTAR ‚ñ≤‚ñ≤‚ñ≤
                
                routine_handleCreatorNext() {
                    const name = document.getElementById('routine-name-input').value.trim();
                    const desc = document.getElementById('routine-desc-input').value.trim();
                    if (!name) { this.showToast('El nombre es obligatorio', 'error'); return; }
                    this._tempRoutine.name = name;
                    this._tempRoutine.description = desc;
                    this.routine_enterCreator(2);
                },
                routine_showAddExerciseDrawer() {
                    const drawer = document.getElementById('exercise-drawer');
                    if (!drawer) return;

                    drawer.classList.add('is-active');

                    const panel = document.getElementById('exercise-list-panel');
                    if (panel) {
                        panel.dataset.mobileVisible = window.innerWidth >= 768 ? 'true' : 'false';
                    }

                    this.routine_creator_handleDrawerResize();

                    const searchInput = document.getElementById('exercise-search-input');
                    if (searchInput) searchInput.focus();
                },
                routine_closeAddExerciseDrawer() {
                    const drawer = document.getElementById('exercise-drawer');
                    if (drawer) drawer.classList.remove('is-active');

                    const panel = document.getElementById('exercise-list-panel');
                    if (panel && window.innerWidth < 768) {
                        panel.dataset.mobileVisible = 'false';
                        this.routine_creator_handleDrawerResize();
                    }
                },
                routine_creator_switchGroup(targetGroup) {
                    const navButtons = document.querySelectorAll('#exercise-group-nav [data-action="routine-creator-switch-group"]');
                    navButtons.forEach(btn => {
                        const isActive = btn.dataset.groupTarget === targetGroup;
                        btn.dataset.active = isActive;
                        if (isActive) {
                            btn.scrollIntoView({ block: 'nearest', inline: 'nearest', behavior: 'smooth' });
                        }
                    });

                    document.querySelectorAll('#exercise-list-panel [data-group-content]').forEach(panel => {
                        panel.classList.toggle('hidden', panel.dataset.groupContent !== targetGroup);
                    });

                    this._tempRoutine.activeExerciseGroup = targetGroup;

                    const drawerContent = document.getElementById('exercise-drawer-content');
                    if (drawerContent) {
                        drawerContent.dataset.currentGroup = targetGroup;
                    }

                    const panel = document.getElementById('exercise-list-panel');
                    if (panel) {
                        panel.dataset.mobileVisible = 'true';
                        if (window.innerWidth < 768) {
                            panel.classList.remove('hidden');
                            panel.classList.add('flex');
                            panel.scrollTop = 0;
                        }
                    }

                    const groupTitle = document.getElementById('active-group-title');
                    if (groupTitle) groupTitle.textContent = targetGroup;

                    this.routine_creator_handleDrawerResize();
                },
                routine_creator_showGroupList() {
                    const panel = document.getElementById('exercise-list-panel');
                    if (panel) {
                        if (window.innerWidth < 768) {
                            panel.dataset.mobileVisible = 'false';
                            panel.scrollTop = 0;
                        } else {
                            panel.dataset.mobileVisible = 'true';
                        }
                    }

                    this.routine_creator_handleDrawerResize();
                },
                routine_creator_handleDrawerResize() {
                    const nav = document.getElementById('exercise-group-nav');
                    const panel = document.getElementById('exercise-list-panel');
                    if (!nav || !panel) return;

                    if (window.innerWidth >= 768) {
                        nav.classList.remove('hidden');
                        panel.classList.remove('hidden');
                        panel.classList.remove('flex');
                        panel.dataset.mobileVisible = 'true';
                        return;
                    }

                    const shouldShowExercises = panel.dataset.mobileVisible === 'true';
                    if (shouldShowExercises) {
                        nav.classList.add('hidden');
                        panel.classList.remove('hidden');
                        panel.classList.add('flex');
                    } else {
                        nav.classList.remove('hidden');
                        panel.classList.add('hidden');
                        panel.classList.remove('flex');
                    }
                },
                routine_creator_showGroupImageModal(group) {
                    if (!this.isAsesor()) return;

                    const currentImage = this.data.exerciseGroupImages?.[group] || '';
                    const body = `
                        <div class="space-y-5">
                            <div class="bg-gray-800/70 border border-gray-700 rounded-2xl p-4">
                                <p class="text-sm text-gray-300 leading-relaxed">Selecciona una imagen representativa para el grupo muscular <strong>${group}</strong>. Recomendamos un formato horizontal para lograr una mejor cobertura de la tarjeta.</p>
                                <label for="group-image-file-input" class="mt-4 block cursor-pointer">
                                    <div class="w-full aspect-video rounded-2xl border-2 border-dashed border-gray-600 text-gray-400 flex flex-col items-center justify-center gap-2 hover:border-emerald-400 hover:text-emerald-300 transition">
                                        <i data-lucide="upload-cloud" class="w-10 h-10"></i>
                                        <span class="font-semibold">Seleccionar imagen</span>
                                        <span class="text-xs text-gray-500">Formatos permitidos: JPG, PNG o WEBP</span>
                                    </div>
                                </label>
                                <input type="file" id="group-image-file-input" class="hidden" accept="image/*">
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-gray-300 mb-2">Vista previa</h4>
                                <div id="group-image-preview" class="aspect-video rounded-2xl overflow-hidden bg-gray-900/60 flex items-center justify-center">
                                    ${currentImage ? `<img src="${currentImage}" alt="Imagen actual de ${group}" class="w-full h-full object-cover">` : `<span class="text-xs text-gray-500">A√∫n no hay imagen asignada para este grupo.</span>`}
                                </div>
                            </div>
                            <div id="group-image-upload-progress" class="hidden">
                                <div class="w-full bg-gray-600 rounded-full h-2">
                                    <div id="group-image-progress-bar" class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p id="group-image-progress-text" class="text-xs text-gray-400 mt-2 text-center">Subiendo...</p>
                            </div>
                        </div>
                    `;

                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                        { text: 'Guardar Imagen', class: 'bg-emerald-600 text-gray-900 hover:bg-emerald-500', action: 'routine-creator-upload-group-image', 'group-target': group }
                    ];

                    this.showModal(`Imagen para ${group}`, body, footer);
                    lucide.createIcons();

                    const fileInput = document.getElementById('group-image-file-input');
                    const previewContainer = document.getElementById('group-image-preview');

                    if (fileInput) {
                        fileInput.addEventListener('change', () => {
                            if (fileInput.files.length === 0) {
                                previewContainer.innerHTML = currentImage
                                    ? `<img src="${currentImage}" alt="Imagen actual de ${group}" class="w-full h-full object-cover">`
                                    : `<span class="text-xs text-gray-500">A√∫n no hay imagen asignada para este grupo.</span>`;
                                return;
                            }

                            const file = fileInput.files[0];
                            if (!file.type.startsWith('image/')) {
                                this.showToast('Selecciona un archivo de imagen v√°lido.', 'error');
                                fileInput.value = '';
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = (event) => {
                                previewContainer.innerHTML = `<img src="${event.target.result}" alt="Nueva imagen para ${group}" class="w-full h-full object-cover">`;
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                },
                async routine_creator_uploadGroupImage(group) {
                    if (!this.isAsesor()) { this.showToast('Acci√≥n no permitida.', 'error'); return; }

                    const fileInput = document.getElementById('group-image-file-input');
                    if (!fileInput || fileInput.files.length === 0) {
                        this.showToast('Selecciona una imagen para este grupo.', 'error');
                        return;
                    }

                    const file = fileInput.files[0];
                    if (!file.type.startsWith('image/')) {
                        this.showToast('El archivo debe ser una imagen.', 'error');
                        return;
                    }

                    const progressContainer = document.getElementById('group-image-upload-progress');
                    const progressBar = document.getElementById('group-image-progress-bar');
                    const progressText = document.getElementById('group-image-progress-text');
                    const modalFooter = document.getElementById('custom-modal-footer');

                    if (progressContainer) progressContainer.classList.remove('hidden');
                    if (modalFooter) {
                        modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = true);
                    }

                    const safeGroupName = group.replace(/\s+/g, '_').toLowerCase();
                    const extension = file.name.split('.').pop();
                    const fileName = `group_covers/${safeGroupName}-${Date.now()}.${extension}`;
                    const storageRef = ref(this.storage, fileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            if (!progressBar || !progressText) return;
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                        },
                        (error) => {
                            console.error('Group image upload failed:', error);
                            this.showToast('Error en la subida. Int√©ntalo nuevamente.', 'error');
                            if (modalFooter) {
                                modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                            }
                        },
                        async () => {
                            try {
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                if (!this.data.exerciseGroupImages) this.data.exerciseGroupImages = {};
                                this.data.exerciseGroupImages[group] = downloadURL;

                                const docRef = doc(this.db, 'app_data', 'exercise_group_images');
                                await setDoc(docRef, { [group]: downloadURL }, { merge: true });

                                this.showToast('Imagen del grupo actualizada.', 'success');
                                this.hideModal();

                                const creatorView = document.getElementById('routine-creator-view');
                                if (creatorView) {
                                    this.routine_enterCreator(2);
                                }
                            } catch (error) {
                                console.error('Error saving group image:', error);
                                this.showToast('No se pudo guardar la imagen.', 'error');
                                if (modalFooter) {
                                    modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                                }
                            }
                        }
                    );
                },
                routine_filterExerciseLibrary(searchTerm) {
                    const term = searchTerm.toLowerCase().trim();
                    const panel = document.getElementById('exercise-list-panel');
                    const nav = document.getElementById('exercise-group-nav');
                    if (!panel || !nav) return;

                    panel.querySelectorAll('.exercise-item').forEach(item => {
                        const name = item.dataset.exerciseName.toLowerCase();
                        item.style.display = name.includes(term) ? 'flex' : 'none';
                    });

                    panel.querySelectorAll('[data-subgroup-content]').forEach(subgroup => {
                        const visibleExercises = subgroup.querySelector('.exercise-item[style*="display: flex"]');
                        subgroup.style.display = visibleExercises ? 'block' : 'none';
                    });

                    panel.querySelectorAll('[data-group-content]').forEach(groupContent => {
                        const visibleSubgroups = groupContent.querySelector('[data-subgroup-content][style*="display: block"]');
                        const correspondingButton = nav.querySelector(`[data-action="routine-creator-switch-group"][data-group-target="${groupContent.dataset.groupContent}"]`);
                        if (correspondingButton) {
                            correspondingButton.classList.toggle('hidden', !visibleSubgroups);
                        }
                    });
                },
                routine_selectExercise(exerciseName) { this._tempRoutine.plan[this._tempRoutine.currentDayIndex].exercises.push({ name: exerciseName, sets: 4, reps: '10', rest: '60s' }); this.showToast(`${exerciseName} a√±adido`, 'success'); this.routine_refreshExerciseList(); },
                routine_editExercise(index) { this._tempRoutine.editingIndex = parseInt(index); this.routine_refreshExerciseList(); },
                routine_saveExerciseDetails(index) { const exercise = this._tempRoutine.plan[this._tempRoutine.currentDayIndex].exercises[index]; if (!exercise) return; const setsInput = document.getElementById(`sets-input-${index}`); const repsInput = document.getElementById(`reps-input-${index}`); const restInput = document.getElementById(`rest-input-${index}`); if (setsInput && repsInput && restInput) { exercise.sets = parseInt(setsInput.value) || exercise.sets; exercise.reps = repsInput.value.trim() || exercise.reps; exercise.rest = restInput.value.trim() || exercise.rest; } this._tempRoutine.editingIndex = -1; this.routine_refreshExerciseList(); },
                routine_removeExercise(index) { this._tempRoutine.plan[this._tempRoutine.currentDayIndex].exercises.splice(index, 1); this.routine_refreshExerciseList(); },
                routine_refreshExerciseList() {
                    const container = document.getElementById('exercise-list-container');
                    if (!container) return;
                    const currentDay = this._tempRoutine.plan[this._tempRoutine.currentDayIndex];
                    if (!currentDay) return;
                    const exercises = currentDay.exercises;

                    if (exercises.length === 0) {
                        container.innerHTML = `
                        <div class="flex h-full flex-col items-center justify-center rounded-2xl border-2 border-dashed border-white/10 bg-gray-900/50 p-10 text-center">
                            <span class="grid h-16 w-16 place-items-center rounded-full bg-emerald-500/10 text-emerald-300 shadow-[0_0_35px_rgba(16,185,129,0.35)]">
                                <i data-lucide="list-plus" class="h-8 w-8"></i>
                            </span>
                            <h3 class="mt-4 text-xl font-semibold text-white">Tu d√≠a a√∫n est√° vac√≠o</h3>
                            <p class="mt-2 max-w-sm text-sm text-gray-400">A√±ade ejercicios manualmente o deja que nuestra IA cree una propuesta equilibrada para comenzar.</p>
                            <div class="mt-6 flex flex-col items-center gap-3 sm:flex-row">
                                <button data-action="routine-creator-add-exercise" class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 px-6 py-3 text-sm font-semibold text-gray-900 shadow-lg transition hover:from-emerald-300 hover:via-teal-300 hover:to-cyan-300">
                                    <i data-lucide="plus" class="h-4 w-4"></i>
                                    <span>A√±adir manualmente</span>
                                </button>
                                <button data-action="routine-creator-suggest-ai" class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-6 py-3 text-sm font-semibold text-white transition hover:border-purple-400/50 hover:text-purple-200">
                                    <i data-lucide="sparkles" class="h-4 w-4"></i>
                                    <span>Sugerir con IA</span>
                                </button>
                            </div>
                        </div>`;
                    } else {
                        container.innerHTML = exercises.map((ex, index) => {
                            if (this._tempRoutine.editingIndex === index) {
                                return `
                                <div class="section-fade-in rounded-2xl border border-emerald-400/40 bg-emerald-500/10 p-5 shadow-[0_25px_80px_-50px_rgba(16,185,129,0.75)]" data-exercise-index="${index}">
                                    <div class="flex items-start justify-between gap-4">
                                        <div>
                                            <p class="text-lg font-semibold text-white">${ex.name}</p>
                                            <p class="mt-1 text-xs font-semibold uppercase tracking-[0.25em] text-emerald-200/80">Editando bloque</p>
                                        </div>
                                        <button data-action="routine-creator-remove-exercise" data-exercise-index="${index}" class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-red-500/30 bg-red-500/10 text-red-300 transition hover:bg-red-500/20">
                                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                    <div class="mt-5 grid gap-4 sm:grid-cols-3">
                                        <div>
                                            <label class="text-xs font-semibold uppercase tracking-[0.25em] text-emerald-100/80">Series</label>
                                            <input id="sets-input-${index}" type="number" value="${ex.sets}" class="mt-2 w-full rounded-xl border border-white/10 bg-gray-950/70 px-3 py-2 text-center text-white focus:border-emerald-400/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                        </div>
                                        <div>
                                            <label class="text-xs font-semibold uppercase tracking-[0.25em] text-emerald-100/80">Reps</label>
                                            <input id="reps-input-${index}" type="text" value="${ex.reps}" class="mt-2 w-full rounded-xl border border-white/10 bg-gray-950/70 px-3 py-2 text-center text-white focus:border-emerald-400/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                        </div>
                                        <div>
                                            <label class="text-xs font-semibold uppercase tracking-[0.25em] text-emerald-100/80">Descanso</label>
                                            <input id="rest-input-${index}" type="text" value="${ex.rest}" class="mt-2 w-full rounded-xl border border-white/10 bg-gray-950/70 px-3 py-2 text-center text-white focus:border-emerald-400/60 focus:outline-none focus:ring-2 focus:ring-emerald-400/40">
                                        </div>
                                    </div>
                                    <button data-action="routine-creator-save-exercise-details" data-exercise-index="${index}" class="mt-5 inline-flex w-full items-center justify-center gap-2 rounded-full bg-emerald-500 px-6 py-3 text-sm font-semibold text-gray-900 shadow-lg transition hover:bg-emerald-400">
                                        <i data-lucide="check-circle" class="h-5 w-5"></i>
                                        <span>Guardar cambios</span>
                                    </button>
                                </div>`;
                            } else {
                                return `
                                <div class="section-fade-in flex flex-col gap-4 rounded-2xl border border-white/10 bg-white/5 p-5 shadow-[0_25px_80px_-60px_rgba(56,189,248,0.4)] sm:flex-row sm:items-center" data-exercise-index="${index}">
                                    <div class="grid h-14 w-14 place-items-center rounded-2xl bg-emerald-500/10 text-xl font-semibold text-emerald-300">${index + 1}</div>
                                    <div class="flex-1">
                                        <p class="text-base font-semibold text-white">${ex.name}</p>
                                        <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-gray-300">
                                            <span class="inline-flex items-center gap-1.5 rounded-full bg-gray-900/60 px-3 py-1"><i data-lucide="layers" class="h-3.5 w-3.5"></i>${ex.sets} series</span>
                                            <span class="inline-flex items-center gap-1.5 rounded-full bg-gray-900/60 px-3 py-1"><i data-lucide="repeat" class="h-3.5 w-3.5"></i>${ex.reps} reps</span>
                                            <span class="inline-flex items-center gap-1.5 rounded-full bg-gray-900/60 px-3 py-1"><i data-lucide="timer" class="h-3.5 w-3.5"></i>${ex.rest}</span>
                                        </div>
                                    </div>
                                    <div class="flex flex-shrink-0 items-center gap-2">
                                        <button data-action="routine-creator-edit-exercise" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-300 transition hover:border-emerald-400/50 hover:text-white">
                                            <i data-lucide="edit" class="h-4 w-4"></i>
                                        </button>
                                        <button data-action="routine-creator-remove-exercise" data-exercise-index="${index}" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-red-500/30 bg-red-500/10 text-red-300 transition hover:bg-red-500/20">
                                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                </div>`;
                            }
                        }).join('');
                    }
                    lucide.createIcons();
                },
                
                routine_addDay() { const dayCount = this._tempRoutine.plan.length + 1; this._tempRoutine.plan.push({ day: `D√≠a ${dayCount}`, exercises: [] }); this._tempRoutine.currentDayIndex = dayCount - 1; this.routine_refreshDayTabs(); this.routine_refreshExerciseList(); },
                routine_switchDay(index) { this._tempRoutine.currentDayIndex = index; this.routine_refreshDayTabs(); this.routine_refreshExerciseList(); },
                routine_refreshDayTabs() { const container = document.getElementById('routine-day-tabs'); if(!container) return; const tabsHtml = this._tempRoutine.plan.map((day, index) => { const isActive = index === this._tempRoutine.currentDayIndex; return `<button data-action="routine-creator-switch-day" data-day-index="${index}" class="relative group flex-shrink-0 px-4 py-2 text-sm font-semibold rounded-lg ${isActive ? 'bg-emerald-500 text-gray-900' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'} transition-colors"><span ondblclick="app.routine_showRenameDayModal(${index})">${day.day}</span><button data-action="routine-creator-confirm-delete-day" data-day-index="${index}" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full text-white flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button></button>`; }).join(''); const addButton = `<button data-action="routine-creator-add-day" class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-gray-800 text-gray-400 rounded-lg hover:bg-gray-700 hover:text-white transition-colors"><i data-lucide="plus"></i></button>`; container.innerHTML = tabsHtml + addButton; lucide.createIcons(); container.scrollLeft = container.scrollWidth; },
                routine_showRenameDayModal(index) { const currentName = this._tempRoutine.plan[index].day; const body = `<input type="text" id="rename-day-input" value="${currentName}" class="w-full bg-gray-700 rounded-lg p-3">`; const footer = [{ text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal' }, { text: 'Guardar', class: 'bg-emerald-600 text-gray-900', action: 'none' }]; this.showModal(`Renombrar ${currentName}`, body, footer); document.querySelector('#custom-modal-footer button[data-action="none"]').onclick = () => { const newName = document.getElementById('rename-day-input').value.trim(); if (newName) { this._tempRoutine.plan[index].day = newName; this.routine_refreshDayTabs(); this.hideModal(); } else { this.showToast('El nombre no puede estar vac√≠o', 'error'); } }; },
                routine_confirmDeleteDay(dayIndex) { if (this._tempRoutine.plan.length <= 1) { this.showToast('No puedes eliminar el √∫nico d√≠a de la rutina.', 'error'); return; } const dayName = this._tempRoutine.plan[dayIndex].day; this.showModal('Eliminar D√≠a', `¬øSeguro que quieres eliminar "${dayName}"?`, [ {text: 'Cancelar', class: 'bg-gray-600', action: 'hide-modal'}, {text: 'Eliminar', class: 'bg-red-600', action: 'routine-creator-delete-day', 'day-index': dayIndex} ]); },
                routine_deleteDay(dayIndex) { this._tempRoutine.plan.splice(dayIndex, 1); this._tempRoutine.currentDayIndex = Math.max(0, dayIndex - 1); this.routine_refreshDayTabs(); this.routine_refreshExerciseList(); this.hideModal(); },
                
                async routine_save() {
                    if (this._tempRoutine.plan.some(d => d.exercises.length === 0)) {
                        this.showToast('Aseg√∫rate de que cada d√≠a tenga al menos un ejercicio.', 'error');
                        return;
                    }
                    this._tempRoutine.editingIndex = -1;

                    const editingClientId = this._tempRoutine.editingClientId;
                    const assignedClientId = this._tempRoutine.assignedClientId || '';
                    const routinePayload = JSON.parse(JSON.stringify(this._tempRoutine));
                    delete routinePayload.editingClientId;
                    delete routinePayload.activeExerciseGroup;
                    if (!assignedClientId) delete routinePayload.assignedClientId;

                    try {
                        if (editingClientId) {
                            const clientRef = doc(this.db, "users", editingClientId);
                            const clientData = (this.state.asesorados || []).find(c => c.id === editingClientId);
                            const existingRoutines = Array.isArray(clientData?.userRoutines) ? [...clientData.userRoutines] : [];
                            const routineIndex = existingRoutines.findIndex(r => r.id === routinePayload.id);
                            if (routineIndex >= 0) {
                                existingRoutines[routineIndex] = routinePayload;
                            } else {
                                existingRoutines.push(routinePayload);
                            }
                            await updateDoc(clientRef, { userRoutines: existingRoutines });
                            this.showToast('Rutina del cliente guardada con √©xito');
                            await this.fetchAsesorados();
                            if (Array.isArray(this.state.userRoutines)) {
                                const localIndex = this.state.userRoutines.findIndex(r => r.id === routinePayload.id);
                                if (localIndex >= 0) {
                                    this.state.userRoutines[localIndex] = routinePayload;
                                    await this.saveDataToFirestore();
                                    this.renderRoutinesSection();
                                }
                            }
                        } else if (assignedClientId) {
                            const clientRef = doc(this.db, "users", assignedClientId);
                            const clientData = (this.state.asesorados || []).find(c => c.id === assignedClientId);
                            const existingRoutines = Array.isArray(clientData?.userRoutines) ? [...clientData.userRoutines] : [];
                            existingRoutines.push(routinePayload);
                            await updateDoc(clientRef, { userRoutines: existingRoutines });
                            this.showToast('Rutina asignada al asesorado con √©xito');
                            await this.fetchAsesorados();

                            if (!this.state.userRoutines) this.state.userRoutines = [];
                            this.state.userRoutines.unshift(routinePayload);
                            await this.saveDataToFirestore();
                            this.renderRoutinesSection();
                        } else {
                            if (!this.state.userRoutines) this.state.userRoutines = [];
                            this.state.userRoutines.unshift(routinePayload);
                            await this.saveDataToFirestore();
                            this.showToast('Rutina guardada con √©xito');
                            this.renderRoutinesSection();
                        }

                        this.routine_closeFullscreenView();
                    } catch (error) {
                        console.error('Error saving routine:', error);
                        const isClientAction = Boolean(editingClientId || assignedClientId);
                        this.showToast(isClientAction ? 'Error al guardar la rutina del cliente.' : 'Error al guardar la rutina.', 'error');
                    }
                },

                routine_confirmDelete(routineId) { this.showModal('Eliminar Rutina', '¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.', [ {text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal'}, {text: 'Eliminar', class: 'bg-red-600 hover:bg-red-500', action: 'routine-delete', 'routine-id': routineId} ]); },
                async routine_delete(routineId) { this.state.userRoutines = this.state.userRoutines.filter(r => r.id !== routineId); await this.saveDataToFirestore(); this.hideModal(); this.routine_closeFullscreenView(); this.renderRoutinesSection(); this.showToast('Rutina eliminada', 'error'); },
                routine_openFullscreenView(html) {
                    const container = document.getElementById('fullscreen-view-container');
                    container.innerHTML = html;
                    container.classList.remove('pointer-events-none');
                    container.classList.remove('opacity-0');
                    container.style.opacity = '1';
                    setTimeout(() => {
                        const view = container.querySelector('.fullscreen-view');
                        if (view) view.classList.add('is-active');
                        lucide.createIcons();
                    }, 10);
                },
                routine_closeFullscreenView() {
                    if (this._boundHandleDrawerResize) {
                        window.removeEventListener('resize', this._boundHandleDrawerResize);
                        this._boundHandleDrawerResize = null;
                    }

                    const container = document.getElementById('fullscreen-view-container');
                    const view = container.querySelector('.fullscreen-view');
                    if (view) {
                        view.classList.remove('is-active');
                        container.style.opacity = '0';
                        container.classList.add('opacity-0');
                        view.addEventListener('transitionend', () => {
                            container.innerHTML = '';
                            container.classList.add('pointer-events-none');
                            this.renderAsesoradosSection();
                        }, { once: true });
                    }
                },
                
                showMediaViewer(url) {
                    if (!url) {
                        this.showToast('No hay multimedia para este ejercicio.', 'error');
                        return;
                    }
                    const modal = document.getElementById('image-viewer-modal');
                    const contentContainer = document.getElementById('image-viewer-content');
                    contentContainer.innerHTML = '';

                    const isVideo = url.includes('.mp4') || url.includes('.webm');
                    let mediaElement;
                    if (isVideo) {
                        mediaElement = document.createElement('video');
                        mediaElement.autoplay = true;
                        mediaElement.loop = true;
                        mediaElement.muted = true;
                        mediaElement.playsInline = true;
                    } else {
                        mediaElement = document.createElement('img');
                    }
                    mediaElement.src = url;
                    mediaElement.className = 'rounded-lg max-h-[90vh]';

                    contentContainer.appendChild(mediaElement);
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                },

                admin_showEditMediaModal(group, subGroup, exerciseIndex) {
                    if (!this.isAsesor()) return;
                    const exercise = this.data.exerciseLibrary[group][subGroup][exerciseIndex];
                    const body = `
                        <p class="text-sm text-gray-400 mb-4">Sube un nuevo GIF, imagen o video para este ejercicio. El archivo anterior ser√° reemplazado.</p>
                        <div>
                            <label for="media-file-input" class="w-full cursor-pointer bg-gray-700 hover:bg-gray-600 border-2 border-dashed border-gray-500 rounded-lg p-6 text-center transition">
                                <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto text-gray-400"></i>
                                <span id="file-name-display" class="mt-2 block text-sm font-semibold text-gray-300">Seleccionar archivo</span>
                            </label>
                            <input type="file" id="media-file-input" class="hidden" accept="image/*,video/*">
                        </div>
                        <div id="media-preview-container" class="mt-4 hidden max-h-48 overflow-hidden rounded-lg bg-gray-900 flex justify-center items-center"></div>
                        <div id="upload-progress-container" class="mt-4 hidden">
                            <div class="w-full bg-gray-600 rounded-full h-2.5">
                                <div id="upload-progress-bar" class="bg-emerald-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="upload-progress-text" class="text-center text-xs text-gray-400 mt-1">Subiendo...</p>
                        </div>
                    `;
                    const footer = [
                        { text: 'Cancelar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                        { text: 'Subir y Guardar', class: 'bg-emerald-600 text-gray-900 hover:bg-emerald-500', action: 'admin-upload-media', group: group, subgroup: subGroup, 'exercise-index': exerciseIndex, id: 'admin-upload-btn' }
                    ];
                    this.showModal(`Editar Media: ${exercise.name}`, body, footer);
                    lucide.createIcons();

                    const fileInput = document.getElementById('media-file-input');
                    const fileNameDisplay = document.getElementById('file-name-display');
                    const previewContainer = document.getElementById('media-preview-container');

                    fileInput.addEventListener('change', () => {
                        if (fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            fileNameDisplay.textContent = file.name;
                            previewContainer.innerHTML = '';
                            previewContainer.classList.remove('hidden');

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                let previewElement;
                                if (file.type.startsWith('image/')) {
                                    previewElement = document.createElement('img');
                                } else if (file.type.startsWith('video/')) {
                                    previewElement = document.createElement('video');
                                    previewElement.muted = true;
                                    previewElement.autoplay = true;
                                    previewElement.loop = true;
                                    previewElement.playsInline = true;
                                }
                                if (previewElement) {
                                    previewElement.src = e.target.result;
                                    previewElement.className = 'w-full h-auto object-contain max-h-48';
                                    previewContainer.appendChild(previewElement);
                                }
                            };
                            reader.readAsDataURL(file);
                        } else {
                            fileNameDisplay.textContent = 'Seleccionar archivo';
                            previewContainer.classList.add('hidden');
                            previewContainer.innerHTML = '';
                        }
                    });
                },

                async admin_uploadAndSaveMedia(group, subGroup, exerciseIndex) {
                    if (!this.isAsesor()) { this.showToast('Acci√≥n no permitida.', 'error'); return; }
                    
                    const fileInput = document.getElementById('media-file-input');
                    if (fileInput.files.length === 0) {
                        this.showToast('Por favor, selecciona un archivo para subir.', 'error');
                        return;
                    }
                    const file = fileInput.files[0];

                    const progressContainer = document.getElementById('upload-progress-container');
                    const progressBar = document.getElementById('upload-progress-bar');
                    const progressText = document.getElementById('upload-progress-text');
                    const modalFooter = document.getElementById('custom-modal-footer');

                    modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = true);
                    progressContainer.classList.remove('hidden');
                    
                    const exerciseName = this.data.exerciseLibrary[group][subGroup][exerciseIndex].name.replace(/\s+/g, '_');
                    const fileName = `exercise_media/${exerciseName}-${Date.now()}.${file.name.split('.').pop()}`;
                    const storageRef = ref(this.storage, fileName);
                    const uploadTask = uploadBytesResumable(storageRef, file);

                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            progressBar.style.width = `${progress}%`;
                            progressText.textContent = `Subiendo... ${Math.round(progress)}%`;
                        },
                        (error) => {
                            console.error("Upload failed:", error);
                            this.showToast('Error en la subida. Revisa las reglas de Storage.', 'error');
                            modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                        },
                        async () => {
                            try {
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                this.data.exerciseLibrary[group][subGroup][exerciseIndex].mediaUrl = downloadURL;
                                
                                const docRef = doc(this.db, "app_data", "exercise_library");
                                await setDoc(docRef, this.data.exerciseLibrary);
                                
                                this.showToast('¬°Recurso subido y guardado!', 'success');
                                this.hideModal();
                                
                                const creatorView = document.getElementById('routine-creator-view');
                                if (creatorView) {
                                   this.routine_enterCreator(2);
                                }

                            } catch(error) {
                                console.error("Error saving data after upload: ", error);
                                this.showToast('Error al guardar la nueva URL.', 'error');
                                modalFooter.querySelectorAll('button').forEach(btn => btn.disabled = false);
                            }
                        }
                    );
                },

                startWorkout(routineId, dayIndex) { let routine = [...(this.state.userRoutines || []), ...Object.values(this.data.predefinedRoutines).flat()].find(r => r.id === routineId); if (!routine || !routine.plan || !routine.plan[dayIndex]) { this.showToast("No se pudo iniciar la rutina.", "error"); return; } const workoutDay = routine.plan[dayIndex]; this.state.activeWorkout = { routineId, dayIndex, routineName: routine.name, dayName: workoutDay.day, exercises: JSON.parse(JSON.stringify(workoutDay.exercises.map(ex => ({...ex, log: []})))), currentExerciseIndex: 0, currentSet: 1, workoutStartTime: Date.now(), totalRestTime: 0, workoutTimerIntervalId: null, }; this.state.timer = { status: 'idle', timeLeft: 0, intervalId: null }; this.state.activeWorkout.workoutTimerIntervalId = setInterval(() => this.updateWorkoutTimerDisplay(), 1000); this.renderLiveWorkoutView(); },
                updateWeightInput(amount) { const input = document.getElementById('weight-input'); if (input) { let currentValue = parseFloat(input.value) || 0; input.value = Math.max(0, currentValue + amount); } },
                
                renderLiveWorkoutView() {
                    const overlay = document.getElementById('live-workout-overlay');
                    if (!this.state.activeWorkout) {
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                        return;
                    }

                    const { exercises, currentExerciseIndex, currentSet, routineName, dayName } = this.state.activeWorkout;
                    const exercise = exercises[currentExerciseIndex];
                    if (!exercise) {
                        this.finishWorkout(false);
                        return;
                    }

                    const totalExercises = Math.max(1, exercises.length);
                    const timerStatus = this.state.timer.status;
                    const workoutProgress = ((currentExerciseIndex + 1) / totalExercises) * 100;
                    const progressRounded = Math.min(100, Math.max(0, workoutProgress));
                    const totalSets = Math.max(1, Number(exercise.sets) || 1);
                    const normalizedSet = Math.min(currentSet, totalSets);
                    const restTarget = exercise.rest || '60s';
                    const nextExercise = exercises[currentExerciseIndex + 1] || null;

                    const libraryExercise = this.getExerciseByName(exercise.name) || {};
                    const mediaUrl = exercise.mediaUrl || libraryExercise.mediaUrl || '';
                    const isVideoMedia = mediaUrl ? (/\.(mp4|webm|mov|m4v)(\?.*)?$/i.test(mediaUrl) || mediaUrl.includes('video')) : false;

                    const mediaContent = mediaUrl
                        ? `
                            <div class="relative aspect-video w-full overflow-hidden rounded-3xl border border-white/10 bg-black/40 shadow-[0_25px_70px_-45px_rgba(56,189,248,0.65)]">
                                ${isVideoMedia
                                    ? `<video src="${mediaUrl}" autoplay loop muted playsinline class="h-full w-full object-cover"></video>`
                                    : `<img src="${mediaUrl}" alt="Demostraci√≥n de ${exercise.name}" class="h-full w-full object-cover" loading="lazy">`
                                }
                                <div class="absolute inset-x-3 bottom-3 flex items-center justify-between rounded-full bg-black/55 px-3 py-2 text-[10px] font-semibold uppercase tracking-[0.35em] text-white/80">
                                    <span class="inline-flex items-center gap-2 text-white">
                                        <i data-lucide="${isVideoMedia ? 'play-circle' : 'image'}" class="h-4 w-4"></i>
                                        ${isVideoMedia ? 'Video' : 'Imagen'} de referencia
                                    </span>
                                    <button data-action="show-media-viewer" data-media-url="${mediaUrl}" class="inline-flex items-center gap-2 rounded-full bg-white/15 px-3 py-1 text-[10px] font-bold tracking-[0.4em] text-white transition hover:bg-white/30">
                                        Ver grande
                                        <i data-lucide="expand" class="h-4 w-4"></i>
                                    </button>
                                </div>
                            </div>
                        `
                        : `
                            <div class="relative overflow-hidden rounded-3xl border border-dashed border-white/15 bg-white/5 px-4 py-12 text-center sm:px-6">
                                <i data-lucide="image-off" class="mx-auto mb-4 h-10 w-10 text-gray-500"></i>
                                <p class="text-sm font-semibold text-gray-300">A√∫n no hay media asociada a este ejercicio.</p>
                                <p class="mt-2 text-xs text-gray-500">Sube una imagen o video desde el creador de rutinas para enriquecer esta vista.</p>
                            </div>
                        `;

                    let setIndicators = '';
                    for (let i = 1; i <= totalSets; i++) {
                        const isCompleted = exercise.log?.[i - 1] !== undefined;
                        const isActive = i === normalizedSet && !['resting', 'exercise_complete', 'workout_complete'].includes(timerStatus);
                        let barClass = 'bg-white/10';
                        if (isCompleted) {
                            barClass = 'bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 shadow-[0_0_25px_-12px_rgba(45,212,191,0.7)]';
                        } else if (isActive) {
                            barClass = 'bg-amber-400/80 animate-pulse shadow-[0_0_35px_-18px_rgba(251,191,36,0.85)]';
                        }
                        setIndicators += `<span class="h-2 flex-1 rounded-full transition-all duration-500 ${barClass}"></span>`;
                    }

                    const statusPresets = {
                        idle: { label: 'Listo para iniciar', badgeClass: 'bg-emerald-400/10 border border-emerald-300/40 text-emerald-200' },
                        active: { label: 'En progreso', badgeClass: 'bg-amber-400/10 border border-amber-300/40 text-amber-200' },
                        logging_weight: { label: 'Registra el peso', badgeClass: 'bg-sky-400/10 border border-sky-300/40 text-sky-200' },
                        resting: { label: 'Descansando', badgeClass: 'bg-purple-400/10 border border-purple-300/40 text-purple-200' },
                        exercise_complete: { label: 'Ejercicio completado', badgeClass: 'bg-indigo-400/10 border border-indigo-300/40 text-indigo-200' },
                        workout_complete: { label: 'Rutina completada', badgeClass: 'bg-emerald-400/20 border border-emerald-300/40 text-emerald-100' }
                    };
                    const statusInfo = statusPresets[timerStatus] || statusPresets.idle;

                    let mainDisplayHtml = '';
                    switch (timerStatus) {
                        case 'resting': {
                            const radius = 88;
                            const circumference = 2 * Math.PI * radius;
                            const progressFraction = this.state.timer.initialRestTime > 0
                                ? Math.max(0, this.state.timer.timeLeft) / this.state.timer.initialRestTime
                                : 0;
                            const offset = circumference - progressFraction * circumference;
                            const upcomingName = (currentSet > totalSets && nextExercise)
                                ? nextExercise.name
                                : exercise.name;
                            mainDisplayHtml = `
                                <div class="flex flex-col items-center gap-6 text-center">
                                    <div class="relative mx-auto h-48 w-48">
                                        <svg class="h-full w-full -rotate-90" viewBox="0 0 ${radius * 2 + 40} ${radius * 2 + 40}">
                                            <circle class="text-white/10" stroke-width="12" stroke="currentColor" fill="transparent" r="${radius}" cx="${radius + 20}" cy="${radius + 20}"></circle>
                                            <circle id="rest-progress-circle" data-circumference="${circumference}" class="text-emerald-400 drop-shadow-[0_0_20px_rgba(45,212,191,0.45)]" stroke-width="12" stroke-dasharray="${circumference}"
                                                stroke-dashoffset="${offset}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="${radius}" cx="${radius + 20}" cy="${radius + 20}"></circle>
                                        </svg>
                                        <div class="absolute inset-0 grid place-items-center">
                                            <div class="text-center">
                                                <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-emerald-200/80">Tiempo de descanso</p>
                                                <p id="rest-timer-display" class="mt-1 text-5xl font-black font-mono tracking-tight text-white">${this.formatTime(this.state.timer.timeLeft)}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-200">
                                            <i data-lucide="clock" class="h-4 w-4"></i>
                                            Recupera energ√≠as
                                        </span>
                                        <p class="text-sm font-semibold text-white">${nextExercise ? 'Pr√≥ximo: ' + upcomingName : '√öltimo bloque completado'}</p>
                                        <p class="text-xs text-gray-400">Respira profundo y prepara la t√©cnica.</p>
                                    </div>
                                </div>
                            `;
                            break;
                        }
                        case 'logging_weight': {
                            const lastWeight = exercise.log?.[currentSet - 2] ?? '';
                            mainDisplayHtml = `
                                <div class="mx-auto w-full max-w-md space-y-6 text-center">
                                    <div>
                                        <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-sky-200/80">Registra el peso</p>
                                        <p class="mt-2 text-sm text-gray-300">Serie ${Math.max(currentSet - 1, 1)} completada</p>
                                    </div>
                                    <div class="flex items-center justify-center gap-4">
                                        <button type="button" onclick="app.updateWeightInput(-2.5)" class="h-14 w-14 rounded-full border border-white/15 bg-white/10 text-3xl font-bold text-white transition hover:border-emerald-300/60 hover:bg-emerald-300/10">-</button>
                                        <div class="relative w-44">
                                            <input type="number" id="weight-input" inputmode="decimal"
                                                class="w-full rounded-2xl border border-white/10 bg-black/60 py-3 text-center text-5xl font-black text-white focus:border-emerald-400 focus:outline-none"
                                                placeholder="0" value="${lastWeight}">
                                            <span class="pointer-events-none absolute inset-x-0 -bottom-6 text-xs uppercase tracking-[0.4em] text-gray-400">kg</span>
                                        </div>
                                        <button type="button" onclick="app.updateWeightInput(2.5)" class="h-14 w-14 rounded-full border border-white/15 bg-white/10 text-3xl font-bold text-white transition hover:border-emerald-300/60 hover:bg-emerald-300/10">+</button>
                                    </div>
                                    <p class="text-xs text-gray-400">Guarda el peso utilizado para mantener tu progreso controlado.</p>
                                </div>
                            `;
                            break;
                        }
                        case 'exercise_complete':
                            mainDisplayHtml = `
                                <div class="flex flex-col items-center gap-4 text-center">
                                    <span class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-emerald-400/10 text-emerald-300">
                                        <i data-lucide="check" class="h-10 w-10"></i>
                                    </span>
                                    <p class="text-2xl font-semibold text-white">¬°Ejercicio completado!</p>
                                    <p class="text-sm text-gray-400">Respira profundo y prep√°rate para el siguiente desaf√≠o.</p>
                                </div>
                            `;
                            break;
                        case 'workout_complete':
                            mainDisplayHtml = `
                                <div class="flex flex-col items-center gap-4 text-center">
                                    <span class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-emerald-400/15 text-emerald-200">
                                        <i data-lucide="sparkles" class="h-10 w-10"></i>
                                    </span>
                                    <p class="text-3xl font-semibold text-white">¬°Entrenamiento finalizado!</p>
                                    <p class="text-sm text-gray-400">Excelente trabajo. Registra sensaciones y estira para cerrar con broche de oro.</p>
                                </div>
                            `;
                            break;
                        default:
                            mainDisplayHtml = `
                                <div class="flex flex-col items-center gap-5 text-center">
                                    <div class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-300">
                                        Serie ${normalizedSet} / ${totalSets}
                                    </div>
                                    <p class="text-7xl font-black tracking-tight text-white">${exercise.reps}</p>
                                    <p class="text-sm text-gray-400">Repeticiones objetivo ¬∑ Mant√©n la t√©cnica bajo control.</p>
                                </div>
                            `;
                            break;
                    }

                    const buttonMap = {
                        idle: { text: `Comenzar serie ${normalizedSet}`, gradient: 'from-emerald-400 via-teal-400 to-cyan-400', textClass: 'text-gray-900', icon: 'play', hoverShadow: 'hover:shadow-[0_35px_70px_-40px_rgba(45,212,191,0.75)]' },
                        active: { text: 'Finalizar serie', gradient: 'from-amber-400 via-orange-400 to-pink-500', textClass: 'text-gray-900', icon: 'flag-checkered', hoverShadow: 'hover:shadow-[0_35px_70px_-40px_rgba(251,191,36,0.75)]' },
                        logging_weight: { text: 'Guardar y descansar', gradient: 'from-sky-400 via-blue-500 to-indigo-500', textClass: 'text-white', icon: 'save', hoverShadow: 'hover:shadow-[0_35px_70px_-40px_rgba(59,130,246,0.75)]' },
                        resting: { text: 'Descansando...', gradient: 'from-slate-600 via-slate-700 to-slate-800', textClass: 'text-gray-200', icon: 'timer', hoverShadow: '', disabled: true },
                        exercise_complete: { text: 'Siguiente ejercicio', gradient: 'from-purple-500 via-indigo-500 to-blue-500', textClass: 'text-white', icon: 'arrow-right', hoverShadow: 'hover:shadow-[0_35px_70px_-40px_rgba(129,140,248,0.75)]' },
                        workout_complete: { text: '¬°Rutina completada!', gradient: 'from-emerald-400 via-green-500 to-teal-500', textClass: 'text-gray-900', icon: 'sparkles', hoverShadow: 'hover:shadow-[0_45px_90px_-50px_rgba(16,185,129,0.85)]' }
                    };
                    const buttonState = buttonMap[timerStatus] || buttonMap.idle;
                    const mainButtonHtml = `
                        <button data-action="handle-workout-action" class="group relative w-full overflow-hidden rounded-full bg-gradient-to-r ${buttonState.gradient} px-5 py-3 text-base font-semibold sm:flex-1 sm:px-7 sm:py-3.5 sm:text-lg ${buttonState.textClass} transition duration-200 ${buttonState.disabled ? 'cursor-not-allowed opacity-70' : 'hover:scale-[1.01]'} ${buttonState.hoverShadow}" ${buttonState.disabled ? 'disabled' : ''}>
                            <span class="flex items-center justify-center gap-3">
                                ${buttonState.text}
                                <i data-lucide="${buttonState.icon}" class="h-5 w-5"></i>
                            </span>
                        </button>
                    `;

                    const exitRoutineButtonHtml = `
                        <button data-action="confirm-cancel-workout" class="inline-flex w-full items-center justify-center gap-2 rounded-full border border-white/10 bg-white/5 px-5 py-3 text-sm font-semibold uppercase tracking-[0.35em] text-gray-200 transition hover:border-rose-400/60 hover:bg-rose-500/10 hover:text-white sm:w-auto sm:px-6">
                            <i data-lucide="log-out" class="h-4 w-4"></i>
                            <span>Finalizar rutina</span>
                        </button>
                    `;

                    const restControlsSection = timerStatus === 'resting'
                        ? `
                            <div class="flex flex-wrap items-center justify-center gap-2 sm:gap-3">
                                <button data-action="add-rest-time" class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1.5 text-[11px] font-semibold uppercase tracking-[0.35em] text-white transition hover:border-emerald-300/60 hover:bg-emerald-300/10 sm:px-4 sm:py-2">
                                    <i data-lucide="plus" class="h-4 w-4"></i>
                                    +15s
                                </button>
                                <button data-action="skip-rest" class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/10 px-3 py-1.5 text-[11px] font-semibold uppercase tracking-[0.35em] text-white transition hover:border-rose-300/60 hover:bg-rose-300/10 sm:px-4 sm:py-2">
                                    <i data-lucide="skip-forward" class="h-4 w-4"></i>
                                    Saltar descanso
                                </button>
                            </div>
                        `
                        : '';

                    const upcomingHtml = `
                        <div class="rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-xl shadow-[0_25px_70px_-55px_rgba(59,130,246,0.45)] sm:p-6">
                            <div class="flex items-center justify-between text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-300">
                                <span>${nextExercise ? 'Siguiente ejercicio' : '√öltimo esfuerzo'}</span>
                                <span class="inline-flex items-center gap-2 text-emerald-200"><i data-lucide="activity" class="h-4 w-4"></i>${Math.round(progressRounded)}%</span>
                            </div>
                            <p class="mt-3 text-lg font-semibold text-white sm:text-xl">${nextExercise ? nextExercise.name : 'Cool down & estiramientos'}</p>
                            <p class="mt-2 text-sm text-gray-400">${nextExercise ? `${nextExercise.sets || '‚Äî'} series ¬∑ ${nextExercise.reps || '‚Äî'} reps` : 'Aprovecha para bajar pulsaciones y evaluar sensaciones.'}</p>
                        </div>
                    `;

                    const statsHtml = `
                        <div class="grid grid-cols-3 gap-3">
                            <div class="rounded-2xl border border-white/10 bg-white/5 py-3 text-center">
                                <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-gray-400">Serie</p>
                                <p class="mt-1 text-lg font-semibold text-white">${normalizedSet}/${totalSets}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 py-3 text-center">
                                <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-gray-400">Reps</p>
                                <p class="mt-1 text-lg font-semibold text-white">${exercise.reps || '‚Äî'}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 py-3 text-center">
                                <p class="text-[10px] font-semibold uppercase tracking-[0.4em] text-gray-400">Descanso</p>
                                <p class="mt-1 text-lg font-semibold text-white">${restTarget}</p>
                            </div>
                        </div>
                    `;

                    overlay.innerHTML = `
                        <div class="flex min-h-full flex-col bg-gradient-to-b from-gray-950 via-gray-950 to-gray-900 text-white">
                            <header class="sticky top-0 z-10 border-b border-white/5 bg-gray-950/95 px-4 py-4 backdrop-blur-sm sm:px-6">
                                <div class="mx-auto flex w-full max-w-5xl flex-col gap-4">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="space-y-1">
                                            <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-gray-400">${routineName || 'Rutina personalizada'}</p>
                                            <div class="flex flex-wrap items-center gap-2">
                                                <h1 class="text-xl font-semibold text-white">${dayName || 'Sesi√≥n en curso'}</h1>
                                                <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.35em] ${statusInfo.badgeClass}">
                                                    <span class="h-2 w-2 rounded-full bg-current"></span>
                                                    ${statusInfo.label}
                                                </span>
                                            </div>
                                        </div>
                                        <button data-action="confirm-cancel-workout" title="Salir de la rutina" aria-label="Salir de la rutina" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-300 transition hover:border-rose-400/60 hover:bg-rose-500/10 hover:text-white">
                                            <span class="sr-only">Salir de la rutina</span>
                                            <i data-lucide="x" class="h-5 w-5"></i>
                                        </button>
                                    </div>
                                    <div class="grid gap-3 sm:grid-cols-[auto,1fr] sm:items-center">
                                        <div class="flex items-center gap-3">
                                            <div id="main-workout-timer" class="rounded-full bg-black/40 px-4 py-2 text-2xl font-mono font-semibold tracking-widest text-white shadow-inner">00:00</div>
                                            <span class="text-xs text-gray-400">Duraci√≥n de la sesi√≥n</span>
                                        </div>
                                        <div class="w-full">
                                            <div class="overflow-hidden rounded-full border border-white/10 bg-white/5">
                                                <div class="h-2 rounded-full bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 transition-[width] duration-500" style="width: ${progressRounded}%"></div>
                                            </div>
                                            <p class="mt-1 text-xs text-gray-400">Ejercicio ${currentExerciseIndex + 1} de ${totalExercises}</p>
                                        </div>
                                    </div>
                                </div>
                            </header>

                            <main class="flex-1 overflow-y-auto px-4 pb-28 pt-6 sm:px-6">
                                <div class="mx-auto flex w-full max-w-5xl flex-col gap-6 lg:flex-row">
                                    <section class="flex w-full flex-col gap-4 lg:w-5/12">
                                        ${mediaContent}
                                        ${upcomingHtml}
                                    </section>

                                    <section class="flex flex-1">
                                        <div class="flex w-full flex-col gap-5 rounded-3xl border border-white/10 bg-white/5 p-5 backdrop-blur-xl shadow-[0_25px_70px_-55px_rgba(15,118,110,0.5)] sm:p-6">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <p class="text-[10px] font-semibold uppercase tracking-[0.35em] text-emerald-200/80">Ejercicio en curso</p>
                                                    <h2 class="mt-1 text-2xl font-semibold leading-tight text-white">${exercise.name}</h2>
                                                </div>
                                                <button data-action="show-exercise-info" data-exercise-name="${exercise.name}" class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-gray-300 transition hover:border-sky-400/60 hover:bg-sky-500/10 hover:text-white">
                                                    <i data-lucide="info" class="h-5 w-5"></i>
                                                </button>
                                            </div>

                                            <div class="space-y-3">
                                                <div class="flex items-center gap-2">
                                                    ${setIndicators}
                                                </div>
                                                ${statsHtml}
                                            </div>

                                            <div class="flex flex-1 items-center justify-center">
                                                <div class="live-workout-display w-full">
                                                    ${mainDisplayHtml}
                                                </div>
                                            </div>

                                            ${timerStatus === 'resting' ? '' : '<p class="text-center text-xs text-gray-400">Mant√©n la buena forma y controla la respiraci√≥n.</p>'}
                                        </div>
                                    </section>
                                </div>
                            </main>

                            <footer class="fixed inset-x-0 bottom-0 border-t border-white/5 bg-gray-950/95 px-4 py-4 backdrop-blur-sm sm:px-6">
                                <div class="mx-auto flex w-full max-w-5xl flex-col gap-3">
                                    ${restControlsSection}
                                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                        ${exitRoutineButtonHtml}
                                        ${mainButtonHtml}
                                    </div>
                                </div>
                            </footer>
                        </div>
                    `;

                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');

                    if (timerStatus === 'logging_weight') {
                        const weightInput = document.getElementById('weight-input');
                        if (weightInput) {
                            weightInput.focus();
                            weightInput.select();
                        }
                    }

                    lucide.createIcons();
                    if (timerStatus === 'resting') {
                        this.updateRestTimerVisuals();
                    }
                },

            updateWorkoutTimerDisplay() {
                if (!this.state.activeWorkout || !this.state.activeWorkout.workoutStartTime) {
                    return;
                }
                const timerElement = document.getElementById('main-workout-timer');
                if (timerElement) {
                    const elapsedSeconds = Math.floor((Date.now() - this.state.activeWorkout.workoutStartTime) / 1000);
                    timerElement.textContent = this.formatTime(elapsedSeconds);
                }
            },
            updateRestTimerVisuals() {
                if (!this.state.timer || this.state.timer.status !== 'resting') {
                    return;
                }
                const timeLeft = Math.max(0, this.state.timer.timeLeft);
                const displayElement = document.getElementById('rest-timer-display');
                if (displayElement) {
                    displayElement.textContent = this.formatTime(timeLeft);
                }
                const circleElement = document.getElementById('rest-progress-circle');
                if (circleElement) {
                    const circumference = parseFloat(circleElement.getAttribute('data-circumference')) || 0;
                    const initialRest = this.state.timer.initialRestTime || 0;
                    if (circumference > 0 && initialRest > 0) {
                        const fraction = Math.min(1, Math.max(0, timeLeft / initialRest));
                        circleElement.style.strokeDashoffset = `${circumference - fraction * circumference}`;
                    }
                }
            },
            handleWorkoutAction() { const status = this.state.timer.status; if (status === 'idle') { this.state.timer.status = 'active'; } else if (status === 'active') { this.state.timer.status = 'logging_weight'; } else if (status === 'logging_weight') { const weightInput = document.getElementById('weight-input'); const weightValue = parseFloat(weightInput.value); const weightToLog = !isNaN(weightValue) && weightValue >= 0 ? weightValue : 0; const { exercises, currentExerciseIndex, currentSet } = this.state.activeWorkout; exercises[currentExerciseIndex].log[currentSet - 1] = weightToLog; this.state.activeWorkout.currentSet++; if (this.state.activeWorkout.currentSet <= exercises[currentExerciseIndex].sets) { this.startRestTimer(); } else { if (this.state.activeWorkout.currentExerciseIndex >= this.state.activeWorkout.exercises.length - 1) { this.state.timer.status = 'workout_complete'; } else { this.state.timer.status = 'exercise_complete'; } } } else if (status === 'exercise_complete') { this.startRestTimer(true); this.state.activeWorkout.currentExerciseIndex++; this.state.activeWorkout.currentSet = 1; this.state.timer.status = 'resting'; } else if (status === 'workout_complete') { this.finishWorkout(true); return; } this.renderLiveWorkoutView(); },
            startRestTimer(isBetweenExercises) {
                clearInterval(this.state.timer.intervalId);
                const { exercises, currentExerciseIndex } = this.state.activeWorkout;
                const betweenExercises = Boolean(isBetweenExercises);

                let restSeconds;
                if (betweenExercises) {
                    restSeconds = 90;
                } else {
                    const restString = exercises[currentExerciseIndex].rest || '60s';
                    restSeconds = parseInt(restString.match(/\d+/)[0] || 60);
                }

                this.state.activeWorkout.totalRestTime += restSeconds;
                this.state.timer = { ...this.state.timer, status: 'resting', timeLeft: restSeconds, initialRestTime: restSeconds };
                this.playSound('start');

                this.state.timer.intervalId = setInterval(() => {
                    if (!this.state.timer) {
                        return clearInterval(this.state.timer.intervalId);
                    }

                    this.state.timer.timeLeft--;
                    if (this.state.timer.timeLeft <= 0) {
                        this.playSound('end');
                        this.skipRest();
                    } else {
                        this.updateRestTimerVisuals();
                    }
                }, 1000);
            },
            addRestTime() { if (this.state.timer.status === 'resting') { this.state.timer.timeLeft += 15; this.state.timer.initialRestTime += 15; this.state.activeWorkout.totalRestTime += 15; this.showToast("+15 segundos a√±adidos"); this.updateRestTimerVisuals(); } },
            skipRest() { if (this.state.timer.status === 'resting') { clearInterval(this.state.timer.intervalId); this.state.timer.status = 'idle'; this.renderLiveWorkoutView(); } },
            confirmCancelWorkout() {
                const hasActiveWorkout = Boolean(this.state.activeWorkout);
                const hasLoggedProgress = hasActiveWorkout && Array.isArray(this.state.activeWorkout.exercises)
                    && this.state.activeWorkout.exercises.some(exercise => Array.isArray(exercise.log) && exercise.log.length > 0);
                const hasAdvancedExercise = hasActiveWorkout && (
                    (this.state.activeWorkout.currentExerciseIndex ?? 0) > 0
                    || (this.state.activeWorkout.currentSet ?? 1) > 1
                );
                const hasMeaningfulProgress = hasLoggedProgress || hasAdvancedExercise;

                const description = hasMeaningfulProgress
                    ? '<p class="text-sm text-gray-300">¬øDeseas salir de la rutina en vivo? Puedes guardar tus avances registrados hasta el momento o salir sin conservarlos.</p>'
                    : '<p class="text-sm text-gray-300">¬øDeseas salir de la rutina en vivo? A√∫n no registras progreso, por lo que puedes abandonar ahora sin guardar datos.</p>';

                const helper = hasMeaningfulProgress
                    ? '<p class="text-xs text-gray-500">Elige "Salir y guardar" para conservar series, pesos y tiempos anotados hasta ahora.</p>'
                    : '<p class="text-xs text-gray-500">Si prefieres guardar, podr√°s registrar el estado actual de todos modos.</p>';

                this.showModal('Salir de la rutina', `<div class="space-y-3 text-left">${description}${helper}</div>`, [
                    { text: 'Seguir entrenando', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                    { text: 'Salir sin guardar', class: 'bg-rose-600 hover:bg-rose-500', action: 'exit-without-saving' },
                    { text: 'Salir y guardar', class: 'bg-emerald-500 text-gray-900 hover:bg-emerald-400', action: 'exit-and-save' }
                ]);
            },
            async finishWorkout(completed) {
                const isCompleted = typeof completed === 'undefined' ? true : Boolean(completed);
                const overlay = document.getElementById('live-workout-overlay');

                if (!this.state.activeWorkout) {
                    if (overlay) {
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                    }
                    this.hideModal();
                    return;
                }

                clearInterval(this.state.activeWorkout.workoutTimerIntervalId);
                if (this.state.timer?.intervalId) {
                    clearInterval(this.state.timer.intervalId);
                }

                const totalDuration = Math.floor((Date.now() - this.state.activeWorkout.workoutStartTime) / 1000);
                const totalRest = this.state.activeWorkout.totalRestTime || 0;
                const totalActive = Math.max(0, totalDuration - totalRest);

                if (isCompleted) {
                    const today = new Date();
                    const dateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    const baseLog = this.state.activeWorkout.exercises.map(ex => ({ name: ex.name, sets: ex.sets, reps: ex.reps, log: ex.log }));
                    const exerciseDetails = baseLog.map(exercise => {
                        const reps = this.parseRepsValue(exercise.reps);
                        const weights = (exercise.log || []).filter(value => typeof value === 'number' && !Number.isNaN(value));
                        const completedSets = weights.length;
                        const bestWeight = weights.length ? Math.max(...weights) : 0;
                        const volume = weights.reduce((sum, weight) => sum + (weight * (reps || 1)), 0);
                        const estimated1RM = this.estimateOneRepMax(bestWeight, exercise.reps || reps);
                        return { ...exercise, weights, completedSets, bestWeight, volume, estimated1RM };
                    });
                    const totalVolume = exerciseDetails.reduce((sum, ex) => sum + ex.volume, 0);
                    const totalSetsCompleted = exerciseDetails.reduce((sum, ex) => sum + ex.completedSets, 0);
                    const peakOneRepMax = exerciseDetails.reduce((max, ex) => Math.max(max, ex.estimated1RM || 0), 0);

                    const summary = {
                        id: `workout-${Date.now()}`,
                        date: dateString,
                        completedAt: today.toISOString(),
                        routineId: this.state.activeWorkout.routineId,
                        dayIndex: this.state.activeWorkout.dayIndex,
                        routineName: this.state.activeWorkout.routineName,
                        dayName: this.state.activeWorkout.dayName,
                        totalDuration,
                        totalActive,
                        totalRest,
                        totalVolume,
                        totalSetsCompleted,
                        peakOneRepMax,
                        log: baseLog,
                        exerciseDetails
                    };

                    if (!this.state.workoutHistory) this.state.workoutHistory = {};
                    if (!Array.isArray(this.state.workoutHistory[dateString])) {
                        this.state.workoutHistory[dateString] = [];
                    }
                    this.state.workoutHistory[dateString].push(summary);
                    this.state.workoutHistory[dateString].sort((a, b) => new Date(a.completedAt) - new Date(b.completedAt));
                    this.showWorkoutSummaryModal(summary);
                } else {
                    this.hideModal();
                }

                this.state.activeWorkout = null;
                this.state.timer = null;
                await this.saveDataToFirestore();
                if (overlay) {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                }
                this.renderAll();
            },
            showWorkoutSummaryModal(summary) {
                const intlFormatter = new Intl.NumberFormat('es-ES');
                const formattedDateTime = summary.completedAt
                    ? new Date(summary.completedAt).toLocaleString('es-ES', { dateStyle: 'long', timeStyle: 'short' })
                    : new Date(`${summary.date}T00:00:00`).toLocaleDateString('es-ES', { dateStyle: 'long' });
                const formattedVolume = intlFormatter.format(Math.round(summary.totalVolume || 0));
                const formattedSets = intlFormatter.format(summary.totalSetsCompleted || 0);
                const exerciseSections = summary.exerciseDetails && summary.exerciseDetails.length > 0
                    ? summary.exerciseDetails.map(exercise => {
                        const totalSets = parseInt(exercise.sets, 10) || exercise.log.length || 0;
                        const setBadges = Array.from({ length: totalSets }).map((_, index) => {
                            const weight = exercise.log?.[index];
                            const isCompleted = typeof weight === 'number' && !Number.isNaN(weight);
                            return `<span class="rounded-full border ${isCompleted ? 'border-emerald-400/40 bg-emerald-500/15 text-emerald-100' : 'border-white/10 bg-white/5 text-gray-400'} px-3 py-1 text-[11px] font-semibold">S${index + 1}: ${isCompleted ? `${weight} kg` : 'Pendiente'}</span>`;
                        }).join('');
                        return `
                            <div class="rounded-2xl border border-white/10 bg-gray-900/70 p-4">
                                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                    <div>
                                        <p class="text-sm font-semibold text-white">${exercise.name}</p>
                                        <p class="text-xs text-gray-400">${exercise.completedSets}/${exercise.sets || exercise.log.length} series registradas ¬∑ ${exercise.reps || '‚Äî'} reps objetivo</p>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-emerald-200">
                                        <i data-lucide="bar-chart" class="h-4 w-4"></i>
                                        Volumen: ${intlFormatter.format(Math.round(exercise.volume || 0))} kg¬∑reps
                                    </div>
                                </div>
                                <div class="mt-3 flex flex-wrap gap-2 text-[11px] text-gray-300">
                                    <span class="inline-flex items-center gap-1 rounded-full border border-sky-400/40 bg-sky-500/10 px-3 py-1 font-semibold text-sky-100">
                                        <i data-lucide="weight" class="h-3.5 w-3.5"></i>
                                        M√°x: ${exercise.bestWeight ? `${exercise.bestWeight} kg` : '‚Äî'}
                                    </span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-amber-400/40 bg-amber-500/10 px-3 py-1 font-semibold text-amber-100">
                                        <i data-lucide="repeat-2" class="h-3.5 w-3.5"></i>
                                        Series completadas: ${exercise.completedSets}
                                    </span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-purple-400/40 bg-purple-500/10 px-3 py-1 font-semibold text-purple-100">
                                        <i data-lucide="line-chart" class="h-3.5 w-3.5"></i>
                                        1RM: ${exercise.estimated1RM ? `${exercise.estimated1RM.toFixed(1)} kg` : '‚Äî'}
                                    </span>
                                </div>
                                <div class="mt-4 flex flex-wrap gap-2">
                                    ${setBadges}
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<p class="text-gray-500 text-sm p-3 bg-gray-900/60 rounded-2xl text-center">No se registraron pesos en esta sesi√≥n.</p>';

                const logString = encodeURIComponent(JSON.stringify(summary.log));
                const body = `
                    <div class="space-y-6 text-left">
                        <div class="rounded-3xl bg-gradient-to-br from-emerald-500/20 via-teal-500/10 to-cyan-500/20 border border-emerald-400/20 p-5 text-emerald-100">
                            <div class="flex flex-col gap-1">
                                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-emerald-200/80">Resumen de progreso</p>
                                <h3 class="text-xl font-semibold text-white">${summary.routineName}</h3>
                                <p class="text-sm text-emerald-100/80">${formattedDateTime}</p>
                            </div>
                        </div>
                        <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Duraci√≥n total</p>
                                <p class="mt-2 text-2xl font-bold">${this.formatTime(summary.totalDuration)}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Tiempo activo</p>
                                <p class="mt-2 text-2xl font-bold">${this.formatTime(summary.totalActive)}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Descanso acumulado</p>
                                <p class="mt-2 text-2xl font-bold">${this.formatTime(summary.totalRest)}</p>
                            </div>
                            <div class="rounded-2xl border border-white/10 bg-white/5 p-4 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Volumen (kg¬∑reps)</p>
                                <p class="mt-2 text-2xl font-bold">${formattedVolume}</p>
                                <p class="text-xs text-gray-400 mt-1">${formattedSets} series registradas</p>
                                <p class="text-xs text-gray-400">1RM m√°ximo: ${summary.peakOneRepMax ? `${summary.peakOneRepMax.toFixed(1)} kg` : '‚Äî'}</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <h4 class="text-sm font-semibold text-gray-200 uppercase tracking-[0.35em]">Detalle por ejercicio</h4>
                                <span class="text-xs text-gray-400">Analiza tus pesos serie a serie</span>
                            </div>
                            <div class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                ${exerciseSections}
                            </div>
                        </div>
                        <div id="ai-analysis-container" class="space-y-2"></div>
                    </div>
                `;

                const footerButtons = [
                    { text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' },
                    { text: 'Ver historial', class: 'bg-sky-500 text-gray-900 hover:bg-sky-400', action: 'show-workout-history', 'history-date': summary.date },
                    { text: '‚ú® Analizar', class: 'bg-gradient-to-r from-purple-500 to-indigo-600', action: 'analyze-workout-performance', 'log-data': logString }
                ];

                this.showModal('Resumen del entrenamiento', body, footerButtons);
                lucide.createIcons();
            },
            _normalizeWorkoutEntry(entry, dateKey) {
                if (!entry || typeof entry !== 'object') {
                    return {
                        id: `workout-${Date.now()}`,
                        date: dateKey,
                        completedAt: new Date(`${dateKey}T00:00:00`).toISOString(),
                        routineId: '',
                        dayIndex: 0,
                        routineName: 'Sesi√≥n',
                        dayName: '',
                        totalDuration: 0,
                        totalRest: 0,
                        totalActive: 0,
                        totalVolume: 0,
                        totalSetsCompleted: 0,
                        log: [],
                        exerciseDetails: []
                    };
                }

                const baseLog = Array.isArray(entry.log)
                    ? entry.log.map(ex => ({
                        name: ex.name,
                        sets: ex.sets,
                        reps: ex.reps,
                        log: Array.isArray(ex.log) ? ex.log : []
                    }))
                    : [];

                const deriveDetails = (source) => {
                    const reps = this.parseRepsValue(source.reps);
                    const weights = (source.log || []).filter(value => typeof value === 'number' && !Number.isNaN(value));
                    const completedSets = weights.length;
                    const bestWeight = weights.length ? Math.max(...weights) : 0;
                    const volume = weights.reduce((sum, weight) => sum + weight * (reps || 1), 0);
                    return {
                        name: source.name,
                        sets: source.sets,
                        reps: source.reps,
                        log: source.log || [],
                        weights,
                        completedSets,
                        bestWeight,
                        volume,
                        estimated1RM: this.estimateOneRepMax(bestWeight, source.reps || reps)
                    };
                };

                const exerciseDetails = Array.isArray(entry.exerciseDetails) && entry.exerciseDetails.length > 0
                    ? entry.exerciseDetails.map(detail => {
                        const base = baseLog.find(ex => ex.name === detail.name) || detail;
                        const normalizedLog = Array.isArray(detail.log) ? detail.log : (base.log || []);
                        const weights = Array.isArray(detail.weights) ? detail.weights : normalizedLog.filter(value => typeof value === 'number' && !Number.isNaN(value));
                        const reps = this.parseRepsValue(detail.reps ?? base.reps);
                        const completedSets = typeof detail.completedSets === 'number' ? detail.completedSets : weights.length;
                        const bestWeight = typeof detail.bestWeight === 'number' ? detail.bestWeight : (weights.length ? Math.max(...weights) : 0);
                        const volume = typeof detail.volume === 'number' ? detail.volume : weights.reduce((sum, weight) => sum + weight * (reps || 1), 0);
                        return {
                            name: detail.name || base.name,
                            sets: detail.sets ?? base.sets,
                            reps: detail.reps ?? base.reps,
                            log: normalizedLog,
                            weights,
                            completedSets,
                            bestWeight,
                            volume,
                            estimated1RM: typeof detail.estimated1RM === 'number' ? detail.estimated1RM : this.estimateOneRepMax(bestWeight, detail.reps ?? base.reps)
                        };
                    })
                    : baseLog.map(deriveDetails);

                const totalDuration = entry.totalDuration || 0;
                const totalRest = entry.totalRest || 0;
                const totalActive = entry.totalActive || Math.max(0, totalDuration - totalRest);
                const totalVolume = typeof entry.totalVolume === 'number' ? entry.totalVolume : exerciseDetails.reduce((sum, ex) => sum + (ex.volume || 0), 0);
                const totalSetsCompleted = typeof entry.totalSetsCompleted === 'number' ? entry.totalSetsCompleted : exerciseDetails.reduce((sum, ex) => sum + (ex.completedSets || 0), 0);
                const peakOneRepMax = typeof entry.peakOneRepMax === 'number' ? entry.peakOneRepMax : exerciseDetails.reduce((max, ex) => Math.max(max, ex.estimated1RM || 0), 0);

                return {
                    id: entry.id || `workout-${Date.parse(entry.completedAt || `${dateKey}T00:00:00`) || Date.now()}`,
                    date: entry.date || dateKey,
                    completedAt: entry.completedAt || new Date(`${dateKey}T00:00:00`).toISOString(),
                    routineId: entry.routineId || '',
                    dayIndex: typeof entry.dayIndex === 'number' ? entry.dayIndex : 0,
                    routineName: entry.routineName || 'Sesi√≥n',
                    dayName: entry.dayName || '',
                    totalDuration,
                    totalRest,
                    totalActive,
                    totalVolume,
                    totalSetsCompleted,
                    peakOneRepMax,
                    log: baseLog,
                    exerciseDetails
                };
            },
            getWorkoutHistoryEntries() {
                if (!this.state.workoutHistory) return [];
                const entries = [];
                Object.entries(this.state.workoutHistory).forEach(([date, records]) => {
                    if (Array.isArray(records)) {
                        records.forEach(record => entries.push({ ...record, date }));
                    }
                });
                return entries.sort((a, b) => {
                    const aDate = new Date(a.completedAt || `${a.date}T00:00:00`);
                    const bDate = new Date(b.completedAt || `${b.date}T00:00:00`);
                    return bDate - aDate;
                });
            },
            openWorkoutHistoryModal(targetDate) {
                if (!this.state.workoutHistory || Object.keys(this.state.workoutHistory).length === 0) {
                    this.showModal('Historial de entrenamientos', '<p class="text-sm text-gray-300">Registra tu primera rutina para comenzar a visualizar estad√≠sticas.</p>', [
                        { text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }
                    ]);
                    return;
                }

                const entriesByDate = Object.entries(this.state.workoutHistory)
                    .filter(([, records]) => Array.isArray(records) && records.length > 0)
                    .sort((a, b) => new Date(b[0]) - new Date(a[0]));

                if (entriesByDate.length === 0) {
                    this.showModal('Historial de entrenamientos', '<p class="text-sm text-gray-300">A√∫n no hay sesiones registradas.</p>', [
                        { text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }
                    ]);
                    return;
                }

                const intlFormatter = new Intl.NumberFormat('es-ES');
                const selectedDate = targetDate && this.state.workoutHistory[targetDate] && this.state.workoutHistory[targetDate].length > 0
                    ? targetDate
                    : entriesByDate[0][0];

                const selectedEntries = this.state.workoutHistory[selectedDate]
                    .slice()
                    .sort((a, b) => new Date(b.completedAt || 0) - new Date(a.completedAt || 0));

                const totalSessions = entriesByDate.reduce((sum, [, list]) => sum + list.length, 0);
                const totalActiveSeconds = entriesByDate.reduce((sum, [, list]) => sum + list.reduce((acc, entry) => acc + (entry.totalActive || 0), 0), 0);
                const totalVolume = entriesByDate.reduce((sum, [, list]) => sum + list.reduce((acc, entry) => acc + (entry.totalVolume || 0), 0), 0);
                const averageActive = totalSessions ? Math.round(totalActiveSeconds / totalSessions) : 0;

                const dateListHtml = entriesByDate.map(([dateKey, list]) => {
                    const formattedDay = new Date(`${dateKey}T00:00:00`).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
                    const dayVolume = list.reduce((acc, entry) => acc + (entry.totalVolume || 0), 0);
                    const isActive = dateKey === selectedDate;
                    return `
                        <button data-action="show-workout-history" data-history-date="${dateKey}" class="w-full rounded-2xl border ${isActive ? 'border-emerald-400/40 bg-emerald-500/15 text-emerald-100' : 'border-white/10 bg-white/5 text-gray-300 hover:border-emerald-300/40 hover:text-white'} px-4 py-3 text-left transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-semibold capitalize">${formattedDay}</p>
                                    <p class="text-xs text-gray-400">${list.length} sesiones ¬∑ ${intlFormatter.format(Math.round(dayVolume))} kg¬∑reps</p>
                                </div>
                                <i data-lucide="chevron-right" class="h-4 w-4"></i>
                            </div>
                        </button>
                    `;
                }).join('');

                const selectedDateLabel = new Date(`${selectedDate}T00:00:00`).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

                const selectedEntriesHtml = selectedEntries.map(entry => {
                    const timeLabel = entry.completedAt
                        ? new Date(entry.completedAt).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
                        : '';
                    const entryVolume = intlFormatter.format(Math.round(entry.totalVolume || 0));
                    const topExercises = (entry.exerciseDetails || []).slice(0, 3).map(ex => {
                        const bestWeightLabel = ex.bestWeight ? `${ex.bestWeight} kg` : '‚Äî';
                        const oneRmLabel = ex.estimated1RM ? `${ex.estimated1RM.toFixed(1)} kg` : '‚Äî';
                        return `
                            <div class="flex items-center justify-between gap-2 text-xs text-gray-300">
                                <span class="truncate pr-2">${ex.name}</span>
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2.5 py-0.5 text-emerald-100"><i data-lucide="dumbbell" class="h-3.5 w-3.5"></i>${bestWeightLabel}</span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-purple-400/40 bg-purple-500/10 px-2.5 py-0.5 text-purple-100"><i data-lucide="line-chart" class="h-3.5 w-3.5"></i>${oneRmLabel}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    return `
                        <div class="rounded-2xl border border-white/10 bg-gray-900/70 p-4">
                            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <div>
                                    <p class="text-base font-semibold text-white">${entry.routineName}</p>
                                    <p class="text-xs text-gray-400">${entry.dayName || 'Sesi√≥n'} ${timeLabel ? `¬∑ ${timeLabel}` : ''}</p>
                                </div>
                                <div class="flex flex-wrap gap-3 text-xs text-gray-300">
                                    <span class="inline-flex items-center gap-1 rounded-full border border-white/10 bg-white/5 px-3 py-1"><i data-lucide="timer" class="h-3.5 w-3.5"></i>${this.formatTime(entry.totalDuration)}</span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-3 py-1 text-emerald-100"><i data-lucide="flame" class="h-3.5 w-3.5"></i>${this.formatTime(entry.totalActive)}</span>
                                    <span class="inline-flex items-center gap-1 rounded-full border border-sky-400/40 bg-sky-500/10 px-3 py-1 text-sky-100"><i data-lucide="bar-chart" class="h-3.5 w-3.5"></i>${entryVolume} kg¬∑reps</span>
                                </div>
                            </div>
                            <div class="mt-3 space-y-1">
                                ${topExercises || '<p class="text-xs text-gray-500">A√±ade pesos para ver m√°s detalles.</p>'}
                            </div>
                        </div>
                    `;
                }).join('');

                const body = `
                    <div class="flex flex-col gap-6 lg:flex-row">
                        <aside class="space-y-4 lg:w-1/3">
                            <div class="rounded-3xl border border-white/10 bg-white/5 p-5 text-white">
                                <p class="text-[11px] font-semibold uppercase tracking-[0.35em] text-gray-400">Resumen general</p>
                                <div class="mt-4 space-y-3 text-sm">
                                    <div class="flex items-center justify-between">
                                        <span>Sesiones registradas</span>
                                        <strong>${intlFormatter.format(totalSessions)}</strong>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span>Volumen total</span>
                                        <strong>${intlFormatter.format(Math.round(totalVolume))} kg¬∑reps</strong>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span>Tiempo activo promedio</span>
                                        <strong>${this.formatTime(averageActive)}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2 max-h-80 overflow-y-auto pr-1">
                                ${dateListHtml}
                            </div>
                        </aside>
                        <section class="flex-1 space-y-4">
                            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                <h3 class="text-lg font-semibold text-white capitalize">${selectedDateLabel}</h3>
                                <p class="text-xs text-gray-400">${selectedEntries.length} sesiones registradas</p>
                            </div>
                            <div class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                ${selectedEntriesHtml || '<p class="text-sm text-gray-400">No hay entrenamientos registrados en esta fecha.</p>'}
                            </div>
                        </section>
                    </div>
                `;

                this.showModal('Historial de entrenamientos', body, [
                    { text: 'Cerrar', class: 'bg-gray-600 hover:bg-gray-500', action: 'hide-modal' }
                ]);
                lucide.createIcons();
            },
        };
            window.app = app;
            app.init();
        };

        if (document.readyState === 'loading') {
            const onceHandler = () => {
                document.removeEventListener('DOMContentLoaded', onceHandler);
                bootstrapApp();
            };
            document.addEventListener('DOMContentLoaded', onceHandler);
        } else {
            bootstrapApp();
        }
</script>

</body>
</html>
